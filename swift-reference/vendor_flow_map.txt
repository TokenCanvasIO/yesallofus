================================================================================
  YESALLOFUS / DLT PAYS - VENDOR FLOW MAP
  Complete Reference for iOS Swift Port
  Generated: 2026-01-30
================================================================================


================================================================================
1. VENDOR FLOW OVERVIEW
================================================================================

YesAllOfUs (branded DLT Pays) is a crypto point-of-sale (POS) system built on
XRPL (XRP Ledger). It enables vendors/partners to accept payments in RLUSD
(Ripple USD stablecoin) at their physical or online stores.

The vendor side consists of:
  - Login/Authentication via Xaman wallet, Crossmark wallet, or Web3Auth (Google)
  - Store Dashboard for managing store settings, wallet, affiliates, milestones
  - Take Payment POS screen for building carts and accepting payments
  - Customer Display screen (second screen / tablet facing customer)
  - Staff Management for clock in/out, shift tracking
  - Products/Inventory management with barcode scanning
  - Payment methods: QR code (Xaman), NFC tap-to-pay, SoundPay (ultrasonic),
    payment links (email/share)
  - Receipt system with email, print, and on-screen confirmation
  - Affiliate/commission tracking (5-level MLM structure)

Base API URL: https://api.dltpays.com
  - Main API:    https://api.dltpays.com/api/v1
  - NFC/POS API: https://api.dltpays.com/nfc/api/v1
  - Conversion:  https://api.dltpays.com/convert/gbp-to-rlusd

Currency: GBP (input) -> RLUSD (settlement on XRPL)


================================================================================
2. PAGE MAP
================================================================================

PAGE: /dashboard
  File: app/(main)/dashboard/page.tsx
  Layout: app/(main)/dashboard/layout.tsx (minimal dark bg wrapper)
  Purpose: Main vendor control panel after login. Shows store info,
           wallet balances, onboarding setup, milestones, activity,
           affiliate tree, settings, and navigation to POS.
  Auth: Reads vendorWalletAddress + storeData from sessionStorage.
        If no wallet, shows LoginScreen component.
  Steps: login -> xaman (QR polling) -> dashboard
  Components:
    - LoginScreen (wallet connection: Xaman QR, Crossmark, Web3Auth/Google)
    - DashboardHeader (store name, logo, hamburger menu, navigation)
    - Sidebar (collapsible navigation panel with section links)
    - Logo (brand logo display)
    - OnboardingSetup (guided wallet setup: fund XRP, set trustline, enable auto-sign)
    - MilestoneChecklist (tracks vendor progress: first sale, first affiliate, etc.)
    - CelebrationToast (confetti/milestone celebration overlay)
    - CollapsibleSection (expandable dashboard sections)
    - StoreActivity (affiliates list + payouts history tabs)
    - WalletFunding (XRP funding instructions/QR)
    - TopUpRLUSD (add RLUSD balance)
    - WithdrawRLUSD (withdraw RLUSD to external wallet)
    - EarnInterest (staking/yield feature)
    - PendingCustomers (NFC card registrations awaiting approval)
    - SignUpCustomerCard (register new NFC customer)
    - QRCodeModal (display store referral QR)
    - InfoModal / InfoButton (contextual help system)
    - VendorDashboardTour (first-time guided tour)
    - DeleteConfirmModal (store deletion confirmation)
    - NebulaBackground (animated particle background)

PAGE: /take-payment
  File: app/(noheader)/take-payment/page.tsx
  Purpose: Full POS register screen. Build cart from products, accept
           payments via QR/NFC/SoundPay/payment links.
  Auth: Reads vendorWalletAddress + storeData from sessionStorage.
        Redirects to /dashboard if not logged in.
  Components:
    - TakePaymentHeader (compact header with logo, staff selector, nav icons)
    - ProductsManager (full CRUD product management modal)
    - StaffSelector (dropdown to assign active cashier)
    - SendPaymentLink (create shareable payment link, email, QR)
    - PendingPayments (view/manage outstanding payment links)
    - LiveConversionWidget (real-time GBP -> RLUSD rate from CoinGecko)
    - TakePaymentTour (first-time guided tour for POS)
    - ReceiptActions (print receipt, email receipt after payment)
    - NebulaBackground (animated background)
    - AutoSignModal (setup auto-signing for NFC payments)
    - SoundPayButton (initiate SoundPay ultrasonic payment)
    - SoundPaySendButton (broadcast SoundPay signal on customer display)
    - BarcodeScanner (camera-based barcode lookup to add products)
    - MobileStaffList (inline staff picker for mobile modal)
  Lib:
    - customerDisplay (updateCustomerDisplay, clearCustomerDisplay)
    - safeStorage (sessionStorage wrapper)
    - foodIcons (SVG icon library for product display)

PAGE: /display
  File: app/(noheader)/display/page.tsx
  URL: /display?store=STORE_ID
  Purpose: Customer-facing second screen. Shows cart, total, payment
           QR code, NFC tap zone, SoundPay zone, tips, split payment
           progress, and signup form. Polls API every 500ms.
  Auth: None (public page, identified by store query param)
  Components:
    - MoveCloserAnimation (SoundPay proximity guidance animation)
    - SoundPaySendButton (customer-side SoundPay broadcast)
  Lib:
    - foodIcons (getIconById for product icon display)
  States/Screens: idle | ready | processing | success | error | qr |
                  signup | split_pending | link_pending | soundpay

PAGE: /staff
  File: app/staff/page.tsx
  Purpose: Staff management - add/edit/delete staff members,
           clock in/out, view shift history.
  Auth: Reads vendorWalletAddress + storeData from sessionStorage.
        Redirects to /dashboard if not logged in.
  Components: Self-contained (no imported components)
  Tabs: Staff list | Shifts history

PAGE: /staffpos
  File: app/staffpos/page.tsx
  Purpose: Duplicate/variant of the staff page (same structure as /staff).
  Auth: Same as /staff
  Components: Self-contained


================================================================================
3. COMPONENT DEPENDENCY TREE
================================================================================

/dashboard (page.tsx)
|-- LoginScreen
|   |-- BackgroundVideo
|   |-- (imports: safeStorage, walletAuth)
|-- DashboardHeader
|-- Sidebar
|-- Logo
|-- OnboardingSetup
|   |-- SuccessMessage
|   |-- QRCodeSVG (from qrcode.react)
|   |-- (imports: safeStorage)
|-- MilestoneChecklist
|-- CelebrationToast
|-- CollapsibleSection
|-- StoreActivity
|   |-- (fetches affiliates + payouts)
|-- WalletFunding
|-- TopUpRLUSD
|-- WithdrawRLUSD
|-- EarnInterest
|-- PendingCustomers
|-- SignUpCustomerCard
|-- QRCodeModal
|-- InfoModal / InfoButton (useInfoModal hook)
|-- VendorDashboardTour
|-- DeleteConfirmModal
|-- NebulaBackground

/take-payment (page.tsx)
|-- TakePaymentHeader
|-- ProductsManager
|   |-- CSVImportModal
|   |-- InventoryHistoryModal
|   |-- EmojiPicker (dynamic import: emoji-picker-react)
|   |-- (imports: foodIcons, Papa papaparse)
|-- StaffSelector
|   |-- (imports: safeStorage)
|-- SendPaymentLink
|   |-- QRCodeSVG (from qrcode.react)
|   |-- (imports: customerDisplay)
|-- PendingPayments
|-- LiveConversionWidget
|-- TakePaymentTour
|-- ReceiptActions
|   |-- EmailReceiptModal
|-- NebulaBackground
|-- AutoSignModal
|-- SoundPayButton
|-- SoundPaySendButton
|   |-- (imports: utils/soundPayment)
|-- BarcodeScanner
|   |-- (uses: html5-qrcode)
|-- MobileStaffList (inline component)
|-- (imports: customerDisplay, safeStorage, foodIcons)

/display (page.tsx)
|-- MoveCloserAnimation
|   |-- (uses: framer-motion)
|-- SoundPaySendButton
|   |-- (imports: utils/soundPayment, framer-motion)
|-- (imports: foodIcons)

/staff (page.tsx)
|-- (self-contained, no child components)
|-- (imports: safeStorage)

/staffpos (page.tsx)
|-- (self-contained, no child components)
|-- (imports: safeStorage)


================================================================================
4. STATE FLOW
================================================================================

A. SESSION STORAGE (via safeStorage.ts wrapper)
   Uses sessionStorage (NOT localStorage) with in-memory fallback.

   Keys stored:
     vendorWalletAddress   -> XRPL wallet address string (e.g., "rXXXX...")
     vendorLoginMethod     -> "xaman" | "crossmark" | "web3auth"
     socialProvider        -> Google/social login provider name
     storeData             -> JSON string of full store object:
                              { store_id, store_name, wallet_address, logo_url,
                                commission_rates, daily_limit, referral_code,
                                auto_sign_max_single_payout, platform_return_url,
                                platform_type, xaman_connected, xaman_user_token }
     vendorReferralCode    -> Referral code from ?ref= URL param
     vendorReferringStore  -> JSON of referring store data
     wordpress_return      -> WordPress plugin return URL
     activeStaff           -> JSON of currently selected staff member

   Functions:
     safeGetItem(key) -> string | null
     safeSetItem(key, value) -> void
     safeRemoveItem(key) -> void
     safeGetJSON<T>(key) -> T | null
     safeSetJSON(key, value) -> void
     safeClear() -> void

B. LOCAL STORAGE (used for persistent flags)
     vendor_tour_completed_{storeId}       -> "true" when tour dismissed
     take_payment_tour_completed_{storeId} -> "true" when POS tour dismissed
     milestones_dismissed_{storeId}        -> "true" when progress bar hidden

C. DATA FLOW SEQUENCE

   Login:
     1. User connects wallet (Xaman QR, Crossmark, or Web3Auth/Google)
     2. Wallet address obtained -> saved to sessionStorage
     3. loadOrCreateStore(wallet, type) called:
        a. If claim token exists: POST /store/claim
        b. Else: GET /store/by-wallet/{wallet}
        c. If no store: POST /store/link-wallet (try unclaimed)
        d. If still none: show create store form -> POST /store/register
     4. Store data saved to sessionStorage
     5. Step changes to "dashboard"

   Taking Payment:
     1. Load walletAddress + storeData from sessionStorage
     2. Fetch products: GET /store/{id}/products?wallet_address=
     3. User builds cart (add/remove products or enter manual amount)
     4. Cart synced to customer display: POST /display/update
     5. User initiates payment:
        a. QR: POST /xaman/payment -> returns QR PNG + payment_id
           - Poll: GET /xaman/payment/poll/{paymentId} every 2s
        b. NFC: Web NFC API scan -> POST /nfc/payment
        c. SoundPay: POST /soundpay/create-payment -> broadcast ultrasonic
           - Poll: GET /display/{storeId} for success status
        d. Payment Link: POST /payment-link/create -> share URL/email
     6. On success:
        - Display updated to "success" state
        - Stock decremented: POST /store/{id}/inventory/{productId}/adjust
        - Receipt fetched: GET /receipts/{receiptId}
        - Cart cleared, ready for next payment

   Customer Display (polling):
     1. Page loads with ?store= query param
     2. Fetches store logo: GET /store/public/{storeId}
     3. Polls every 500ms: GET /display/{storeId}
     4. Renders current state (idle/cart/qr/processing/success/error)
     5. Customer can:
        - Add tip: POST /display/{storeId}/tip
        - Confirm payment: POST /display/{storeId}/confirm
        - Tap NFC card: POST /nfc/payment (from display side)
        - Scan QR with Xaman wallet
        - Sign up for NFC card: POST /nfc/register-customer
     6. Live conversion rate: GET /convert/gbp-to-rlusd?amount=X (every 10s)


================================================================================
5. API ENDPOINTS USED
================================================================================

BASE: https://api.dltpays.com/api/v1     (referred to as API_V1)
BASE: https://api.dltpays.com/nfc/api/v1  (referred to as NFC_API)

--- AUTHENTICATION & WALLET ---

POST   API_V1/xaman/login
       Purpose: Initiate Xaman wallet login (returns QR code)

GET    API_V1/xaman/login/poll/{loginId}
       Purpose: Poll for Xaman login completion
       Returns: { status: "signed"|"expired"|"cancelled", wallet_address, xaman_user_token }

POST   API_V1/wallet/auth-token
       Purpose: Get HMAC auth token for protected endpoints
       Body: { wallet_address }

GET    API_V1/wallet/status/{walletAddress}
       Purpose: Check wallet funding, trustline, balances
       Returns: { funded, xrp_balance, rlusd_trustline, rlusd_balance,
                  usdc_trustline, usdc_balance, auto_signing_enabled }

--- STORE MANAGEMENT ---

GET    API_V1/store/by-wallet/{walletAddress}
       Purpose: Load existing store for wallet

POST   API_V1/store/register
       Purpose: Create new store
       Body: { store_name, store_url, email, wallet_address, wallet_type,
               xaman_user_token, referral_code }
       Returns: { store, api_secret }

POST   API_V1/store/claim
       Purpose: Claim a pre-created store with claim token
       Body: { claim_token, wallet_address, wallet_type, xaman_user_token }

POST   API_V1/store/link-wallet
       Purpose: Link wallet to unclaimed store
       Body: { wallet_address, wallet_type, xaman_user_token }

GET    API_V1/store/by-claim/{claimToken}
       Purpose: Lookup store by claim token

GET    API_V1/store/lookup-referral/{referralCode}
       Purpose: Lookup referring store by referral code

POST   API_V1/store/save-xaman-wallet
       Purpose: Save Xaman connection to existing store
       Body: { store_id, wallet_address, xaman_user_token }

POST   API_V1/store/set-platform-return
       Purpose: Save WordPress return URL
       Body: { store_id, wallet_address, platform_return_url, platform_type }

POST   NFC_API/store/{storeId}/logo
       Purpose: Upload/remove store logo
       Body: { logo_url, wallet_address }

GET    NFC_API/store/public/{storeId}
       Purpose: Get public store data (logo, name) - no auth required

POST   API_V1/store/{storeId}/milestone
       Purpose: Record milestone achievement
       Body: { milestone, wallet_address }

GET    API_V1/store/{storeId}/affiliate-count?wallet_address=
       Purpose: Count affiliates and check for payouts

GET    API_V1/store/{storeId}/referred-vendors
       Purpose: Check for referred vendor partners

--- PRODUCTS & INVENTORY ---

GET    NFC_API/store/{storeId}/products?wallet_address=
       Purpose: List all products for store

POST   NFC_API/store/{storeId}/products
       Purpose: Create new product
       Body: { wallet_address, name, price, sku, category, emoji, icon_id,
               image_url, barcode, track_stock, stock_quantity, low_stock_threshold }

PUT    NFC_API/store/{storeId}/products/{productId}
       Purpose: Update product

DELETE NFC_API/store/{storeId}/products/{productId}?wallet_address=
       Purpose: Delete product

GET    NFC_API/store/{storeId}/products/barcode/{barcode}?wallet_address=
       Purpose: Lookup product by barcode scan

POST   NFC_API/store/{storeId}/inventory/{productId}/adjust
       Purpose: Adjust stock quantity (increment/decrement)
       Body: { wallet_address, adjustment, reason, notes }

--- PAYMENTS ---

POST   API_V1/xaman/payment
       Purpose: Create Xaman QR payment request
       Body: { amount (RLUSD), vendor_wallet, store_id, store_name,
               items, amount_gbp }
       Returns: { success, qr_png, payment_id }

GET    API_V1/xaman/payment/poll/{paymentId}
       Purpose: Poll Xaman payment status
       Returns: { status: "signed"|"expired"|"cancelled"|"failed",
                  tx_hash, receipt_id }

POST   NFC_API/nfc/payment
       Purpose: Process NFC tap-to-pay
       Body: { uid, amount, vendor_wallet, store_name, store_id,
               items, staff_id, staff_name, payment_id, gbp_amount }
       Returns: { success, tx_hash, receipt_id }

POST   NFC_API/payment-link/create
       Purpose: Create shareable payment link
       Body: { store_id, amount, items, tip, currency }
       Returns: { success, payment_url, payment_id }

GET    NFC_API/store/{storeId}/pending-payments
       Purpose: List pending/outstanding payment links

POST   NFC_API/soundpay/create-payment
       Purpose: Create SoundPay ultrasonic payment session
       Body: { store_id, store_name, vendor_wallet, amount, tip_amount, items }
       Returns: { success, payment_id }

--- CUSTOMER DISPLAY ---

POST   NFC_API/display/update
       Purpose: Push cart/status to customer-facing display
       Body: { store_id, store_name, cart, total, status, qr_code,
               tip, tips_enabled, vendor_wallet }

GET    NFC_API/display/{storeId}
       Purpose: Poll display state (called every 500ms from display page,
               every 1s from POS for tip sync)
       Returns: { store_name, cart, subtotal, total, status, qr_code,
                  tip, tips_enabled, vendor_wallet, customer_confirmed,
                  split_payment, payment_id, logo_url }

POST   NFC_API/display/{storeId}/tip
       Purpose: Customer adds tip from display
       Body: { tip }

POST   NFC_API/display/{storeId}/confirm
       Purpose: Customer confirms payment from display

POST   NFC_API/display/{storeId}/reset-confirm
       Purpose: Reset confirmation flag after processing

--- RECEIPTS ---

GET    NFC_API/receipts/{receiptId}
       Purpose: Fetch receipt details
       Returns: { receipt: { items, total, tip_amount, conversion_rate,
                  amount_rlusd, tx_hash, ... } }

GET    NFC_API/store/{storeId}/receipts?wallet_address=&limit=
       Purpose: List store receipts (for stats calculation)

--- NFC CUSTOMER REGISTRATION ---

POST   NFC_API/nfc/register-customer
       Purpose: Register new NFC card for customer
       Body: { card_uid, card_name, store_id, name, email, phone }

--- STAFF ---

GET    NFC_API/store/{storeId}/staff?wallet_address=
       Purpose: List all staff members

POST   NFC_API/store/{storeId}/staff
       Purpose: Add new staff member
       Body: { wallet_address, name, role, pin, hourly_rate, photo_url }

PUT    NFC_API/store/{storeId}/staff/{staffId}
       Purpose: Update staff member

DELETE NFC_API/store/{storeId}/staff/{staffId}?wallet_address=
       Purpose: Delete staff member

POST   NFC_API/store/{storeId}/staff/{staffId}/clock-in
       Purpose: Clock in staff member
       Body: { wallet_address }

POST   NFC_API/store/{storeId}/staff/{staffId}/clock-out
       Purpose: Clock out staff member
       Body: { wallet_address }

GET    NFC_API/store/{storeId}/shifts?wallet_address=&limit=
       Purpose: List shift history

--- AFFILIATES & PAYOUTS ---

GET    API_V1/store/{storeId}/affiliates?wallet=
       Purpose: List store's affiliate tree

GET    API_V1/store/{storeId}/payouts?wallet=
       Purpose: List commission payout history

--- CONVERSION ---

GET    https://api.dltpays.com/convert/gbp-to-rlusd?amount=X&capture=true
       Purpose: Convert GBP to RLUSD using live CoinGecko Pro rate
       Returns: { success, gbp, rlusd, rate: { rlusd_gbp, gbp_to_rlusd,
                  source, source_url }, price_age_ms, compliance }

--- EXTERNAL ---

POST   https://tokencanvas.io/api/cloudinary/upload
       Purpose: Upload store logo image via Cloudinary proxy
       Body: FormData with file + upload_preset

GET    https://tokencanvas.io/api/coingecko/simple/price?ids=ripple-usd&vs_currencies=gbp
       Purpose: Fallback conversion rate from CoinGecko cache


================================================================================
6. USER JOURNEY
================================================================================

STEP 1: VENDOR LOGIN (/dashboard)
  a. Vendor opens /dashboard
  b. LoginScreen component renders with 3 options:
     - Xaman Wallet: POST /xaman/login -> Show QR code -> Poll /xaman/login/poll
     - Crossmark: Browser extension connection
     - Web3Auth (Google): OAuth flow via Web3Auth SDK -> returns XRPL address
  c. Wallet address obtained and saved to sessionStorage
  d. loadOrCreateStore() called:
     - Checks for existing store via /store/by-wallet/{wallet}
     - Or creates new store via /store/register
  e. Store data saved to sessionStorage
  f. Dashboard renders

STEP 2: ONBOARDING SETUP (first time)
  a. OnboardingSetup checks wallet status: /wallet/status/{wallet}
  b. Steps shown if incomplete:
     1. Fund wallet with XRP (minimum for XRPL reserve)
     2. Set RLUSD trustline (allow receiving RLUSD payments)
     3. Enable auto-signing (allows server to sign NFC payments)
  c. Each step has Xaman QR or Web3Auth flow
  d. MilestoneChecklist tracks: account_created, wallet_funded,
     trustline_set, first_payment, first_affiliate, first_payout_sent,
     first_partner_signed

STEP 3: DASHBOARD OVERVIEW
  a. DashboardHeader shows store name, logo, navigation
  b. Sidebar provides quick navigation to sections
  c. Store overview: wallet balances (XRP, RLUSD), store ID
  d. Activity section: affiliates tree + payout history (StoreActivity)
  e. Quick actions: Take Payment, Manage Products, View Receipts
  f. Settings: commission rates (5-level), daily limits, auto-sign
  g. Referral: Store referral code + QR for partner recruitment
  h. Advanced: TopUp RLUSD, Withdraw RLUSD, Earn Interest

STEP 4: TAKE PAYMENT (/take-payment)
  a. POS loads products from API
  b. Vendor builds cart by tapping product tiles
     - Search/filter by name or category
     - Barcode scan via camera (BarcodeScanner component)
     - Manual amount entry via number pad
  c. Cart displayed with quantities, line totals, and grand total
  d. Cart automatically synced to customer display via /display/update
  e. Optional: Select active staff member (StaffSelector)
  f. Optional: Tips enabled (customer can add from display)
  g. Payment initiation options:
     - "Pay" button -> showQRPayment():
       1. Convert GBP to RLUSD via /convert/gbp-to-rlusd
       2. Create Xaman payment: POST /xaman/payment
       3. Show QR on POS + push to display
       4. Poll /xaman/payment/poll every 2s
     - NFC tap icon -> startNFCPayment():
       1. Update display to "ready" state
       2. Web NFC API scan (Android Chrome)
       3. On card tap: POST /nfc/payment
     - SoundPay button (SoundPayButton):
       1. Create sound payment: POST /soundpay/create-payment
       2. Update display to "soundpay" state
       3. Customer device listens for ultrasonic signal
       4. Poll display for success
     - Share/Link button (SendPaymentLink):
       1. Create payment link: POST /payment-link/create
       2. Copy URL, show QR, or email to customer
       3. Update display to "link_pending" state
     - Split Bill (SplitBillModal):
       1. Choose number of splits
       2. Creates multiple payment links

STEP 5: PAYMENT PROCESSING
  a. QR Path: Customer scans QR in Xaman wallet -> signs XRPL transaction
  b. NFC Path: Customer taps NFC card -> server processes via pre-authorized signing
  c. SoundPay Path: Ultrasonic data exchange -> server processes payment
  d. Link Path: Customer opens link -> pays via Xaman or Web3Auth
  e. All paths result in XRPL transaction sending RLUSD to vendor wallet
  f. API returns: { success, tx_hash, receipt_id }
  g. Stock automatically decremented for tracked items

STEP 6: PAYMENT SUCCESS / RECEIPT
  a. POS shows success screen with checkmark
  b. Customer display shows "Payment Complete" with animation
  c. ReceiptActions component offers:
     - Print receipt (opens print dialog with formatted receipt)
     - Email receipt (EmailReceiptModal)
     - View on XRPL explorer (link to tx_hash)
  d. Receipt data from API includes:
     - Items, quantities, prices
     - Subtotal, tip amount, total
     - Conversion rate (GBP -> RLUSD) with source + timestamp
     - RLUSD amount settled
     - Transaction hash on XRPL
  e. Vendor taps "New Sale" to reset and start over
  f. "Repeat Last Order" option available to re-add previous cart

STEP 7: ONGOING MANAGEMENT
  a. Staff management (/staff):
     - Add/edit/delete staff with roles (admin, manager, cashier)
     - PIN for clock-in verification
     - Clock in/out with shift duration tracking
     - Staff photos (compressed to 200x200 JPEG)
  b. Products management (ProductsManager modal):
     - Full CRUD with categories, emojis/icons, images
     - CSV import (via Papa parse)
     - Inventory tracking with stock levels, low-stock alerts
     - Barcode assignment
  c. Analytics: Sales stats aggregated from receipt history
  d. Affiliate network: 5-level commission structure
     - Level 1: 25% | Level 2: 5% | Level 3: 3% | Level 4: 2% | Level 5: 1%
     - Partner referrals tracked via referral codes


================================================================================
7. KEY DATA MODELS
================================================================================

--- Product ---
{
  product_id: string        // Unique ID from API (e.g., "prod_xxx")
  name: string              // Product name
  price: number             // Price in GBP (e.g., 3.50)
  sku: string               // Stock Keeping Unit
  category: string | null   // Category name (e.g., "Hot Drinks")
  emoji: string | null      // Unicode emoji (e.g., "coffee")
  icon_id: string | null    // SVG icon ID from foodIcons library
  image_url: string | null  // Uploaded product image URL
  track_stock: boolean      // Whether inventory is tracked
  stock_quantity: number    // Current stock level
  low_stock_threshold: number // Alert threshold
  barcode: string | null    // UPC/EAN barcode
}

--- CartItem (extends Product) ---
{
  ...Product,
  quantity: number          // Quantity in cart
}

--- DisplayData (Customer Display State) ---
{
  store_name: string
  logo_url: string | null
  payment_id: string | null
  cart: CartItem[]          // { name, quantity, price, emoji, icon_id }
  subtotal: number
  total: number             // subtotal + tip
  status: "idle" | "ready" | "processing" | "success" | "error" |
          "qr" | "signup" | "split_pending" | "link_pending" | "soundpay"
  qr_code: string | null   // QR PNG data URL
  tip: number
  tips_enabled: boolean
  vendor_wallet: string | null
  last_updated: number | null
  split_payment: {
    parent_id: string
    total_splits: number
    paid_count: number
    split_ids: string[]
    all_paid: boolean
  } | null
}

--- WalletStatus ---
{
  funded: boolean           // Has minimum XRP balance
  xrp_balance: number      // XRP balance
  rlusd_trustline: boolean  // RLUSD trustline set
  rlusd_balance: number     // RLUSD balance
  usdc_trustline: boolean   // USDC trustline set
  usdc_balance: number      // USDC balance
  auto_signing_enabled: boolean  // Server can auto-sign NFC payments
}

--- Store ---
{
  store_id: string          // e.g., "store_xxx"
  store_name: string
  wallet_address: string    // XRPL address
  wallet_type: "xaman" | "crossmark" | "web3auth"
  logo_url: string | null
  referral_code: string     // For partner/affiliate recruitment
  commission_rates: number[]  // [25, 5, 3, 2, 1] (5 levels, percentages)
  daily_limit: number       // Max daily payout limit
  auto_sign_max_single_payout: number
  email: string
  store_url: string
  platform_return_url: string | null  // WordPress return URL
  platform_type: string | null        // "wordpress" etc.
  xaman_connected: boolean
  xaman_user_token: string | null
  api_secret: string        // Shown once on creation
}

--- StaffMember ---
{
  staff_id: string
  name: string
  photo_url: string | null  // Base64 JPEG (compressed 200x200)
  role: "admin" | "cashier" | "manager"
  pin: string | null        // 4-digit clock-in PIN
  hourly_rate: number | null
  created_at: string        // ISO date
  is_clocked_in: boolean
  current_shift_start: string | null  // ISO date
}

--- Shift ---
{
  shift_id: string
  staff_id: string
  staff_name: string
  clock_in: string          // ISO date
  clock_out: string | null  // ISO date (null if still active)
  duration_minutes: number | null
  total_sales: number | null
  tips_earned: number | null
}

--- Receipt ---
{
  receipt_id: string
  store_id: string
  store_name: string
  items: Array<{
    product_id: string
    name: string
    quantity: number
    unit_price: number
    line_total: number
  }>
  total: number             // GBP total
  tip_amount: number
  amount_rlusd: number      // RLUSD settled
  conversion_rate: {
    rlusd_gbp: number       // e.g., 0.74
    source: string          // "CoinGecko Pro"
    captured_at: string     // ISO timestamp
  }
  tx_hash: string           // XRPL transaction hash
  staff_id: string | null
  staff_name: string | null
  created_at: string
}

--- Affiliate ---
{
  affiliate_id: string
  wallet: string            // XRPL wallet address
  referral_code: string
  total_earned: number
  level: number             // 1-5
  parent_id: string | null
  created_at: string
}

--- Payout ---
{
  payout_id: string
  order_id: string
  order_total: number
  payments: Array<{
    wallet: string
    amount: number
    level: number
    type: string
    affiliate_id: string
  }>
  tx_hashes: Array<{
    wallet: string
    amount: number
    tx_hash: string
  }>
  paid_at: string
  auto_signed: boolean
}

--- ConversionRate ---
{
  success: boolean
  gbp: number
  rlusd: number
  rate: {
    rlusd_gbp: number       // RLUSD price in GBP
    rlusd_usd: number       // RLUSD price in USD
    gbp_to_rlusd: number    // How many RLUSD per 1 GBP
    source: string           // "CoinGecko Pro"
    source_url: string
    aggregated_from: string  // "600+ exchanges"
  }
  timestamp: string
  price_fetched_at: string
  price_age_ms: number
  compliance: {
    standard: string
    data_source: string
    manipulation_resistant: boolean
    jurisdiction: string
  }
}

--- PendingPayment (Payment Link) ---
{
  payment_id: string
  amount: number            // GBP amount
  status: string            // "pending" | "paid" | "expired" | "cancelled"
  created_at: string
  expires_at: string
  items: Array<{ name, quantity, price, unit_price, line_total }>
  tip: number
  currency: string          // "GBP"
}


================================================================================
8. LIBRARY FILES
================================================================================

lib/safeStorage.ts
  - sessionStorage wrapper with in-memory fallback
  - Handles: Safari private browsing, quota exceeded, SSR
  - Exports: safeGetItem, safeSetItem, safeRemoveItem, safeClear,
             safeGetJSON, safeSetJSON

lib/customerDisplay.ts
  - Functions to sync POS state to customer-facing display
  - updateCustomerDisplay(storeId, storeName, cart, total, status,
                          qrCode, tip, tipsEnabled, vendorWallet)
  - clearCustomerDisplay(storeId, storeName)
  - Posts to: NFC_API/display/update

lib/foodIcons.tsx
  - 100 SVG food/drink icons in 10 categories
  - Categories: Hot Drinks, Cold Drinks, Breakfast, Lunch, Snacks,
                Desserts, Fruits, Meals, Fast Food, Other
  - Exports: foodIcons[], foodIconCategories[], findIconForProduct(),
             getIconById(), FoodIcon interface

lib/walletAuth.ts
  - HMAC-signed authentication for protected API endpoints
  - In-memory token cache per wallet
  - Exports: refreshWalletAuth(walletAddress), getWalletAuthHeaders(),
             authenticatedFetch()

lib/web3auth.ts
  - Web3Auth SDK initialization for XRPL
  - Google/social login -> XRPL wallet address
  - Cached singleton instance
  - Exports: getWeb3Auth(), loginWithWeb3Auth(), WEB3AUTH_CLIENT_ID


================================================================================
END OF VENDOR FLOW MAP
================================================================================
