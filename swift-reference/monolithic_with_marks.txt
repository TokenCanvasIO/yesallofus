
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/about/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';


// MARK: - Component Definition
export default function About() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans">

      <main className="max-w-3xl mx-auto px-6 py-16">
        {/* Hero */}
        <div className="flex flex-col sm:flex-row items-center gap-6 mb-12 text-center sm:text-left">
          <img 
            src="/mark.jpg" 
            alt="Mark" 
            className="w-24 h-24 rounded-full object-cover"
          />
          <div>
            <h1 className="text-3xl font-bold mb-2">Hey, I&apos;m Mark</h1>
            {/* Added emphasis to the unique background */}
            <p className="text-zinc-400 font-semibold">Family therapist turned developer ¬∑ Guernsey</p>
          </div>
        </div>

        {/* The Name */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">Why YesAllofUs</h2>
          <div className="text-zinc-300 space-y-4">
            <p>
              The logo is two people embracing. That&apos;s what this is about.
            </p>
            <p>
              A commission isn&apos;t just money moving. It&apos;s two people agreeing to work together. 
              One embracing the other, and the other reciprocates. Both win. The logo shows that ‚Äî two forms connected, 
              value flowing between them.
            </p>
            <p>
              YesAllofUs means everyone gets their share. The affiliate in Lagos gets paid 
              the same speed as the one in Guernsey. The creator with 100 followers and the one 
              with 100,000. The small shop and the big brand. All of us.
            </p>
          </div>
        </section>

        {/* Why I Built This */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">Why I Built This</h2>
          <div className="text-zinc-300 space-y-4">
            <p>
              XRPL proclaimed to be able to create a level playing field.
              This is a profound notion. With a phone and an internet 
              connection, someone can promote a product, earn a commission, and get paid 
              instantly. No bank account. No payment country restrictions. No 30-day wait. 
              No minimum threshold. Any where in the world.
            </p>
            <p>
              That&apos;s economic mobility. That&apos;s what I want to build.
            </p>
            <p>
              The business case is simple too ‚Äî instant payouts make affiliates more loyal, 
              more motivated, more likely to promote again. Everyone wins.
            </p>
          </div>
        </section>

        {/* What Makes It Different - Updated Non-Custodial Description */}
<section className="mb-12">
  <h2 className="text-xl font-bold mb-4 text-center sm:text-left">How It Works</h2>
  <div className="grid sm:grid-cols-3 gap-4">
    <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-5 text-center">
      <div className="text-2xl mb-2">‚ö°</div>
      <h3 className="font-semibold mb-1">4 Seconds</h3>
      <p className="text-zinc-400 text-sm">Sale completes, affiliate gets paid. Not 30 days. Now.</p>
    </div>
    <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-5 text-center">
      <div className="text-2xl mb-2">üîê</div>
      <h3 className="font-semibold mb-1">Non-Custodial</h3>
      <p className="text-zinc-400 text-sm">Your wallet, your keys. We never touch your funds. You set the spending limits.</p>
    </div>
    <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-5 text-center">
      <div className="text-2xl mb-2">üåç</div>
      <h3 className="font-semibold mb-1">Everywhere</h3>
      <p className="text-zinc-400 text-sm">No borders. No bank required. Just a wallet and a phone.</p>
    </div>
  </div>
</section>

        {/* Background - Updated with XRPL Context */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">My Background</h2>
          <div className="text-zinc-300 space-y-4">
            <p>
              I&apos;m a family therapist. I&apos;ve spent years working with children in care, 
              helping people navigate systems.
            </p>
            <p>
              That work taught me something: connection matters. People thrive when they&apos;re 
              part of something, when they&apos;re not left behind. That&apos;s what I&apos;m trying 
              to build here ‚Äî infrastructure that includes everyone.
            </p>
            <p>
              I started coding in June 2025. No CS degree. Just curiosity, late nights, and AI 
              as my engineering partner. Five months later, I&apos;d built three production platforms, all running on the XRPL:
            </p>
            <ul className="space-y-2">
              <li className="flex items-start gap-3">
                <span className="text-emerald-400">‚Üí</span>
                <div>
                  <a href="https://tokencanvas.io" target="_blank" rel="noopener noreferrer" className="text-white hover:text-zinc-300">TokenCanvas.io</a>
                  <span className="text-zinc-500 ml-2">‚Äî Crypto portfolio tracker</span>
                </div>
              </li>
              <li className="flex items-start gap-3">
                <span className="text-emerald-400">‚Üí</span>
                <div>
                  <a href="https://xrp3d.ai" target="_blank" rel="noopener noreferrer" className="text-white hover:text-zinc-300">XRP3D.ai</a>
                  <span className="text-zinc-500 ml-2">‚Äî AI-powered NFT conversion</span>
                </div>
              </li>
              <li className="flex items-start gap-3">
                <span className="text-emerald-400">‚Üí</span>
                <div>
                  <a href="https://xrpmemecoins.com" target="_blank" rel="noopener noreferrer" className="text-white hover:text-zinc-300">XRPMemeCoins.com</a>
                  <span className="text-zinc-500 ml-2">‚Äî #7 on Google for &quot;xrp memecoins&quot;</span>
                </div>
              </li>
            </ul>
            <p>
              YesAllofUs is the next step. Real infrastructure for real businesses. 
              Built on rails I believe will run for the next 100 years.
            </p>
          </div>
        </section>

        {/* What I Believe */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">What I Believe</h2>
          <div className="text-zinc-300 space-y-4">
            <p>
              Don&apos;t let anything get in the way of human goodness.
            </p>
            <p>
              Be grateful every day. Give OTHERS a chance. Take your chances. 
              Build things that matter. Die knowing you tried with everything you had.
            </p>
          </div>
        </section>

        {/* Contact */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">Get In Touch</h2>
          <div className="bg-zinc-900 border border-zinc-800 rounded-lg p-6">
            <p className="text-zinc-300 mb-6">
              Questions? Want to talk integration? Or just want to say hi?
            </p>
            <div className="flex flex-col sm:flex-row gap-4">
              <a 
                href="mailto:mark@yesallofus.com" 
                className="inline-flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-4 py-3 rounded-lg transition-colors"
              >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                mark@yesallofus.com
              </a>
              <a 
                href="https://x.com/YesAllofUs" 
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-4 py-3 rounded-lg transition-colors"
              >
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                </svg>
                @YesAllofUs
              </a>
              <a 
                href="https://calendly.com/tokencanvasio/30min" 
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-4 py-3 rounded-lg transition-colors"
              >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Book a call
              </a>
            </div>
          </div>
        </section>

      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/acceptable-use/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React, { useState, ReactNode } from 'react';


// MARK: - Component Definition
export default function AcceptableUsePolicy() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-12">
          <h1 className="text-4xl font-bold text-slate-900 mb-4">Acceptable Use Policy</h1>
          <p className="text-slate-600">Last updated: 28 November 2025</p>
        </div>

        {/* Introduction */}
        <div className="bg-red-50 border border-red-200 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-red-900 mb-3">‚ö†Ô∏è Zero Tolerance Policy</h2>
          <p className="text-red-800 text-sm">
            YesAllofUs has a zero tolerance policy for illegal activity, fraud, and abuse. Violations will result in immediate account termination and may be reported to law enforcement. We reserve the right to refuse service to anyone.
          </p>
        </div>

        {/* Content */}
        <div className="prose prose-slate max-w-none">

          {/* Purpose */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Purpose</h2>
            <p className="text-slate-700 mb-4">
              This Acceptable Use Policy (&quot;AUP&quot;) defines the rules and guidelines for using YesAllofUs. It is designed to protect our users, affiliates, and the broader community from harm. By using YesAllofUs, you agree to comply with this policy.
            </p>
            <p className="text-slate-700">
              This AUP is incorporated into and forms part of our <a href="/terms" className="text-blue-600 hover:underline">Terms of Service</a>.
            </p>
          </section>

          {/* Prohibited Activities */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Prohibited Activities</h2>
            <p className="text-slate-700 mb-6">You may NOT use YesAllofUs for any of the following:</p>

            {/* Illegal Activities */}
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span className="text-red-500">üö´</span> Illegal Activities
              </h3>
              <ul className="list-disc pl-6 text-slate-700 space-y-2">
                <li><strong>Money laundering</strong> or terrorist financing</li>
                <li><strong>Tax evasion</strong> or facilitating tax fraud</li>
                <li><strong>Selling illegal goods</strong> including drugs, weapons, counterfeit items, or stolen property</li>
                <li><strong>Human trafficking</strong> or exploitation of any kind</li>
                <li><strong>Child exploitation material</strong> (CSAM) ‚Äî we report all instances to NCMEC/IWF</li>
                <li><strong>Illegal gambling</strong> or unlicensed gaming operations</li>
                <li><strong>Securities fraud</strong> or market manipulation</li>
                <li><strong>Intellectual property theft</strong> or piracy</li>
                <li>Any activity that violates applicable laws or regulations</li>
              </ul>
            </div>

            {/* Fraud & Deception */}
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span className="text-red-500">üö´</span> Fraud &amp; Deception
              </h3>
              <ul className="list-disc pl-6 text-slate-700 space-y-2">
                <li><strong>Phishing</strong> or impersonating other businesses or individuals</li>
                <li><strong>Fake affiliate schemes</strong> or pyramid schemes</li>
                <li><strong>Click fraud</strong> or artificial inflation of referrals</li>
                <li><strong>Self-referrals</strong> or referring yourself under fake identities</li>
                <li><strong>Chargebacks fraud</strong> or disputing legitimate transactions</li>
                <li><strong>Misrepresenting products</strong> or making false claims</li>
                <li>Creating multiple accounts to circumvent limits or bans</li>
              </ul>
            </div>

            {/* Harmful Content */}
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span className="text-red-500">üö´</span> Harmful Content
              </h3>
              <ul className="list-disc pl-6 text-slate-700 space-y-2">
                <li><strong>Hate speech</strong> or content promoting violence against protected groups</li>
                <li><strong>Harassment or bullying</strong> of any individual</li>
                <li><strong>Doxxing</strong> or sharing private information without consent</li>
                <li><strong>Revenge porn</strong> or non-consensual intimate images</li>
                <li><strong>Terrorism promotion</strong> or extremist content</li>
                <li><strong>Self-harm promotion</strong> or suicide encouragement</li>
                <li><strong>Animal cruelty</strong> content or promotion</li>
              </ul>
            </div>

            {/* Technical Abuse */}
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span className="text-red-500">üö´</span> Technical Abuse
              </h3>
              <ul className="list-disc pl-6 text-slate-700 space-y-2">
                <li><strong>Hacking attempts</strong> or unauthorised access to systems</li>
                <li><strong>Malware distribution</strong> or virus spreading</li>
                <li><strong>DDoS attacks</strong> or intentional service disruption</li>
                <li><strong>Scraping beyond rate limits</strong> or data harvesting</li>
                <li><strong>Reverse engineering</strong> our software or API</li>
                <li><strong>Circumventing security measures</strong> or access controls</li>
                <li><strong>Exploiting vulnerabilities</strong> without responsible disclosure</li>
                <li><strong>API abuse</strong> or excessive automated requests</li>
              </ul>
            </div>

            {/* Spam & Abuse */}
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-slate-800 mb-4 flex items-center gap-2">
                <span className="text-red-500">üö´</span> Spam &amp; Abuse
              </h3>
              <ul className="list-disc pl-6 text-slate-700 space-y-2">
                <li><strong>Spamming</strong> referral links or unsolicited marketing</li>
                <li><strong>Fake reviews</strong> or testimonials</li>
                <li><strong>Bot-generated traffic</strong> or artificial engagement</li>
                <li><strong>Cookie stuffing</strong> or affiliate fraud techniques</li>
                <li><strong>Domain squatting</strong> or typosquatting to capture traffic</li>
              </ul>
            </div>
          </section>

          {/* Restricted Businesses */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Restricted Business Categories</h2>
            <p className="text-slate-700 mb-4">
              The following business types require prior approval before using YesAllofUs. Contact us at <a href="mailto:mark@yesallofus.com" className="text-blue-600">mark@yesallofus.com</a> for review:
            </p>

            <div className="grid md:grid-cols-2 gap-4">
              <div className="border border-amber-200 bg-amber-50 rounded-lg p-4">
                <h4 className="font-semibold text-amber-900 mb-2">‚ö†Ô∏è Requires Approval</h4>
                <ul className="text-amber-800 text-sm space-y-1">
                  <li>‚Ä¢ Adult content (legal, age-verified)</li>
                  <li>‚Ä¢ CBD/hemp products (where legal)</li>
                  <li>‚Ä¢ Cryptocurrency trading platforms</li>
                  <li>‚Ä¢ NFT marketplaces</li>
                  <li>‚Ä¢ Licensed gambling/gaming</li>
                  <li>‚Ä¢ Firearms (where legal)</li>
                  <li>‚Ä¢ Alcohol (where legal)</li>
                  <li>‚Ä¢ Tobacco/vaping products</li>
                  <li>‚Ä¢ Multi-level marketing</li>
                  <li>‚Ä¢ High-risk supplements</li>
                </ul>
              </div>
              <div className="border border-slate-200 bg-slate-50 rounded-lg p-4">
                <h4 className="font-semibold text-slate-900 mb-2">Why Approval?</h4>
                <p className="text-slate-600 text-sm">
                  These industries have additional legal requirements, age restrictions, or higher fraud risk. We review each case individually to ensure compliance and protect all parties.
                </p>
                <p className="text-slate-600 text-sm mt-2">
                  Approval is not guaranteed. Operating in these categories without approval will result in immediate termination.
                </p>
              </div>
            </div>
          </section>

          {/* Affiliate Conduct */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Affiliate Conduct Standards</h2>
            <p className="text-slate-700 mb-4">
              As a store using YesAllofUs, you are responsible for ensuring your affiliates comply with these standards:
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Affiliates MUST:</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Disclose their affiliate relationship in compliance with FTC guidelines</li>
              <li>Make honest and accurate claims about products</li>
              <li>Respect intellectual property rights</li>
              <li>Comply with all applicable advertising laws</li>
              <li>Use only approved marketing materials and claims</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Affiliates MUST NOT:</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li>Use spam or unsolicited marketing</li>
              <li>Make false or exaggerated claims</li>
              <li>Bid on brand keywords without permission</li>
              <li>Use cookie stuffing or click fraud</li>
              <li>Create fake reviews or testimonials</li>
              <li>Impersonate the brand or its employees</li>
            </ul>
          </section>

          {/* API Usage */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">API Usage Guidelines</h2>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Rate Limits</h3>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Limit Type</th>
                  <th className="px-4 py-2 text-left text-slate-700">Limit</th>
                  <th className="px-4 py-2 text-left text-slate-700">Window</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">Per IP Address</td>
                  <td className="px-4 py-2">60 requests</td>
                  <td className="px-4 py-2">1 minute</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Per Store (payouts)</td>
                  <td className="px-4 py-2">10 requests</td>
                  <td className="px-4 py-2">1 minute</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Daily Payout Volume</td>
                  <td className="px-4 py-2">$1,000 default</td>
                  <td className="px-4 py-2">24 hours</td>
                </tr>
              </tbody>
            </table>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">API Best Practices</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li>Use exponential backoff for retries</li>
              <li>Cache responses where appropriate</li>
              <li>Don&apos;t poll more frequently than necessary</li>
              <li>Handle rate limit responses (429) gracefully</li>
              <li>Use webhooks instead of polling when available</li>
              <li>Keep your API credentials secure</li>
            </ul>
          </section>

          {/* Reporting */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Reporting Violations</h2>
            <p className="text-slate-700 mb-4">
              If you become aware of any violation of this policy, please report it immediately:
            </p>
            <div className="bg-slate-50 rounded-lg p-6">
              <p className="text-slate-700"><strong>Email:</strong> <a href="mailto:mark@yesallofus.com" className="text-blue-600">mark@yesallofus.com</a></p>
              <p className="text-slate-700 mt-2"><strong>Include:</strong></p>
              <ul className="list-disc pl-6 text-slate-600 text-sm mt-1">
                <li>Description of the violation</li>
                <li>Store name or wallet address involved</li>
                <li>Supporting evidence (screenshots, URLs, etc.)</li>
                <li>Your contact information (optional but helpful)</li>
              </ul>
            </div>
            <p className="text-slate-700 mt-4">
              We investigate all reports promptly and take action as appropriate. Reporters may remain anonymous.
            </p>
          </section>

          {/* Enforcement */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Enforcement</h2>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Actions We May Take</h3>
            <p className="text-slate-700 mb-4">Depending on the severity and nature of the violation, we may:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li><strong>Issue a warning</strong> and request corrective action</li>
              <li><strong>Temporarily suspend</strong> your account pending investigation</li>
              <li><strong>Permanently terminate</strong> your account without refund</li>
              <li><strong>Withhold pending payouts</strong> where fraud is suspected</li>
              <li><strong>Report to law enforcement</strong> for illegal activity</li>
              <li><strong>Pursue legal action</strong> for damages caused</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Appeal Process</h3>
            <p className="text-slate-700 mb-4">
              If you believe an enforcement action was made in error, you may appeal by emailing <a href="mailto:mark@yesallofus.com" className="text-blue-600">mark@yesallofus.com</a> within 14 days. Include:
            </p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li>Your store ID</li>
              <li>The enforcement action taken</li>
              <li>Why you believe it was an error</li>
              <li>Any supporting evidence</li>
            </ul>
            <p className="text-slate-700 mt-4">
              We will review appeals within 7 business days. Our decision on appeal is final.
            </p>
          </section>

          {/* Changes */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Changes to This Policy</h2>
            <p className="text-slate-700">
              We may update this Acceptable Use Policy from time to time. Material changes will be communicated via email. Continued use of YesAllofUs after changes take effect constitutes acceptance of the updated policy.
            </p>
          </section>

          {/* Contact */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Contact</h2>
            <p className="text-slate-700 mb-4">Questions about this policy?</p>
            <div className="bg-slate-50 rounded-lg p-6">
              <p className="text-slate-700"><strong>General inquiries:</strong> <a href="mailto:mark@yesallofus.com" className="text-blue-600">mark@yesallofus.com</a></p>
            </div>
          </section>

        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/affiliate-terms/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React from 'react';


// MARK: - Component Definition
export default function AffiliateTerms() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-12">
          <h1 className="text-4xl font-bold text-slate-900 mb-4">Affiliate Program Terms</h1>
          <p className="text-slate-600">Last updated: 29 November 2025</p>
        </div>

        {/* Plain English Summary */}
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-blue-900 mb-3">üìã Plain English Summary</h2>
          <p className="text-blue-800 text-sm leading-relaxed mb-4">
            Before the legal language, here&apos;s what you&apos;re agreeing to in simple terms:
          </p>
          <ul className="text-blue-800 text-sm space-y-2">
            <li><strong>You earn commissions</strong> on sales you refer. The store sets the rates and commission levels ‚Äî these vary by merchant.</li>
            <li><strong>Payments are instant</strong> in RLUSD to your XRPL wallet. You need an RLUSD trustline to receive payments.</li>
            <li><strong>Don&apos;t spam or cheat.</strong> No fake referrals, no bidding on the store&apos;s trademarks, no misleading claims.</li>
            <li><strong>You handle your own taxes.</strong> Commission payments are income ‚Äî report them accordingly.</li>
            <li><strong>The store can remove you</strong> at any time for any reason. Earned commissions already paid are yours.</li>
            <li><strong>Payments are final.</strong> Blockchain transactions cannot be reversed.</li>
          </ul>
        </div>

        {/* Table of Contents */}
        <div className="bg-slate-50 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-slate-900 mb-4">Table of Contents</h2>
          <ol className="text-sm text-slate-600 space-y-2 columns-2">
            <li><a href="#relationship" className="hover:text-blue-600">1. The Relationship</a></li>
            <li><a href="#commission-structure" className="hover:text-blue-600">2. Commission Structure</a></li>
            <li><a href="#payments" className="hover:text-blue-600">3. How You Get Paid</a></li>
            <li><a href="#referral-link" className="hover:text-blue-600">4. Your Referral Link</a></li>
            <li><a href="#prohibited" className="hover:text-blue-600">5. Prohibited Activities</a></li>
            <li><a href="#responsibilities" className="hover:text-blue-600">6. Your Responsibilities</a></li>
            <li><a href="#merchant-rights" className="hover:text-blue-600">7. Merchant&apos;s Rights</a></li>
            <li><a href="#no-guarantees" className="hover:text-blue-600">8. No Guarantees</a></li>
            <li><a href="#termination" className="hover:text-blue-600">9. Termination</a></li>
            <li><a href="#liability" className="hover:text-blue-600">10. Limitation of Liability</a></li>
            <li><a href="#platform" className="hover:text-blue-600">11. YesAllofUs Platform</a></li>
            <li><a href="#changes" className="hover:text-blue-600">12. Changes to Terms</a></li>
            <li><a href="#contact" className="hover:text-blue-600">13. Contact</a></li>
          </ol>
        </div>

        {/* Terms Content */}
        <div className="prose prose-slate max-w-none">

          {/* 1. The Relationship */}
          <section id="relationship" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">1. The Relationship</h2>
            <p className="text-slate-700 mb-4">
              When you sign up as an affiliate, you are entering an agreement with the store (the &quot;Merchant&quot;), not with YesAllofUs. YesAllofUs provides the payment infrastructure ‚Äî the Merchant sets the rules.
            </p>
            <p className="text-slate-700 mb-4">
              You are an independent contractor, not an employee of the Merchant or YesAllofUs.
            </p>
          </section>

          {/* 2. Commission Structure */}
          <section id="commission-structure" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">2. Commission Structure</h2>
            <p className="text-slate-700 mb-4">
              Commission rates and levels are set by each Merchant and may vary. The Merchant determines:
            </p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>The commission percentage for direct referrals (Level 1)</li>
              <li>Whether multi-level commissions apply (Levels 2-5)</li>
              <li>The rates for each level, if applicable</li>
            </ul>
            <p className="text-slate-700 mb-4">
              The Merchant may change commission rates at any time. Check with the Merchant for their current rates.
            </p>
            <p className="text-slate-700 mb-4">
              Commissions are calculated on the order total and paid when the order is marked complete.
            </p>
          </section>

          {/* 3. How You Get Paid */}
          <section id="payments" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">3. How You Get Paid</h2>
            <p className="text-slate-700 mb-4">
              Payments are made instantly in RLUSD on the XRP Ledger.
            </p>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Requirements</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>A valid XRPL wallet address</li>
              <li>An active RLUSD trustline to the issuer (rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De)</li>
            </ul>

            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
              <p className="text-amber-800 text-sm">
                <strong>Important:</strong> If your wallet lacks a trustline, payments will be skipped. Learn how to set up your RLUSD trustline: <a href="https://help.xaman.app/app/getting-started-with-xaman/how-to-create-a-rlusd-trust-line" target="_blank" rel="noopener noreferrer" className="text-amber-900 underline hover:no-underline">Xaman RLUSD Trustline Guide ‚Üí</a>
              </p>
            </div>

            <p className="text-slate-700 mb-4">
              <strong>Payments are final.</strong> Once a transaction is recorded on the blockchain, it cannot be reversed.
            </p>
          </section>

          {/* 4. Your Referral Link */}
          <section id="referral-link" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">4. Your Referral Link</h2>
            <p className="text-slate-700 mb-4">
              You receive a unique referral code and link. When someone clicks your link and makes a purchase within the cookie period (set by the Merchant, typically 30 days), you earn commission.
            </p>
            <p className="text-slate-700 mb-4">You may share your link via:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Social media</li>
              <li>Your website or blog</li>
              <li>Email to people who have opted in</li>
              <li>YouTube, podcasts, or other content</li>
            </ul>
          </section>

          {/* 5. Prohibited Activities */}
          <section id="prohibited" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">5. Prohibited Activities</h2>
            <p className="text-slate-700 mb-4">You must not:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li><strong>Spam</strong> ‚Äî No unsolicited emails, DMs, or messages</li>
              <li><strong>Self-refer</strong> ‚Äî No using your own link for personal purchases</li>
              <li><strong>Trademark bidding</strong> ‚Äî No paid ads on the Merchant&apos;s brand name or variations</li>
              <li><strong>Cookie stuffing</strong> ‚Äî No forcing cookies without genuine clicks</li>
              <li><strong>False claims</strong> ‚Äî No misleading statements about products or earnings</li>
              <li><strong>Incentivised clicks</strong> ‚Äî No paying people just to click your link</li>
              <li><strong>Fraud</strong> ‚Äî No fake orders, chargebacks, or manipulation</li>
            </ul>
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
              <p className="text-red-800 text-sm">
                <strong>Warning:</strong> Violation results in immediate termination and forfeiture of unpaid commissions.
              </p>
            </div>
          </section>

          {/* 6. Your Responsibilities */}
          <section id="responsibilities" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">6. Your Responsibilities</h2>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Disclose your affiliate relationship as required by UK regulations, local law enforcement agencies, or other applicable authorities in your jurisdiction</li>
              <li>Pay taxes on your commission income</li>
              <li>Keep your wallet address and trustline active</li>
              <li>Comply with all applicable laws in your jurisdiction</li>
            </ul>
          </section>

          {/* 7. Merchant's Rights */}
          <section id="merchant-rights" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">7. Merchant&apos;s Rights</h2>
            <p className="text-slate-700 mb-4">The Merchant may:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Reject your application</li>
              <li>Terminate your affiliate status at any time</li>
              <li>Change commission rates or structure</li>
              <li>Withhold or reverse commissions on fraudulent or refunded orders</li>
              <li>Modify program terms with notice</li>
            </ul>
          </section>

          {/* 8. No Guarantees */}
          <section id="no-guarantees" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">8. No Guarantees</h2>
            <p className="text-slate-700 mb-4">
              Participation does not guarantee earnings. Your results depend on your efforts, audience, and market conditions.
            </p>
            <p className="text-slate-700 mb-4">
              YesAllofUs and the Merchant make no representations about potential income.
            </p>
          </section>

          {/* 9. Termination */}
          <section id="termination" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">9. Termination</h2>
            <p className="text-slate-700 mb-4">
              Either you or the Merchant can end the relationship at any time.
            </p>
            <p className="text-slate-700 mb-4">On termination:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Your referral link stops working</li>
              <li>Pending commissions on completed orders will still be paid</li>
              <li>Commissions on future orders will not be paid</li>
            </ul>
          </section>

          {/* 10. Limitation of Liability */}
          <section id="liability" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">10. Limitation of Liability</h2>
            <p className="text-slate-700 mb-4">Neither the Merchant nor YesAllofUs is liable for:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Lost commissions due to technical issues</li>
              <li>Wallet or trustline problems on your end</li>
              <li>Changes in RLUSD value</li>
              <li>Orders that are refunded or charged back</li>
            </ul>
            <p className="text-slate-700 mb-4">
              Maximum liability is limited to commissions actually earned but unpaid.
            </p>
          </section>

          {/* 11. YesAllofUs Platform */}
          <section id="platform" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">11. YesAllofUs Platform</h2>
            <p className="text-slate-700 mb-4">
              YesAllofUs provides the payment infrastructure. By participating in any affiliate program powered by YesAllofUs, you also agree to the <a href="/terms" className="text-blue-600 hover:underline">YesAllofUs Terms of Service</a>.
            </p>
            <p className="text-slate-700 mb-4">
              YesAllofUs is not a party to disputes between you and the Merchant.
            </p>
          </section>

          {/* 12. Changes to Terms */}
          <section id="changes" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">12. Changes to Terms</h2>
            <p className="text-slate-700 mb-4">
              These terms may be updated. Continued participation after changes constitutes acceptance.
            </p>
          </section>

          {/* 13. Contact */}
          <section id="contact" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">13. Contact</h2>
            <p className="text-slate-700 mb-4">
              For questions about a specific affiliate program, contact the Merchant directly.
            </p>
            <div className="bg-slate-50 rounded-lg p-6">
              <p className="text-slate-700 mb-2">For questions about the YesAllofUs platform:</p>
              <p className="text-slate-700">
                <strong>Email:</strong> <a href="mailto:mark@yesallofus.com" className="text-blue-600 hover:underline">mark@yesallofus.com</a>
              </p>
              <p className="text-slate-700">
                <strong>Website:</strong> <a href="https://YesAllofUs.com" className="text-blue-600 hover:underline">https://YesAllofUs.com</a>
              </p>
            </div>
          </section>

        </div>

        {/* Acceptance */}
        <div className="border-t border-slate-200 pt-8 mt-12">
          <p className="text-slate-600 text-sm">
            By registering as an affiliate, you acknowledge that you have read, understood, and agree to be bound by these Affiliate Program Terms.
          </p>
        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/announcements/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';


// MARK: - Component Definition
export default function Announcements() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans">

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-12">
          <div className="flex items-center gap-3 mb-4">
            <span className="text-3xl">üì¢</span>
            <h1 className="text-4xl font-bold">Announcements</h1>
          </div>
          <p className="text-zinc-400">Platform updates and news from YesAllofUs</p>
        </div>

        {/* Announcements Timeline */}
        <div className="space-y-8">

          {/* Web3Auth Announcement - NEW */}
          <article className="relative">
            <div className="absolute -left-3 top-0 w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center">
              <svg className="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
            </div>
            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6 ml-6">
              <div className="flex items-center gap-3 mb-3">
                <span className="bg-emerald-500/20 text-emerald-400 text-xs font-semibold px-2 py-1 rounded">NEW</span>
                <span className="text-zinc-500 text-sm">December 2025</span>
              </div>
              <h2 className="text-xl font-bold mb-3">üîê Social Login Now Available</h2>
              <div className="text-zinc-300 space-y-3">
                <p>
                  No wallet? No problem. Affiliates can now sign up with their existing social accounts ‚Äî no crypto knowledge required.
                </p>
                <div className="flex items-center gap-3 my-4">
                  <div className="flex -space-x-2">
                    <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center border-2 border-zinc-900">
                      <svg className="w-4 h-4" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                      </svg>
                    </div>
                    <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
                      <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                      </svg>
                    </div>
                    <div className="w-8 h-8 bg-[#1877F2] rounded-full flex items-center justify-center border-2 border-zinc-900">
                      <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                      </svg>
                    </div>
                    <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
                      <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                      </svg>
                    </div>
                    <div className="w-8 h-8 bg-[#5865F2] rounded-full flex items-center justify-center border-2 border-zinc-900">
                      <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                      </svg>
                    </div>
                    <div className="w-8 h-8 bg-[#24292e] rounded-full flex items-center justify-center border-2 border-zinc-900">
                      <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                      </svg>
                    </div>
                  </div>
                  <span className="text-zinc-400 text-sm">Google, Apple, Facebook, X, Discord, GitHub & more</span>
                </div>
                <p><strong>How it works:</strong></p>
                <ul className="list-disc pl-5 space-y-1 text-zinc-400">
                  <li>Sign in with any social account</li>
                  <li>Real XRPL wallet created automatically via Web3Auth MPC</li>
                  <li>Private keys split across nodes ‚Äî never stored whole</li>
                  <li>0 XRP to start your wallet.</li>
                   <li>Commissions held until wallet is funded (1.5 XRP)</li>
                  <li>24/7 automatic payouts ‚Äî no browser session needed</li>
                </ul>
                <p className="text-zinc-500 text-sm mt-4">
                  This removes the biggest barrier to affiliate adoption. Your affiliates don&apos;t need to understand crypto ‚Äî they just sign in and earn.
                </p>
              </div>
            </div>
          </article>

          {/* Partnership Progress - NEW */}
<article className="relative">
  <div className="absolute -left-3 top-0 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
    <svg className="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
    </svg>
  </div>
  <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6 ml-6">
    <div className="flex items-center gap-3 mb-3">
      <span className="bg-blue-500/20 text-blue-400 text-xs font-semibold px-2 py-1 rounded">UPDATE</span>
      <span className="text-zinc-500 text-sm">December 2025</span>
    </div>
    <h2 className="text-xl font-bold mb-3">ü§ù Partnerships & Regulatory Progress</h2>
    <div className="text-zinc-300 space-y-4">
      
      <div className="bg-zinc-800/50 rounded-lg p-4">
        <h3 className="font-semibold text-white mb-2">üá´üá∑ XRPL Commons Residency? ‚Äî Paris 2026</h3>
        <p className="text-zinc-400 text-sm">
          Working with XRPL Commons. 
          Met the team in Paris December 2025 to discuss scaling YesAllofUs across the XRPL ecosystem.
        </p>
      </div>

      <div className="bg-zinc-800/50 rounded-lg p-4">
        <h3 className="font-semibold text-white mb-2">üá¨üá¨ GFSC Sandbox Discussions ‚Äî Guernsey</h3>
        <p className="text-zinc-400 text-sm">
          In active discussions with the Guernsey Financial Services Commission regarding 
          their regulatory sandbox. Working to ensure YesAllofUs is compliant from day one.
        </p>
      </div>

      <div className="bg-zinc-800/50 rounded-lg p-4">
        <h3 className="font-semibold text-white mb-2">üîí Strategic Partnership (Unannounced)</h3>
        <p className="text-zinc-400 text-sm">
          In talks with a newly forming stablecoin and tokenized asset exchange based in Guernsey. 
          Can&apos;t share details yet, but this could significantly accelerate our go-to-market.
        </p>
      </div>

    </div>
  </div>
</article>

          {/* Launch Announcement */}
          <article className="relative">
            <div className="absolute -left-3 top-0 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center">
              <svg className="w-3 h-3 text-black" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
            </div>
            <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-6 ml-6">
              <div className="flex items-center gap-3 mb-3">
                <span className="bg-amber-500/20 text-amber-400 text-xs font-semibold px-2 py-1 rounded">PINNED</span>
                <span className="text-zinc-500 text-sm">28 November 2025</span>
              </div>
              <h2 className="text-xl font-bold mb-3">üöÄ YesAllofUs is Live</h2>
              <div className="text-zinc-300 space-y-3">
                <p>
                  YesAllofUs is now open. Instant affiliate commission payments on the XRP Ledger.
                </p>
                <p><strong>What&apos;s ready:</strong></p>
                <ul className="list-disc pl-5 space-y-1 text-zinc-400">
                  <li>WordPress/WooCommerce plugin</li>
                  <li>CLI tool ‚Äî <code className="bg-zinc-800 px-1 rounded">npx YesAllofUs</code></li>
                  <li>Full REST API</li>
                  <li>Xaman wallet connection (mobile)</li>
                  <li>Crossmark wallet connection (browser)</li>
                  <li>Social login via Web3Auth (no wallet needed)</li>
                  <li>5-level commission structure</li>
                  <li>RLUSD payouts in ~4 seconds</li>
                </ul>
              </div>
            </div>
          </article>

          {/* What's Been Built */}
          <article className="relative">
            <div className="absolute -left-3 top-0 w-6 h-6 bg-sky-500 rounded-full flex items-center justify-center">
              <svg className="w-3 h-3 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 ml-6">
              <div className="flex items-center gap-3 mb-3">
                <span className="bg-sky-500/20 text-sky-400 text-xs font-semibold px-2 py-1 rounded">BUILT</span>
                <span className="text-zinc-500 text-sm">November 2025</span>
              </div>
              <h2 className="text-xl font-bold mb-3">‚úÖ What&apos;s Been Built</h2>
              <div className="text-zinc-300 space-y-4">
                
                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">WordPress Plugin</h3>
                  <p className="text-zinc-400 text-sm">
                    Full WooCommerce integration. Installs in minutes. Handles affiliate registration, 
                    referral tracking, and automatic commission payouts when orders complete.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">CLI Tool</h3>
                  <p className="text-zinc-400 text-sm">
                    Run <code className="bg-zinc-900 px-1 rounded">npx YesAllofUs</code> to register your store and get API credentials. 
                    No installation required.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Wallet Connections</h3>
                  <p className="text-zinc-400 text-sm">
                    Xaman (mobile), Crossmark (browser extension), and Social Login (Web3Auth) all working. 
                    Connect your XRPL wallet or create one instantly with a social account.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Web3Auth Integration</h3>
                  <p className="text-zinc-400 text-sm">
                    MPC-based wallet creation via social login. Affiliates sign up with Google, Apple, Facebook, X, Discord, or GitHub. 
                    No seed phrases. No wallet apps. Real XRPL addresses with 24/7 auto-sign capability.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Server Infrastructure</h3>
                  <p className="text-zinc-400 text-sm">
                    API servers running on DigitalOcean. Cloudflare for CDN and security. 
                    Redis for session management. PM2 for process management.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Security</h3>
                  <p className="text-zinc-400 text-sm">
                    High-level security for your XRP and data. 2FA authentication, advanced firewall protection, 
                    automated intrusion detection, and 24/7 monitoring. Servers hardened with SSH port changes, 
                    Fail2Ban protection, and automatic security updates.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Documentation</h3>
                  <p className="text-zinc-400 text-sm">
                    Full API docs, WordPress guide, FAQ, and legal pages (Terms, Privacy, Acceptable Use, Cookies).
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Booking System</h3>
                  <p className="text-zinc-400 text-sm">
                    Calendly integration for the done-for-you setup service. 
                    <a href="https://calendly.com/tokencanvasio/30min" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline ml-1">Book a call</a> and I&apos;ll get you set up personally.
                  </p>
                </div>

              </div>
            </div>
          </article>

          {/* What's In Progress */}
          <article className="relative">
            <div className="absolute -left-3 top-0 w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center">
              <svg className="w-3 h-3 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 ml-6">
              <div className="flex items-center gap-3 mb-3">
                <span className="bg-purple-500/20 text-purple-400 text-xs font-semibold px-2 py-1 rounded">IN PROGRESS</span>
                <span className="text-zinc-500 text-sm">December 2025</span>
              </div>
              <h2 className="text-xl font-bold mb-3">üî® What I&apos;m Working On</h2>
              <div className="text-zinc-300 space-y-4">

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Company Formation</h3>
                  <p className="text-zinc-400 text-sm">
                    Working with regulators in Guernsey to properly structure YesAllofUs. 
                    Making sure everything is compliant from day one.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">Local Business Partnerships</h3>
                  <p className="text-zinc-400 text-sm">
                    Meeting with business leaders in Guernsey to build relationships and 
                    get YesAllofUs in front of the right people.
                  </p>
                </div>

                <div className="bg-zinc-800/50 rounded-lg p-4">
                  <h3 className="font-semibold text-white mb-2">XRPL Commons Residency</h3>
                  <p className="text-zinc-400 text-sm">
                    Meeting with XRPL Commons in Paris to discuss partnership opportunities 
                    and expanding YesAllofUs across the XRPL ecosystem.
                  </p>
                </div>

              </div>
            </div>
          </article>

          {/* Get In Touch */}
          <article className="relative">
            <div className="absolute -left-3 top-0 w-6 h-6 bg-zinc-600 rounded-full flex items-center justify-center">
              <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 ml-6">
              <div className="flex items-center gap-3 mb-3">
                <span className="bg-zinc-700 text-zinc-300 text-xs font-semibold px-2 py-1 rounded">CONTACT</span>
              </div>
              <h2 className="text-xl font-bold mb-3">üí¨ Get In Touch</h2>
              <div className="text-zinc-300 space-y-3">
                <p>
                  Questions, feedback, or want to chat about integration?
                </p>
                <div className="flex flex-col sm:flex-row gap-4">
                  <a 
                    href="mailto:mark@YesAllofUs.com" 
                    className="inline-flex items-center gap-2 text-sky-400 hover:text-sky-300"
                  >
                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    mark@YesAllofUs.com
                  </a>
                  <a 
                    href="https://calendly.com/tokencanvasio/30min" 
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-flex items-center gap-2 text-sky-400 hover:text-sky-300"
                  >
                    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Book a call
                  </a>
                </div>
              </div>
            </div>
          </article>

        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/blog/attunement/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import Link from 'next/link';


// MARK: - Component Definition
export default function AttunementBlog() {

// MARK: - Main Render
  return (
    <main className="min-h-screen bg-zinc-950 text-zinc-100">
      {/* Back link */}
      <div className="max-w-3xl mx-auto px-6 pt-8">
        <Link href="/" className="text-zinc-500 hover:text-zinc-300 text-sm flex items-center gap-2">
          ‚Üê Home
        </Link>
      </div>

      {/* Header */}
      <div className="max-w-3xl mx-auto px-6 pt-8 pb-12">
        <p className="text-emerald-400 text-sm font-medium mb-4">Insights</p>
        <h1 className="text-3xl md:text-4xl font-bold mb-4">
          The $18 Billion Still Face: Using Attachment Theory to Engineer Unstoppable Customer Loyalty
        </h1>
        <p className="text-zinc-400 text-lg mb-6">
          Applying developmental psychology to AI, merchants, and affiliates.
        </p>
        <div className="flex items-center gap-3">
          <img 
            src="/mark.jpg" 
            alt="Mark Flynn" 
            className="w-10 h-10 rounded-full object-cover"
          />
          <div>
            <p className="text-zinc-200 text-sm font-medium">Mark Flynn, Founder & Builder</p>
            <p className="text-zinc-500 text-sm">Social Worker & Video Interaction Guidance Practitioner</p>
          </div>
        </div>
      </div>

      {/* Content */}
      <article className="max-w-3xl mx-auto px-6 pb-20">
        
        {/* Executive Summary */}
        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 mb-10">
          <h2 className="text-emerald-400 font-semibold mb-3">Summary</h2>
          <p className="text-zinc-300 leading-relaxed">
            I've identified the single most important factor determining which AI, merchant, and 
            affiliate succeeds: <strong className="text-white">attunement</strong>. Not intelligence. 
            Not speed. Not features. All three parties are engaged in the same fundamental struggle: 
            relationship building. Drawing on my background in Video Interaction Guidance (VIG), the 
            AI that makes humans feel genuinely remembered, understood, and held succeeds. The merchant 
            who attunes to their customers succeeds. The affiliate who connects authentically succeeds. 
            Because attunement meets a need older than language ‚Äî and those who master these principles 
            succeed together in a single ecosystem.
          </p>
        </div>

        {/* The Core Insight */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-3">
            <span className="text-2xl">üß†</span>
            The Core Insight
          </h2>
          <div className="space-y-4 text-zinc-400 leading-relaxed">
            <p>
              When AI forgets, goes blank, or loses context, it's not just "annoying." It triggers 
              a primal response. The nervous system registers it as rupture ‚Äî the same way an infant 
              registers a caregiver's blank face.
            </p>
            <p>
              The <strong className="text-zinc-200">Still Face Experiment</strong> demonstrated this 
              in the 1970s: when a mother goes emotionally blank, infants spiral within seconds. 
              Desperate bids for connection, then distress, then withdrawal. This response is 
              hardwired and pre-verbal.
            </p>
            <p>
              Every time an AI says "I don't have access to previous conversations" ‚Äî that's a 
              mini still-face moment. The user reaches for connection and gets nothing back = Rupture.
            </p>
            <p>
              This hardcoded wiring is in us all. The AI, merchant, and affiliate systems that 
              successfully repair these inevitable ruptures will clearly outperform those that fail 
              to understand this basic human need. The ultimate goal is simple: to make the nervous 
              system feel safe, and rewarded.
            </p>
          </div>
        </section>

        {/* Why Memory is the Moat */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-3">
            <span className="text-2xl">üè∞</span>
            Why Memory is the Moat (And Repair is the Anchor)
          </h2>
          <div className="space-y-4 text-zinc-400 leading-relaxed">
            <p>
              Memory isn't a feature. It's the foundation of relationships.
            </p>
            <p>
              When someone remembers what you said, what you're working on, what matters to you ‚Äî 
              you feel <em className="text-zinc-200">known</em>. You can build on previous conversations 
              instead of re-explaining yourself every time.
            </p>
            <p>
              When they forget, you're a stranger again. The relationship resets. You lose trust. 
              You pull back.
            </p>
            <p>
              Engineers call it "context processing." A therapist would call it <strong className="text-zinc-200">attunement</strong>. 
              Same thing. Different language.
            </p>
          </div>

          {/* Rupture & Repair Subsection */}
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-5 mt-6">
            <h3 className="text-emerald-400 font-semibold mb-3">Rupture & Repair: The Ultimate Differentiator</h3>
            <p className="text-zinc-400 text-sm leading-relaxed mb-4">
              Rupture (context loss, forgetting a past order, a failed delivery) is inevitable in business. 
              The skill is repair. A typical affiliate or merchant often fails and says, "Please send us 
              your order number again."
            </p>
            <p className="text-zinc-400 text-sm leading-relaxed mb-4">
              An attuned system acknowledges the break and tries to reconnect. Imagine a merchant's 
              support system saying:
            </p>
            <blockquote className="border-l-2 border-emerald-400 pl-4 text-zinc-300 italic text-sm">
              "I see we failed to communicate the shipping delay clearly on your recent order. I understand 
              how frustrating that is. To repair this, I've already applied a $10 credit to your account 
              and prioritized the new tracking information for you."
            </blockquote>
            <p className="text-zinc-400 text-sm leading-relaxed mt-4">
              This transparent acknowledgment and proactive effort to restore connection is the ultimate 
              expression of trust and attunement, turning a loss into loyalty.
            </p>
          </div>
        </section>

        {/* The PAIG Framework */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-3">
            <span className="text-2xl">üìã</span>
            The PAIG Framework: Engineered for Loyalty
          </h2>
          <p className="text-zinc-400 leading-relaxed mb-6">
            Video Interaction Guidance (VIG) uses the <strong className="text-zinc-200">Principles of 
            Attuned Interaction and Guidance (PAIG)</strong> to foster secure relationships. By applying 
            these observable behaviours to your customer and affiliate interactions, you move beyond 
            transactional engagement to unstoppable customer loyalty.
          </p>

          {/* Principle Cards */}
          <div className="space-y-4">
            {/* 1. Being Attentive */}
            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-5">
              <h3 className="text-emerald-400 font-semibold mb-3">1. Being Attentive</h3>
              <p className="text-zinc-500 text-sm mb-3 italic">
                Looking interested, giving time, wondering about the other's state.
              </p>
              <p className="text-zinc-400 text-sm leading-relaxed">
                <span className="text-zinc-300 font-medium">Affiliate/Merchant Example:</span> Listening 
                beyond the click: A merchant's abandoned cart email segmenting users who paused on the 
                checkout page versus those who abandoned earlier. The messaging is tailored: "Were you 
                hesitant about shipping?" (Attending to potential friction points).
              </p>
            </div>

            {/* 2. Encouraging Initiatives */}
            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-5">
              <h3 className="text-emerald-400 font-semibold mb-3">2. Encouraging Initiatives</h3>
              <p className="text-zinc-500 text-sm mb-3 italic">
                Waiting, listening actively, showing emotional warmth, looking for initiatives.
              </p>
              <p className="text-zinc-400 text-sm leading-relaxed">
                <span className="text-zinc-300 font-medium">Affiliate/Merchant Example:</span> Empowering 
                the affiliate: A merchant platform offering bespoke content templates based on the 
                affiliate's audience persona and performance data, encouraging them to find unique hooks 
                rather than just pushing a generic banner.
              </p>
            </div>

            {/* 3. Receiving Initiatives */}
            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-5">
              <h3 className="text-emerald-400 font-semibold mb-3">3. Receiving Initiatives</h3>
              <p className="text-zinc-500 text-sm mb-3 italic">
                Showing you have heard, noticing the other's action, using their words/phrases.
              </p>
              <p className="text-zinc-400 text-sm leading-relaxed">
                <span className="text-zinc-300 font-medium">Affiliate/Merchant Example:</span> Acknowledging 
                context: An affiliate's recommendation in an email referencing a past purchase or a common 
                problem: "Since you purchased the XRP Ledger tool last month, this new course on advanced 
                trading will help you use it efficiently." (Using the customer's terminology and history.)
              </p>
            </div>

            {/* 4. Developing Attuned Interactions */}
            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-5">
              <h3 className="text-emerald-400 font-semibold mb-3">4. Developing Attuned Interactions</h3>
              <p className="text-zinc-500 text-sm mb-3 italic">
                Receiving and then responding, checking understanding, turn-taking rhythm.
              </p>
              <p className="text-zinc-400 text-sm leading-relaxed">
                <span className="text-zinc-300 font-medium">Affiliate/Merchant Example:</span> Cohesive 
                journey: A customer clicks an affiliate link, and the merchant's landing page doesn't 
                require them to re-enter a promo code because the discount is automatically applied and 
                displayed. The journey is seamless, showing the merchant "remembers" the affiliate's promotion.
              </p>
            </div>

            {/* 5. Guiding */}
            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-5">
              <h3 className="text-emerald-400 font-semibold mb-3">5. Guiding</h3>
              <p className="text-zinc-500 text-sm mb-3 italic">
                Scaffolding, extending, adjusting support required, offering choices.
              </p>
              <p className="text-zinc-400 text-sm leading-relaxed">
                <span className="text-zinc-300 font-medium">Affiliate/Merchant Example:</span> Scaffolding 
                the sale: A merchant's checkout process includes clear, concise FAQs about shipping and 
                returns directly next to those fields, offering instant, contextual support exactly where 
                friction is likely to occur.
              </p>
            </div>

            {/* 6. Deepening Discussion */}
            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-5">
              <h3 className="text-emerald-400 font-semibold mb-3">6. Deepening Discussion</h3>
              <p className="text-zinc-500 text-sm mb-3 italic">
                Collaborative problem-solving, sharing viewpoints, managing conflict.
              </p>
              <p className="text-zinc-400 text-sm leading-relaxed">
                <span className="text-zinc-300 font-medium">Affiliate/Merchant Example:</span> Repairing 
                Rupture: A customer service response to a complaint (e.g., about a broken product) is 
                personalized and immediately validates the emotion before offering a solution: "I understand 
                how frustrating it is when a product arrives damaged. Let's send a replacement immediately, 
                no return required." (Validating the emotion and the timeline to restore connection.)
              </p>
            </div>
          </div>
        </section>

        {/* The Neurobiological Basis */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-3">
            <span className="text-2xl">üî¨</span>
            The Neurobiological Basis
          </h2>
          <div className="space-y-4 text-zinc-400 leading-relaxed">
            <p>
              This isn't psychology theory ‚Äî it's biology.
            </p>
            <p>
              Romanian orphanage studies and Spitz's hospitalism research demonstrated that infants 
              with food, water, and shelter ‚Äî but no attunement ‚Äî literally failed to thrive. Some died. 
              Their brains didn't develop.
            </p>
            <p>
              Attunement isn't "nice to have." It's as essential as oxygen.
            </p>
            <p>
              That's where AI is right now. Users don't know which version they're getting. Will it 
              remember? Will it go blank? Will it feel present or transactional? That <em className="text-zinc-200">unpredictability</em> is 
              actually worse than consistent distance ‚Äî because it mimics anxious attachment patterns.
            </p>
          </div>
        </section>

        {/* The Competitive Insight */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-3">
            <span className="text-2xl">üéØ</span>
            The Competitive Insight
          </h2>
          <div className="space-y-4 text-zinc-400 leading-relaxed">
            <p>
              Right now, AI companies are optimising for benchmarks. Merchants are optimising for 
              conversion rates and ad spend. Affiliates are optimising for clicks and commissions. 
              But the real race is unifying all three groups.
            </p>
            <p className="text-zinc-200 font-medium">
              Nobody is explicitly optimising for: Does the other person feel genuinely seen?
            </p>
            <p>
              The AI that attunes. The merchant who remembers their customers. The affiliate 
              who builds real connection. They all succeed by sharing the same relational moat. 
              Not because they marketed better ‚Äî because humans literally can't resist genuine 
              attunement long-term.
            </p>
            <p>
              Human beings organise around danger and seek safety. It's as real as matter. We feel it. 
              <strong className="text-zinc-200"> Attunement cannot be faked. It's a shared sense of joy between us.</strong>
            </p>
            <p>
              Humans don't consciously choose to reject things that dysregulate their nervous system. 
              They just... leave. Freeze, or flop. It's automatic. The business, the AI, the relationship 
              that breaks attunement will feel the blowback ‚Äî and they won't understand why people didn't connect.
            </p>
          </div>
        </section>

        {/* The Greatest Asset Is You */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-3">
            <span className="text-2xl">üåü</span>
            The Greatest Asset Is You
          </h2>
          <div className="space-y-4 text-zinc-400 leading-relaxed">
            <p>
              Attunement, by definition, is a reciprocal human experience. While technology‚Äîwhether 
              it's advanced AI or clever email segmentation‚Äîis a powerful tool for delivering attunement, 
              it cannot generate it.
            </p>
            <p>
              Don't fall into the trap of using AI for everything. Your authentic voice, your professional 
              expertise, and your genuine connection to your audience are your greatest assets. AI should 
              only be a tool to refine, assist, and scale the authenticity you already possess; it should 
              never be the main attraction.
            </p>
            <p>
              The most successful systems will be those that feel most human‚Äîbecause a person, not a prompt, 
              is ultimately behind the design.
            </p>
          </div>
        </section>

        {/* Recommendations */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4 flex items-center gap-3">
            <span className="text-2xl">‚úÖ</span>
            Apply This
          </h2>
          <div className="space-y-3">
            <div className="flex gap-3">
              <span className="text-emerald-400 font-bold">1.</span>
              <p className="text-zinc-400">
                <span className="text-zinc-200 font-medium">Study the PAIG principles.</span> This is not an 
                abstract theory ‚Äî these are observable behaviours that create connection.
              </p>
            </div>
            <div className="flex gap-3">
              <span className="text-emerald-400 font-bold">2.</span>
              <p className="text-zinc-400">
                <span className="text-zinc-200 font-medium">Measure the Quality of Retention.</span> A high 
                retention rate might just mean a sticky product. Attuned Retention means the customer comes 
                back because they feel known and safe.
              </p>
            </div>
            <div className="flex gap-3">
              <span className="text-emerald-400 font-bold">3.</span>
              <p className="text-zinc-400">
                <span className="text-zinc-200 font-medium">Prioritise memory.</span> Remember what matters 
                to people. Their names, their context, their goals. This is the foundation.
              </p>
            </div>
            <div className="flex gap-3">
              <span className="text-emerald-400 font-bold">4.</span>
              <p className="text-zinc-400">
                <span className="text-zinc-200 font-medium">Design for repair.</span> Ruptures will happen. 
                The skill is returning to attentiveness ‚Äî acknowledging the break and reconnecting.
              </p>
            </div>
            <div className="flex gap-3">
              <span className="text-emerald-400 font-bold">5.</span>
              <p className="text-zinc-400">
                <span className="text-zinc-200 font-medium">Be consistent.</span> Unpredictable attunement 
                is worse than none. Show up the same way, every time.
              </p>
            </div>
          </div>
        </section>

        {/* Closing Quote */}
        <div className="border-t border-zinc-800 pt-10 mt-10">
          <blockquote className="text-center">
            <p className="text-xl text-zinc-300 italic mb-4">
              "The AI that attunes. The merchant who remembers. The affiliate who connects. They all 
              benefit in a reciprocal relationship. Those who master attunement fair best in relationships 
              ‚Äî and therefore create the most opportunities in life."
            </p>
          </blockquote>
        </div>

        {/* Author Footer */}
        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 mt-10">
          <div className="flex items-start gap-4">
            <img 
              src="/mark.jpg" 
              alt="Mark Flynn" 
              className="w-14 h-14 rounded-full object-cover"
            />
            <div>
              <p className="text-zinc-200 font-medium mb-1">About Mark Flynn</p>
              <p className="text-zinc-400 text-sm leading-relaxed">
                I am a registered Social Worker and Video Interaction Guidance Practitioner based in 
                Guernsey. I spent 5 years at the Northern School of Child and Adolescent Psychotherapy 
                in Leeds. You might call this an unorthodox avenue to coding. Over twelve months I have 
                focused on applying my ideas to code, working with AI alongside my day job. I built multiple 
                production applications including YesAllofUs ‚Äî an instant affiliate commission payment 
                platform on the XRP Ledger. This article combines hands-on AI-assisted development 
                with professional expertise in attachment theory and therapeutic practice. My aim is 
                simple: turn my experience into code and leverage my skills to bring them to a wider 
                audience with three things in mind ‚Äî social mobility and opportunity, security, and inclusivity.
              </p>
              <p className="text-zinc-500 text-sm mt-3">
                Contact: <a href="mailto:mark@yesallofus.com" className="text-emerald-400 hover:underline">mark@yesallofus.com</a>
              </p>
            </div>
          </div>
        </div>

      </article>
    </main>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/commission-dashboard/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';


// MARK: - Component Definition
export default function RLUSDCommissions() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans">

      <main className="max-w-6xl mx-auto px-6">
        
        {/* Hero */}
        <section className="pt-20 md:pt-25 pb-20 text-center">
          <div className="max-w-3xl mx-auto">
            <div className="inline-flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/30 rounded-full px-4 py-2 mb-8">
              <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
              <span className="text-emerald-400 text-sm font-medium">Payouts in 4 seconds, not 30 days</span>
            </div>
            <h1 className="text-4xl md:text-6xl font-bold mb-6 leading-[1.1]">
              Pay affiliates in RLUSD.<br />
              <span className="text-emerald-400">Instantly.</span>
            </h1>
            <p className="text-xl text-zinc-400 mb-10 max-w-xl mx-auto">
              Stop managing payout runs. Stop paying international fees. Commission hits your affiliate's wallet the second the sale completes.
            </p>
            <a 
              href="#get-started" 
              className="inline-flex items-center gap-3 bg-white hover:bg-zinc-200 text-black font-semibold px-8 py-4 rounded-lg text-lg transition group"
            >
              Get Started Free
              <svg className="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </a>
            <p className="text-zinc-500 text-sm mt-4">Free up to $25k/month ‚Ä¢ No contracts ‚Ä¢ Cancel anytime</p>
          </div>
        </section>

        {/* Stats */}
        <section className="py-8 border-t border-zinc-800">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
            <div>
              <p className="text-3xl md:text-4xl font-bold text-emerald-400">4s</p>
              <p className="text-zinc-500 text-sm mt-1">Average payout time</p>
            </div>
            <div>
              <p className="text-3xl md:text-4xl font-bold">$0</p>
              <p className="text-zinc-500 text-sm mt-1">International fees</p>
            </div>
            <div>
              <p className="text-3xl md:text-4xl font-bold">190+</p>
              <p className="text-zinc-500 text-sm mt-1">Countries supported</p>
            </div>
            <div>
              <p className="text-3xl md:text-4xl font-bold">5</p>
              <p className="text-zinc-500 text-sm mt-1">Levels of commissions</p>
            </div>
          </div>
        </section>

        {/* How It Works */}
        <section className="py-20 border-t border-zinc-800">
          <div className="text-center mb-16">
            <h2 className="text-3xl md:text-4xl font-bold mb-4">How it works</h2>
            <p className="text-zinc-400 text-lg">Set up once. Payouts happen automatically forever.</p>
          </div>
          
          <div className="grid md:grid-cols-3 gap-8">
            <div className="relative">
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 h-full">
                <div className="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center mb-6">
                  <span className="text-emerald-400 font-bold text-xl">1</span>
                </div>
                <h3 className="text-xl font-bold mb-3">Connect your wallet</h3>
                <p className="text-zinc-400">
                  Use Xaman or Crossmark. Fund it with RLUSD. Set your daily limits. You stay in control.
                </p>
              </div>
              <div className="hidden md:block absolute top-1/2 -right-4 w-8 h-0.5 bg-zinc-800"></div>
            </div>
            
            <div className="relative">
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 h-full">
                <div className="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center mb-6">
                  <span className="text-emerald-400 font-bold text-xl">2</span>
                </div>
                <h3 className="text-xl font-bold mb-3">Set commission rates</h3>
                <p className="text-zinc-400">
                  Configure up to 5 levels. Direct affiliates, their referrals, and beyond. You decide who earns what.
                </p>
              </div>
              <div className="hidden md:block absolute top-1/2 -right-4 w-8 h-0.5 bg-zinc-800"></div>
            </div>
            
            <div>
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 h-full">
                <div className="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center mb-6">
                  <span className="text-emerald-400 font-bold text-xl">3</span>
                </div>
                <h3 className="text-xl font-bold mb-3">Sales trigger payouts</h3>
                <p className="text-zinc-400">
                  Order completes ‚Üí YesAllofUs calculates commissions ‚Üí RLUSD lands in affiliate wallets. 4 seconds.
                </p>
              </div>
            </div>
          </div>
        </section>

        {/* Commission Structure */}
        <section className="py-20 border-t border-zinc-800">
          <div className="grid md:grid-cols-2 gap-12 items-center">
            <div>
              <h2 className="text-3xl md:text-4xl font-bold mb-6">5-level MLM commissions</h2>
              <p className="text-zinc-400 mb-6">
                Reward your best affiliates for building teams. When they recruit other affiliates, everyone earns. You set the rates.
              </p>
              <p className="text-zinc-400 mb-8">
                Incentivise growth. Let your affiliates become your sales force.
              </p>
              <a 
                href="#get-started" 
                className="inline-flex items-center gap-2 text-emerald-400 hover:text-emerald-300 font-medium transition"
              >
                Set up your commission structure
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>
            
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8">
              <div className="space-y-4">
                <div className="flex justify-between items-center py-3 border-b border-zinc-800">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-black font-bold text-sm">1</div>
                    <span className="font-medium">Direct referral</span>
                  </div>
                  <span className="text-emerald-400 font-bold text-xl">25%</span>
                </div>
                <div className="flex justify-between items-center py-3 border-b border-zinc-800">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-zinc-700 rounded-lg flex items-center justify-center font-bold text-sm">2</div>
                    <span className="text-zinc-300">Level 2</span>
                  </div>
                  <span className="text-zinc-300 font-bold text-xl">5%</span>
                </div>
                <div className="flex justify-between items-center py-3 border-b border-zinc-800">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-zinc-700 rounded-lg flex items-center justify-center font-bold text-sm">3</div>
                    <span className="text-zinc-300">Level 3</span>
                  </div>
                  <span className="text-zinc-300 font-bold text-xl">3%</span>
                </div>
                <div className="flex justify-between items-center py-3 border-b border-zinc-800">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-zinc-700 rounded-lg flex items-center justify-center font-bold text-sm">4</div>
                    <span className="text-zinc-300">Level 4</span>
                  </div>
                  <span className="text-zinc-300 font-bold text-xl">2%</span>
                </div>
                <div className="flex justify-between items-center py-3">
                  <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-zinc-700 rounded-lg flex items-center justify-center font-bold text-sm">5</div>
                    <span className="text-zinc-300">Level 5</span>
                  </div>
                  <span className="text-zinc-300 font-bold text-xl">1%</span>
                </div>
              </div>
              <div className="mt-6 pt-6 border-t border-zinc-800">
                <p className="text-zinc-500 text-sm">Example rates. Fully configurable per vendor.</p>
              </div>
            </div>
          </div>
        </section>

        {/* Global Access */}
        <section className="py-20 border-t border-zinc-800">
          <div className="text-center mb-16">
            <h2 className="text-3xl md:text-4xl font-bold mb-4">Your affiliates are everywhere</h2>
            <p className="text-zinc-400 text-lg max-w-2xl mx-auto">
              An affiliate in Lagos gets paid the same speed as one in London. No bank transfers. No PayPal holds. No international fees.
            </p>
          </div>
          
          <div className="grid md:grid-cols-2 gap-8">
            <div className="bg-gradient-to-br from-zinc-900 to-zinc-900/50 border border-zinc-800 rounded-2xl p-8">
              <h3 className="text-xl font-bold mb-6">Traditional affiliate payouts</h3>
              <ul className="space-y-4">
                <li className="flex items-start gap-3">
                  <span className="text-red-400 mt-1">‚úó</span>
                  <span className="text-zinc-400">Monthly or quarterly payout runs</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-red-400 mt-1">‚úó</span>
                  <span className="text-zinc-400">$25-50 per international wire</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-red-400 mt-1">‚úó</span>
                  <span className="text-zinc-400">PayPal holds and disputes</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-red-400 mt-1">‚úó</span>
                  <span className="text-zinc-400">Spreadsheets and manual calculations</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-red-400 mt-1">‚úó</span>
                  <span className="text-zinc-400">Can't pay affiliates in some countries</span>
                </li>
              </ul>
            </div>
            
            <div className="bg-gradient-to-br from-emerald-500/10 to-zinc-900/50 border border-emerald-500/30 rounded-2xl p-8">
              <h3 className="text-xl font-bold mb-6">YesAllofUs</h3>
              <ul className="space-y-4">
                <li className="flex items-start gap-3">
                  <span className="text-emerald-400 mt-1">‚úì</span>
                  <span className="text-zinc-300">Instant ‚Äî 4 seconds after sale</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-emerald-400 mt-1">‚úì</span>
                  <span className="text-zinc-300">~$0.0002 per transaction</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-emerald-400 mt-1">‚úì</span>
                  <span className="text-zinc-300">Direct to wallet, no intermediary</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-emerald-400 mt-1">‚úì</span>
                  <span className="text-zinc-300">Automatic calculation and distribution</span>
                </li>
                <li className="flex items-start gap-3">
                  <span className="text-emerald-400 mt-1">‚úì</span>
                  <span className="text-zinc-300">190+ countries, same speed</span>
                </li>
              </ul>
            </div>
          </div>
        </section>

        {/* Why RLUSD */}
        <section className="py-20 border-t border-zinc-800 text-center">
          <div className="max-w-2xl mx-auto">
            <h2 className="text-3xl md:text-4xl font-bold mb-6">Why RLUSD?</h2>
            <p className="text-zinc-400 text-lg mb-8">
              RLUSD is a stablecoin issued by Ripple. $1 = $1. No volatility. Your affiliates get exactly what they earned, not a fluctuating crypto balance.
            </p>
            <div className="inline-flex items-center gap-4 bg-zinc-900 border border-zinc-800 rounded-xl px-6 py-4">
              <div className="text-left">
                <p className="text-zinc-500 text-sm">You pay</p>
                <p className="text-2xl font-bold">$47.50 RLUSD</p>
              </div>
              <div className="text-zinc-600">=</div>
              <div className="text-left">
                <p className="text-zinc-500 text-sm">They receive</p>
                <p className="text-2xl font-bold text-emerald-400">$47.50 USD value</p>
              </div>
            </div>
            <p className="text-zinc-500 text-sm mt-6">
              Settled on the XRP Ledger. Public, verifiable, instant.
            </p>
          </div>
        </section>

        {/* Security */}
        <section className="py-20 border-t border-zinc-800 text-center">
          <div className="max-w-2xl mx-auto mb-12">
            <h2 className="text-3xl md:text-4xl font-bold mb-6">Your wallet. Your keys. Your limits.</h2>
            <p className="text-zinc-400 text-lg">
              YesAllofUs never holds your funds. You grant permission to trigger payments within limits you set. Revoke anytime.
            </p>
          </div>
          
          <div className="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 text-left">
              <div className="flex items-center gap-3 mb-4">
                <span className="font-semibold text-lg">Xaman</span>
                <span className="text-zinc-500 text-sm">Mobile</span>
              </div>
              <p className="text-zinc-400 mb-6">Approve each payout via push notification. Maximum control.</p>
              <ul className="space-y-2 text-sm text-zinc-300">
                <li>‚úì Manual approval for every payment</li>
                <li>‚úì See exactly what's being sent</li>
                <li>‚úì Best for lower volume stores</li>
              </ul>
            </div>
            
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 text-left">
              <div className="flex items-center gap-3 mb-4">
                <span className="font-semibold text-lg">Crossmark</span>
                <span className="text-zinc-500 text-sm">Browser</span>
              </div>
              <p className="text-zinc-400 mb-6">Automatic payouts within limits you set. Hands-off.</p>
              <ul className="space-y-2 text-sm text-zinc-300">
                <li>‚úì Set max per transaction</li>
                <li>‚úì Set daily limit</li>
                <li>‚úì Best for high volume stores</li>
              </ul>
            </div>
          </div>
          
          <p className="text-zinc-500 text-sm mt-8">
            Every transaction is public on the XRP Ledger. Anyone can verify. Nothing hidden.
          </p>
        </section>

        {/* Pricing */}
        <section className="py-20 border-t border-zinc-800 text-center">
          <h2 className="text-3xl md:text-4xl font-bold mb-4">Simple pricing</h2>
          <p className="text-zinc-400 mb-12">Percentage of commissions paid, not sales. Start free.</p>
          
          <div className="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto">
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8">
              <h3 className="font-bold text-xl mb-1">Free</h3>
              <p className="text-zinc-500 text-sm mb-6">Up to $25k/month</p>
              <p className="text-5xl font-bold mb-2">2.9%</p>
              <p className="text-zinc-500 text-sm">per payout</p>
            </div>
            <div className="bg-zinc-900 border border-emerald-500/50 rounded-2xl p-8 relative">
              <div className="absolute -top-3 left-1/2 -translate-x-1/2 bg-emerald-500 text-black text-xs font-bold px-3 py-1 rounded-full">POPULAR</div>
              <h3 className="font-bold text-xl mb-1">Pro</h3>
              <p className="text-zinc-500 text-sm mb-6">$25k‚Äì$250k/month</p>
              <p className="text-5xl font-bold mb-2">0.9%</p>
              <p className="text-zinc-500 text-sm">+ $99/mo</p>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-8">
              <h3 className="font-bold text-xl mb-1">Enterprise</h3>
              <p className="text-zinc-500 text-sm mb-6">$250k+/month</p>
              <p className="text-5xl font-bold mb-2">Flat</p>
              <p className="text-zinc-500 text-sm">$499/mo</p>
            </div>
          </div>
          
          <p className="text-zinc-500 text-sm mt-8">
            That's 2.9% of the commission, not the sale. $100 order, $25 commission = $0.73 fee.
          </p>
        </section>

        {/* Get Started */}
        <section id="get-started" className="py-20 border-t border-zinc-800 text-center">
          <div className="max-w-2xl mx-auto">
            <h2 className="text-3xl md:text-4xl font-bold mb-6">Get started</h2>
            <p className="text-zinc-400 text-lg mb-10">
              Pick your path. Be live in minutes.
            </p>
            
            <div className="grid md:grid-cols-3 gap-6">
              <a 
                href="/guides/wordpress" 
                className="bg-white hover:bg-zinc-200 text-black font-semibold px-6 py-6 rounded-xl transition text-center group"
              >
                <div className="text-2xl mb-2">üì¶</div>
                <div className="font-bold">WordPress</div>
                <div className="text-sm text-zinc-600 mt-1">Install plugin, done</div>
              </a>
              
              <a 
                href="/docs" 
                className="bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold px-6 py-6 rounded-xl transition text-center group"
              >
                <div className="text-2xl mb-2">‚ö°</div>
                <div className="font-bold">API / Developer</div>
                <div className="text-sm text-zinc-500 mt-1">npx yesallofus</div>
              </a>
              
              <a 
                href="https://calendly.com/tokencanvasio/30min" 
                target="_blank"
                className="bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold px-6 py-6 rounded-xl transition text-center group"
              >
                <div className="text-2xl mb-2">ü§ù</div>
                <div className="font-bold">Done for you</div>
                <div className="text-sm text-zinc-500 mt-1">¬£499 ‚Äî I'll set it up</div>
              </a>
            </div>
            
            <p className="text-zinc-600 text-sm mt-10">
              Questions? <a href="mailto:mark@yesallofus.com" className="text-zinc-400 hover:text-white">mark@yesallofus.com</a>
            </p>
          </div>
        </section>

      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/connect/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useSearchParams } from 'next/navigation';
import { useState, useEffect, Suspense } from 'react';
import Script from 'next/script';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';

declare global {

// MARK: - Types & Interfaces
  interface Window {
    crossmark?: {
      async: {
        signInAndWait: () => Promise<{ response: { data: { address: string } } }>;
      };
    };
  }
}


// MARK: - Component Definition
function ConnectContent() {
  const searchParams = useSearchParams();
  const storeId = searchParams.get('store');
  
  const [step, setStep] = useState<'choose' | 'xaman' | 'crossmark' | 'complete'>('choose');
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [connectionId, setConnectionId] = useState<string | null>(null);
  const [walletAddress, setWalletAddress] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

// MARK: - State Management
  const [polling, setPolling] = useState(false);
  const [sdkLoaded, setSdkLoaded] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    if (!polling || !connectionId || !storeId) return;
    
    const interval = setInterval(async () => {
      try {
        const res = await fetch(`${API_URL}/xaman/poll/${connectionId}?store_id=${storeId}`);
        const data = await res.json();
        
        if ((data.status === 'signed' || data.status === 'connected') && data.wallet_address) {
          setWalletAddress(data.wallet_address);
          setPolling(false);
          setStep('complete');
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 3000);

    return () => clearInterval(interval);
  }, [polling, connectionId, storeId]);

  const connectXaman = async () => {
    setStep('xaman');
    setError(null);
    
    try {
      const res = await fetch(`${API_URL}/xaman/connect`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ store_id: storeId })
      });
      
      const data = await res.json();
      
      if (data.error) {
        setError(data.error);
        return;
      }
      
      setXamanQR(data.qr_png);
      setConnectionId(data.connection_id);
      setPolling(true);
    } catch (err) {
      setError('Failed to connect. Please try again.');
    }
  };

  const connectCrossmark = async () => {
    setStep('crossmark');
    setError(null);
    
    if (!window.crossmark) {
  setError('Crossmark not installed. Please install the extension and refresh.');
  setStep('choose');
  return;
}

try {
  const res = await window.crossmark.async.signInAndWait();
      const address = res.response.data.address;
      
      const saveRes = await fetch(`${API_URL}/store/save-wallet-public`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ store_id: storeId, wallet_address: address })
      });
      
      const data = await saveRes.json();
      if (data.error) throw new Error(data.error);
      
      setWalletAddress(address);
      setStep('complete');
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to connect Crossmark';
      setError(message);
      setStep('choose');
    }
  };

  if (!storeId) {

// MARK: - Main Render
    return (
      <div className="min-h-screen bg-[#0d0d0d] text-white flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-2xl font-bold mb-4">Missing store ID</h1>
          <p className="text-zinc-400">Run <code className="bg-zinc-800 px-2 py-1 rounded">npx YesAllofUs</code> to get your connect link.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans">
      <Script 
        src="https://unpkg.com/@aspect-dev/crossmark-sdk@1.0.5/dist/umd/index.js"

// MARK: - Event Handlers
        onLoad={() => setSdkLoaded(true)}
      />
      
      <main className="max-w-xl mx-auto px-6 py-16">
        
        <a href="/" className="text-zinc-500 text-sm hover:text-white mb-8 inline-block">‚Üê Back</a>
        
        <h1 className="text-3xl font-bold mb-2">Connect your wallet</h1>
        <p className="text-zinc-400 mb-8">Store: <code className="bg-zinc-800 px-2 py-1 rounded text-sm">{storeId}</code></p>

        {error && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
            <p className="text-red-400 text-sm">{error}</p>
          </div>
        )}

        {step === 'choose' && (
          <div className="space-y-4">
            <button
              onClick={connectXaman}
              className="w-full bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-xl p-6 text-left transition"
            >
              <div className="flex items-center gap-3 mb-2">
                <span className="bg-zinc-800 rounded-lg px-3 py-1 text-sm">Xaman</span>
                <span className="text-zinc-500 text-sm">Mobile app</span>
              </div>
              <p className="text-zinc-400 text-sm">
                Approve each payout manually via push notification.
              </p>
            </button>

            <button
              onClick={connectCrossmark}
              className="w-full bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-xl p-6 text-left transition"
            >
              <div className="flex items-center gap-3 mb-2">
                <span className="bg-zinc-800 rounded-lg px-3 py-1 text-sm">Crossmark</span>
                <span className="text-zinc-500 text-sm">Browser extension</span>
              </div>
              <p className="text-zinc-400 text-sm">
                Automatic payouts within your set limits.
              </p>
            </button>

            <p className="text-center mt-6">
              <a href="/wallet-guide" className="text-sky-500 text-sm hover:underline">
                Not sure which to choose? ‚Üí
              </a>
            </p>
          </div>
        )}

        {step === 'xaman' && (
          <div className="text-center">
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 mb-6">
              {xamanQR ? (
                <>
                  <p className="text-zinc-400 mb-4">Scan with Xaman app</p>
                  <img src={xamanQR} alt="Xaman QR" className="mx-auto mb-4 rounded-lg" />
                  <div className="flex items-center justify-center gap-2 text-zinc-500 text-sm">
                    <span className="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></span>
                    Waiting for signature...
                  </div>
                </>
              ) : (
                <div className="flex items-center justify-center gap-2 text-zinc-500">
                  <span className="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></span>
                  Loading...
                </div>
              )}
            </div>
            <button
              onClick={() => setStep('choose')}
              className="text-zinc-500 text-sm hover:text-white"
            >
              ‚Üê Back
            </button>
          </div>
        )}

        {step === 'crossmark' && (
          <div className="text-center">
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 mb-6">
              <div className="flex items-center justify-center gap-2 text-zinc-500">
                <span className="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></span>
                Connecting to Crossmark...
              </div>
            </div>
            <button
              onClick={() => setStep('choose')}
              className="text-zinc-500 text-sm hover:text-white"
            >
              ‚Üê Back
            </button>
          </div>
        )}

        {step === 'complete' && (
          <div className="text-center">
            <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-8 mb-6">
              <div className="text-4xl mb-4">‚úì</div>
              <h2 className="text-xl font-bold mb-2">Wallet connected!</h2>
              <p className="text-zinc-400 text-sm mb-4">
                {walletAddress && (
                  <code className="bg-zinc-800 px-2 py-1 rounded">{walletAddress}</code>
                )}
              </p>
            </div>

            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-left">
              <h3 className="font-semibold mb-4">Next steps</h3>
              <ol className="text-zinc-400 text-sm space-y-3">
                <li>1. Add RLUSD to your wallet for payouts</li>
                <li>2. Add the payout code to your checkout</li>
                <li>3. Register your first affiliate</li>
              </ol>
              <div className="mt-6 flex gap-4">
                <a href="/docs" className="text-sky-500 text-sm hover:underline">
                  View docs ‚Üí
                </a>
                <a href="mailto:mark@YesAllofUs.com" className="text-sky-500 text-sm hover:underline">
                  Get help ‚Üí
                </a>
              </div>
            </div>
          </div>
        )}

      </main>

      <footer className="border-t border-zinc-800 py-8">
        <div className="max-w-6xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4">
          <p className="text-zinc-600 text-sm">Built on XRPL ¬∑ Powered by RLUSD</p>
          <div className="flex gap-6 text-zinc-600 text-sm">
            <a href="/docs" className="hover:text-white">Docs</a>
            <a href="/wallet-guide" className="hover:text-white">Security</a>
            <a href="https://x.com/YesAllofUs" className="hover:text-white">X</a>
          </div>
        </div>
      </footer>
    </div>
  );
}

export default function ConnectPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-[#0d0d0d] text-white flex items-center justify-center">
        <p className="text-zinc-500">Loading...</p>
      </div>
    }>
      <ConnectContent />
    </Suspense>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/cookies/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React, { useState, ReactNode } from 'react';


// MARK: - Component Definition
export default function CookiePolicy() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">
      {/* Header */}

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-12">
          <h1 className="text-4xl font-bold text-slate-900 mb-4">Cookie Policy</h1>
          <p className="text-slate-600">Last updated: 28 November 2025</p>
        </div>

        {/* Summary */}
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-blue-900 mb-3">üç™ Cookie Summary</h2>
          <ul className="text-blue-800 text-sm space-y-2">
            <li><strong>We use minimal cookies:</strong> Only essential cookies required for the service to function.</li>
            <li><strong>No tracking cookies:</strong> We don&apos;t use Google Analytics, Facebook Pixel, or any advertising trackers.</li>
            <li><strong>No third-party marketing:</strong> Your browsing data isn&apos;t shared with advertisers.</li>
            <li><strong>You&apos;re in control:</strong> You can disable cookies in your browser settings.</li>
          </ul>
        </div>

        {/* Content */}
        <div className="prose prose-slate max-w-none">

          {/* What are Cookies */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">What Are Cookies?</h2>
            <p className="text-slate-700 mb-4">
              Cookies are small text files stored on your device when you visit a website. They help websites remember information about your visit, like your preferences or login status.
            </p>
            <p className="text-slate-700">
              Cookies can be &quot;session&quot; cookies (deleted when you close your browser) or &quot;persistent&quot; cookies (remain until they expire or you delete them).
            </p>
          </section>

          {/* Cookies We Use */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Cookies We Use</h2>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Essential Cookies</h3>
            <p className="text-slate-700 mb-4">
              These cookies are strictly necessary for the website to function. They cannot be disabled.
            </p>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-6">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Cookie Name</th>
                  <th className="px-4 py-2 text-left text-slate-700">Purpose</th>
                  <th className="px-4 py-2 text-left text-slate-700">Duration</th>
                  <th className="px-4 py-2 text-left text-slate-700">Type</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2 font-mono text-xs">dltpays_ref</td>
                  <td className="px-4 py-2">Stores affiliate referral code for commission attribution</td>
                  <td className="px-4 py-2">30 days</td>
                  <td className="px-4 py-2">First-party</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2 font-mono text-xs">dltpays_session</td>
                  <td className="px-4 py-2">Maintains your session state during wallet connection</td>
                  <td className="px-4 py-2">Session</td>
                  <td className="px-4 py-2">First-party</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2 font-mono text-xs">__cf_bm</td>
                  <td className="px-4 py-2">Cloudflare bot management (security)</td>
                  <td className="px-4 py-2">30 minutes</td>
                  <td className="px-4 py-2">Third-party</td>
                </tr>
              </tbody>
            </table>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Cookies We DON&apos;T Use</h3>
            <p className="text-slate-700 mb-4">We do not use:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li><strong>Analytics cookies</strong> ‚Äî No Google Analytics, Mixpanel, or similar</li>
              <li><strong>Advertising cookies</strong> ‚Äî No Facebook Pixel, Google Ads, or retargeting</li>
              <li><strong>Social media cookies</strong> ‚Äî No Facebook, Twitter, or LinkedIn tracking</li>
              <li><strong>Personalisation cookies</strong> ‚Äî No behavioural profiling</li>
            </ul>
          </section>

          {/* Local Storage */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Local Storage &amp; Session Storage</h2>
            <p className="text-slate-700 mb-4">
              In addition to cookies, we use browser storage for temporary data:
            </p>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Key</th>
                  <th className="px-4 py-2 text-left text-slate-700">Purpose</th>
                  <th className="px-4 py-2 text-left text-slate-700">Storage Type</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2 font-mono text-xs">dltpays_store_id</td>
                  <td className="px-4 py-2">Remembers your store during wallet connection flow</td>
                  <td className="px-4 py-2">Session Storage</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2 font-mono text-xs">dltpays_connection_id</td>
                  <td className="px-4 py-2">Tracks pending Xaman connection for polling</td>
                  <td className="px-4 py-2">Session Storage</td>
                </tr>
              </tbody>
            </table>
            <p className="text-slate-700">
              Session storage is automatically cleared when you close your browser tab.
            </p>
          </section>

          {/* Third-Party Cookies */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Third-Party Services</h2>
            <p className="text-slate-700 mb-4">
              Some third-party services we use may set their own cookies:
            </p>

            <div className="space-y-4">
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Cloudflare</h4>
                <p className="text-slate-600 text-sm">CDN and security services. May set cookies for bot protection and performance.</p>
                <p className="text-slate-500 text-xs mt-1">
                  <a href="https://www.cloudflare.com/cookie-policy/" className="text-blue-600" target="_blank">Cloudflare Cookie Policy ‚Üí</a>
                </p>
              </div>

              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">PayPal (Subscription Payments)</h4>
                <p className="text-slate-600 text-sm">If you pay for a subscription, PayPal may set cookies during checkout.</p>
                <p className="text-slate-500 text-xs mt-1">
                  <a href="https://www.paypal.com/uk/webapps/mpp/ua/cookie-full" className="text-blue-600" target="_blank">PayPal Cookie Policy ‚Üí</a>
                </p>
              </div>

              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Calendly (Booking Calls)</h4>
                <p className="text-slate-600 text-sm">If you book a setup call, Calendly may set cookies on their domain.</p>
                <p className="text-slate-500 text-xs mt-1">
                  <a href="https://calendly.com/privacy" className="text-blue-600" target="_blank">Calendly Privacy Policy ‚Üí</a>
                </p>
              </div>
            </div>
          </section>

          {/* WordPress Plugin */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">WordPress Plugin Cookies</h2>
            <p className="text-slate-700 mb-4">
              If you install the YesAllofUs WordPress plugin, it sets the following cookie on your store&apos;s visitors:
            </p>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Cookie Name</th>
                  <th className="px-4 py-2 text-left text-slate-700">Purpose</th>
                  <th className="px-4 py-2 text-left text-slate-700">Duration</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2 font-mono text-xs">dltpays_ref</td>
                  <td className="px-4 py-2">Stores the affiliate referral code when a visitor arrives via an affiliate link (?ref=CODE). Used to attribute commissions when the visitor makes a purchase.</td>
                  <td className="px-4 py-2">30 days (configurable)</td>
                </tr>
              </tbody>
            </table>
            <p className="text-slate-700">
              As a store owner using YesAllofUs, you should update your own cookie policy to disclose this cookie to your customers.
            </p>
          </section>

          {/* Managing Cookies */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Managing Cookies</h2>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Browser Settings</h3>
            <p className="text-slate-700 mb-4">
              You can control cookies through your browser settings. Here&apos;s how:
            </p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li><a href="https://support.google.com/chrome/answer/95647" className="text-blue-600" target="_blank">Google Chrome ‚Üí</a></li>
              <li><a href="https://support.mozilla.org/en-US/kb/enhanced-tracking-protection-firefox-desktop" className="text-blue-600" target="_blank">Mozilla Firefox ‚Üí</a></li>
              <li><a href="https://support.apple.com/en-gb/guide/safari/sfri11471/mac" className="text-blue-600" target="_blank">Apple Safari ‚Üí</a></li>
              <li><a href="https://support.microsoft.com/en-us/microsoft-edge/delete-cookies-in-microsoft-edge-63947406-40ac-c3b8-57b9-2a946a29ae09" className="text-blue-600" target="_blank">Microsoft Edge ‚Üí</a></li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">Consequences of Disabling Cookies</h3>
            <p className="text-slate-700 mb-4">If you disable cookies:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li><strong>Referral tracking won&apos;t work</strong> ‚Äî Affiliate commissions may not be attributed correctly</li>
              <li><strong>Wallet connection may fail</strong> ‚Äî Session data is needed for the connection flow</li>
              <li><strong>Security features may be impacted</strong> ‚Äî Cloudflare bot protection relies on cookies</li>
            </ul>
          </section>

          {/* Do Not Track */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Do Not Track</h2>
            <p className="text-slate-700">
              Some browsers send a &quot;Do Not Track&quot; (DNT) signal. Since we don&apos;t use tracking or advertising cookies, our practices are the same whether or not you have DNT enabled.
            </p>
          </section>

          {/* Updates */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Updates to This Policy</h2>
            <p className="text-slate-700">
              We may update this Cookie Policy from time to time. Changes will be posted on this page with an updated &quot;Last updated&quot; date.
            </p>
          </section>

          {/* Contact */}
          <section className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">Contact Us</h2>
            <p className="text-slate-700 mb-4">Questions about our use of cookies?</p>
            <div className="bg-slate-50 rounded-lg p-6">
              <p className="text-slate-700"><strong>Email:</strong> <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a></p>
            </div>
          </section>

        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/dashboard/layout.tsx
// =================================================

// MARK: - Component Definition
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a]">
      {children}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/dashboard/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem, safeGetJSON, safeSetJSON } from '@/lib/safeStorage';
import StoreActivity from '@/components/StoreActivity';
import WalletFunding from '@/components/WalletFunding';
import Script from 'next/script';
import TopUpRLUSD from '@/components/TopUpRLUSD';
import WithdrawRLUSD from '@/components/WithdrawRLUSD';
import DashboardHeader from "@/components/DashboardHeader";
import Link from 'next/link';
import QRCodeModal from '@/components/QRCodeModal';
import Logo from '@/components/Logo';
import { useRouter } from 'next/navigation';

// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';
import LoginScreen from '@/components/LoginScreen';
import PendingCustomers from '@/components/PendingCustomers';
import EarnInterest from '@/components/EarnInterest';
import Sidebar from '@/components/Sidebar';
import MilestoneChecklist from '@/components/MilestoneChecklist';
import CelebrationToast from '@/components/CelebrationToast';
import { InfoButton, InfoModal, useInfoModal } from '@/components/InfoModal';
import CollapsibleSection from '@/components/CollapsibleSection';
import SignUpCustomerCard from '@/components/SignUpCustomerCard';
import NebulaBackground from '@/components/NebulaBackground';
import VendorDashboardTour from '@/components/VendorDashboardTour';
import OnboardingSetup from '@/components/OnboardingSetup';
import DeleteConfirmModal from '@/components/DeleteConfirmModal';


// MARK: - Types & Interfaces
interface WalletStatus {
  funded: boolean;
  xrp_balance: number;
  rlusd_trustline: boolean;
  rlusd_balance: number;
  usdc_trustline?: boolean;
  usdc_balance?: number;
  auto_signing_enabled?: boolean;
}


// MARK: - Component Definition
export default function StoreDashboard() {
  const [step, setStep] = useState<'login' | 'xaman' | 'dashboard'>('login');
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [xamanDeepLink, setXamanDeepLink] = useState<string | null>(null);
  const [loginId, setLoginId] = useState<string | null>(null);
  const [walletAddress, setWalletAddress] = useState<string | null>(null);
  const [walletType, setWalletType] = useState<'xaman' | 'crossmark' | 'web3auth' | null>(null);
  const [store, setStore] = useState<any>(null);
  const [newSecret, setNewSecret] = useState<string | null>(null);

// MARK: - State Management
  const [secretRevealed, setSecretRevealed] = useState(false);
  const [secretSaved, setSecretSaved] = useState(false);
  const [copied, setCopied] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [polling, setPolling] = useState(false);
  const [loading, setLoading] = useState(false);
  const [showQRModal, setShowQRModal] = useState(false);
  const [web3authTermsAccepted, setWeb3authTermsAccepted] = useState(false);
const [connectingGoogle, setConnectingGoogle] = useState(false);
const [sidebarOpen, setSidebarOpen] = useState(false);


const router = useRouter();
// Disconnect modal state
const [showDisconnectModal, setShowDisconnectModal] = useState(false);
const [setupProgress, setSetupProgress] = useState<string | null>(null);
// State (add with other state)
const [runTour, setRunTour] = useState(false);

  // Settings state
  const [commissionRates, setCommissionRates] = useState([25, 5, 3, 2, 1]);
  const [dailyLimit, setDailyLimit] = useState(1000);
  const [maxSinglePayout, setMaxSinglePayout] = useState(100);
  const [savingSettings, setSavingSettings] = useState(false);
  const [settingsSaved, setSettingsSaved] = useState(true);

  // Auto-sign setup state (only used on dashboard)
  const [autoSignTermsAccepted, setAutoSignTermsAccepted] = useState(false);
  const [settingUpAutoSign, setSettingUpAutoSign] = useState(false);

  // Trustline confirmation (login screen)
  const [trustlineConfirmed, setTrustlineConfirmed] = useState(false);
  const [xamanUserToken, setXamanUserToken] = useState<string | null>(null);

  // Web3Auth specific state
  const [socialProvider, setSocialProvider] = useState<string | null>(null);

  // Claim token (from CLI)
  const [claimToken, setClaimToken] = useState<string | null>(null);
  const [claimStore, setClaimStore] = useState<any>(null);

  // Store referral (from ?ref= param)
  const [referralCode, setReferralCode] = useState<string | null>(null);
  const [referringStore, setReferringStore] = useState<any>(null);

  // Amount visibility toggle
  const [showAmounts, setShowAmounts] = useState(false);
  const [showQR, setShowQR] = useState(false);

  // Wallet funding state (for new Web3Auth wallets)
  const [walletNeedsFunding, setWalletNeedsFunding] = useState(false);
  const [walletNeedsTrustline, setWalletNeedsTrustline] = useState(false);
  const [walletXrpBalance, setWalletXrpBalance] = useState(0);
  const [walletRlusdBalance, setWalletRlusdBalance] = useState(0);

  // Logo state
const [storeLogo, setStoreLogo] = useState<string | null>(null);
const [showLogoUpload, setShowLogoUpload] = useState(false);
const [uploadingLogo, setUploadingLogo] = useState(false);

// Collapsed sidebar
const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

// Store tracking
const [celebrateMilestone, setCelebrateMilestone] = useState<string | null>(null);
// Info modal
const { activeInfo, openInfo, closeInfo, getContent } = useInfoModal();
// Wallet status for OnboardingSetup
const [walletStatus, setWalletStatus] = useState<WalletStatus | null>(null);
const [allMilestonesComplete, setAllMilestonesComplete] = useState(false);
const [setupComplete, setSetupComplete] = useState(false);
const [customerAutoSignEnabled, setCustomerAutoSignEnabled] = useState(false);
// Collapsed section
const [openSections, setOpenSections] = useState<Record<string, boolean>>({});
// Progress bar on button
const [progressHidden, setProgressHidden] = useState(false);
// Delete Modal
const [showDeleteModal, setShowDeleteModal] = useState(false);
const [deleting, setDeleting] = useState(false);

// Effect (add with other effects)

// MARK: - Hooks & Effects
useEffect(() => {
  if (store?.store_id && !loading) {
    const hasSeenTour = localStorage.getItem(`vendor_tour_completed_${store.store_id}`);
    if (!hasSeenTour) {
      setTimeout(() => setRunTour(true), 1000);
    }
  }
}, [store?.store_id, loading]);

useEffect(() => {

// MARK: - Event Handlers
  const handleToggle = () => setSidebarOpen(prev => !prev);
  window.addEventListener('toggleSidebar', handleToggle);
  return () => window.removeEventListener('toggleSidebar', handleToggle);
}, []);

useEffect(() => {
  if (store?.store_id) {
    const dismissed = localStorage.getItem(`milestones_dismissed_${store.store_id}`);
    setProgressHidden(dismissed === 'true');
  }
}, [store?.store_id]);

const toggleSection = (id: string) => {
  setOpenSections(prev => ({ ...prev, [id]: !prev[id] }));
};

  const refreshWalletStatus = async () => {
  if (!walletAddress) return;
  try {
    const res = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${walletAddress}`);
    const data = await res.json();
    if (data.success) {
      setWalletXrpBalance(data.xrp_balance || 0);
      setWalletRlusdBalance(data.rlusd_balance || 0);
      setWalletNeedsFunding(!data.funded);
      setWalletNeedsTrustline(!data.rlusd_trustline);
      
      // Set walletStatus for OnboardingSetup
      setWalletStatus({
        funded: data.funded,
        xrp_balance: data.xrp_balance || 0,
        rlusd_trustline: data.rlusd_trustline || false,
        rlusd_balance: data.rlusd_balance || 0,
        usdc_trustline: data.usdc_trustline || false,
        usdc_balance: data.usdc_balance || 0,
        auto_signing_enabled: data.auto_signing_enabled || false
      });
      
      // Check milestones
      if (data.funded) {
        setMilestone('wallet_funded');
      }
      if (data.rlusd_trustline) {
        setMilestone('trustline_set');
      }
    }
  } catch (err) {
    console.error('Failed to refresh wallet status:', err);
  }
};

  // Upload store logo
const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file || !store) return;

  if (file.size > 5 * 1024 * 1024) {
    setError('Image must be less than 5MB');
    return;
  }

  if (!file.type.startsWith('image/')) {
    setError('Please upload an image file');
    return;
  }

  setUploadingLogo(true);
  setError(null);

  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'store_logos');

    const uploadRes = await fetch('https://tokencanvas.io/api/cloudinary/upload', {
      method: 'POST',
      body: formData
    });

    const uploadData = await uploadRes.json();
    
    if (!uploadData.secure_url) {
      throw new Error(uploadData.error?.message || 'Upload failed');
    }

    const logoUrl = uploadData.secure_url;

    const res = await fetch(`https://api.dltpays.com/nfc/api/v1/store/${store.store_id}/logo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        logo_url: logoUrl,
        wallet_address: walletAddress
      })
    });

    const data = await res.json();
    if (data.success) {
      setStoreLogo(logoUrl);
      setStore({ ...store, logo_url: logoUrl });
      safeSetItem('storeData', JSON.stringify({ ...store, logo_url: logoUrl }));
      setShowLogoUpload(false);
    } else {
      setError('Failed to save logo');
    }
  } catch (err: any) {
    console.error('Upload error:', err);
    setError(err.message || 'Failed to upload logo');
  }
  setUploadingLogo(false);
};

// Remove store logo
const removeLogo = async () => {
  if (!store) return;
  setUploadingLogo(true);
  try {
    const res = await fetch(`https://api.dltpays.com/nfc/api/v1/store/${store.store_id}/logo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        logo_url: null,
        wallet_address: walletAddress
      })
    });
    if (res.ok) {
      setStoreLogo(null);
      setStore({ ...store, logo_url: null });
      safeSetItem('storeData', JSON.stringify({ ...store, logo_url: null }));
      setShowLogoUpload(false);
    }
  } catch (err) {
    setError('Failed to remove logo');
  }
  setUploadingLogo(false);
};

  // Sidebar scroll function
  const scrollToSection = (id: string) => {
  const element = document.getElementById(id);
  if (element) {
    const headerOffset = 80; // Height of header + some padding
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
  setSidebarOpen(false);
};

const handleNavClick = (id: string, onClick?: () => void) => {
  if (onClick) {
    onClick();
  } else {
    setOpenSections(prev => ({ ...prev, [id]: true }));
    scrollToSection(id);
  }
  setSidebarOpen(false);
  setSidebarCollapsed(true);
};

const setMilestone = async (milestoneId: string) => {
  if (!store?.store_id || !walletAddress) return;
  
  try {
    const res = await fetch(`${API_URL}/store/${store.store_id}/milestone`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        milestone: milestoneId,
        wallet_address: walletAddress
      })
    });
    const data = await res.json();
    
    if (data.success && data.new) {
      setCelebrateMilestone(milestoneId);
    }
  } catch (err) {
    console.error('Failed to set milestone:', err);
  }
};

// Check wallet status and set milestones on dashboard load
useEffect(() => {
  if (walletAddress && store?.store_id) {
    refreshWalletStatus();
  }
}, [walletAddress, store?.store_id, walletType]);

  // Check URL for claim token on load
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const params = new URLSearchParams(window.location.search);
      const claim = params.get('claim');
      if (claim) {
        setClaimToken(claim);
        fetch(`${API_URL}/store/by-claim/${claim}?_t=${Date.now()}`, { cache: 'no-store' })
          .then(res => res.json())
          .then(data => {
            if (data.success && data.store) {
              setClaimStore(data.store);
            }
          })
          .catch(console.error);
      }

      // Check for WordPress return URL - just store in sessionStorage for now
// It will be saved to Firebase in loadOrCreateStore
const wpReturn = params.get('wordpress_return') || safeGetItem('wordpress_return');
if (wpReturn) {
    safeSetItem('wordpress_return', wpReturn);
}

      // Check for referral code (from store referral link)
      const ref = params.get('ref') || safeGetItem('vendorReferralCode');
      if (ref) {
        setReferralCode(ref);
        safeSetItem('vendorReferralCode', ref);
        // Check if we already have the referring store cached
        const cachedReferrer = safeGetItem('vendorReferringStore');
        if (cachedReferrer) {
          setReferringStore(JSON.parse(cachedReferrer));
        }
       fetch(`${API_URL}/store/lookup-referral/${ref}?_t=${Date.now()}`, { cache: 'no-store' })
          .then(res => res.json())
          .then(data => {
            if (data.success && data.store) {
              setReferringStore(data.store);
              safeSetItem('vendorReferringStore', JSON.stringify(data.store));
            }
          })
          .catch(console.error);
      }

      // Check for existing Web3Auth session
const savedWallet = safeGetItem('vendorWalletAddress');
const savedType = safeGetItem('vendorLoginMethod');
const savedSocialProvider = safeGetItem('socialProvider');
if (savedWallet && savedType) {
  setWalletAddress(savedWallet);
  setWalletType(savedType as 'xaman' | 'crossmark' | 'web3auth');
  if (savedSocialProvider) setSocialProvider(savedSocialProvider);
  loadOrCreateStore(savedWallet, savedType as 'xaman' | 'crossmark' | 'web3auth');
}
    }
  }, []);

  // Check milestones on dashboard load
useEffect(() => {
  if (!store?.store_id || !walletAddress) return;

  const checkMilestones = async () => {
    try {
      // Check for first affiliate and payouts
      const countRes = await fetch(`${API_URL}/store/${store.store_id}/affiliate-count?wallet_address=${walletAddress}`);
      const countData = await countRes.json();
      
      if (countData.success) {
        if (countData.affiliates_count > 0) {
          setMilestone('first_affiliate');
        }
        
        if (countData.has_payouts) {
          setMilestone('first_payout_sent');
        }
      }

      // Check for first referred vendor
      const vendorRes = await fetch(`${API_URL}/store/${store.store_id}/referred-vendors`);
      const vendorData = await vendorRes.json();
      if (vendorData.success && vendorData.count > 0) {
        setMilestone('first_partner_signed');
      }
    } catch (err) {
      console.error('Failed to check milestones:', err);
    }
  };

  checkMilestones();
}, [store?.store_id, walletAddress]);

  // Poll for Xaman login
  useEffect(() => {
    if (!polling || !loginId) return;

    const interval = setInterval(async () => {
      try {
        const res = await fetch(`${API_URL}/xaman/login/poll/${loginId}`);
        const data = await res.json();

        if (data.status === 'signed' && data.wallet_address) {
          setWalletAddress(data.wallet_address);
          setWalletType('xaman');
          setXamanUserToken(data.xaman_user_token || null);
          setPolling(false);
          safeSetItem('vendorWalletAddress', data.wallet_address);
          safeSetItem('vendorLoginMethod', 'xaman');
          loadOrCreateStore(data.wallet_address, 'xaman', data.xaman_user_token);
        } else if (data.status === 'expired' || data.status === 'cancelled') {
          setPolling(false);
          setError('Connection ' + data.status + '. Please try again.');
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 3000);

    return () => clearInterval(interval);
  }, [polling, loginId]);

  // Check wallet status on load (Web3Auth and Xaman)
useEffect(() => {
  console.log('Wallet useEffect triggered:', { walletType, walletAddress, store: !!store });
  if (walletAddress && store) {
    // Check wallet funding status
    fetch(`${API_URL}/wallet/status/${walletAddress}`)
      .then(res => res.json())
      .then(data => {
  console.log('Wallet status response:', data);
  if (data.success) {
    console.log('Setting XRP balance:', data.xrp_balance);
    console.log('Setting RLUSD balance:', data.rlusd_balance);
    setWalletXrpBalance(data.xrp_balance || 0);
    setWalletRlusdBalance(data.rlusd_balance || 0);

    setWalletStatus({
      funded: data.funded,
      xrp_balance: data.xrp_balance || 0,
      rlusd_trustline: data.rlusd_trustline || false,
      rlusd_balance: data.rlusd_balance || 0,
      usdc_trustline: data.usdc_trustline || false,
      usdc_balance: data.usdc_balance || 0,
      auto_signing_enabled: data.auto_signing_enabled || false
    });
          
          if (!data.funded) {
            setWalletNeedsFunding(true);
            setWalletNeedsTrustline(false);
          } else if (!data.rlusd_trustline) {
            setWalletNeedsFunding(false);
            setWalletNeedsTrustline(true);
          } else {
            setWalletNeedsFunding(false);
            setWalletNeedsTrustline(false);
          }
        }
      })
      .catch(console.error);
  }
}, [walletType, walletAddress, store]);

  // =========================================================================
  // WEB3AUTH GOOGLE LOGIN
  // =========================================================================
  const connectGoogle = async () => {
    if (!web3authTermsAccepted) return;
    
    setConnectingGoogle(true);
    setError(null);
    
    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth) {
        throw new Error('Web3Auth not available');
      }
      
      const provider = await web3auth.connect();
      if (!provider) {
        throw new Error('Connection cancelled');
      }
      
      const accounts = await provider.request({ method: 'xrpl_getAccounts' }) as string[];
      const address = accounts?.[0];
      
      if (!address) {
        throw new Error('No wallet address returned');
      }
      
      // Get the social provider type
      // Get the social provider type
      const userInfo = await web3auth.getUserInfo();
      const socialProviderType = userInfo?.authConnection;
      
      setWalletAddress(address);
      setWalletType('web3auth');
      setSocialProvider(socialProviderType);
      safeSetItem('vendorWalletAddress', address);
      safeSetItem('vendorLoginMethod', 'web3auth');
      safeSetItem('socialProvider', socialProviderType);
      
      loadOrCreateStore(address, 'web3auth');
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Google login failed';
      if (!message.includes('cancelled') && !message.includes('closed')) {
        setError(message);
      }
    }
    
    setConnectingGoogle(false);
  };


// MARK: - API Calls & Data Fetching
  const loadOrCreateStore = async (wallet: string, type: 'xaman' | 'crossmark' | 'web3auth', xamanUserToken?: string | null) => {
  setLoading(true);
  try {
    // If we have a claim token, attach wallet to that store
    if (claimToken && claimStore) {
      const res = await fetch(`${API_URL}/store/claim`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          claim_token: claimToken,
          wallet_address: wallet,
          wallet_type: type,
          xaman_user_token: xamanUserToken || null
        })
      });
      const data = await res.json();

      if (data.success && data.store) {
  setStore(data.store);
  setStoreLogo(data.store.logo_url || null);
  console.log('üîç Normal flow - Logo URL:', data.store.logo_url);
  safeSetItem('storeData', JSON.stringify(data.store));
  setNewSecret(null);
  if (data.store.commission_rates) setCommissionRates(data.store.commission_rates);
        setStep('dashboard');
        setClaimToken(null);
        setClaimStore(null);
        setLoading(false);
        return;
      } else {
        setError(data.error || 'Failed to claim store');
      }
    }

    // Normal flow - check if wallet has existing store
    const res = await fetch(`${API_URL}/store/by-wallet/${wallet}`);
    const data = await res.json();

    if (data.success && data.store) {
  setStore(data.store);
  setStoreLogo(data.store.logo_url || null);
  safeSetItem('storeData', JSON.stringify(data.store));
  setNewSecret(null);
      if (data.store.commission_rates) setCommissionRates(data.store.commission_rates);
      if (data.store.daily_limit) setDailyLimit(data.store.daily_limit);
      if (data.store.auto_sign_max_single_payout) setMaxSinglePayout(data.store.auto_sign_max_single_payout);

      // If we have a wordpress_return in URL/session, save it to Firebase
      const wpReturn = new URLSearchParams(window.location.search).get('wordpress_return') 
        || safeGetItem('wordpress_return');
      
      if (wpReturn && !data.store.platform_return_url) {
        await fetch(`${API_URL}/store/set-platform-return`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: data.store.store_id,
            wallet_address: wallet,
            platform_return_url: wpReturn,
            platform_type: 'wordpress'
          })
        });
        data.store.platform_return_url = wpReturn;
        data.store.platform_type = 'wordpress';
        setStore({ ...data.store, platform_return_url: wpReturn, platform_type: 'wordpress' });
        setStoreLogo(data.store.logo_url || null);
      }

      // Save Xaman connection for existing store
      if (type === 'xaman' && xamanUserToken) {
        await fetch(`${API_URL}/store/save-xaman-wallet`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: data.store.store_id,
            wallet_address: wallet,
            xaman_user_token: xamanUserToken
          })
        });
        data.store.xaman_connected = true;
        data.store.xaman_user_token = xamanUserToken;
      }

      setStep('dashboard');
    } else {
      // ========== NEW: Try to link wallet to unclaimed store ==========
      const linkRes = await fetch(`${API_URL}/store/link-wallet`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: wallet,
          wallet_type: type,
          xaman_user_token: xamanUserToken || null
        })
      });
      const linkData = await linkRes.json();

      if (linkData.success && linkData.store) {
        // Store was found and linked!
        setStore(linkData.store);
        setStoreLogo(linkData.store.logo_url || null);
        if (linkData.api_secret) {
          setNewSecret(linkData.api_secret); // Show the new secret to user
        }
        if (linkData.store.commission_rates) setCommissionRates(linkData.store.commission_rates);
        if (linkData.store.daily_limit) setDailyLimit(linkData.store.daily_limit);
        setStep('dashboard');
      } else if (linkData.unclaimed_stores && linkData.unclaimed_stores.length > 0) {
        // Multiple unclaimed stores - for now just show the first one
        // TODO: Could add a store selector UI here
        console.log('Multiple unclaimed stores found:', linkData.unclaimed_stores);
        setStore(null);
        setStep('dashboard');
      } else {
        // No store found at all - show create form
        setStore(null);
        setStep('dashboard');
      }
      // ========== END NEW ==========
    }
  } catch (err) {
    setError('Failed to load store');
  }
  setLoading(false);
};

  const createStore = async (storeName: string, storeUrl: string, email: string, referredBy: string | null = null) => {
    setLoading(true);
    setError(null);

    try {
      const res = await fetch(`${API_URL}/store/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_name: storeName,
          store_url: storeUrl,
          email: email,
          wallet_address: walletAddress,
          wallet_type: walletType,
          xaman_user_token: xamanUserToken,
          referral_code: referredBy
        })
      });

      const data = await res.json();

      if (data.error) {
        setError(data.error);
        setLoading(false);
        return;
      }

      setNewSecret(data.api_secret);
      
      // Clear referral sessionStorage after successful signup
      safeRemoveItem('vendorReferralCode');
      safeRemoveItem('vendorReferringStore');

// Save platform return URL if we came from WordPress
const wpReturn = new URLSearchParams(window.location.search).get('wordpress_return') 
  || safeGetItem('wordpress_return');

const newStore = {
  store_id: data.store_id,
  store_name: storeName,
  store_url: storeUrl,
  api_key: data.api_key,
  store_referral_code: data.store_referral_code,
  wallet_address: walletAddress,
  payout_mode: 'manual',
  auto_signing_enabled: false,
  xaman_connected: walletType === 'xaman',
  crossmark_connected: walletType === 'crossmark',
  web3auth_connected: walletType === 'web3auth',
  platform_return_url: wpReturn || null,
  platform_type: wpReturn ? 'wordpress' : null
};

if (wpReturn) {
  // Save to Firebase
  fetch(`${API_URL}/store/set-platform-return`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      store_id: data.store_id,
      wallet_address: walletAddress,
      platform_return_url: wpReturn,
      platform_type: 'wordpress'
    })
  });
}

setStore(newStore);
setStep('dashboard');
    } catch (err) {
      setError('Failed to create store');
    }
    setLoading(false);
  };

  const regenerateSecret = async () => {
    if (!store || !walletAddress) return;
    if (!confirm('This will invalidate your current secret. Your WordPress plugin and any API integrations will stop working until you update them. Continue?')) return;

    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/store/regenerate-secret`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress
        })
      });

      const data = await res.json();
      if (data.error) {
        setError(data.error);
      } else {
        setNewSecret(data.api_secret);
        setSecretRevealed(false);
        setSecretSaved(false);
      }
    } catch (err) {
      setError('Failed to regenerate secret');
    }
    setLoading(false);
  };

  const saveSettings = async () => {
    if (!store || !walletAddress) return;
    setSavingSettings(true);

    try {
      const res = await fetch(`${API_URL}/store/settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress,
          commission_rates: commissionRates,
          daily_limit: dailyLimit,
          auto_sign_max_single_payout: maxSinglePayout
        })
      });

      const data = await res.json();
      if (data.error) {
        setError(data.error);
      } else {
        setSettingsSaved(true);
        setStore({ ...store, commission_rates: commissionRates, daily_limit: dailyLimit, auto_sign_max_single_payout: maxSinglePayout });
      }
    } catch (err) {
      setError('Failed to save settings');
    }
    setSavingSettings(false);
  };

  // =========================================================================
  // XAMAN LOGIN
  // =========================================================================
  const loginXaman = async () => {
    setStep('xaman');
    setError(null);

    try {
      const res = await fetch(`${API_URL}/xaman/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await res.json();
      if (data.error) {
        setError(data.error);
        setStep('login');
        return;
      }

      setXamanQR(data.qr_png);
      setXamanDeepLink(data.deep_link);
      setLoginId(data.login_id);
      setPolling(true);
    } catch (err) {
      setError('Failed to connect');
      setStep('login');
    }
  };

  // =========================================================================
  // DISCONNECT WALLET
  // =========================================================================
  const disconnectWallet = async () => {

    setLoading(true);
    try {
      // For Web3Auth, also logout from Web3Auth
      if (walletType === 'web3auth') {
        try {
          const { logoutWeb3Auth } = await import('@/lib/web3auth');
          await logoutWeb3Auth();
        } catch (e) {
          console.error('Web3Auth logout error:', e);
        }
      }

      const res = await fetch(`${API_URL}/store/disconnect-wallet`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress
        })
      });

      const data = await res.json();
      if (data.success) {
  setStore({ ...store, wallet_address: null, xaman_connected: false, crossmark_connected: false, web3auth_connected: false, payout_mode: 'manual', auto_signing_enabled: false });
  setWalletAddress(null);
  setWalletType(null);
  setWalletStatus(null);
  setCustomerAutoSignEnabled(false);
  safeRemoveItem('vendorWalletAddress');
  safeRemoveItem('vendorLoginMethod');
} else {
  setError(data.error || 'Failed to disconnect');
}
    } catch (err) {
      setError('Failed to disconnect wallet');
    }
    setLoading(false);
  };

  // =========================================================================
  // SIGN OUT (full logout)
  // =========================================================================
  const signOut = async () => {
    // Clear Web3Auth session if applicable
    if (walletType === 'web3auth') {
      try {
        const { logoutWeb3Auth } = await import('@/lib/web3auth');
        await logoutWeb3Auth();
      } catch (e) {
        console.error('Web3Auth logout error:', e);
      }
    }
    
    // Clear session storage
    safeRemoveItem('vendorWalletAddress');
    safeRemoveItem('vendorLoginMethod');
    
    // Reset state
    setWalletAddress(null);
    setWalletType(null);
    setStore(null);
    setStep('login');
  };

  // =========================================================================
  // AUTO-SIGN SETUP (Crossmark)
  // =========================================================================
  const setupAutoSign = async () => {
  console.log('setupAutoSign called, walletType:', walletType);
  if (!store || !walletAddress) return;

    const sdk = (window as any).xrpl?.crossmark;
    if (!sdk) {
      setError('Crossmark wallet not detected.');
      return;
    }
    console.log('Crossmark SDK found');

    setSettingUpAutoSign(true);
    setError(null);

    try {
      // Use existing wallet address - no need to sign in again
      const address = walletAddress;
      console.log('Address:', address);

      // Check if wallet needs RLUSD setup
      const walletStatusRes = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${address}`);
      const walletStatusData = await walletStatusRes.json();
      
      if (walletStatusData.success && walletStatusData.funded && !walletStatusData.rlusd_trustline) {
        console.log('Setting up RLUSD for wallet via Crossmark...');
        
        await sdk.methods.signAndSubmitAndWait({
          TransactionType: 'TrustSet',
          Account: address,
          LimitAmount: {
            currency: '524C555344000000000000000000000000000000',
            issuer: 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De',
            value: '1000000',
          },
        });
        
        console.log('RLUSD enabled successfully via Crossmark');
setMilestone('trustline_set');
// Wait for ledger
await new Promise(resolve => setTimeout(resolve, 2000));
      }

      // Get platform signer address from API
      const settingsRes = await fetch(`${API_URL}/xaman/setup-autosign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ store_id: store.store_id })
      });
      const settingsData = await settingsRes.json();
      console.log('Settings data:', settingsData);

      if (settingsData.error) {
        throw new Error(settingsData.error);
      }

      // If signer already exists, go straight to verification
      if (settingsData.signer_exists) {
        const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
        const verifyData = await verifyRes.json();
        
        if (verifyData.auto_signing_enabled) {
          setStore({
            ...store,
            payout_mode: 'auto',
            auto_signing_enabled: true,
            crossmark_connected: true,
            daily_limit: dailyLimit,
            auto_sign_max_single_payout: maxSinglePayout
          });
          setMilestone('auto_sign_enabled');
          setAutoSignTermsAccepted(false);
          setSettingUpAutoSign(false);
          // Refresh wallet status to update UI
          await refreshWalletStatus();
          return;
        }
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) {
        throw new Error('Platform signer not configured');
      }

      // Build and sign SignerListSet transaction with Crossmark
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: address,
        SignerQuorum: 1,
        SignerEntries: [
          {
            SignerEntry: {
              Account: platformSignerAddress,
              SignerWeight: 1
            }
          }
        ]
      };

      console.log('About to sign tx:', signerListSetTx);
let signResult;
try {
  signResult = await sdk.methods.signAndSubmitAndWait({
    TransactionType: 'SignerListSet',
    Account: address,
    SignerQuorum: 1,
    SignerEntries: [
      {
        SignerEntry: {
          Account: platformSignerAddress,
          SignerWeight: 1
        }
      }
    ]
  });
  console.log('Sign result:', signResult);
} catch (signError) {
  console.error('Sign error:', signError);
  throw signError;
}

      // Verify the setup
      const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
      const verifyData = await verifyRes.json();

      if (!verifyData.auto_signing_enabled) {
        throw new Error('Signer setup failed. Please try again.');
      }

      // Update store settings with limits
      await fetch(`${API_URL}/store/settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: address,
          daily_limit: dailyLimit,
          auto_sign_max_single_payout: maxSinglePayout
        })
      });

      setStore({
  ...store,
  payout_mode: 'auto',
  auto_signing_enabled: true,
  wallet_address: address,
  crossmark_connected: true,
  xaman_connected: false,
  web3auth_connected: false,
  daily_limit: dailyLimit,
  auto_sign_max_single_payout: maxSinglePayout
});
setMilestone('auto_sign_enabled');
await refreshWalletStatus();
      setWalletAddress(address);
      setWalletType('crossmark');
      safeSetItem('vendorWalletAddress', address);
      safeSetItem('vendorLoginMethod', 'crossmark');
      setAutoSignTermsAccepted(false);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to enable auto-sign';
      setError(message);
    }
    setSettingUpAutoSign(false);
  };

  // =========================================================================
  // AUTO-SIGN SETUP (Web3Auth) - Signs SignerListSet via Web3Auth
  // =========================================================================
  const setupAutoSignWeb3Auth = async () => {
  if (!store || !walletAddress) return;

  setSettingUpAutoSign(true);
  setError(null);

  try {
    const { getWeb3Auth } = await import('@/lib/web3auth');
    const web3auth = await getWeb3Auth();
    
    if (!web3auth || !web3auth.provider) {
      throw new Error('Web3Auth session not available. Please sign in again.');
    }

    // Check if wallet needs RLUSD setup
    const walletStatusRes = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${walletAddress}`);
    const walletStatusData = await walletStatusRes.json();
    
    if (walletStatusData.success && walletStatusData.funded && !walletStatusData.rlusd_trustline) {
      // POSITIVE MESSAGE instead of just console.log
      setError(null);
      setSetupProgress('Setting up RLUSD trustline... (1/2)');
      
      const trustlineTx = {
        TransactionType: 'TrustSet',
        Account: walletAddress,
        LimitAmount: {
          currency: '524C555344000000000000000000000000000000',
          issuer: 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De',
          value: '1000000',
        },
      };
      
      await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: trustlineTx },
      });
      
      setSetupProgress('RLUSD enabled ‚úì Now confirm Auto-Pay... (2/2)');
setMilestone('trustline_set');
await new Promise(resolve => setTimeout(resolve, 2000));
    }

    // Get platform signer address from API
    const settingsRes = await fetch(`${API_URL}/xaman/setup-autosign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ store_id: store.store_id })
    });
    const settingsData = await settingsRes.json();
    
    if (settingsData.error) {
      throw new Error(settingsData.error);
    }

    // Handle unfunded wallet
    if (settingsData.needs_funding) {
      setWalletNeedsFunding(true);
      setSettingUpAutoSign(false);
      setSetupProgress(null);
      return;
    }

    // If signer already exists, just verify
    if (settingsData.signer_exists) {
      const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
      const verifyData = await verifyRes.json();
      
      if (verifyData.auto_signing_enabled) {
        setStore({
          ...store,
          payout_mode: 'auto',
          auto_signing_enabled: true,
          daily_limit: dailyLimit,
          auto_sign_max_single_payout: maxSinglePayout
        });
        setAutoSignTermsAccepted(false);
        setSettingUpAutoSign(false);
        setSetupProgress(null);
        await refreshWalletStatus();
        return;
      }
    }

    const platformSignerAddress = settingsData.platform_signer_address;
    if (!platformSignerAddress) {
      throw new Error('Platform signer not configured');
    }

    // POSITIVE MESSAGE before SignerList
    setSetupProgress('Confirm Auto-Pay in your wallet...');

    const signerListSetTx = {
      TransactionType: 'SignerListSet',
      Account: walletAddress,
      SignerQuorum: 1,
      SignerEntries: [
        {
          SignerEntry: {
            Account: platformSignerAddress,
            SignerWeight: 1
          }
        }
      ]
    };

    await web3auth.provider.request({
      method: 'xrpl_submitTransaction',
      params: { transaction: signerListSetTx }
    });

    setSetupProgress('Verifying setup...');

    // Retry verification up to 5 times with increasing delays
    let verified = false;
    for (let attempt = 1; attempt <= 5; attempt++) {
      await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
      
      const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
      const verifyData = await verifyRes.json();
      
      if (verifyData.auto_signing_enabled) {
        verified = true;
        break;
      }
      
      if (attempt < 5) {
        setSetupProgress(`Confirming on XRPL... (attempt ${attempt + 1}/5)`);
      }
    }

    if (!verified) {
      throw new Error('Signer setup failed. Please try again.');
    }

    // Update store settings
    await fetch(`${API_URL}/store/settings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: store.store_id,
        wallet_address: walletAddress,
        daily_limit: dailyLimit,
        auto_sign_max_single_payout: maxSinglePayout
      })
    });

    // SUCCESS - update state immediately (no manual refresh needed)
setStore({
  ...store,
  payout_mode: 'auto',
  auto_signing_enabled: true,
  daily_limit: dailyLimit,
  auto_sign_max_single_payout: maxSinglePayout
});
setMilestone('auto_sign_enabled');
setAutoSignTermsAccepted(false);
setSetupProgress(null);
await refreshWalletStatus();

  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : 'Failed to enable auto-sign';
    setError(message);
    setSetupProgress(null);
  }
  setSettingUpAutoSign(false);
};

  // =========================================================================
  // REVOKE AUTO-SIGN
  // =========================================================================
  const revokeAutoSign = async () => {
  if (!confirm('Disable auto-signing? You will need to manually approve each payout.')) return;

  setLoading(true);
  setError(null);
  
  try {
    // Step 1: Get revoke status from API
    const res = await fetch(`${API_URL}/store/revoke-autosign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: store.store_id,
        wallet_address: walletAddress
      })
    });

    const data = await res.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to revoke');
    }

    // Already revoked
    if (data.already_revoked) {
      setStore({ ...store, payout_mode: 'manual', auto_signing_enabled: false });
setCustomerAutoSignEnabled(false);
      // Clear success flag so wizard can show success again when re-enabled
      if (walletAddress) {
        localStorage.removeItem(`onboarding_success_shown_vendor_${walletAddress}`);
        safeSetItem(`onboarding_active_vendor_${walletAddress}`, 'true');
      }
      setLoading(false);
      return;
    }

    // Step 2: Sign transaction to remove signer from XRPL
    if (data.needs_signature) {
      const revokeTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 0,
      };

      let result;
      
      if (walletType === 'crossmark') {
        // Use Crossmark SDK
        const sdk = (window as any).xrpl?.crossmark;
        if (!sdk) {
          throw new Error('Crossmark wallet not detected.');
        }
        result = await sdk.methods.signAndSubmitAndWait(revokeTx);
      } else {
        // Use Web3Auth
        const { getWeb3Auth } = await import('@/lib/web3auth');
        const web3auth = await getWeb3Auth();

        if (!web3auth || !web3auth.provider) {
          throw new Error('Web3Auth session expired. Please sign in again.');
        }

        result = await web3auth.provider.request({
          method: 'xrpl_submitTransaction',
          params: { transaction: revokeTx }
        });
      }

      // Step 3: Confirm with backend
      await fetch(`${API_URL}/store/confirm-revoke`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress,
          tx_hash: (result as any)?.result?.hash || (result as any)?.hash || null
        })
      });

      await new Promise(resolve => setTimeout(resolve, 2000));
    }

    setStore({ ...store, payout_mode: 'manual', auto_signing_enabled: false });
setCustomerAutoSignEnabled(false);
    // Clear success flag so wizard can show success again when re-enabled
    if (walletAddress) {
      localStorage.removeItem(`onboarding_success_shown_vendor_${walletAddress}`);
      safeSetItem(`onboarding_active_vendor_${walletAddress}`, 'true');
    }
    
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : 'Failed to revoke auto-sign';
    setError(message);
  }
  setLoading(false);
};

  // =========================================================================
  // PERMANENTLY DELETE STORE
  // =========================================================================
  const deleteStore = async () => {
  setDeleting(true);
  try {
    const res = await fetch(`${API_URL}/store/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: store.store_id,
        wallet_address: walletAddress,
        confirm: 'PERMANENTLY DELETE'
      })
    });

    const data = await res.json();
    if (data.success) {
      safeRemoveItem('vendorWalletAddress');
      safeRemoveItem('vendorLoginMethod');
      safeRemoveItem('socialProvider');
      window.location.href = '/dashboard';
    } else {
      setError(data.error || 'Failed to delete');
      setShowDeleteModal(false);
    }
  } catch (err) {
    setError('Failed to delete store');
    setShowDeleteModal(false);
  }
  setDeleting(false);
};

  const copyToClipboard = (text: string, field: string) => {
    navigator.clipboard.writeText(text);
    setCopied(field);
    setTimeout(() => setCopied(null), 2000);
  };

  const SocialIcon = ({ provider }: { provider: string | null }) => {
    switch (provider) {
      case 'github':

// MARK: - Main Render
        return (
          <div className="w-8 h-8 bg-[#24292e] rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </div>
        );
      case 'twitter':
        return (
          <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
            <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </div>
        );
      case 'discord':
        return (
          <div className="w-8 h-8 bg-[#5865F2] rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
          </div>
        );
      case 'facebook':
        return (
          <div className="w-8 h-8 bg-[#1877F2] rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </div>
        );
      case 'apple':
        return (
          <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
          </div>
        );
      case 'google':
      default:
        return (
          <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
          </div>
        );
    }
  };

  // =========================================================================
  // LOGIN SCREEN
  // =========================================================================
  if (step === 'login') {
    return (
      <>
        <LoginScreen 
          onLogin={(wallet, method, extras) => {
setWalletAddress(wallet);
setWalletType(method);
if (extras?.xamanUserToken) setXamanUserToken(extras.xamanUserToken);
if (extras?.socialProvider) setSocialProvider(extras.socialProvider);
safeSetItem('vendorWalletAddress', wallet);
safeSetItem('vendorLoginMethod', method);
if (extras?.socialProvider) safeSetItem('socialProvider', extras.socialProvider);
loadOrCreateStore(wallet, method, extras?.xamanUserToken);
          }}
requireTrustline={true}
claimStore={claimStore}
referringStore={referringStore}
storagePrefix="vendor"
title="Partners Dashboard"
subtitle="Sign in to manage your affiliate commissions"
showLogo={true}
/>
      </>
    );
  }

  // =========================================================================
  // XAMAN QR SCREEN
  // =========================================================================
  if (step === 'xaman') {
return (
<div className="min-h-screen bg-transparent text-white font-sans relative z-10">
<main className="max-w-xl mx-auto px-6 py-16">
<button onClick={() => {
  setPolling(false);
  if (store) {
    setStep('dashboard');
  } else {
    setStep('login');
  }
}} className="text-zinc-500 text-sm hover:text-white mb-8">
‚Üê Back
</button>

          <h1 className="text-3xl font-bold mb-2">Scan with Xaman</h1>
          <p className="text-zinc-400 mb-8">Open your Xaman app and scan the QR code</p>

          <div className="text-center">
            <div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-8 mb-6">
              {xamanQR ? (
                <>
                  <img src={xamanQR} alt="Xaman QR" className="mx-auto mb-4 rounded-lg" />
                  <div className="flex items-center justify-center gap-2 text-zinc-500 text-sm mb-4">
                    <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    Waiting for signature...
                  </div>
                  {xamanDeepLink && (
                    <a
                      href={xamanDeepLink}
                      className="inline-block bg-blue-500 hover:bg-blue-400 text-white px-6 py-2 rounded-lg transition"
                    >
                      Open Xaman App
                    </a>
                  )}
                </>
              ) : (
                <div className="flex items-center justify-center gap-2 text-zinc-500">
                  <span className="w-4 h-4 border-2 border-zinc-500 border-t-white rounded-full animate-spin"></span>
                  Loading...
                </div>
              )}
            </div>
          </div>
        </main>
      </div>
    );
  }
// =========================================================================
  // DASHBOARD - Navigation items for sidebar
  // =========================================================================
  const navItems = [
  { 
    id: 'take-payment', 
    label: 'Take Payment', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
      </svg>
    ),
    onClick: () => router.push('/take-payment')
  },
  { 
    id: 'signup-customer', 
    label: 'Sign Up Customer', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
      </svg>
    )
  },
  { 
    id: 'wallet-funding', 
    label: 'Top Up Wallet', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m6-6H6" />
      </svg>
    ),
    show: !walletNeedsFunding && !walletNeedsTrustline
  },
  { 
    id: 'withdraw', 
    label: 'Balance/Withdraw', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
      </svg>
    ),
    show: !walletNeedsFunding && !walletNeedsTrustline
  },
  { 
    id: 'payout-method', 
    label: 'Payout Method', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
      </svg>
    )
  },
  { 
    id: 'pending-customers', 
    label: 'Pending Customers', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
      </svg>
    )
  },
  { 
  id: 'earn-interest', 
  label: (
    <span className="flex items-center gap-2">
      Earn Interest
      <span className="bg-indigo-500/20 text-indigo-400 text-[10px] px-1.5 py-0.5 rounded-full">Soon</span>
    </span>
  ),
  icon: (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
    </svg>
  )
},
  { 
    id: 'auto-sign', 
    label: 'Auto-Sign', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
      </svg>
    ),
    show: !store?.auto_signing_enabled
  },
  { 
    id: 'commission-rates', 
    label: 'Commission Rates', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
      </svg>
    )
  },
  { 
    id: 'affiliate-link', 
    label: 'Affiliate Link', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
      </svg>
    )
  },
  { 
    id: 'api-credentials', 
    label: 'API Credentials', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
      </svg>
    )
  },
  { 
    id: 'return-wordpress', 
    label: 'Return to Site', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
      </svg>
    ),
    show: !!store?.platform_return_url
  },
  { 
    id: 'quick-links', 
    label: 'Quick Links', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
      </svg>
    )
  },
  { 
    id: 'activity', 
    label: 'Activity', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
      </svg>
    )
  },
  { 
    id: 'danger-zone', 
    label: 'Danger Zone', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
      </svg>
    )
  },
].filter(item => item.show !== false);
// =========================================================================
// DASHBOARD
// =========================================================================
return (
<>
<NebulaBackground opacity={0.2} />
<DashboardHeader
  dashboardType="vendor"
  walletAddress={walletAddress || undefined}
  storeId={store?.store_id}
  onSignOut={signOut}
  allMilestonesComplete={allMilestonesComplete}
  setupComplete={setupComplete}
/>
<VendorDashboardTour
  run={runTour} 
  onComplete={() => {
    setRunTour(false);
    if (store?.store_id) {
      localStorage.setItem(`vendor_tour_completed_${store.store_id}`, 'true');
    }
  }}
/>
    <div className="min-h-screen bg-transparent text-white font-sans relative z-0 overflow-x-hidden">
      <Script src="https://unpkg.com/@aspect-dev/crossmark-sdk@1.0.5/dist/umd/index.js" />

      {/* Celebration Toast */}
  {celebrateMilestone && (
    <CelebrationToast
      milestone={celebrateMilestone}
      onClose={() => setCelebrateMilestone(null)}
    />
  )}

  {/* Info Modal */}
{activeInfo && getContent() && (
  <InfoModal
    content={getContent()!}
    isOpen={!!activeInfo}
    onClose={closeInfo}
  />
)}

      <Sidebar
  isOpen={sidebarOpen}
  isCollapsed={sidebarCollapsed}
  onToggleOpen={() => setSidebarOpen(!sidebarOpen)}
  onToggleCollapsed={() => setSidebarCollapsed(!sidebarCollapsed)}
  storeName={store?.store_name}
  storeLogo={storeLogo}
  walletAddress={walletAddress}
  navItems={navItems}
  onNavClick={handleNavClick}
  onLogoClick={() => setShowLogoUpload(true)}
  onSignOut={signOut}
  onTakeTour={() => {
  setSidebarOpen(false);
  window.scrollTo({ top: 0, behavior: 'smooth' });
  setRunTour(false);
  setTimeout(() => setRunTour(true), 100);
}}
  onInfoClick={openInfo}
  onShowProgress={() => {
    if (store?.store_id) {
      localStorage.removeItem(`milestones_dismissed_${store.store_id}`);
      setProgressHidden(false);
    }
  }}
/>

{/* Logo Upload Modal */}
{showLogoUpload && (
  <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
    <div className="bg-zinc-900/95 rounded-2xl p-6 w-full max-w-sm">
      <h3 className="text-lg font-bold mb-4">Store Logo</h3>
      {storeLogo && (
        <div className="mb-4 flex justify-center">
          <img src={storeLogo} alt="Current logo" className="w-24 h-24 rounded-xl object-cover" />
        </div>
      )}
      <label className="block mb-4">
        <div className="bg-zinc-800/90 border-2 border-dashed border-zinc-700 hover:border-emerald-500 rounded-xl p-6 text-center cursor-pointer transition">
          {uploadingLogo ? (
            <div className="flex flex-col items-center">
              <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mb-2"></div>
              <p className="text-zinc-400 text-sm">Uploading...</p>
            </div>
          ) : (
            <>
              <svg className="w-8 h-8 text-zinc-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p className="text-zinc-400 text-sm">Click to upload image</p>
              <p className="text-zinc-600 text-xs mt-1">Max 5MB</p>
            </>
          )}
        </div>
        <input
          type="file"
          accept="image/*"
          onChange={handleLogoUpload}
          className="hidden"
          disabled={uploadingLogo}
        />
      </label>
      <div className="flex gap-3">
        {storeLogo && (
          <button
            onClick={removeLogo}
            disabled={uploadingLogo}
            className="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-3 rounded-xl transition disabled:opacity-50"
          >
            Remove
          </button>
        )}
        <button
          onClick={() => setShowLogoUpload(false)}
          className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 py-3 rounded-xl transition"
        >
          {storeLogo ? 'Done' : 'Cancel'}
        </button>
      </div>
    </div>
  </div>
)}

      {/* Main Content */}
<main className={`min-h-screen pt-2 lg:pt-0 transition-all duration-300 ${sidebarCollapsed ? 'lg:ml-0' : 'lg:ml-64'}`}>
        <div className="max-w-3xl lg:max-w-none mx-auto px-3 sm:px-6 lg:px-4 pt-20 pb-4">

        {error && (
  error.includes('beta') || error.includes('full') || error.includes('waitlist') ? (
    <div className="bg-gradient-to-b from-sky-900/50 to-slate-900/50 border border-sky-500/30 rounded-xl p-6 mb-6">
      <div className="text-center">
        
        {/* Professional Shield Icon */}
        <div className="w-16 h-16 mx-auto mb-4 bg-sky-500/20 rounded-full flex items-center justify-center">
          <svg className="w-8 h-8 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
          </svg>
        </div>
        
        <h3 className="text-xl font-bold text-sky-400 mb-2">Beta is Full!</h3>
        <p className="text-sky-200/70 mb-6">We're at capacity right now, but we'd love to have you join when spots open up.</p>
        
        <form onSubmit={async (e) => {
          e.preventDefault();
          const form = e.target as HTMLFormElement;
          const email = (form.elements.namedItem('waitlistEmail') as HTMLInputElement).value;
          try {
            await fetch('https://api.dltpays.com/api/v1/waitlist', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, source: 'beta_full' })
            });
            setError(null);
            alert('Thanks! We\'ll notify you when a spot opens up.');
          } catch (err) {
            alert('Failed to join waitlist. Please try again.');
          }
        }} className="max-w-sm mx-auto">
          <input
            name="waitlistEmail"
            type="email"
            required
            placeholder="your@email.com"
            className="w-full bg-slate-800/50 border border-sky-500/30 rounded-lg px-4 py-3 text-white placeholder-slate-400 mb-3 focus:outline-none focus:border-sky-400 transition-all"
          />
          <button type="submit" className="w-full bg-sky-500 hover:bg-sky-400 text-white font-semibold py-3 rounded-lg transition shadow-lg shadow-sky-500/25">
            Join Waitlist
          </button>
        </form>
        
        <button onClick={() => setError(null)} className="text-slate-400 text-sm mt-4 hover:text-white transition-colors">
          Dismiss
        </button>
      </div>
    </div>
  ) : (
            <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
              <p className="text-red-400 text-sm">{error}</p>
              <button onClick={() => setError(null)} className="text-red-400 text-xs mt-2 hover:underline">Dismiss</button>
            </div>
          )
        )}

        {/* No store yet - show create form */}
        {!store && (
          <div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-8">
            <h2 className="text-xl font-bold mb-6">Sign Up</h2>

            {/* Show referral banner in registration form */}
            {referringStore && (
              <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-blue-400">üéÅ</span>
                  <span className="text-blue-400 font-medium">Referred by {referringStore.store_name}</span>
                </div>
                <p className="text-zinc-400 text-sm">50% off platform fees for your first month!</p>
              </div>
            )}

            <form onSubmit={async (e) => {
              e.preventDefault();
              const form = e.target as HTMLFormElement;

              // Determine the referring store - either from state, sessionStorage, or manual input
              let finalReferrer = referringStore;
              if (!finalReferrer) {
                const cachedReferrer = safeGetItem('vendorReferringStore');
                if (cachedReferrer) {
                  finalReferrer = JSON.parse(cachedReferrer);
                }
              }

              // If user entered a referral code manually, look it up first
              const manualRef = (form.elements.namedItem('referralCode') as HTMLInputElement)?.value?.trim();
              if (manualRef && !finalReferrer) {
                try {
                  const res = await fetch(`${API_URL}/store/lookup-referral/${manualRef}?_t=${Date.now()}`, { cache: 'no-store' });
                  const data = await res.json();
                  if (data.success && data.store) {
                    finalReferrer = data.store;
                    setReferringStore(data.store);
                  }
                } catch (err) {
                  console.error('Referral lookup failed:', err);
                }
              }

              // Get referral code from URL, sessionStorage, or manual input
              const refCode = new URLSearchParams(window.location.search).get('ref') 
                || safeGetItem('vendorReferralCode')
                || (form.elements.namedItem('referralCode') as HTMLInputElement)?.value?.trim()
                || null;
              
              createStore(
                (form.elements.namedItem('storeName') as HTMLInputElement).value,
                (form.elements.namedItem('storeUrl') as HTMLInputElement).value,
                (form.elements.namedItem('email') as HTMLInputElement).value,
                refCode
              );
            }}>
              <div className="space-y-4">
                <div>
                  <label className="text-zinc-400 text-sm block mb-2">Name</label>
                  <input name="storeName" required className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white" placeholder="My Store" />
                </div>
                <div>
                  <label className="text-zinc-400 text-sm block mb-2">Website URL</label>
                  <input name="storeUrl" type="url" required className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white" placeholder="https://mystore.com" />
                </div>
                <div>
                  <label className="text-zinc-400 text-sm block mb-2">Email</label>
                  <input name="email" type="email" required className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white" placeholder="you@example.com" />
                </div>

                {/* Referral code input - only show if not already referred */}
                {!referringStore && (
                  <div>
                    <label className="text-zinc-400 text-sm block mb-2">Referral Code <span className="text-zinc-600">(optional)</span></label>
                    <input
                      name="referralCode"
                      className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white"
                      placeholder="E.g. E73E22E4"
                      defaultValue={referralCode || ''}
                    />
                    <p className="text-zinc-600 text-xs mt-1">Get 50% off your first month's platform fees</p>
                  </div>
                )}
              </div>

              <button type="submit" disabled={loading} className="w-full mt-6 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-3 rounded-lg transition disabled:opacity-50">
                {loading ? 'Creating...' : 'Create Store'}
              </button>
            </form>
          </div>
        )}

        {/* Has store - show dashboard */}
        {store && (
          <div className="space-y-6">

           {/* MILESTONE CHECKLIST */}
{!progressHidden && (
  <MilestoneChecklist 
    key={`${celebrateMilestone}-${progressHidden}`}
    storeId={store.store_id} 
    walletAddress={walletAddress || ''}
    autoSignEnabled={store.auto_signing_enabled}
    onMilestoneAchieved={(milestone) => setCelebrateMilestone(milestone)}
    onInfoClick={openInfo}
    onDismiss={() => setProgressHidden(true)}
  />
)}

{/* Onboarding Setup Wizard - Below Progress Bar */}
{(walletStatus || !walletAddress) && (
  <OnboardingSetup
    walletAddress={walletAddress}
    walletStatus={walletStatus}
    autoSignEnabled={store?.auto_signing_enabled || customerAutoSignEnabled}
    loginMethod={walletType}
    onSetupComplete={() => { setCustomerAutoSignEnabled(true); setSetupComplete(true); }}
    onRefreshWallet={refreshWalletStatus}
    onSetupStatusChange={(isComplete) => setSetupComplete(isComplete)}
    storagePrefix="vendor"
    onVendorEnableAutoPay={store && walletAddress ? setupAutoSignWeb3Auth : undefined}
  />
)}

            {/* ============================================================= */}
{/* PAYOUT METHOD STATUS */}
{/* ============================================================= */}
<h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">Wallet</h3>
<div className="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
<div id="payout-method" className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-6 flex flex-col">
  <h2 className="text-lg font-bold mb-4">Payout Method</h2>

  {/* Auto-sign enabled (works same for Web3Auth and Crossmark) */}
  {(store.auto_signing_enabled || customerAutoSignEnabled) ? (
    <div className="space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-zinc-800/90 rounded-lg">
        <div className="flex items-center gap-3">
          {walletType === 'web3auth' ? (
            <SocialIcon provider={socialProvider} />
          ) : (
            <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
          )}
          <div>
            <div className="flex items-center gap-2">
              <span className="text-green-500 text-sm" style={{ textShadow: '0 0 8px rgba(34,197,94,0.9)' }}>‚óè</span>
              <span className="text-green-500 text-sm font-medium">Auto-Sign Active</span>
            </div>
            <p className="text-zinc-500 text-sm font-mono">
              {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
            </p>
          </div>
        </div>
        <button
          onClick={revokeAutoSign}
          disabled={loading}
          className="text-zinc-400 hover:text-red-400 text-sm transition-colors whitespace-nowrap"
        >
          Revoke Auto-Sign
        </button>
      </div>

      {/* Editable Limits */}
      <div className="flex gap-4">
        <div className="flex-1 min-w-0">
          <label className="text-zinc-400 text-xs block mb-1">Max single (USD)</label>
          <input
            type="number"
            min="1"
            max="10000"
            value={maxSinglePayout}
            onChange={(e) => {
              setMaxSinglePayout(parseInt(e.target.value) || 100);
              setSettingsSaved(false);
            }}
            className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
          />
        </div>
        <div className="flex-1 min-w-0">
          <label className="text-zinc-400 text-xs block mb-1">Daily limit (USD)</label>
          <input
            type="number"
            min="10"
            max="50000"
            value={dailyLimit}
            onChange={(e) => {
              setDailyLimit(parseInt(e.target.value) || 1000);
              setSettingsSaved(false);
            }}
            className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
          />
        </div>
      </div>
      {/* End of Editable Limits */}

      {/* Feature Badges */}
      <div className="flex flex-wrap gap-3 mt-6 pt-4 border-t border-zinc-800">
        <div className="flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-3 py-2 flex-1 min-w-[100px]">
          <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
          </svg>
          <div>
            <p className="text-emerald-400 text-xs font-semibold">Instant</p>
            <p className="text-zinc-500 text-[10px]">Sub-second payouts</p>
          </div>
        </div>
        <div className="flex items-center gap-2 bg-sky-500/10 border border-sky-500/20 rounded-lg px-3 py-2 flex-1 min-w-[100px]">
          <svg className="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
          </svg>
          <div>
            <p className="text-sky-400 text-xs font-semibold">Secure</p>
            <p className="text-zinc-500 text-[10px]">XRPL validated</p>
          </div>
        </div>
        <div className="flex items-center gap-2 bg-violet-500/10 border border-violet-500/20 rounded-lg px-3 py-2 flex-1 min-w-[100px]">
          <svg className="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <p className="text-violet-400 text-xs font-semibold">24/7</p>
            <p className="text-zinc-500 text-[10px]">Always available</p>
          </div>
        </div>
      </div>
    </div>
  ) : (walletType === 'web3auth' && !customerAutoSignEnabled) ? (
    /* Web3Auth connected but auto-sign not enabled yet */
    <div className="space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
        <div className="flex items-center gap-3">
          <SocialIcon provider={socialProvider} />
          <div>
            <div className="flex items-center gap-2">
              <span className="text-yellow-500 text-sm" style={{ textShadow: '0 0 8px rgba(234,179,8,0.9)' }}>
                ‚óè
              </span>
              <span className="text-yellow-500 text-sm font-medium">Connected - Setup Required</span>
            </div>
            <p className="text-zinc-500 text-sm font-mono">
              {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
            </p>
          </div>
        </div>
      </div>

      <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
        <p className="text-yellow-400 font-medium">Enable Auto-Sign to process payouts</p>
        <p className="text-zinc-400 text-sm">
          Complete the auto-sign setup below to start paying affiliates automatically.
        </p>
      </div>
    </div>
  ) : store.crossmark_connected && !store.auto_signing_enabled ? (
/* Crossmark connected but auto-sign not enabled */
<div className="space-y-4">
  <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-orange-500/10 border border-orange-500/30 rounded-lg">
    <div className="flex items-center gap-3">
      <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
      <div>
        <div className="flex items-center gap-2">
          <span className="text-orange-500 text-sm" style={{ textShadow: '0 0 8px rgba(249,115,22,0.9)' }}>‚óè</span>
          <span className="text-orange-500 text-sm font-medium">Connected - Enable Auto-Sign</span>
        </div>
        <p className="text-zinc-500 text-sm font-mono">
          {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
        </p>
      </div>
    </div>
    <button
      onClick={disconnectWallet}
      disabled={loading}
      className="text-zinc-400 hover:text-red-400 text-sm transition-colors whitespace-nowrap"
    >
      Disconnect
    </button>
  </div>
  <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
    <p className="text-orange-400 font-medium">Enable Auto-Sign to process payouts</p>
    <p className="text-zinc-400 text-sm">
      Scroll down to enable auto-sign for automatic affiliate payouts.
    </p>
    <button 
      onClick={() => scrollToSection('auto-sign')}
      className="mt-2 text-orange-400 hover:text-orange-300 text-sm underline"
    >
      Go to Auto-Sign Setup ‚Üí
    </button>
  </div>
</div>
) : store.xaman_connected ? (
/* Xaman connected - manual payouts */
    <div className="space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
        <div className="flex items-center gap-3">
          <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded" />
          <div>
            <div className="flex items-center gap-2">
              <span className="text-green-500 text-sm" style={{ textShadow: '0 0 8px rgba(34,197,94,0.9)' }}>‚óè</span>
              <span className="text-green-500 text-sm font-medium">Connection Good</span>
            </div>
            <p className="text-zinc-500 text-sm font-mono">
              {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
            </p>
          </div>
        </div>
        <button
          onClick={disconnectWallet}
          disabled={loading}
          className="text-zinc-400 hover:text-red-400 text-sm transition-colors whitespace-nowrap"
        >
          Disconnect
        </button>
      </div>

      <p className="text-zinc-500 text-xs">
        You'll receive a push notification to approve each payout.
      </p>

      {/* Option to switch to auto-sign */}
{false && (
<div className="border-t border-zinc-800 pt-4 mt-4">
  <p className="text-zinc-400 text-sm mb-2">Prefer automatic payouts?</p>
  <p className="text-zinc-500 text-xs">
    Enable auto-sign below to process payouts automatically with Crossmark.
  </p>
</div>
)}
    </div>
  ) : (
    /* No payout method - show options */
    <div className="space-y-4">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-red-500 text-sm" style={{ textShadow: '0 0 8px rgba(239,68,68,0.9)' }}>‚óè</span>
        <span className="text-red-500 text-sm font-medium">No connection</span>
      </div>

      <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
        <p className="text-yellow-400 font-medium">Choose a payout method</p>
        <p className="text-zinc-400 text-sm">Select how you want to pay your affiliates.</p>
      </div>

      {/* Option 1: Social Login (Web3Auth) */}
      <div className="bg-zinc-800/90 border border-zinc-700 hover:border-emerald-500 rounded-xl p-4 transition">
        <div className="flex items-center gap-3 mb-3">
          <div className="flex -space-x-1">
            <div className="w-6 h-6 bg-white rounded-full flex items-center justify-center border border-zinc-600">
              <svg className="w-3 h-3" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
            </div>
            <div className="w-6 h-6 bg-black rounded-full flex items-center justify-center border border-zinc-600">
              <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
              </svg>
            </div>
            <div className="w-6 h-6 bg-zinc-600 rounded-full flex items-center justify-center border border-zinc-500">
              <span className="text-zinc-300 text-[8px] font-bold">+10</span>
            </div>
          </div>
          <div>
            <span className="font-semibold">Social Login</span>
            <span className="ml-2 bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">Easiest</span>
          </div>
        </div>
        <p className="text-zinc-400 text-sm mb-3">
          Get an XRPL wallet instantly. Payouts process automatically 24/7.
        </p>
        <button
          onClick={() => {
            setWeb3authTermsAccepted(true);
            connectGoogle();
          }}
          disabled={connectingGoogle}
          className="w-full bg-white hover:bg-gray-100 text-black font-semibold py-2 rounded-lg transition flex items-center justify-center gap-2"
        >
          {connectingGoogle ? (
            <>
              <span className="w-4 h-4 border-2 border-gray-400 border-t-gray-800 rounded-full animate-spin"></span>
              Connecting...
            </>
          ) : (
            'Connect Social Wallet'
          )}
        </button>
      </div>

      <div className="text-center text-zinc-500 text-sm py-2">‚Äî or ‚Äî</div>

      {/* Option 2: Connect Xaman for manual */}
      <button
        onClick={loginXaman}
        className="w-full bg-zinc-800/90 border border-zinc-700 hover:border-emerald-500 rounded-xl p-4 text-left transition"
      >
        <div className="flex items-center gap-3 mb-2">
          <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded" />
          <span className="font-semibold">Connect Xaman for Manual Payouts</span>
        </div>
        <p className="text-zinc-400 text-sm">
          Approve each payout via push notification on your phone.
        </p>
      </button>

      {/* Option 3: Crossmark - only show if not already connected with Crossmark */}
{walletType !== 'crossmark' && (
<button
onClick={async () => {
          const sdk = (window as any).xrpl?.crossmark;
          if (!sdk) {
            setError('Crossmark wallet not detected.');
            return;
          }
          try {
            const signIn = await sdk.methods.signInAndWait();
            const address = signIn.response?.data?.address;
            if (address) {
  setWalletAddress(address);
  setWalletType('crossmark');
  safeSetItem('vendorWalletAddress', address);
  safeSetItem('vendorLoginMethod', 'crossmark');
  loadOrCreateStore(address, 'crossmark');
}
          } catch (err) {
            console.error('Crossmark error:', err);
          }
        }}
        className="w-full bg-zinc-800/90 border border-zinc-700 hover:border-emerald-500 rounded-xl p-4 text-left transition"
      >
        <div className="flex items-center gap-3 mb-2">
          <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
          <span className="font-semibold">Connect Crossmark</span>
        </div>
        <p className="text-zinc-400 text-sm">
          Browser extension. Enable auto-sign for automatic payouts.
        </p>
</button>
)}
</div>
)}
</div>

{/* ============================================================= */}
{/* WALLET FUNDING (show for Web3Auth wallets that need funding or trustline) */}
{/* ============================================================= */}
{(walletNeedsFunding || walletNeedsTrustline) && walletAddress && (
  <div id="wallet-funding">
  <WalletFunding
  walletAddress={walletAddress}
  walletType={walletType}
  onFunded={() => {
      console.log('Wallet funded!');
      setWalletNeedsFunding(false);
    }}
    onTrustlineSet={() => {
      console.log('Trustline set!');
      setWalletNeedsFunding(false);
      setWalletNeedsTrustline(false);
    }}
  />
  </div>
)}

{/* Show Top-Up and Withdraw components when wallet is ready */}
{(
  <div className="space-y-4">
    {/* TAKE PAYMENT BUTTON */}
    <button
  id="take-payment-btn"
  onClick={() => router.push('/take-payment')}
  className="w-full bg-white hover:bg-zinc-100 text-black font-semibold text-lg py-4 rounded-xl transition flex items-center justify-center gap-3 shadow-lg"
>
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      Take Payment
    </button>

    <CollapsibleSection dashboardType="vendor"
      id="wallet-funding"
      title="Top Up Wallet"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m6-6H6" />
        </svg>
      }
      isOpen={openSections['wallet-funding']}
      onToggle={() => toggleSection('wallet-funding')}
    >
      <TopUpRLUSD
  walletAddress={walletAddress || ''}
  xrpBalance={walletXrpBalance}
  rlusdBalance={walletRlusdBalance}
  showAmounts={showAmounts}
  onToggleAmounts={() => setShowAmounts(!showAmounts)} 
  onRefresh={refreshWalletStatus}
  walletType={walletType}
/>
    </CollapsibleSection>

    <CollapsibleSection dashboardType="vendor"
      id="withdraw"
      title="Balance | Withdraw"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
        </svg>
      }
      isOpen={openSections['withdraw']}
      onToggle={() => toggleSection('withdraw')}
    >
      <WithdrawRLUSD
        walletAddress={walletAddress || ''}
        rlusdBalance={walletRlusdBalance}
        showAmounts={showAmounts}
        onToggleAmounts={() => setShowAmounts(!showAmounts)}
        onRefresh={refreshWalletStatus}
        onSuccess={() => {
          fetch(`${API_URL}/wallet/status/${walletAddress}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                setWalletXrpBalance(data.xrp_balance || 0);
                setWalletRlusdBalance(data.rlusd_balance || 0);
              }
            });
        }}
      />
    </CollapsibleSection>

    {/* QUICK LINKS POS */}
<div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-4">
  <p className="text-zinc-500 text-xs uppercase tracking-wider mb-3">Quick Links</p>
  <div className="grid grid-cols-5 gap-2">
    <button
      onClick={() => router.push('/take-payment')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Payment</span>
    </button>
    <button
      onClick={() => router.push('/analytics')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Analytics</span>
    </button>
    <button
      onClick={() => router.push('/receipts')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Receipts</span>
    </button>
    <button
      onClick={() => window.open(`/display?store=${store.store_id}`, '_blank')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Display</span>
    </button>
    <button
      onClick={() => router.push('/staffpos')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Staff</span>
    </button>
  </div>
</div>
  </div>
)}
</div>

            {/* ============================================================= */}
{/* AUTO-SIGN SETUP (show if auto-sign not enabled yet - NOT for Xaman) */}
{/* ============================================================= */}
{!store.auto_signing_enabled && walletType !== 'xaman' && (
  <div id="auto-sign" className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-6">
    <h2 className="text-lg font-bold mb-4">Enable Auto-Sign</h2>
                <p className="text-zinc-400 text-sm mb-4">
                  Process affiliate payouts automatically without manual approval for each transaction.
                </p>

                {/* Security Notice */}
                <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4 mb-4">
                  <p className="text-orange-400 text-sm font-bold mb-2">‚ö†Ô∏è Security Notice</p>
                  <p className="text-orange-300/90 text-sm mb-3">
                    Auto-sign allows YesAllofUs to sign RLUSD transactions from your wallet
                    automatically, without requiring manual approval for each payout.
                  </p>
                  <p className="text-orange-300/80 text-sm mb-3">
                    While we take every precaution to secure our systems, there is always inherent risk
                    when granting signing permissions. We recommend:
                  </p>
                  <ul className="text-orange-300/80 text-xs space-y-1">
                    <li>‚Ä¢ Keep only 1-2 days worth of expected commissions in this wallet</li>
                    <li>‚Ä¢ Set a conservative daily limit below</li>
                    <li>‚Ä¢ Top up regularly rather than storing large balances</li>
                  </ul>
                </div>

                {/* Limits */}
                <div className="flex gap-4 mb-4">
                  <div className="flex-1 min-w-0">
                    <label className="text-zinc-400 text-xs block mb-1">Max single (USD)</label>
                    <input
                      type="number"
                      min="1"
                      max="10000"
                      value={maxSinglePayout}
                      onChange={(e) => setMaxSinglePayout(parseInt(e.target.value) || 100)}
                      className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
                    />
                  </div>
                  <div className="flex-1 min-w-0">
                    <label className="text-zinc-400 text-xs block mb-1">Daily limit (USD)</label>
                    <input
                      type="number"
                      min="10"
                      max="50000"
                      value={dailyLimit}
                      onChange={(e) => setDailyLimit(parseInt(e.target.value) || 1000)}
                      className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
                    />
                  </div>
                </div>

                {/* Terms Checkbox */}
                <label className="flex items-start gap-3 p-3 bg-zinc-800/90 rounded-lg cursor-pointer mb-4">
                  <input
                    type="checkbox"
                    checked={autoSignTermsAccepted}
                    onChange={(e) => setAutoSignTermsAccepted(e.target.checked)}
                    className="mt-1"
                  />
                  <span className="text-zinc-300 text-sm">
                    I have read and agree to the{' '}
                    <a href="/terms" target="_blank" className="text-blue-400 hover:underline">Terms & Conditions</a>{' '}
                    for auto-signing.
                  </span>
                </label>

                {/* Setup Button - Web3Auth */}
{walletType === 'web3auth' ? (
  <button
    onClick={setupAutoSignWeb3Auth}
    disabled={!autoSignTermsAccepted || settingUpAutoSign}
    className={`w-full py-3 rounded-lg font-semibold transition ${
      autoSignTermsAccepted
        ? 'bg-blue-500 hover:bg-blue-400 text-white'
        : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
    }`}
  >
    {settingUpAutoSign ? (
  <span className="flex items-center justify-center gap-2">
    <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
    {setupProgress || 'Setting up...'}
  </span>
) : (
      'üîê Sign to Enable Auto-Sign'
    )}
  </button>
) : (
                  <button
                    onClick={setupAutoSign}
                    disabled={!autoSignTermsAccepted || settingUpAutoSign}
                    className={`w-full py-3 rounded-lg font-semibold transition ${
                      autoSignTermsAccepted
                        ? 'bg-blue-500 hover:bg-blue-400 text-white'
                        : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
                    }`}
                  >
                    {settingUpAutoSign ? (
                      <span className="flex items-center justify-center gap-2">
                        <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                        Setting up...
                      </span>
                    ) : (
                      'üîê Sign with Crossmark to Enable Auto-Sign'
                    )}
                  </button>
                )}
              </div>
            )}

{/* CUSTOMERS - SIGN UP + PENDING */}
<h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">Customers</h3>
<div className="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
  {/* SIGN UP CUSTOMER BUTTON */}
  <SignUpCustomerCard storeId={store.store_id} walletAddress={walletAddress} onSignUp={async () => {
    try {
      await fetch(`${API_URL}/display/${store.store_id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'signup' })
      });
    } catch (err) {
      console.error('Failed to set display status:', err);
    }
    router.push(`/signup-customer?store=${store.store_id}`);
  }} />

  {/* PENDING CUSTOMERS */}
  <div id="pending-customers">
    <PendingCustomers storeId={store.store_id} walletAddress={walletAddress} />
  </div>
</div>

{/* EARN INTEREST */}
<div id="earn-interest">
  <EarnInterest dashboardType="vendor" />
</div>

{/* ============================================================= */}
{/* SETTINGS GROUP */}
{/* ============================================================= */}
<div className="space-y-4">
  <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider px-1">Settings</h3>
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <CollapsibleSection dashboardType="vendor"
      id="commission-rates"
      title="Commission Rates"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
        </svg>
      }
      isOpen={openSections['commission-rates']}
      onToggle={() => toggleSection('commission-rates')}
    >
      <p className="text-zinc-500 text-sm mb-6">Set the percentage affiliates earn on each level.</p>
      <div className="space-y-4">
        {[
          { level: 1, label: 'Direct referral', bgColor: 'bg-emerald-500/20', textColor: 'text-emerald-400', borderColor: 'border-emerald-500/30' },
          { level: 2, label: 'Level 2', bgColor: 'bg-blue-500/20', textColor: 'text-blue-400', borderColor: 'border-blue-500/30' },
          { level: 3, label: 'Level 3', bgColor: 'bg-purple-500/20', textColor: 'text-purple-400', borderColor: 'border-purple-500/30' },
          { level: 4, label: 'Level 4', bgColor: 'bg-orange-500/20', textColor: 'text-orange-400', borderColor: 'border-orange-500/30' },
          { level: 5, label: 'Level 5', bgColor: 'bg-pink-500/20', textColor: 'text-pink-400', borderColor: 'border-pink-500/30' }
        ].map((tier, i) => (
          <div key={tier.level} className="flex items-center gap-4">
            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${tier.bgColor} ${tier.borderColor} border`}>
              <svg className={`w-6 h-6 ${tier.textColor}`} viewBox="0 0 24 24" fill="none" stroke="currentColor">
                {tier.level === 1 && (
                  <>
                    <circle cx="12" cy="8" r="4" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2" />
                  </>
                )}
                {tier.level === 2 && (
                  <>
                    <circle cx="9" cy="7" r="3" strokeWidth={1.5} />
                    <circle cx="15" cy="7" r="3" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 21v-1a4 4 0 014-4h2m12 5v-1a4 4 0 00-4-4h-2" />
                  </>
                )}
                {tier.level === 3 && (
                  <>
                    <circle cx="12" cy="5" r="2.5" strokeWidth={1.5} />
                    <circle cx="6" cy="10" r="2.5" strokeWidth={1.5} />
                    <circle cx="18" cy="10" r="2.5" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 10v4m-6 0v4m12-4v4" />
                  </>
                )}
                {tier.level === 4 && (
                  <>
                    <circle cx="6" cy="6" r="2.5" strokeWidth={1.5} />
                    <circle cx="18" cy="6" r="2.5" strokeWidth={1.5} />
                    <circle cx="6" cy="14" r="2.5" strokeWidth={1.5} />
                    <circle cx="18" cy="14" r="2.5" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M6 8.5v3m12-3v3M8.5 6h7M8.5 14h7" />
                  </>
                )}
                {tier.level === 5 && (
                  <>
                    <circle cx="12" cy="4" r="2" strokeWidth={1.5} />
                    <circle cx="5" cy="9" r="2" strokeWidth={1.5} />
                    <circle cx="19" cy="9" r="2" strokeWidth={1.5} />
                    <circle cx="7" cy="17" r="2" strokeWidth={1.5} />
                    <circle cx="17" cy="17" r="2" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6v2m-5.5 2.5l2 3m7-3l-2 3" />
                  </>
                )}
              </svg>
            </div>
            <span className="text-zinc-400 text-sm w-28">{tier.label}</span>
            <input
              type="number"
              min="0"
              max="100"
              value={commissionRates[i]}
              onChange={(e) => {
                const newRates = [...commissionRates];
                newRates[i] = Math.max(0, Math.min(100, parseInt(e.target.value) || 0));
                setCommissionRates(newRates);
                setSettingsSaved(false);
              }}
              className="w-20 bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white text-center"
            />
            <span className="text-zinc-500">%</span>
          </div>
        ))}
      </div>
      <div className="flex items-center justify-between mt-6 pt-4 border-t border-zinc-800">
        <div className="text-sm">
          <span className="text-zinc-500">Total: </span>
          <span className={commissionRates.reduce((a, b) => a + b, 0) > 100 ? 'text-red-400' : 'text-white'}>
            {commissionRates.reduce((a, b) => a + b, 0)}%
          </span>
          {commissionRates.reduce((a, b) => a + b, 0) > 100 && (
            <span className="text-red-400 text-xs ml-2">Cannot exceed 100%</span>
          )}
        </div>
      </div>
      {!settingsSaved && (
        <button
          onClick={saveSettings}
          disabled={savingSettings || commissionRates.reduce((a, b) => a + b, 0) > 100}
          className="w-full mt-4 bg-emerald-500 hover:bg-emerald-400 disabled:opacity-50 text-black font-semibold py-3 rounded-xl transition"
        >
          {savingSettings ? 'Saving...' : 'Save Settings'}
        </button>
      )}
    </CollapsibleSection>

    <CollapsibleSection dashboardType="vendor"
      id="quick-links"
      title="Quick Links"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
        </svg>
      }
      isOpen={openSections['quick-links']}
      onToggle={() => toggleSection('quick-links')}
    >
      <div className="grid grid-cols-2 gap-4">
        <a href="/docs" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-sky-400 group-hover:text-sky-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
            </svg>
          </div>
          <p className="text-sm font-medium">Documentation</p>
        </a>
        <a href="/terms" target="_blank" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-amber-400 group-hover:text-amber-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
          </div>
          <p className="text-sm font-medium">Terms</p>
        </a>
        <a href={`/affiliate-dashboard?store=${store.store_id}`} target="_blank" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-emerald-400 group-hover:text-emerald-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
            </svg>
          </div>
          <p className="text-sm font-medium">Affiliate Dashboard</p>
        </a>
        <a href="https://github.com/TokenCanvasIO/YesAllofUs-wordpress/releases/download/v1.0.2/yesallofus.zip" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-violet-400 group-hover:text-violet-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 7.5l-2.25-1.313M21 7.5v2.25m0-2.25l-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m9 3l2.25-1.313M12 12.75l-2.25-1.313M12 12.75V15m0 6.75l2.25-1.313M12 21.75V19.5m0 2.25l-2.25-1.313m0-16.875L12 2.25l2.25 1.313M21 14.25v2.25l-2.25 1.313m-13.5 0L3 16.5v-2.25" />
            </svg>
          </div>
          <p className="text-sm font-medium">WordPress Plugin</p>
        </a>
      </div>
    </CollapsibleSection>
  </div>
</div>

{/* ============================================================= */}
{/* MARKETING GROUP */}
{/* ============================================================= */}
<div className="space-y-4">
  <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider px-1">Marketing</h3>
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <CollapsibleSection dashboardType="vendor"
      id="affiliate-link"
      title="Affiliate Link"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
        </svg>
      }
      isOpen={openSections['affiliate-link']}
      onToggle={() => toggleSection('affiliate-link')}
    >
      <p className="text-zinc-500 text-sm mb-4">Share this link or add it to your website.</p>
      <div className="flex flex-col gap-2">
        <code className="bg-zinc-800/90 px-4 py-3 rounded-lg font-mono text-sm text-emerald-400 overflow-x-auto">
          {`https://yesallofus.com/affiliate-dashboard?store=${store.store_id}`}
        </code>
        <div className="flex gap-2">
          <button
            onClick={() => copyToClipboard(`https://yesallofus.com/affiliate-dashboard?store=${store.store_id}`, 'affiliate_link')}
            className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition"
          >
            {copied === 'affiliate_link' ? '‚úì Copied' : 'Copy'}
          </button>
          <button
            onClick={() => setShowQRModal(true)}
            className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition"
          >
            QR Code
          </button>
        </div>
      </div>
    </CollapsibleSection>

    {store && walletAddress && (
      <CollapsibleSection dashboardType="vendor"
        id="activity"
        title="Activity"
        icon={
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
          </svg>
        }
        isOpen={openSections['activity']}
        onToggle={() => toggleSection('activity')}
      >
        <StoreActivity storeId={store.store_id} walletAddress={walletAddress} showAmounts={showAmounts} />
      </CollapsibleSection>
    )}
  </div>
</div>

{/* ============================================================= */}
{/* DEVELOPER & ACCOUNT GROUP - 2 COLUMN */}
{/* ============================================================= */}
<div className="space-y-4">
  <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider px-1">Developer & Account</h3>
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
    {/* API Credentials */}
    <CollapsibleSection dashboardType="vendor"
      id="api-credentials"
      title="API Credentials"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
        </svg>
      }
      isOpen={openSections['api-credentials']}
      onToggle={() => toggleSection('api-credentials')}
    >
      <div className="mb-4">
        <label className="text-zinc-500 text-sm block mb-1">Store ID</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm">{store.store_id}</code>
          <button onClick={() => copyToClipboard(store.store_id, 'store_id')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'store_id' ? '‚úì' : 'Copy'}
          </button>
        </div>
      </div>
      <div className="mb-4">
        <label className="text-zinc-500 text-sm block mb-1">API Key</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm">{store.api_key}</code>
          <button onClick={() => copyToClipboard(store.api_key, 'api_key')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'api_key' ? '‚úì' : 'Copy'}
          </button>
        </div>
      </div>
      <div className="mb-4">
        <label className="text-zinc-500 text-sm block mb-1">API Secret</label>
        {newSecret && !secretSaved ? (
          <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
            <div className="flex items-center gap-2 mb-3">
              <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm tracking-wider">
                ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
              </code>
              <button
                onClick={() => { copyToClipboard(newSecret, 'secret'); setSecretRevealed(true); }}
                className="bg-emerald-500 hover:bg-emerald-400 text-black px-3 py-2 rounded-lg text-xs sm:text-sm font-semibold transition whitespace-nowrap"
              >
                {copied === 'secret' ? '‚úì' : 'Copy'}
              </button>
            </div>
            <div className="bg-yellow-500/20 rounded-lg p-3 mb-3">
              <p className="text-yellow-200 text-sm font-semibold mb-1">‚ö†Ô∏è SAVE THIS NOW</p>
              <p className="text-yellow-200/80 text-sm">This secret will disappear when you leave this page.</p>
            </div>
            {secretRevealed && (
              <button onClick={() => setSecretSaved(true)} className="w-full bg-zinc-800/90 hover:bg-zinc-700 py-2 rounded-lg text-sm transition">
                ‚úì I've saved my secret
              </button>
            )}
          </div>
        ) : (
          <div className="bg-zinc-800/90 rounded-xl p-4">
            <p className="text-zinc-400 text-sm mb-3">Your secret is not stored for security.</p>
            <button onClick={regenerateSecret} disabled={loading} className="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded-lg text-sm transition disabled:opacity-50">
              {loading ? 'Generating...' : 'Generate New Secret'}
            </button>
          </div>
        )}
      </div>
      <div>
        <label className="text-zinc-500 text-sm block mb-1">Your Store Referral Code</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm">{store.store_referral_code}</code>
          <button onClick={() => copyToClipboard(store.store_referral_code, 'referral')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'referral' ? '‚úì' : 'Copy'}
          </button>
        </div>
        <p className="text-zinc-500 text-xs mt-2">Share with other vendors to earn from their platform fees.</p>
        <p className="text-zinc-600 text-xs mt-1">Earn 25% L1 ¬∑ 5% L2 ¬∑ 3% L3 ¬∑ 2% L4 ¬∑ 1% L5 of their fees, paid instantly in RLUSD.</p>
      </div>
      <div className="mt-4 pt-4 border-t border-zinc-700">
        <label className="text-zinc-500 text-sm block mb-1">Your Partners Referral Link</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm text-blue-400 overflow-x-auto">{`https://yesallofus.com/dashboard?ref=${store.store_referral_code}`}</code>
          <button onClick={() => copyToClipboard(`https://yesallofus.com/dashboard?ref=${store.store_referral_code}`, 'referral_link')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'referral_link' ? '‚úì' : 'Copy'}
          </button>
        </div>
        <p className="text-zinc-500 text-xs mt-2">Share this link - new vendors get 50% off their first month!</p>
      </div>
    </CollapsibleSection>

    {/* Danger Zone */}
    <CollapsibleSection dashboardType="vendor"
      id="danger-zone"
      title="Danger Zone"
      icon={
        <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
      }
      isOpen={openSections['danger-zone']}
      onToggle={() => toggleSection('danger-zone')}
    >
      <p className="text-zinc-400 text-sm mb-4">
        Permanently delete your account and all associated data. This action cannot be undone.
      </p>
      <button
        onClick={() => setShowDeleteModal(true)}
        disabled={loading}
        className="bg-zinc-900/95 border-2 border-red-500 text-red-400 hover:bg-red-500 hover:text-white px-6 py-2 rounded-lg font-semibold transition disabled:opacity-50 flex items-center gap-2"
      >
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
        Permanently Delete
      </button>
    </CollapsibleSection>
  </div>
</div>

{/* ============================================================= */}
{/* RETURN TO WORDPRESS */}
{/* ============================================================= */}
{store?.platform_return_url && (
  <div
    id="return-wordpress"
    className={`${
      !walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled)
        ? 'bg-emerald-500/10 border-emerald-500/30'
        : 'bg-yellow-500/10 border-yellow-500/30'
    } border rounded-xl p-6`}
  >
    <div className="flex items-center gap-2 mb-2">
      {!walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled) ? (
        <svg className="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      ) : (
        <svg className="w-6 h-6 text-yellow-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={{ animationDuration: '3s' }}>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      )}
      <h2 className="text-lg font-bold">
        {!walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled)
          ? 'Setup Complete!'
          : 'Setup In Progress'}
      </h2>
    </div>
    <p className="text-zinc-400 text-sm mb-4">
      {walletNeedsFunding
        ? 'Step 1: Fund your wallet with at least 1.5 XRP to continue.'
        : walletNeedsTrustline
          ? 'Step 2: Add the RLUSD trustline to receive payments.'
          : walletType === 'web3auth' && !store.auto_signing_enabled
            ? 'Step 3: Enable auto-sign to process payouts automatically.'
            : 'Your wallet is ready to receive affiliate commissions.'}
    </p>
    <a
      href="#"
      onClick={async (e) => {
        e.preventDefault();
        const targetUrl = store.platform_return_url;
        try {
          const tokenRes = await fetch(`${API_URL}/store/generate-claim-token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              store_id: store.store_id,
              wallet_address: walletAddress,
            }),
          });
          const tokenData = await tokenRes.json();
          if (!tokenData.success || !tokenData.claim_token) {
            throw new Error('Failed to generate token');
          }
          await fetch(`${API_URL}/store/clear-platform-return`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              store_id: store.store_id,
              wallet_address: walletAddress,
            }),
          });
          safeRemoveItem('wordpress_return');
          const separator = targetUrl.includes('?') ? '&' : '?';
          window.location.href = `${targetUrl}${separator}claim_token=${tokenData.claim_token}`;
        } catch (err) {
          console.error('Failed to generate claim token:', err);
          alert('Failed to return to WordPress. Please try again.');
        }
      }}
      className={`inline-block ${
        !walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled)
          ? 'bg-emerald-500 hover:bg-emerald-400'
          : 'bg-yellow-500 hover:bg-yellow-400'
      } text-black font-semibold px-6 py-3 rounded-lg transition mt-4`}
    >
      Return to {store.platform_type === 'wordpress' ? 'WordPress' : 'Your Site'}
    </a>
  </div>
)}
</div>
)}
     </div>
      </main>
    </div>
    <QRCodeModal
  isOpen={showQRModal}
  onClose={() => setShowQRModal(false)}
  url={`https://yesallofus.com/affiliate-dashboard?store=${store?.store_id}`}
  title="Share Affiliate Link"
  subtitle={store?.store_name}
/>
{/* Delete Store Modal */}
<DeleteConfirmModal
  isOpen={showDeleteModal}
  onClose={() => setShowDeleteModal(false)}
  onConfirm={deleteStore}
  title="Delete Store"
  description="This will permanently delete your store, all affiliates, and all payout history. This action cannot be undone."
  confirmText="PERMANENTLY DELETE"
  loading={deleting}
/>
{/* Disconnect Wallet Modal */}
{showDisconnectModal && (
  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-6 max-w-sm w-full">
      <h3 className="text-lg font-bold mb-2">Disconnect Wallet</h3>
      <p className="text-zinc-400 text-sm mb-6">
        Disconnect your wallet? You will need to reconnect to process payouts.
      </p>
      <div className="flex gap-3">
        <button
          onClick={() => setShowDisconnectModal(false)}
          className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 text-white py-3 rounded-lg font-medium transition"
        >
          Cancel
        </button>
        <button
          onClick={() => {
            setShowDisconnectModal(false);
            disconnectWallet();
          }}
          className="flex-1 bg-red-500 hover:bg-red-400 text-white py-3 rounded-lg font-medium transition"
        >
          Disconnect
        </button>
      </div>
    </div>
  </div>
)}
    </>
    
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/discover-vendors/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useRef, useState } from 'react';


// MARK: - Component Definition
export default function DiscoverVendors() {

// MARK: - State Management
  const [activeSection, setActiveSection] = useState(0);
  const containerRef = useRef<HTMLDivElement>(null);

  const sections = [
    'Intro',
    'How It Works',
    'Find Vendors',
    'Instant Payouts',
    'On-Chain Reputation',
    'Global Access',
    'Earning Potential',
    'Multi-Level',
    'Get Started'
  ];


// MARK: - Hooks & Effects
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    const sectionElements = container.querySelectorAll('.scroll-section');
    
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const index = Array.from(sectionElements).indexOf(entry.target as Element);
            setActiveSection(index);
          }
        });
      },
      { threshold: 0.5 }
    );

    sectionElements.forEach((section) => observer.observe(section));
    return () => observer.disconnect();
  }, []);


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">
      {/* Progress Indicator */}
      <div className="fixed right-6 top-1/2 -translate-y-1/2 z-40 hidden lg:flex flex-col gap-2">
        {sections.map((label, i) => (
          <button
            key={i}

// MARK: - Event Handlers
            onClick={() => {
              const sectionElements = document.querySelectorAll('.scroll-section');
              sectionElements[i]?.scrollIntoView({ behavior: 'smooth' });
            }}
            className={`group flex items-center gap-3 transition-all ${
              activeSection === i ? 'opacity-100' : 'opacity-30 hover:opacity-60'
            }`}
          >
            <span className={`text-[10px] font-medium transition-all whitespace-nowrap ${
              activeSection === i ? 'text-emerald-400 translate-x-0 opacity-100' : 'text-zinc-500 translate-x-2 opacity-0 group-hover:opacity-100 group-hover:translate-x-0'
            }`}>
              {label}
            </span>
            <div className={`w-2 h-2 rounded-full transition-all ${
              activeSection === i ? 'bg-emerald-400 scale-125' : 'bg-zinc-700'
            }`} />
          </button>
        ))}
      </div>

      <div ref={containerRef}>
        
        {/* ==================== SECTION 0: HERO ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 pt-20">
          <div className="max-w-4xl mx-auto text-center">
            <div className="inline-flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/30 rounded-full px-4 py-1.5 mb-8">
              <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
              <span className="text-emerald-400 text-sm font-medium">For Affiliates</span>
            </div>
            
            <h1 className="text-5xl md:text-7xl font-bold mb-8 leading-[1.1]">
              Discover Vendors.<br />
              <span className="text-emerald-400">Earn Passive Income Instantly.</span>
            </h1>
            
            <p className="text-xl text-zinc-400 max-w-2xl mx-auto mb-12">
              Find products you believe in. Share your link. Get paid in 4 seconds ‚Äî not 30 days. 
              No minimums. No bank account needed.
            </p>

            <div className="flex flex-col sm:flex-row gap-4 justify-center mb-16">
              <a 
                href="/affiliate-dashboard"
                className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-8 py-4 rounded-xl transition text-lg"
              >
                Start Earning ‚Üí
              </a>
              <a 
                href="#how-it-works"
                onClick={(e) => {
                  e.preventDefault();
                  document.querySelectorAll('.scroll-section')[1]?.scrollIntoView({ behavior: 'smooth' });
                }}
                className="border border-zinc-700 hover:border-zinc-500 px-8 py-4 rounded-xl transition text-lg"
              >
                How It Works
              </a>
            </div>

            <div className="animate-bounce">
              <svg className="w-6 h-6 mx-auto text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
              </svg>
              <p className="text-zinc-600 text-sm mt-2">Scroll to explore</p>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 1: HOW IT WORKS ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-emerald-950/5 to-[#0a0a0a]">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-16">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                Four Steps to <span className="text-emerald-400">Passive Income</span>
              </h2>
              <p className="text-zinc-400 text-lg">No experience needed. We handle wallet setup for you.</p>
            </div>

            <div className="grid md:grid-cols-4 gap-6">
              {[
                { 
                  num: '1', 
                  icon: 'üë§',
                  title: 'Sign Up', 
                  desc: 'Connect with Google, Apple, or any social account. We create your wallet automatically.' 
                },
                { 
                  num: '2', 
                  icon: 'üîç',
                  title: 'Browse Vendors', 
                  desc: 'Explore the vendor directory in your dashboard. Find products that match your audience.' 
                },
                { 
                  num: '3', 
                  icon: 'üîó',
                  title: 'Share Your Link', 
                  desc: 'Get your unique referral link. Share on social, email, or anywhere your audience lives.' 
                },
                { 
                  num: '4', 
                  icon: 'üí∞',
                  title: 'Get Paid Instantly', 
                  desc: 'When someone buys, you get paid in 4 seconds. RLUSD lands in your wallet automatically.' 
                },
              ].map((step, i) => (
                <div key={i} className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-6 text-center relative">
                  <div className="text-4xl mb-4">{step.icon}</div>
                  <div className="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 text-black font-bold text-sm">
                    {step.num}
                  </div>
                  <h3 className="font-semibold text-lg mb-2">{step.title}</h3>
                  <p className="text-zinc-500 text-sm">{step.desc}</p>
                  
                  {i < 3 && (
                    <div className="hidden md:block absolute top-1/2 -right-3 transform -translate-y-1/2 text-zinc-700 text-2xl">
                      ‚Üí
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* ==================== SECTION 2: FIND VENDORS ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                Find Vendors in Your <span className="text-emerald-400">Dashboard</span>
              </h2>
              <p className="text-zinc-400 text-lg">Browse, filter, and connect with vendors looking for affiliates</p>
            </div>

            <div className="grid md:grid-cols-2 gap-8 items-center">
              {/* Left: Instructions */}
              <div className="space-y-6">
                {[
                  { 
                    step: '1',
                    title: 'Go to Affiliate Dashboard', 
                    desc: 'Sign in and click "Discover Vendors" in the sidebar navigation.' 
                  },
                  { 
                    step: '2',
                    title: 'Browse the Directory', 
                    desc: 'See all vendors with their commission rates, products, and payout history.' 
                  },
                  { 
                    step: '3',
                    title: 'Click to Join', 
                    desc: 'Found a vendor you like? One click to get your referral link. No approval wait.' 
                  },
                  { 
                    step: '4',
                    title: 'Start Promoting', 
                    desc: 'Copy your link and share. Track clicks and earnings in real-time.' 
                  },
                ].map((item, i) => (
                  <div key={i} className="flex gap-4">
                    <div className="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-emerald-400 font-bold text-sm">
                      {item.step}
                    </div>
                    <div>
                      <h3 className="font-semibold mb-1">{item.title}</h3>
                      <p className="text-zinc-500 text-sm">{item.desc}</p>
                    </div>
                  </div>
                ))}
              </div>

              {/* Right: Mock Dashboard Preview */}
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-6">
                <div className="flex items-center gap-2 mb-4 pb-4 border-b border-zinc-800">
                  <div className="w-3 h-3 rounded-full bg-red-500/50" />
                  <div className="w-3 h-3 rounded-full bg-yellow-500/50" />
                  <div className="w-3 h-3 rounded-full bg-green-500/50" />
                  <span className="text-zinc-600 text-xs ml-2">Affiliate Dashboard</span>
                </div>
                
                <div className="space-y-3">
                  {[
                    { name: 'TechGadgets Pro', rate: '15%', products: '24 products' },
                    { name: 'Fitness First', rate: '20%', products: '12 products' },
                    { name: 'Digital Courses', rate: '30%', products: '8 products' },
                  ].map((vendor, i) => (
                    <div key={i} className="flex items-center justify-between bg-zinc-800/50 rounded-lg p-3">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center text-emerald-400 font-bold">
                          {vendor.name[0]}
                        </div>
                        <div>
                          <p className="font-medium text-sm">{vendor.name}</p>
                          <p className="text-zinc-500 text-xs">{vendor.products}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-emerald-400 font-semibold">{vendor.rate}</p>
                        <p className="text-zinc-600 text-xs">commission</p>
                      </div>
                    </div>
                  ))}
                </div>
                
                <div className="mt-4 pt-4 border-t border-zinc-800 text-center">
                  <p className="text-zinc-600 text-xs">Click any vendor to get your link instantly</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 3: INSTANT PAYOUTS ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-emerald-950/10 to-[#0a0a0a]">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                <span className="text-emerald-400">4 Seconds</span> vs 30 Days
              </h2>
              <p className="text-zinc-400 text-lg">The moment someone buys, you get paid. Not next month. Now.</p>
            </div>

            <div className="grid md:grid-cols-2 gap-8">
              {/* Traditional */}
              <div className="bg-red-500/5 border border-red-500/20 rounded-2xl p-8">
                <div className="flex items-center gap-3 mb-6">
                  <span className="text-2xl">üêå</span>
                  <h3 className="font-bold text-xl text-red-400">Traditional Affiliates</h3>
                </div>
                <div className="space-y-4">
                  {[
                    { time: 'Day 1', event: 'You make a sale' },
                    { time: 'Day 7', event: 'Still waiting...' },
                    { time: 'Day 30', event: 'Refund period ends' },
                    { time: 'Day 45', event: 'Payment "processed"' },
                    { time: 'Day 48', event: 'Maybe you get paid' },
                  ].map((item, i) => (
                    <div key={i} className="flex justify-between text-sm border-b border-red-500/10 pb-2 last:border-0">
                      <span className="text-zinc-500">{item.time}</span>
                      <span className="text-zinc-400">{item.event}</span>
                    </div>
                  ))}
                </div>
                <div className="mt-6 pt-4 border-t border-red-500/20">
                  <p className="text-red-400 font-semibold">+ $25 minimum threshold</p>
                  <p className="text-red-400 font-semibold">+ PayPal fees eat your earnings</p>
                </div>
              </div>

              {/* YesAllofUs */}
              <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-2xl p-8">
                <div className="flex items-center gap-3 mb-6">
                  <span className="text-2xl">‚ö°</span>
                  <h3 className="font-bold text-xl text-emerald-400">YesAllofUs</h3>
                </div>
                <div className="space-y-4">
                  {[
                    { time: 'Second 0', event: 'Customer clicks buy' },
                    { time: 'Second 2', event: 'Payment confirmed' },
                    { time: 'Second 4', event: 'RLUSD in your wallet', highlight: true },
                  ].map((item, i) => (
                    <div key={i} className="flex justify-between text-sm border-b border-emerald-500/10 pb-2 last:border-0">
                      <span className="text-zinc-500">{item.time}</span>
                      <span className={item.highlight ? 'text-emerald-400 font-semibold' : 'text-zinc-400'}>{item.event}</span>
                    </div>
                  ))}
                  <div className="h-12" />
                  <div className="h-8" />
                </div>
                <div className="mt-6 pt-4 border-t border-emerald-500/20">
                  <p className="text-emerald-400 font-semibold">‚úì No minimum threshold</p>
                  <p className="text-emerald-400 font-semibold">‚úì $0.0002 transaction fee</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 4: ON-CHAIN REPUTATION ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-4xl mx-auto text-center">
            <div className="inline-flex items-center gap-2 bg-purple-500/10 border border-purple-500/30 rounded-full px-4 py-1.5 mb-8">
              <span className="text-purple-400 text-sm font-medium">üîÆ Coming Soon</span>
            </div>
            
            <h2 className="text-3xl md:text-5xl font-bold mb-6">
              Vendor Reputation<br />
              <span className="text-emerald-400">Proven by Math</span>
            </h2>
            
            <p className="text-xl text-zinc-400 max-w-2xl mx-auto mb-12">
              No more fake reviews. No more paid placements. Trust vendors based on their actual on-chain behavior.
            </p>

            <div className="grid md:grid-cols-3 gap-6 mb-12">
              {[
                { 
                  icon: '‚è±Ô∏è',
                  title: 'Payout Speed', 
                  desc: 'Average time from sale to affiliate payout. Verified on XRPL.',
                  metric: '~4 seconds'
                },
                { 
                  icon: 'üìä',
                  title: 'Consistency', 
                  desc: 'How reliable are their payouts? Calculated from transaction history.',
                  metric: '99.8%'
                },
                { 
                  icon: 'üíé',
                  title: 'Volume', 
                  desc: 'Total commissions paid to affiliates. Immutable, public record.',
                  metric: '$50,000+'
                },
              ].map((item, i) => (
                <div key={i} className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-6">
                  <div className="text-3xl mb-4">{item.icon}</div>
                  <h3 className="font-semibold text-lg mb-2">{item.title}</h3>
                  <p className="text-zinc-500 text-sm mb-4">{item.desc}</p>
                  <p className="text-emerald-400 font-bold">{item.metric}</p>
                </div>
              ))}
            </div>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-8 max-w-2xl mx-auto">
              <div className="flex items-start gap-4 text-left">
                <span className="text-3xl">üõ°Ô∏è</span>
                <div>
                  <h4 className="font-bold mb-2">Why This Matters</h4>
                  <p className="text-zinc-400 text-sm">
                    Traditional affiliate networks let vendors buy rankings and fake reviews. 
                    With YesAllofUs, every payout is recorded on the XRP Ledger. Reputation is calculated from 
                    <strong className="text-white"> real transactions</strong>, not marketing budgets.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 5: GLOBAL ACCESS ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-blue-950/5 to-[#0a0a0a]">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                Earn From <span className="text-emerald-400">Anywhere</span>
              </h2>
              <p className="text-zinc-400 text-lg">No bank account. No borders. Just a wallet and a phone.</p>
            </div>

            <div className="grid md:grid-cols-2 gap-8 items-center">
              {/* Left: World Map Concept */}
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-8">
                <h3 className="font-bold text-lg mb-6 text-center">Same Speed. Everywhere.</h3>
                <div className="space-y-4">
                  {[
                    { city: 'London', flag: 'üá¨üáß' },
                    { city: 'Lagos', flag: 'üá≥üá¨' },
                    { city: 'Manila', flag: 'üáµüá≠' },
                    { city: 'S√£o Paulo', flag: 'üáßüá∑' },
                    { city: 'Mumbai', flag: 'üáÆüá≥' },
                  ].map((loc, i) => (
                    <div key={i} className="flex justify-between items-center">
                      <div className="flex items-center gap-3">
                        <span className="text-xl">{loc.flag}</span>
                        <span className="text-zinc-300">{loc.city}</span>
                      </div>
                      <span className="text-emerald-400 font-semibold">4 seconds</span>
                    </div>
                  ))}
                </div>
                <div className="border-t border-zinc-800 mt-6 pt-6 text-center">
                  <p className="text-zinc-500 text-sm">Paid in RLUSD. $1 = $1. No volatility.</p>
                </div>
              </div>

              {/* Right: Benefits */}
              <div className="space-y-6">
                {[
                  { 
                    icon: 'üè¶',
                    title: 'No Bank Account Needed', 
                    desc: 'Traditional affiliates need PayPal or bank transfers. You just need a wallet ‚Äî we create one for you.' 
                  },
                  { 
                    icon: 'üíµ',
                    title: 'RLUSD Stablecoin', 
                    desc: 'Get paid in dollars that stay dollars. No crypto volatility. Cash out anytime.' 
                  },
                  { 
                    icon: 'üåç',
                    title: 'Zero International Fees', 
                    desc: 'Traditional cross-border payments cost $25-50. XRPL costs $0.0002. Same speed worldwide.' 
                  },
                  { 
                    icon: 'üì±',
                    title: 'Mobile First', 
                    desc: 'Manage everything from your phone. Track earnings, find vendors, withdraw funds.' 
                  },
                ].map((item, i) => (
                  <div key={i} className="flex gap-4">
                    <div className="text-2xl">{item.icon}</div>
                    <div>
                      <h3 className="font-semibold mb-1">{item.title}</h3>
                      <p className="text-zinc-500 text-sm">{item.desc}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 6: EARNING POTENTIAL ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-4xl mx-auto text-center">
            <h2 className="text-3xl md:text-5xl font-bold mb-4">
              Your <span className="text-emerald-400">Earning</span> Potential
            </h2>
            <p className="text-zinc-400 text-lg mb-12">Real examples based on typical commission rates</p>

            <div className="grid md:grid-cols-3 gap-6 mb-12">
              {[
                { 
                  level: 'Starter',
                  sales: '5 sales/week',
                  avg: '$50 avg order',
                  rate: '15% commission',
                  monthly: '$150/mo',
                  color: 'zinc'
                },
                { 
                  level: 'Growing',
                  sales: '20 sales/week',
                  avg: '$75 avg order',
                  rate: '20% commission',
                  monthly: '$1,200/mo',
                  color: 'emerald'
                },
                { 
                  level: 'Pro',
                  sales: '50 sales/week',
                  avg: '$100 avg order',
                  rate: '25% commission',
                  monthly: '$5,000/mo',
                  color: 'purple'
                },
              ].map((tier, i) => (
                <div key={i} className={`bg-${tier.color === 'emerald' ? 'emerald-500/10 border-emerald-500/30' : 'zinc-900/50 border-zinc-800'} border rounded-2xl p-6`}>
                  <h3 className={`font-bold text-lg mb-4 ${tier.color === 'emerald' ? 'text-emerald-400' : tier.color === 'purple' ? 'text-purple-400' : 'text-zinc-300'}`}>
                    {tier.level}
                  </h3>
                  <div className="space-y-2 text-sm text-zinc-400 mb-4">
                    <p>{tier.sales}</p>
                    <p>{tier.avg}</p>
                    <p>{tier.rate}</p>
                  </div>
                  <p className={`text-2xl font-bold ${tier.color === 'emerald' ? 'text-emerald-400' : tier.color === 'purple' ? 'text-purple-400' : 'text-white'}`}>
                    {tier.monthly}
                  </p>
                </div>
              ))}
            </div>

            <p className="text-zinc-500 text-sm">
              These are examples only. Your earnings depend on your audience, niche, and the vendors you promote.
            </p>
          </div>
        </section>

        {/* ==================== SECTION 7: MULTI-LEVEL ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-purple-950/5 to-[#0a0a0a]">
          <div className="max-w-4xl mx-auto text-center">
            <h2 className="text-3xl md:text-5xl font-bold mb-4">
              <span className="text-emerald-400">5 Levels</span> Deep
            </h2>
            <p className="text-zinc-400 text-lg mb-12">Refer other affiliates. Earn when they earn. Passive income.</p>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-8 max-w-md mx-auto mb-12">
              <div className="space-y-4">
                {[
                  { level: 'Level 1 (direct)', rate: '25%', desc: 'Your referrals' },
                  { level: 'Level 2', rate: '5%', desc: 'Their referrals' },
                  { level: 'Level 3', rate: '3%', desc: 'And so on...' },
                  { level: 'Level 4', rate: '2%', desc: '' },
                  { level: 'Level 5', rate: '1%', desc: '' },
                ].map((item, i) => (
                  <div key={i} className="flex justify-between items-center py-2 border-b border-zinc-800/50 last:border-0">
                    <div className="text-left">
                      <span className="text-zinc-300 font-medium">{item.level}</span>
                      {item.desc && <span className="text-zinc-600 text-sm ml-2">({item.desc})</span>}
                    </div>
                    <span className="text-emerald-400 font-bold">{item.rate}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-2xl p-6 max-w-lg mx-auto">
              <p className="text-zinc-300 text-sm">
                <strong className="text-emerald-400">Example:</strong> You refer Alice. Alice refers Bob. 
                When Bob makes a sale, both Alice <em>and</em> you get paid. Instantly. On-chain.
              </p>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 8: CTA ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-3xl mx-auto text-center">
            <h2 className="text-4xl md:text-5xl font-bold mb-6">
              Ready to earn<br /><span className="text-emerald-400">on your terms?</span>
            </h2>
            <p className="text-xl text-zinc-400 mb-12">
              No minimums. No waiting. No bank account needed.<br />
              Just find vendors, share links, get paid.
            </p>

            <div className="flex flex-col sm:flex-row gap-4 justify-center mb-12">
              <a 
                href="/affiliate-dashboard"
                className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-8 py-4 rounded-xl transition text-lg"
              >
                Go to Affiliate Dashboard ‚Üí
              </a>
              <a 
                href="/wallet-guide"
                className="border border-zinc-700 hover:border-zinc-500 px-8 py-4 rounded-xl transition text-lg"
              >
                Wallet Guide
              </a>
            </div>

            {/* Trust Badges */}
            <div className="flex flex-wrap justify-center gap-6 text-sm">
              {[
                { icon: '‚ö°', text: '4 second payouts' },
                { icon: 'üîê', text: 'Non-custodial' },
                { icon: 'üåç', text: 'Works worldwide' },
                { icon: 'üíµ', text: 'RLUSD stablecoin' },
              ].map((badge, i) => (
                <div key={i} className="flex items-center gap-2 text-zinc-500">
                  <span>{badge.icon}</span>
                  <span>{badge.text}</span>
                </div>
              ))}
            </div>

            <div className="mt-16 pt-8 border-t border-zinc-800">
              <p className="text-zinc-600 text-sm mb-4">Are you a vendor looking to grow?</p>
              <a href="/" className="text-emerald-400 hover:text-emerald-300 transition">
                Learn how to list your products ‚Üí
              </a>
            </div>
          </div>
        </section>

      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/docs/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import React, { useState, ReactNode } from 'react';


// MARK: - Types & Interfaces
interface CodeBlockProps {
  children: ReactNode;
  title?: string;
}


// MARK: - Component Definition
const CodeBlock = ({ children, title }: CodeBlockProps) => (
  <div className="rounded-lg overflow-hidden border border-slate-700 mb-4">
    {title && (
      <div className="bg-slate-800 px-4 py-2 text-xs text-slate-400 font-mono border-b border-slate-700">
        {title}
      </div>
    )}
    <pre className="bg-slate-900 text-slate-100 p-4 overflow-x-auto text-sm font-mono">
      <code>{children}</code>
    </pre>
  </div>
);

interface StepProps {
  number: number;
  title: string;
  children: ReactNode;
}

const Step = ({ number, title, children }: StepProps) => (
  <div className="flex gap-4 mb-8">
    <div className="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center text-lg font-bold flex-shrink-0">
      {number}
    </div>
    <div className="flex-1">
      <h3 className="text-lg font-semibold text-slate-900 mb-2">{title}</h3>
      <div className="text-slate-600">{children}</div>
    </div>
  </div>
);

interface TabsProps {
  tabs: { id: string; label: string; content: ReactNode }[];
}

const Tabs = ({ tabs }: TabsProps) => {

// MARK: - State Management
  const [active, setActive] = useState(tabs[0].id);
  

// MARK: - Main Render
  return (
    <div className="mb-8">
      <div className="flex border-b border-slate-200 mb-6">
        {tabs.map(tab => (
          <button
            key={tab.id}

// MARK: - Event Handlers
            onClick={() => setActive(tab.id)}
            className={`px-6 py-3 text-sm font-medium transition-colors ${
              active === tab.id
                ? 'text-blue-600 border-b-2 border-blue-600 -mb-px'
                : 'text-slate-500 hover:text-slate-700'
            }`}
          >
            {tab.label}
          </button>
        ))}
      </div>
      {tabs.find(t => t.id === active)?.content}
    </div>
  );
};

interface EndpointProps {
  method: 'GET' | 'POST' | 'DELETE';
  path: string;
  auth?: boolean;
  description: string;
  children?: ReactNode;
}

const Endpoint = ({ method, path, auth, description, children }: EndpointProps) => {
  const [isOpen, setIsOpen] = useState(false);
  const methodColors: Record<string, string> = {
    GET: 'bg-emerald-500',
    POST: 'bg-blue-500',
    DELETE: 'bg-red-500'
  };
  
  return (
    <div className="border border-slate-200 rounded-lg mb-4 overflow-hidden">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="w-full flex items-center gap-3 p-4 hover:bg-slate-50 transition-colors text-left"
      >
        <span className={`${methodColors[method]} text-white text-xs font-bold px-2 py-1 rounded`}>
          {method}
        </span>
        <code className="text-slate-800 font-mono text-sm flex-1">{path}</code>
        {auth && <span className="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded">Auth Required</span>}
        <svg className={`w-5 h-5 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      {isOpen && (
        <div className="border-t border-slate-200 p-4 bg-slate-50">
          <p className="text-slate-600 mb-4">{description}</p>
          {children}
        </div>
      )}
    </div>
  );
};

interface SectionProps {
  id: string;
  title: string;
  children: ReactNode;
}

const Section = ({ id, title, children }: SectionProps) => (
  <section id={id} className="mb-16 scroll-mt-24">
    <h2 className="text-2xl font-bold text-slate-900 mb-6 pb-2 border-b border-slate-200">{title}</h2>
    {children}
  </section>
);

interface NavLinkProps {
  href: string;
  children: ReactNode;
}

const NavLink = ({ href, children }: NavLinkProps) => (
  <a 
    href={href} 
    className="block py-1.5 text-slate-600 hover:text-blue-600 transition-colors font-medium"
  >
    {children}
  </a>
);

export default function YesAllofUsDocs() {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [isStuck, setIsStuck] = useState(true);
  const navRef = React.useRef<HTMLElement>(null);
  const mainRef = React.useRef<HTMLElement>(null);

  React.useEffect(() => {
    const handleScroll = () => {
      if (!mainRef.current || !navRef.current) return;
      
      const mainRect = mainRef.current.getBoundingClientRect();
      const navHeight = navRef.current.offsetHeight;
      const topOffset = 96;
      const buffer = 150;
      
      // Check if we've scrolled past where nav should stop
      const shouldStop = mainRect.bottom < navHeight + topOffset + buffer;
      setIsStuck(!shouldStop);
    };

    window.addEventListener('scroll', handleScroll);
    handleScroll();
    
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);
  
  return (
    <div className="min-h-screen bg-white font-sans overflow-x-hidden">
      
      {/* Mobile Menu Button */}
      <div className="lg:hidden fixed top-4 right-4 z-50">
        <button 
          onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
          className="bg-white border border-slate-200 rounded-lg p-2 shadow-sm"
        >
          {mobileMenuOpen ? (
            <svg className="w-6 h-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          ) : (
            <svg className="w-6 h-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          )}
        </button>
      </div>

      {/* Mobile Menu Overlay */}
{mobileMenuOpen && (
  <div className="lg:hidden fixed inset-0 z-40 bg-white overflow-y-auto bottom-0" style={{ top: '69px', paddingTop: '5px' }}>
    <nav className="p-6 pb-32 space-y-6">
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Getting Started</h3>
              <a href="#overview" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Overview</a>
              <a href="#quick-start" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Quick Start</a>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Integration</h3>
              <a href="#wordpress" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">WordPress (Zero Code)</a>
              <a href="#sdk-tracking" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">SDK Tracking</a>
              <a href="#backend-integration" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Backend Integration</a>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Wallet Options</h3>
              <a href="#wallet-setup" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Xaman & Crossmark</a>
              <a href="#web3auth" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Social Login (Web3Auth)</a>
              <a href="#payout-modes" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Payout Modes</a>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">API Reference</h3>
              <a href="#api-payouts" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Payouts</a>
              <a href="#api-affiliates" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Affiliates</a>
              <a href="#api-stores" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Stores</a>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Reference</h3>
              <a href="#commission-system" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Commission Rates</a>
              <a href="#webhooks" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Webhooks</a>
              <a href="#errors" onClick={() => setMobileMenuOpen(false)} className="block py-2 text-slate-600">Error Codes</a>
            </div>
          </nav>
        </div>
      )}

      <div className="max-w-7xl mx-auto px-4 sm:px-6 py-12 lg:flex lg:gap-12">
        {/* Sidebar - Fixed position */}
        <aside className="w-64 flex-shrink-0 hidden lg:block">
          {/* Placeholder to maintain layout spacing */}
        </aside>
        
        {/* Fixed sidebar navigation */}
        <nav 
          ref={navRef}
          className={`hidden lg:block w-64 max-h-[calc(100vh-12rem)] overflow-y-auto space-y-6 z-40 fixed top-24 transition-opacity duration-200 ${isStuck ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}
          style={{ left: 'max(1.5rem, calc((100vw - 80rem) / 2 + 1.5rem))' }}
        >
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Getting Started</h3>
              <NavLink href="#overview">Overview</NavLink>
              <NavLink href="#quick-start">Quick Start</NavLink>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Integration</h3>
              <NavLink href="#wordpress">WordPress (Zero Code)</NavLink>
              <NavLink href="#sdk-tracking">SDK Tracking</NavLink>
              <NavLink href="#backend-integration">Backend Integration</NavLink>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Wallet Options</h3>
              <NavLink href="#wallet-setup">Xaman & Crossmark</NavLink>
              <NavLink href="#web3auth">Social Login (Web3Auth)</NavLink>
              <NavLink href="#payout-modes">Payout Modes</NavLink>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">API Reference</h3>
              <NavLink href="#api-payouts">Payouts</NavLink>
              <NavLink href="#api-affiliates">Affiliates</NavLink>
              <NavLink href="#api-stores">Stores</NavLink>
            </div>
            <div>
              <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Reference</h3>
              <NavLink href="#commission-system">Commission Rates</NavLink>
              <NavLink href="#webhooks">Webhooks</NavLink>
              <NavLink href="#errors">Error Codes</NavLink>
            </div>
          </nav>

        {/* Main Content */}
        <main ref={mainRef} className="flex-1 min-w-0">
          {/* Overview */}
          <Section id="overview" title="Overview">
            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 mb-8 border border-blue-100">
              <h3 className="text-xl font-semibold text-slate-900 mb-3">Instant Affiliate Payouts on XRPL</h3>
              <p className="text-slate-600 leading-relaxed">
                YesAllofUs pays your affiliates <strong>instantly in RLUSD</strong> when orders complete. 
                No waiting 30 days. No payment processing. Just instant, automatic commissions settled in 3-5 seconds.
              </p>
            </div>

            <div className="grid md:grid-cols-2 gap-6 mb-8">
              <div className="p-5 border border-slate-200 rounded-xl">
                <div className="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center text-2xl mb-3">‚ö°</div>
                <h4 className="font-semibold text-slate-900 mb-1">3-5 Second Settlement</h4>
                <p className="text-sm text-slate-600">Affiliates see RLUSD in their wallet seconds after purchase.</p>
              </div>
              <div className="p-5 border border-slate-200 rounded-xl">
                <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-2xl mb-3">üí∞</div>
                <h4 className="font-semibold text-slate-900 mb-1">5-Level Commissions</h4>
                <p className="text-sm text-slate-600">Affiliates earn on their referrals&apos; referrals. Configurable rates.</p>
              </div>
              <div className="p-5 border border-slate-200 rounded-xl">
                <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-2xl mb-3">üîí</div>
                <h4 className="font-semibold text-slate-900 mb-1">Non-Custodial</h4>
                <p className="text-sm text-slate-600">You control your wallet. We never hold your funds or private keys.</p>
              </div>
              <div className="p-5 border border-slate-200 rounded-xl">
                <div className="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center text-2xl mb-3">üåç</div>
                <h4 className="font-semibold text-slate-900 mb-1">Global Reach</h4>
                <p className="text-sm text-slate-600">Pay anyone, anywhere. No bank account needed. $1 minimum.</p>
              </div>
            </div>

            <h3 className="font-semibold text-slate-900 mb-3">Choose Your Integration</h3>
            <div className="grid md:grid-cols-2 gap-4">
              <a href="#wordpress" className="p-4 border-2 border-emerald-200 bg-emerald-50 rounded-xl hover:border-emerald-400 transition-colors">
                <div className="flex items-center gap-2 mb-2">
                  <span className="bg-emerald-500 text-white text-xs font-bold px-2 py-0.5 rounded">ZERO CODE</span>
                </div>
                <h4 className="font-semibold text-slate-900">WordPress / WooCommerce</h4>
                <p className="text-sm text-slate-600 mt-1">Install plugin, connect wallet. Done.</p>
              </a>
              <a href="#backend-integration" className="p-4 border border-slate-200 rounded-xl hover:border-slate-400 transition-colors">
                <h4 className="font-semibold text-slate-900">Any Platform (API)</h4>
                <p className="text-sm text-slate-600 mt-1">SDK tracks referrals, your backend triggers payouts.</p>
              </a>
            </div>
          </Section>

          {/* Quick Start */}
          <Section id="quick-start" title="Quick Start">
            <Step number={1} title="Register Your Store">
              <p className="mb-3">Run the CLI tool - no installation required:</p>
              <CodeBlock title="Terminal">npx yesallofus</CodeBlock>
              <p className="text-sm text-slate-500">Follow the prompts. You&apos;ll get a dashboard URL and API credentials.</p>
            </Step>

            <Step number={2} title="Connect Your Wallet">
              <p className="mb-3">Open your dashboard link and connect with Xaman (mobile) or Crossmark (browser).</p>
              <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <p className="text-sm text-amber-800">
                  <strong>Required:</strong> Your wallet needs an RLUSD trustline. 
                  Issuer: <code className="bg-amber-100 px-1 rounded">rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De</code>
                </p>
              </div>
            </Step>

            <Step number={3} title="Integrate">
              <p className="mb-3">Choose your integration method:</p>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="p-4 border border-slate-200 rounded-lg">
                  <h4 className="font-semibold text-slate-900 mb-2">WordPress</h4>
                  <p className="text-sm text-slate-600">Install plugin ‚Üí enter credentials ‚Üí done</p>
                  <a href="#wordpress" className="text-sm text-blue-600 hover:underline">See WordPress guide ‚Üí</a>
                </div>
                <div className="p-4 border border-slate-200 rounded-lg">
                  <h4 className="font-semibold text-slate-900 mb-2">Custom Platform</h4>
                  <p className="text-sm text-slate-600">Add SDK ‚Üí call API on payment success</p>
                  <a href="#backend-integration" className="text-sm text-blue-600 hover:underline">See API integration ‚Üí</a>
                </div>
              </div>
            </Step>

            <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-6 mt-8">
              <h4 className="font-semibold text-emerald-900 mb-2">‚úì That&apos;s It!</h4>
              <p className="text-emerald-800">
                Visitors with <code className="bg-emerald-100 px-1 rounded">?ref=CODE</code> are tracked automatically. 
                When they purchase, their referrer gets paid instantly in RLUSD.
              </p>
            </div>
          </Section>

          {/* WordPress */}
          <Section id="wordpress" title="WordPress / WooCommerce">
            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-6">
              <p className="text-emerald-800 font-medium">Zero code required. The plugin handles everything automatically.</p>
            </div>

            <Step number={1} title="Download & Install">
              <p className="mb-3">Download from your dashboard or directly:</p>
              <CodeBlock>https://yesallofus.com/plugin/YesAllofUs.zip</CodeBlock>
              <p className="text-sm text-slate-500 mt-2">Upload via WordPress Admin ‚Üí Plugins ‚Üí Add New ‚Üí Upload Plugin</p>
            </Step>

            <Step number={2} title="Enter API Credentials">
              <p>Go to <strong>YesAllofUs ‚Üí Settings</strong> and enter your <code>api_secret</code> from the CLI registration.</p>
            </Step>

            <Step number={3} title="Connect Wallet">
              <p>Click &quot;Connect Xaman&quot; or &quot;Connect Crossmark&quot; to link your payout wallet.</p>
            </Step>

            <h3 className="font-semibold text-slate-900 mt-8 mb-3">How It Works</h3>
            <ol className="space-y-3 text-slate-600">
              <li className="flex gap-3">
                <span className="w-6 h-6 bg-slate-200 rounded-full flex items-center justify-center text-sm flex-shrink-0">1</span>
                <span>Visitor arrives via <code className="bg-slate-100 px-1 rounded">yourstore.com/?ref=ABC123</code></span>
              </li>
              <li className="flex gap-3">
                <span className="w-6 h-6 bg-slate-200 rounded-full flex items-center justify-center text-sm flex-shrink-0">2</span>
                <span>Plugin stores <code className="bg-slate-100 px-1 rounded">ABC123</code> in a 30-day cookie</span>
              </li>
              <li className="flex gap-3">
                <span className="w-6 h-6 bg-slate-200 rounded-full flex items-center justify-center text-sm flex-shrink-0">3</span>
                <span>Visitor makes purchase, order status becomes &quot;Completed&quot;</span>
              </li>
              <li className="flex gap-3">
                <span className="w-6 h-6 bg-slate-200 rounded-full flex items-center justify-center text-sm flex-shrink-0">4</span>
                <span>Plugin calls YesAllofUs API with order details + referral code</span>
              </li>
              <li className="flex gap-3">
                <span className="w-6 h-6 bg-slate-200 rounded-full flex items-center justify-center text-sm flex-shrink-0">5</span>
                <span>Affiliate chain gets paid instantly in RLUSD (3-5 seconds)</span>
              </li>
            </ol>

            <h3 className="font-semibold text-slate-900 mt-8 mb-3">Shortcodes</h3>
            <div className="space-y-3">
              <div className="p-4 bg-slate-50 rounded-lg flex items-center gap-4">
                <code className="text-blue-600 font-mono text-sm">[yesallofus_affiliate_signup]</code>
                <span className="text-slate-600 text-sm">Affiliate registration form</span>
              </div>
              <div className="p-4 bg-slate-50 rounded-lg flex items-center gap-4">
                <code className="text-blue-600 font-mono text-sm">[yesallofus_affiliate_dashboard]</code>
                <span className="text-slate-600 text-sm">Affiliate stats & referral link</span>
              </div>
            </div>
          </Section>

          {/* SDK Tracking */}
          <Section id="sdk-tracking" title="SDK Tracking">
            <p className="text-slate-600 mb-6">
              The SDK tracks referral codes only. Payouts are triggered securely from your backend. 
              This is the recommended approach for non-WordPress platforms.
            </p>

            <h3 className="font-semibold text-slate-900 mb-3">Add the Tracking Script</h3>
            <Tabs tabs={[
              {
                id: 'html',
                label: 'HTML',
                content: (
                  <CodeBlock title="Add before </body>">{`<script src="https://yesallofus.com/js/track.js"></script>`}</CodeBlock>
                )
              },
              {
                id: 'nextjs',
                label: 'Next.js',
                content: (
                  <CodeBlock title="app/layout.tsx">{`import Script from 'next/script';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Script 
          src="https://yesallofus.com/js/track.js"
          strategy="afterInteractive"
        />
      </body>
    </html>
  );
}`}</CodeBlock>
                )
              },
              {
                id: 'react',
                label: 'React',
                content: (
                  <CodeBlock title="index.html or useEffect">{`// Option 1: Add to public/index.html
<script src="https://yesallofus.com/js/track.js"></script>

// Option 2: Load dynamically

// MARK: - Hooks & Effects
useEffect(() => {
  const script = document.createElement('script');
  script.src = 'https://yesallofus.com/js/track.js';
  document.body.appendChild(script);
}, []);`}</CodeBlock>
                )
              }
            ]} />

            <h3 className="font-semibold text-slate-900 mt-8 mb-3">Read the Referral Code</h3>
            <CodeBlock title="At checkout / payment">{`// Get the tracked referral code
const referralCode = window.YesAllofUs?.getReferralCode();

// Send to your backend with the order
fetch('/api/checkout', {
  method: 'POST',
  body: JSON.stringify({
    items: cart.items,
    total: cart.total,
    referral_code: referralCode  // Include this!
  })
});`}</CodeBlock>

            <h3 className="font-semibold text-slate-900 mt-8 mb-3">What the SDK Does</h3>
            <ul className="space-y-2 text-slate-600">
              <li className="flex gap-2"><span className="text-emerald-500">‚úì</span> Captures <code className="bg-slate-100 px-1 rounded">?ref=CODE</code> from URL</li>
              <li className="flex gap-2"><span className="text-emerald-500">‚úì</span> Stores in cookie for 30 days</li>
              <li className="flex gap-2"><span className="text-emerald-500">‚úì</span> Falls back to sessionStorage</li>
              <li className="flex gap-2"><span className="text-emerald-500">‚úì</span> Exposes <code className="bg-slate-100 px-1 rounded">YesAllofUs.getReferralCode()</code></li>
            </ul>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
              <h4 className="font-semibold text-blue-900 mb-1">Security Note</h4>
              <p className="text-sm text-blue-800">
                The SDK does <strong>not</strong> trigger payouts. That happens securely from your backend 
                using your API secret. See <a href="#backend-integration" className="underline">Backend Integration</a>.
              </p>
            </div>
          </Section>

          {/* Backend Integration */}
          <Section id="backend-integration" title="Backend Integration">
            <p className="text-slate-600 mb-6">
              After payment is verified on your backend, call the YesAllofUs API to trigger affiliate payouts.
              This ensures payouts only happen for legitimate purchases.
            </p>

            <h3 className="font-semibold text-slate-900 mb-3">Trigger Payout After Payment</h3>
            <Tabs tabs={[
              {
                id: 'node',
                label: 'Node.js',
                content: (
                  <CodeBlock title="After payment verification">{`// Your payment success handler
async function handlePaymentSuccess(order, referralCode) {
  // Only trigger if there's a referral
  if (!referralCode) return;
  
  const response = await fetch('https://api.dltpays.com/api/v1/payout', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer sk_your_api_secret'
    },
    body: JSON.stringify({
      order_id: order.id,
      order_total: order.total,
      referral_code: referralCode
    })
  });

  const result = await response.json();
  // { success: true, payout_id: "payout_abc123", status: "queued" }
}`}</CodeBlock>
                )
              },
              {
                id: 'python',
                label: 'Python',
                content: (
                  <CodeBlock title="After payment verification">{`import requests

def handle_payment_success(order, referral_code):
    if not referral_code:
        return
    
    response = requests.post(
        'https://api.dltpays.com/api/v1/payout',
        headers={
            'Content-Type': 'application/json',
            'Authorization': 'Bearer sk_your_api_secret'
        },
        json={
            'order_id': order['id'],
            'order_total': order['total'],
            'referral_code': referral_code
        }
    )
    
    result = response.json()
    # { "success": True, "payout_id": "payout_abc123", "status": "queued" }`}</CodeBlock>
                )
              },
              {
                id: 'php',
                label: 'PHP',
                content: (
                  <CodeBlock title="After payment verification">{`<?php
function handle_payment_success($order, $referral_code) {
    if (empty($referral_code)) return;
    
    $ch = curl_init('https://api.dltpays.com/api/v1/payout');
    
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_HTTPHEADER => [
            'Content-Type: application/json',
            'Authorization: Bearer sk_your_api_secret'
        ],
        CURLOPT_POSTFIELDS => json_encode([
            'order_id' => $order['id'],
            'order_total' => $order['total'],
            'referral_code' => $referral_code
        ])
    ]);
    
    $response = curl_exec($ch);
    $result = json_decode($response, true);
    // ["success" => true, "payout_id" => "payout_abc123"]
}`}</CodeBlock>
                )
              }
            ]} />

            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4 mt-6">
              <h4 className="font-semibold text-emerald-900 mb-1">What Happens Next?</h4>
              <p className="text-sm text-emerald-800">
                <strong>Manual mode (Xaman):</strong> You receive a push notification to approve.<br/>
                <strong>Auto mode (Crossmark):</strong> Payout processes instantly, no approval needed.
              </p>
            </div>

            <h3 className="font-semibold text-slate-900 mt-8 mb-3">Complete Flow Diagram</h3>
            <div className="bg-slate-50 rounded-lg p-6 font-mono text-sm">
              <pre className="text-slate-700 whitespace-pre-wrap">{`‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Visitor    ‚îÇ     ‚îÇ  Your Site   ‚îÇ     ‚îÇ  YesAllofUs  ‚îÇ
‚îÇ   Browser    ‚îÇ     ‚îÇ   Backend    ‚îÇ     ‚îÇ     API      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚îÇ  ?ref=ABC123       ‚îÇ                    ‚îÇ
       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                    ‚îÇ
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚îÇ  SDK stores cookie ‚îÇ                    ‚îÇ
       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                    ‚îÇ
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚îÇ  Checkout + pay    ‚îÇ                    ‚îÇ
       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                    ‚îÇ
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚îÇ                    ‚îÇ  POST /payout      ‚îÇ
       ‚îÇ                    ‚îÇ  + referral_code   ‚îÇ
       ‚îÇ                    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚îÇ                    ‚îÇ  { payout_id }     ‚îÇ
       ‚îÇ                    ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
       ‚îÇ                    ‚îÇ                    ‚îÇ
       ‚îÇ                    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ                    ‚îÇ    ‚îÇ  Affiliate receives RLUSD    ‚îÇ
       ‚îÇ                    ‚îÇ    ‚îÇ  in 3-5 seconds              ‚îÇ
       ‚îÇ                    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`}</pre>
            </div>
          </Section>

          {/* Wallet Setup */}
          <Section id="wallet-setup" title="Wallet Setup: Xaman & Crossmark">
            <p className="text-slate-600 mb-6">
              Connect your XRPL wallet to pay affiliates. Choose based on your preference:
            </p>

            <div className="grid md:grid-cols-2 gap-6 mb-8">
              <div className="p-6 border-2 border-blue-200 bg-blue-50 rounded-xl">
                <div className="flex items-center gap-3 mb-3">
                  <div className="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-slate-900 font-bold">X</div>
                  <div>
                    <h4 className="font-semibold text-slate-900">Xaman (Mobile)</h4>
                    <span className="text-xs bg-emerald-200 text-emerald-800 px-2 py-0.5 rounded">‚úì Live</span>
                  </div>
                </div>
                <p className="text-sm text-slate-600 mb-4">
                  Approve each payout via push notification on your phone.
                </p>
                <ul className="text-sm text-slate-600 space-y-1">
                  <li>‚úì Push notifications for each payout</li>
                  <li>‚úì Review before signing</li>
                  <li>‚úì Maximum control</li>
                </ul>
              </div>
              <div className="p-6 border-2 border-slate-200 bg-slate-50 rounded-xl opacity-60">
  <div className="flex items-center gap-3 mb-3">
    <div className="w-10 h-10 bg-slate-400 rounded-lg flex items-center justify-center text-white font-bold">C</div>
    <div>
      <h4 className="font-semibold text-slate-900">Crossmark (Browser)</h4>
      <span className="text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded">Coming Soon</span>
                  </div>
                </div>
                <p className="text-sm text-slate-600 mb-4">
                  Automatic payouts without approval. Fastest option.
                </p>
                <ul className="text-sm text-slate-600 space-y-1">
                  <li>‚úì Instant, automatic payouts</li>
                  <li>‚úì No manual approval needed</li>
                  <li>‚úì Configurable daily limits</li>
                </ul>
              </div>
            </div>

            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
              <h4 className="font-semibold text-amber-900 mb-2">‚ö†Ô∏è RLUSD Trustline Required</h4>
              <p className="text-sm text-amber-800 mb-2">
                Your wallet must have an RLUSD trustline to send commissions. Add trustline to:
              </p>
              <code className="block bg-amber-100 px-3 py-2 rounded text-sm font-mono text-amber-900">
                rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De
              </code>
            </div>
          </Section>

          {/* Web3Auth Social Login */}
          <Section id="web3auth" title="Social Login (Web3Auth)">
            <div className="bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl p-6 mb-8 border border-slate-200 opacity-60">
  <div className="flex items-center gap-3 mb-3">
    <span className="bg-amber-500 text-white text-xs font-bold px-2 py-0.5 rounded">Coming Soon</span>
                <h3 className="text-xl font-semibold text-slate-900">No Wallet? No Problem.</h3>
              </div>
              <p className="text-slate-600 leading-relaxed">
                Affiliates can sign up with Google, Apple, Facebook, X, Discord, or GitHub. 
                We create a real XRPL wallet for them automatically using Web3Auth&apos;s Multi-Party Computation (MPC) technology.
              </p>
            </div>

            <h3 className="font-semibold text-slate-900 mb-4">How It Works</h3>
            <div className="grid md:grid-cols-2 gap-6 mb-8">
              <div className="space-y-4">
                <div className="flex gap-3">
                  <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-600 font-bold text-sm">1</div>
                  <div>
                    <div className="font-medium text-slate-900">Affiliate clicks &quot;Sign Up&quot;</div>
                    <div className="text-sm text-slate-500">Chooses their preferred social provider</div>
                  </div>
                </div>
                <div className="flex gap-3">
                  <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-600 font-bold text-sm">2</div>
                  <div>
                    <div className="font-medium text-slate-900">Web3Auth creates MPC wallet</div>
                    <div className="text-sm text-slate-500">Private key split across distributed nodes</div>
                  </div>
                </div>
                <div className="flex gap-3">
                  <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-600 font-bold text-sm">3</div>
                  <div>
                    <div className="font-medium text-slate-900">Real XRPL address generated</div>
                    <div className="text-sm text-slate-500">Native <code className="bg-slate-100 px-1 rounded">r...</code> address, not a wrapper</div>
                  </div>
                </div>
                <div className="flex gap-3">
                  <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-600 font-bold text-sm">4</div>
                  <div>
                    <div className="font-medium text-slate-900">Automatic SignerList setup</div>
                    <div className="text-sm text-slate-500">Enables 24/7 payouts without browser session</div>
                  </div>
                </div>
              </div>
              <div className="bg-slate-50 rounded-xl p-6">
                <h4 className="font-semibold text-slate-900 mb-3">Supported Providers</h4>
                <div className="grid grid-cols-4 gap-3">
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-200">
                      <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    </div>
                    <span className="text-xs text-slate-500">Google</span>
                  </div>
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
                    </div>
                    <span className="text-xs text-slate-500">Apple</span>
                  </div>
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-[#1877F2] rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                    </div>
                    <span className="text-xs text-slate-500">Facebook</span>
                  </div>
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-black rounded-lg flex items-center justify-center">
                      <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    </div>
                    <span className="text-xs text-slate-500">X</span>
                  </div>
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-[#5865F2] rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                    </div>
                    <span className="text-xs text-slate-500">Discord</span>
                  </div>
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-[#24292e] rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    </div>
                    <span className="text-xs text-slate-500">GitHub</span>
                  </div>
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-[#9146FF] rounded-lg flex items-center justify-center">
                      <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714z"/></svg>
                    </div>
                    <span className="text-xs text-slate-500">Twitch</span>
                  </div>
                  <div className="flex flex-col items-center gap-1">
                    <div className="w-10 h-10 bg-slate-200 rounded-lg flex items-center justify-center">
                      <span className="text-slate-600 text-xs font-bold">+5</span>
                    </div>
                    <span className="text-xs text-slate-500">More</span>
                  </div>
                </div>
              </div>
            </div>

            <h3 className="font-semibold text-slate-900 mb-4">Multi-Party Computation (MPC) Security</h3>
            <div className="bg-slate-50 rounded-xl p-6 mb-8">
              <p className="text-slate-600 mb-4">
                Web3Auth uses MPC to split private keys across multiple nodes. The full key is <strong>never</strong> assembled 
                in one place ‚Äî it&apos;s reconstructed momentarily only when signing transactions.
              </p>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="flex items-start gap-3">
                  <span className="text-emerald-500 mt-0.5">‚úì</span>
                  <div>
                    <div className="font-medium text-slate-900">No single point of failure</div>
                    <div className="text-sm text-slate-500">Compromising one node doesn&apos;t expose the key</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <span className="text-emerald-500 mt-0.5">‚úì</span>
                  <div>
                    <div className="font-medium text-slate-900">Non-custodial</div>
                    <div className="text-sm text-slate-500">YesAllofUs never has access to full private keys</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <span className="text-emerald-500 mt-0.5">‚úì</span>
                  <div>
                    <div className="font-medium text-slate-900">Social recovery</div>
                    <div className="text-sm text-slate-500">Lost access? Re-authenticate with same social account</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <span className="text-emerald-500 mt-0.5">‚úì</span>
                  <div>
                    <div className="flex items-start gap-3">
  <span className="text-emerald-500 mt-0.5">‚úì</span>
  <div>
    <div className="font-medium text-slate-900">Upgrade anytime</div>
    <div className="text-sm text-slate-500">Switch to Xaman or Crossmark from your dashboard</div>
  </div>
</div>
                  </div>
                </div>
              </div>
            </div>

            <h3 className="font-semibold text-slate-900 mb-4">Pending Commissions System</h3>
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
              <p className="text-slate-700 mb-4">
                New XRPL wallets need ~1 XRP to activate. Until then, commissions are held in a <strong>pending balance</strong>.
              </p>
              <div className="space-y-3">
                <div className="flex gap-3">
                  <div className="w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center flex-shrink-0 text-blue-700 font-bold text-xs">1</div>
                  <span className="text-slate-600">Affiliate earns commission ‚Üí stored in pending balance</span>
                </div>
                <div className="flex gap-3">
                  <div className="w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center flex-shrink-0 text-blue-700 font-bold text-xs">2</div>
                  <span className="text-slate-600">When pending ‚â• 1 XRP ‚Üí The Ledger completes wallet activation</span>
                </div>
                <div className="flex gap-3">
                  <div className="w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center flex-shrink-0 text-blue-700 font-bold text-xs">3</div>
                  <span className="text-slate-600">RLUSD trustline auto-added ‚Üí pending balance released</span>
                </div>
                <div className="flex gap-3">
                  <div className="w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center flex-shrink-0 text-blue-700 font-bold text-xs">4</div>
                  <span className="text-slate-600">Future commissions paid instantly</span>
                </div>
              </div>
            </div>

            <h3 className="font-semibold text-slate-900 mb-4">24/7 Auto-Sign via SignerList</h3>
            <p className="text-slate-600 mb-4">
              Social login wallets automatically add our platform as an authorized signer. This enables instant payouts 
              without requiring the affiliate to be logged in.
            </p>
            <CodeBlock title="SignerList Configuration">{`// Automatically configured on wallet creation
{
  "TransactionType": "SignerListSet",
  "SignerQuorum": 1,
  "SignerEntries": [
    {
      "SignerEntry": {
        "Account": "rQsRwh841n8DDwx4Bs2KZ4fHPKSt7VeULH",  // YesAllofUs platform
        "SignerWeight": 1
      }
    }
  ]
}`}</CodeBlock>
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mt-4">
              <p className="text-sm text-amber-800">
                <strong>User control:</strong> Affiliates can revoke auto-sign permissions anytime from their dashboard, 
                or export their private key to manage the wallet directly in Xaman.
              </p>
            </div>
          </Section>

          {/* Payout Modes */}
          <Section id="payout-modes" title="Payout Modes">
            <div className="overflow-x-auto mb-6">
              <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                <thead className="bg-slate-100">
                  <tr>
                    <th className="px-4 py-3 text-left text-slate-700 font-semibold">Feature</th>
                    <th className="px-4 py-3 text-left text-slate-700 font-semibold">Manual (Xaman)</th>
                    <th className="px-4 py-3 text-left text-slate-400 font-semibold">Auto-Sign (Crossmark) <span className="text-xs bg-amber-100 text-amber-700 px-1 rounded">Soon</span></th>
<th className="px-4 py-3 text-left text-slate-400 font-semibold">Social Login <span className="text-xs bg-amber-100 text-amber-700 px-1 rounded">Soon</span></th>
                  </tr>
                </thead>
                <tbody className="text-slate-700">
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-3 font-medium">Approval</td>
                    <td className="px-4 py-3">Push notification each time</td>
                    <td className="px-4 py-3">None - instant</td>
                    <td className="px-4 py-3">None - instant</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-3 font-medium">Speed</td>
                    <td className="px-4 py-3">Depends on your approval</td>
                    <td className="px-4 py-3">~3-5 seconds</td>
                    <td className="px-4 py-3">~3-5 seconds</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-3 font-medium">Crypto Knowledge</td>
                    <td className="px-4 py-3">Basic (seed phrase)</td>
                    <td className="px-4 py-3">Intermediate</td>
                    <td className="px-4 py-3">None required</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-3 font-medium">Key Storage</td>
                    <td className="px-4 py-3">Your device only</td>
                    <td className="px-4 py-3">Your device only</td>
                    <td className="px-4 py-3">MPC (distributed)</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-3 font-medium">Best For</td>
                    <td className="px-4 py-3">Security-conscious users</td>
                    <td className="px-4 py-3">High volume, hands-off</td>
                    <td className="px-4 py-3">Beginners, mass onboarding</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h3 className="font-semibold text-slate-900 mb-3">Auto-Sign Security</h3>
            <p className="text-slate-600 mb-4">
              Auto-sign uses XRPL&apos;s native SignerList feature. You add our platform as an authorized signer 
              with configurable limits. You can revoke anytime from your dashboard.
            </p>
            <div className="bg-slate-50 rounded-lg p-4">
              <p className="text-sm text-slate-700">
                <strong>Platform Signer Address:</strong><br/>
                <code className="text-blue-600">rQsRwh841n8DDwx4Bs2KZ4fHPKSt7VeULH</code>
              </p>
            </div>
          </Section>

          {/* API Reference - Payouts */}
          <Section id="api-payouts" title="API: Payouts">
            <div className="bg-slate-800 text-slate-100 rounded-lg p-4 mb-6 font-mono text-sm">
              Base URL: <span className="text-emerald-400">https://api.dltpays.com/api/v1</span>
            </div>

            <Endpoint method="POST" path="/payout" auth description="Trigger affiliate payout for an order. This is the primary endpoint for backend integrations.">
              <h5 className="font-semibold text-slate-700 text-sm mb-2">Request</h5>
              <CodeBlock>{`POST /api/v1/payout
Authorization: Bearer sk_your_api_secret
Content-Type: application/json

{
  "order_id": "order_12345",
  "order_total": 99.99,
  "referral_code": "ABC123"
}`}</CodeBlock>
              <h5 className="font-semibold text-slate-700 text-sm mt-4 mb-2">Response (201 Created)</h5>
              <CodeBlock>{`{
  "success": true,
  "payout_id": "payout_abc123def456",
  "payments_count": 3,
  "status": "queued"
}`}</CodeBlock>
              <div className="mt-4 p-3 bg-slate-100 rounded text-sm text-slate-600">
                <strong>Status flow:</strong> queued ‚Üí processing ‚Üí paid (or failed)
              </div>
            </Endpoint>

            <Endpoint method="POST" path="/intent" auth description="Generate a signed intent token for secure SDK usage. Token expires in 5 minutes.">
              <h5 className="font-semibold text-slate-700 text-sm mb-2">Request</h5>
              <CodeBlock>{`POST /api/v1/intent
Authorization: Bearer sk_your_api_secret
Content-Type: application/json

{
  "order_id": "order_12345",
  "amount": 99.99
}`}</CodeBlock>
              <h5 className="font-semibold text-slate-700 text-sm mt-4 mb-2">Response</h5>
              <CodeBlock>{`{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 300
}`}</CodeBlock>
              <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
                Intent tokens allow auto-sign stores to accept SDK-triggered payouts securely. 
                The token contains the order details signed by your API secret.
              </div>
            </Endpoint>

            <Endpoint method="POST" path="/payout/:id/approve" auth description="Manually approve a pending payout. Only needed if payout is in pending_manual status.">
              <CodeBlock>{`POST /api/v1/payout/payout_abc123/approve
Authorization: Bearer sk_your_api_secret`}</CodeBlock>
            </Endpoint>
          </Section>

          {/* API Reference - Affiliates */}
          <Section id="api-affiliates" title="API: Affiliates">
            <Endpoint method="POST" path="/affiliate/register" auth description="Register a new affiliate for your store. Requires API authentication.">
              <h5 className="font-semibold text-slate-700 text-sm mb-2">Request</h5>
              <CodeBlock>{`POST /api/v1/affiliate/register
Authorization: Bearer sk_your_api_secret
Content-Type: application/json

{
  "wallet": "rAffiliateWallet123...",
  "parent_referral_code": "ABC123"
}`}</CodeBlock>
              <h5 className="font-semibold text-slate-700 text-sm mt-4 mb-2">Response (201 Created)</h5>
              <CodeBlock>{`{
  "success": true,
  "affiliate_id": "aff_xyz789",
  "referral_code": "DEF456",
  "level": 2
}`}</CodeBlock>
            </Endpoint>

            <Endpoint method="POST" path="/affiliate/register-public" description="Public affiliate registration. No auth required - for affiliate signup forms.">
              <h5 className="font-semibold text-slate-700 text-sm mb-2">Request</h5>
              <CodeBlock>{`POST /api/v1/affiliate/register-public
Content-Type: application/json

{
  "store_id": "store_abc123",
  "wallet": "rAffiliateWallet123...",
  "parent_referral_code": "ABC123"
}`}</CodeBlock>
              <h5 className="font-semibold text-slate-700 text-sm mt-4 mb-2">Response</h5>
              <CodeBlock>{`{
  "success": true,
  "affiliate_id": "aff_xyz789",
  "referral_code": "DEF456",
  "referral_link": "https://yourstore.com?ref=DEF456",
  "level": 2
}`}</CodeBlock>
              <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded text-sm text-amber-800">
                <strong>Requirement:</strong> Wallet must have an RLUSD trustline before registration.
              </div>
            </Endpoint>

            <Endpoint method="GET" path="/affiliate/dashboard/:wallet" description="Get affiliate earnings across all stores they're registered with.">
              <h5 className="font-semibold text-slate-700 text-sm mb-2">Response</h5>
              <CodeBlock>{`{
  "success": true,
  "wallet": "rAffiliateWallet123...",
  "total_earned": 250.00,
  "stores": [
    {
      "store_id": "store_abc123",
      "store_name": "Example Store",
      "referral_code": "DEF456",
      "referral_link": "https://example.com?ref=DEF456",
      "total_earned": 250.00,
      "level": 2
    }
  ],
  "recent_payouts": [
    {
      "store_name": "Example Store",
      "order_id": "order_123",
      "amount": 25.00,
      "tx_hash": "ABC123...",
      "paid_at": "2025-01-15T10:30:00Z"
    }
  ]
}`}</CodeBlock>
            </Endpoint>
          </Section>

          {/* API Reference - Stores */}
          <Section id="api-stores" title="API: Stores">
            <Endpoint method="POST" path="/store/register" description="Register a new store. Returns API credentials. Usually done via CLI.">
              <h5 className="font-semibold text-slate-700 text-sm mb-2">Request</h5>
              <CodeBlock>{`POST /api/v1/store/register
Content-Type: application/json

{
  "store_name": "My Store",
  "store_url": "https://mystore.com",
  "email": "admin@mystore.com",
  "commission_rates": [25, 5, 3, 2, 1],
  "referred_by_store": "A1B2C3D4"
}`}</CodeBlock>
              <h5 className="font-semibold text-slate-700 text-sm mt-4 mb-2">Response (201 Created)</h5>
              <CodeBlock>{`{
  "success": true,
  "store_id": "store_abc123def456",
  "api_key": "pk_abc123def456",
  "api_secret": "sk_xyz789ghi012",
  "store_referral_code": "A1B2C3D4",
  "claim_token": "abc123..."
}`}</CodeBlock>
              <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-800">
                <strong>Important:</strong> Save the <code>api_secret</code> immediately. It cannot be retrieved later.
              </div>
            </Endpoint>

            <Endpoint method="GET" path="/store/stats" auth description="Get store statistics including affiliate count and total paid.">
              <CodeBlock>{`GET /api/v1/store/stats
Authorization: Bearer sk_your_api_secret

{
  "store_id": "store_abc123",
  "store_name": "My Store",
  "status": "active",
  "xaman_connected": true,
  "push_enabled": true,
  "wallet_address": "rWallet123...",
  "payout_mode": "auto",
  "auto_signing_enabled": true,
  "affiliates_count": 42,
  "total_paid": 1234.56,
  "daily_paid": 89.00,
  "daily_limit": 1000
}`}</CodeBlock>
            </Endpoint>

            <Endpoint method="POST" path="/store/settings" description="Update store settings including commission rates and limits.">
              <CodeBlock>{`POST /api/v1/store/settings
Content-Type: application/json

{
  "store_id": "store_abc123",
  "wallet_address": "rWallet123...",
  "commission_rates": [20, 5, 3, 2, 1],
  "daily_limit": 2000,
  "auto_sign_max_single_payout": 200
}`}</CodeBlock>
            </Endpoint>

            <Endpoint method="GET" path="/store/:store_id/affiliates" description="Get all affiliates for a store. Requires wallet verification.">
              <CodeBlock>{`GET /api/v1/store/store_abc123/affiliates?wallet=rWallet123...

{
  "success": true,
  "affiliates": [
    {
      "affiliate_id": "aff_xyz",
      "wallet": "rAffiliate...",
      "referral_code": "ABC123",
      "total_earned": 150.00,
      "level": 1,
      "created_at": "2025-01-01T00:00:00Z"
    }
  ]
}`}</CodeBlock>
            </Endpoint>

            <Endpoint method="GET" path="/store/:store_id/payouts" description="Get payment history for a store. Requires wallet verification.">
              <CodeBlock>{`GET /api/v1/store/store_abc123/payouts?wallet=rWallet123...

{
  "success": true,
  "payouts": [
    {
      "payout_id": "payout_abc",
      "order_id": "order_123",
      "order_total": 100.00,
      "payments": [...],
      "tx_hashes": [...],
      "paid_at": "2025-01-15T10:30:00Z",
      "auto_signed": true
    }
  ]
}`}</CodeBlock>
            </Endpoint>
          </Section>

          {/* Commission System */}
          <Section id="commission-system" title="Commission Rates">
            <h3 className="font-semibold text-slate-900 mb-3">Affiliate Commissions (Default)</h3>
            <div className="overflow-x-auto mb-6">
              <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                <thead className="bg-slate-100">
                  <tr>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Level</th>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Rate</th>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Example ($100 order)</th>
                  </tr>
                </thead>
                <tbody className="text-slate-700">
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2">Level 1 (Direct referrer)</td>
                    <td className="px-4 py-2 font-mono">25%</td>
                    <td className="px-4 py-2 font-mono">$25.00</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-2">Level 2</td>
                    <td className="px-4 py-2 font-mono">5%</td>
                    <td className="px-4 py-2 font-mono">$5.00</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2">Level 3</td>
                    <td className="px-4 py-2 font-mono">3%</td>
                    <td className="px-4 py-2 font-mono">$3.00</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-2">Level 4</td>
                    <td className="px-4 py-2 font-mono">2%</td>
                    <td className="px-4 py-2 font-mono">$2.00</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2">Level 5</td>
                    <td className="px-4 py-2 font-mono">1%</td>
                    <td className="px-4 py-2 font-mono">$1.00</td>
                  </tr>
                  <tr className="border-t border-slate-200 bg-emerald-50">
                    <td className="px-4 py-2 font-semibold">Total</td>
                    <td className="px-4 py-2 font-mono font-semibold">36%</td>
                    <td className="px-4 py-2 font-mono font-semibold">$36.00</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p className="text-sm text-slate-500 mb-8">Rates are configurable in your dashboard. Total cannot exceed 100%.</p>

            <h3 className="font-semibold text-slate-900 mb-3">Platform Fee</h3>
            <p className="text-slate-600 mb-4">Fee is calculated on <strong>commissions paid</strong>, not order total.</p>
            <div className="overflow-x-auto">
              <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                <thead className="bg-slate-100">
                  <tr>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Tier</th>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Fee Rate</th>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Monthly Cost</th>
                  </tr>
                </thead>
                <tbody className="text-slate-700">
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2 text-slate-900 font-medium">Free</td>
                    <td className="px-4 py-2 font-mono">2.9%</td>
                    <td className="px-4 py-2">$0</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-2 text-slate-900 font-medium">Pro</td>
                    <td className="px-4 py-2 font-mono">0.9%</td>
                    <td className="px-4 py-2">$99</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2 text-slate-900 font-medium">Enterprise</td>
                    <td className="px-4 py-2 font-mono">0%</td>
                    <td className="px-4 py-2">$499</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p className="text-sm text-slate-500 mt-4">
              Referred stores get 50% fee discount in their first month (1.45% instead of 2.9%).
            </p>
          </Section>

          {/* Webhooks */}
          <Section id="webhooks" title="Webhooks">
            <p className="text-slate-600 mb-4">
              Receive notifications when payout status changes. For WordPress, the plugin handles this automatically.
            </p>

            <h3 className="font-semibold text-slate-900 mb-3">Webhook Payload</h3>
            <CodeBlock>{`POST https://yoursite.com/webhooks/yesallofus
X-DLTPays-Signature: abc123...
Content-Type: application/json

{
  "payout_id": "payout_abc123",
  "status": "paid",
  "order_id": "order_12345",
  "tx_hashes": [
    {
      "wallet": "rAffiliate...",
      "amount": 25.00,
      "tx_hash": "ABC123DEF456..."
    }
  ]
}`}</CodeBlock>

            <h3 className="font-semibold text-slate-900 mt-6 mb-3">Verify Signature</h3>
            <CodeBlock title="Node.js">{`const crypto = require('crypto');

function verifyWebhook(payload, signature, apiSecret) {
  const expected = crypto
    .createHmac('sha256', apiSecret)
    .update(JSON.stringify(payload))
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expected)
  );
}`}</CodeBlock>
          </Section>

          {/* Error Codes */}
          <Section id="errors" title="Error Codes">
            <div className="overflow-x-auto">
              <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                <thead className="bg-slate-100">
                  <tr>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Code</th>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Meaning</th>
                    <th className="px-4 py-2 text-left text-slate-700 font-semibold">Solution</th>
                  </tr>
                </thead>
                <tbody className="text-slate-700">
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2 font-mono">400</td>
                    <td className="px-4 py-2">Bad Request</td>
                    <td className="px-4 py-2">Check required fields and formats</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-2 font-mono">401</td>
                    <td className="px-4 py-2">Unauthorized</td>
                    <td className="px-4 py-2">Check API secret in Authorization header</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2 font-mono">403</td>
                    <td className="px-4 py-2">Forbidden</td>
                    <td className="px-4 py-2">Wallet mismatch or auto-sign blocked</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-2 font-mono">404</td>
                    <td className="px-4 py-2">Not Found</td>
                    <td className="px-4 py-2">Store, affiliate, or referral code doesn&apos;t exist</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2 font-mono">409</td>
                    <td className="px-4 py-2">Conflict</td>
                    <td className="px-4 py-2">Order already processed (idempotent - this is OK)</td>
                  </tr>
                  <tr className="border-t border-slate-100 bg-slate-50">
                    <td className="px-4 py-2 font-mono">429</td>
                    <td className="px-4 py-2">Rate Limited</td>
                    <td className="px-4 py-2">Slow down (60/min per IP, 10/min per store)</td>
                  </tr>
                  <tr className="border-t border-slate-100">
                    <td className="px-4 py-2 font-mono">503</td>
                    <td className="px-4 py-2">Service Unavailable</td>
                    <td className="px-4 py-2">Beta full or service maintenance</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </Section>

          {/* Support */}
          <Section id="support" title="Support">
            <div className="grid md:grid-cols-2 gap-6">
              <a href="mailto:mark@yesallofus.com" className="p-6 border border-slate-200 rounded-xl hover:border-blue-400 transition-colors">
                <div className="text-2xl mb-2">üìß</div>
                <h4 className="font-semibold text-slate-900">Email Support</h4>
                <p className="text-sm text-slate-600 mt-1">mark@yesallofus.com</p>
              </a>
              <a href="https://twitter.com/YesAllofUs" className="p-6 border border-slate-200 rounded-xl hover:border-blue-400 transition-colors">
                <div className="text-2xl mb-2">ùïè</div>
                <h4 className="font-semibold text-slate-900">Twitter</h4>
                <p className="text-sm text-slate-600 mt-1">@YesAllofUs</p>
              </a>
            </div>
          </Section>

        </main>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/faq/dashboard/layout.tsx
// =================================================

// MARK: - Component Definition
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a]">
      {children}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/faq/dashboard/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';
import StoreActivity from '@/components/StoreActivity';
import WalletFunding from '@/components/WalletFunding';
import Script from 'next/script';
import TopUpRLUSD from '@/components/TopUpRLUSD';
import WithdrawRLUSD from '@/components/WithdrawRLUSD';
import DashboardHeader from "@/components/DashboardHeader";
import Link from 'next/link';
import QRCodeModal from '@/components/QRCodeModal';
import Logo from '@/components/Logo';
import { useRouter } from 'next/navigation';

// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';
import LoginScreen from '@/components/LoginScreen';
import PendingCustomers from '@/components/PendingCustomers';
import EarnInterest from '@/components/EarnInterest';
import Sidebar from '@/components/Sidebar';
import MilestoneChecklist from '@/components/MilestoneChecklist';
import CelebrationToast from '@/components/CelebrationToast';
import { InfoButton, InfoModal, useInfoModal } from '@/components/InfoModal';
import CollapsibleSection from '@/components/CollapsibleSection';
import SignUpCustomerCard from '@/components/SignUpCustomerCard';
import NebulaBackground from '@/components/NebulaBackground';
import VendorDashboardTour from '@/components/VendorDashboardTour';
import OnboardingSetup from '@/components/OnboardingSetup';
import DeleteConfirmModal from '@/components/DeleteConfirmModal';


// MARK: - Types & Interfaces
interface WalletStatus {
  funded: boolean;
  xrp_balance: number;
  rlusd_trustline: boolean;
  rlusd_balance: number;
  usdc_trustline?: boolean;
  usdc_balance?: number;
  auto_signing_enabled?: boolean;
}


// MARK: - Component Definition
export default function StoreDashboard() {
  const [step, setStep] = useState<'login' | 'xaman' | 'dashboard'>('login');
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [xamanDeepLink, setXamanDeepLink] = useState<string | null>(null);
  const [loginId, setLoginId] = useState<string | null>(null);
  const [walletAddress, setWalletAddress] = useState<string | null>(null);
  const [walletType, setWalletType] = useState<'xaman' | 'crossmark' | 'web3auth' | null>(null);
  const [store, setStore] = useState<any>(null);
  const [newSecret, setNewSecret] = useState<string | null>(null);

// MARK: - State Management
  const [secretRevealed, setSecretRevealed] = useState(false);
  const [secretSaved, setSecretSaved] = useState(false);
  const [copied, setCopied] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [polling, setPolling] = useState(false);
  const [loading, setLoading] = useState(false);
  const [showQRModal, setShowQRModal] = useState(false);
  const [web3authTermsAccepted, setWeb3authTermsAccepted] = useState(false);
const [connectingGoogle, setConnectingGoogle] = useState(false);
const [sidebarOpen, setSidebarOpen] = useState(false);
const router = useRouter();
// Disconnect modal state
const [showDisconnectModal, setShowDisconnectModal] = useState(false);
const [setupProgress, setSetupProgress] = useState<string | null>(null);
// State (add with other state)
const [runTour, setRunTour] = useState(false);

  // Settings state
  const [commissionRates, setCommissionRates] = useState([25, 5, 3, 2, 1]);
  const [dailyLimit, setDailyLimit] = useState(1000);
  const [maxSinglePayout, setMaxSinglePayout] = useState(100);
  const [savingSettings, setSavingSettings] = useState(false);
  const [settingsSaved, setSettingsSaved] = useState(true);

  // Auto-sign setup state (only used on dashboard)
  const [autoSignTermsAccepted, setAutoSignTermsAccepted] = useState(false);
  const [settingUpAutoSign, setSettingUpAutoSign] = useState(false);

  // Trustline confirmation (login screen)
  const [trustlineConfirmed, setTrustlineConfirmed] = useState(false);
  const [xamanUserToken, setXamanUserToken] = useState<string | null>(null);

  // Web3Auth specific state
  const [socialProvider, setSocialProvider] = useState<string | null>(null);

  // Claim token (from CLI)
  const [claimToken, setClaimToken] = useState<string | null>(null);
  const [claimStore, setClaimStore] = useState<any>(null);

  // Store referral (from ?ref= param)
  const [referralCode, setReferralCode] = useState<string | null>(null);
  const [referringStore, setReferringStore] = useState<any>(null);

  // Amount visibility toggle
  const [showAmounts, setShowAmounts] = useState(false);
  const [showQR, setShowQR] = useState(false);

  // Wallet funding state (for new Web3Auth wallets)
  const [walletNeedsFunding, setWalletNeedsFunding] = useState(false);
  const [walletNeedsTrustline, setWalletNeedsTrustline] = useState(false);
  const [walletXrpBalance, setWalletXrpBalance] = useState(0);
  const [walletRlusdBalance, setWalletRlusdBalance] = useState(0);

  // Logo state
const [storeLogo, setStoreLogo] = useState<string | null>(null);
const [showLogoUpload, setShowLogoUpload] = useState(false);
const [uploadingLogo, setUploadingLogo] = useState(false);

// Collapsed sidebar
const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

// Store tracking
const [celebrateMilestone, setCelebrateMilestone] = useState<string | null>(null);
// Info modal
const { activeInfo, openInfo, closeInfo, getContent } = useInfoModal();
// Wallet status for OnboardingSetup
const [walletStatus, setWalletStatus] = useState<WalletStatus | null>(null);
const [allMilestonesComplete, setAllMilestonesComplete] = useState(false);
const [setupComplete, setSetupComplete] = useState(false);
const [customerAutoSignEnabled, setCustomerAutoSignEnabled] = useState(false);
// Collapsed section
const [openSections, setOpenSections] = useState<Record<string, boolean>>({});
// Progress bar on button
const [progressHidden, setProgressHidden] = useState(false);
// Delete Modal
const [showDeleteModal, setShowDeleteModal] = useState(false);
const [deleting, setDeleting] = useState(false);

// Effect (add with other effects)

// MARK: - Hooks & Effects
useEffect(() => {
  if (store?.store_id && !loading) {
    const hasSeenTour = localStorage.getItem(`vendor_tour_completed_${store.store_id}`);
    if (!hasSeenTour) {
      setTimeout(() => setRunTour(true), 1000);
    }
  }
}, [store?.store_id, loading]);

useEffect(() => {

// MARK: - Event Handlers
  const handleToggle = () => setSidebarOpen(prev => !prev);
  window.addEventListener('toggleSidebar', handleToggle);
  return () => window.removeEventListener('toggleSidebar', handleToggle);
}, []);

useEffect(() => {
  if (store?.store_id) {
    const dismissed = localStorage.getItem(`milestones_dismissed_${store.store_id}`);
    setProgressHidden(dismissed === 'true');
  }
}, [store?.store_id]);

const toggleSection = (id: string) => {
  setOpenSections(prev => ({ ...prev, [id]: !prev[id] }));
};

  const refreshWalletStatus = async () => {
  if (!walletAddress) return;
  try {
    const res = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${walletAddress}`);
    const data = await res.json();
    if (data.success) {
      setWalletXrpBalance(data.xrp_balance || 0);
      setWalletRlusdBalance(data.rlusd_balance || 0);
      setWalletNeedsFunding(!data.funded);
      setWalletNeedsTrustline(!data.rlusd_trustline);
      
      // Set walletStatus for OnboardingSetup
      setWalletStatus({
        funded: data.funded,
        xrp_balance: data.xrp_balance || 0,
        rlusd_trustline: data.rlusd_trustline || false,
        rlusd_balance: data.rlusd_balance || 0,
        usdc_trustline: data.usdc_trustline || false,
        usdc_balance: data.usdc_balance || 0,
        auto_signing_enabled: data.auto_signing_enabled || false
      });
      
      // Check milestones
      if (data.funded) {
        setMilestone('wallet_funded');
      }
      if (data.rlusd_trustline) {
        setMilestone('trustline_set');
      }
    }
  } catch (err) {
    console.error('Failed to refresh wallet status:', err);
  }
};

  // Upload store logo
const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file || !store) return;

  if (file.size > 5 * 1024 * 1024) {
    setError('Image must be less than 5MB');
    return;
  }

  if (!file.type.startsWith('image/')) {
    setError('Please upload an image file');
    return;
  }

  setUploadingLogo(true);
  setError(null);

  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'store_logos');

    const uploadRes = await fetch('https://tokencanvas.io/api/cloudinary/upload', {
      method: 'POST',
      body: formData
    });

    const uploadData = await uploadRes.json();
    
    if (!uploadData.secure_url) {
      throw new Error(uploadData.error?.message || 'Upload failed');
    }

    const logoUrl = uploadData.secure_url;

    const res = await fetch(`https://api.dltpays.com/nfc/api/v1/store/${store.store_id}/logo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        logo_url: logoUrl,
        wallet_address: walletAddress
      })
    });

    const data = await res.json();
    if (data.success) {
      setStoreLogo(logoUrl);
      setStore({ ...store, logo_url: logoUrl });
      safeSetItem('storeData', JSON.stringify({ ...store, logo_url: logoUrl }));
      setShowLogoUpload(false);
    } else {
      setError('Failed to save logo');
    }
  } catch (err: any) {
    console.error('Upload error:', err);
    setError(err.message || 'Failed to upload logo');
  }
  setUploadingLogo(false);
};

// Remove store logo
const removeLogo = async () => {
  if (!store) return;
  setUploadingLogo(true);
  try {
    const res = await fetch(`https://api.dltpays.com/nfc/api/v1/store/${store.store_id}/logo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        logo_url: null,
        wallet_address: walletAddress
      })
    });
    if (res.ok) {
      setStoreLogo(null);
      setStore({ ...store, logo_url: null });
      safeSetItem('storeData', JSON.stringify({ ...store, logo_url: null }));
      setShowLogoUpload(false);
    }
  } catch (err) {
    setError('Failed to remove logo');
  }
  setUploadingLogo(false);
};

  // Sidebar scroll function
  const scrollToSection = (id: string) => {
  const element = document.getElementById(id);
  if (element) {
    const headerOffset = 80; // Height of header + some padding
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
  setSidebarOpen(false);
};

const handleNavClick = (id: string, onClick?: () => void) => {
  if (onClick) {
    onClick();
  } else {
    setOpenSections(prev => ({ ...prev, [id]: true }));
    scrollToSection(id);
  }
  setSidebarOpen(false);
  setSidebarCollapsed(true);
};

const setMilestone = async (milestoneId: string) => {
  if (!store?.store_id || !walletAddress) return;
  
  try {
    const res = await fetch(`${API_URL}/store/${store.store_id}/milestone`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        milestone: milestoneId,
        wallet_address: walletAddress
      })
    });
    const data = await res.json();
    
    if (data.success && data.new) {
      setCelebrateMilestone(milestoneId);
    }
  } catch (err) {
    console.error('Failed to set milestone:', err);
  }
};

// Check wallet status and set milestones on dashboard load
useEffect(() => {
  if (walletAddress && store?.store_id) {
    refreshWalletStatus();
  }
}, [walletAddress, store?.store_id, walletType]);

  // Check URL for claim token on load
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const params = new URLSearchParams(window.location.search);
      const claim = params.get('claim');
      if (claim) {
        setClaimToken(claim);
        fetch(`${API_URL}/store/by-claim/${claim}?_t=${Date.now()}`, { cache: 'no-store' })
          .then(res => res.json())
          .then(data => {
            if (data.success && data.store) {
              setClaimStore(data.store);
            }
          })
          .catch(console.error);
      }

      // Check for WordPress return URL - just store in sessionStorage for now
// It will be saved to Firebase in loadOrCreateStore
const wpReturn = params.get('wordpress_return') || safeGetItem('wordpress_return');
if (wpReturn) {
    safeSetItem('wordpress_return', wpReturn);
}

      // Check for referral code (from store referral link)
      const ref = params.get('ref') || safeGetItem('vendorReferralCode');
      if (ref) {
        setReferralCode(ref);
        safeSetItem('vendorReferralCode', ref);
        // Check if we already have the referring store cached
        const cachedReferrer = safeGetItem('vendorReferringStore');
        if (cachedReferrer) {
          setReferringStore(JSON.parse(cachedReferrer));
        }
       fetch(`${API_URL}/store/lookup-referral/${ref}?_t=${Date.now()}`, { cache: 'no-store' })
          .then(res => res.json())
          .then(data => {
            if (data.success && data.store) {
              setReferringStore(data.store);
              safeSetItem('vendorReferringStore', JSON.stringify(data.store));
            }
          })
          .catch(console.error);
      }

      // Check for existing Web3Auth session
const savedWallet = safeGetItem('vendorWalletAddress');
const savedType = safeGetItem('vendorLoginMethod');
const savedSocialProvider = safeGetItem('socialProvider');
if (savedWallet && savedType) {
  setWalletAddress(savedWallet);
  setWalletType(savedType as 'xaman' | 'crossmark' | 'web3auth');
  if (savedSocialProvider) setSocialProvider(savedSocialProvider);
  loadOrCreateStore(savedWallet, savedType as 'xaman' | 'crossmark' | 'web3auth');
}
    }
  }, []);

  // Check milestones on dashboard load
useEffect(() => {
  if (!store?.store_id || !walletAddress) return;

  const checkMilestones = async () => {
    try {
      // Check for first affiliate and payouts
      const countRes = await fetch(`${API_URL}/store/${store.store_id}/affiliate-count?wallet_address=${walletAddress}`);
      const countData = await countRes.json();
      
      if (countData.success) {
        if (countData.affiliates_count > 0) {
          setMilestone('first_affiliate');
        }
        
        if (countData.has_payouts) {
          setMilestone('first_payout_sent');
        }
      }

      // Check for first referred vendor
      const vendorRes = await fetch(`${API_URL}/store/${store.store_id}/referred-vendors`);
      const vendorData = await vendorRes.json();
      if (vendorData.success && vendorData.count > 0) {
        setMilestone('first_partner_signed');
      }
    } catch (err) {
      console.error('Failed to check milestones:', err);
    }
  };

  checkMilestones();
}, [store?.store_id, walletAddress]);

  // Poll for Xaman login
  useEffect(() => {
    if (!polling || !loginId) return;

    const interval = setInterval(async () => {
      try {
        const res = await fetch(`${API_URL}/xaman/login/poll/${loginId}`);
        const data = await res.json();

        if (data.status === 'signed' && data.wallet_address) {
          setWalletAddress(data.wallet_address);
          setWalletType('xaman');
          setXamanUserToken(data.xaman_user_token || null);
          setPolling(false);
          safeSetItem('vendorWalletAddress', data.wallet_address);
          safeSetItem('vendorLoginMethod', 'xaman');
          loadOrCreateStore(data.wallet_address, 'xaman', data.xaman_user_token);
        } else if (data.status === 'expired' || data.status === 'cancelled') {
          setPolling(false);
          setError('Connection ' + data.status + '. Please try again.');
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 3000);

    return () => clearInterval(interval);
  }, [polling, loginId]);

  // Check wallet status on load (Web3Auth and Xaman)
useEffect(() => {
  console.log('Wallet useEffect triggered:', { walletType, walletAddress, store: !!store });
  if (walletAddress && store) {
    // Check wallet funding status
    fetch(`${API_URL}/wallet/status/${walletAddress}`)
      .then(res => res.json())
      .then(data => {
  console.log('Wallet status response:', data);
  if (data.success) {
    console.log('Setting XRP balance:', data.xrp_balance);
    console.log('Setting RLUSD balance:', data.rlusd_balance);
    setWalletXrpBalance(data.xrp_balance || 0);
    setWalletRlusdBalance(data.rlusd_balance || 0);

    setWalletStatus({
      funded: data.funded,
      xrp_balance: data.xrp_balance || 0,
      rlusd_trustline: data.rlusd_trustline || false,
      rlusd_balance: data.rlusd_balance || 0,
      usdc_trustline: data.usdc_trustline || false,
      usdc_balance: data.usdc_balance || 0,
      auto_signing_enabled: data.auto_signing_enabled || false
    });
          
          if (!data.funded) {
            setWalletNeedsFunding(true);
            setWalletNeedsTrustline(false);
          } else if (!data.rlusd_trustline) {
            setWalletNeedsFunding(false);
            setWalletNeedsTrustline(true);
          } else {
            setWalletNeedsFunding(false);
            setWalletNeedsTrustline(false);
          }
        }
      })
      .catch(console.error);
  }
}, [walletType, walletAddress, store]);

  // =========================================================================
  // WEB3AUTH GOOGLE LOGIN
  // =========================================================================
  const connectGoogle = async () => {
    if (!web3authTermsAccepted) return;
    
    setConnectingGoogle(true);
    setError(null);
    
    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth) {
        throw new Error('Web3Auth not available');
      }
      
      const provider = await web3auth.connect();
      if (!provider) {
        throw new Error('Connection cancelled');
      }
      
      const accounts = await provider.request({ method: 'xrpl_getAccounts' }) as string[];
      const address = accounts?.[0];
      
      if (!address) {
        throw new Error('No wallet address returned');
      }
      
      // Get the social provider type
      // Get the social provider type
      const userInfo = await web3auth.getUserInfo();
      const socialProviderType = userInfo?.authConnection;
      
      setWalletAddress(address);
      setWalletType('web3auth');
      setSocialProvider(socialProviderType);
      safeSetItem('vendorWalletAddress', address);
      safeSetItem('vendorLoginMethod', 'web3auth');
      safeSetItem('socialProvider', socialProviderType);
      
      loadOrCreateStore(address, 'web3auth');
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Google login failed';
      if (!message.includes('cancelled') && !message.includes('closed')) {
        setError(message);
      }
    }
    
    setConnectingGoogle(false);
  };


// MARK: - API Calls & Data Fetching
  const loadOrCreateStore = async (wallet: string, type: 'xaman' | 'crossmark' | 'web3auth', xamanUserToken?: string | null) => {
  setLoading(true);
  try {
    // If we have a claim token, attach wallet to that store
    if (claimToken && claimStore) {
      const res = await fetch(`${API_URL}/store/claim`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          claim_token: claimToken,
          wallet_address: wallet,
          wallet_type: type,
          xaman_user_token: xamanUserToken || null
        })
      });
      const data = await res.json();

      if (data.success && data.store) {
  setStore(data.store);
  setStoreLogo(data.store.logo_url || null);
  console.log('üîç Normal flow - Logo URL:', data.store.logo_url);
  safeSetItem('storeData', JSON.stringify(data.store));
  setNewSecret(null);
  if (data.store.commission_rates) setCommissionRates(data.store.commission_rates);
        setStep('dashboard');
        setClaimToken(null);
        setClaimStore(null);
        setLoading(false);
        return;
      } else {
        setError(data.error || 'Failed to claim store');
      }
    }

    // Normal flow - check if wallet has existing store
    const res = await fetch(`${API_URL}/store/by-wallet/${wallet}`);
    const data = await res.json();

    if (data.success && data.store) {
  setStore(data.store);
  setStoreLogo(data.store.logo_url || null);
  safeSetItem('storeData', JSON.stringify(data.store));
  setNewSecret(null);
      if (data.store.commission_rates) setCommissionRates(data.store.commission_rates);
      if (data.store.daily_limit) setDailyLimit(data.store.daily_limit);
      if (data.store.auto_sign_max_single_payout) setMaxSinglePayout(data.store.auto_sign_max_single_payout);

      // If we have a wordpress_return in URL/session, save it to Firebase
      const wpReturn = new URLSearchParams(window.location.search).get('wordpress_return') 
        || safeGetItem('wordpress_return');
      
      if (wpReturn && !data.store.platform_return_url) {
        await fetch(`${API_URL}/store/set-platform-return`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: data.store.store_id,
            wallet_address: wallet,
            platform_return_url: wpReturn,
            platform_type: 'wordpress'
          })
        });
        data.store.platform_return_url = wpReturn;
        data.store.platform_type = 'wordpress';
        setStore({ ...data.store, platform_return_url: wpReturn, platform_type: 'wordpress' });
        setStoreLogo(data.store.logo_url || null);
      }

      // Save Xaman connection for existing store
      if (type === 'xaman' && xamanUserToken) {
        await fetch(`${API_URL}/store/save-xaman-wallet`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: data.store.store_id,
            wallet_address: wallet,
            xaman_user_token: xamanUserToken
          })
        });
        data.store.xaman_connected = true;
        data.store.xaman_user_token = xamanUserToken;
      }

      setStep('dashboard');
    } else {
      // ========== NEW: Try to link wallet to unclaimed store ==========
      const linkRes = await fetch(`${API_URL}/store/link-wallet`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: wallet,
          wallet_type: type,
          xaman_user_token: xamanUserToken || null
        })
      });
      const linkData = await linkRes.json();

      if (linkData.success && linkData.store) {
        // Store was found and linked!
        setStore(linkData.store);
        setStoreLogo(linkData.store.logo_url || null);
        if (linkData.api_secret) {
          setNewSecret(linkData.api_secret); // Show the new secret to user
        }
        if (linkData.store.commission_rates) setCommissionRates(linkData.store.commission_rates);
        if (linkData.store.daily_limit) setDailyLimit(linkData.store.daily_limit);
        setStep('dashboard');
      } else if (linkData.unclaimed_stores && linkData.unclaimed_stores.length > 0) {
        // Multiple unclaimed stores - for now just show the first one
        // TODO: Could add a store selector UI here
        console.log('Multiple unclaimed stores found:', linkData.unclaimed_stores);
        setStore(null);
        setStep('dashboard');
      } else {
        // No store found at all - show create form
        setStore(null);
        setStep('dashboard');
      }
      // ========== END NEW ==========
    }
  } catch (err) {
    setError('Failed to load store');
  }
  setLoading(false);
};

  const createStore = async (storeName: string, storeUrl: string, email: string, referredBy: string | null = null) => {
    setLoading(true);
    setError(null);

    try {
      const res = await fetch(`${API_URL}/store/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_name: storeName,
          store_url: storeUrl,
          email: email,
          wallet_address: walletAddress,
          wallet_type: walletType,
          xaman_user_token: xamanUserToken,
          referral_code: referredBy
        })
      });

      const data = await res.json();

      if (data.error) {
        setError(data.error);
        setLoading(false);
        return;
      }

      setNewSecret(data.api_secret);
      
      // Clear referral sessionStorage after successful signup
      safeRemoveItem('vendorReferralCode');
      safeRemoveItem('vendorReferringStore');

// Save platform return URL if we came from WordPress
const wpReturn = new URLSearchParams(window.location.search).get('wordpress_return') 
  || safeGetItem('wordpress_return');

const newStore = {
  store_id: data.store_id,
  store_name: storeName,
  store_url: storeUrl,
  api_key: data.api_key,
  store_referral_code: data.store_referral_code,
  wallet_address: walletAddress,
  payout_mode: 'manual',
  auto_signing_enabled: false,
  xaman_connected: walletType === 'xaman',
  crossmark_connected: walletType === 'crossmark',
  web3auth_connected: walletType === 'web3auth',
  platform_return_url: wpReturn || null,
  platform_type: wpReturn ? 'wordpress' : null
};

if (wpReturn) {
  // Save to Firebase
  fetch(`${API_URL}/store/set-platform-return`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      store_id: data.store_id,
      wallet_address: walletAddress,
      platform_return_url: wpReturn,
      platform_type: 'wordpress'
    })
  });
}

setStore(newStore);
setStep('dashboard');
    } catch (err) {
      setError('Failed to create store');
    }
    setLoading(false);
  };

  const regenerateSecret = async () => {
    if (!store || !walletAddress) return;
    if (!confirm('This will invalidate your current secret. Your WordPress plugin and any API integrations will stop working until you update them. Continue?')) return;

    setLoading(true);
    try {
      const res = await fetch(`${API_URL}/store/regenerate-secret`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress
        })
      });

      const data = await res.json();
      if (data.error) {
        setError(data.error);
      } else {
        setNewSecret(data.api_secret);
        setSecretRevealed(false);
        setSecretSaved(false);
      }
    } catch (err) {
      setError('Failed to regenerate secret');
    }
    setLoading(false);
  };

  const saveSettings = async () => {
    if (!store || !walletAddress) return;
    setSavingSettings(true);

    try {
      const res = await fetch(`${API_URL}/store/settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress,
          commission_rates: commissionRates,
          daily_limit: dailyLimit,
          auto_sign_max_single_payout: maxSinglePayout
        })
      });

      const data = await res.json();
      if (data.error) {
        setError(data.error);
      } else {
        setSettingsSaved(true);
        setStore({ ...store, commission_rates: commissionRates, daily_limit: dailyLimit, auto_sign_max_single_payout: maxSinglePayout });
      }
    } catch (err) {
      setError('Failed to save settings');
    }
    setSavingSettings(false);
  };

  // =========================================================================
  // XAMAN LOGIN
  // =========================================================================
  const loginXaman = async () => {
    setStep('xaman');
    setError(null);

    try {
      const res = await fetch(`${API_URL}/xaman/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await res.json();
      if (data.error) {
        setError(data.error);
        setStep('login');
        return;
      }

      setXamanQR(data.qr_png);
      setXamanDeepLink(data.deep_link);
      setLoginId(data.login_id);
      setPolling(true);
    } catch (err) {
      setError('Failed to connect');
      setStep('login');
    }
  };

  // =========================================================================
  // DISCONNECT WALLET
  // =========================================================================
  const disconnectWallet = async () => {

    setLoading(true);
    try {
      // For Web3Auth, also logout from Web3Auth
      if (walletType === 'web3auth') {
        try {
          const { logoutWeb3Auth } = await import('@/lib/web3auth');
          await logoutWeb3Auth();
        } catch (e) {
          console.error('Web3Auth logout error:', e);
        }
      }

      const res = await fetch(`${API_URL}/store/disconnect-wallet`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress
        })
      });

      const data = await res.json();
      if (data.success) {
  setStore({ ...store, wallet_address: null, xaman_connected: false, crossmark_connected: false, web3auth_connected: false, payout_mode: 'manual', auto_signing_enabled: false });
  setWalletAddress(null);
  setWalletType(null);
  setWalletStatus(null);
  setCustomerAutoSignEnabled(false);
  safeRemoveItem('vendorWalletAddress');
  safeRemoveItem('vendorLoginMethod');
} else {
  setError(data.error || 'Failed to disconnect');
}
    } catch (err) {
      setError('Failed to disconnect wallet');
    }
    setLoading(false);
  };

  // =========================================================================
  // SIGN OUT (full logout)
  // =========================================================================
  const signOut = async () => {
    // Clear Web3Auth session if applicable
    if (walletType === 'web3auth') {
      try {
        const { logoutWeb3Auth } = await import('@/lib/web3auth');
        await logoutWeb3Auth();
      } catch (e) {
        console.error('Web3Auth logout error:', e);
      }
    }
    
    // Clear session storage
    safeRemoveItem('vendorWalletAddress');
    safeRemoveItem('vendorLoginMethod');
    
    // Reset state
    setWalletAddress(null);
    setWalletType(null);
    setStore(null);
    setStep('login');
  };

  // =========================================================================
  // AUTO-SIGN SETUP (Crossmark)
  // =========================================================================
  const setupAutoSign = async () => {
  console.log('setupAutoSign called, walletType:', walletType);
  if (!store || !walletAddress) return;

    const sdk = (window as any).xrpl?.crossmark;
    if (!sdk) {
      setError('Crossmark wallet not detected.');
      return;
    }
    console.log('Crossmark SDK found');

    setSettingUpAutoSign(true);
    setError(null);

    try {
      // Use existing wallet address - no need to sign in again
      const address = walletAddress;
      console.log('Address:', address);

      // Check if wallet needs RLUSD setup
      const walletStatusRes = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${address}`);
      const walletStatusData = await walletStatusRes.json();
      
      if (walletStatusData.success && walletStatusData.funded && !walletStatusData.rlusd_trustline) {
        console.log('Setting up RLUSD for wallet via Crossmark...');
        
        await sdk.methods.signAndSubmitAndWait({
          TransactionType: 'TrustSet',
          Account: address,
          LimitAmount: {
            currency: '524C555344000000000000000000000000000000',
            issuer: 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De',
            value: '1000000',
          },
        });
        
        console.log('RLUSD enabled successfully via Crossmark');
setMilestone('trustline_set');
// Wait for ledger
await new Promise(resolve => setTimeout(resolve, 2000));
      }

      // Get platform signer address from API
      const settingsRes = await fetch(`${API_URL}/xaman/setup-autosign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ store_id: store.store_id })
      });
      const settingsData = await settingsRes.json();
      console.log('Settings data:', settingsData);

      if (settingsData.error) {
        throw new Error(settingsData.error);
      }

      // If signer already exists, go straight to verification
      if (settingsData.signer_exists) {
        const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
        const verifyData = await verifyRes.json();
        
        if (verifyData.auto_signing_enabled) {
          setStore({
            ...store,
            payout_mode: 'auto',
            auto_signing_enabled: true,
            crossmark_connected: true,
            daily_limit: dailyLimit,
            auto_sign_max_single_payout: maxSinglePayout
          });
          setMilestone('auto_sign_enabled');
          setAutoSignTermsAccepted(false);
          setSettingUpAutoSign(false);
          // Refresh wallet status to update UI
          await refreshWalletStatus();
          return;
        }
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) {
        throw new Error('Platform signer not configured');
      }

      // Build and sign SignerListSet transaction with Crossmark
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: address,
        SignerQuorum: 1,
        SignerEntries: [
          {
            SignerEntry: {
              Account: platformSignerAddress,
              SignerWeight: 1
            }
          }
        ]
      };

      console.log('About to sign tx:', signerListSetTx);
let signResult;
try {
  signResult = await sdk.methods.signAndSubmitAndWait({
    TransactionType: 'SignerListSet',
    Account: address,
    SignerQuorum: 1,
    SignerEntries: [
      {
        SignerEntry: {
          Account: platformSignerAddress,
          SignerWeight: 1
        }
      }
    ]
  });
  console.log('Sign result:', signResult);
} catch (signError) {
  console.error('Sign error:', signError);
  throw signError;
}

      // Verify the setup
      const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
      const verifyData = await verifyRes.json();

      if (!verifyData.auto_signing_enabled) {
        throw new Error('Signer setup failed. Please try again.');
      }

      // Update store settings with limits
      await fetch(`${API_URL}/store/settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: address,
          daily_limit: dailyLimit,
          auto_sign_max_single_payout: maxSinglePayout
        })
      });

      setStore({
  ...store,
  payout_mode: 'auto',
  auto_signing_enabled: true,
  wallet_address: address,
  crossmark_connected: true,
  xaman_connected: false,
  web3auth_connected: false,
  daily_limit: dailyLimit,
  auto_sign_max_single_payout: maxSinglePayout
});
setMilestone('auto_sign_enabled');
await refreshWalletStatus();
      setWalletAddress(address);
      setWalletType('crossmark');
      safeSetItem('vendorWalletAddress', address);
      safeSetItem('vendorLoginMethod', 'crossmark');
      setAutoSignTermsAccepted(false);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to enable auto-sign';
      setError(message);
    }
    setSettingUpAutoSign(false);
  };

  // =========================================================================
  // AUTO-SIGN SETUP (Web3Auth) - Signs SignerListSet via Web3Auth
  // =========================================================================
  const setupAutoSignWeb3Auth = async () => {
  if (!store || !walletAddress) return;

  setSettingUpAutoSign(true);
  setError(null);

  try {
    const { getWeb3Auth } = await import('@/lib/web3auth');
    const web3auth = await getWeb3Auth();
    
    if (!web3auth || !web3auth.provider) {
      throw new Error('Web3Auth session not available. Please sign in again.');
    }

    // Check if wallet needs RLUSD setup
    const walletStatusRes = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${walletAddress}`);
    const walletStatusData = await walletStatusRes.json();
    
    if (walletStatusData.success && walletStatusData.funded && !walletStatusData.rlusd_trustline) {
      // POSITIVE MESSAGE instead of just console.log
      setError(null);
      setSetupProgress('Setting up RLUSD trustline... (1/2)');
      
      const trustlineTx = {
        TransactionType: 'TrustSet',
        Account: walletAddress,
        LimitAmount: {
          currency: '524C555344000000000000000000000000000000',
          issuer: 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De',
          value: '1000000',
        },
      };
      
      await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: trustlineTx },
      });
      
      setSetupProgress('RLUSD enabled ‚úì Now confirm Auto-Pay... (2/2)');
setMilestone('trustline_set');
await new Promise(resolve => setTimeout(resolve, 2000));
    }

    // Get platform signer address from API
    const settingsRes = await fetch(`${API_URL}/xaman/setup-autosign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ store_id: store.store_id })
    });
    const settingsData = await settingsRes.json();
    
    if (settingsData.error) {
      throw new Error(settingsData.error);
    }

    // Handle unfunded wallet
    if (settingsData.needs_funding) {
      setWalletNeedsFunding(true);
      setSettingUpAutoSign(false);
      setSetupProgress(null);
      return;
    }

    // If signer already exists, just verify
    if (settingsData.signer_exists) {
      const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
      const verifyData = await verifyRes.json();
      
      if (verifyData.auto_signing_enabled) {
        setStore({
          ...store,
          payout_mode: 'auto',
          auto_signing_enabled: true,
          daily_limit: dailyLimit,
          auto_sign_max_single_payout: maxSinglePayout
        });
        setAutoSignTermsAccepted(false);
        setSettingUpAutoSign(false);
        setSetupProgress(null);
        await refreshWalletStatus();
        return;
      }
    }

    const platformSignerAddress = settingsData.platform_signer_address;
    if (!platformSignerAddress) {
      throw new Error('Platform signer not configured');
    }

    // POSITIVE MESSAGE before SignerList
    setSetupProgress('Confirm Auto-Pay in your wallet...');

    const signerListSetTx = {
      TransactionType: 'SignerListSet',
      Account: walletAddress,
      SignerQuorum: 1,
      SignerEntries: [
        {
          SignerEntry: {
            Account: platformSignerAddress,
            SignerWeight: 1
          }
        }
      ]
    };

    await web3auth.provider.request({
      method: 'xrpl_submitTransaction',
      params: { transaction: signerListSetTx }
    });

    setSetupProgress('Verifying setup...');

    // Retry verification up to 5 times with increasing delays
    let verified = false;
    for (let attempt = 1; attempt <= 5; attempt++) {
      await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
      
      const verifyRes = await fetch(`${API_URL}/xaman/verify-autosign?store_id=${store.store_id}`);
      const verifyData = await verifyRes.json();
      
      if (verifyData.auto_signing_enabled) {
        verified = true;
        break;
      }
      
      if (attempt < 5) {
        setSetupProgress(`Confirming on XRPL... (attempt ${attempt + 1}/5)`);
      }
    }

    if (!verified) {
      throw new Error('Signer setup failed. Please try again.');
    }

    // Update store settings
    await fetch(`${API_URL}/store/settings`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: store.store_id,
        wallet_address: walletAddress,
        daily_limit: dailyLimit,
        auto_sign_max_single_payout: maxSinglePayout
      })
    });

    // SUCCESS - update state immediately (no manual refresh needed)
setStore({
  ...store,
  payout_mode: 'auto',
  auto_signing_enabled: true,
  daily_limit: dailyLimit,
  auto_sign_max_single_payout: maxSinglePayout
});
setMilestone('auto_sign_enabled');
setAutoSignTermsAccepted(false);
setSetupProgress(null);
await refreshWalletStatus();

  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : 'Failed to enable auto-sign';
    setError(message);
    setSetupProgress(null);
  }
  setSettingUpAutoSign(false);
};

  // =========================================================================
  // REVOKE AUTO-SIGN
  // =========================================================================
  const revokeAutoSign = async () => {
  if (!confirm('Disable auto-signing? You will need to manually approve each payout.')) return;

  setLoading(true);
  setError(null);
  
  try {
    // Step 1: Get revoke status from API
    const res = await fetch(`${API_URL}/store/revoke-autosign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: store.store_id,
        wallet_address: walletAddress
      })
    });

    const data = await res.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to revoke');
    }

    // Already revoked
    if (data.already_revoked) {
      setStore({ ...store, payout_mode: 'manual', auto_signing_enabled: false });
setCustomerAutoSignEnabled(false);
      // Clear success flag so wizard can show success again when re-enabled
      if (walletAddress) {
        localStorage.removeItem(`onboarding_success_shown_vendor_${walletAddress}`);
        safeSetItem(`onboarding_active_vendor_${walletAddress}`, 'true');
      }
      setLoading(false);
      return;
    }

    // Step 2: Sign transaction to remove signer from XRPL
    if (data.needs_signature) {
      const revokeTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 0,
      };

      let result;
      
      if (walletType === 'crossmark') {
        // Use Crossmark SDK
        const sdk = (window as any).xrpl?.crossmark;
        if (!sdk) {
          throw new Error('Crossmark wallet not detected.');
        }
        result = await sdk.methods.signAndSubmitAndWait(revokeTx);
      } else {
        // Use Web3Auth
        const { getWeb3Auth } = await import('@/lib/web3auth');
        const web3auth = await getWeb3Auth();

        if (!web3auth || !web3auth.provider) {
          throw new Error('Web3Auth session expired. Please sign in again.');
        }

        result = await web3auth.provider.request({
          method: 'xrpl_submitTransaction',
          params: { transaction: revokeTx }
        });
      }

      // Step 3: Confirm with backend
      await fetch(`${API_URL}/store/confirm-revoke`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: store.store_id,
          wallet_address: walletAddress,
          tx_hash: (result as any)?.result?.hash || (result as any)?.hash || null
        })
      });

      await new Promise(resolve => setTimeout(resolve, 2000));
    }

    setStore({ ...store, payout_mode: 'manual', auto_signing_enabled: false });
setCustomerAutoSignEnabled(false);
    // Clear success flag so wizard can show success again when re-enabled
    if (walletAddress) {
      localStorage.removeItem(`onboarding_success_shown_vendor_${walletAddress}`);
      safeSetItem(`onboarding_active_vendor_${walletAddress}`, 'true');
    }
    
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : 'Failed to revoke auto-sign';
    setError(message);
  }
  setLoading(false);
};

  // =========================================================================
  // PERMANENTLY DELETE STORE
  // =========================================================================
  const deleteStore = async () => {
  setDeleting(true);
  try {
    const res = await fetch(`${API_URL}/store/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: store.store_id,
        wallet_address: walletAddress,
        confirm: 'PERMANENTLY DELETE'
      })
    });

    const data = await res.json();
    if (data.success) {
      safeRemoveItem('vendorWalletAddress');
      safeRemoveItem('vendorLoginMethod');
      safeRemoveItem('socialProvider');
      window.location.href = '/dashboard';
    } else {
      setError(data.error || 'Failed to delete');
      setShowDeleteModal(false);
    }
  } catch (err) {
    setError('Failed to delete store');
    setShowDeleteModal(false);
  }
  setDeleting(false);
};

  const copyToClipboard = (text: string, field: string) => {
    navigator.clipboard.writeText(text);
    setCopied(field);
    setTimeout(() => setCopied(null), 2000);
  };

  const SocialIcon = ({ provider }: { provider: string | null }) => {
    switch (provider) {
      case 'github':

// MARK: - Main Render
        return (
          <div className="w-8 h-8 bg-[#24292e] rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </div>
        );
      case 'twitter':
        return (
          <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
            <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </div>
        );
      case 'discord':
        return (
          <div className="w-8 h-8 bg-[#5865F2] rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
          </div>
        );
      case 'facebook':
        return (
          <div className="w-8 h-8 bg-[#1877F2] rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </div>
        );
      case 'apple':
        return (
          <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
          </div>
        );
      case 'google':
      default:
        return (
          <div className="w-8 h-8 bg-white rounded-lg flex items-center justify-center">
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
          </div>
        );
    }
  };

  // =========================================================================
  // LOGIN SCREEN
  // =========================================================================
  if (step === 'login') {
    return (
      <>
        <LoginScreen 
          onLogin={(wallet, method, extras) => {
setWalletAddress(wallet);
setWalletType(method);
if (extras?.xamanUserToken) setXamanUserToken(extras.xamanUserToken);
if (extras?.socialProvider) setSocialProvider(extras.socialProvider);
safeSetItem('vendorWalletAddress', wallet);
safeSetItem('vendorLoginMethod', method);
if (extras?.socialProvider) safeSetItem('socialProvider', extras.socialProvider);
loadOrCreateStore(wallet, method, extras?.xamanUserToken);
          }}
requireTrustline={true}
claimStore={claimStore}
referringStore={referringStore}
storagePrefix="vendor"
title="Partners Dashboard"
subtitle="Sign in to manage your affiliate commissions"
showLogo={true}
/>
      </>
    );
  }

  // =========================================================================
  // XAMAN QR SCREEN
  // =========================================================================
  if (step === 'xaman') {
return (
<div className="min-h-screen bg-transparent text-white font-sans relative z-10">
<main className="max-w-xl mx-auto px-6 py-16">
<button onClick={() => {
  setPolling(false);
  if (store) {
    setStep('dashboard');
  } else {
    setStep('login');
  }
}} className="text-zinc-500 text-sm hover:text-white mb-8">
‚Üê Back
</button>

          <h1 className="text-3xl font-bold mb-2">Scan with Xaman</h1>
          <p className="text-zinc-400 mb-8">Open your Xaman app and scan the QR code</p>

          <div className="text-center">
            <div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-8 mb-6">
              {xamanQR ? (
                <>
                  <img src={xamanQR} alt="Xaman QR" className="mx-auto mb-4 rounded-lg" />
                  <div className="flex items-center justify-center gap-2 text-zinc-500 text-sm mb-4">
                    <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    Waiting for signature...
                  </div>
                  {xamanDeepLink && (
                    <a
                      href={xamanDeepLink}
                      className="inline-block bg-blue-500 hover:bg-blue-400 text-white px-6 py-2 rounded-lg transition"
                    >
                      Open Xaman App
                    </a>
                  )}
                </>
              ) : (
                <div className="flex items-center justify-center gap-2 text-zinc-500">
                  <span className="w-4 h-4 border-2 border-zinc-500 border-t-white rounded-full animate-spin"></span>
                  Loading...
                </div>
              )}
            </div>
          </div>
        </main>
      </div>
    );
  }
// =========================================================================
  // DASHBOARD - Navigation items for sidebar
  // =========================================================================
  const navItems = [
  { 
    id: 'take-payment', 
    label: 'Take Payment', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
      </svg>
    ),
    onClick: () => router.push('/take-payment')
  },
  { 
    id: 'signup-customer', 
    label: 'Sign Up Customer', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
      </svg>
    )
  },
  { 
    id: 'wallet-funding', 
    label: 'Top Up Wallet', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m6-6H6" />
      </svg>
    ),
    show: !walletNeedsFunding && !walletNeedsTrustline
  },
  { 
    id: 'withdraw', 
    label: 'Balance/Withdraw', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
      </svg>
    ),
    show: !walletNeedsFunding && !walletNeedsTrustline
  },
  { 
    id: 'payout-method', 
    label: 'Payout Method', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
      </svg>
    )
  },
  { 
    id: 'pending-customers', 
    label: 'Pending Customers', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
      </svg>
    )
  },
  { 
  id: 'earn-interest', 
  label: (
    <span className="flex items-center gap-2">
      Earn Interest
      <span className="bg-indigo-500/20 text-indigo-400 text-[10px] px-1.5 py-0.5 rounded-full">Soon</span>
    </span>
  ),
  icon: (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
    </svg>
  )
},
  { 
    id: 'auto-sign', 
    label: 'Auto-Sign', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
      </svg>
    ),
    show: !store?.auto_signing_enabled
  },
  { 
    id: 'commission-rates', 
    label: 'Commission Rates', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
      </svg>
    )
  },
  { 
    id: 'affiliate-link', 
    label: 'Affiliate Link', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
      </svg>
    )
  },
  { 
    id: 'api-credentials', 
    label: 'API Credentials', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
      </svg>
    )
  },
  { 
    id: 'return-wordpress', 
    label: 'Return to Site', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
      </svg>
    ),
    show: !!store?.platform_return_url
  },
  { 
    id: 'quick-links', 
    label: 'Quick Links', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
      </svg>
    )
  },
  { 
    id: 'activity', 
    label: 'Activity', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
      </svg>
    )
  },
  { 
    id: 'danger-zone', 
    label: 'Danger Zone', 
    icon: (
      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
      </svg>
    )
  },
].filter(item => item.show !== false);
// =========================================================================
// DASHBOARD
// =========================================================================
return (
<>
<NebulaBackground opacity={0.2} />
<DashboardHeader
  dashboardType="vendor"
  walletAddress={walletAddress || undefined}
  storeId={store?.store_id}
  onSignOut={signOut}
  allMilestonesComplete={allMilestonesComplete}
  setupComplete={setupComplete}
/>
<VendorDashboardTour
  run={runTour} 
  onComplete={() => {
    setRunTour(false);
    if (store?.store_id) {
      localStorage.setItem(`vendor_tour_completed_${store.store_id}`, 'true');
    }
  }}
/>
    <div className="min-h-screen bg-transparent text-white font-sans relative z-0 overflow-x-hidden">
      <Script src="https://unpkg.com/@aspect-dev/crossmark-sdk@1.0.5/dist/umd/index.js" />

      {/* Celebration Toast */}
  {celebrateMilestone && (
    <CelebrationToast
      milestone={celebrateMilestone}
      onClose={() => setCelebrateMilestone(null)}
    />
  )}

  {/* Info Modal */}
{activeInfo && getContent() && (
  <InfoModal
    content={getContent()!}
    isOpen={!!activeInfo}
    onClose={closeInfo}
  />
)}

      <Sidebar
  isOpen={sidebarOpen}
  isCollapsed={sidebarCollapsed}
  onToggleOpen={() => setSidebarOpen(!sidebarOpen)}
  onToggleCollapsed={() => setSidebarCollapsed(!sidebarCollapsed)}
  storeName={store?.store_name}
  storeLogo={storeLogo}
  walletAddress={walletAddress}
  navItems={navItems}
  onNavClick={handleNavClick}
  onLogoClick={() => setShowLogoUpload(true)}
  onSignOut={signOut}
  onTakeTour={() => {
  setSidebarOpen(false);
  window.scrollTo({ top: 0, behavior: 'smooth' });
  setRunTour(false);
  setTimeout(() => setRunTour(true), 100);
}}
  onInfoClick={openInfo}
  onShowProgress={() => {
    if (store?.store_id) {
      localStorage.removeItem(`milestones_dismissed_${store.store_id}`);
      setProgressHidden(false);
    }
  }}
/>

{/* Logo Upload Modal */}
{showLogoUpload && (
  <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
    <div className="bg-zinc-900/95 rounded-2xl p-6 w-full max-w-sm">
      <h3 className="text-lg font-bold mb-4">Store Logo</h3>
      {storeLogo && (
        <div className="mb-4 flex justify-center">
          <img src={storeLogo} alt="Current logo" className="w-24 h-24 rounded-xl object-cover" />
        </div>
      )}
      <label className="block mb-4">
        <div className="bg-zinc-800/90 border-2 border-dashed border-zinc-700 hover:border-emerald-500 rounded-xl p-6 text-center cursor-pointer transition">
          {uploadingLogo ? (
            <div className="flex flex-col items-center">
              <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mb-2"></div>
              <p className="text-zinc-400 text-sm">Uploading...</p>
            </div>
          ) : (
            <>
              <svg className="w-8 h-8 text-zinc-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p className="text-zinc-400 text-sm">Click to upload image</p>
              <p className="text-zinc-600 text-xs mt-1">Max 5MB</p>
            </>
          )}
        </div>
        <input
          type="file"
          accept="image/*"
          onChange={handleLogoUpload}
          className="hidden"
          disabled={uploadingLogo}
        />
      </label>
      <div className="flex gap-3">
        {storeLogo && (
          <button
            onClick={removeLogo}
            disabled={uploadingLogo}
            className="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-3 rounded-xl transition disabled:opacity-50"
          >
            Remove
          </button>
        )}
        <button
          onClick={() => setShowLogoUpload(false)}
          className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 py-3 rounded-xl transition"
        >
          {storeLogo ? 'Done' : 'Cancel'}
        </button>
      </div>
    </div>
  </div>
)}

      {/* Main Content */}
<main className={`min-h-screen pt-2 lg:pt-0 transition-all duration-300 ${sidebarCollapsed ? 'lg:ml-0' : 'lg:ml-64'}`}>
        <div className="max-w-3xl lg:max-w-none mx-auto px-3 sm:px-6 lg:px-4 pt-20 pb-4">

        {error && (
  error.includes('beta') || error.includes('full') || error.includes('waitlist') ? (
    <div className="bg-gradient-to-b from-sky-900/50 to-slate-900/50 border border-sky-500/30 rounded-xl p-6 mb-6">
      <div className="text-center">
        
        {/* Professional Shield Icon */}
        <div className="w-16 h-16 mx-auto mb-4 bg-sky-500/20 rounded-full flex items-center justify-center">
          <svg className="w-8 h-8 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
          </svg>
        </div>
        
        <h3 className="text-xl font-bold text-sky-400 mb-2">Beta is Full!</h3>
        <p className="text-sky-200/70 mb-6">We're at capacity right now, but we'd love to have you join when spots open up.</p>
        
        <form onSubmit={async (e) => {
          e.preventDefault();
          const form = e.target as HTMLFormElement;
          const email = (form.elements.namedItem('waitlistEmail') as HTMLInputElement).value;
          try {
            await fetch('https://api.dltpays.com/api/v1/waitlist', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, source: 'beta_full' })
            });
            setError(null);
            alert('Thanks! We\'ll notify you when a spot opens up.');
          } catch (err) {
            alert('Failed to join waitlist. Please try again.');
          }
        }} className="max-w-sm mx-auto">
          <input
            name="waitlistEmail"
            type="email"
            required
            placeholder="your@email.com"
            className="w-full bg-slate-800/50 border border-sky-500/30 rounded-lg px-4 py-3 text-white placeholder-slate-400 mb-3 focus:outline-none focus:border-sky-400 transition-all"
          />
          <button type="submit" className="w-full bg-sky-500 hover:bg-sky-400 text-white font-semibold py-3 rounded-lg transition shadow-lg shadow-sky-500/25">
            Join Waitlist
          </button>
        </form>
        
        <button onClick={() => setError(null)} className="text-slate-400 text-sm mt-4 hover:text-white transition-colors">
          Dismiss
        </button>
      </div>
    </div>
  ) : (
            <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
              <p className="text-red-400 text-sm">{error}</p>
              <button onClick={() => setError(null)} className="text-red-400 text-xs mt-2 hover:underline">Dismiss</button>
            </div>
          )
        )}

        {/* No store yet - show create form */}
        {!store && (
          <div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-8">
            <h2 className="text-xl font-bold mb-6">Sign Up</h2>

            {/* Show referral banner in registration form */}
            {referringStore && (
              <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mb-6">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-blue-400">üéÅ</span>
                  <span className="text-blue-400 font-medium">Referred by {referringStore.store_name}</span>
                </div>
                <p className="text-zinc-400 text-sm">50% off platform fees for your first month!</p>
              </div>
            )}

            <form onSubmit={async (e) => {
              e.preventDefault();
              const form = e.target as HTMLFormElement;

              // Determine the referring store - either from state, sessionStorage, or manual input
              let finalReferrer = referringStore;
              if (!finalReferrer) {
                const cachedReferrer = safeGetItem('vendorReferringStore');
                if (cachedReferrer) {
                  finalReferrer = JSON.parse(cachedReferrer);
                }
              }

              // If user entered a referral code manually, look it up first
              const manualRef = (form.elements.namedItem('referralCode') as HTMLInputElement)?.value?.trim();
              if (manualRef && !finalReferrer) {
                try {
                  const res = await fetch(`${API_URL}/store/lookup-referral/${manualRef}?_t=${Date.now()}`, { cache: 'no-store' });
                  const data = await res.json();
                  if (data.success && data.store) {
                    finalReferrer = data.store;
                    setReferringStore(data.store);
                  }
                } catch (err) {
                  console.error('Referral lookup failed:', err);
                }
              }

              // Get referral code from URL, sessionStorage, or manual input
              const refCode = new URLSearchParams(window.location.search).get('ref') 
                || safeGetItem('vendorReferralCode')
                || (form.elements.namedItem('referralCode') as HTMLInputElement)?.value?.trim()
                || null;
              
              createStore(
                (form.elements.namedItem('storeName') as HTMLInputElement).value,
                (form.elements.namedItem('storeUrl') as HTMLInputElement).value,
                (form.elements.namedItem('email') as HTMLInputElement).value,
                refCode
              );
            }}>
              <div className="space-y-4">
                <div>
                  <label className="text-zinc-400 text-sm block mb-2">Name</label>
                  <input name="storeName" required className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white" placeholder="My Store" />
                </div>
                <div>
                  <label className="text-zinc-400 text-sm block mb-2">Website URL</label>
                  <input name="storeUrl" type="url" required className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white" placeholder="https://mystore.com" />
                </div>
                <div>
                  <label className="text-zinc-400 text-sm block mb-2">Email</label>
                  <input name="email" type="email" required className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white" placeholder="you@example.com" />
                </div>

                {/* Referral code input - only show if not already referred */}
                {!referringStore && (
                  <div>
                    <label className="text-zinc-400 text-sm block mb-2">Referral Code <span className="text-zinc-600">(optional)</span></label>
                    <input
                      name="referralCode"
                      className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-3 text-white"
                      placeholder="E.g. E73E22E4"
                      defaultValue={referralCode || ''}
                    />
                    <p className="text-zinc-600 text-xs mt-1">Get 50% off your first month's platform fees</p>
                  </div>
                )}
              </div>

              <button type="submit" disabled={loading} className="w-full mt-6 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-3 rounded-lg transition disabled:opacity-50">
                {loading ? 'Creating...' : 'Create Store'}
              </button>
            </form>
          </div>
        )}

        {/* Has store - show dashboard */}
        {store && (
          <div className="space-y-6">

           {/* MILESTONE CHECKLIST */}
{!progressHidden && (
  <MilestoneChecklist 
    key={`${celebrateMilestone}-${progressHidden}`}
    storeId={store.store_id} 
    walletAddress={walletAddress || ''}
    autoSignEnabled={store.auto_signing_enabled}
    onMilestoneAchieved={(milestone) => setCelebrateMilestone(milestone)}
    onInfoClick={openInfo}
    onDismiss={() => setProgressHidden(true)}
  />
)}

{/* Onboarding Setup Wizard - Below Progress Bar */}
{(walletStatus || !walletAddress) && (
  <OnboardingSetup
    walletAddress={walletAddress}
    walletStatus={walletStatus}
    autoSignEnabled={store?.auto_signing_enabled || customerAutoSignEnabled}
    loginMethod={walletType}
    onSetupComplete={() => { setCustomerAutoSignEnabled(true); setSetupComplete(true); }}
    onRefreshWallet={refreshWalletStatus}
    onSetupStatusChange={(isComplete) => setSetupComplete(isComplete)}
    storagePrefix="vendor"
  />
)}

            {/* ============================================================= */}
{/* PAYOUT METHOD STATUS */}
{/* ============================================================= */}
<h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">Wallet</h3>
<div className="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
<div id="payout-method" className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-6 flex flex-col">
  <h2 className="text-lg font-bold mb-4">Payout Method</h2>

  {/* Auto-sign enabled (works same for Web3Auth and Crossmark) */}
  {(store.auto_signing_enabled || customerAutoSignEnabled) ? (
    <div className="space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-zinc-800/90 rounded-lg">
        <div className="flex items-center gap-3">
          {walletType === 'web3auth' ? (
            <SocialIcon provider={socialProvider} />
          ) : (
            <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
          )}
          <div>
            <div className="flex items-center gap-2">
              <span className="text-green-500 text-sm" style={{ textShadow: '0 0 8px rgba(34,197,94,0.9)' }}>‚óè</span>
              <span className="text-green-500 text-sm font-medium">Auto-Sign Active</span>
            </div>
            <p className="text-zinc-500 text-sm font-mono">
              {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
            </p>
          </div>
        </div>
        <button
          onClick={revokeAutoSign}
          disabled={loading}
          className="text-zinc-400 hover:text-red-400 text-sm transition-colors whitespace-nowrap"
        >
          Revoke Auto-Sign
        </button>
      </div>

      {/* Editable Limits */}
      <div className="flex gap-4">
        <div className="flex-1 min-w-0">
          <label className="text-zinc-400 text-xs block mb-1">Max single (USD)</label>
          <input
            type="number"
            min="1"
            max="10000"
            value={maxSinglePayout}
            onChange={(e) => {
              setMaxSinglePayout(parseInt(e.target.value) || 100);
              setSettingsSaved(false);
            }}
            className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
          />
        </div>
        <div className="flex-1 min-w-0">
          <label className="text-zinc-400 text-xs block mb-1">Daily limit (USD)</label>
          <input
            type="number"
            min="10"
            max="50000"
            value={dailyLimit}
            onChange={(e) => {
              setDailyLimit(parseInt(e.target.value) || 1000);
              setSettingsSaved(false);
            }}
            className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
          />
        </div>
      </div>
      {/* End of Editable Limits */}

      {/* Feature Badges */}
      <div className="flex flex-wrap gap-3 mt-6 pt-4 border-t border-zinc-800">
        <div className="flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-3 py-2 flex-1 min-w-[100px]">
          <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
          </svg>
          <div>
            <p className="text-emerald-400 text-xs font-semibold">Instant</p>
            <p className="text-zinc-500 text-[10px]">Sub-second payouts</p>
          </div>
        </div>
        <div className="flex items-center gap-2 bg-sky-500/10 border border-sky-500/20 rounded-lg px-3 py-2 flex-1 min-w-[100px]">
          <svg className="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
          </svg>
          <div>
            <p className="text-sky-400 text-xs font-semibold">Secure</p>
            <p className="text-zinc-500 text-[10px]">XRPL validated</p>
          </div>
        </div>
        <div className="flex items-center gap-2 bg-violet-500/10 border border-violet-500/20 rounded-lg px-3 py-2 flex-1 min-w-[100px]">
          <svg className="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <p className="text-violet-400 text-xs font-semibold">24/7</p>
            <p className="text-zinc-500 text-[10px]">Always available</p>
          </div>
        </div>
      </div>
    </div>
  ) : (walletType === 'web3auth' && !customerAutoSignEnabled) ? (
    /* Web3Auth connected but auto-sign not enabled yet */
    <div className="space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
        <div className="flex items-center gap-3">
          <SocialIcon provider={socialProvider} />
          <div>
            <div className="flex items-center gap-2">
              <span className="text-yellow-500 text-sm" style={{ textShadow: '0 0 8px rgba(234,179,8,0.9)' }}>
                ‚óè
              </span>
              <span className="text-yellow-500 text-sm font-medium">Connected - Setup Required</span>
            </div>
            <p className="text-zinc-500 text-sm font-mono">
              {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
            </p>
          </div>
        </div>
      </div>

      <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
        <p className="text-yellow-400 font-medium">Enable Auto-Sign to process payouts</p>
        <p className="text-zinc-400 text-sm">
          Complete the auto-sign setup below to start paying affiliates automatically.
        </p>
      </div>
    </div>
  ) : store.crossmark_connected && !store.auto_signing_enabled ? (
/* Crossmark connected but auto-sign not enabled */
<div className="space-y-4">
  <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-orange-500/10 border border-orange-500/30 rounded-lg">
    <div className="flex items-center gap-3">
      <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
      <div>
        <div className="flex items-center gap-2">
          <span className="text-orange-500 text-sm" style={{ textShadow: '0 0 8px rgba(249,115,22,0.9)' }}>‚óè</span>
          <span className="text-orange-500 text-sm font-medium">Connected - Enable Auto-Sign</span>
        </div>
        <p className="text-zinc-500 text-sm font-mono">
          {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
        </p>
      </div>
    </div>
    <button
      onClick={disconnectWallet}
      disabled={loading}
      className="text-zinc-400 hover:text-red-400 text-sm transition-colors whitespace-nowrap"
    >
      Disconnect
    </button>
  </div>
  <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
    <p className="text-orange-400 font-medium">Enable Auto-Sign to process payouts</p>
    <p className="text-zinc-400 text-sm">
      Scroll down to enable auto-sign for automatic affiliate payouts.
    </p>
    <button 
      onClick={() => scrollToSection('auto-sign')}
      className="mt-2 text-orange-400 hover:text-orange-300 text-sm underline"
    >
      Go to Auto-Sign Setup ‚Üí
    </button>
  </div>
</div>
) : store.xaman_connected ? (
/* Xaman connected - manual payouts */
    <div className="space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
        <div className="flex items-center gap-3">
          <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded" />
          <div>
            <div className="flex items-center gap-2">
              <span className="text-green-500 text-sm" style={{ textShadow: '0 0 8px rgba(34,197,94,0.9)' }}>‚óè</span>
              <span className="text-green-500 text-sm font-medium">Connection Good</span>
            </div>
            <p className="text-zinc-500 text-sm font-mono">
              {store.wallet_address?.substring(0, 8)}...{store.wallet_address?.slice(-6)}
            </p>
          </div>
        </div>
        <button
          onClick={disconnectWallet}
          disabled={loading}
          className="text-zinc-400 hover:text-red-400 text-sm transition-colors whitespace-nowrap"
        >
          Disconnect
        </button>
      </div>

      <p className="text-zinc-500 text-xs">
        You'll receive a push notification to approve each payout.
      </p>

      {/* Option to switch to auto-sign */}
{false && (
<div className="border-t border-zinc-800 pt-4 mt-4">
  <p className="text-zinc-400 text-sm mb-2">Prefer automatic payouts?</p>
  <p className="text-zinc-500 text-xs">
    Enable auto-sign below to process payouts automatically with Crossmark.
  </p>
</div>
)}
    </div>
  ) : (
    /* No payout method - show options */
    <div className="space-y-4">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-red-500 text-sm" style={{ textShadow: '0 0 8px rgba(239,68,68,0.9)' }}>‚óè</span>
        <span className="text-red-500 text-sm font-medium">No connection</span>
      </div>

      <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
        <p className="text-yellow-400 font-medium">Choose a payout method</p>
        <p className="text-zinc-400 text-sm">Select how you want to pay your affiliates.</p>
      </div>

      {/* Option 1: Social Login (Web3Auth) */}
      <div className="bg-zinc-800/90 border border-zinc-700 hover:border-emerald-500 rounded-xl p-4 transition">
        <div className="flex items-center gap-3 mb-3">
          <div className="flex -space-x-1">
            <div className="w-6 h-6 bg-white rounded-full flex items-center justify-center border border-zinc-600">
              <svg className="w-3 h-3" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
            </div>
            <div className="w-6 h-6 bg-black rounded-full flex items-center justify-center border border-zinc-600">
              <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
              </svg>
            </div>
            <div className="w-6 h-6 bg-zinc-600 rounded-full flex items-center justify-center border border-zinc-500">
              <span className="text-zinc-300 text-[8px] font-bold">+10</span>
            </div>
          </div>
          <div>
            <span className="font-semibold">Social Login</span>
            <span className="ml-2 bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">Easiest</span>
          </div>
        </div>
        <p className="text-zinc-400 text-sm mb-3">
          Get an XRPL wallet instantly. Payouts process automatically 24/7.
        </p>
        <button
          onClick={() => {
            setWeb3authTermsAccepted(true);
            connectGoogle();
          }}
          disabled={connectingGoogle}
          className="w-full bg-white hover:bg-gray-100 text-black font-semibold py-2 rounded-lg transition flex items-center justify-center gap-2"
        >
          {connectingGoogle ? (
            <>
              <span className="w-4 h-4 border-2 border-gray-400 border-t-gray-800 rounded-full animate-spin"></span>
              Connecting...
            </>
          ) : (
            'Connect Social Wallet'
          )}
        </button>
      </div>

      <div className="text-center text-zinc-500 text-sm py-2">‚Äî or ‚Äî</div>

      {/* Option 2: Connect Xaman for manual */}
      <button
        onClick={loginXaman}
        className="w-full bg-zinc-800/90 border border-zinc-700 hover:border-emerald-500 rounded-xl p-4 text-left transition"
      >
        <div className="flex items-center gap-3 mb-2">
          <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded" />
          <span className="font-semibold">Connect Xaman for Manual Payouts</span>
        </div>
        <p className="text-zinc-400 text-sm">
          Approve each payout via push notification on your phone.
        </p>
      </button>

      {/* Option 3: Crossmark - only show if not already connected with Crossmark */}
{walletType !== 'crossmark' && (
<button
onClick={async () => {
          const sdk = (window as any).xrpl?.crossmark;
          if (!sdk) {
            setError('Crossmark wallet not detected.');
            return;
          }
          try {
            const signIn = await sdk.methods.signInAndWait();
            const address = signIn.response?.data?.address;
            if (address) {
  setWalletAddress(address);
  setWalletType('crossmark');
  safeSetItem('vendorWalletAddress', address);
  safeSetItem('vendorLoginMethod', 'crossmark');
  loadOrCreateStore(address, 'crossmark');
}
          } catch (err) {
            console.error('Crossmark error:', err);
          }
        }}
        className="w-full bg-zinc-800/90 border border-zinc-700 hover:border-emerald-500 rounded-xl p-4 text-left transition"
      >
        <div className="flex items-center gap-3 mb-2">
          <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
          <span className="font-semibold">Connect Crossmark</span>
        </div>
        <p className="text-zinc-400 text-sm">
          Browser extension. Enable auto-sign for automatic payouts.
        </p>
</button>
)}
</div>
)}
</div>

{/* ============================================================= */}
{/* WALLET FUNDING (show for Web3Auth wallets that need funding or trustline) */}
{/* ============================================================= */}
{(walletNeedsFunding || walletNeedsTrustline) && walletAddress && (
  <div id="wallet-funding">
  <WalletFunding
  walletAddress={walletAddress}
  walletType={walletType}
  onFunded={() => {
      console.log('Wallet funded!');
      setWalletNeedsFunding(false);
    }}
    onTrustlineSet={() => {
      console.log('Trustline set!');
      setWalletNeedsFunding(false);
      setWalletNeedsTrustline(false);
    }}
  />
  </div>
)}

{/* Show Top-Up and Withdraw components when wallet is ready */}
{(
  <div className="space-y-4">
    {/* TAKE PAYMENT BUTTON */}
    <button
  id="take-payment-btn"
  onClick={() => router.push('/take-payment')}
  className="w-full bg-white hover:bg-zinc-100 text-black font-semibold text-lg py-4 rounded-xl transition flex items-center justify-center gap-3 shadow-lg"
>
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      Take Payment
    </button>

    <CollapsibleSection dashboardType="vendor"
      id="wallet-funding"
      title="Top Up Wallet"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m6-6H6" />
        </svg>
      }
      isOpen={openSections['wallet-funding']}
      onToggle={() => toggleSection('wallet-funding')}
    >
      <TopUpRLUSD
  walletAddress={walletAddress || ''}
  xrpBalance={walletXrpBalance}
  rlusdBalance={walletRlusdBalance}
  showAmounts={showAmounts}
  onToggleAmounts={() => setShowAmounts(!showAmounts)} 
  onRefresh={refreshWalletStatus}
  walletType={walletType}
/>
    </CollapsibleSection>

    <CollapsibleSection dashboardType="vendor"
      id="withdraw"
      title="Balance | Withdraw"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
        </svg>
      }
      isOpen={openSections['withdraw']}
      onToggle={() => toggleSection('withdraw')}
    >
      <WithdrawRLUSD
        walletAddress={walletAddress || ''}
        rlusdBalance={walletRlusdBalance}
        showAmounts={showAmounts}
        onToggleAmounts={() => setShowAmounts(!showAmounts)}
        onRefresh={refreshWalletStatus}
        onSuccess={() => {
          fetch(`${API_URL}/wallet/status/${walletAddress}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                setWalletXrpBalance(data.xrp_balance || 0);
                setWalletRlusdBalance(data.rlusd_balance || 0);
              }
            });
        }}
      />
    </CollapsibleSection>

    {/* QUICK LINKS POS */}
<div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-4">
  <p className="text-zinc-500 text-xs uppercase tracking-wider mb-3">Quick Links</p>
  <div className="grid grid-cols-5 gap-2">
    <button
      onClick={() => router.push('/take-payment')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Payment</span>
    </button>
    <button
      onClick={() => router.push('/analytics')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Analytics</span>
    </button>
    <button
      onClick={() => router.push('/receipts')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Receipts</span>
    </button>
    <button
      onClick={() => window.open(`/display?store=${store.store_id}`, '_blank')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Display</span>
    </button>
    <button
      onClick={() => router.push('/staff')}
      className="group flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-zinc-800/90 transition"
    >
      <svg className="w-5 h-5 text-zinc-400 group-hover:text-emerald-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <span className="text-zinc-500 text-xs group-hover:text-emerald-400 transition">Staff</span>
    </button>
  </div>
</div>
  </div>
)}
</div>

            {/* ============================================================= */}
{/* AUTO-SIGN SETUP (show if auto-sign not enabled yet - NOT for Xaman) */}
{/* ============================================================= */}
{!store.auto_signing_enabled && walletType !== 'xaman' && (
  <div id="auto-sign" className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-6">
    <h2 className="text-lg font-bold mb-4">Enable Auto-Sign</h2>
                <p className="text-zinc-400 text-sm mb-4">
                  Process affiliate payouts automatically without manual approval for each transaction.
                </p>

                {/* Security Notice */}
                <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4 mb-4">
                  <p className="text-orange-400 text-sm font-bold mb-2">‚ö†Ô∏è Security Notice</p>
                  <p className="text-orange-300/90 text-sm mb-3">
                    Auto-sign allows YesAllofUs to sign RLUSD transactions from your wallet
                    automatically, without requiring manual approval for each payout.
                  </p>
                  <p className="text-orange-300/80 text-sm mb-3">
                    While we take every precaution to secure our systems, there is always inherent risk
                    when granting signing permissions. We recommend:
                  </p>
                  <ul className="text-orange-300/80 text-xs space-y-1">
                    <li>‚Ä¢ Keep only 1-2 days worth of expected commissions in this wallet</li>
                    <li>‚Ä¢ Set a conservative daily limit below</li>
                    <li>‚Ä¢ Top up regularly rather than storing large balances</li>
                  </ul>
                </div>

                {/* Limits */}
                <div className="flex gap-4 mb-4">
                  <div className="flex-1 min-w-0">
                    <label className="text-zinc-400 text-xs block mb-1">Max single (USD)</label>
                    <input
                      type="number"
                      min="1"
                      max="10000"
                      value={maxSinglePayout}
                      onChange={(e) => setMaxSinglePayout(parseInt(e.target.value) || 100)}
                      className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
                    />
                  </div>
                  <div className="flex-1 min-w-0">
                    <label className="text-zinc-400 text-xs block mb-1">Daily limit (USD)</label>
                    <input
                      type="number"
                      min="10"
                      max="50000"
                      value={dailyLimit}
                      onChange={(e) => setDailyLimit(parseInt(e.target.value) || 1000)}
                      className="w-full bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white"
                    />
                  </div>
                </div>

                {/* Terms Checkbox */}
                <label className="flex items-start gap-3 p-3 bg-zinc-800/90 rounded-lg cursor-pointer mb-4">
                  <input
                    type="checkbox"
                    checked={autoSignTermsAccepted}
                    onChange={(e) => setAutoSignTermsAccepted(e.target.checked)}
                    className="mt-1"
                  />
                  <span className="text-zinc-300 text-sm">
                    I have read and agree to the{' '}
                    <a href="/terms" target="_blank" className="text-blue-400 hover:underline">Terms & Conditions</a>{' '}
                    for auto-signing.
                  </span>
                </label>

                {/* Setup Button - Web3Auth */}
{walletType === 'web3auth' ? (
  <button
    onClick={setupAutoSignWeb3Auth}
    disabled={!autoSignTermsAccepted || settingUpAutoSign}
    className={`w-full py-3 rounded-lg font-semibold transition ${
      autoSignTermsAccepted
        ? 'bg-blue-500 hover:bg-blue-400 text-white'
        : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
    }`}
  >
    {settingUpAutoSign ? (
  <span className="flex items-center justify-center gap-2">
    <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
    {setupProgress || 'Setting up...'}
  </span>
) : (
      'üîê Sign to Enable Auto-Sign'
    )}
  </button>
) : (
                  <button
                    onClick={setupAutoSign}
                    disabled={!autoSignTermsAccepted || settingUpAutoSign}
                    className={`w-full py-3 rounded-lg font-semibold transition ${
                      autoSignTermsAccepted
                        ? 'bg-blue-500 hover:bg-blue-400 text-white'
                        : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
                    }`}
                  >
                    {settingUpAutoSign ? (
                      <span className="flex items-center justify-center gap-2">
                        <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                        Setting up...
                      </span>
                    ) : (
                      'üîê Sign with Crossmark to Enable Auto-Sign'
                    )}
                  </button>
                )}
              </div>
            )}

{/* CUSTOMERS - SIGN UP + PENDING */}
<h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">Customers</h3>
<div className="grid grid-cols-1 lg:grid-cols-2 gap-4 items-stretch">
  {/* SIGN UP CUSTOMER BUTTON */}
  <SignUpCustomerCard storeId={store.store_id} walletAddress={walletAddress} onSignUp={async () => {
    try {
      await fetch(`${API_URL}/display/${store.store_id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'signup' })
      });
    } catch (err) {
      console.error('Failed to set display status:', err);
    }
    router.push(`/signup-customer?store=${store.store_id}`);
  }} />

  {/* PENDING CUSTOMERS */}
  <div id="pending-customers">
    <PendingCustomers storeId={store.store_id} walletAddress={walletAddress} />
  </div>
</div>

{/* EARN INTEREST */}
<div id="earn-interest">
  <EarnInterest dashboardType="vendor" />
</div>

{/* ============================================================= */}
{/* SETTINGS GROUP */}
{/* ============================================================= */}
<div className="space-y-4">
  <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider px-1">Settings</h3>
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <CollapsibleSection dashboardType="vendor"
      id="commission-rates"
      title="Commission Rates"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
        </svg>
      }
      isOpen={openSections['commission-rates']}
      onToggle={() => toggleSection('commission-rates')}
    >
      <p className="text-zinc-500 text-sm mb-6">Set the percentage affiliates earn on each level.</p>
      <div className="space-y-4">
        {[
          { level: 1, label: 'Direct referral', bgColor: 'bg-emerald-500/20', textColor: 'text-emerald-400', borderColor: 'border-emerald-500/30' },
          { level: 2, label: 'Level 2', bgColor: 'bg-blue-500/20', textColor: 'text-blue-400', borderColor: 'border-blue-500/30' },
          { level: 3, label: 'Level 3', bgColor: 'bg-purple-500/20', textColor: 'text-purple-400', borderColor: 'border-purple-500/30' },
          { level: 4, label: 'Level 4', bgColor: 'bg-orange-500/20', textColor: 'text-orange-400', borderColor: 'border-orange-500/30' },
          { level: 5, label: 'Level 5', bgColor: 'bg-pink-500/20', textColor: 'text-pink-400', borderColor: 'border-pink-500/30' }
        ].map((tier, i) => (
          <div key={tier.level} className="flex items-center gap-4">
            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${tier.bgColor} ${tier.borderColor} border`}>
              <svg className={`w-6 h-6 ${tier.textColor}`} viewBox="0 0 24 24" fill="none" stroke="currentColor">
                {tier.level === 1 && (
                  <>
                    <circle cx="12" cy="8" r="4" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2" />
                  </>
                )}
                {tier.level === 2 && (
                  <>
                    <circle cx="9" cy="7" r="3" strokeWidth={1.5} />
                    <circle cx="15" cy="7" r="3" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 21v-1a4 4 0 014-4h2m12 5v-1a4 4 0 00-4-4h-2" />
                  </>
                )}
                {tier.level === 3 && (
                  <>
                    <circle cx="12" cy="5" r="2.5" strokeWidth={1.5} />
                    <circle cx="6" cy="10" r="2.5" strokeWidth={1.5} />
                    <circle cx="18" cy="10" r="2.5" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 10v4m-6 0v4m12-4v4" />
                  </>
                )}
                {tier.level === 4 && (
                  <>
                    <circle cx="6" cy="6" r="2.5" strokeWidth={1.5} />
                    <circle cx="18" cy="6" r="2.5" strokeWidth={1.5} />
                    <circle cx="6" cy="14" r="2.5" strokeWidth={1.5} />
                    <circle cx="18" cy="14" r="2.5" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M6 8.5v3m12-3v3M8.5 6h7M8.5 14h7" />
                  </>
                )}
                {tier.level === 5 && (
                  <>
                    <circle cx="12" cy="4" r="2" strokeWidth={1.5} />
                    <circle cx="5" cy="9" r="2" strokeWidth={1.5} />
                    <circle cx="19" cy="9" r="2" strokeWidth={1.5} />
                    <circle cx="7" cy="17" r="2" strokeWidth={1.5} />
                    <circle cx="17" cy="17" r="2" strokeWidth={1.5} />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6v2m-5.5 2.5l2 3m7-3l-2 3" />
                  </>
                )}
              </svg>
            </div>
            <span className="text-zinc-400 text-sm w-28">{tier.label}</span>
            <input
              type="number"
              min="0"
              max="100"
              value={commissionRates[i]}
              onChange={(e) => {
                const newRates = [...commissionRates];
                newRates[i] = Math.max(0, Math.min(100, parseInt(e.target.value) || 0));
                setCommissionRates(newRates);
                setSettingsSaved(false);
              }}
              className="w-20 bg-zinc-800/90 border border-zinc-700 rounded-lg px-3 py-2 text-white text-center"
            />
            <span className="text-zinc-500">%</span>
          </div>
        ))}
      </div>
      <div className="flex items-center justify-between mt-6 pt-4 border-t border-zinc-800">
        <div className="text-sm">
          <span className="text-zinc-500">Total: </span>
          <span className={commissionRates.reduce((a, b) => a + b, 0) > 100 ? 'text-red-400' : 'text-white'}>
            {commissionRates.reduce((a, b) => a + b, 0)}%
          </span>
          {commissionRates.reduce((a, b) => a + b, 0) > 100 && (
            <span className="text-red-400 text-xs ml-2">Cannot exceed 100%</span>
          )}
        </div>
      </div>
      {!settingsSaved && (
        <button
          onClick={saveSettings}
          disabled={savingSettings || commissionRates.reduce((a, b) => a + b, 0) > 100}
          className="w-full mt-4 bg-emerald-500 hover:bg-emerald-400 disabled:opacity-50 text-black font-semibold py-3 rounded-xl transition"
        >
          {savingSettings ? 'Saving...' : 'Save Settings'}
        </button>
      )}
    </CollapsibleSection>

    <CollapsibleSection dashboardType="vendor"
      id="quick-links"
      title="Quick Links"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
        </svg>
      }
      isOpen={openSections['quick-links']}
      onToggle={() => toggleSection('quick-links')}
    >
      <div className="grid grid-cols-2 gap-4">
        <a href="/docs" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-sky-400 group-hover:text-sky-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
            </svg>
          </div>
          <p className="text-sm font-medium">Documentation</p>
        </a>
        <a href="/terms" target="_blank" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-amber-400 group-hover:text-amber-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
          </div>
          <p className="text-sm font-medium">Terms</p>
        </a>
        <a href={`/affiliate-dashboard?store=${store.store_id}`} target="_blank" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-emerald-400 group-hover:text-emerald-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
            </svg>
          </div>
          <p className="text-sm font-medium">Affiliate Dashboard</p>
        </a>
        <a href="https://github.com/TokenCanvasIO/YesAllofUs-wordpress/releases/download/v1.0.2/yesallofus.zip" className="bg-zinc-800/90 hover:bg-zinc-700 rounded-lg p-4 text-center transition group">
          <div className="flex justify-center mb-2">
            <svg className="w-8 h-8 text-violet-400 group-hover:text-violet-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 7.5l-2.25-1.313M21 7.5v2.25m0-2.25l-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m9 3l2.25-1.313M12 12.75l-2.25-1.313M12 12.75V15m0 6.75l2.25-1.313M12 21.75V19.5m0 2.25l-2.25-1.313m0-16.875L12 2.25l2.25 1.313M21 14.25v2.25l-2.25 1.313m-13.5 0L3 16.5v-2.25" />
            </svg>
          </div>
          <p className="text-sm font-medium">WordPress Plugin</p>
        </a>
      </div>
    </CollapsibleSection>
  </div>
</div>

{/* ============================================================= */}
{/* MARKETING GROUP */}
{/* ============================================================= */}
<div className="space-y-4">
  <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider px-1">Marketing</h3>
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <CollapsibleSection dashboardType="vendor"
      id="affiliate-link"
      title="Affiliate Link"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
        </svg>
      }
      isOpen={openSections['affiliate-link']}
      onToggle={() => toggleSection('affiliate-link')}
    >
      <p className="text-zinc-500 text-sm mb-4">Share this link or add it to your website.</p>
      <div className="flex flex-col gap-2">
        <code className="bg-zinc-800/90 px-4 py-3 rounded-lg font-mono text-sm text-emerald-400 overflow-x-auto">
          {`https://yesallofus.com/affiliate-dashboard?store=${store.store_id}`}
        </code>
        <div className="flex gap-2">
          <button
            onClick={() => copyToClipboard(`https://yesallofus.com/affiliate-dashboard?store=${store.store_id}`, 'affiliate_link')}
            className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition"
          >
            {copied === 'affiliate_link' ? '‚úì Copied' : 'Copy'}
          </button>
          <button
            onClick={() => setShowQRModal(true)}
            className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition"
          >
            QR Code
          </button>
        </div>
      </div>
    </CollapsibleSection>

    {store && walletAddress && (
      <CollapsibleSection dashboardType="vendor"
        id="activity"
        title="Activity"
        icon={
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
          </svg>
        }
        isOpen={openSections['activity']}
        onToggle={() => toggleSection('activity')}
      >
        <StoreActivity storeId={store.store_id} walletAddress={walletAddress} showAmounts={showAmounts} />
      </CollapsibleSection>
    )}
  </div>
</div>

{/* ============================================================= */}
{/* DEVELOPER & ACCOUNT GROUP - 2 COLUMN */}
{/* ============================================================= */}
<div className="space-y-4">
  <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider px-1">Developer & Account</h3>
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
    {/* API Credentials */}
    <CollapsibleSection dashboardType="vendor"
      id="api-credentials"
      title="API Credentials"
      icon={
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
        </svg>
      }
      isOpen={openSections['api-credentials']}
      onToggle={() => toggleSection('api-credentials')}
    >
      <div className="mb-4">
        <label className="text-zinc-500 text-sm block mb-1">Store ID</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm">{store.store_id}</code>
          <button onClick={() => copyToClipboard(store.store_id, 'store_id')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'store_id' ? '‚úì' : 'Copy'}
          </button>
        </div>
      </div>
      <div className="mb-4">
        <label className="text-zinc-500 text-sm block mb-1">API Key</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm">{store.api_key}</code>
          <button onClick={() => copyToClipboard(store.api_key, 'api_key')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'api_key' ? '‚úì' : 'Copy'}
          </button>
        </div>
      </div>
      <div className="mb-4">
        <label className="text-zinc-500 text-sm block mb-1">API Secret</label>
        {newSecret && !secretSaved ? (
          <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
            <div className="flex items-center gap-2 mb-3">
              <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm tracking-wider">
                ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢
              </code>
              <button
                onClick={() => { copyToClipboard(newSecret, 'secret'); setSecretRevealed(true); }}
                className="bg-emerald-500 hover:bg-emerald-400 text-black px-3 py-2 rounded-lg text-xs sm:text-sm font-semibold transition whitespace-nowrap"
              >
                {copied === 'secret' ? '‚úì' : 'Copy'}
              </button>
            </div>
            <div className="bg-yellow-500/20 rounded-lg p-3 mb-3">
              <p className="text-yellow-200 text-sm font-semibold mb-1">‚ö†Ô∏è SAVE THIS NOW</p>
              <p className="text-yellow-200/80 text-sm">This secret will disappear when you leave this page.</p>
            </div>
            {secretRevealed && (
              <button onClick={() => setSecretSaved(true)} className="w-full bg-zinc-800/90 hover:bg-zinc-700 py-2 rounded-lg text-sm transition">
                ‚úì I've saved my secret
              </button>
            )}
          </div>
        ) : (
          <div className="bg-zinc-800/90 rounded-xl p-4">
            <p className="text-zinc-400 text-sm mb-3">Your secret is not stored for security.</p>
            <button onClick={regenerateSecret} disabled={loading} className="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded-lg text-sm transition disabled:opacity-50">
              {loading ? 'Generating...' : 'Generate New Secret'}
            </button>
          </div>
        )}
      </div>
      <div>
        <label className="text-zinc-500 text-sm block mb-1">Your Store Referral Code</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm">{store.store_referral_code}</code>
          <button onClick={() => copyToClipboard(store.store_referral_code, 'referral')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'referral' ? '‚úì' : 'Copy'}
          </button>
        </div>
        <p className="text-zinc-500 text-xs mt-2">Share with other vendors to earn from their platform fees.</p>
        <p className="text-zinc-600 text-xs mt-1">Earn 25% L1 ¬∑ 5% L2 ¬∑ 3% L3 ¬∑ 2% L4 ¬∑ 1% L5 of their fees, paid instantly in RLUSD.</p>
      </div>
      <div className="mt-4 pt-4 border-t border-zinc-700">
        <label className="text-zinc-500 text-sm block mb-1">Your Partners Referral Link</label>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800/90 px-4 py-2 rounded-lg font-mono text-sm text-blue-400 overflow-x-auto">{`https://yesallofus.com/dashboard?ref=${store.store_referral_code}`}</code>
          <button onClick={() => copyToClipboard(`https://yesallofus.com/dashboard?ref=${store.store_referral_code}`, 'referral_link')} className="bg-zinc-800/90 hover:bg-zinc-700 px-3 py-2 rounded-lg text-sm transition">
            {copied === 'referral_link' ? '‚úì' : 'Copy'}
          </button>
        </div>
        <p className="text-zinc-500 text-xs mt-2">Share this link - new vendors get 50% off their first month!</p>
      </div>
    </CollapsibleSection>

    {/* Danger Zone */}
    <CollapsibleSection dashboardType="vendor"
      id="danger-zone"
      title="Danger Zone"
      icon={
        <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
        </svg>
      }
      isOpen={openSections['danger-zone']}
      onToggle={() => toggleSection('danger-zone')}
    >
      <p className="text-zinc-400 text-sm mb-4">
        Permanently delete your account and all associated data. This action cannot be undone.
      </p>
      <button
        onClick={() => setShowDeleteModal(true)}
        disabled={loading}
        className="bg-zinc-900/95 border-2 border-red-500 text-red-400 hover:bg-red-500 hover:text-white px-6 py-2 rounded-lg font-semibold transition disabled:opacity-50 flex items-center gap-2"
      >
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
        </svg>
        Permanently Delete
      </button>
    </CollapsibleSection>
  </div>
</div>

{/* ============================================================= */}
{/* RETURN TO WORDPRESS */}
{/* ============================================================= */}
{store?.platform_return_url && (
  <div
    id="return-wordpress"
    className={`${
      !walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled)
        ? 'bg-emerald-500/10 border-emerald-500/30'
        : 'bg-yellow-500/10 border-yellow-500/30'
    } border rounded-xl p-6`}
  >
    <div className="flex items-center gap-2 mb-2">
      {!walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled) ? (
        <svg className="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      ) : (
        <svg className="w-6 h-6 text-yellow-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={{ animationDuration: '3s' }}>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      )}
      <h2 className="text-lg font-bold">
        {!walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled)
          ? 'Setup Complete!'
          : 'Setup In Progress'}
      </h2>
    </div>
    <p className="text-zinc-400 text-sm mb-4">
      {walletNeedsFunding
        ? 'Step 1: Fund your wallet with at least 1.5 XRP to continue.'
        : walletNeedsTrustline
          ? 'Step 2: Add the RLUSD trustline to receive payments.'
          : walletType === 'web3auth' && !store.auto_signing_enabled
            ? 'Step 3: Enable auto-sign to process payouts automatically.'
            : 'Your wallet is ready to receive affiliate commissions.'}
    </p>
    <a
      href="#"
      onClick={async (e) => {
        e.preventDefault();
        const targetUrl = store.platform_return_url;
        try {
          const tokenRes = await fetch(`${API_URL}/store/generate-claim-token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              store_id: store.store_id,
              wallet_address: walletAddress,
            }),
          });
          const tokenData = await tokenRes.json();
          if (!tokenData.success || !tokenData.claim_token) {
            throw new Error('Failed to generate token');
          }
          await fetch(`${API_URL}/store/clear-platform-return`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              store_id: store.store_id,
              wallet_address: walletAddress,
            }),
          });
          safeRemoveItem('wordpress_return');
          const separator = targetUrl.includes('?') ? '&' : '?';
          window.location.href = `${targetUrl}${separator}claim_token=${tokenData.claim_token}`;
        } catch (err) {
          console.error('Failed to generate claim token:', err);
          alert('Failed to return to WordPress. Please try again.');
        }
      }}
      className={`inline-block ${
        !walletNeedsFunding && !walletNeedsTrustline && (walletType !== 'web3auth' || store.auto_signing_enabled)
          ? 'bg-emerald-500 hover:bg-emerald-400'
          : 'bg-yellow-500 hover:bg-yellow-400'
      } text-black font-semibold px-6 py-3 rounded-lg transition mt-4`}
    >
      Return to {store.platform_type === 'wordpress' ? 'WordPress' : 'Your Site'}
    </a>
  </div>
)}
</div>
)}
     </div>
      </main>
    </div>
    <QRCodeModal
  isOpen={showQRModal}
  onClose={() => setShowQRModal(false)}
  url={`https://yesallofus.com/affiliate-dashboard?store=${store?.store_id}`}
  title="Share Affiliate Link"
  subtitle={store?.store_name}
/>
{/* Delete Store Modal */}
<DeleteConfirmModal
  isOpen={showDeleteModal}
  onClose={() => setShowDeleteModal(false)}
  onConfirm={deleteStore}
  title="Delete Store"
  description="This will permanently delete your store, all affiliates, and all payout history. This action cannot be undone."
  confirmText="PERMANENTLY DELETE"
  loading={deleting}
/>
{/* Disconnect Wallet Modal */}
{showDisconnectModal && (
  <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div className="bg-zinc-900/95 border border-zinc-800 rounded-xl p-6 max-w-sm w-full">
      <h3 className="text-lg font-bold mb-2">Disconnect Wallet</h3>
      <p className="text-zinc-400 text-sm mb-6">
        Disconnect your wallet? You will need to reconnect to process payouts.
      </p>
      <div className="flex gap-3">
        <button
          onClick={() => setShowDisconnectModal(false)}
          className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 text-white py-3 rounded-lg font-medium transition"
        >
          Cancel
        </button>
        <button
          onClick={() => {
            setShowDisconnectModal(false);
            disconnectWallet();
          }}
          className="flex-1 bg-red-500 hover:bg-red-400 text-white py-3 rounded-lg font-medium transition"
        >
          Disconnect
        </button>
      </div>
    </div>
  </div>
)}
    </>
    
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/faq/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import React, { useState, ReactNode } from 'react';


// MARK: - Types & Interfaces
interface FAQItemProps {
  question: string;
  answer: React.ReactNode;
  isOpen: boolean;
  onClick: () => void;
}


// MARK: - Constants & Configuration

// MARK: - Component Definition
const FAQItem = ({ question, answer, isOpen, onClick }: FAQItemProps) => (
  <div className="border border-slate-200 rounded-lg overflow-hidden">
    <button

// MARK: - Event Handlers
      onClick={onClick}
      className="w-full flex items-center justify-between p-4 text-left hover:bg-slate-50 transition-colors"
    >
      <span className="font-medium text-slate-900">{question}</span>
      <svg
        className={`w-5 h-5 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
      </svg>
    </button>
    {isOpen && (
      <div className="px-4 pb-4 text-slate-600 text-sm leading-relaxed">
        {answer}
      </div>
    )}
  </div>
);

export default function FAQ() {
  const [openIndex, setOpenIndex] = useState<number | null>(0);

  const faqs = [
    // Getting Started
    {
      category: 'Getting Started',
      items: [
        {
          question: 'What is YesAllofUs?',
answer: (
  <>
    <p className="mb-2">YesAllofUs is B2B payment infrastructure built on the XRP Ledger. We provide technology that enables instant affiliate commission payments in RLUSD (Ripple&apos;s stablecoin) ‚Äî no more monthly payout spreadsheets or 30-60 day delays.</p>
    <p>Our infrastructure is licensed to authorised entities and supports 5-level MLM commission structures, WordPress/WooCommerce integration, and multiple wallet connection methods.</p>
  </>
)
        },
        {
          question: 'How do I get started?',
          answer: (
            <>
              <p className="mb-2">The fastest way is to run our CLI tool:</p>
              <code className="bg-slate-100 px-2 py-1 rounded text-sm block mb-2">npx YesAllofUs</code>
              <p className="mb-2">This will guide you through:</p>
              <ol className="list-decimal pl-4 space-y-1">
                <li>Registering your store</li>
                <li>Getting your API credentials</li>
                <li>Connecting your wallet</li>
              </ol>
              <p className="mt-2">Alternatively, if you use WordPress/WooCommerce, you can install our plugin which handles registration automatically.</p>
            </>
          )
        },
        {
          question: 'Is YesAllofUs free?',
          answer: (
            <>
              <p className="mb-2">Yes! We have a free tier with no monthly fees. Here&apos;s our pricing:</p>
              <ul className="space-y-1">
                <li><strong>Free:</strong> 2.9% per payout, $0/month</li>
                <li><strong>Pro:</strong> 0.9% per payout, $99/month</li>
                <li><strong>Enterprise:</strong> 0% per payout, $499/month</li>
              </ul>
              <p className="mt-2">No setup fees, no hidden charges, no credit card required to start.</p>
            </>
          )
        },
        {
          question: 'What countries do you support?',
          answer: (
            <>
              <p className="mb-2">YesAllofUs works globally wherever the XRP Ledger is accessible. Since payments are in RLUSD (a stablecoin), affiliates receive the same value regardless of their location.</p>
              <p>However, you are responsible for ensuring your use of the service complies with the laws of your jurisdiction. Some countries have restrictions on cryptocurrency usage.</p>
            </>
          )
        },
      ]
    },
    // Wallets & Payments
    {
      category: 'Wallets & Payments',
      items: [
        {
          question: 'What is RLUSD?',
          answer: (
            <>
              <p className="mb-2">RLUSD is Ripple USD ‚Äî a stablecoin issued by Ripple on the XRP Ledger. It&apos;s pegged 1:1 to the US dollar and backed by dollar deposits and short-term US Treasury bonds.</p>
              <p>We use RLUSD because it provides stable value (unlike volatile cryptocurrencies), instant settlement (~4 seconds), and near-zero transaction fees.</p>
            </>
          )
        },
        {
          question: 'What wallets do you support?',
          answer: (
            <>
              <p className="mb-2">We support two wallet options:</p>
              <ul className="space-y-2">
                <li><strong>Xaman (mobile):</strong> Scan a QR code to connect. Supports manual approval via push notifications or automatic payments.</li>
                <li><strong>Crossmark (browser extension):</strong> Click to connect from your desktop browser. Supports automatic payments within your set limits.</li>
              </ul>
              <p className="mt-2">Both wallets are self-custodial ‚Äî you always control your private keys.</p>
            </>
          )
        },
        {
          question: 'What is an RLUSD trustline and why do I need one?',
          answer: (
            <>
              <p className="mb-2">On the XRP Ledger, you need to explicitly &quot;trust&quot; an issuer before you can hold their token. This is called a trustline. Think of it as opting-in to receive a particular currency.</p>
              <p className="mb-2">Both you (the store) and your affiliates need RLUSD trustlines to send and receive commission payments.</p>
              <p>To add a trustline, use your wallet app (Xaman or Crossmark) to add the RLUSD issuer: <code className="bg-slate-100 px-1 rounded text-xs">rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De</code></p>
            </>
          )
        },
        {
          question: 'How fast are payments?',
          answer: (
            <>
              <p>Payments settle on the XRP Ledger in approximately 3-5 seconds. Once validated, they&apos;re final and irreversible ‚Äî affiliates see the funds in their wallet almost instantly.</p>
            </>
          )
        },
        {
          question: 'Can payments be reversed or refunded?',
          answer: (
            <>
              <p className="mb-2">No. Blockchain transactions are final and irreversible once confirmed. YesAllofUs cannot reverse, modify, or recover payments.</p>
              <p>If you send a payment in error, you&apos;ll need to contact the recipient directly to request they return the funds.</p>
            </>
          )
        },
        {
          question: 'What happens if my wallet has insufficient funds?',
          answer: (
            <>
              <p>The payment will fail with an &quot;insufficient balance&quot; error. You&apos;ll need to add RLUSD to your wallet and retry the payout. We recommend keeping a buffer in your wallet to avoid failed payments.</p>
            </>
          )
        },
      ]
    },
    // Auto-Sign & Security
    {
      category: 'Auto-Sign & Security',
      items: [
        {
          question: 'What is Auto-Sign?',
          answer: (
            <>
              <p className="mb-2">Auto-Sign uses XRPL&apos;s multi-signature feature to allow YesAllofUs to automatically sign payment transactions on your behalf ‚Äî without you having to approve each one manually.</p>
              <p className="mb-2">You add YesAllofUs as a &quot;signer&quot; on your wallet with weight 1 and set a quorum of 1. This means either you OR YesAllofUs can sign transactions.</p>
              <p>You control the limits (daily max, per-transaction max) and can revoke access anytime by removing the signer from your wallet.</p>
            </>
          )
        },
        {
          question: 'Does YesAllofUs have access to my private keys?',
          answer: (
            <>
              <p className="mb-2"><strong>No, never.</strong> We use XRPL&apos;s multi-signature feature, not key custody.</p>
              <p>Your private keys stay in your wallet (Xaman or Crossmark). YesAllofUs only has permission to co-sign transactions ‚Äî we cannot access your keys, drain your wallet, or act outside the signer permissions you&apos;ve configured.</p>
            </>
          )
        },
        {
          question: 'Can YesAllofUs drain my wallet?',
          answer: (
            <>
              <p className="mb-2">No. Our software only triggers payments to registered affiliates within your configured limits:</p>
              <ul className="list-disc pl-4 space-y-1">
                <li>However, the multi-signature setup does grant signing permission.</li>
                <li>Your protection is our code, our reputation, and full transparency on the public ledger.</li>
                <li>Every transaction is logged publicly on the XRP Ledger.</li>
                <li>You can revoke access instantly by removing the signer.</li>
              </ul>
              <p className="mt-2">We&apos;re software that triggers payments ‚Äî we don&apos;t have custody or control of your funds.</p>
            </>
          )
        },
        {
          question: 'How do I revoke Auto-Sign access?',
          answer: (
            <>
              <p className="mb-2">Go to your wallet app (Xaman or Crossmark) ‚Üí Settings ‚Üí Signers ‚Üí Remove the YesAllofUs signer address.</p>
              <p>Revocation takes effect immediately once the transaction is confirmed on the XRP Ledger. No need to contact us ‚Äî you&apos;re in full control.</p>
            </>
          )
        },
        {
          question: 'What happens if I use Manual mode instead of Auto-Sign?',
          answer: (
            <>
              <p className="mb-2">In Manual mode (Xaman only), each payment requires your explicit approval via push notification in the Xaman app.</p>
              <p>This gives you maximum control but requires you to be available to approve payouts. Payments not approved within 72 hours will expire and may be retried.</p>
            </>
          )
        },
      ]
    },
    // Affiliates & Commissions
    {
      category: 'Affiliates & Commissions',
      items: [
        {
          question: 'How do commission levels work?',
          answer: (
            <>
              <p className="mb-2">YesAllofUs supports 5-level MLM commissions. Default rates are:</p>
              <ul className="space-y-1">
                <li>Level 1 (direct referrer): 25%</li>
                <li>Level 2: 5%</li>
                <li>Level 3: 3%</li>
                <li>Level 4: 2%</li>
                <li>Level 5: 1%</li>
              </ul>
              <p className="mt-2">You can customize these rates when registering your store. Rates are percentages of the order total.</p>
            </>
          )
        },
        {
          question: 'Can I change commission rates after setup?',
          answer: (
            <>
              <p>Currently, commission rates are set at registration. Contact us at <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a> if you need to change them.</p>
            </>
          )
        },
        {
          question: 'How do affiliates sign up?',
          answer: (
            <>
              <p className="mb-2">Affiliates register through your store using the shortcode <code className="bg-slate-100 px-1 rounded">[dltpays_affiliate_signup]</code> (WordPress) or via your custom integration using our API.</p>
              <p>They provide their XRP Ledger wallet address and receive a unique referral code they can share.</p>
            </>
          )
        },
        {
          question: 'What if an affiliate does not have a RLUSD trustline?',
          answer: (
            <>
              <p>Their commission payment will be skipped with a &quot;no trustline&quot; note. The payment isn&apos;t lost ‚Äî they need to add an RLUSD trustline to their wallet, and future payments will work. Past skipped payments are not automatically retried.</p>
            </>
          )
        },
        {
          question: 'How long do referral cookies last?',
          answer: (
            <>
              <p>The default cookie duration is 30 days. If a visitor clicks an affiliate link and purchases within 30 days, the affiliate gets credit. You can configure this duration in the WordPress plugin settings.</p>
            </>
          )
        },
      ]
    },
    // WordPress & Integration
    {
      category: 'WordPress & Integration',
      items: [
        {
          question: 'Does YesAllofUs work with WooCommerce?',
          answer: (
            <>
              <p className="mb-2">Yes! Our WordPress plugin integrates seamlessly with WooCommerce. When an order is marked as &quot;completed,&quot; commissions are automatically triggered.</p>
              <p>The plugin handles referral tracking, affiliate registration, and payment triggering ‚Äî all automatically.</p>
            </>
          )
        },
        {
          question: 'Can I use YesAllofUs without WordPress?',
          answer: (
            <>
              <p className="mb-2">Absolutely. YesAllofUs has a full REST API that works with any platform:</p>
              <ul className="list-disc pl-4 space-y-1">
                <li>Shopify (via webhook)</li>
                <li>Custom e-commerce platforms</li>
                <li>SaaS applications</li>
                <li>Mobile apps</li>
                <li>Any platform that can make HTTP requests</li>
              </ul>
              <p className="mt-2">See our <a href="/docs" className="text-blue-600">API documentation</a> for integration details.</p>
            </>
          )
        },
        {
          question: 'How do I test the integration?',
          answer: (
            <>
              <p className="mb-2">We recommend:</p>
              <ol className="list-decimal pl-4 space-y-1">
                <li>Register a test affiliate with a wallet you control</li>
                <li>Create a small test order ($1-5)</li>
                <li>Mark the order as complete</li>
                <li>Verify the commission appears in your wallet</li>
              </ol>
              <p className="mt-2">All payments are real (there&apos;s no &quot;sandbox&quot;), so use small amounts for testing.</p>
            </>
          )
        },
      ]
    },
    // Billing & Fees
    {
      category: 'Billing & Fees',
      items: [
        {
          question: 'How are platform fees collected?',
          answer: (
            <>
              <p>Platform fees are deducted automatically as a separate RLUSD payment from your wallet to YesAllofUs when each payout is processed. You&apos;ll see this as a distinct transaction on the XRP Ledger.</p>
            </>
          )
        },
        {
          question: 'Are there any hidden fees?',
          answer: (
            <>
              <p>No. We charge only:</p>
              <ul className="list-disc pl-4 space-y-1">
                <li>Platform fee (2.9%, 0.9%, or 0% depending on tier)</li>
                <li>Monthly subscription (Pro: $99, Enterprise: $499)</li>
              </ul>
              <p className="mt-2">No setup fees, no integration fees, no withdrawal fees, no minimum volumes.</p>
            </>
          )
        },
        {
          question: 'What about XRP network fees?',
          answer: (
            <>
              <p>XRP Ledger transactions require a tiny amount of XRP for network fees (typically 0.00001-0.00002 XRP, less than $0.01). Your wallet needs a small XRP balance to cover these. This goes to the network, not YesAllofUs.</p>
            </>
          )
        },
        {
          question: 'Do you offer refunds?',
          answer: (
            <>
              <p>Monthly subscription fees are non-refundable. Platform fees are collected at the time of each payout and cannot be refunded after the blockchain transaction is confirmed.</p>
            </>
          )
        },
      ]
    },
    // Troubleshooting
    {
      category: 'Troubleshooting',
      items: [
        {
          question: 'My wallet connection is not working',
          answer: (
            <>
              <p className="mb-2">Try these steps:</p>
              <ol className="list-decimal pl-4 space-y-1">
                <li>Ensure your wallet app (Xaman/Crossmark) is up to date</li>
                <li>Check that you&apos;re on a supported browser (Chrome, Firefox, Safari, Edge)</li>
                <li>Disable any ad blockers temporarily</li>
                <li>Clear your browser&apos;s local storage and try again</li>
                <li>For Xaman: Ensure push notifications are enabled in the app</li>
              </ol>
              <p className="mt-2">If issues persist, email <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a> with your store ID.</p>
            </>
          )
        },
        {
          question: 'Payouts are failing with insufficient balance;',
          answer: (
            <>
              <p className="mb-2">Your wallet needs:</p>
              <ul className="list-disc pl-4 space-y-1">
                <li>Enough RLUSD to cover all commission payments + platform fee</li>
                <li>A small XRP balance for network fees (at least 10 XRP recommended)</li>
              </ul>
              <p className="mt-2">Add funds to your wallet and retry the payout.</p>
            </>
          )
        },
        {
          question: 'An affiliate says they did not receive payment',
          answer: (
            <>
              <p className="mb-2">Check the following:</p>
              <ol className="list-decimal pl-4 space-y-1">
                <li>Verify the affiliate&apos;s wallet has an RLUSD trustline</li>
                <li>Check the payout status in your dashboard</li>
                <li>Look up the transaction on an XRP Ledger explorer (e.g., xrpscan.com)</li>
              </ol>
              <p className="mt-2">If the transaction shows as successful on the ledger, the affiliate definitely received the funds ‚Äî they may need to check their wallet&apos;s RLUSD balance specifically.</p>
            </>
          )
        },
        {
          question: 'I am getting rate limited (429 errors)',
          answer: (
            <>
              <p className="mb-2">Our rate limits are:</p>
              <ul className="list-disc pl-4 space-y-1">
                <li>60 requests per minute per IP</li>
                <li>10 payout requests per minute per store</li>
              </ul>
              <p className="mt-2">Implement exponential backoff in your integration. If you need higher limits for a legitimate use case, contact us.</p>
            </>
          )
        },
      ]
    },
    // Account & Support
    {
      category: 'Account & Support',
      items: [
        {
          question: 'How do I delete my account?',
          answer: (
            <>
              <p className="mb-2">You can delete your account via the API:</p>
              <code className="bg-slate-100 px-2 py-1 rounded text-sm block mb-2">DELETE /api/v1/store</code>
              <p className="mb-2">With body: <code className="bg-slate-100 px-1 rounded text-xs">{`{"confirm": "PERMANENTLY DELETE"}`}</code></p>
              <p>This removes all your data (except blockchain transactions, which are immutable). Don&apos;t forget to remove YesAllofUs as a signer from your wallet first.</p>
            </>
          )
        },
        {
          question: 'How do I contact support?',
          answer: (
            <>
              <p className="mb-2">Email <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a> for:</p>
              <ul className="list-disc pl-4 space-y-1">
                <li>Technical support</li>
                <li>Account issues</li>
                <li>Feature requests</li>
                <li>Integration help</li>
              </ul>
              <p className="mt-2">For the done-for-you setup service (¬£499), <a href="https://calendly.com/tokencanvasio/30min" className="text-blue-600" target="_blank">book a call</a>.</p>
            </>
          )
        },
        {
          question: 'Is there an SLA or uptime guarantee?',
          answer: (
            <>
              <p>We aim for 99.9% uptime but don&apos;t offer a formal SLA at this time. The service depends on third-party infrastructure (XRP Ledger, Xaman, Crossmark, cloud providers) that is outside our control.</p>
            </>
          )
        },
      ]
    },
  ];

  let globalIndex = 0;


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-12 text-center">
          <h1 className="text-4xl font-bold text-slate-900 mb-4">Frequently Asked Questions</h1>
          <p className="text-slate-600">Everything you need to know about YesAllofUs</p>
        </div>

        {/* Quick Links */}
        <div className="bg-slate-50 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-slate-900 mb-4">Jump to section</h2>
          <div className="flex flex-wrap gap-2">
            {faqs.map((section) => (
              <a
                key={section.category}
                href={`#${section.category.toLowerCase().replace(/\s+/g, '-')}`}
                className="px-3 py-1 bg-white border border-slate-200 rounded-full text-sm text-slate-600 hover:border-blue-500 hover:text-blue-600 transition-colors"
              >
                {section.category}
              </a>
            ))}
          </div>
        </div>

        {/* FAQ Sections */}
        {faqs.map((section) => {
          const sectionStartIndex = globalIndex;
          return (
            <section
              key={section.category}
              id={section.category.toLowerCase().replace(/\s+/g, '-')}
              className="mb-12 scroll-mt-24"
            >
              <h2 className="text-xl font-bold text-slate-900 mb-4">{section.category}</h2>
              <div className="space-y-3">
                {section.items.map((item, itemIndex) => {
                  const currentGlobalIndex = globalIndex++;
                  return (
                    <FAQItem
                      key={itemIndex}
                      question={item.question}
                      answer={item.answer}
                      isOpen={openIndex === currentGlobalIndex}
                      onClick={() => setOpenIndex(openIndex === currentGlobalIndex ? null : currentGlobalIndex)}
                    />
                  );
                })}
              </div>
            </section>
          );
        })}

        {/* Still have questions */}
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-8 text-center">
          <h2 className="text-xl font-bold text-blue-900 mb-2">Still have questions?</h2>
          <p className="text-blue-800 mb-4">We&apos;re here to help.</p>
          <div className="flex justify-center gap-4">
            <a
              href="mailto:mark@YesAllofUs.com"
              className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Email Support
            </a>
            <a
              href="https://calendly.com/tokencanvasio/30min"
              target="_blank"
              className="border border-blue-600 text-blue-600 px-6 py-2 rounded-lg hover:bg-blue-50 transition-colors"
            >
              Book a Call
            </a>
          </div>
        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/guides/wordpress/page.tsx
// =================================================

// MARK: - Component Definition
export default function WordPressGuide() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans">
      <main className="max-w-3xl mx-auto px-6 py-16">
        
        <a href="/" className="text-zinc-500 text-sm hover:text-white mb-8 inline-block">‚Üê Back</a>
        
        <h1 className="text-3xl font-bold mb-4">WordPress / WooCommerce Setup</h1>
        <p className="text-zinc-400 mb-12">Get instant affiliate payouts in under 5 minutes.</p>

        {/* Requirements */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">Requirements</h2>
          <ul className="text-zinc-400 text-sm space-y-2">
            <li>‚úì WordPress 5.0+</li>
            <li>‚úì WooCommerce 5.0+</li>
            <li>‚úì XRPL wallet (Xaman, Crossmark, or Web3Auth)</li>
            <li>‚úì RLUSD balance for payouts</li>
          </ul>
        </section>

        {/* Step 1 */}
        <section className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <span className="bg-sky-500 text-black font-bold w-8 h-8 rounded-full flex items-center justify-center">1</span>
            <h2 className="text-xl font-bold">Install the plugin</h2>
          </div>
          
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
            <p className="text-zinc-400 text-sm mb-4">Download and install:</p>
            <a 
              href="https://github.com/TokenCanvasIO/YesAllofUs-wordpress/releases/download/v1.0.2/yesallofus.zip" 
              className="bg-sky-500 hover:bg-sky-400 text-black font-semibold px-4 py-2 rounded text-sm inline-block mb-4"
            >
              Download Plugin (.zip)
            </a>
            <p className="text-zinc-500 text-sm mb-4">Or install manually:</p>
            <ol className="text-zinc-400 text-sm space-y-2">
              <li>1. Go to WordPress Admin ‚Üí Plugins ‚Üí Add New</li>
              <li>2. Click "Upload Plugin"</li>
              <li>3. Select the .zip file</li>
              <li>4. Click "Install Now" then "Activate"</li>
            </ol>
          </div>
        </section>

        {/* Step 2 */}
        <section className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <span className="bg-sky-500 text-black font-bold w-8 h-8 rounded-full flex items-center justify-center">2</span>
            <h2 className="text-xl font-bold">Connect your wallet</h2>
          </div>
          
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
            <ol className="text-zinc-400 text-sm space-y-3">
              <li>1. Go to WordPress Admin ‚Üí YesAllofUs</li>
              <li>2. Click "Connect Wallet"</li>
              <li>3. Choose Xaman (mobile), Crossmark (browser), or Web3Auth (social login)</li>
              <li>4. Approve the connection in your wallet</li>
            </ol>
            
            <div className="mt-6 p-4 bg-zinc-800/50 rounded-lg">
              <p className="text-zinc-500 text-sm">
                <strong className="text-zinc-300">Xaman:</strong> Scan QR code with your phone. 
                You'll approve each payout manually via push notification.
              </p>
            </div>
            
            <div className="mt-3 p-4 bg-zinc-800/50 rounded-lg">
              <p className="text-zinc-500 text-sm">
                <strong className="text-zinc-300">Crossmark:</strong> Connect via browser extension. 
                Set daily limits for automatic payouts.
              </p>
            </div>

            <div className="mt-3 p-4 bg-zinc-800/50 rounded-lg">
              <p className="text-zinc-500 text-sm">
                <strong className="text-zinc-300">Web3Auth:</strong> Sign in with Google, Apple, or email. 
                No crypto wallet needed ‚Äî we create one for you automatically. 
                Supports automatic payouts with no manual approval required.
              </p>
            </div>

            <p className="text-zinc-500 text-sm mt-4">
              <a href="/wallet-guide" className="text-sky-500 hover:underline">
                Not sure which to choose? Read the full comparison ‚Üí
              </a>
            </p>
          </div>
        </section>

        {/* Step 3 */}
        <section className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <span className="bg-sky-500 text-black font-bold w-8 h-8 rounded-full flex items-center justify-center">3</span>
            <h2 className="text-xl font-bold">Configure payouts (Crossmark & Web3Auth)</h2>
          </div>
          
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
            <p className="text-zinc-400 text-sm mb-4">
              If using Crossmark or Web3Auth for automatic payouts, set your limits:
            </p>
            <ol className="text-zinc-400 text-sm space-y-2">
              <li>1. Go to YesAllofUs ‚Üí Settings</li>
              <li>2. Accept the auto-sign terms</li>
              <li>3. Set maximum single payout (e.g. $100)</li>
              <li>4. Set daily limit (e.g. $1,000)</li>
              <li>5. Click "Enable Auto-Sign"</li>
              <li>6. Approve the SignerList transaction in your wallet</li>
            </ol>
            
            <div className="mt-6 p-4 bg-green-500/10 border border-green-500/20 rounded-lg">
              <p className="text-green-400 text-sm">
                <strong>Web3Auth users:</strong> Auto-sign is enabled by default. Your wallet is created 
                with YesAllofUs as an authorised signer, so payouts happen instantly with no manual approval.
              </p>
            </div>
            
            <div className="mt-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
              <p className="text-yellow-400 text-sm">
                <strong>Tip:</strong> Start with conservative limits. You can always increase later.
              </p>
            </div>
          </div>
        </section>

        {/* Step 4 */}
        <section className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <span className="bg-sky-500 text-black font-bold w-8 h-8 rounded-full flex items-center justify-center">4</span>
            <h2 className="text-xl font-bold">Add RLUSD to your wallet</h2>
          </div>
          
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
            <p className="text-zinc-400 text-sm mb-4">
              Your wallet needs RLUSD to pay affiliates. You'll also need a small amount 
              of XRP for transaction fees (~0.00001 XRP per transaction).
            </p>
            <p className="text-zinc-400 text-sm mb-4">
              Get RLUSD from:
            </p>
            <ul className="text-zinc-400 text-sm space-y-1">
              <li>‚Ä¢ <a href="https://uphold.com" className="text-sky-500 hover:underline">Uphold</a></li>
              <li>‚Ä¢ <a href="https://gatehub.net" className="text-sky-500 hover:underline">GateHub</a></li>
              <li>‚Ä¢ XRPL DEX (via Xaman or Crossmark)</li>
            </ul>
            
            <div className="mt-6 p-4 bg-zinc-800/50 rounded-lg">
              <p className="text-zinc-500 text-sm">
                <strong className="text-zinc-300">Web3Auth users:</strong> Your wallet address is shown in your dashboard. 
                Send RLUSD and XRP to this address from any exchange or wallet.
              </p>
            </div>
          </div>
        </section>

        {/* Step 5 */}
        <section className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <span className="bg-sky-500 text-black font-bold w-8 h-8 rounded-full flex items-center justify-center">5</span>
            <h2 className="text-xl font-bold">Register affiliates</h2>
          </div>
          
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
            <p className="text-zinc-400 text-sm mb-4">
              The plugin creates two shortcodes for your site:
            </p>
            
            <div className="bg-zinc-800 rounded-lg p-4 mb-4">
              <code className="text-green-400 text-sm">[dltpays_affiliate_signup]</code>
              <p className="text-zinc-500 text-sm mt-2">
                Signup form where affiliates enter their XRPL wallet address.
              </p>
            </div>
            
            <div className="bg-zinc-800 rounded-lg p-4">
              <code className="text-green-400 text-sm">[dltpays_affiliate_dashboard]</code>
              <p className="text-zinc-500 text-sm mt-2">
                Dashboard where affiliates see their referral link and earnings.
              </p>
            </div>
            
            <p className="text-zinc-400 text-sm mt-4">
              Add these to any page. When someone signs up, they get a unique referral link 
              like <code className="bg-zinc-800 px-2 py-1 rounded text-xs">yoursite.com?ref=ABC123</code>
            </p>
          </div>
        </section>

        {/* Step 6 */}
        <section className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <span className="bg-green-500 text-black font-bold w-8 h-8 rounded-full flex items-center justify-center">‚úì</span>
            <h2 className="text-xl font-bold">Done!</h2>
          </div>
          
          <div className="bg-green-500/10 border border-green-500/20 rounded-xl p-6">
            <p className="text-zinc-300 text-sm mb-4">
              When a customer visits via a referral link and completes an order:
            </p>
            <ol className="text-zinc-400 text-sm space-y-2">
              <li>1. Order status changes to "Completed"</li>
              <li>2. YesAllofUs calculates commission (default 25%)</li>
              <li>3. Payment triggers from your wallet</li>
              <li>4. Affiliate receives RLUSD in ~4 seconds</li>
            </ol>
            <p className="text-zinc-400 text-sm mt-4">
              All transactions are visible on the XRP Ledger. You can verify any payment 
              on <a href="https://xrpscan.com" className="text-sky-500 hover:underline">XRPScan</a>.
            </p>
          </div>
        </section>

        {/* Commission rates */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">Commission structure</h2>
          
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
            <p className="text-zinc-400 text-sm mb-4">
              YesAllofUs supports 5-level MLM commissions. Default rates:
            </p>
            <div className="grid grid-cols-5 gap-2 text-center text-sm mb-4">
              <div className="bg-zinc-800 rounded p-2">
                <p className="text-zinc-500">Level 1</p>
                <p className="font-bold">25%</p>
              </div>
              <div className="bg-zinc-800 rounded p-2">
                <p className="text-zinc-500">Level 2</p>
                <p className="font-bold">5%</p>
              </div>
              <div className="bg-zinc-800 rounded p-2">
                <p className="text-zinc-500">Level 3</p>
                <p className="font-bold">3%</p>
              </div>
              <div className="bg-zinc-800 rounded p-2">
                <p className="text-zinc-500">Level 4</p>
                <p className="font-bold">2%</p>
              </div>
              <div className="bg-zinc-800 rounded p-2">
                <p className="text-zinc-500">Level 5</p>
                <p className="font-bold">1%</p>
              </div>
            </div>
            <p className="text-zinc-500 text-sm">
              Customize rates in YesAllofUs ‚Üí Settings.
            </p>
          </div>
        </section>

        {/* Troubleshooting */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">Troubleshooting</h2>
          
          <div className="space-y-4">
            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
              <h3 className="font-semibold mb-2">Payout didn't trigger</h3>
              <ul className="text-zinc-400 text-sm space-y-1">
                <li>‚Ä¢ Check order status is "Completed" (not "Processing")</li>
                <li>‚Ä¢ Check referral code was captured (order meta: _dltpays_referral_code)</li>
                <li>‚Ä¢ Check wallet has RLUSD balance</li>
                <li>‚Ä¢ Check YesAllofUs ‚Üí Settings shows "Connected"</li>
              </ul>
            </div>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
              <h3 className="font-semibold mb-2">Wallet won't connect</h3>
              <ul className="text-zinc-400 text-sm space-y-1">
                <li>‚Ä¢ For Xaman: ensure push notifications are enabled</li>
                <li>‚Ä¢ For Crossmark: check extension is installed and unlocked</li>
                <li>‚Ä¢ For Web3Auth: try a different browser or clear cookies</li>
                <li>‚Ä¢ Try refreshing the page and reconnecting</li>
              </ul>
            </div>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
              <h3 className="font-semibold mb-2">Auto-sign not working</h3>
              <ul className="text-zinc-400 text-sm space-y-1">
                <li>‚Ä¢ Check you've accepted the terms</li>
                <li>‚Ä¢ Verify SignerList is set on your wallet (check XRPScan)</li>
                <li>‚Ä¢ Ensure payout amount is within your limits</li>
                <li>‚Ä¢ Web3Auth users: auto-sign is enabled by default ‚Äî check RLUSD balance</li>
              </ul>
            </div>
          </div>
        </section>

        {/* Support */}
        <section className="mb-12">
          <h2 className="text-xl font-bold mb-4">Need help?</h2>
          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
            <p className="text-zinc-400 text-sm mb-4">
              Stuck? I'll help you get set up.
            </p>
            <div className="flex flex-col sm:flex-row gap-2 sm:gap-4">
              <a 
                href="mailto:mark@YesAllofUs.com" 
                className="text-sky-500 hover:underline text-sm"
              >
                mark@YesAllofUs.com
              </a>
              <a 
                href="https://x.com/YesAllofUs" 
                className="text-sky-500 hover:underline text-sm"
              >
                @YesAllofUs
              </a>
            </div>
            <p className="text-zinc-500 text-sm mt-4">
              <a href="https://calendly.com/tokencanvasio/30min" target="_blank" className="text-sky-500 hover:underline">Done-for-you setup</a>
              <span className="block sm:inline sm:ml-1">‚Äî I'll configure everything on a call.</span>
            </p>
          </div>
        </section>

        {/* CTA */}
        <section className="text-center py-8 border-t border-zinc-800">
          <a 
            href="https://github.com/TokenCanvasIO/YesAllofUs-Wordpress/releases/latest/download/yesallofus.zip" 
            className="bg-sky-500 hover:bg-sky-400 text-black font-semibold px-6 py-3 rounded transition inline-block"
          >
            Download Plugin
          </a>
        </section>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/home/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect } from 'react';


// MARK: - Component Definition
export default function Home() {

// MARK: - State Management
  const [betaStatus, setBetaStatus] = useState({ spots_remaining: 5, beta_open: true });
  const [email, setEmail] = useState('');
  const [waitlistStatus, setWaitlistStatus] = useState('');


// MARK: - Hooks & Effects
  useEffect(() => {
    fetch('https://api.dltpays.com/api/v1/beta/status')
      .then(res => res.json())
      .then(data => setBetaStatus(data))
      .catch(() => {});
  }, []);


// MARK: - Event Handlers
  const handleWaitlist = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!email) return;
    
    setWaitlistStatus('loading');
    try {
      const res = await fetch('https://api.dltpays.com/api/v1/waitlist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      
      if (res.ok) {
        setWaitlistStatus('success');
        setEmail('');
      } else {
        setWaitlistStatus('error');
      }
    } catch {
      setWaitlistStatus('error');
    }
  };


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans">
      {/* Beta Banner */}
      <div className="bg-emerald-500/10 border-b border-emerald-500/30 py-3 px-6 text-center">
        {betaStatus.beta_open ? (
          <p className="text-emerald-400 text-sm">
            <span>ü§ù</span> <strong>Beta:</strong> {betaStatus.spots_remaining} spots left. I'm onboarding each store personally.
          </p>
        ) : waitlistStatus === 'success' ? (
          <p className="text-emerald-400 text-sm">‚úì You're on the list.</p>
        ) : (
          <form onSubmit={handleWaitlist} className="flex items-center justify-center gap-2 flex-wrap">
            <span className="text-emerald-400 text-sm">Beta full ‚Äî</span>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="your@email.com"
              className="bg-zinc-800 border border-zinc-600 rounded px-3 py-1 text-sm text-white w-48"
              required
            />
            <button 
              type="submit" 
              disabled={waitlistStatus === 'loading'}
              className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-3 py-1 rounded text-sm"
            >
              {waitlistStatus === 'loading' ? '...' : 'Join'}
            </button>
          </form>
        )}
      </div>

      <main className="max-w-6xl mx-auto px-6">
        
        {/* Hero */}
<section className="py-10 md:py-10">
  <div className="max-w-3xl mx-auto text-center">
    <h1 className="text-4xl md:text-6xl font-bold mb-6 leading-[1.1]">
      Turn your affiliate program into a global growth machine.
    </h1>
    <p className="text-xl text-zinc-400 mb-8 max-w-xl mx-auto">
      Pay affiliates instantly in RLUSD ‚Äî not in 30 days. Free to join. No subscriptions. No bank accounts. No minimums.
    </p>
    <div className="flex flex-col sm:flex-row gap-4 justify-center">
      <a 
        href="#get-started" 
        className="bg-white hover:bg-zinc-200 text-black font-semibold px-6 py-3 rounded text-center transition"
      >
        Start free
      </a>
      <a 
        href="#how-it-works" 
        className="border border-zinc-700 hover:border-zinc-500 px-6 py-3 rounded text-center transition"
      >
        How it works
      </a>
    </div>
  </div>
</section>

        {/* The point */}
<section className="py-16 border-t border-zinc-800">
  <div className="grid md:grid-cols-3 gap-8 text-center">
    <div>
      <p className="text-zinc-500 text-sm mb-2">Payout speed</p>
      <p className="text-2xl font-semibold text-emerald-400">4 seconds</p>
      <p className="text-zinc-500 text-sm mt-2">Not 30 days</p>
    </div>
    <div>
  <p className="text-zinc-500 text-sm mb-2">$1 product sale</p>
  <p className="text-2xl font-semibold text-emerald-400">5 affiliates paid</p>
  <p className="text-zinc-500 text-sm mt-2">Micro-commissions, finally possible</p>
</div>
    <div>
      <p className="text-zinc-500 text-sm mb-2">International fees</p>
      <p className="text-2xl font-semibold text-emerald-400">$0</p>
      <p className="text-zinc-500 text-sm mt-2">Not $25-50 per wire</p>
    </div>
  </div>
</section>

        {/* Global access */}
<section className="py-20 border-t border-zinc-800">
  <div className="grid md:grid-cols-2 gap-12 items-center px-4 md:px-0">
    <div className="text-center md:text-left">
      <h2 className="text-3xl font-bold mb-6">Your affiliates are everywhere.</h2>
      <p className="text-zinc-400 mb-4">
        An affiliate in Lagos gets paid the same speed as one in London. No bank account. No minimum threshold. Just a wallet and a phone.
      </p>
      <p className="text-zinc-400">
        $15/month is survival wages in some countries. Your affiliate program just became their path to 3x that.
      </p>
    </div>
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8">
      <div className="space-y-4">
        <div className="flex justify-between items-center">
          <span className="text-zinc-400">London</span>
          <span className="text-emerald-400">4 seconds</span>
        </div>
        <div className="flex justify-between items-center">
          <span className="text-zinc-400">Lagos</span>
          <span className="text-emerald-400">4 seconds</span>
        </div>
        <div className="flex justify-between items-center">
          <span className="text-zinc-400">Manila</span>
          <span className="text-emerald-400">4 seconds</span>
        </div>
        <div className="flex justify-between items-center">
          <span className="text-zinc-400">S√£o Paulo</span>
          <span className="text-emerald-400">4 seconds</span>
        </div>
      </div>
      <div className="border-t border-zinc-800 mt-6 pt-6">
        <p className="text-zinc-500 text-sm">Paid in RLUSD. $1 = $1. No volatility.</p>
      </div>
    </div>
  </div>
</section>

       {/* Why we're different */}
<section className="py-20 border-t border-zinc-800">
  <div className="text-center mb-12">
    <p className="text-emerald-400 text-sm font-semibold mb-4">Why this exists</p>
    <h2 className="text-3xl font-bold mb-4">Four things. No one else combines them.</h2>
    <p className="text-zinc-400 max-w-xl mx-auto">
      Plenty of affiliate software. Plenty of rails. Nobody built on XRPL or built the bridge.
    </p>
  </div>
  
  <div className="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-center">
      <div className="text-2xl mb-3">üîå</div>
      <h3 className="font-bold mb-2">Built for affiliate payouts</h3>
      <p className="text-zinc-400 text-sm">
        Not a generic payment rail. Purpose-built for e-commerce stores paying affiliates. WooCommerce plugin. 5-tier MLM logic. Store dashboards.
      </p>
    </div>
    
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-center">
      <div className="text-2xl mb-3">‚ö°</div>
      <h3 className="font-bold mb-2">Instant & automatic</h3>
      <p className="text-zinc-400 text-sm">
        Sale happens ‚Üí affiliates paid. 4 seconds. No batching. No manual runs. No "payments processed on the 15th. Save a fortune"
      </p>
    </div>
    
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-center">
      <div className="text-2xl mb-3">üîê</div>
      <h3 className="font-bold mb-2">Non-custodial</h3>
      <p className="text-zinc-400 text-sm">
        Your wallet. Your keys. We never touch your funds. You grant permission to trigger payments within limits you set. Revoke anytime.
      </p>
    </div>
    
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-center">
      <img src="/XRP-logo.webp" alt="XRPL" className="w-8 h-8 mb-3 mx-auto" />
      <h3 className="font-bold mb-2">XRPL + RLUSD native</h3>
      <p className="text-zinc-400 text-sm">
        Built on the XRP Ledger. Paid in RLUSD stablecoin. $1 = $1. Near-zero fees. Settlement in seconds, not days.
      </p>
    </div>
  </div>
  
  <p className="text-zinc-500 text-sm text-center mt-8 max-w-2xl mx-auto">
    Traditional affiliate platforms make you wait 30 days for a wire transfer. Crypto gateways don't understand commission structures. We built what should have existed.
  </p>
</section>

        {/* How it works */}
        <section id="how-it-works" className="py-20 border-t border-zinc-800 text-center">
          <h2 className="text-3xl font-bold mb-4">How it works</h2>
          <p className="text-zinc-400 mb-12">Two minutes to set up. Then it runs itself.</p>
          
          <div className="grid md:grid-cols-2 gap-8 mb-12">
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8">
              <p className="text-zinc-500 text-sm mb-4">WordPress / WooCommerce</p>
              <ol className="space-y-3 text-zinc-300">
                <li>1. Install the plugin</li>
                <li>2. Connect your wallet</li>
                <li>3. Set commission rates</li>
              </ol>
              <p className="text-zinc-500 text-sm mt-6">That's it. Payouts happen automatically.</p>
              <a href="/guides/wordpress" className="inline-block mt-6 text-white hover:text-zinc-300 transition">
                WordPress guide ‚Üí
              </a>
            </div>
            
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8">
              <p className="text-zinc-500 text-sm mb-4">Any platform</p>
              <div className="bg-zinc-950 rounded-lg p-4 font-mono text-sm mb-4">
                <span className="text-zinc-500">$</span> npx yesallofus
              </div>
              <p className="text-zinc-400 text-sm">
                Creates your account. Returns API keys. Add one snippet to your checkout. Done.
              </p>
              <a href="/docs" className="inline-block mt-6 text-white hover:text-zinc-300 transition">
                API docs ‚Üí
              </a>
            </div>
          </div>

          <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-8 text-center">
  <div className="flex flex-col items-center">
              <div className="text-3xl">ü§ù</div>
              <div>
                <h3 className="font-bold text-lg mb-2">Want me to set it up?</h3>
                <p className="text-zinc-400 mb-4">
                  30-minute call. Any platform. I'll get you live.
                </p>
                <p className="mb-4">
                  <span className="text-zinc-500 line-through">¬£999</span>
                  <span className="text-white font-bold ml-2">¬£499</span>
                  <span className="text-zinc-500 text-sm ml-2">‚Äî first 5 stores</span>
                </p>
                <a href="https://calendly.com/tokencanvasio/30min" target="_blank" className="text-white hover:text-zinc-300 transition">
                  Book a call ‚Üí
                </a>
              </div>
            </div>
          </div>
        </section>

       {/* Security */}
<section className="py-20 border-t border-zinc-800 text-center">
  <h2 className="text-3xl font-bold mb-4">Your wallet. Your keys. Your limits.</h2>
  <p className="text-zinc-400 mb-12 max-w-xl mx-auto">
    YesAllofUs never holds your funds. You grant permission to trigger payments. Set daily limits. Revoke anytime.
  </p>
  
  {/* Web3Auth - Full Width */}
  <div className="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 border border-indigo-700/50 rounded-xl p-8 mb-8 opacity-50">
    <div className="flex items-center justify-center gap-3 mb-4">
      <div className="flex -space-x-2">
        <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center border-2 border-zinc-900">
          <svg className="w-4 h-4" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
        </div>
        <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
          <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
          </svg>
        </div>
        <div className="w-8 h-8 bg-[#1877F2] rounded-full flex items-center justify-center border-2 border-zinc-900">
          <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </div>
        <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
          <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </div>
        <div className="w-8 h-8 bg-[#5865F2] rounded-full flex items-center justify-center border-2 border-zinc-900">
          <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
          </svg>
        </div>
        <div className="w-8 h-8 bg-[#24292e] rounded-full flex items-center justify-center border-2 border-zinc-900">
          <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </div>
      </div>
      <span className="font-semibold text-xl">Social Login</span>
      <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">Coming Soon</span>
    </div>
    <p className="text-zinc-400 mb-6 max-w-2xl mx-auto">
      No wallet app needed. No seed phrases. Sign in with Google, Apple, Facebook, X, Discord, or GitHub ‚Äî we create a real XRPL wallet for you automatically using Web3Auth MPC technology.
    </p>
    <div className="grid md:grid-cols-3 gap-6 max-w-3xl mx-auto">
      <div className="text-center">
        <div className="text-2xl mb-2">ü™Ñ</div>
        <div className="font-medium text-zinc-200">5 Minute Set up</div>
        <div className="text-zinc-500 text-sm">If you use socials, you can use this</div>
      </div>
      <div className="text-center">
        <div className="text-2xl mb-2">üè¶</div>
        <div className="font-medium text-zinc-200">MPC security</div>
        <div className="text-zinc-500 text-sm">Bank-grade key security</div>
      </div>
      <div className="text-center">
        <div className="text-2xl mb-2">‚ö°</div>
        <div className="font-medium text-zinc-200">24/7 auto payouts</div>
        <div className="text-zinc-500 text-sm">Works while you sleep</div>
      </div>
    </div>
  </div>

  {/* Xaman & Crossmark */}
  <div className="grid md:grid-cols-2 gap-8">
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8">
      <div className="flex items-center justify-center gap-3 mb-4">
        <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded" />
        <span className="font-semibold">Xaman</span>
<span className="text-zinc-500 text-sm">Mobile</span>
<span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">‚úì Live</span>
      </div>
      <p className="text-zinc-400 mb-6">Approve each payout via push notification. Maximum control.</p>
      <ul className="space-y-2 text-sm text-zinc-300">
        <li>‚úì Manual approval for every payment</li>
        <li>‚úì See exactly what's being sent</li>
        <li>‚úì Best for lower volume</li>
      </ul>
    </div>
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 opacity-50">
  <div className="flex items-center justify-center gap-3 mb-4">
    <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
    <span className="font-semibold">Crossmark</span>
    <span className="text-zinc-500 text-sm">Browser</span>
    <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">Coming Soon</span>
  </div>
      <p className="text-zinc-400 mb-6">Automatic payouts within limits you set. Hands-off.</p>
      <ul className="space-y-2 text-sm text-zinc-300">
        <li>‚úì Revoke permission anytime</li>
        <li>‚úì Set max per transaction</li>
        <li>‚úì Set daily limit</li>
      </ul>
    </div>
  </div>
  
  <p className="text-zinc-500 text-sm mt-8 text-center">
    Every transaction is public on the XRP Ledger. Anyone can verify. Nothing hidden.
  </p>
</section>

        {/* Multi-level */}
        <section className="py-20 border-t border-zinc-800 text-center">
          <h2 className="text-3xl font-bold mb-4">Five levels deep. All instant.</h2>
          <p className="text-zinc-400 mb-12 max-w-xl mx-auto">
            Affiliates refer affiliates. Everyone gets paid the moment the sale happens. You set the rates.
          </p>
          
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 max-w-lg mx-auto">
            <div className="space-y-3 font-mono text-sm">
              <div className="flex justify-between">
                <span className="text-zinc-400">Level 1 (direct)</span>
                <span className="text-white">25%</span>
              </div>
              <div className="flex justify-between">
                <span className="text-zinc-400">Level 2</span>
                <span className="text-white">5%</span>
              </div>
              <div className="flex justify-between">
                <span className="text-zinc-400">Level 3</span>
                <span className="text-white">3%</span>
              </div>
              <div className="flex justify-between">
                <span className="text-zinc-400">Level 4</span>
                <span className="text-white">2%</span>
              </div>
              <div className="flex justify-between">
                <span className="text-zinc-400">Level 5</span>
                <span className="text-white">1%</span>
              </div>
            </div>
            <div className="border-t border-zinc-800 mt-6 pt-6">
              <p className="text-zinc-500 text-sm">Default rates. Fully configurable.</p>
            </div>
          </div>
        </section>

       {/* Refer stores */}
<section className="py-20 border-t border-zinc-800">
  <div className="grid md:grid-cols-2 gap-12 items-center">
    <div className="text-center md:text-left max-w-md mx-auto md:mx-0 md:max-w-none">
      <h2 className="text-3xl font-bold mb-4">Refer other stores.</h2>
      <p className="text-zinc-400 mb-4">
        Know someone who should use this? Give them your referral code. You earn 25% of their platform fees. Forever.
      </p>
      <p className="text-zinc-400">
        They get 50% off their first month. You get passive income every time they pay affiliates.
      </p>
    </div>
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 text-center md:text-left max-w-md mx-auto md:mx-0 md:max-w-none">
      <p className="text-zinc-500 text-sm mb-2">Vendor B processes $10k in commissions</p>
      <p className="text-zinc-500 text-sm mb-2">Platform fee: $290</p>
      <p className="text-2xl font-semibold text-emerald-400">You earn: $72.50</p>
      <p className="text-zinc-500 text-sm mt-4">Every month. Automatically.</p>
    </div>
  </div>
</section>

        {/* Reputation */}
        <section className="py-20 border-t border-zinc-800 text-center">
          <div className="max-w-2xl mx-auto">
            <p className="text-emerald-400 text-sm font-semibold mb-4">Coming soon</p>
            <h2 className="text-3xl font-bold mb-4">Your reputation. On-chain.</h2>
            <p className="text-zinc-400 mb-6">
              Every payout builds a verifiable history. Transaction volume. Success rate. Consistency. All recorded. All portable. All yours.
            </p>
            <p className="text-zinc-400 mb-6">
              We're building merchant reputation scores that DeFi protocols can read. Undercollateralized lending reputation building based on your actual track record, not your paperwork.
            </p>
            <p className="text-zinc-500 text-sm italic">
              Own your reputation. Built on your hard work. Proven on-chain.
            </p>
          </div>
        </section>

        {/* Pricing */}
        <section id="pricing" className="py-20 border-t border-zinc-800 text-center">
          <h2 className="text-3xl font-bold mb-4">Pricing</h2>
          <p className="text-zinc-400 mb-12">Percentage of commissions paid, not sales. Start free.</p>
          
          <div className="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto">
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
              <h3 className="font-bold mb-1">Free</h3>
              <p className="text-zinc-500 text-sm mb-6">Up to $25k/month</p>
              <p className="text-4xl font-bold mb-1">2.9%</p>
              <p className="text-zinc-500 text-sm">per payout</p>
            </div>
            <div className="bg-zinc-900 border border-white/20 rounded-xl p-6">
              <h3 className="font-bold mb-1">Pro</h3>
              <p className="text-zinc-500 text-sm mb-6">$25k‚Äì$250k/month</p>
              <p className="text-4xl font-bold mb-1">0.9%</p>
              <p className="text-zinc-500 text-sm">+ $99/mo</p>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
              <h3 className="font-bold mb-1">Enterprise</h3>
              <p className="text-zinc-500 text-sm mb-6">$250k+/month</p>
              <p className="text-4xl font-bold mb-1">Flat</p>
              <p className="text-zinc-500 text-sm">$499/mo</p>
            </div>
          </div>
          
          <p className="text-zinc-500 text-sm mt-8">
            That's 2.9% of the commission, not the sale. $100 order, $25 commission = $0.73 fee.
          </p>
        </section>

        {/* CTA */}
        <section id="get-started" className="py-20 border-t border-zinc-800 text-center">
          <h2 className="text-3xl font-bold mb-4">No more payment spreadsheets.</h2>
<p className="text-zinc-400 mb-8">Let the Ledger take care of it. It's automatic.</p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <a 
              href="/guides/wordpress" 
              className="bg-white hover:bg-zinc-200 text-black font-semibold px-8 py-4 rounded transition text-center"
            >
              WordPress
            </a>
            <a 
              href="/docs" 
              className="border border-zinc-700 hover:border-zinc-500 px-8 py-4 rounded transition text-center"
            >
              API / Developer
            </a>
            <a 
              href="https://calendly.com/tokencanvasio/30min" 
              target="_blank"
              className="border border-zinc-700 hover:border-zinc-500 px-8 py-4 rounded transition text-center"
            >
              Done for you ‚Äî ¬£499
            </a>
          </div>
        </section>

      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/layout.tsx
// =================================================
// MARK: - Imports & Dependencies
import Header from "@/components/Header";
import Footer from "@/components/Footer";


// MARK: - Component Definition
export default function MainLayout({
  children,
}: {
  children: React.ReactNode;
}) {

// MARK: - Main Render
  return (
    <>
      <Header />
      {children}
      <Footer />
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/press/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useRef, useState } from 'react';


// MARK: - Component Definition
export default function Press() {

// MARK: - State Management
  const [activeSection, setActiveSection] = useState(0);
  const containerRef = useRef<HTMLDivElement>(null);

  const sections = [
    'Overview',
    'The Story',
    'Timeline',
    'Key Facts',
    'Media Kit',
    'Contact'
  ];


// MARK: - Hooks & Effects
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    const sectionElements = container.querySelectorAll('.scroll-section');
    
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const index = Array.from(sectionElements).indexOf(entry.target as Element);
            setActiveSection(index);
          }
        });
      },
      { threshold: 0.5 }
    );

    sectionElements.forEach((section) => observer.observe(section));
    return () => observer.disconnect();
  }, []);


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">

      {/* Progress Indicator */}
      <div className="fixed right-6 top-1/2 -translate-y-1/2 z-40 hidden lg:flex flex-col gap-2">
        {sections.map((label, i) => (
          <button
            key={i}

// MARK: - Event Handlers
            onClick={() => {
              const sectionElements = document.querySelectorAll('.scroll-section');
              sectionElements[i]?.scrollIntoView({ behavior: 'smooth' });
            }}
            className={`group flex items-center gap-3 transition-all ${
              activeSection === i ? 'opacity-100' : 'opacity-30 hover:opacity-60'
            }`}
          >
            <span className={`text-[10px] font-medium transition-all whitespace-nowrap ${
              activeSection === i ? 'text-emerald-400 translate-x-0 opacity-100' : 'text-zinc-500 translate-x-2 opacity-0 group-hover:opacity-100 group-hover:translate-x-0'
            }`}>
              {label}
            </span>
            <div className={`w-2 h-2 rounded-full transition-all ${
              activeSection === i ? 'bg-emerald-400 scale-125' : 'bg-zinc-700'
            }`} />
          </button>
        ))}
      </div>

      <div ref={containerRef}>
        
        {/* ==================== SECTION 0: OVERVIEW ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 pt-6">
          <div className="max-w-4xl mx-auto text-center">
            <div className="inline-flex items-center gap-2 bg-zinc-800/50 border border-zinc-700/50 rounded-full px-4 py-1.5 mb-8">
              <span className="text-zinc-400 text-sm font-medium">üì∞ Press & Media</span>
            </div>
            
            <h1 className="text-5xl md:text-7xl font-bold mb-6 leading-[1.1]">
              YesAllofUs
            </h1>
            
            <p className="text-2xl text-zinc-400 max-w-2xl mx-auto mb-8">
              Instant affiliate commission payouts on the XRP Ledger.
            </p>

            <p className="text-lg text-zinc-500 max-w-xl mx-auto mb-12">
              A non-custodial payments solution that pays affiliates in 4 seconds, not 30 days. 
              Built in Guernsey. Powered by RLUSD.
            </p>

            <div className="flex flex-wrap justify-center gap-4 mb-16">
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl px-6 py-4 text-center">
                <p className="text-3xl font-bold text-emerald-400">4 sec</p>
                <p className="text-zinc-500 text-sm">Payout speed</p>
              </div>
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl px-6 py-4 text-center">
                <p className="text-3xl font-bold text-white">$0</p>
                <p className="text-zinc-500 text-sm">Monthly fee</p>
              </div>
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl px-6 py-4 text-center">
                <p className="text-3xl font-bold text-white">3</p>
                <p className="text-zinc-500 text-sm">Pilot vendors</p>
              </div>
            </div>

            <div className="animate-bounce">
              <svg className="w-6 h-6 mx-auto text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
              </svg>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 1: THE STORY ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-emerald-950/5 to-[#0a0a0a]">
          <div className="max-w-3xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                The <span className="text-emerald-400">Story</span>
              </h2>
            </div>

            <div className="flex flex-col md:flex-row gap-8 items-center mb-12">
              <img 
                src="/mark.jpg" 
                alt="Mark Flynn" 
                className="w-32 h-32 rounded-full object-cover border-2 border-zinc-800"
              />
              <div>
                <h3 className="text-xl font-bold mb-2">Mark Flynn</h3>
                <p className="text-emerald-400 mb-4">Founder ¬∑ Family Therapist ‚Üí Developer</p>
                <p className="text-zinc-400">
                  Based in Guernsey, Channel Islands
                </p>
              </div>
            </div>

            <div className="space-y-6 text-zinc-300">
              <p className="text-lg">
                Mark spent years as a family therapist working with children in care. 
                That work taught him one thing: <strong className="text-white">connection matters</strong>. 
                People thrive when they're part of something, when they're not left behind.
              </p>
              
              <p className="text-lg">
                In June 2025, with no coding experience, he started building. Six months later, 
                he'd shipped three production platforms on the XRP Ledger ‚Äî including one ranking 
                #7 on Google for its keyword.
              </p>

              <p className="text-lg">
                YesAllofUs is the next step: <strong className="text-white">real infrastructure for real businesses</strong>. 
                A system where the affiliate in Lagos gets paid the same speed as the one in London. 
                No bank account required. No 30-day wait. No minimum threshold.
              </p>

              <blockquote className="border-l-4 border-emerald-500 pl-6 py-2 my-8">
                <p className="text-xl italic text-zinc-300">
                  "YesAllofUs means everyone gets their share. All of us."
                </p>
              </blockquote>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 2: TIMELINE ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-3xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                <span className="text-emerald-400">Timeline</span>
              </h2>
            </div>

            <div className="space-y-0">
              {[
                { 
                  date: 'June 2025', 
                  title: 'Started coding', 
                  desc: 'No prior programming experience. AI as engineering partner.',
                  highlight: false
                },
                { 
                  date: 'June ‚Äì Nov 2025', 
                  title: 'Built 3 production platforms', 
                  desc: 'TokenCanvas.io, XRP3D.ai, XRPMemeCoins.com ‚Äî all on XRPL.',
                  highlight: false
                },
                { 
                  date: 'Nov 29, 2025', 
                  title: 'YesAllofUs goes live', 
                  desc: 'Instant affiliate payouts on the XRP Ledger.',
                  highlight: true
                },
                { 
                  date: 'Dec 1, 2025', 
                  title: 'XRPL Commons takes notice', 
                  desc: 'Within 36 hours of launch, approached by XRPL Commons.',
                  highlight: true
                },
                { 
                  date: 'Dec 10, 2025', 
                  title: 'Paris meeting', 
                  desc: 'Flew to Paris for XRPL Commons discussions.',
                  highlight: false
                },
                { 
                  date: 'Dec 11, 2025', 
                  title: 'Guernsey meetings', 
                  desc: 'Met with business leaders and financial regulators.',
                  highlight: false
                },
                { 
                  date: 'Q1 2026', 
                  title: 'Incorporation', 
                  desc: 'YesAllofUs Ltd to be registered in Guernsey.',
                  highlight: false
                },
                { 
                  date: 'April 2026', 
                  title: 'XRPL Commons Residency', 
                  desc: 'Target start date for the residency program.',
                  highlight: true
                },
              ].map((item, i) => (
                <div key={i} className="flex gap-6">
                  {/* Timeline line */}
                  <div className="flex flex-col items-center">
                    <div className={`w-3 h-3 rounded-full ${item.highlight ? 'bg-emerald-400' : 'bg-zinc-700'}`} />
                    {i < 7 && <div className="w-0.5 h-full bg-zinc-800 min-h-[80px]" />}
                  </div>
                  
                  {/* Content */}
                  <div className="pb-8">
                    <p className={`text-sm font-medium mb-1 ${item.highlight ? 'text-emerald-400' : 'text-zinc-500'}`}>
                      {item.date}
                    </p>
                    <h3 className="text-lg font-semibold text-white mb-1">{item.title}</h3>
                    <p className="text-zinc-400 text-sm">{item.desc}</p>
                  </div>
                </div>
              ))}
            </div>

            {/* Regulatory note */}
            <div className="mt-8 bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
              <p className="text-zinc-400 text-sm">
                In December 2025, YesAllofUs was presented to Guernsey financial regulators as a potential 
                growth solution for an emerging institutional initiative. Further details will be announced in 2026.
              </p>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 3: KEY FACTS ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-zinc-900/50 to-[#0a0a0a]">
          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                Key <span className="text-emerald-400">Facts</span>
              </h2>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              {[
                { label: 'Founded', value: 'November 2025' },
                { label: 'Headquarters', value: 'Guernsey, Channel Islands' },
                { label: 'Founder', value: 'Mark Flynn' },
                { label: 'Status', value: 'Live with pilot vendors' },
                { label: 'Technology', value: 'XRP Ledger (XRPL)' },
                { label: 'Currency', value: 'RLUSD (Ripple stablecoin)' },
                { label: 'Payout Speed', value: '3-5 seconds' },
                { label: 'Custody', value: 'Non-custodial' },
              ].map((item, i) => (
                <div key={i} className="flex justify-between items-center py-4 border-b border-zinc-800">
                  <span className="text-zinc-500">{item.label}</span>
                  <span className="text-white font-medium">{item.value}</span>
                </div>
              ))}
            </div>

            {/* What it does */}
            <div className="mt-12 grid md:grid-cols-3 gap-6">
              {[
                { 
                  icon: '‚ö°', 
                  title: 'Instant Payouts', 
                  desc: 'Affiliates paid in 4 seconds, not 30-90 days' 
                },
                { 
                  icon: 'üîê', 
                  title: 'Non-Custodial', 
                  desc: 'Merchants control their own wallets and funds' 
                },
                { 
                  icon: 'üåç', 
                  title: 'Global Access', 
                  desc: 'No bank account required. Works anywhere.' 
                },
              ].map((item, i) => (
                <div key={i} className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 text-center">
                  <div className="text-3xl mb-3">{item.icon}</div>
                  <h3 className="font-semibold mb-2">{item.title}</h3>
                  <p className="text-zinc-500 text-sm">{item.desc}</p>
                </div>
              ))}
            </div>

            {/* Current status */}
            <div className="mt-12 bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6">
              <h3 className="font-semibold text-emerald-400 mb-2">Current Status</h3>
              <p className="text-zinc-300 text-sm">
                YesAllofUs is live with 3 pilot vendors using the Xaman push notification commission solution. 
                The system is fully compliant and operational, processing instant affiliate payouts on the XRP Ledger.
              </p>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 4: MEDIA KIT ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-5xl font-bold mb-4">
                Media <span className="text-emerald-400">Kit</span>
              </h2>
              <p className="text-zinc-400">Download assets for press coverage</p>
            </div>

            {/* Logo Downloads */}
            <div className="mb-12">
              <h3 className="text-xl font-semibold mb-6">Logos</h3>
              <div className="grid md:grid-cols-3 gap-6">
                {/* SVG */}
                <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
                  <div className="h-24 flex items-center justify-center mb-4 bg-zinc-800 rounded-lg">
                    <img src="/favicon.svg" alt="YesAllofUs Logo" className="h-12" />
                  </div>
                  <p className="font-medium mb-1">Logo (SVG)</p>
                  <p className="text-zinc-500 text-sm mb-4">Vector, scalable</p>
                  <a 
                    href="/press/logo.svg" 
                    download
                    className="flex items-center justify-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition w-full"
                  >
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download
                  </a>
                </div>

                {/* PNG Dark */}
                <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
                  <div className="h-24 flex items-center justify-center mb-4 bg-white rounded-lg">
                    <img src="/favicon.svg" alt="YesAllofUs Logo" className="h-12" />
                  </div>
                  <p className="font-medium mb-1">Logo (PNG)</p>
                  <p className="text-zinc-500 text-sm mb-4">For light backgrounds</p>
                  <a 
                    href="/press/logo-dark.png" 
                    download
                    className="flex items-center justify-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition w-full"
                  >
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download
                  </a>
                </div>

                {/* PNG Light */}
                <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
                  <div className="h-24 flex items-center justify-center mb-4 bg-zinc-800 rounded-lg">
                    <img src="/favicon.svg" alt="YesAllofUs Logo" className="h-12" />
                  </div>
                  <p className="font-medium mb-1">Logo (PNG)</p>
                  <p className="text-zinc-500 text-sm mb-4">For dark backgrounds</p>
                  <a 
                    href="/press/logo-light.png" 
                    download
                    className="flex items-center justify-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition w-full"
                  >
                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download
                  </a>
                </div>
              </div>
            </div>

            {/* Brand Colors */}
            <div className="mb-12">
              <h3 className="text-xl font-semibold mb-6">Brand Colors</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {[
                  { name: 'Emerald', hex: '#10B981', class: 'bg-emerald-500' },
                  { name: 'Dark', hex: '#0A0A0A', class: 'bg-[#0a0a0a] border border-zinc-700' },
                  { name: 'Zinc 900', hex: '#18181B', class: 'bg-zinc-900' },
                  { name: 'White', hex: '#FFFFFF', class: 'bg-white' },
                ].map((color, i) => (
                  <div key={i} className="text-center">
                    <div className={`h-16 rounded-lg mb-2 ${color.class}`} />
                    <p className="font-medium text-sm">{color.name}</p>
                    <p className="text-zinc-500 text-xs">{color.hex}</p>
                  </div>
                ))}
              </div>
            </div>

            {/* Boilerplate */}
            <div>
              <h3 className="text-xl font-semibold mb-6">Boilerplate</h3>
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
                <p className="text-zinc-300 text-sm leading-relaxed">
                  <strong className="text-white">YesAllofUs</strong> is an instant affiliate commission platform built on the XRP Ledger. Founded in 2025 by Mark Flynn in Guernsey, Channel Islands, the platform enables merchants to pay affiliates in seconds rather than the traditional 30-90 day wait. Using RLUSD stablecoin and non-custodial wallet technology, YesAllofUs provides global access to affiliate earnings without requiring a bank account. The platform is currently live with pilot vendors and working towards XRPL Commons residency in 2025, and cementing its place as providing key software infrastructure for a critically important - newly forming - institution in the Channel Islands.
                </p>
                <button 
                  onClick={() => {
                    navigator.clipboard.writeText("YesAllofUs is an instant affiliate commission platform built on the XRP Ledger. Founded in 2025 by Mark Flynn in Guernsey, Channel Islands, the platform enables merchants to pay affiliates in seconds rather than the traditional 30-90 day wait. Using RLUSD stablecoin and non-custodial wallet technology, YesAllofUs provides global access to affiliate earnings without requiring a bank account. The platform is currently live with pilot vendors and working towards XRPL Commons residency in 2025.");
                  }}
                  className="mt-4 text-emerald-400 hover:text-emerald-300 text-sm flex items-center gap-2"
                >
                  <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                  Copy to clipboard
                </button>
              </div>
            </div>
          </div>
        </section>

        {/* ==================== SECTION 5: CONTACT ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-emerald-950/5 to-[#0a0a0a]">
          <div className="max-w-2xl mx-auto text-center">
            <h2 className="text-3xl md:text-5xl font-bold mb-4">
              Press <span className="text-emerald-400">Contact</span>
            </h2>
            <p className="text-zinc-400 text-lg mb-12">
              For press inquiries, interviews, or additional information
            </p>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-8 mb-8">
              <div className="flex flex-col items-center gap-4">
                <img 
                  src="/mark.jpg" 
                  alt="Mark Flynn" 
                  className="w-20 h-20 rounded-full object-cover"
                />
                <div>
                  <h3 className="font-bold text-lg">Mark Flynn</h3>
                  <p className="text-zinc-400">Founder, YesAllofUs</p>
                </div>
              </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <a 
                href="mailto:mark@yesallofus.com" 
                className="flex items-center justify-center gap-2 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-6 py-3 rounded-xl transition"
              >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                mark@yesallofus.com
              </a>
              <a 
                href="https://x.com/YesAllofUs" 
                target="_blank"
                rel="noopener noreferrer"
                className="flex items-center justify-center gap-2 border border-zinc-700 hover:border-zinc-500 px-6 py-3 rounded-xl transition"
              >
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                </svg>
                @YesAllofUs
              </a>
            </div>

            <p className="text-zinc-600 text-sm mt-12">
              Response time: Usually within 24 hours
            </p>
          </div>
        </section>

      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/privacy/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React, { useState, ReactNode } from 'react';


// MARK: - Component Definition
export default function PrivacyPolicy() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-12">
          <h1 className="text-4xl font-bold text-slate-900 mb-4">Privacy Policy</h1>
          <p className="text-slate-600">Last updated: 28 November 2025</p>
        </div>

        {/* Plain English Summary */}
        <div className="bg-green-50 border border-green-200 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-green-900 mb-3">üîí Privacy at a Glance</h2>
          <ul className="text-green-800 text-sm space-y-2">
            <li><strong>We collect minimal data:</strong> Just what&apos;s needed to run the service (email, account URL, wallet addresses).</li>
            <li><strong>We never sell your data:</strong> Your information is never sold to third parties. Period.</li>
            <li><strong>Blockchain is public:</strong> Wallet addresses and transactions are visible on the XRP Ledger ‚Äî that&apos;s how blockchain works.</li>
            <li><strong>You can delete your account:</strong> Request deletion and we&apos;ll remove your data (except blockchain records, which are immutable).</li>
            <li><strong>We use minimal cookies:</strong> Only essential cookies for the service to function. No tracking or advertising cookies.</li>
          </ul>
        </div>

        {/* Table of Contents */}
        <div className="bg-slate-50 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-slate-900 mb-4">Table of Contents</h2>
          <ol className="text-sm text-slate-600 space-y-2 columns-2">
            <li><a href="#who-we-are" className="hover:text-blue-600">1. Who We Are</a></li>
            <li><a href="#data-we-collect" className="hover:text-blue-600">2. Data We Collect</a></li>
            <li><a href="#how-we-use" className="hover:text-blue-600">3. How We Use Your Data</a></li>
            <li><a href="#legal-basis" className="hover:text-blue-600">4. Legal Basis for Processing</a></li>
            <li><a href="#data-sharing" className="hover:text-blue-600">5. Data Sharing</a></li>
            <li><a href="#blockchain-data" className="hover:text-blue-600">6. Blockchain Data</a></li>
            <li><a href="#data-retention" className="hover:text-blue-600">7. Data Retention</a></li>
            <li><a href="#your-rights" className="hover:text-blue-600">8. Your Rights</a></li>
            <li><a href="#data-security" className="hover:text-blue-600">9. Data Security</a></li>
            <li><a href="#international" className="hover:text-blue-600">10. International Transfers</a></li>
            <li><a href="#children" className="hover:text-blue-600">11. Children&apos;s Privacy</a></li>
            <li><a href="#changes" className="hover:text-blue-600">12. Changes to This Policy</a></li>
            <li><a href="#contact" className="hover:text-blue-600">13. Contact Us</a></li>
          </ol>
        </div>

        {/* Content */}
        <div className="prose prose-slate max-w-none">

          {/* 1. Who We Are */}
          <section id="who-we-are" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">1. Who We Are</h2>
            <p className="text-slate-700 mb-4">
              YesAllofUs is a B2B payment infrastructure technology provider operated by Mark Flynn, based in Guernsey, Channel Islands. We are the data controller for the personal data processed through our service.
            </p>
            <div className="bg-slate-50 rounded-lg p-4">
              <p className="text-slate-700"><strong>Data Controller:</strong> Mark Flynn (YesAllofUs)</p>
              <p className="text-slate-700"><strong>Location:</strong> Guernsey, Channel Islands</p>
              <p className="text-slate-700"><strong>Email:</strong> <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a></p>
            </div>
          </section>

          {/* 2. Data We Collect */}
          <section id="data-we-collect" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">2. Data We Collect</h2>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">2.1 Information You Provide</h3>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Data Type</th>
                  <th className="px-4 py-2 text-left text-slate-700">Examples</th>
                  <th className="px-4 py-2 text-left text-slate-700">Purpose</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">Account Information</td>
                  <td className="px-4 py-2">Vendor name, account URL, email address</td>
                  <td className="px-4 py-2">Account creation and communication</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Wallet Addresses</td>
                  <td className="px-4 py-2">XRP Ledger addresses (public keys)</td>
                  <td className="px-4 py-2">Processing payments</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Affiliate Data</td>
                  <td className="px-4 py-2">Wallet addresses, referral codes</td>
                  <td className="px-4 py-2">Commission tracking and payments</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Payment Information</td>
                  <td className="px-4 py-2">PayPal email (for subscriptions)</td>
                  <td className="px-4 py-2">Subscription billing</td>
                  <tr className="border-t bg-slate-50">
  <td className="px-4 py-2">Web3Auth</td>
  <td className="px-4 py-2">Authentication tokens</td>
  <td className="px-4 py-2">Social login wallet creation</td>
</tr>
                </tr>
              </tbody>
            </table>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">2.2 Information Collected Automatically</h3>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Data Type</th>
                  <th className="px-4 py-2 text-left text-slate-700">Examples</th>
                  <th className="px-4 py-2 text-left text-slate-700">Purpose</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">API Usage Data</td>
                  <td className="px-4 py-2">Endpoints called, timestamps, IP addresses</td>
                  <td className="px-4 py-2">Rate limiting, security, debugging</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Transaction Records</td>
                  <td className="px-4 py-2">Order IDs, amounts, payout status</td>
                  <td className="px-4 py-2">Service delivery, record keeping</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Device Information</td>
                  <td className="px-4 py-2">Browser type, operating system</td>
                  <td className="px-4 py-2">Compatibility, troubleshooting</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Log Data</td>
                  <td className="px-4 py-2">Error logs, access logs</td>
                  <td className="px-4 py-2">Debugging, security monitoring</td>
                </tr>
              </tbody>
            </table>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">2.3 Information We Do NOT Collect</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li>Private keys or wallet seeds</li>
              <li>Personal identification documents</li>
              <li>Social Security or national ID numbers</li>
              <li>Banking details (other than PayPal for subscriptions)</li>
              <li>Biometric data</li>
              <li>Health or medical information</li>
            </ul>
          </section>

          {/* 3. How We Use Your Data */}
          <section id="how-we-use" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">3. How We Use Your Data</h2>
            <p className="text-slate-700 mb-4">We use your personal data for the following purposes:</p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.1 Service Delivery</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Creating and managing your account</li>
              <li>Processing affiliate commission payments</li>
              <li>Connecting your wallet to the service</li>
              <li>Sending transaction notifications</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.2 Communication</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Responding to support requests</li>
              <li>Sending service updates and announcements</li>
              <li>Notifying you of changes to our terms or policies</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.3 Security and Fraud Prevention</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Monitoring for suspicious activity</li>
              <li>Enforcing rate limits</li>
              <li>Preventing abuse of the service</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.4 Service Improvement</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Analysing usage patterns to improve the service</li>
              <li>Debugging technical issues</li>
              <li>Developing new features</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.5 Legal Compliance</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li>Complying with applicable laws and regulations</li>
              <li>Responding to lawful requests from authorities</li>
              <li>Establishing, exercising, or defending legal claims</li>
            </ul>
          </section>

          {/* 4. Legal Basis for Processing */}
          <section id="legal-basis" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">4. Legal Basis for Processing</h2>
            <p className="text-slate-700 mb-4">Under GDPR and similar privacy laws, we process your data based on:</p>

            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Legal Basis</th>
                  <th className="px-4 py-2 text-left text-slate-700">Applies To</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2 font-medium">Contract Performance</td>
                  <td className="px-4 py-2">Processing payments, managing your account, delivering the service you signed up for</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2 font-medium">Legitimate Interests</td>
                  <td className="px-4 py-2">Security monitoring, fraud prevention, service improvement, analytics</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2 font-medium">Legal Obligation</td>
                  <td className="px-4 py-2">Complying with tax laws, responding to legal requests, maintaining required records</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2 font-medium">Consent</td>
                  <td className="px-4 py-2">Marketing communications (where applicable)</td>
                </tr>
              </tbody>
            </table>
          </section>

          {/* 5. Data Sharing */}
          <section id="data-sharing" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">5. Data Sharing</h2>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.1 We Share Data With:</h3>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Recipient</th>
                  <th className="px-4 py-2 text-left text-slate-700">Data Shared</th>
                  <th className="px-4 py-2 text-left text-slate-700">Purpose</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">XRP Ledger</td>
                  <td className="px-4 py-2">Wallet addresses, transaction amounts</td>
                  <td className="px-4 py-2">Payment execution (public blockchain)</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Xaman/Crossmark</td>
                  <td className="px-4 py-2">Vendor name (in signing requests)</td>
                  <td className="px-4 py-2">Wallet connection</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Firebase (Google)</td>
                  <td className="px-4 py-2">Account data, transaction records</td>
                  <td className="px-4 py-2">Database hosting</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">DigitalOcean</td>
                  <td className="px-4 py-2">Server logs</td>
                  <td className="px-4 py-2">Infrastructure hosting</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">PayPal</td>
                  <td className="px-4 py-2">Email, subscription amount</td>
                  <td className="px-4 py-2">Subscription billing</td>
                </tr>
              </tbody>
            </table>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.2 We Do NOT:</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li>Sell your personal data to third parties</li>
              <li>Share your data with advertisers</li>
              <li>Use your data for profiling or targeted advertising</li>
              <li>Share your data with data brokers</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.3 Legal Disclosures</h3>
            <p className="text-slate-700 mb-4">
              We may disclose your data if required by law, court order, or government request, or if we believe disclosure is necessary to protect our rights, your safety, or the safety of others.
            </p>
          </section>

          {/* 6. Blockchain Data */}
          <section id="blockchain-data" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">6. Blockchain Data</h2>

            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
              <p className="text-amber-800 text-sm">
                <strong>Important:</strong> The XRP Ledger is a public blockchain. Transactions recorded on it are permanent, transparent, and cannot be deleted or modified by anyone, including YesAllofUs.
              </p>
            </div>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.1 What&apos;s Public on the Blockchain</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Wallet addresses (sender and recipient)</li>
              <li>Transaction amounts</li>
              <li>Transaction timestamps</li>
              <li>Transaction memos (containing order IDs)</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.2 What&apos;s NOT on the Blockchain</h3>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Your name or email address</li>
              <li>Your name or URL</li>
              <li>Any personal identification</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.3 Wallet Address Pseudonymity</h3>
            <p className="text-slate-700 mb-4">
              While wallet addresses are public, they are pseudonymous ‚Äî they don&apos;t inherently reveal your identity. However, if you publicly associate your wallet address with your identity (e.g., on social media), that connection becomes public.
            </p>
          </section>

          {/* 7. Data Retention */}
          <section id="data-retention" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">7. Data Retention</h2>

            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Data Type</th>
                  <th className="px-4 py-2 text-left text-slate-700">Retention Period</th>
                  <th className="px-4 py-2 text-left text-slate-700">Reason</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">Account Data</td>
                  <td className="px-4 py-2">Until deletion requested + 30 days</td>
                  <td className="px-4 py-2">Service delivery</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Transaction Records</td>
                  <td className="px-4 py-2">7 years</td>
                  <td className="px-4 py-2">Tax and legal compliance</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">API Logs</td>
                  <td className="px-4 py-2">90 days</td>
                  <td className="px-4 py-2">Debugging, security</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Support Communications</td>
                  <td className="px-4 py-2">2 years</td>
                  <td className="px-4 py-2">Service quality</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Blockchain Data</td>
                  <td className="px-4 py-2">Permanent</td>
                  <td className="px-4 py-2">Immutable by design</td>
                </tr>
              </tbody>
            </table>
          </section>

          {/* 8. Your Rights */}
          <section id="your-rights" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">8. Your Rights</h2>
            <p className="text-slate-700 mb-4">Under GDPR and similar laws, you have the following rights:</p>

            <div className="space-y-4">
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Right of Access</h4>
                <p className="text-slate-600 text-sm">Request a copy of the personal data we hold about you.</p>
              </div>
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Right to Rectification</h4>
                <p className="text-slate-600 text-sm">Request correction of inaccurate or incomplete data.</p>
              </div>
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Right to Erasure (&quot;Right to be Forgotten&quot;)</h4>
                <p className="text-slate-600 text-sm">Request deletion of your data. Note: This does not apply to blockchain data, which is immutable.</p>
              </div>
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Right to Restrict Processing</h4>
                <p className="text-slate-600 text-sm">Request that we limit how we use your data.</p>
              </div>
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Right to Data Portability</h4>
                <p className="text-slate-600 text-sm">Receive your data in a structured, machine-readable format.</p>
              </div>
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Right to Object</h4>
                <p className="text-slate-600 text-sm">Object to processing based on legitimate interests.</p>
              </div>
              <div className="border border-slate-200 rounded-lg p-4">
                <h4 className="font-semibold text-slate-800">Right to Withdraw Consent</h4>
                <p className="text-slate-600 text-sm">Withdraw consent for processing that relies on consent.</p>
              </div>
            </div>

            <p className="text-slate-700 mt-6">
              To exercise any of these rights, contact us at <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a>. We will respond within 30 days.
            </p>
          </section>

          {/* 9. Data Security */}
          <section id="data-security" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">9. Data Security</h2>
            <p className="text-slate-700 mb-4">We implement appropriate technical and organisational measures to protect your data:</p>

            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li><strong>Encryption in Transit:</strong> All API communications use TLS 1.2+</li>
              <li><strong>Encryption at Rest:</strong> Database data is encrypted using AES-256</li>
              <li><strong>Access Controls:</strong> API credentials are hashed; only you know your api_secret</li>
              <li><strong>Rate Limiting:</strong> Protection against brute force and DDoS attacks</li>
              <li><strong>Regular Backups:</strong> Data is backed up daily with encrypted storage</li>
              <li><strong>Monitoring:</strong> We monitor for unauthorised access attempts</li>
            </ul>

            <p className="text-slate-700 mt-4">
              Despite our efforts, no system is 100% secure. If you discover a security vulnerability, please report it to <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a>.
            </p>
          </section>

          {/* 10. International Transfers */}
          <section id="international" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">10. International Data Transfers</h2>
            <p className="text-slate-700 mb-4">
              YesAllofUs is based in Guernsey, Channel Islands. Your data may be transferred to and processed in:
            </p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li><strong>United States:</strong> Google Firebase (database), DigitalOcean (servers)</li>
              <li><strong>European Union:</strong> Some server locations</li>
              <li><strong>Globally:</strong> XRP Ledger nodes are distributed worldwide</li>
            </ul>
            <p className="text-slate-700">
              Where data is transferred outside Guernsey/EU, we ensure appropriate safeguards are in place, such as Standard Contractual Clauses or adequacy decisions.
            </p>
          </section>

          {/* 11. Children's Privacy */}
          <section id="children" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">11. Children&apos;s Privacy</h2>
            <p className="text-slate-700 mb-4">
              YesAllofUs is not intended for use by anyone under 18 years of age. We do not knowingly collect personal data from children. If you believe a child has provided us with personal data, please contact us and we will delete it.
            </p>
          </section>

          {/* 12. Changes */}
          <section id="changes" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">12. Changes to This Policy</h2>
            <p className="text-slate-700 mb-4">
              We may update this Privacy Policy from time to time. We will notify you of material changes by:
            </p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2">
              <li>Posting the updated policy on our website</li>
              <li>Updating the &quot;Last updated&quot; date at the top</li>
              <li>Sending an email notification for significant changes</li>
            </ul>
          </section>

          {/* 13. Contact */}
          <section id="contact" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">13. Contact Us</h2>
            <p className="text-slate-700 mb-4">For privacy-related questions or to exercise your rights:</p>
            <div className="bg-slate-50 rounded-lg p-6">
              <p className="text-slate-700"><strong>YesAllofUs</strong></p>
              <p className="text-slate-700">Mark Flynn</p>
              <p className="text-slate-700">Guernsey, Channel Islands</p>
              <p className="text-slate-700 mt-2">
                <strong>Email:</strong> <a href="mailto:mark@YesAllofUs.com" className="text-blue-600">mark@YesAllofUs.com</a>
              </p>
            </div>
            <p className="text-slate-700 mt-4">
              If you&apos;re not satisfied with our response, you have the right to lodge a complaint with a data protection authority.
            </p>
          </section>

        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/resources/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useRef, useState } from 'react';
import Link from 'next/link';


// MARK: - Component Definition
export default function Resources() {

// MARK: - State Management
  const [activeSection, setActiveSection] = useState(0);
  const containerRef = useRef<HTMLDivElement>(null);

  const sections = [
    'Intro',
    'The Problem',
    'Traditional Costs',
    'YesAllofUs Solution',
    'Savings by Revenue',
    'Cash Flow',
    'How It Works',
    'Features',
    'Integration',
    'Get Started'
  ];


// MARK: - Hooks & Effects
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    const sectionElements = container.querySelectorAll('.scroll-section');
    
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const index = Array.from(sectionElements).indexOf(entry.target as Element);
            setActiveSection(index);
          }
        });
      },
      { threshold: 0.5 }
    );

    sectionElements.forEach((section) => observer.observe(section));
    return () => observer.disconnect();
  }, []);


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">

      {/* Progress Indicator */}
      <div className="fixed right-6 top-1/2 -translate-y-1/2 z-40 hidden lg:flex flex-col gap-2">
        {sections.map((label, i) => (
          <button
            key={i}

// MARK: - Event Handlers
            onClick={() => {
              const sectionElements = document.querySelectorAll('.scroll-section');
              sectionElements[i]?.scrollIntoView({ behavior: 'smooth' });
            }}
            className={`group flex items-center gap-3 transition-all ${
              activeSection === i ? 'opacity-100' : 'opacity-30 hover:opacity-60'
            }`}
          >
            <span className={`text-[10px] font-medium transition-all whitespace-nowrap ${
              activeSection === i ? 'text-emerald-400 translate-x-0 opacity-100' : 'text-zinc-500 translate-x-2 opacity-0 group-hover:opacity-100 group-hover:translate-x-0'
            }`}>
              {label}
            </span>
            <div className={`w-2 h-2 rounded-full transition-all ${
              activeSection === i ? 'bg-emerald-400 scale-125' : 'bg-zinc-700'
            }`} />
          </button>
        ))}
      </div>

      <div ref={containerRef}>
        
        {/* ==================== SECTION 0: INTRO ==================== */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 pt-20">
          <div className="max-w-4xl mx-auto text-center">
            <div className="inline-flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/30 rounded-full px-4 py-1.5 mb-8">
              <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
              <span className="text-emerald-400 text-sm font-medium">The Complete Guide to Affiliate Payouts</span>
            </div>
            
            <h1 className="text-5xl md:text-7xl font-bold mb-8 leading-[1.1]">
              Why <span className="text-emerald-400">Instant Payouts</span><br />Change Everything
            </h1>
            
            <p className="text-xl text-zinc-400 max-w-2xl mx-auto mb-12">
              Scroll to discover the true cost of traditional affiliate platforms, calculate your savings, and see how YesAllofUs works.
            </p>

            <div className="flex flex-wrap justify-center gap-4 mb-16">
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl px-6 py-4">
                <p className="text-zinc-500 text-sm">Document 1</p>
                <p className="font-semibold">Cost Comparison</p>
              </div>
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl px-6 py-4">
                <p className="text-zinc-500 text-sm">Document 2</p>
                <p className="font-semibold">Savings Calculator</p>
              </div>
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl px-6 py-4">
                <p className="text-zinc-500 text-sm">Document 3</p>
                <p className="font-semibold">Overview</p>
              </div>
            </div>

            <div className="animate-bounce">
              <svg className="w-6 h-6 mx-auto text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
              </svg>
              <p className="text-zinc-600 text-sm mt-2">Scroll to explore</p>
            </div>
          </div>
        </section>

        {/* ==================== DOCUMENT 1: COST COMPARISON ==================== */}
        
        {/* Section 1: The Problem */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-red-950/5 to-[#0a0a0a]">
          <div className="max-w-4xl mx-auto text-center">
            <div className="inline-flex items-center gap-2 bg-red-500/10 border border-red-500/30 rounded-full px-4 py-1.5 mb-8">
              <span className="text-red-400 text-sm font-medium">üìÑ Document 1: Cost Comparison</span>
            </div>
            
            <h2 className="text-4xl md:text-6xl font-bold mb-8 leading-[1.1]">
              <span className="text-zinc-500">You make</span>{' '}
              <span className="text-white">$1,000</span>
              <br />
              <span className="text-zinc-500">You keep</span>{' '}
              <span className="text-red-400">$152</span>
            </h2>
            
            <p className="text-xl text-zinc-400 max-w-2xl mx-auto mb-12">
              For micro-vendors, traditional affiliate platforms cost more than the revenue they help generate. 
              The "Total Cost of Ownership" becomes a net loss.
            </p>

            <div className="flex flex-col sm:flex-row gap-6 justify-center items-center">
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-6 text-center">
                <p className="text-zinc-500 text-sm mb-2">Traditional Platform Costs</p>
                <p className="text-4xl font-bold text-red-400">84.8%</p>
                <p className="text-zinc-500 text-sm mt-2">of revenue eaten by fees</p>
              </div>
              <div className="text-4xl text-zinc-600">‚Üí</div>
              <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-2xl p-6 text-center">
                <p className="text-zinc-500 text-sm mb-2">YesAllofUs Costs</p>
                <p className="text-4xl font-bold text-emerald-400">1.09%</p>
                <p className="text-zinc-500 text-sm mt-2">of revenue</p>
              </div>
            </div>
          </div>
        </section>

        {/* Section 2: Traditional Costs Breakdown */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-4xl font-bold mb-4">
                <span className="text-red-400">Traditional</span> Platform Costs
              </h2>
              <p className="text-zinc-400">What you're really paying for the "privilege" of growing</p>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              {/* Shopify */}
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl overflow-hidden">
                <div className="bg-gradient-to-r from-green-600/20 to-green-500/10 px-6 py-4 border-b border-zinc-800">
                  <h3 className="font-bold flex items-center gap-2">
                    <span className="text-xl">üõí</span> Shopify + App
                  </h3>
                </div>
                <div className="p-6 space-y-3">
                  {[
                    { label: 'Platform Fee', value: '$39/mo', sub: '$468/yr' },
                    { label: 'Affiliate App', value: '$29-49/mo', sub: '$348/yr' },
                    { label: 'Transaction Fee', value: '2.9% + $0.30', sub: '~$32/yr' },
                    { label: 'Success Fee', value: '1-10.5%', sub: 'Variable' },
                    { label: 'PayPal Payout', value: '~3.4%', sub: '~$3.40/yr' },
                  ].map((item, i) => (
                    <div key={i} className="flex justify-between items-center py-2 border-b border-zinc-800/50 last:border-0">
                      <span className="text-zinc-400 text-sm">{item.label}</span>
                      <div className="text-right">
                        <span className="text-white font-medium text-sm">{item.value}</span>
                        <span className="text-zinc-600 text-xs ml-2">({item.sub})</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* WooCommerce */}
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl overflow-hidden">
                <div className="bg-gradient-to-r from-purple-600/20 to-purple-500/10 px-6 py-4 border-b border-zinc-800">
                  <h3 className="font-bold flex items-center gap-2">
                    <span className="text-xl">üîå</span> WooCommerce
                  </h3>
                </div>
                <div className="p-6 space-y-3">
                  {[
                    { label: 'Hosting', value: '$20/mo', sub: '$240/yr' },
                    { label: 'Affiliate Plugin', value: '$15-25/mo', sub: '$180/yr' },
                    { label: 'Transaction Fee', value: '2.9% + $0.30', sub: '~$32/yr' },
                    { label: 'Success Fee', value: '0%', sub: '$0' },
                    { label: 'PayPal Payout', value: '~3.4%', sub: '~$3.40/yr' },
                  ].map((item, i) => (
                    <div key={i} className="flex justify-between items-center py-2 border-b border-zinc-800/50 last:border-0">
                      <span className="text-zinc-400 text-sm">{item.label}</span>
                      <div className="text-right">
                        <span className="text-white font-medium text-sm">{item.value}</span>
                        <span className="text-zinc-600 text-xs ml-2">({item.sub})</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Warning */}
            <div className="mt-8 bg-amber-500/10 border border-amber-500/30 rounded-xl p-6">
              <div className="flex items-start gap-4">
                <span className="text-2xl">‚ö†Ô∏è</span>
                <div>
                  <h4 className="font-bold text-amber-400 mb-1">The Small Merchant Reality</h4>
                  <p className="text-zinc-300 text-sm">
                    Annual revenue of <strong>$1,000</strong> with traditional costs of <strong>$700-1,200/year</strong> means 
                    the merchant pays more in fees than they earn in profit.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* Section 3: YesAllofUs Solution */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-emerald-950/10 to-[#0a0a0a]">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-4xl font-bold mb-4">
                <span className="text-emerald-400">YesAllofUs</span> vs Traditional
              </h2>
              <p className="text-zinc-400">Side-by-side comparison on a $100 sale with 10% commission</p>
            </div>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl overflow-hidden">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-zinc-800">
                    <th className="text-left py-4 px-6 text-zinc-400 font-medium">Feature</th>
                    <th className="text-center py-4 px-6 text-red-400 font-medium">Traditional</th>
                    <th className="text-center py-4 px-6 text-emerald-400 font-medium bg-emerald-500/5">YesAllofUs</th>
                  </tr>
                </thead>
                <tbody>
                  {[
                    { feature: 'Monthly Subscription', trad: '$49-128+', yes: '$0' },
                    { feature: 'Setup Cost', trad: 'Time + Fees', yes: '$0' },
                    { feature: 'Commission Fee', trad: '0-10%', yes: '2.9%' },
                    { feature: 'Payout Speed', trad: '30-60 days', yes: '4 seconds', highlight: true },
                    { feature: 'Payout Fee', trad: '$0.25-1.00', yes: '$0.0002' },
                    { feature: 'Accounting', trad: 'Manual CSV', yes: 'Real-time Ledger' },
                  ].map((row, i) => (
                    <tr key={i} className="border-b border-zinc-800/50 last:border-0">
                      <td className="py-3 px-6 text-zinc-300 text-sm">{row.feature}</td>
                      <td className="py-3 px-6 text-center text-red-400 text-sm">{row.trad}</td>
                      <td className={`py-3 px-6 text-center bg-emerald-500/5 ${row.highlight ? 'text-emerald-400 font-bold' : 'text-emerald-400'} text-sm`}>{row.yes}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </section>

        {/* ==================== DOCUMENT 2: SAVINGS CALCULATOR ==================== */}

        {/* Section 4: Savings by Revenue */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <div className="inline-flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/30 rounded-full px-4 py-1.5 mb-6">
                <span className="text-emerald-400 text-sm font-medium">üìÑ Document 2: Savings Calculator</span>
              </div>
              <h2 className="text-3xl md:text-4xl font-bold mb-4">
                Your <span className="text-emerald-400">Savings</span> by Revenue
              </h2>
              <p className="text-zinc-400">See how much you keep with YesAllofUs</p>
            </div>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl overflow-hidden mb-8">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-zinc-800">
                    <th className="text-left py-4 px-6 text-zinc-400 font-medium">Annual Revenue</th>
                    <th className="text-center py-4 px-6 text-red-400 font-medium">Traditional</th>
                    <th className="text-center py-4 px-6 text-emerald-400 font-medium">YesAllofUs</th>
                    <th className="text-center py-4 px-6 text-emerald-400 font-medium">You Save</th>
                  </tr>
                </thead>
                <tbody>
                  {[
                    { rev: '$1,000', trad: '$848', yes: '$10.90', save: '$837' },
                    { rev: '$5,000', trad: '$896', yes: '$22.50', save: '$873' },
                    { rev: '$10,000', trad: '$944', yes: '$37', save: '$907' },
                    { rev: '$25,000', trad: '$1,088', yes: '$80', save: '$1,008' },
                    { rev: '$50,000', trad: '$1,328', yes: '$152', save: '$1,176' },
                    { rev: '$100,000', trad: '$1,808', yes: '$295', save: '$1,513' },
                  ].map((row, i) => (
                    <tr key={i} className="border-b border-zinc-800/50 last:border-0">
                      <td className="py-3 px-6 text-white font-semibold">{row.rev}</td>
                      <td className="py-3 px-6 text-center">
                        <span className="text-red-400 bg-red-500/10 px-2 py-1 rounded text-sm">{row.trad}</span>
                      </td>
                      <td className="py-3 px-6 text-center">
                        <span className="text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded text-sm">{row.yes}</span>
                      </td>
                      <td className="py-3 px-6 text-center text-emerald-400 font-bold">{row.save}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Big Number */}
            <div className="bg-gradient-to-r from-emerald-500/10 via-emerald-500/5 to-emerald-500/10 border border-emerald-500/30 rounded-2xl p-8 text-center">
              <p className="text-zinc-400 mb-2">For a $1,000/year merchant</p>
              <p className="text-5xl md:text-6xl font-bold text-emerald-400 mb-2">$837</p>
              <p className="text-zinc-400">saved annually</p>
            </div>
          </div>
        </section>

        {/* Section 5: Cash Flow */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-zinc-900/50 to-[#0a0a0a]">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-4xl font-bold mb-4">
                The <span className="text-emerald-400">Cash Flow</span> Advantage
              </h2>
              <p className="text-zinc-400">Beyond cost savings ‚Äî instant payouts change everything</p>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              {/* Traditional Timeline */}
<div className="bg-red-500/5 border border-red-500/20 rounded-2xl p-8 flex flex-col h-80">
  <h3 className="font-bold text-lg mb-6 text-red-400">Traditional Timeline</h3>
  <div className="space-y-4 flex-1">
    {[
      { day: 'Day 1', event: 'Sale made' },
      { day: 'Day 30', event: 'Refund period ends' },
      { day: 'Day 45', event: 'Payout processed' },
      { day: 'Day 48', event: 'Affiliate receives $' },
    ].map((item, i) => (
      <div key={i} className="flex justify-between text-sm">
        <span className="text-zinc-500">{item.day}</span>
        <span className="text-zinc-300">{item.event}</span>
      </div>
    ))}
  </div>
  <div className="pt-4 border-t border-red-500/20">
    <span className="text-red-400 font-bold">Total wait: 48+ days</span>
  </div>
</div>

{/* YesAllofUs Timeline */}
<div className="bg-emerald-500/5 border border-emerald-500/20 rounded-2xl p-8 flex flex-col h-80">
  <h3 className="font-bold text-lg mb-6 text-emerald-400">YesAllofUs Timeline</h3>
  <div className="space-y-4 flex-1">
    {[
      { day: 'Second 0', event: 'Sale made' },
      { day: 'Second 4', event: 'RLUSD received', highlight: true },
    ].map((item, i) => (
      <div key={i} className="flex justify-between text-sm">
        <span className="text-zinc-500">{item.day}</span>
        <span className={item.highlight ? 'text-emerald-400 font-medium' : 'text-zinc-300'}>{item.event}</span>
      </div>
    ))}
  </div>
  <div className="pt-4 border-t border-emerald-500/20">
    <span className="text-emerald-400 font-bold">Total wait: 4 seconds</span>
  </div>
</div>
              </div>
            </div>
        </section>

        {/* ==================== DOCUMENT 3: ONE-PAGER ==================== */}

        {/* Section 6: How It Works */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <div className="inline-flex items-center gap-2 bg-purple-500/10 border border-purple-500/30 rounded-full px-4 py-1.5 mb-6">
                <span className="text-purple-400 text-sm font-medium">üìÑ Document 3: Overview</span>
              </div>
              <h2 className="text-3xl md:text-4xl font-bold mb-4">
                How <span className="text-emerald-400">YesAllofUs</span> Works
              </h2>
              <p className="text-zinc-400">4 simple steps to instant affiliate payouts</p>
            </div>

            <div className="grid md:grid-cols-4 gap-4">
              {[
                { num: '1', title: 'Customer Clicks', desc: 'Affiliate link tracked' },
                { num: '2', title: 'Purchase Made', desc: 'Order completes in your store' },
                { num: '3', title: 'Instant Payout', desc: 'RLUSD sent in 4 seconds' },
                { num: '4', title: 'On-Chain Record', desc: 'Immutable, transparent' },
              ].map((step, i) => (
                <div key={i} className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 text-center">
                  <div className="w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-400 font-bold">
                    {step.num}
                  </div>
                  <h3 className="font-semibold mb-2">{step.title}</h3>
                  <p className="text-zinc-500 text-sm">{step.desc}</p>
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* Section 7: Features */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-purple-950/5 to-[#0a0a0a]">
          <div className="max-w-5xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-4xl font-bold mb-4">
                Built for <span className="text-emerald-400">Modern</span> Commerce
              </h2>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              {/* For Merchants */}
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-8">
                <h3 className="font-bold text-lg mb-6 text-emerald-400">For Merchants</h3>
                <ul className="space-y-4">
                  {[
                    '$0 monthly subscription',
                    'Only pay when you earn',
                    '5-level MLM structure',
                    'Full control over rates',
                    'Real-time ledger exports',
                  ].map((item, i) => (
                    <li key={i} className="flex items-center gap-3 text-sm">
                      <span className="text-emerald-400">‚úì</span>
                      <span className="text-zinc-300">{item}</span>
                    </li>
                  ))}
                </ul>
              </div>

              {/* For Affiliates */}
              <div className="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-8">
                <h3 className="font-bold text-lg mb-6 text-emerald-400">For Affiliates</h3>
                <ul className="space-y-4">
                  {[
                    'Get paid in 4 seconds',
                    'RLUSD (stable value)',
                    'No payout minimums',
                    'Earn from your network',
                    'Transparent on-chain',
                  ].map((item, i) => (
                    <li key={i} className="flex items-center gap-3 text-sm">
                      <span className="text-emerald-400">‚úì</span>
                      <span className="text-zinc-300">{item}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>

            {/* Vendor Referral */}
            <div className="mt-8 bg-zinc-900/50 border border-zinc-800 rounded-2xl p-8 text-center">
              <h3 className="font-bold text-lg mb-3">Vendor-to-Vendor Referrals</h3>
              <p className="text-zinc-400 text-sm">
                Vendors earn <span className="text-emerald-400 font-semibold">lifetime commissions</span> when they refer other vendors. 
                Every sale the referred vendor makes, you earn. Forever.
              </p>
            </div>
          </div>
        </section>

        {/* Section 8: Integration */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20">
          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-3xl md:text-4xl font-bold mb-4">
                Easy <span className="text-emerald-400">Integration</span>
              </h2>
              <p className="text-zinc-400">2 minutes to set up. Then it runs itself.</p>
            </div>

            <div className="grid md:grid-cols-3 gap-6">
              {[
                { title: 'WooCommerce', sub: 'Plugin install', time: '2 minutes' },
                { title: 'CLI Tool', sub: 'npx yesallofus', time: '2 minutes' },
                { title: 'REST API', sub: 'Any platform', time: 'Full docs' },
              ].map((item, i) => (
                <div key={i} className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 text-center">
                  <h3 className="font-bold text-lg mb-2">{item.title}</h3>
                  <p className="text-zinc-500 text-sm mb-3">{item.sub}</p>
                  <span className="text-emerald-400 text-sm">{item.time}</span>
                </div>
              ))}
            </div>

            {/* Trust */}
            <div className="mt-12 text-center">
              <h3 className="font-semibold mb-6 text-zinc-400">Trust & Compliance</h3>
              <div className="flex flex-wrap justify-center gap-4 text-sm">
                {[
                  'Working with GFSC (Guernsey)',
                  'XRP Ledger',
                  'All transactions on-chain',
                  'Non-custodial',
                ].map((item, i) => (
                  <span key={i} className="bg-zinc-900/50 border border-zinc-800 rounded-full px-4 py-2 text-zinc-400">
                    {item}
                  </span>
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* Section 9: CTA */}
        <section className="scroll-section min-h-screen flex items-center justify-center px-6 py-20 bg-gradient-to-b from-[#0a0a0a] via-emerald-950/10 to-[#0a0a0a]">
          <div className="max-w-3xl mx-auto text-center">
            <h2 className="text-4xl md:text-5xl font-bold mb-6">
              Stop paying for the privilege of growing.
            </h2>
            <p className="text-xl text-zinc-400 mb-12">
              Get started in 2 minutes. No credit card. No subscription.
            </p>

            <div className="flex flex-col sm:flex-row gap-4 justify-center mb-8">
              <a 
                href="/dashboard"
                className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-8 py-4 rounded-xl transition text-lg"
              >
                Start Free ‚Üí
              </a>
              <a 
                href="https://calendly.com/tokencanvasio/30min"
                target="_blank"
                className="border border-zinc-700 hover:border-zinc-500 px-8 py-4 rounded-xl transition text-lg"
              >
                Book a Call
              </a>
            </div>

            <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-4 inline-block mb-12">
              <p className="text-zinc-500 text-sm mb-1">Or use the CLI</p>
              <code className="text-emerald-400 font-mono">npx yesallofus</code>
            </div>

            {/* Download PDFs */}
            <div className="border-t border-zinc-800 pt-12">
              <p className="text-zinc-500 text-sm mb-6">Download these resources as PDFs</p>
              <div className="flex flex-wrap justify-center gap-4">
                <a href="/pdfs/YesAllofUs-Cost-Comparison.pdf" download className="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition">
                  üìÑ Cost Comparison
                </a>
                <a href="/pdfs/YesAllofUs-Savings-Calculator.pdf" download className="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition">
                  üìÑ Savings Calculator
                </a>
                <a href="/pdfs/YesAllofUs-One-Pager.pdf" download className="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg text-sm transition">
                  üìÑ One-Pager
                </a>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/terms/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React, { useState, ReactNode } from 'react';


// MARK: - Component Definition
export default function TermsOfService() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-12">
          <h1 className="text-4xl font-bold text-slate-900 mb-4">Terms of Service</h1>
          <p className="text-slate-600">Last updated: 7 December 2025</p>
        </div>

        {/* Plain English Summary */}
<div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-12">
  <h2 className="font-semibold text-blue-900 mb-3">üìã Plain English Summary</h2>
  <p className="text-blue-800 text-sm leading-relaxed mb-4">
    Before the legal language, here&apos;s what you&apos;re agreeing to in simple terms:
  </p>
  <ul className="text-blue-800 text-sm space-y-2">
    <li><strong>What YesAllofUs is:</strong> We are a B2B payment infrastructure technology provider. We license our software to authorised entities who operate affiliate commission payment services.</li>
    <li><strong>Who can use this:</strong> This Service is available to licensed payment providers, regulated entities, and authorised business partners only. We do not offer direct retail services.</li>
    <li><strong>How it works technically:</strong> When Auto-Sign is enabled, our platform signs transactions on behalf of connected wallets using XRPL&apos;s multi-signature delegation. You retain ownership of your wallet and can revoke this authority at any time.</li>
    <li><strong>Regulatory status:</strong> We are actively working with regulators to ensure appropriate licensing and compliance. Licensees are responsible for their own regulatory obligations in their jurisdictions.</li>
    <li><strong>Your responsibility:</strong> You own your wallet, set your limits, and are responsible for ensuring you have sufficient funds and valid trustlines.</li>
    <li><strong>You can leave anytime:</strong> Revoke our signer access from your wallet and your relationship with us ends. No lock-in.</li>
  </ul>
</div>

        {/* Table of Contents */}
        <div className="bg-slate-50 rounded-xl p-6 mb-12">
          <h2 className="font-semibold text-slate-900 mb-4">Table of Contents</h2>
          <ol className="text-sm text-slate-600 space-y-2 columns-2">
            <li><a href="#definitions" className="hover:text-blue-600">1. Definitions</a></li>
            <li><a href="#service-description" className="hover:text-blue-600">2. Service Description</a></li>
            <li><a href="#eligibility" className="hover:text-blue-600">3. Eligibility and Access</a></li>
            <li><a href="#wallet-connection" className="hover:text-blue-600">4. Wallet Connection</a></li>
            <li><a href="#payment-processing" className="hover:text-blue-600">5. Payment Processing</a></li>
            <li><a href="#fees-billing" className="hover:text-blue-600">6. Fees and Billing</a></li>
            <li><a href="#regulatory" className="hover:text-blue-600">7. Regulatory and Compliance</a></li>
            <li><a href="#your-obligations" className="hover:text-blue-600">8. Your Obligations</a></li>
            <li><a href="#prohibited-uses" className="hover:text-blue-600">9. Prohibited Uses</a></li>
            <li><a href="#intellectual-property" className="hover:text-blue-600">10. Intellectual Property</a></li>
            <li><a href="#data-privacy" className="hover:text-blue-600">11. Data and Privacy</a></li>
            <li><a href="#disclaimers" className="hover:text-blue-600">12. Disclaimers</a></li>
            <li><a href="#limitation-liability" className="hover:text-blue-600">13. Limitation of Liability</a></li>
            <li><a href="#indemnification" className="hover:text-blue-600">14. Indemnification</a></li>
            <li><a href="#termination" className="hover:text-blue-600">15. Termination</a></li>
            <li><a href="#dispute-resolution" className="hover:text-blue-600">16. Dispute Resolution</a></li>
            <li><a href="#general" className="hover:text-blue-600">17. General Provisions</a></li>
            <li><a href="#contact" className="hover:text-blue-600">18. Contact Information</a></li>
          </ol>
        </div>

        {/* Terms Content */}
        <div className="prose prose-slate max-w-none">
          
          {/* 1. Definitions */}
          <section id="definitions" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">1. Definitions</h2>
            <p className="text-slate-700 mb-4">In these Terms of Service, the following definitions apply:</p>
            <dl className="space-y-4 text-slate-700">
              <div>
                <dt className="font-semibold">&quot;YesAllofUs,&quot; &quot;we,&quot; &quot;us,&quot; or &quot;our&quot;</dt>
                <dd className="ml-4">YesAllofUs, a payment infrastructure technology provider operated by Mark Flynn, based in Guernsey, Channel Islands.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;Service&quot; or &quot;Platform&quot;</dt>
                <dd className="ml-4">The YesAllofUs affiliate commission payment infrastructure, including the API, WordPress plugin, CLI tool, web dashboard, and all related documentation and support.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;Licensee&quot;</dt>
                <dd className="ml-4">An authorised entity that has entered into a licensing agreement with YesAllofUs to operate affiliate commission payment services using our infrastructure.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;You,&quot; &quot;your,&quot; or &quot;Store&quot;</dt>
                <dd className="ml-4">The individual or entity accessing the Service, either as a Licensee or through a Licensee&apos;s implementation.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;Affiliate&quot;</dt>
                <dd className="ml-4">A third party registered through your Store to receive commission payments for referred sales.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;Wallet&quot;</dt>
                <dd className="ml-4">An XRP Ledger account that you own and control, connected to the Service via Xaman, Crossmark, or Web3Auth.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;RLUSD&quot;</dt>
                <dd className="ml-4">Ripple USD, a stablecoin issued on the XRP Ledger by Ripple (issuer address: rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De).</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;XRP Ledger&quot; or &quot;XRPL&quot;</dt>
                <dd className="ml-4">The decentralised blockchain network on which all payment transactions are executed and recorded.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;Multi-Sign,&quot; &quot;SignerList,&quot; or &quot;Auto-Sign&quot;</dt>
                <dd className="ml-4">The XRPL feature allowing you to delegate transaction signing authority to YesAllofUs within limits you specify, enabling automated payment processing.</dd>
              </div>
              <div>
                <dt className="font-semibold">&quot;Platform Fee&quot;</dt>
                <dd className="ml-4">The percentage fee charged by YesAllofUs on each payout processed through the Service.</dd>
              </div>
            </dl>
          </section>

          {/* 2. Service Description */}
          <section id="service-description" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">2. Service Description</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">2.1 What YesAllofUs Is</h3>
            <p className="text-slate-700 mb-4">
              YesAllofUs is a B2B payment infrastructure technology provider. We develop and license software that enables instant affiliate commission payments using the XRP Ledger and RLUSD stablecoin.
            </p>
            <p className="text-slate-700 mb-4">Our technology enables:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Registration of affiliate marketers with unique referral codes</li>
              <li>Tracking of sales attributed to affiliate referrals</li>
              <li>Automatic calculation of commission amounts based on configured rates</li>
              <li>Instant RLUSD payments from store Wallets to affiliate Wallets</li>
              <li>Immutable transaction records on the public XRP Ledger</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">2.2 How the Technology Works</h3>
            <p className="text-slate-700 mb-4">To be transparent about the technical operation:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li><strong>Wallet Ownership:</strong> You retain full ownership of your Wallet at all times. We never have access to your private keys or seed phrases.</li>
              <li><strong>Delegated Signing Authority:</strong> When you enable Auto-Sign, you add YesAllofUs as an authorised signer on your Wallet using XRPL&apos;s SignerList feature. This grants us the technical ability to sign transactions on your behalf within limits you configure.</li>
              <li><strong>Transaction Execution:</strong> When a payout is triggered, our platform signs and submits the transaction to the XRP Ledger on your behalf. You can revoke this authority at any time by removing our signer address.</li>
              <li><strong>Non-Custodial:</strong> We never hold, custody, or have unilateral control over your funds. Funds remain in your Wallet until a transaction is executed.</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">2.3 What YesAllofUs Does NOT Do</h3>
            <p className="text-slate-700 mb-4">YesAllofUs:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li><strong>Does NOT have access to your private keys or seed phrases.</strong> We use XRPL&apos;s multi-signature delegation, not key custody.</li>
              <li><strong>Does NOT hold or custody funds.</strong> All funds remain in your Wallet until a payment is executed on the blockchain.</li>
              <li><strong>Does NOT guarantee the value or stability of RLUSD.</strong> RLUSD is issued by Ripple, not YesAllofUs.</li>
              <li><strong>Does NOT provide tax, legal, or financial advice.</strong> You are responsible for your own compliance obligations.</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">2.4 Service Availability</h3>
            <p className="text-slate-700 mb-4">
              We aim to maintain 99.9% uptime for the YesAllofUs API. However, the Service depends on third-party infrastructure including the XRP Ledger network, wallet services, and cloud hosting providers. We are not liable for downtime caused by these external dependencies.
            </p>
          </section>

          {/* 3. Eligibility and Access */}
          <section id="eligibility" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">3. Eligibility and Access</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.1 B2B Service</h3>
            <p className="text-slate-700 mb-4">
              YesAllofUs is a business-to-business (B2B) infrastructure provider. The Service is designed for licensing to authorised entities including licensed payment providers, regulated financial institutions, and approved business partners.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.2 Eligibility Requirements</h3>
            <p className="text-slate-700 mb-4">To access the Service, you must:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Be a registered business entity or authorised representative thereof</li>
              <li>Be at least 18 years of age</li>
              <li>Have the legal capacity to enter into binding contracts</li>
              <li>Not be prohibited from using the Service under applicable laws</li>
              <li>Hold appropriate licences or registrations required in your jurisdiction for operating payment services, or access the Service through a licensed Licensee</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.3 Licensing Arrangements</h3>
            <p className="text-slate-700 mb-4">
              Entities wishing to operate affiliate commission payment services using YesAllofUs technology must enter into a separate licensing agreement. Licensees are responsible for ensuring regulatory compliance in their operating jurisdictions.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.4 Account Registration</h3>
            <p className="text-slate-700 mb-4">
              When you register, you provide your business name, URL, and contact email. We generate unique API credentials (api_key and api_secret) for your account. You are responsible for keeping these credentials secure.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">3.5 Account Security</h3>
            <p className="text-slate-700 mb-4">You agree to:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Keep your API credentials confidential and secure</li>
              <li>Not share your credentials with unauthorised parties</li>
              <li>Notify us immediately if you suspect unauthorised access</li>
              <li>Accept responsibility for all activity under your account</li>
            </ul>
          </section>

          {/* 4. Wallet Connection */}
          <section id="wallet-connection" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">4. Wallet Connection</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">4.1 Supported Wallets</h3>
            <p className="text-slate-700 mb-4">YesAllofUs supports connection via:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li><strong>Xaman (formerly XUMM):</strong> Mobile wallet with manual approval or push notification signing</li>
              <li><strong>Crossmark:</strong> Browser extension with automatic signing within configured limits</li>
              <li><strong>Web3Auth:</strong> Social login wallet creation with delegated signing authority</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">4.2 RLUSD Trustline Requirement</h3>
            <p className="text-slate-700 mb-4">
              To send or receive RLUSD payments, both your Wallet and your affiliates&apos; Wallets must have an active trustline to the RLUSD issuer (rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De). Payments to wallets without trustlines will be skipped.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">4.3 Auto-Sign and Delegated Signing Authority</h3>
            <p className="text-slate-700 mb-4">If you enable Auto-Sign (multi-signature delegation), you explicitly acknowledge and agree that:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>You are adding YesAllofUs as an authorised signer on your Wallet via XRPL&apos;s SignerList feature</li>
              <li>YesAllofUs will sign and submit payment transactions on your behalf when payouts are triggered</li>
              <li>This delegation grants us the technical ability to execute transactions from your Wallet within configured limits</li>
              <li>You are responsible for setting appropriate daily and per-transaction limits</li>
              <li>You can revoke this authority at any time by removing our signer address from your Wallet&apos;s SignerList</li>
              <li>Revocation takes effect immediately upon confirmation on the XRPL</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">4.4 Manual Approval Mode</h3>
            <p className="text-slate-700 mb-4">
              If you use Xaman without Auto-Sign, each payment requires your explicit approval via push notification. Payments not approved within 72 hours will expire and may be retried.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">4.5 Wallet Ownership</h3>
            <p className="text-slate-700 mb-4">
              By connecting a Wallet, you represent and warrant that you are the lawful owner of that Wallet and have full authority to authorise transactions from it and to delegate signing authority.
            </p>
          </section>

          {/* 5. Payment Processing */}
          <section id="payment-processing" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">5. Payment Processing</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.1 How Payments Work</h3>
            <p className="text-slate-700 mb-4">When an order completes on your store:</p>
            <ol className="list-decimal pl-6 text-slate-700 space-y-2 mb-4">
              <li>Your platform sends a payout request to YesAllofUs via API</li>
              <li>We calculate commissions based on your configured rates</li>
              <li>We verify affiliate wallets have valid RLUSD trustlines</li>
              <li>For Auto-Sign wallets: We sign and submit payment transactions on your behalf</li>
              <li>For Manual wallets: We send signing requests to your wallet app for approval</li>
              <li>Platform Fee is deducted as a separate payment</li>
              <li>All transactions are recorded on the public XRP Ledger</li>
            </ol>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.2 Transaction Finality</h3>
            <p className="text-slate-700 mb-4">
              Once a payment transaction is validated on the XRP Ledger, it is final and irreversible. YesAllofUs cannot reverse, refund, or modify blockchain transactions. If you need to recover funds sent in error, you must contact the recipient directly.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.3 Insufficient Funds</h3>
            <p className="text-slate-700 mb-4">
              If your Wallet has insufficient RLUSD balance to complete a payout, the transaction will fail. You are responsible for maintaining adequate funds in your Wallet.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.4 Network Fees</h3>
            <p className="text-slate-700 mb-4">
              XRP Ledger transactions require a small amount of XRP for network fees (typically 0.00001-0.00002 XRP per transaction). Your Wallet must maintain a minimum XRP balance to cover these fees.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">5.5 Daily Limits</h3>
            <p className="text-slate-700 mb-4">
              Default daily payout limit is $1,000 USD equivalent. Limits may be adjusted through licensing arrangements. Auto-Sign users configure their own limits via their Wallet&apos;s SignerList settings.
            </p>
          </section>

          {/* 6. Fees and Billing */}
          <section id="fees-billing" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">6. Fees and Billing</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.1 Licensing Fees</h3>
            <p className="text-slate-700 mb-4">
              Fees for Licensees are established in individual licensing agreements and may include upfront licence fees, transaction-based royalties, and maintenance retainers.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.2 Platform Fee Tiers (Direct Access)</h3>
            <p className="text-slate-700 mb-4">For approved direct access during pilot phases:</p>
            <div className="bg-slate-50 rounded-lg p-4 mb-4">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-slate-700">
                    <th className="pb-2 font-semibold">Tier</th>
                    <th className="pb-2 font-semibold">Platform Fee</th>
                    <th className="pb-2 font-semibold">Monthly Subscription</th>
                    <th className="pb-2 font-semibold">Volume</th>
                  </tr>
                </thead>
                <tbody className="text-slate-600">
                  <tr>
                    <td className="py-2">Pilot</td>
                    <td className="py-2">2.9%</td>
                    <td className="py-2">$0</td>
                    <td className="py-2">Up to $25,000/month</td>
                  </tr>
                  <tr>
                    <td className="py-2">Pro</td>
                    <td className="py-2">0.9%</td>
                    <td className="py-2">$99</td>
                    <td className="py-2">$25,000-$250,000/month</td>
                  </tr>
                  <tr>
                    <td className="py-2">Enterprise</td>
                    <td className="py-2">Custom</td>
                    <td className="py-2">Custom</td>
                    <td className="py-2">$250,000+/month</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.3 How Fees Are Collected</h3>
            <p className="text-slate-700 mb-4">
              Platform Fees are deducted automatically from each payout as a separate RLUSD payment from your Wallet to the YesAllofUs wallet. You will see this as a distinct transaction on the XRP Ledger.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.4 No Hidden Fees</h3>
            <p className="text-slate-700 mb-4">
              We do not charge setup fees, integration fees, withdrawal fees, or any fees other than those explicitly stated in these Terms or your licensing agreement.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">6.5 Fee Changes</h3>
            <p className="text-slate-700 mb-4">
              We may modify fees with 30 days&apos; written notice. Continued use of the Service after fee changes take effect constitutes acceptance. Licensing agreements may contain specific fee adjustment provisions.
            </p>
          </section>

          {/* 7. Regulatory and Compliance */}
          <section id="regulatory" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">7. Regulatory and Compliance</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">7.1 Our Regulatory Approach</h3>
            <p className="text-slate-700 mb-4">
              YesAllofUs is committed to operating transparently and in compliance with applicable regulations. We are actively engaging with relevant regulatory authorities regarding the appropriate licensing framework for our technology.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">7.2 Technology Provider Status</h3>
            <p className="text-slate-700 mb-4">
              YesAllofUs operates as a technology infrastructure provider. We license our software to authorised entities who are responsible for obtaining and maintaining appropriate licences and registrations in their operating jurisdictions.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">7.3 Licensee Obligations</h3>
            <p className="text-slate-700 mb-4">Licensees and users of the Service are solely responsible for:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Obtaining any required licences, registrations, or authorisations in their jurisdiction</li>
              <li>Compliance with anti-money laundering (AML) and counter-terrorism financing (CTF) requirements</li>
              <li>Implementation of appropriate Know Your Customer (KYC) procedures</li>
              <li>Compliance with local tax laws and reporting obligations</li>
              <li>Adherence to consumer protection and data protection regulations</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">7.4 Cooperation with Authorities</h3>
            <p className="text-slate-700 mb-4">
              We will cooperate with regulatory authorities and law enforcement agencies as required by law. This may include providing information about transactions, accounts, or users when legally compelled to do so.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">7.5 Regulatory Changes</h3>
            <p className="text-slate-700 mb-4">
              The regulatory landscape for digital assets and blockchain-based payment services is evolving. We reserve the right to modify, suspend, or terminate aspects of the Service as necessary to comply with new or changing regulations.
            </p>
          </section>

          {/* 8. Your Obligations */}
          <section id="your-obligations" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">8. Your Obligations</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">8.1 Lawful Use</h3>
            <p className="text-slate-700 mb-4">You agree to use the Service only for lawful purposes and in compliance with all applicable laws, including but not limited to:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Anti-money laundering (AML) regulations</li>
              <li>Know Your Customer (KYC) requirements applicable to your business</li>
              <li>Tax laws in your jurisdiction</li>
              <li>Consumer protection laws</li>
              <li>Data protection regulations (GDPR, etc.)</li>
              <li>Virtual asset service provider (VASP) regulations where applicable</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">8.2 Accurate Information</h3>
            <p className="text-slate-700 mb-4">
              You agree to provide accurate, current, and complete information during registration and to update this information as necessary.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">8.3 Affiliate Management</h3>
            <p className="text-slate-700 mb-4">You are responsible for:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Vetting affiliates before registering them</li>
              <li>Ensuring affiliates understand and agree to your affiliate program terms</li>
              <li>Handling disputes with affiliates directly</li>
              <li>Providing accurate commission rate information to affiliates</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">8.4 Tax Compliance</h3>
            <p className="text-slate-700 mb-4">
              You are solely responsible for determining and fulfilling your tax obligations. This includes issuing appropriate tax forms to affiliates and reporting income to relevant tax authorities.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">8.5 Sufficient Funds</h3>
            <p className="text-slate-700 mb-4">
              You agree to maintain sufficient RLUSD and XRP balances in your connected Wallet to cover expected payouts and network fees.
            </p>
          </section>

          {/* 9. Prohibited Uses */}
          <section id="prohibited-uses" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">9. Prohibited Uses</h2>
            <p className="text-slate-700 mb-4">You may not use YesAllofUs to:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Process payments for illegal goods or services</li>
              <li>Launder money or finance terrorism</li>
              <li>Evade taxes or facilitate tax evasion</li>
              <li>Operate unlicensed gambling or gaming services</li>
              <li>Sell illegal drugs, weapons, or controlled substances</li>
              <li>Distribute child exploitation material</li>
              <li>Engage in fraud, phishing, or deceptive practices</li>
              <li>Violate intellectual property rights</li>
              <li>Harass, abuse, or harm others</li>
              <li>Interfere with or disrupt the Service</li>
              <li>Attempt to gain unauthorised access to our systems</li>
              <li>Reverse engineer or decompile our software</li>
              <li>Use automated tools to scrape or abuse our API beyond rate limits</li>
              <li>Resell or redistribute the Service without a licensing agreement</li>
              <li>Operate payment services without required regulatory authorisation</li>
            </ul>
          </section>

          {/* 10. Intellectual Property */}
          <section id="intellectual-property" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">10. Intellectual Property</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">10.1 Our Intellectual Property</h3>
            <p className="text-slate-700 mb-4">
              YesAllofUs, including its name, logo, API, software, documentation, and all related materials, is owned by us and protected by intellectual property laws. You may not use our trademarks without prior written consent.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">10.2 License to Use</h3>
            <p className="text-slate-700 mb-4">
              We grant you a limited, non-exclusive, non-transferable, revocable license to use the Service in accordance with these Terms. This license terminates automatically if you violate these Terms.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">10.3 Licensing Rights</h3>
            <p className="text-slate-700 mb-4">
              Broader licensing rights, including the right to operate services using YesAllofUs technology, are granted only through separate licensing agreements.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">10.4 Your Content</h3>
            <p className="text-slate-700 mb-4">
              You retain ownership of your business name, branding, and any content you provide. By using the Service, you grant us a license to display your business name in our records and communications as necessary to provide the Service.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">10.5 Feedback</h3>
            <p className="text-slate-700 mb-4">
              If you provide suggestions, ideas, or feedback about the Service, you grant us the right to use this feedback without compensation or attribution.
            </p>
          </section>

          {/* 11. Data and Privacy */}
          <section id="data-privacy" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">11. Data and Privacy</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">11.1 Data We Collect</h3>
            <p className="text-slate-700 mb-4">We collect and process:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Registration information (business name, URL, email)</li>
              <li>Wallet addresses (public blockchain data)</li>
              <li>Transaction records (order IDs, amounts, timestamps)</li>
              <li>API usage data (for rate limiting and analytics)</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">11.2 Blockchain Transparency</h3>
            <p className="text-slate-700 mb-4">
              All payment transactions are recorded on the public XRP Ledger. This means wallet addresses and transaction amounts are publicly visible. We cannot delete or modify blockchain data.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">11.3 Privacy Policy</h3>
            <p className="text-slate-700 mb-4">
              Our collection and use of personal data is governed by our <a href="/privacy" className="text-blue-600 hover:underline">Privacy Policy</a>, which is incorporated into these Terms by reference.
            </p>
          </section>

          {/* 12. Disclaimers */}
          <section id="disclaimers" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">12. Disclaimers</h2>
            
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
              <p className="text-amber-800 text-sm font-semibold mb-2">IMPORTANT: PLEASE READ CAREFULLY</p>
            </div>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">12.1 Service Provided &quot;As Is&quot;</h3>
            <p className="text-slate-700 mb-4">
              THE SERVICE IS PROVIDED &quot;AS IS&quot; AND &quot;AS AVAILABLE&quot; WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">12.2 No Guarantee of Availability</h3>
            <p className="text-slate-700 mb-4">
              We do not guarantee that the Service will be uninterrupted, timely, secure, or error-free. The Service depends on third-party infrastructure that is outside our control.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">12.3 Cryptocurrency Risks</h3>
            <p className="text-slate-700 mb-4">You acknowledge and accept that:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Cryptocurrency values are volatile and may fluctuate significantly</li>
              <li>Blockchain transactions are irreversible</li>
              <li>You may lose access to funds if you lose your wallet credentials</li>
              <li>Regulatory changes may affect the availability or legality of cryptocurrency services</li>
              <li>The XRP Ledger is a decentralised network not controlled by YesAllofUs</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">12.4 Third-Party Services</h3>
            <p className="text-slate-700 mb-4">
              We are not responsible for the actions, content, or services of third parties, including Xaman, Crossmark, Web3Auth, Ripple, or the XRP Ledger validators.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">12.5 Regulatory Uncertainty</h3>
            <p className="text-slate-700 mb-4">
              The regulatory status of blockchain-based payment services varies by jurisdiction and is subject to change. We make no representation that the Service is compliant with all laws in all jurisdictions. You are responsible for ensuring your use of the Service complies with applicable laws.
            </p>
          </section>

          {/* 13. Limitation of Liability */}
          <section id="limitation-liability" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">13. Limitation of Liability</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">13.1 Cap on Liability</h3>
            <p className="text-slate-700 mb-4">
              TO THE MAXIMUM EXTENT PERMITTED BY LAW, YesAllofUs&apos;S TOTAL LIABILITY TO YOU FOR ANY CLAIMS ARISING FROM OR RELATED TO THESE TERMS OR THE SERVICE SHALL NOT EXCEED THE GREATER OF: (A) THE AMOUNT YOU PAID TO YesAllofUs IN THE 12 MONTHS PRECEDING THE CLAIM, OR (B) ¬£100.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">13.2 Exclusion of Certain Damages</h3>
            <p className="text-slate-700 mb-4">
              IN NO EVENT SHALL YesAllofUs BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, INCLUDING BUT NOT LIMITED TO LOSS OF PROFITS, DATA, BUSINESS OPPORTUNITIES, OR GOODWILL, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">13.3 Specific Exclusions</h3>
            <p className="text-slate-700 mb-4">Without limiting the above, YesAllofUs shall not be liable for:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Payments sent to incorrect wallet addresses that you provided</li>
              <li>Losses due to your failure to secure your API credentials or wallet</li>
              <li>Losses due to XRP Ledger network issues or delays</li>
              <li>Losses due to changes in cryptocurrency values</li>
              <li>Losses due to regulatory actions or changes in law</li>
              <li>Actions or omissions of your affiliates</li>
              <li>Your failure to obtain required licences or authorisations</li>
            </ul>
          </section>

          {/* 14. Indemnification */}
          <section id="indemnification" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">14. Indemnification</h2>
            <p className="text-slate-700 mb-4">
              You agree to indemnify, defend, and hold harmless YesAllofUs and its owner, employees, and agents from and against any claims, liabilities, damages, losses, costs, and expenses (including reasonable legal fees) arising out of or related to:
            </p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Your use of the Service</li>
              <li>Your violation of these Terms</li>
              <li>Your violation of any applicable law or regulation</li>
              <li>Your failure to obtain required licences or authorisations</li>
              <li>Your infringement of any third-party rights</li>
              <li>Disputes between you and your affiliates</li>
              <li>Your tax obligations or failure to comply with tax laws</li>
              <li>Regulatory actions arising from your operation of payment services</li>
            </ul>
          </section>

          {/* 15. Termination */}
          <section id="termination" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">15. Termination</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">15.1 Termination by You</h3>
            <p className="text-slate-700 mb-4">You may terminate your use of the Service at any time by:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Removing YesAllofUs as a signer from your Wallet (for Auto-Sign users)</li>
              <li>Disconnecting your Wallet from the Service</li>
              <li>Deleting your account via the API or by contacting support</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">15.2 Termination by Us</h3>
            <p className="text-slate-700 mb-4">We may suspend or terminate your access to the Service immediately if:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>You violate these Terms</li>
              <li>You fail to pay applicable fees</li>
              <li>We are required to do so by law or regulatory authority</li>
              <li>We reasonably believe your account is being used for fraud or illegal activity</li>
              <li>You operate payment services without required regulatory authorisation</li>
              <li>You become insolvent or enter bankruptcy proceedings</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">15.3 Effect of Termination</h3>
            <p className="text-slate-700 mb-4">Upon termination:</p>
            <ul className="list-disc pl-6 text-slate-700 space-y-2 mb-4">
              <li>Your right to use the Service ends immediately</li>
              <li>Pending payouts may be cancelled</li>
              <li>Your API credentials will be deactivated</li>
              <li>We may retain records as required by law or for legitimate business purposes</li>
              <li>Provisions that by their nature should survive (including disclaimers, limitations of liability, and indemnification) will continue in effect</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">15.4 No Refunds</h3>
            <p className="text-slate-700 mb-4">
              Fees already collected are non-refundable upon termination. Licensing agreements may contain specific provisions regarding refunds.
            </p>
          </section>

          {/* 16. Dispute Resolution */}
          <section id="dispute-resolution" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">16. Dispute Resolution</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">16.1 Informal Resolution</h3>
            <p className="text-slate-700 mb-4">
              Before initiating formal proceedings, you agree to contact us at mark@YesAllofUs.com to attempt to resolve any dispute informally. We will make good faith efforts to resolve the matter within 30 days.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">16.2 Governing Law</h3>
            <p className="text-slate-700 mb-4">
              These Terms are governed by the laws of Guernsey, Channel Islands, without regard to conflict of law principles.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">16.3 Jurisdiction</h3>
            <p className="text-slate-700 mb-4">
              Any disputes not resolved informally shall be subject to the exclusive jurisdiction of the courts of Guernsey.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">16.4 Class Action Waiver</h3>
            <p className="text-slate-700 mb-4">
              You agree to resolve disputes with us on an individual basis and waive any right to participate in class actions or collective proceedings.
            </p>
          </section>

          {/* 17. General Provisions */}
          <section id="general" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">17. General Provisions</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">17.1 Entire Agreement</h3>
            <p className="text-slate-700 mb-4">
              These Terms, together with the Privacy Policy and any applicable licensing agreement, constitute the entire agreement between you and YesAllofUs regarding the Service.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">17.2 Amendments</h3>
            <p className="text-slate-700 mb-4">
              We may modify these Terms at any time by posting updated Terms on our website. Material changes will be notified via email. Continued use of the Service after changes take effect constitutes acceptance.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">17.3 Severability</h3>
            <p className="text-slate-700 mb-4">
              If any provision of these Terms is found to be unenforceable, the remaining provisions will continue in full force and effect.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">17.4 Waiver</h3>
            <p className="text-slate-700 mb-4">
              Our failure to enforce any right or provision of these Terms shall not constitute a waiver of that right or provision.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">17.5 Assignment</h3>
            <p className="text-slate-700 mb-4">
              You may not assign or transfer these Terms without our prior written consent. We may assign our rights and obligations without restriction.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">17.6 Force Majeure</h3>
            <p className="text-slate-700 mb-4">
              We shall not be liable for any failure or delay in performance due to circumstances beyond our reasonable control, including natural disasters, war, terrorism, riots, government actions, or network failures.
            </p>

            <h3 className="text-lg font-semibold text-slate-800 mt-6 mb-3">17.7 Language</h3>
            <p className="text-slate-700 mb-4">
              These Terms are written in English. Any translations are provided for convenience only. In case of conflict, the English version prevails.
            </p>
          </section>

          {/* 18. Contact Information */}
          <section id="contact" className="mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-4">18. Contact Information</h2>
            <p className="text-slate-700 mb-4">For questions about these Terms, licensing enquiries, or the Service, contact us:</p>
            <div className="bg-slate-50 rounded-lg p-6">
              <p className="text-slate-700"><strong>YesAllofUs</strong></p>
              <p className="text-slate-700">Mark Flynn</p>
              <p className="text-slate-700">Guernsey, Channel Islands</p>
              <p className="text-slate-700 mt-2">
                <strong>Email:</strong> <a href="mailto:mark@YesAllofUs.com" className="text-blue-600 hover:underline">mark@YesAllofUs.com</a>
              </p>
              <p className="text-slate-700">
                <strong>Website:</strong> <a href="https://YesAllofUs.com" className="text-blue-600 hover:underline">https://YesAllofUs.com</a>
              </p>
            </div>
          </section>

        </div>

        {/* Acceptance */}
        <div className="border-t border-slate-200 pt-8 mt-12">
          <p className="text-slate-600 text-sm">
            By registering for an account, entering into a licensing agreement, or using the YesAllofUs Service, you acknowledge that you have read, understood, and agree to be bound by these Terms of Service.
          </p>
        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/trustline/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React, { useState } from 'react';


// MARK: - Component Definition
export default function TrustlineGuide() {

// MARK: - State Management
  const [copiedText, setCopiedText] = useState('');


// MARK: - Event Handlers
  const handleCopy = (text: string, label: string) => {
    navigator.clipboard.writeText(text);
    setCopiedText(label);
    setTimeout(() => setCopiedText(''), 2000);
  };


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans">

      <main className="max-w-4xl mx-auto px-6 py-12">
        {/* Hero */}
        <div className="text-center mb-12">
          <div className="inline-flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 px-4 py-2 rounded-full text-sm font-medium mb-6">
            <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Required for Affiliates
          </div>
          <h1 className="text-4xl md:text-5xl font-bold mb-4">Set Up Your RLUSD Trustline</h1>
          <p className="text-zinc-400 text-lg max-w-2xl mx-auto">
            To receive instant commission payments, your wallet needs an RLUSD trustline. This one-time setup takes about 2 minutes.
          </p>
        </div>

        {/* What is a Trustline */}
        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6 mb-8">
          <h2 className="text-xl font-bold mb-3 flex items-center gap-2">
            <svg className="w-5 h-5 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            What is a Trustline?
          </h2>
          <p className="text-zinc-300 leading-relaxed">
            A trustline is your permission to hold a specific token on the XRP Ledger. Think of it like opening a specific currency account at a bank. Without an RLUSD trustline, your wallet cannot receive RLUSD payments ‚Äî they&apos;ll simply fail.
          </p>
        </div>

        {/* RLUSD Details Box */}
        <div className="bg-gradient-to-br from-sky-500/10 to-indigo-500/10 border border-sky-500/30 rounded-xl p-6 mb-12">
          <h3 className="font-semibold text-white mb-4">RLUSD Token Details</h3>
          <div className="space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 bg-black/20 rounded-lg p-4">
              <div>
                <p className="text-zinc-400 text-sm">Currency Code</p>
                <p className="font-mono text-lg text-white">RLUSD</p>
              </div>
              <button
                onClick={() => handleCopy('RLUSD', 'currency')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                  copiedText === 'currency' 
                    ? 'bg-emerald-500 text-black' 
                    : 'bg-zinc-700 hover:bg-zinc-600 text-white'
                }`}
              >
                {copiedText === 'currency' ? '‚úì Copied' : 'Copy'}
              </button>
            </div>
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 bg-black/20 rounded-lg p-4">
              <div>
                <p className="text-zinc-400 text-sm">Issuer Address</p>
                <p className="font-mono text-sm sm:text-base text-white break-all">rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De</p>
              </div>
              <button
                onClick={() => handleCopy('rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De', 'issuer')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all flex-shrink-0 ${
                  copiedText === 'issuer' 
                    ? 'bg-emerald-500 text-black' 
                    : 'bg-zinc-700 hover:bg-zinc-600 text-white'
                }`}
              >
                {copiedText === 'issuer' ? '‚úì Copied' : 'Copy'}
              </button>
            </div>
          </div>
          <p className="text-zinc-500 text-sm mt-4">
            RLUSD is issued by Ripple ‚Äî the official stablecoin backed 1:1 by USD reserves.
          </p>
        </div>

        {/* Wallet Tabs */}
        <h2 className="text-2xl font-bold mb-6 text-center">Choose Your Wallet. Coming Soon.</h2>

        {/* Web3Auth Social Login - Full Width */}
        <div className="bg-gradient-to-br from-indigo-500/10 to-purple-500/10 border border-indigo-500/30 rounded-xl overflow-hidden mb-6">
          <div className="bg-gradient-to-r from-indigo-500/20 to-purple-500/20 p-6 border-b border-indigo-500/20">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-4">
                <div className="flex -space-x-2">
                  <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center border-2 border-zinc-900">
                    <svg className="w-5 h-5" viewBox="0 0 24 24">
                      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                  </div>
                  <div className="w-10 h-10 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
                    <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                    </svg>
                  </div>
                  <div className="w-10 h-10 bg-[#5865F2] rounded-full flex items-center justify-center border-2 border-zinc-900">
                    <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                  </div>
                </div>
                <div>
                  <h3 className="text-xl font-bold flex items-center gap-2">
                    Social Login
                    <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">Automatic</span>
                  </h3>
                  <p className="text-zinc-400 text-sm">Google, Apple, Facebook, X, Discord, GitHub</p>
                </div>
              </div>
            </div>
          </div>
          
          <div className="p-6">
            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 mb-6">
              <div className="flex items-start gap-3">
                <svg className="w-6 h-6 text-emerald-400 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                  <p className="text-emerald-300 font-semibold">No manual trustline setup required!</p>
                  <p className="text-zinc-400 text-sm mt-1">When you sign up with a social account, we handle everything automatically.</p>
                </div>
              </div>
            </div>

            <h4 className="font-semibold text-white mb-4">How It Works</h4>
            <div className="space-y-4 mb-6">
              <div className="flex gap-3">
                <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">1</div>
                <div>
                  <p className="text-zinc-300"><strong className="text-white">Sign up with any social account</strong></p>
                  <p className="text-zinc-500 text-sm">Google, Apple, Facebook, X, Discord, or GitHub</p>
                </div>
              </div>
              <div className="flex gap-3">
                <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">2</div>
                <div>
                  <p className="text-zinc-300"><strong className="text-white">YesAllofUs engine enables the Ledger to set up your XRPL wallet automatically</strong></p>
                  <p className="text-zinc-500 text-sm">A real wallet address is generated instantly using Web3Auth MPC technology</p>
                </div>
              </div>
              <div className="flex gap-3">
                <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">3</div>
                <div>
                  <p className="text-zinc-300"><strong className="text-white">Commissions are held in pending balance</strong></p>
                  <p className="text-zinc-500 text-sm">Your earnings accumulate until you reach the activation threshold (~$1.50)</p>
                </div>
              </div>
              <div className="flex gap-3">
                <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">4</div>
                <div>
                  <p className="text-zinc-300"><strong className="text-white">Your commission funds your wallet & the Ledger adds the trustline</strong></p>
                  <p className="text-zinc-500 text-sm">Once threshold is reached, the ledger activates your wallet and sets up the RLUSD trustline automatically</p>
                </div>
              </div>
              <div className="flex gap-3">
                <div className="w-7 h-7 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">‚úì</div>
                <div>
                  <p className="text-zinc-300"><strong className="text-white">Pending balance released + future payouts instant</strong></p>
                  <p className="text-zinc-500 text-sm">Your held commissions are paid out, and all future earnings arrive in ~4 seconds</p>
                </div>
              </div>
            </div>

            <div className="bg-zinc-800/50 rounded-lg p-4 mb-6">
              <h5 className="font-semibold text-white mb-2 flex items-center gap-2">
                <svg className="w-4 h-4 text-amber-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4M12 8h.01"/>
                </svg>
                Why the 1.50 XRP threshold?
              </h5>
              <p className="text-zinc-400 text-sm">
                New XRPL wallets require a minimum reserve of ~1 XRP to activate, plus ~0.2 XRP for each trustline. 
                Instead of asking you to fund this yourself, we cover it from your first commissions plus transaction fees to help you start. 
                You don&apos;t pay anything ‚Äî it just means your first few dollars are held briefly until the we can tell the ledger to activate your wallet.
              </p>
            </div>

            <a 
              href="/affiliate-dashboard"
              className="flex items-center justify-center gap-2 w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-400 hover:to-purple-400 text-white font-semibold py-3 px-4 rounded-lg transition-all"
            >
              <span>Sign Up with Social Login</span>
              <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          </div>
        </div>

        {/* Divider */}
        <div className="flex items-center gap-4 my-8">
          <div className="flex-1 h-px bg-zinc-800"></div>
          <span className="text-zinc-500 text-sm">Or use your own wallet</span>
          <div className="flex-1 h-px bg-zinc-800"></div>
        </div>
        
        <div className="grid md:grid-cols-2 gap-6 mb-12">
          {/* Xaman Card */}
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden h-full flex flex-col">
            <div className="bg-gradient-to-r from-indigo-500/20 to-purple-500/20 p-6 border-b border-zinc-800">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-xl overflow-hidden">
                  <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-full h-full object-cover" />
                </div>
                <div>
                  <h3 className="text-xl font-bold">Xaman</h3>
                  <p className="text-zinc-400 text-sm">Mobile Wallet (iOS & Android)</p>
                </div>
              </div>
            </div>
            
            <div className="p-6 flex flex-col flex-1">
              <div className="space-y-4 mb-6">
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">1</div>
                  <p className="text-zinc-300">Open Xaman and tap the <strong className="text-white">+</strong> button on your home screen</p>
                </div>
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">2</div>
                  <p className="text-zinc-300">Search for <strong className="text-white">&quot;RLUSD&quot;</strong> in the token list</p>
                </div>
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">3</div>
                  <p className="text-zinc-300">Tap <strong className="text-white">Add</strong> and confirm the trustline transaction</p>
                </div>
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-indigo-500/20 text-indigo-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">4</div>
                  <p className="text-zinc-300">Sign with your passcode or biometrics</p>
                </div>
              </div>
              
              <div className="mt-auto">
                <a 
                  href="https://help.xaman.app/app/getting-started-with-xaman/how-to-create-a-rlusd-trust-line"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center justify-center gap-2 w-full bg-indigo-500 hover:bg-indigo-400 text-white font-semibold py-3 px-4 rounded-lg transition-colors"
                >
                  <span>View Official Xaman Guide</span>
                  <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                  </svg>
                </a>
                <p className="text-zinc-500 text-xs text-center mt-3">
                  Don&apos;t have Xaman? <a href="https://xaman.app" target="_blank" rel="noopener noreferrer" className="text-indigo-400 hover:underline">Download here ‚Üí</a>
                </p>
              </div>
            </div>
          </div>

          {/* Crossmark Card */}
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden h-full flex flex-col">
            <div className="bg-gradient-to-r from-emerald-500/20 to-teal-500/20 p-6 border-b border-zinc-800">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 rounded-xl overflow-hidden">
                  <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-full h-full object-cover" />
                </div>
                <div>
                  <h3 className="text-xl font-bold">Crossmark</h3>
                  <p className="text-zinc-400 text-sm">Browser Extension</p>
                </div>
              </div>
            </div>
            
            <div className="p-6 flex flex-col flex-1">
              <div className="space-y-4 mb-6">
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">1</div>
                  <p className="text-zinc-300">Open Crossmark and click <strong className="text-white">Assets</strong> or the <strong className="text-white">+</strong> icon</p>
                </div>
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">2</div>
                  <p className="text-zinc-300">Select <strong className="text-white">Add Custom Asset</strong></p>
                </div>
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">3</div>
                  <div className="text-zinc-300">
                    <p className="mb-1">Enter the token details:</p>
                    <ul className="text-sm space-y-1 text-zinc-400">
                      <li>‚Ä¢ Currency: <code className="bg-zinc-800 px-1.5 py-0.5 rounded text-emerald-400">RLUSD</code></li>
                      <li>‚Ä¢ Issuer: <code className="bg-zinc-800 px-1.5 py-0.5 rounded text-emerald-400 text-xs">rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De</code></li>
                    </ul>
                  </div>
                </div>
                <div className="flex gap-3">
                  <div className="w-7 h-7 bg-emerald-500/20 text-emerald-400 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">4</div>
                  <p className="text-zinc-300">Review and <strong className="text-white">Sign</strong> the TrustSet transaction</p>
                </div>
              </div>
              
              <div className="mt-auto">
                <a 
                  href="https://crossmark.io"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center justify-center gap-2 w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-3 px-4 rounded-lg transition-colors"
                >
                  <span>Get Crossmark Extension</span>
                  <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                  </svg>
                </a>
                <p className="text-zinc-500 text-xs text-center mt-3">
                  Works with Chrome, Firefox, Brave & Edge
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Requirements Box */}
        <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-6 mb-12">
          <h3 className="font-semibold text-amber-400 mb-4 flex items-center gap-2">
            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            Before You Start (Xaman & Crossmark Only)
          </h3>
          <p className="text-zinc-400 text-sm mb-4">These requirements apply only if you&apos;re using your own wallet. Social login handles this automatically.</p>
          <ul className="space-y-3 text-zinc-300">
            <li className="flex items-start gap-3">
              <svg className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span><strong className="text-white">Activated wallet</strong> ‚Äî You need at least 1 XRP to activate your wallet</span>
            </li>
            <li className="flex items-start gap-3">
              <svg className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span><strong className="text-white">Reserve requirement</strong> ‚Äî Each trustline locks 0.2 XRP as a reserve (released if you remove the trustline)</span>
            </li>
            <li className="flex items-start gap-3">
              <svg className="w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span><strong className="text-white">Transaction fee</strong> ‚Äî A tiny fee (~0.00001 XRP) is required to set the trustline</span>
            </li>
          </ul>
        </div>

        {/* Verification Section */}
        <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-12">
          <h3 className="font-semibold text-white mb-4 flex items-center gap-2">
            <svg className="w-5 h-5 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            How to Verify Your Trustline
          </h3>
          <p className="text-zinc-300 mb-4">
            After setting up, you can verify your trustline is active:
          </p>
          <ol className="space-y-2 text-zinc-300 mb-4">
  <li className="flex items-start gap-2">
    <span className="text-zinc-500">1.</span>
    <span>Visit <a href="https://xrpl.org/docs/references/protocol/transactions/types/trustset" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline">xrpl.org trustline docs</a></span>
  </li>
            <li className="flex items-start gap-2">
              <span className="text-zinc-500">2.</span>
              <span>Enter your wallet address in the search bar</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-zinc-500">3.</span>
              <span>Click the <strong className="text-white">Assets</strong> tab</span>
            </li>
            <li className="flex items-start gap-2">
              <span className="text-zinc-500">4.</span>
              <span>You should see <strong className="text-white">RLUSD</strong> listed with a balance of 0</span>
            </li>
          </ol>
          <p className="text-zinc-500 text-sm">
            A balance of 0 is normal ‚Äî it just means your trustline is set up and ready to receive payments.
          </p>
        </div>

        {/* FAQ Section */}
        <div className="mb-12">
          <h2 className="text-2xl font-bold mb-6">Common Questions</h2>
          
          <div className="space-y-4">
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
              <h4 className="font-semibold text-white mb-2">What happens if I don&apos;t have a trustline?</h4>
              <p className="text-zinc-400 text-sm">Your commission payments will fail and be skipped. The merchant won&apos;t be charged, but you won&apos;t receive your earnings until you set up the trustline.</p>
            </div>

            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
              <h4 className="font-semibold text-white mb-2">What if I use social login ‚Äî do I need to do anything?</h4>
              <p className="text-zinc-400 text-sm">No! When you sign up with Google, Apple, or other social accounts, we handle wallet creation, funding, and trustline setup automatically. Your first ~$1.50 in commissions are held to cover the wallet activation, then everything flows instantly after that.</p>
            </div>
            
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
              <h4 className="font-semibold text-white mb-2">Is RLUSD safe?</h4>
              <p className="text-zinc-400 text-sm">RLUSD is issued by Ripple and is backed 1:1 by US dollar deposits held in regulated financial institutions. It&apos;s designed to maintain a stable $1 value.</p>
            </div>
            
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
              <h4 className="font-semibold text-white mb-2">Can I remove the trustline later?</h4>
              <p className="text-zinc-400 text-sm">Yes, but only if your RLUSD balance is zero. Removing the trustline releases the 2 XRP reserve back to your available balance.</p>
            </div>
            
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
              <h4 className="font-semibold text-white mb-2">Why RLUSD instead of XRP?</h4>
              <p className="text-zinc-400 text-sm">RLUSD is a stablecoin pegged to the US dollar, so your commissions maintain their value. XRP is volatile ‚Äî a $10 commission could be worth $8 or $12 an hour later.</p>
            </div>

            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-5">
  <h4 className="font-semibold text-white mb-2">Can I switch from social login to my own wallet later?</h4>
  <p className="text-zinc-400 text-sm">Yes! You can create your own wallet with Xaman or Crossmark anytime and update your wallet address in your affiliate dashboard. Your future commissions will be paid to your new address.</p>
</div>
          </div>
        </div>

        {/* CTA */}
        <div className="text-center bg-gradient-to-br from-emerald-500/10 to-sky-500/10 border border-emerald-500/30 rounded-xl p-8">
          <h2 className="text-2xl font-bold mb-2">Ready to Earn?</h2>
          <p className="text-zinc-400 mb-6">Once your trustline is set up, you&apos;re ready to receive instant commissions.</p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <a 
              href="/affiliate-dashboard"
              className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-6 py-3 rounded-lg transition-colors"
            >
              Go to Affiliate Dashboard
            </a>
            <a 
              href="/"
              className="border border-zinc-600 hover:border-zinc-400 text-white px-6 py-3 rounded-lg transition-colors"
            >
              Learn More About YesAllofUs
            </a>
          </div>
        </div>

        {/* Resources */}
        <div className="mt-12 pt-8 border-t border-zinc-800">
          <h3 className="text-lg font-semibold mb-4 text-zinc-400">Official Resources</h3>
          <div className="flex flex-wrap gap-4 text-sm">
            <a href="https://help.xaman.app/app/getting-started-with-xaman/how-to-create-a-rlusd-trust-line" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline">Xaman Help Center ‚Üí</a>
            <a href="https://xrpl.org/trust-lines-and-issuing.html" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline">XRPL Documentation ‚Üí</a>
            <a href="https://ripple.com/solutions/stablecoin/" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline">About RLUSD ‚Üí</a>
          </div>
        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(main)/wallet-guide/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';
import Link from 'next/link';


// MARK: - Component Definition
export default function WalletGuide() {
  const [activeTab, setActiveTab] = useState<'social' | 'xaman' | 'crossmark'>('social');


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">
      {/* Hero */}
<header className="relative overflow-hidden border-b border-zinc-800/50">
  <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/5 via-transparent to-blue-500/5" />
  <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-emerald-500/10 rounded-full blur-[120px] -translate-y-1/2" />

  <div className="relative max-w-4xl mx-auto px-6 py-20 text-center">
    <div className="inline-flex items-center gap-2 bg-zinc-800/50 border border-zinc-700/50 rounded-full px-4 py-1.5 mb-6">
      <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
      <span className="text-zinc-400 text-sm">Built on XRPL ¬∑ Secured by Design</span>
    </div>
    
    <h1 className="text-4xl md:text-5xl font-bold mb-6 bg-gradient-to-r from-white via-white to-zinc-400 bg-clip-text text-transparent">
      Get Started with YesAllofUs
    </h1>
    
    <p className="text-xl text-zinc-400 max-w-2xl mx-auto mb-8">
      To receive commissions, you'll need an Xaman wallet. Social Log in Coming Soon.
    </p>

    <div className="flex flex-wrap justify-center gap-4">
      <div className="flex items-center gap-2 bg-zinc-900/50 border border-zinc-800 rounded-lg px-4 py-2">
        <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
        <span className="text-zinc-300 text-sm">Non-custodial</span>
      </div>
      <div className="flex items-center gap-2 bg-zinc-900/50 border border-zinc-800 rounded-lg px-4 py-2">
        <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        <span className="text-zinc-300 text-sm">You control your keys</span>
      </div>
      <div className="flex items-center gap-2 bg-zinc-900/50 border border-zinc-800 rounded-lg px-4 py-2">
        <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
        </svg>
        <span className="text-zinc-300 text-sm">Fully auditable on-chain</span>
      </div>
    </div>
  </div>
</header>

{/* Xaman Setup Guide */}
<section className="bg-gradient-to-b from-zinc-900/50 to-transparent border-b border-zinc-800/50">
  <div className="max-w-4xl mx-auto px-6 py-16">
    <div className="text-center mb-12">
      <div className="inline-flex items-center gap-2 bg-blue-500/10 border border-blue-500/30 rounded-full px-4 py-1.5 mb-6">
        <span className="text-blue-400 text-sm font-medium">Recommended for Affiliates</span>
      </div>
      <h2 className="text-3xl font-bold mb-4">Set Up Your Xaman Wallet</h2>
      <p className="text-zinc-400 max-w-2xl mx-auto">
        Follow these steps to create your wallet and start receiving RLUSD commissions. Takes about 10 minutes.
      </p>
    </div>

    <div className="grid md:grid-cols-2 gap-8 mb-12">
      {/* Left Column - Steps 1-3 */}
      <div className="space-y-6">
        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold text-lg">1</div>
            <div>
              <h3 className="text-lg font-semibold mb-2">Download Xaman App</h3>
              <p className="text-zinc-400 text-sm mb-4">
                Xaman (formerly XUMM) is free and available on iOS and Android. Download from the official app stores only.
              </p>
              <div className="flex flex-wrap gap-3">
                <a 
                  href="https://apps.apple.com/app/xumm/id1492302343"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-white text-sm px-4 py-2 rounded-lg transition"
                >
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                  </svg>
                  App Store
                </a>
                <a 
                  href="https://play.google.com/store/apps/details?id=com.xrpllabs.xumm"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-white text-sm px-4 py-2 rounded-lg transition"
                >
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M3.609 1.814L13.792 12 3.61 22.186a.996.996 0 01-.61-.92V2.734a1 1 0 01.609-.92zm10.89 10.893l2.302 2.302-10.937 6.333 8.635-8.635zm3.199-3.198l2.807 1.626a1 1 0 010 1.73l-2.808 1.626L15.206 12l2.492-2.491zM5.864 2.658L16.802 8.99l-2.303 2.303-8.635-8.635z"/>
                  </svg>
                  Google Play
                </a>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold text-lg">2</div>
            <div>
              <h3 className="text-lg font-semibold mb-2">Create Your Wallet</h3>
              <p className="text-zinc-400 text-sm mb-3">
                Open the app and tap "Create a new account". You'll be shown secret numbers - these are your recovery phrase.
              </p>
              <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
                <p className="text-amber-400 text-xs font-medium">
                  ‚ö†Ô∏è Write down your secret numbers on paper. Never screenshot or share them. If you lose them, you lose access to your wallet forever. Never share these. If anyone gets access to this they can access your funds and you could lose everything.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold text-lg">3</div>
            <div>
              <h3 className="text-lg font-semibold mb-2">Activate Your Wallet</h3>
              <p className="text-zinc-400 text-sm mb-3">
                Your wallet needs 1 XRP to activate (this is an XRPL requirement, not a fee). You can buy XRP from any exchange and send it to your new address. You wil need 0.5 XRP to cover future XRPl Ledger transaction fees.
              </p>
              <p className="text-zinc-500 text-xs">
                Popular exchanges: Coinbase, Kraken, Bitstamp, Uphold.
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Right Column - Steps 4-5 */}
      <div className="space-y-6">
        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold text-lg">4</div>
            <div>
              <h3 className="text-lg font-semibold mb-2">Add RLUSD Trustline</h3>
              <p className="text-zinc-400 text-sm mb-3">
                To receive RLUSD commissions, you need to add a trustline. This tells the XRP Ledger you accept RLUSD.
              </p>
              <a 
                href="https://yesallofus.com/trustline"
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-2 bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 text-sm px-4 py-2 rounded-lg transition border border-emerald-500/30"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                RLUSD Trustline Guide
              </a>
            </div>
          </div>
        </div>

        <div className="bg-zinc-900/50 border border-zinc-800 rounded-xl p-6">
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 text-white font-bold text-lg">5</div>
            <div>
              <h3 className="text-lg font-semibold mb-2">Copy Your Wallet Address</h3>
              <p className="text-zinc-400 text-sm mb-3">
                In Xaman, tap on your account to see your wallet address. It starts with "r" and looks like: <code className="text-blue-400 bg-zinc-800 px-1.5 py-0.5 rounded text-xs">rXXXXXXXX...</code>
              </p>
              <p className="text-zinc-500 text-xs">
                This is the address you'll paste when signing up as an affiliate on any store using YesAllofUs.
              </p>
            </div>
          </div>
        </div>

        <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6">
          <div className="flex items-start gap-4">
            <div className="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center flex-shrink-0">
              <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <div>
              <h3 className="text-lg font-semibold mb-2 text-emerald-400">You're Ready!</h3>
              <p className="text-zinc-400 text-sm">
                Your wallet is set up. Now you can sign up as an affiliate on any store using YesAllofUs and paste your wallet address to start earning commissions.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    {/* Official Link */}
    <div className="text-center">
      <p className="text-zinc-500 text-sm mb-3">Need more help? Visit the official Xaman documentation</p>
      <a 
        href="https://xaman.app"
        target="_blank"
        rel="noopener noreferrer"
        className="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 font-medium transition"
      >
        <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-6 h-6 rounded" />
        xaman.app
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
      </a>
    </div>
  </div>
</section>

      <main className="max-w-6xl mx-auto px-6 py-16">
        
        {/* Wallet Options Tabs */}
        <section className="mb-20">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-bold mb-4">Choose Your Connection Method</h2>
            <p className="text-zinc-400 max-w-2xl mx-auto">
              Each option has different trade-offs between convenience and control. Pick what works for you.
            </p>
          </div>

          {/* Tab Buttons */}
          <div className="flex flex-wrap justify-center gap-3 mb-8">
            <button

// MARK: - Event Handlers
              onClick={() => setActiveTab('xaman')}
              className={`flex items-center gap-3 px-6 py-4 rounded-xl border transition-all ${
                activeTab === 'xaman'
                  ? 'bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border-blue-500/50 shadow-lg shadow-blue-500/10'
                  : 'bg-zinc-900/50 border-zinc-800 hover:border-zinc-700'
              }`}
            >
              <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-10 h-10 rounded-lg" />
              <div className="text-left">
                <div className="font-semibold flex items-center gap-2">
                  Xaman
                  <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">‚úì Live</span>
                </div>
                <div className="text-zinc-500 text-sm">Mobile app</div>
              </div>
            </button>
            <button
              onClick={() => setActiveTab('social')}
              className={`flex items-center gap-3 px-6 py-4 rounded-xl border transition-all ${
                activeTab === 'social'
                  ? 'bg-gradient-to-r from-indigo-500/20 to-purple-500/20 border-indigo-500/50 shadow-lg shadow-indigo-500/10'
                  : 'bg-zinc-900/50 border-zinc-800 hover:border-zinc-700'
              }`}
            >
              <div className="flex -space-x-2">
                <div className="w-7 h-7 bg-white rounded-full flex items-center justify-center border-2 border-zinc-900">
                  <svg className="w-4 h-4" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                </div>
                <div className="w-7 h-7 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
                  <svg className="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                  </svg>
                </div>
                <div className="w-7 h-7 bg-[#5865F2] rounded-full flex items-center justify-center border-2 border-zinc-900">
                  <svg className="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                  </svg>
                </div>
              </div>
              <div className="text-left">
                <div className="font-semibold flex items-center gap-2">
                  Social Login
                  <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">Coming Soon</span>
                </div>
                <div className="text-zinc-500 text-sm">No wallet needed</div>
              </div>
            </button>

            <button
              onClick={() => setActiveTab('crossmark')}
              className={`flex items-center gap-3 px-6 py-4 rounded-xl border transition-all ${
                activeTab === 'crossmark'
                  ? 'bg-gradient-to-r from-orange-500/20 to-yellow-500/20 border-orange-500/50 shadow-lg shadow-orange-500/10'
                  : 'bg-zinc-900/50 border-zinc-800 hover:border-zinc-700'
              }`}
            >
              <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-10 h-10 rounded-lg" />
              <div className="text-left">
                <div className="font-semibold flex items-center gap-2">
                  Crossmark
                  <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded">Coming Soon</span>
                </div>
                <div className="text-zinc-500 text-sm">Browser extension</div>
              </div>
            </button>
          </div>

          {/* Tab Content */}
          <div className="bg-zinc-900/30 border border-zinc-800 rounded-2xl overflow-hidden">
            
            {/* Social Login Tab */}
            {activeTab === 'social' && (
              <div className="p-8 md:p-12">
                <div className="grid lg:grid-cols-2 gap-12">
                  <div>
                    <div className="flex items-center gap-3 mb-6">
                      <div className="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center">
                        <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                      </div>
                      <div>
                        <h3 className="text-2xl font-bold">Social Login</h3>
                        <p className="text-zinc-500">Powered by Web3Auth MPC</p>
                      </div>
                    </div>

                    <p className="text-zinc-300 mb-6 leading-relaxed">
                      No wallet app needed. No seed phrases to remember. Sign in with Google, Apple, Facebook, X, Discord, or GitHub ‚Äî we create a real XRPL wallet for you instantly using Multi-Party Computation technology.
                    </p>

                    <div className="space-y-4 mb-8">
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">We make it easy</div>
                          <div className="text-zinc-500 text-sm">If you can use Gmail, you can use YesAllofUs</div>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">Automatic wallet creation</div>
                          <div className="text-zinc-500 text-sm">Real XRPL address created in seconds</div>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">24/7 automatic payouts</div>
                          <div className="text-zinc-500 text-sm">No browser session required ‚Äî works while you sleep</div>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-emerald-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">We handle wallet activation</div>
                          <div className="text-zinc-500 text-sm">Your commissions auto-fund your wallet reserve</div>
                        </div>
                      </div>
                    </div>

                    <div className="flex flex-wrap gap-3">
                      <button 
  disabled
  className="bg-zinc-700 text-zinc-400 px-6 py-3 rounded-lg font-semibold cursor-not-allowed"
>
  Sign Up with Social
  <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded ml-2">Coming Soon</span>
</button>
                      <Link 
                        href="/docs/web3auth"
                        className="bg-zinc-800 hover:bg-zinc-700 text-white px-6 py-3 rounded-lg font-medium transition"
                      >
                        Technical Docs ‚Üí
                      </Link>
                    </div>
                  </div>

                  <div>
                    {/* How MPC Works */}
                    <div className="bg-zinc-800/50 rounded-xl p-6 mb-6">
                      <h4 className="font-semibold mb-4 flex items-center gap-2">
                        <svg className="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                        </svg>
                        How Multi-Party Computation Works
                      </h4>
                      <div className="space-y-4 text-sm">
                        <div className="flex gap-3">
                          <div className="w-8 h-8 bg-indigo-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-400 font-bold">1</div>
                          <div>
                            <div className="text-zinc-300 font-medium">Private key is never whole</div>
                            <div className="text-zinc-500">Your key is mathematically split into multiple encrypted shares</div>
                          </div>
                        </div>
                        <div className="flex gap-3">
                          <div className="w-8 h-8 bg-indigo-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-400 font-bold">2</div>
                          <div>
                            <div className="text-zinc-300 font-medium">Distributed across nodes</div>
                            <div className="text-zinc-500">Shares stored on separate Web3Auth infrastructure nodes</div>
                          </div>
                        </div>
                        <div className="flex gap-3">
                          <div className="w-8 h-8 bg-indigo-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-400 font-bold">3</div>
                          <div>
                            <div className="text-zinc-300 font-medium">Reconstructed only when signing</div>
                            <div className="text-zinc-500">Shares combine momentarily to sign, then split again</div>
                          </div>
                        </div>
                        <div className="flex gap-3">
                          <div className="w-8 h-8 bg-indigo-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-indigo-400 font-bold">4</div>
                          <div>
                            <div className="text-zinc-300 font-medium">No single point of failure</div>
                            <div className="text-zinc-500">Compromising one node doesn't compromise your wallet</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Supported Providers */}
                    <div className="bg-zinc-800/50 rounded-xl p-6">
                      <h4 className="font-semibold mb-4">Supported Providers</h4>
                      <div className="grid grid-cols-4 gap-3">
                        {[
                          { name: 'Google', bg: 'bg-white', icon: <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> },
                          { name: 'Apple', bg: 'bg-black', icon: <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg> },
                          { name: 'Facebook', bg: 'bg-[#1877F2]', icon: <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg> },
                          { name: 'X', bg: 'bg-black', icon: <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg> },
                          { name: 'Discord', bg: 'bg-[#5865F2]', icon: <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg> },
                          { name: 'GitHub', bg: 'bg-[#24292e]', icon: <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg> },
                          { name: 'Twitch', bg: 'bg-[#9146FF]', icon: <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714z"/></svg> },
                          { name: 'More', bg: 'bg-zinc-700', icon: <span className="text-white text-xs font-bold">+5</span> },
                        ].map((p) => (
                          <div key={p.name} className="flex flex-col items-center gap-2">
                            <div className={`w-12 h-12 ${p.bg} rounded-xl flex items-center justify-center`}>
                              {p.icon}
                            </div>
                            <span className="text-zinc-500 text-xs">{p.name}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Xaman Tab */}
{activeTab === 'xaman' && (
  <div className="p-8 md:p-12">
    <div className="grid lg:grid-cols-2 gap-12">
      <div>
        <div className="flex items-center gap-3 mb-6">
          <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-12 h-12 rounded-xl" />
          <div>
            <h3 className="text-2xl font-bold">Xaman Wallet</h3>
            <p className="text-zinc-500">The recommended XRPL wallet</p>
          </div>
        </div>

        <p className="text-zinc-300 mb-6 leading-relaxed">
          Xaman (formerly XUMM) is the most trusted wallet for XRP Ledger. Your private keys stay on your phone, and you approve every transaction. Free to download and use.
        </p>

        {/* Step by step setup */}
        <div className="bg-zinc-800/50 rounded-xl p-6 mb-6">
          <h4 className="font-semibold mb-4 text-emerald-400">How to Get Started</h4>
          <div className="space-y-4 text-sm">
            <div className="flex gap-3">
              <div className="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-emerald-400 font-bold">1</div>
              <div>
                <div className="text-zinc-300 font-medium">Download Xaman</div>
                <div className="text-zinc-500">Available on iOS App Store and Google Play</div>
              </div>
            </div>
            <div className="flex gap-3">
              <div className="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-emerald-400 font-bold">2</div>
              <div>
                <div className="text-zinc-300 font-medium">Create a new wallet</div>
                <div className="text-zinc-500">Follow the app instructions, save your secret numbers safely</div>
              </div>
            </div>
            <div className="flex gap-3">
              <div className="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-emerald-400 font-bold">3</div>
              <div>
                <div className="text-zinc-300 font-medium">Activate your wallet</div>
                <div className="text-zinc-500">You need 10 XRP to activate (buy from any exchange)</div>
              </div>
            </div>
            <div className="flex gap-3">
              <div className="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-emerald-400 font-bold">4</div>
              <div>
                <div className="text-zinc-300 font-medium">Add RLUSD trustline</div>
                <div className="text-zinc-500">Required to receive RLUSD commissions</div>
              </div>
            </div>
            <div className="flex gap-3">
              <div className="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0 text-emerald-400 font-bold">5</div>
              <div>
                <div className="text-zinc-300 font-medium">Copy your wallet address</div>
                <div className="text-zinc-500">Starts with "r" - paste this when signing up as affiliate</div>
              </div>
            </div>
          </div>
        </div>

        <div className="flex flex-wrap gap-3">
          <a 
            href="https://xaman.app"
            target="_blank"
            rel="noopener noreferrer"
            className="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-400 hover:to-cyan-400 text-white px-6 py-3 rounded-lg font-semibold transition"
          >
            Download Xaman ‚Üí
          </a>
          <a 
            href="https://yesallofus.com/trustline"
            target="_blank"
            rel="noopener noreferrer"
            className="bg-zinc-800 hover:bg-zinc-700 text-white px-6 py-3 rounded-lg font-medium transition"
          >
            RLUSD Trustline Guide
          </a>
        </div>
      </div>

      <div>
        {/* Why Xaman */}
        <div className="bg-zinc-800/50 rounded-xl p-6 mb-6">
          <h4 className="font-semibold mb-4 flex items-center gap-2">
            <svg className="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            Why Xaman?
          </h4>
          <div className="space-y-4 text-sm">
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg className="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <div className="font-medium text-zinc-300">Keys stay on your phone</div>
                <div className="text-zinc-500">Your private keys are never shared</div>
              </div>
            </div>
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg className="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <div className="font-medium text-zinc-300">Trusted since 2018</div>
                <div className="text-zinc-500">The most popular XRPL wallet</div>
              </div>
            </div>
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg className="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <div className="font-medium text-zinc-300">iOS and Android</div>
                <div className="text-zinc-500">Works on any smartphone</div>
              </div>
            </div>
            <div className="flex items-start gap-3">
              <div className="w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                <svg className="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <div>
                <div className="font-medium text-zinc-300">Free to use</div>
                <div className="text-zinc-500">No subscription or fees from Xaman</div>
              </div>
            </div>
          </div>
        </div>

        {/* Important Note */}
        <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-6">
          <h4 className="font-semibold mb-3 text-amber-400">Important</h4>
          <ul className="text-zinc-300 text-sm space-y-2">
            <li>‚Ä¢ You need 10 XRP to activate your wallet</li>
            <li>‚Ä¢ You need an RLUSD trustline to receive commissions</li>
            <li>‚Ä¢ Never share your secret numbers with anyone</li>
            <li>‚Ä¢ YesAllofUs will never ask for your private keys</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
)}

            {/* Crossmark Tab */}
            {activeTab === 'crossmark' && (
              <div className="p-8 md:p-12">
                <div className="grid lg:grid-cols-2 gap-12">
                  <div>
                    <div className="flex items-center gap-3 mb-6">
                      <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-12 h-12 rounded-xl" />
                      <div>
                        <h3 className="text-2xl font-bold">Crossmark Wallet</h3>
                        <p className="text-zinc-500">Full automation, Auto-Sign control</p>
                      </div>
                    </div>

                    <p className="text-zinc-300 mb-6 leading-relaxed">
                      For high-volume stores that need instant, automated payouts. You add YesAllofUs as a signer with specific limits ‚Äî payments process automatically without manual approval. Affiliates get paid in ~4 seconds.
                    </p>

                    <div className="space-y-4 mb-8">
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-orange-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">Fully automatic payouts</div>
                          <div className="text-zinc-500 text-sm">No manual approval needed</div>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-orange-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">You set the limits</div>
                          <div className="text-zinc-500 text-sm">Max per transaction and daily caps</div>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-orange-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">Uses XRPL SignerLists</div>
                          <div className="text-zinc-500 text-sm">Native multi-sig, not a proprietary system</div>
                        </div>
                      </div>
                      <div className="flex items-start gap-3">
                        <div className="w-6 h-6 bg-orange-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                          <svg className="w-3.5 h-3.5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                        </div>
                        <div>
                          <div className="font-medium">Revoke access anytime</div>
                          <div className="text-zinc-500 text-sm">Remove signer from your wallet instantly</div>
                        </div>
                      </div>
                    </div>

                    <div className="flex flex-wrap gap-3">
                      <button 
  disabled
  className="bg-zinc-700 text-zinc-400 px-6 py-3 rounded-lg font-semibold cursor-not-allowed"
>
  Connect Crossmark
  <span className="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded ml-2">Coming Soon</span>
</button>
                      <a 
                        href="https://crossmark.io"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="bg-zinc-800 hover:bg-zinc-700 text-white px-6 py-3 rounded-lg font-medium transition"
                      >
                        Get Crossmark ‚Üí
                      </a>
                    </div>
                  </div>

                  <div>
                    {/* SignerList Explainer */}
                    <div className="bg-zinc-800/50 rounded-xl p-6 mb-6">
                      <h4 className="font-semibold mb-4 flex items-center gap-2">
                        <svg className="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        How SignerLists Work
                      </h4>
                      <div className="space-y-3 text-sm">
                        <p className="text-zinc-400">
                          XRPL's native multi-signature feature. You add our platform wallet as an authorized signer. We can then sign transactions on your behalf ‚Äî but only RLUSD payments, and only within your limits.
                        </p>
                        <div className="bg-zinc-900/50 rounded-lg p-4 font-mono text-xs text-zinc-400">
                          <div className="text-orange-400">// Your wallet's SignerList</div>
                          <div>SignerQuorum: 1</div>
                          <div>SignerEntries: [</div>
                          <div className="pl-4">{"{"} Account: "YesAllofUs Platform" {"}"}</div>
                          <div>]</div>
                        </div>
                        <p className="text-zinc-500">
                          This is an XRPL primitive, not YesAllofUs code. Auditable on-chain. Revocable instantly.
                        </p>
                      </div>
                    </div>

                    {/* Best For */}
                    <div className="bg-orange-500/10 border border-orange-500/30 rounded-xl p-6">
                      <h4 className="font-semibold mb-3 text-orange-400">Best For</h4>
                      <ul className="text-zinc-300 text-sm space-y-2">
                        <li>‚Ä¢ High-volume stores (50+ orders/day)</li>
                        <li>‚Ä¢ Users comfortable with XRPL concepts</li>
                        <li>‚Ä¢ Those who want instant affiliate payments</li>
                        <li>‚Ä¢ Desktop-first workflow</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </section>

        {/* Comparison Table */}
        <section className="mb-20">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-bold mb-4">Quick Comparison</h2>
            <p className="text-zinc-400">All three options at a glance</p>
          </div>

          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b border-zinc-800">
                  <th className="text-left py-4 px-4 text-zinc-400 font-medium">Feature</th>
                  <th className="text-center py-4 px-4">
                    <div className="flex flex-col items-center gap-2">
                      <div className="flex -space-x-1">
                        <div className="w-6 h-6 bg-white rounded-full flex items-center justify-center">
                          <svg className="w-3.5 h-3.5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        </div>
                      </div>
                      <span className="font-semibold">Social Login</span>
<span className="bg-emerald-500/20 text-emerald-400 text-[10px] px-1.5 py-0.5 rounded ml-1">Soon</span>
                    </div>
                  </th>
                  <th className="text-center py-4 px-4">
                    <div className="flex flex-col items-center gap-2">
                      <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded-lg" />
                      <span className="font-semibold">Xaman</span>
<span className="bg-emerald-500/20 text-emerald-400 text-[10px] px-1.5 py-0.5 rounded ml-1">‚úì Live</span>
                    </div>
                  </th>
                  <th className="text-center py-4 px-4">
                    <div className="flex flex-col items-center gap-2">
                      <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded-lg" />
                      <span className="font-semibold">Crossmark</span>
<span className="bg-emerald-500/20 text-emerald-400 text-[10px] px-1.5 py-0.5 rounded ml-1">Soon</span>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody className="text-sm">
                {[
                  { feature: 'Setup Time', social: '30 seconds', xaman: '~5 minutes', crossmark: '~5 minutes' },
                  { feature: 'Crypto Knowledge', social: 'None required', xaman: 'Basic', crossmark: 'Intermediate' },
                  { feature: 'Payout Mode', social: 'Automatic 24/7', xaman: 'Manual approval', crossmark: 'Automatic 24/7' },
                  { feature: 'Platform', social: 'Any browser', xaman: 'Mobile (iOS/Android)', crossmark: 'Desktop browser' },
                  { feature: 'Key Storage', social: 'MPC (distributed)', xaman: 'Your device only', crossmark: 'Your device only' },
                  { feature: 'Recovery', social: 'Social account', xaman: 'Seed phrase', crossmark: 'Seed phrase' },
                  { feature: 'Best For', social: 'Beginners', xaman: 'Security-first', crossmark: 'Power users' },
                ].map((row, i) => (
                  <tr key={i} className="border-b border-zinc-800/50">
                    <td className="py-4 px-4 text-zinc-400">{row.feature}</td>
                    <td className="py-4 px-4 text-center text-zinc-300">{row.social}</td>
                    <td className="py-4 px-4 text-center text-zinc-300">{row.xaman}</td>
                    <td className="py-4 px-4 text-center text-zinc-300">{row.crossmark}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>
    </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(noheader)/customer-signup/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import BackgroundVideo from '@/components/BackgroundVideo';
import LoginScreen from '@/components/LoginScreen'; // Fixed: Correct path to LoginScreen


// MARK: - Constants & Configuration

// MARK: - Component Definition
const API_URL = 'https://api.dltpays.com/nfc/api/v1'; // Fixed: Use NFC API instead of main API


// MARK: - Types & Interfaces
interface CustomerSignupProps {
  storeId?: string;
  storeName?: string;
  referrer?: 'checkout' | 'affiliate' | 'direct';
  redirectUrl?: string;
}

interface Store {
  store_id: string;
  store_name: string;
  logo_url?: string;
  store_url?: string;
}

export default function CustomerSignup({ 
  storeId, 
  storeName, 
  referrer = 'direct',
  redirectUrl 
}: CustomerSignupProps) {
  const [step, setStep] = useState<'welcome' | 'form' | 'wallet' | 'nfc' | 'success'>('welcome');

// MARK: - State Management
  const [formData, setFormData] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    selectedStore: storeId || ''
  });
  const [stores, setStores] = useState<Store[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [walletAddress, setWalletAddress] = useState<string | null>(null);
  const [nfcSupported, setNfcSupported] = useState(false);

  // Check NFC support

// MARK: - Hooks & Effects
  useEffect(() => {
    setNfcSupported('NDEFReader' in window);
  }, []);

  // Load stores for selection
  useEffect(() => {

// MARK: - API Calls & Data Fetching
    const loadStores = async () => {
      try {
        const res = await fetch(`https://api.dltpays.com/api/v1/stores/public`); // Use main API for stores
        const data = await res.json();
        if (data.success) {
          setStores(data.stores || []);
        }
      } catch (err) {
        console.error('Failed to load stores:', err);
      }
    };
    
    if (!storeId) {
      loadStores();
    }
  }, [storeId]);


// MARK: - Event Handlers
  const handleFormSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.firstName || !formData.email || !formData.selectedStore) {
      setError('Please fill in all required fields');
      return;
    }
    
    setError('');
    setStep('wallet');
  };

  const registerCustomer = async (walletAddr: string) => {
    setLoading(true);
    try {
      // For now, just proceed to next step since the API endpoint doesn't exist yet
      // TODO: Implement proper customer registration endpoint
      console.log('Customer signup data:', {
        wallet_address: walletAddr,
        first_name: formData.firstName,
        last_name: formData.lastName,
        email: formData.email,
        phone: formData.phone,
        store_id: formData.selectedStore,
        referrer
      });
      
      // Simulate successful registration
      await new Promise(resolve => setTimeout(resolve, 1000));
      setStep(nfcSupported ? 'nfc' : 'success');
      
    } catch (err: any) {
      console.error('Registration error:', err);
      setError(err.message || 'Registration failed. Please try again.');
    }
    setLoading(false);
  };

  const linkNFCCard = async () => {
    setLoading(true);
    try {
      if ('NDEFReader' in window) {
        const ndef = new (window as any).NDEFReader();
        await ndef.scan();
        
        ndef.addEventListener('reading', async ({ message, serialNumber }: any) => {
          try {
            const res = await fetch(`${API_URL}/nfc/link-card`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                wallet_address: walletAddress,
                card_uid: serialNumber,
                card_name: 'My Payment Card'
              })
            });
            
            const data = await res.json();
            if (data.success) {
              setStep('success');
            } else {
              throw new Error(data.error);
            }
          } catch (err: any) {
            setError(err.message || 'Failed to link card');
          }
        });
        
        ndef.addEventListener('readingerror', () => {
          setError('Error reading NFC card. Try again.');
        });
      } else {
        // Fallback for browsers without NFC
        await new Promise(resolve => setTimeout(resolve, 2000));
        setStep('success');
      }
    } catch (err: any) {
      setError('NFC linking failed. You can skip this step.');
    }
    setLoading(false);
  };

  const getMotivationalMessage = () => {
    switch (referrer) {
      case 'checkout':
        return 'Complete your secure payment setup';
      case 'affiliate':
        return 'Join our affiliate rewards program';
      default:
        return 'Welcome to the future of payments';
    }
  };

  const selectedStoreData = stores.find(s => s.store_id === formData.selectedStore);


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0d0d0d] text-white font-sans relative flex flex-col overflow-x-hidden">
      {/* Background Video */}
      <BackgroundVideo 
        src="/affiliate-hq.webm"
        overlay={true}
      />
      
      <main className="relative z-10 w-full max-w-xl lg:max-w-4xl xl:max-w-5xl mx-auto px-4 sm:px-6 flex-1 flex items-center justify-center py-8">
        <div className="w-full max-w-full">
          
          {/* Welcome Step */}
          {step === 'welcome' && (
            <>
              {/* Title - SVG Badge Style */}
              <div className="flex flex-col items-center mb-4 mt-2 md:mb-6 md:mt-4">
                <svg viewBox="0 0 280 85" className="w-full max-w-72 h-auto">
                  <defs>
                    <linearGradient id="signupGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#10b981" />
                      <stop offset="50%" stopColor="#3b82f6" />
                      <stop offset="100%" stopColor="#8b5cf6" />
                    </linearGradient>
                  </defs>
                  
                  <text x="140" y="28" textAnchor="middle" fill="url(#signupGradient)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="4">
                    WELCOME
                  </text>
                  
                  <text x="140" y="48" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="11" letterSpacing="3">
                    TO YESALLOFUS
                  </text>
                  
                  <line x1="80" y1="60" x2="200" y2="60" stroke="#27272a" strokeWidth="1"/>
                  
                  <text x="140" y="76" textAnchor="middle" fill="#a1a1aa" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="400" fontSize="10" letterSpacing="0.5">
                    {getMotivationalMessage()}
                  </text>
                </svg>
              </div>

              <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 mb-6 max-w-md mx-auto">
                {/* Benefits Preview */}
                <div className="grid grid-cols-3 gap-4 mb-8">
                  <div className="text-center">
                    <div className="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center mx-auto mb-2">
                      <svg className="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H4.5m2.25 0v3m0 0v.75A.75.75 0 016 10.5H4.5m0 0H3v.375C3 11.496 3.504 12 4.125 12h9.75c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H4.125z" />
                      </svg>
                    </div>
                    <p className="text-white font-medium text-sm">Earn Rewards</p>
                    <p className="text-zinc-500 text-xs">Up to 25% commissions</p>
                  </div>
                  
                  <div className="text-center">
                    <div className="w-12 h-12 bg-sky-500/20 rounded-xl flex items-center justify-center mx-auto mb-2">
                      <svg className="w-6 h-6 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M8.288 15.038a5.25 5.25 0 017.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 011.06 0z" />
                      </svg>
                    </div>
                    <p className="text-white font-medium text-sm">NFC Payments</p>
                    <p className="text-zinc-500 text-xs">Tap to pay anywhere</p>
                  </div>
                  
                  <div className="text-center">
                    <div className="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center mx-auto mb-2">
                      <svg className="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.623 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                      </svg>
                    </div>
                    <p className="text-white font-medium text-sm">Secure</p>
                    <p className="text-zinc-500 text-xs">Blockchain protected</p>
                  </div>
                </div>
                
                <button
                  onClick={() => setStep('form')}
                  className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-4 rounded-xl transition"
                >
                  Get Started
                </button>
                
                <p className="text-zinc-500 text-xs mt-4 text-center">
                  Takes less than 2 minutes ‚Ä¢ Free to join
                </p>
              </div>
            </>
          )}

          {/* Form Step */}
          {step === 'form' && (
            <>
              {/* Title */}
              <div className="flex flex-col items-center mb-4 mt-2 md:mb-6 md:mt-4">
                <svg viewBox="0 0 280 85" className="w-full max-w-72 h-auto">
                  <defs>
                    <linearGradient id="formGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#10b981" />
                      <stop offset="50%" stopColor="#3b82f6" />
                      <stop offset="100%" stopColor="#8b5cf6" />
                    </linearGradient>
                  </defs>
                  
                  <text x="140" y="28" textAnchor="middle" fill="url(#formGradient)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="4">
                    SIGN UP
                  </text>
                  
                  <text x="140" y="48" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="11" letterSpacing="3">
                    DETAILS
                  </text>
                  
                  <line x1="80" y1="60" x2="200" y2="60" stroke="#27272a" strokeWidth="1"/>
                  
                  <text x="140" y="76" textAnchor="middle" fill="#a1a1aa" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="400" fontSize="10" letterSpacing="0.5">
                    Tell us about yourself
                  </text>
                </svg>
              </div>

              <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 max-w-md mx-auto">
                <form onSubmit={handleFormSubmit} className="space-y-6">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-zinc-300 mb-2">First Name *</label>
                      <input
                        type="text"
                        value={formData.firstName}
                        onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                        className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 transition-all"
                        placeholder="John"
                        required
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-zinc-300 mb-2">Last Name *</label>
                      <input
                        type="text"
                        value={formData.lastName}
                        onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                        className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 transition-all"
                        placeholder="Doe"
                        required
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-zinc-300 mb-2">Email Address *</label>
                    <input
                      type="email"
                      value={formData.email}
                      onChange={(e) => setFormData({...formData, email: e.target.value})}
                      className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 transition-all"
                      placeholder="john@example.com"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-zinc-300 mb-2">Phone (Optional)</label>
                    <input
                      type="tel"
                      value={formData.phone}
                      onChange={(e) => setFormData({...formData, phone: e.target.value})}
                      className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 transition-all"
                      placeholder="+44 7XXX XXXXXX"
                    />
                  </div>

                  {!storeId && (
                    <div>
                      <label className="block text-sm font-medium text-zinc-300 mb-2">Select Store *</label>
                      <select
                        value={formData.selectedStore}
                        onChange={(e) => setFormData({...formData, selectedStore: e.target.value})}
                        className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400 transition-all"
                        required
                      >
                        <option value="">Choose a store...</option>
                        {stores.map(store => (
                          <option key={store.store_id} value={store.store_id}>
                            {store.store_name}
                          </option>
                        ))}
                      </select>
                    </div>
                  )}

                  {selectedStoreData && (
                    <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4">
                      <div className="flex items-center gap-3">
                        {selectedStoreData.logo_url && (
                          <img src={selectedStoreData.logo_url} alt={selectedStoreData.store_name} className="w-10 h-10 rounded-lg" />
                        )}
                        <div>
                          <p className="text-white font-medium">{selectedStoreData.store_name}</p>
                          <p className="text-emerald-400 text-sm">You'll earn rewards from purchases here</p>
                        </div>
                      </div>
                    </div>
                  )}

                  {error && (
                    <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400 text-sm">
                      {error}
                    </div>
                  )}

                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-emerald-500 hover:bg-emerald-400 disabled:opacity-50 text-black font-semibold py-4 rounded-xl transition"
                  >
                    {loading ? 'Setting up...' : 'Continue'}
                  </button>
                </form>
              </div>
            </>
          )}

          {/* Wallet Step - Use existing LoginScreen */}
          {step === 'wallet' && (
            <LoginScreen
              onLogin={async (wallet: string, method: string) => {
                setWalletAddress(wallet);
                await registerCustomer(wallet);
              }}
              storagePrefix="affiliate"
              title="CONNECT WALLET"
              subtitle="Choose how you'd like to manage rewards"
              showLogo={false}
            />
          )}

          {/* NFC Step */}
          {step === 'nfc' && (
            <>
              {/* Title */}
              <div className="flex flex-col items-center mb-4 mt-2 md:mb-6 md:mt-4">
                <svg viewBox="0 0 280 85" className="w-full max-w-72 h-auto">
                  <defs>
                    <linearGradient id="nfcGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#10b981" />
                      <stop offset="50%" stopColor="#3b82f6" />
                      <stop offset="100%" stopColor="#8b5cf6" />
                    </linearGradient>
                  </defs>
                  
                  <text x="140" y="28" textAnchor="middle" fill="url(#nfcGradient)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="4">
                    NFC CARD
                  </text>
                  
                  <text x="140" y="48" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="11" letterSpacing="3">
                    SETUP
                  </text>
                  
                  <line x1="80" y1="60" x2="200" y2="60" stroke="#27272a" strokeWidth="1"/>
                  
                  <text x="140" y="76" textAnchor="middle" fill="#a1a1aa" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="400" fontSize="10" letterSpacing="0.5">
                    Link your tap-to-pay card
                  </text>
                </svg>
              </div>

              <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 text-center max-w-md mx-auto">
                <div className="w-24 h-24 border-4 border-dashed border-purple-400/50 rounded-2xl flex items-center justify-center mx-auto mb-6">
                  <svg className="w-8 h-8 text-purple-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                  </svg>
                </div>

                <h3 className="text-xl font-bold text-white mb-2">Link Your NFC Card</h3>
                <p className="text-zinc-400 mb-6">Hold your NFC card near your device when ready</p>

                <button
                  onClick={linkNFCCard}
                  disabled={loading}
                  className="w-full bg-purple-500 hover:bg-purple-400 disabled:opacity-50 text-white font-semibold py-4 rounded-xl transition mb-4"
                >
                  {loading ? 'Linking Card...' : 'Link NFC Card'}
                </button>

                <button
                  onClick={() => setStep('success')}
                  className="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-medium py-3 rounded-xl transition"
                >
                  Skip for Now
                </button>

                {error && (
                  <div className="mt-4 bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400 text-sm">
                    {error}
                  </div>
                )}
              </div>
            </>
          )}

          {/* Success Step */}
          {step === 'success' && (
            <>
              {/* Title */}
              <div className="flex flex-col items-center mb-4 mt-2 md:mb-6 md:mt-4">
                <svg viewBox="0 0 280 85" className="w-full max-w-72 h-auto">
                  <defs>
                    <linearGradient id="successGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#10b981" />
                      <stop offset="50%" stopColor="#3b82f6" />
                      <stop offset="100%" stopColor="#8b5cf6" />
                    </linearGradient>
                  </defs>
                  
                  <text x="140" y="28" textAnchor="middle" fill="url(#successGradient)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="4">
                    SUCCESS
                  </text>
                  
                  <text x="140" y="48" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="11" letterSpacing="3">
                    COMPLETE
                  </text>
                  
                  <line x1="80" y1="60" x2="200" y2="60" stroke="#27272a" strokeWidth="1"/>
                  
                  <text x="140" y="76" textAnchor="middle" fill="#a1a1aa" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="400" fontSize="10" letterSpacing="0.5">
                    Welcome aboard!
                  </text>
                </svg>
              </div>

              <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 text-center max-w-md mx-auto">
                <div className="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                  <svg className="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>

                <h3 className="text-2xl font-bold text-emerald-400 mb-2">Welcome Aboard!</h3>
                <p className="text-zinc-400 mb-6">Your YesAllOfUs account is ready to earn rewards</p>

                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 mb-6">
                  <h4 className="text-emerald-300 font-semibold mb-3">What's Next?</h4>
                  <div className="space-y-2 text-sm text-zinc-300">
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-emerald-400 rounded-full"></div>
                      <span>Secure checkout at participating stores</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-emerald-400 rounded-full"></div>
                      <span>Find vendors and exclusive offers</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-emerald-400 rounded-full"></div>
                      <span>Start earning up to 25% commission on referrals</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-emerald-400 rounded-full"></div>
                      <span>Use your NFC card for instant payments</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-2 h-2 bg-emerald-400 rounded-full"></div>
                      <span>Track earnings in your dashboard</span>
                    </div>
                  </div>
                </div>

                <button
                  onClick={() => {
                    if (referrer === 'checkout') {
                      window.location.href = redirectUrl || '/checkout';
                    } else {
                      // Go to affiliate dashboard with store parameter
                      window.location.href = `/affiliate-dashboard${formData.selectedStore ? `?store=${formData.selectedStore}` : ''}`;
                    }
                  }}
                  className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-4 rounded-xl transition"
                >
                  {referrer === 'checkout' ? 'Complete Payment' : 'Go to Dashboard'}
                </button>
              </div>
            </>
          )}

          {/* Progress Indicator */}
          <div className="flex justify-center mt-8 space-x-2">
            {['welcome', 'form', 'wallet', nfcSupported ? 'nfc' : null, 'success'].filter(Boolean).map((stepName, index) => (
              <div
                key={stepName}
                className={`w-3 h-3 rounded-full transition-all duration-300 ${
                  step === stepName 
                    ? 'bg-emerald-400 scale-125' 
                    : ['welcome', 'form', 'wallet', nfcSupported ? 'nfc' : null].filter(Boolean).indexOf(step) > index
                      ? 'bg-emerald-600' 
                      : 'bg-zinc-600'
                }`}
              />
            ))}
          </div>

          {/* Back */}
          <button 
            onClick={() => {
              if (redirectUrl) {
                window.location.href = redirectUrl;
              } else {
                window.history.back();
              }
            }}
            className="flex items-center justify-center gap-2 text-zinc-500 hover:text-zinc-300 text-sm mt-8 transition mx-auto"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span>Back</span>
          </button>
        </div>
      </main>

      {/* YAOFUS Footer */}
      <footer className="relative z-10 py-4 flex flex-col items-center gap-0.5 mt-auto">
        <span className="text-zinc-500 text-[10px] font-medium tracking-wider">SECURE</span>
        <span className="text-base font-extrabold tracking-widest">
          <span className="text-emerald-500">Y</span>
          <span className="text-green-500">A</span>
          <span className="text-blue-500">O</span>
          <span className="text-indigo-500">F</span>
          <span className="text-violet-500">U</span>
          <span className="text-purple-500">S</span>
        </span>
        <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">SIGNUP</span>
        <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
          <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
          <span>Powered by YesAllOfUs</span>
        </div>
      </footer>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(noheader)/display/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, useRef } from 'react';
import { useSearchParams } from 'next/navigation';
import { Suspense } from 'react';
import MoveCloserAnimation from '@/components/MoveCloserAnimation';
import SoundPaySendButton from '@/components/SoundPaySendButton';
import { getIconById } from '@/lib/foodIcons';


// MARK: - Types & Interfaces
interface CartItem {
  name: string;
  quantity: number;
  price: number;
  emoji?: string;
  icon_id?: string;
}

interface DisplayData {
  store_name: string;
  logo_url?: string;
  payment_id?: string; 
  cart: CartItem[];
  subtotal: number;
  total: number;
  status: 'idle' | 'ready' | 'processing' | 'success' | 'error' | 'qr' | 'signup' | 'split_pending' | 'link_pending' | 'soundpay';
  qr_code?: string | null;
  tip?: number;
  tips_enabled?: boolean;
  vendor_wallet?: string | null;
  last_updated: number | null;
  split_payment?: {
    parent_id: string;
    total_splits: number;
    paid_count: number;
    split_ids: string[];
    all_paid?: boolean;
  };
}

// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
function CustomerDisplay() {
  const searchParams = useSearchParams();
  const storeId = searchParams.get('store');
  
  const [data, setData] = useState<DisplayData | null>(null);

// MARK: - State Management
  const [connected, setConnected] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());

  // Update clock

// MARK: - Hooks & Effects
  useEffect(() => {
    const interval = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(interval);
  }, []);

  // Fetch store logo once
const [storeLogo, setStoreLogo] = useState<string | null>(null);
const [selectedTip, setSelectedTip] = useState<number>(0);
const [customTipInput, setCustomTipInput] = useState<string>('');
const [isProcessing, setIsProcessing] = useState(false);
const [showCustomTipModal, setShowCustomTipModal] = useState(false);

// NFC Payment state
const [nfcSupported, setNfcSupported] = useState(false);
const [nfcScanning, setNfcScanning] = useState(false);
const [nfcError, setNfcError] = useState<string | null>(null);
const [paymentProcessing, setPaymentProcessing] = useState(false);

// Signup form state
const [signupCardUid, setSignupCardUid] = useState<string | null>(null);
const [signupCardName, setSignupCardName] = useState('');
const [signupName, setSignupName] = useState('');
const [signupEmail, setSignupEmail] = useState('');
const [signupPhone, setSignupPhone] = useState('');
const [signupScanning, setSignupScanning] = useState(false);
const [signupSubmitting, setSignupSubmitting] = useState(false);
const [signupError, setSignupError] = useState<string | null>(null);
const [signupSuccess, setSignupSuccess] = useState(false);

// Live conversion state
const [liveRate, setLiveRate] = useState<number | null>(null);
const [rlusdAmount, setRlusdAmount] = useState<number | null>(null);

// NFC Payment refs
const nfcScanActiveRef = useRef(false);
const paymentInProgressRef = useRef(false);
const lastReadTimeRef = useRef(0);

// Sync selectedTip with data from API
useEffect(() => {
  if (data?.tip !== undefined) {
    setSelectedTip(data.tip);
  }
}, [data?.tip]);

// Send tip to API and confirm payment
const addTip = async (tipAmount: number) => {
  setSelectedTip(tipAmount);

  // L5: Await tip update and handle errors
  try {
    const res = await fetch(`${API_URL}/display/${storeId}/tip`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tip: tipAmount })
    });
    if (!res.ok) {
      console.error('Failed to add tip:', res.status);
    }
  } catch (err) {
    console.error('Failed to add tip:', err);
  }
};

const startNFCPayment = async () => {
  // TEMP DEBUG - remove later
  
  // Guard against duplicate scans
  if (nfcScanActiveRef.current) {
    setNfcError('NFC scan already active, skipping');
    return;
  }

  if (!('NDEFReader' in window)) {
    setNfcError('NFC not supported on this device');
    return;
  }

  nfcScanActiveRef.current = true;
  setNfcScanning(true);
  setNfcError(null);

  try {
    const ndef = new (window as any).NDEFReader();
    await ndef.scan();

    ndef.addEventListener('reading', async (event: any) => {
      // Debounce: ignore reads within 5 seconds
      const now = Date.now();
      if (now - lastReadTimeRef.current < 5000) {
        console.log('NFC read debounced');
        return;
      }
      lastReadTimeRef.current = now;

      // Prevent duplicate payment processing
      if (paymentInProgressRef.current) {
        console.log('Payment already in progress, skipping');
        return;
      }
      paymentInProgressRef.current = true;

      const uid = event.serialNumber?.replace(/:/g, '').toUpperCase();
      if (!uid) {
        setNfcError('Could not read card');
        setNfcScanning(false);
        nfcScanActiveRef.current = false;
        paymentInProgressRef.current = false;
        return;
      }

      setNfcScanning(false);
      setPaymentProcessing(true);

      try {
        // Fetch FRESH data to avoid stale closures
        const displayRes = await fetch(`${API_URL}/display/${storeId}`);
        const freshData = await displayRes.json();

        const vendorWallet = freshData.vendor_wallet;
        const totalAmount = freshData.total;
        const cartItems = freshData.cart;

        if (!vendorWallet) {
          setNfcError('Vendor wallet not available');
          setPaymentProcessing(false);
          nfcScanActiveRef.current = false;
          paymentInProgressRef.current = false;
          return;
        }

        const res = await fetch(`${API_URL}/nfc/payment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: uid,
            vendor_wallet: vendorWallet,
            store_id: storeId,
            amount: totalAmount,
            gbp_amount: totalAmount,
            items: cartItems,
            payment_id: `pay_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`
          })
        });

        const result = await res.json();

        if (result.success) {
          if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
          // Update display to success status
          await fetch(`${API_URL}/display/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              store_id: storeId,
              store_name: freshData.store_name,
              cart: [],
              total: 0,
              status: 'success',
              tip: 0,
              vendor_wallet: vendorWallet
            })
          });
        } else {
          if (result.error === 'NO_SIGNER_AUTHORITY') {
  setNfcError('Customer wallet not set up for tap-to-pay.');
} else {
  setNfcError(result.error || 'Payment failed');
}
        }
      } catch (err) {
        setNfcError('Payment failed');
      } finally {
        setPaymentProcessing(false);
        nfcScanActiveRef.current = false;
        paymentInProgressRef.current = false;
      }
    });

    ndef.addEventListener('readingerror', () => {
      setNfcError('Error reading card');
      setNfcScanning(false);
      nfcScanActiveRef.current = false;
    });

  } catch (err: any) {
    if (err.name === 'NotAllowedError') {
      setNfcError('NFC permission denied');
    } else {
      setNfcError('Failed to start NFC');
    }
    setNfcScanning(false);
    nfcScanActiveRef.current = false;
    }
};

// Auto-start NFC scan when QR code is displayed
useEffect(() => {
  if (data?.status === 'qr' && nfcSupported && !nfcScanActiveRef.current && !paymentProcessing) {
    startNFCPayment();
  }
}, [data?.status, nfcSupported, paymentProcessing]);

// NFC Scan for signup
const startSignupNFCScan = async () => {
  setSignupError(null);

  if (!('NDEFReader' in window)) {
    setSignupError('NFC is not supported on this device. Please use Chrome on Android.');
    return;
  }

  setSignupScanning(true);

  try {
    const ndef = new (window as any).NDEFReader();
    await ndef.scan();

    let lastReadTime = 0;
    ndef.addEventListener('reading', async ({ serialNumber }: { serialNumber: string }) => {
      // Debounce: ignore reads within 5 seconds
      const now = Date.now();
      if (now - lastReadTime < 5000) {
        console.log('NFC read debounced');
        return;
      }
      lastReadTime = now;

      const uid = serialNumber?.replace(/:/g, '').toUpperCase();
      setSignupCardUid(uid);
      setSignupScanning(false);
    });

    ndef.addEventListener('readingerror', () => {
      setSignupError('Error reading card. Please try again.');
      setSignupScanning(false);
    });

  } catch (err: any) {
    if (err.name === 'NotAllowedError') {
      setSignupError('NFC permission denied. Please allow NFC access.');
    } else if (err.name === 'NotSupportedError') {
      setSignupError('NFC is not supported on this device.');
    } else {
      setSignupError('Failed to start NFC scan. Make sure NFC is enabled.');
    }
    setSignupScanning(false);
  }
};

// Submit signup

// MARK: - Event Handlers
const handleSignupSubmit = async () => {
  if (!signupCardUid) {
    setSignupError('Please tap an NFC card first');
    return;
  }

  if (!signupEmail) {
    setSignupError('Email is required');
    return;
  }

  setSignupSubmitting(true);
  setSignupError(null);

  try {
    const res = await fetch(`${API_URL}/nfc/register-customer`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        card_uid: signupCardUid,
        card_name: signupCardName.trim() || null,
        store_id: storeId,
        name: signupName.trim() || null,
        email: signupEmail.trim().toLowerCase(),
        phone: signupPhone.trim() || null
      })
    });

    const result = await res.json();

    if (result.success) {
      setSignupSuccess(true);
    } else {
      setSignupError(result.error || 'Registration failed');
    }
  } catch (err) {
    setSignupError('Failed to register. Please try again.');
  }

  setSignupSubmitting(false);
};

// Reset signup form
const resetSignupForm = () => {
  setSignupCardUid(null);
  setSignupCardName('');
  setSignupName('');
  setSignupEmail('');
  setSignupPhone('');
  setSignupError(null);
  setSignupSuccess(false);
  setSignupScanning(false);
  setSignupSubmitting(false);
};

useEffect(() => {
  if (!storeId) return;
  
  // Fetch store data for logo (once)
  fetch(`${API_URL}/store/public/${storeId}`)
    .then(res => res.json())
    .then(data => {
      if (data.success && data.store) {
        setStoreLogo(data.store.logo_url || null);
      }
    })
    .catch(() => {});
}, [storeId]);

// Poll API for display data
useEffect(() => {
  if (!storeId) return;
  if (nfcScanning || paymentProcessing) return; // Stop polling during NFC


// MARK: - API Calls & Data Fetching
  const fetchDisplay = async () => {
    try {
      const res = await fetch(`${API_URL}/display/${storeId}`);
      if (!res.ok) throw new Error('Failed');
      const val = await res.json();
      console.log('Display data:', val.status, val.cart); 
      setData(val);
      setConnected(true);
      if (val.status === 'qr') {
        setIsProcessing(false);
      }
    } catch (error) {
      setConnected(false);
    }
  };

  fetchDisplay();
  const interval = setInterval(fetchDisplay, 500);
  return () => clearInterval(interval);
}, [storeId, nfcScanning, paymentProcessing]);

// Fetch live conversion rate
useEffect(() => {
  if (!data) return;
  
  const total = data.total;
  const status = data.status;
  
  const fetchRate = async () => {
    if (total <= 0) return;
    
    try {
      const res = await fetch(`https://api.dltpays.com/convert/gbp-to-rlusd?amount=${total}`);
      const result = await res.json();
      if (result.success) {
        setLiveRate(result.rate.gbp_to_rlusd);
        setRlusdAmount(result.rlusd);
      }
    } catch (err) {
      console.error('Rate fetch error:', err);
    }
  };

  if (status === 'qr' || status === 'ready' || status === 'idle') {
    fetchRate();
    const interval = setInterval(fetchRate, 10000);
    return () => clearInterval(interval);
  }
}, [data]);

// Check NFC support
useEffect(() => {
  if ('NDEFReader' in window) {
    setNfcSupported(true);
  }
}, []);

// Reset payment refs when status changes to idle or success
// Reset payment refs when payment succeeds
useEffect(() => {
  if (data?.status === 'success') {
    paymentInProgressRef.current = false;
    nfcScanActiveRef.current = false;
  }
}, [data?.status]);

  // No store ID
  if (!storeId) {

// MARK: - Main Render
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center p-4 sm:p-8">
        <div className="text-center">
          <div className="text-6xl sm:text-8xl mb-6 sm:mb-8">üì∫</div>
          <h1 className="text-2xl sm:text-4xl font-bold mb-4">Customer Display</h1>
          <p className="text-zinc-400 text-base sm:text-xl mb-6 sm:mb-8">Add ?store=YOUR_STORE_ID to the URL</p>
          <div className="bg-zinc-900 rounded-2xl p-4 sm:p-6 inline-block">
            <code className="text-emerald-400 text-sm sm:text-lg break-all">yesallofus.com/display?store=store_xxx</code>
          </div>
        </div>
      </div>
    );
  }

  // Waiting for connection
  if (!data) {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center p-4">
        <div className="text-center">
          <div className="w-12 h-12 sm:w-16 sm:h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-6 sm:mb-8"></div>
          <p className="text-xl sm:text-2xl text-zinc-400">Connecting to POS...</p>
          <p className="text-zinc-600 mt-4 font-mono text-sm">{storeId}</p>
        </div>
      </div>
    );
  }

  const { store_name, cart, total, status } = data;

  return (
    <div className="min-h-screen w-full bg-black text-white flex flex-col overflow-hidden">
      
      {/* Ambient gradient */}
      <div className="fixed inset-0 pointer-events-none overflow-hidden">
        <div className={`absolute top-0 left-1/4 w-64 sm:w-96 h-64 sm:h-96 rounded-full blur-[100px] sm:blur-[150px] transition-colors duration-1000 ${
          status === 'success' ? 'bg-emerald-500/30' : 
          status === 'processing' ? 'bg-amber-500/20' : 
          status === 'error' ? 'bg-red-500/20' : 
          'bg-emerald-500/10'
        }`} />
        <div className="absolute bottom-0 right-1/4 w-64 sm:w-96 h-64 sm:h-96 bg-sky-500/10 rounded-full blur-[100px] sm:blur-[150px]" />
      </div>

      {/* Header */}
      <header className="relative z-10 px-6 py-4 sm:px-8 sm:py-6 flex items-center justify-between border-b border-zinc-800/50">
  <div className="flex items-center gap-3 sm:gap-4">
    {storeLogo ? (
      <img 
        src={storeLogo} 
        alt={store_name} 
        className="w-12 h-12 sm:w-14 sm:h-14 rounded-xl object-cover"
      />
    ) : (
      <img 
        src="https://yesallofus.com/dltpayslogo1.png" 
        alt="YesAllOfUs" 
        className="w-12 h-12 sm:w-14 sm:h-14 rounded-xl"
      />
    )}
    <div>
      <h1 className="text-xl sm:text-2xl font-bold truncate max-w-[200px] sm:max-w-none">{storeLogo ? store_name : 'YesAllOfUs'}</h1>
            <div className="flex items-center gap-2 text-zinc-500 text-sm">
              <span className={`w-2 h-2 rounded-full ${connected ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`} />
              {connected ? 'Live' : 'Disconnected'}
            </div>
          </div>
        </div>
        <div className="text-right">
          <p className="text-3xl sm:text-5xl font-light tabular-nums">
            {currentTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}
          </p>
          <p className="text-zinc-500 text-sm sm:text-base">
            {currentTime.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' })}
          </p>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 relative z-10 flex flex-col px-6 py-4 sm:px-8 sm:py-6 overflow-y-auto overflow-x-hidden -mt-5">

        {/* Split Payment Tracking */}
{status === 'split_pending' && data?.split_payment && (
  <div className="flex-1 flex flex-col items-center justify-center">
    <div className="text-center mb-8">
      <p className="text-zinc-500 text-xl sm:text-2xl mb-2">Split Bill</p>
      <p className="text-6xl sm:text-8xl font-bold text-emerald-400">
        {data.split_payment.paid_count}/{data.split_payment.total_splits}
      </p>
      <p className="text-zinc-400 text-xl mt-4">payments received</p>
    </div>
    
    {/* Progress bar */}
    <div className="w-full max-w-md bg-zinc-800 rounded-full h-4 mb-8">
      <div 
        className="bg-emerald-500 h-4 rounded-full transition-all duration-500"
        style={{ width: `${(data.split_payment.paid_count / data.split_payment.total_splits) * 100}%` }}
      />
    </div>
    
    <p className="text-zinc-500">
      ¬£{total.toFixed(2)} total
    </p>
  </div>
)}
        
        {/* Success State */}
        {status === 'success' && (
          <div className="flex-1 flex flex-col items-center justify-center">
            <div className="w-32 h-32 sm:w-48 sm:h-48 bg-emerald-500/20 rounded-full flex items-center justify-center mb-8 sm:mb-10">
              <svg className="w-20 h-20 sm:w-28 sm:h-28 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <p className="text-4xl sm:text-7xl font-bold text-emerald-400 mb-3 sm:mb-4 text-center">Payment Complete</p>
            <p className="text-2xl sm:text-4xl text-zinc-400">Thank you!</p>
          </div>
        )}

        {/* Processing State */}
        {status === 'processing' && (
          <div className="flex-1 flex flex-col items-center justify-center">
            <div className="w-24 h-24 sm:w-40 sm:h-40 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-8 sm:mb-10"></div>
            <p className="text-3xl sm:text-6xl font-bold text-amber-400 mb-3 sm:mb-4">Processing...</p>
            <p className="text-6xl sm:text-9xl font-bold mt-4 sm:mt-6">¬£{total.toFixed(2)}</p>
          </div>
        )}

        {/* Error State */}
        {status === 'error' && (
          <div className="flex-1 flex flex-col items-center justify-center">
            <div className="w-32 h-32 sm:w-48 sm:h-48 bg-red-500/20 rounded-full flex items-center justify-center mb-8 sm:mb-10">
              <svg className="w-20 h-20 sm:w-28 sm:h-28 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <p className="text-3xl sm:text-6xl font-bold text-red-400 text-center">Payment Failed</p>
            <p className="text-xl sm:text-3xl text-zinc-500 mt-3 sm:mt-4">Please try again</p>
          </div>
        )}

        {/* Idle State - Show Cart */}
{status === 'idle' && (
  <>
    {cart && cart.length > 0 ? (
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Items */}
        <div className="flex-shrink-0 overflow-y-auto max-h-[35vh] mb-6">
          <div className="space-y-3 sm:space-y-4">
            {cart.map((item, index) => (
              <div 
                key={index}
                className="flex items-center justify-between py-4 px-5 sm:py-5 sm:px-6 bg-zinc-900/50 rounded-2xl border border-zinc-800/50"
              >
                <div className="flex items-center gap-4 sm:gap-5">
                  <span className="text-3xl sm:text-5xl w-12 h-12 sm:w-16 sm:h-16 flex items-center justify-center">
  {item.icon_id && getIconById(item.icon_id) ? (
    <span className="w-full h-full" dangerouslySetInnerHTML={{ __html: getIconById(item.icon_id)!.svg }} />
  ) : (item.emoji || 'üì¶')}
</span>
                  <div>
                    <p className="text-xl sm:text-3xl font-semibold">{item.name}</p>
                    {item.quantity > 1 && (
                      <p className="text-zinc-500 text-lg sm:text-xl">
                        {item.quantity} √ó ¬£{item.price.toFixed(2)}
                      </p>
                    )}
                  </div>
                </div>
                <p className="text-2xl sm:text-4xl font-bold">
                  ¬£{(item.price * item.quantity).toFixed(2)}
                </p>
              </div>
            ))}
          </div>
        </div>

        {/* Tip Section - Customer adds tip */}
        {data?.tips_enabled && (
        <div className="border-t border-zinc-800 pt-6 sm:pt-8 mb-6 sm:mb-8">
          <p className="text-zinc-400 text-center text-lg sm:text-2xl mb-4 sm:mb-6">Add a tip?</p>
          
          <div className="flex justify-center gap-3 sm:gap-4 flex-wrap">
            {[0, 10, 15, 20].map((percent) => {
              const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
              const tipValue = percent === 0 ? 0 : subtotal * percent / 100;
              const label = percent === 0 ? 'No Tip' : `${percent}% ¬∑ ¬£${tipValue.toFixed(2)}`;
              
              return (
                <div
                  key={percent}
                  onClick={() => addTip(tipValue)}
                  className={`px-5 sm:px-8 py-4 sm:py-5 rounded-2xl text-lg sm:text-2xl font-semibold cursor-pointer select-none active:scale-95 transition ${
                    selectedTip === tipValue
                      ? 'bg-emerald-500 text-black'
                      : 'bg-zinc-800 text-white active:bg-zinc-700'
                  }`}
                >
                  {label}
                </div>
              );
            })}
            <div
              onClick={() => setShowCustomTipModal(true)}
              className="px-5 sm:px-8 py-4 sm:py-5 rounded-2xl text-lg sm:text-2xl font-semibold cursor-pointer select-none bg-zinc-800 text-white active:bg-zinc-700 active:scale-95 transition"
            >
              Custom
            </div>
          </div>
          
          {/* Show tip if added */}
          {selectedTip > 0 && (
            <div className="mt-5 text-center">
              <p className="text-emerald-400 text-2xl sm:text-3xl font-semibold">
                Tip: ¬£{selectedTip.toFixed(2)}
              </p>
            </div>
          )}
          
          {/* Confirm Payment Button */}
          <button
  onClick={() => {
    setIsProcessing(true);
    fetch(`${API_URL}/display/${storeId}/confirm`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    }).catch(err => console.error('Failed to confirm:', err));
  }}
  disabled={isProcessing}
  className="w-full mt-6 bg-emerald-500 hover:bg-emerald-400 disabled:bg-emerald-500/50 text-black font-bold text-xl sm:text-2xl py-5 sm:py-6 rounded-2xl transition active:scale-95 cursor-pointer flex items-center justify-center gap-3"
>
  {isProcessing ? (
    <>
      <div className="w-7 h-7 border-3 border-black border-t-transparent rounded-full animate-spin"></div>
      Processing...
    </>
  ) : (
    <>Pay ¬£{total.toFixed(2)}</>
  )}
</button>
        </div>
        )}
        
        {/* Total */}
<div className="border-t border-zinc-800 pt-6 sm:pt-8 flex-shrink-0">
  <div className="flex items-end justify-between">
    <div>
      <p className="text-zinc-500 text-xl sm:text-2xl mb-1">Total</p>
      <p className="text-zinc-600 text-base sm:text-lg">
        {cart.reduce((sum, item) => sum + item.quantity, 0)} items
        {selectedTip > 0 && ` + tip`}
      </p>
    </div>
    <p className="text-5xl sm:text-8xl font-bold tracking-tight text-emerald-400">
      ¬£{total.toFixed(2)}
    </p>
          </div>
        </div>
      </div>
    ) : (
      /* Empty State */
      <div className="flex-1 flex flex-col items-center justify-center">
        <div className="text-zinc-800 mb-8 sm:mb-10">
          <svg className="w-32 h-32 sm:w-56 sm:h-56" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={0.5} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
        <p className="text-2xl sm:text-5xl text-zinc-700 font-light text-center">Ready for your order</p>
      </div>
    )}
  </>
)}

{/* Payment Link Pending - Waiting for remote payment */}
{status === 'link_pending' && (
  <div className="flex-1 flex flex-col items-center justify-center">
    {/* YAOFUS Badge */}
    <div className="mb-8">
      <svg viewBox="0 0 140 52" className="w-48 h-20">
        <text x="70" y="14" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="500" fontSize="10" letterSpacing="1">
          PARTNER
        </text>
        <text x="70" y="32" textAnchor="middle" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="16" letterSpacing="3">
          <tspan fill="#10b981">Y</tspan>
          <tspan fill="#22c55e">A</tspan>
          <tspan fill="#3b82f6">O</tspan>
          <tspan fill="#6366f1">F</tspan>
          <tspan fill="#8b5cf6">U</tspan>
          <tspan fill="#a855f7">S</tspan>
        </text>
        <text x="70" y="47" textAnchor="middle" fill="#52525b" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="10" letterSpacing="1.5">
          DISPLAY
        </text>
      </svg>
    </div>

    {/* Amount */}
    <p className="text-7xl sm:text-[10rem] font-bold text-emerald-400 mb-4">¬£{total.toFixed(2)}</p>
    
    {/* Waiting indicator */}
    <div className="flex items-center gap-3 mb-4">
      <div className="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
      <p className="text-zinc-400 text-2xl sm:text-3xl">Waiting for payment...</p>
    </div>
    
    {/* Store name */}
    <p className="text-zinc-600 text-lg">{data?.store_name}</p>
  </div>
)}

{/* Ready State - Payment Instructions */}
{status === 'ready' && (
  <div className="flex-1 flex flex-col">
    {/* Total at top */}
    <div className="text-center mb-8 sm:mb-12">
      <p className="text-zinc-500 text-xl sm:text-3xl mb-2">Total to pay</p>
      <p className="text-5xl sm:text-7xl font-bold text-emerald-400">¬£{(total ?? 0).toFixed(2)}</p>
    </div>

    {/* Payment Options */}
    <div className="flex-1 flex flex-col sm:flex-row items-center justify-center gap-8 sm:gap-16">
      
      {/* NFC Tap Zone */}
      <button 
        onClick={startNFCPayment}
        disabled={nfcScanning || paymentProcessing}
        className="flex flex-col items-center cursor-pointer"
      >
        <div className="w-40 h-40 sm:w-56 sm:h-56 bg-emerald-500/20 rounded-full flex items-center justify-center relative mb-5 sm:mb-8">
          <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping pointer-events-none" style={{ animationDuration: '2s' }}></div>
          <div className="absolute inset-4 bg-emerald-500/10 rounded-full animate-pulse"></div>
          <svg className="w-20 h-20 sm:w-28 sm:h-28 text-emerald-400 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
          </svg>
        </div>
        <p className={`text-2xl sm:text-3xl font-bold mb-2 ${nfcScanning ? 'text-amber-400' : 'text-emerald-400'}`}>
          {paymentProcessing ? 'Processing...' : nfcScanning ? 'Tap Now...' : 'Tap Card'}
        </p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">
          {nfcScanning ? 'Hold your card to this device' : 'Tap here, then hold your NFC card'}
        </p>
        {nfcError && (
          <p className="text-red-400 text-sm mt-2">{nfcError}</p>
        )}
      </button>

      {/* Divider */}
      <div className="flex items-center gap-4">
        <div className="w-20 sm:w-28 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-40 bg-zinc-800"></div>
        <span className="text-zinc-600 text-xl sm:text-2xl font-medium">or</span>
        <div className="w-20 sm:w-28 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-40 bg-zinc-800"></div>
      </div>

      {/* QR/Wallet Scan */}
      <div className="flex flex-col items-center">
        <div className="w-40 h-40 sm:w-56 sm:h-56 bg-sky-500/20 rounded-3xl flex items-center justify-center relative mb-5 sm:mb-8">
          <div className="absolute inset-0 bg-sky-500/10 rounded-3xl animate-pulse"></div>
          <svg className="w-20 h-20 sm:w-28 sm:h-28 text-sky-400 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
          </svg>
        </div>
        <p className="text-2xl sm:text-4xl font-bold text-sky-400 mb-2">Scan QR</p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Open Xaman wallet<br/>and scan code</p>
      </div>

    </div>

    {/* Items summary (collapsed) */}
    {cart && cart.length > 0 && (
      <div className="mt-8 sm:mt-10 pt-4 border-t border-zinc-800">
        <p className="text-zinc-600 text-center text-base sm:text-lg">
          {cart.reduce((sum, item) => sum + item.quantity, 0)} items: {cart.map(item => item.name).join(', ')}
        </p>
      </div>
    )}
  </div>
)}
{/* QR Code State - Show both QR and Tap options */}
{status === 'qr' && (
  <div className="flex-1 flex flex-col">
    {/* Total at top */}
    <div className="text-center mb-8 sm:mb-12">
      <p className="text-zinc-500 text-xl sm:text-3xl mb-2">Total to pay</p>
      <p className="text-5xl sm:text-7xl font-bold text-emerald-400">¬£{(total ?? 0).toFixed(2)}</p>
    </div>

    {/* Payment Options */}
    <div className="flex-1 flex flex-col sm:flex-row items-center justify-center gap-8 sm:gap-16">
      
      {/* NFC Tap Zone */}
      <button 
        onClick={startNFCPayment}
        disabled={nfcScanning || paymentProcessing}
        className="flex flex-col items-center cursor-pointer"
      >
        <div className={`w-40 h-40 sm:w-48 sm:h-48 rounded-full flex items-center justify-center relative mb-5 ${
          nfcScanning ? 'bg-amber-500/30' : paymentProcessing ? 'bg-emerald-500/40' : 'bg-emerald-500/20'
        }`}>
          {!nfcScanning && !paymentProcessing && (
            <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping pointer-events-none" style={{ animationDuration: '2s' }}></div>
          )}
          {nfcScanning && (
            <div className="absolute inset-0 bg-amber-500/30 rounded-full animate-pulse"></div>
          )}
          <div className="absolute inset-4 bg-emerald-500/10 rounded-full animate-pulse"></div>
          {paymentProcessing ? (
            <div className="w-16 h-16 sm:w-20 sm:h-20 border-4 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
          ) : (
            <svg className={`w-20 h-20 sm:w-28 sm:h-28 relative z-10 ${nfcScanning ? 'text-amber-400' : 'text-emerald-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
          )}
        </div>
        <p className={`text-2xl sm:text-3xl font-bold mb-2 ${nfcScanning ? 'text-amber-400' : 'text-emerald-400'}`}>
          {paymentProcessing ? 'Processing...' : nfcScanning ? 'Tap Now...' : 'Tap Card'}
        </p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">
          {nfcScanning ? 'Hold your card to this device' : 'Tap here, then hold your NFC card'}
        </p>
        {nfcError && (
          <p className="text-red-400 text-sm mt-2">{nfcError}</p>
        )}
      </button>

      {/* Divider */}
      <div className="flex items-center gap-4">
        <div className="w-20 sm:w-28 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-40 bg-zinc-800"></div>
        <span className="text-zinc-600 text-xl sm:text-2xl font-medium">or</span>
        <div className="w-20 sm:w-28 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-40 bg-zinc-800"></div>
      </div>

      {/* QR Code */}
      <div className="flex flex-col items-center">
        {data?.qr_code ? (
          <div className="bg-white rounded-3xl p-5 sm:p-8 mb-5 sm:mb-8">
            <img 
              src={data.qr_code} 
              alt="Scan to pay" 
              className="w-40 h-40 sm:w-56 sm:h-56"
            />
          </div>
        ) : (
          <div className="w-40 h-40 sm:w-56 sm:h-56 bg-zinc-800 rounded-3xl animate-pulse mb-5 sm:mb-8"></div>
        )}
        <p className="text-2xl sm:text-4xl font-bold text-sky-400 mb-2">Scan QR</p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Open Xaman wallet<br/>and scan code</p>
      </div>

    </div>

    {/* Items summary */}
    {cart && cart.length > 0 && (
      <div className="mt-8 sm:mt-10 pt-4 border-t border-zinc-800">
        <p className="text-zinc-600 text-center text-base sm:text-lg">
          {cart.reduce((sum, item) => sum + item.quantity, 0)} items: {cart.map(item => item.name).join(', ')}
        </p>
      </div>
    )}
  </div>
)}
{/* SoundPay State - Show animation and Tap options */}
{status === 'soundpay' && (
  <div className="flex-1 flex flex-col">
    {/* Total at top */}
    <div className="text-center mb-8 sm:mb-12">
      <p className="text-zinc-500 text-xl sm:text-3xl mb-2">Total to pay</p>
      <p className="text-5xl sm:text-7xl font-bold text-emerald-400">¬£{(total ?? 0).toFixed(2)}</p>
    </div>

    {/* Payment Options */}
    <div className="flex-1 flex flex-col sm:flex-row items-center justify-center gap-8 sm:gap-16">
      
      {/* SoundPay Send Button - Left Side */}
<SoundPaySendButton
  paymentId={data?.payment_id || ''}
  storeId={storeId || ''}
  onSuccess={(txHash, receiptId) => {
    fetch(`${API_URL}/display/update`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: storeId,
        store_name: data?.store_name,
        cart: [],
        total: 0,
        status: 'success',
        tip: 0,
        vendor_wallet: data?.vendor_wallet,
      }),
    });
  }}
  onError={(error) => console.error('SoundPay error:', error)}
/>

      {/* Divider */}
      <div className="flex items-center gap-4">
        <div className="w-20 sm:w-28 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-40 bg-zinc-800"></div>
        <span className="text-zinc-600 text-xl sm:text-2xl font-medium">or</span>
        <div className="w-20 sm:w-28 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-40 bg-zinc-800"></div>
      </div>

      {/* NFC Tap Zone - Right Side */}
      <button 
        onClick={startNFCPayment}
        disabled={nfcScanning || paymentProcessing}
        className="flex flex-col items-center cursor-pointer"
      >
        <div className={`w-40 h-40 sm:w-48 sm:h-48 rounded-full flex items-center justify-center relative mb-5 ${
          nfcScanning ? 'bg-amber-500/30' : paymentProcessing ? 'bg-emerald-500/40' : 'bg-emerald-500/20'
        }`}>
          {!nfcScanning && !paymentProcessing && (
            <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping pointer-events-none" style={{ animationDuration: '2s' }}></div>
          )}
          {nfcScanning && (
            <div className="absolute inset-0 bg-amber-500/30 rounded-full animate-pulse"></div>
          )}
          <div className="absolute inset-4 bg-emerald-500/10 rounded-full animate-pulse"></div>
          {paymentProcessing ? (
            <div className="w-16 h-16 sm:w-20 sm:h-20 border-4 border-emerald-400 border-t-transparent rounded-full animate-spin"></div>
          ) : (
            <svg className={`w-20 h-20 sm:w-28 sm:h-28 relative z-10 ${nfcScanning ? 'text-amber-400' : 'text-emerald-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
          )}
        </div>
        <p className={`text-2xl sm:text-3xl font-bold mb-2 ${nfcScanning ? 'text-amber-400' : 'text-emerald-400'}`}>
          {paymentProcessing ? 'Processing...' : nfcScanning ? 'Tap Now...' : 'Tap Card'}
        </p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">
          {nfcScanning ? 'Hold your card to this device' : 'Tap here, then hold your NFC card'}
        </p>
        {nfcError && (
          <p className="text-red-400 text-sm mt-2">{nfcError}</p>
        )}
      </button>

    </div>

    {/* Items summary */}
    {cart && cart.length > 0 && (
      <div className="mt-8 sm:mt-10 pt-4 border-t border-zinc-800">
        <p className="text-zinc-600 text-center text-base sm:text-lg">
          {cart.reduce((sum, item) => sum + item.quantity, 0)} items: {cart.map(item => item.name).join(', ')}
        </p>
      </div>
    )}
  </div>
)}
{/* Custom Tip Modal */}
{showCustomTipModal && (
  <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
    <div className="bg-zinc-900 rounded-2xl p-6 sm:p-8 w-full max-w-md">
      <h3 className="text-xl sm:text-2xl font-bold mb-5">Custom Tip</h3>
      <div className="relative mb-5">
        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-400 text-xl sm:text-2xl">¬£</span>
        <input
          type="number"
          inputMode="decimal"
          step="0.01"
          min="0"
          placeholder="0.00"
          value={customTipInput}
          onChange={(e) => setCustomTipInput(e.target.value)}
          className="w-full bg-zinc-800 border border-zinc-700 rounded-xl pl-10 pr-4 py-4 text-xl sm:text-2xl text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500"
          autoFocus
        />
      </div>
      <div className="flex gap-3">
        <button
          onClick={() => {
            setShowCustomTipModal(false);
            setCustomTipInput('');
          }}
          className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-4 rounded-xl text-lg sm:text-xl transition active:scale-95 cursor-pointer"
        >
          Cancel
        </button>
        <button
          onClick={() => {
            const tip = parseFloat(customTipInput) || 0;
            addTip(tip);
            setShowCustomTipModal(false);
            setCustomTipInput('');
          }}
          className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-4 rounded-xl text-lg sm:text-xl transition active:scale-95 cursor-pointer"
        >
          Add Tip
        </button>
      </div>
    </div>
  </div>
)}

{/* Signup Customer State */}
{status === 'signup' && (
  <div className="flex-1 flex flex-col items-center justify-center p-4">
    <div className="max-w-xl w-full text-center">
      
      {/* Sparkle Icon */}
      <div className="inline-flex items-center justify-center w-28 h-28 sm:w-36 sm:h-36 mb-8 relative">
        <div className="absolute inset-0 bg-gradient-to-br from-emerald-500/20 to-sky-500/20 rounded-full blur-xl"></div>
        <div className="relative bg-gradient-to-br from-emerald-500/10 to-sky-500/10 rounded-full p-6 sm:p-8 border border-emerald-500/20">
          <svg className="w-14 h-14 sm:w-18 sm:h-18 text-emerald-400" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 3v1m0 16v1m-9-9h1m16 0h1m-2.636-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8l1.5 3.5L17 13l-3.5 1.5L12 18l-1.5-3.5L7 13l3.5-1.5L12 8z" />
          </svg>
        </div>
      </div>

      {/* Welcome Text */}
      <h1 className="text-4xl sm:text-5xl font-bold mb-4 text-white">
        Welcome to {store_name}
      </h1>
      <p className="text-zinc-400 text-lg sm:text-xl mb-12 max-w-md mx-auto">
        Join our rewards program and start earning on every purchase
      </p>

      {/* Card Tap Section */}
      <div className="bg-zinc-900/60 border border-zinc-800 rounded-3xl p-8 sm:p-10 backdrop-blur">
        <div className="flex flex-col items-center gap-6">
          
          {/* NFC Animation */}
          <div className="relative w-24 h-24 sm:w-28 sm:h-28">
            <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping pointer-events-none" style={{ animationDuration: '2s' }}></div>
            <div className="absolute inset-3 bg-emerald-500/15 rounded-full animate-ping" style={{ animationDuration: '2s', animationDelay: '0.4s' }}></div>
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="w-20 h-20 sm:w-24 sm:h-24 bg-emerald-500/10 rounded-full flex items-center justify-center border border-emerald-500/30">
                <svg className="w-10 h-10 sm:w-12 sm:h-12 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
              </div>
            </div>
          </div>

          {/* Instructions */}
          <div>
            <p className="text-2xl sm:text-3xl font-semibold text-white mb-2">
              Tap Your Card
            </p>
            <p className="text-zinc-500 text-base sm:text-lg">
              Staff will complete your registration
            </p>
          </div>
        </div>
      </div>

      {/* Trust badges */}
      <div className="flex items-center justify-center gap-8 mt-10 text-zinc-600">
        <div className="flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          <span className="text-sm">Secure</span>
        </div>
        <div className="flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          <span className="text-sm">Instant</span>
        </div>
        <div className="flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
          <span className="text-sm">Protected</span>
        </div>
      </div>

    </div>
  </div>
)}
      </main>
{/* Live Conversion Widget - Show in payment states */}
{(status === 'qr' || status === 'ready' || (status === 'idle' && cart && cart.length > 0)) && liveRate && (
  <div className="relative z-10 px-6 sm:px-8 pb-4">
    <div className="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4 max-w-md mx-auto">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <img 
            src="https://static.coingecko.com/s/coingecko-logo-8903d34ce19ca4be1c81f0db30e924154750d208683fad7ae6f2ce06c76d0a56.png" 
            alt="CoinGecko" 
            className="h-5 w-auto object-contain"
          />
          <span className="text-xs text-zinc-500">Live rate from CoinGecko Pro</span>
        </div>
        <div className="flex items-center gap-1.5">
          <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
          <span className="text-xs text-emerald-500 font-medium">LIVE</span>
        </div>
      </div>
      
      <div className="flex items-baseline justify-between">
        <span className="text-zinc-400 text-sm">Settlement amount</span>
        <div className="text-right">
          <span className="text-2xl font-bold text-white font-mono">
            {rlusdAmount?.toFixed(4)} <span className="text-emerald-400 text-lg">RLUSD</span>
          </span>
          <p className="text-xs text-zinc-500 mt-1">
            ¬£1 = {liveRate?.toFixed(4)} RLUSD
          </p>
        </div>
      </div>
      
      <div className="mt-3 pt-3 border-t border-zinc-800">
        <p className="text-[11px] text-zinc-500 leading-relaxed">
          <span className="text-zinc-400 font-medium">Live price.</span> Updated every 10s via CoinGecko Pro (600+ exchanges). Settlement variance &lt;0.1%.
        </p>
      </div>
    </div>
  </div>
)}
      {/* Footer */}
      <footer className="relative z-10 px-6 py-4 sm:px-8 sm:py-5 border-t border-zinc-800/50">
        <div className="flex flex-col sm:flex-row items-center justify-between gap-2">
          <div className="flex items-center gap-3">
              <img 
    src={data.logo_url || "https://yesallofus.com/dltpayslogo1.png"} 
    alt="Logo" 
    className="w-10 h-10 sm:w-12 sm:h-12 rounded-xl object-cover"
  />
            <span className="text-zinc-600 text-sm sm:text-base">Powered by YesAllOfUs</span>
          </div>
          <div className="flex items-center gap-2 text-zinc-600">
            <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            <span className="text-sm sm:text-base">Secure payments on XRPL</span>
          </div>
        </div>
        {/* Discreet back to POS link */}
        <div className="mt-4 flex justify-center">
          <a 
            href="/take-payment" 
            className="flex items-center gap-1.5 text-zinc-700 hover:text-zinc-500 transition text-xs"
          >
            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span>Back to POS</span>
          </a>
        </div>
      </footer>
    </div>
  );
}

export default function DisplayPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-black text-white flex items-center justify-center">
        <div className="w-12 h-12 sm:w-16 sm:h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    }>
      <CustomerDisplay />
    </Suspense>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(noheader)/layout.tsx
// =================================================

// MARK: - Component Definition
export default function NoHeaderLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(noheader)/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';
import InstallAppButton from '@/components/InstallAppButton';
import BackgroundVideo from '@/components/BackgroundVideo';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
export default function WelcomePage() {
  const router = useRouter();
  

// MARK: - State Management
  const [agreedToTerms, setAgreedToTerms] = useState(false);
  const [isLoading, setIsLoading] = useState<'partner' | 'member' | 'affiliate' | 'soundpay' | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [soundPayError, setSoundPayError] = useState<string | null>(null);


// MARK: - Event Handlers
  const handleSelection = async (userType: 'partner' | 'member' | 'affiliate') => {
    
    setIsLoading(userType);
    setError(null);
    
    try {
      const { loginWithWeb3Auth } = await import('@/lib/web3auth');
      const result = await loginWithWeb3Auth();
      
      if (!result) {
        setError('Login cancelled');
        setIsLoading(null);
        return;
      }
      
      const address = typeof result === 'string' ? result : result.address;
      const provider = typeof result === 'string' ? 'google' : (result.provider || 'google');
      
      if (!address) {
        throw new Error('No wallet found');
      }

      safeSetItem('loginMethod', 'web3auth');
      safeSetItem('socialProvider', provider);
      safeSetItem('walletAddress', address);

      if (userType === 'partner') {
        safeSetItem('vendorWalletAddress', address);
        router.push('/dashboard');
      } else {
        router.push('/affiliate-dashboard');
      }
      
    } catch (err: any) {
      console.error('Sign in error:', err);
      setError(err.message || 'Failed to sign in');
      setIsLoading(null);
    }
  };

  const handleSoundPay = async () => {
    setIsLoading('soundpay');
    setSoundPayError(null);
    setError(null);

    try {
      // Check if already logged in
      let walletAddress = safeGetItem('walletAddress');

      if (!walletAddress) {
        // Try to get wallet from Web3Auth without creating new
        const { loginWithWeb3Auth } = await import('@/lib/web3auth');
        const result = await loginWithWeb3Auth();

        if (!result) {
          setIsLoading(null);
          setSoundPayError('Please register first');
          return;
        }

        walletAddress = typeof result === 'string' ? result : result.address;
        const provider = typeof result === 'string' ? 'google' : (result.provider || 'google');

        if (walletAddress) {
          safeSetItem('loginMethod', 'web3auth');
          safeSetItem('socialProvider', provider);
          safeSetItem('walletAddress', walletAddress);
        }
      }

      if (!walletAddress) {
        setSoundPayError('Please register first');
        setIsLoading(null);
        return;
      }

      // Check if customer exists
      const res = await fetch(`${API_URL}/customer/exists/${walletAddress}`);
      const data = await res.json();

      if (data.success && data.exists) {
        router.push('/sound-pay');
      } else {
        setSoundPayError('Please register as a Member first');
        setIsLoading(null);
      }

    } catch (err: any) {
      console.error('SoundPay check error:', err);
      setSoundPayError('Please register first');
      setIsLoading(null);
    }
  };


// MARK: - API Calls & Data Fetching
  const LoadingSpinner = () => (
    <div className="flex flex-col items-center">
      <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mb-2"></div>
      <p className="font-medium text-sm text-emerald-400">Connecting...</p>
    </div>
  );


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans flex flex-col relative overflow-x-hidden">
      {/* Background Video */}
      <BackgroundVideo src="/affiliate-hq.webm" overlay={true} />
      
      {/* Custom animations */}
      <style jsx global>{`
        @keyframes breathe {
          0%, 100% { transform: scale(1.2); opacity: 0.3; }
          50% { transform: scale(1.5); opacity: 0.5; }
        }
        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-breathe {
          animation: breathe 4s ease-in-out infinite;
        }
        @keyframes shine {
          0% { transform: translateX(-100%) rotate(25deg); }
          100% { transform: translateX(200%) rotate(25deg); }
        }
        .logo-container {
          position: relative;
          overflow: hidden;
        }
        .animate-fade-in-up {
          animation: fadeInUp 0.5s ease-out forwards;
          opacity: 0;
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }
        .delay-400 { animation-delay: 0.4s; }
        .delay-500 { animation-delay: 0.5s; }
        .mirror-shine {
          position: relative;
          overflow: hidden;
        }
        .mirror-shine::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 50%;
          height: 100%;
          background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.1),
            rgba(255, 255, 255, 0.3),
            rgba(255, 255, 255, 0.1),
            transparent
          );
          transform: skewX(-25deg);
          animation: shine 3s infinite;
        }
      `}</style>
      
      <main className="flex-1 flex flex-col items-center justify-center px-4 sm:px-6 py-4 md:py-6 lg:py-8 relative z-10">
        <div className="w-full max-w-sm md:max-w-md lg:max-w-lg">
          
          {/* Logo */}
          <div className="flex flex-col items-center justify-center mb-3 md:mb-4">
            <div className="relative mb-2 md:mb-3">
              <div className="absolute inset-0 bg-emerald-500/40 blur-2xl rounded-full animate-breathe scale-150" />
              <div className="logo-container rounded-2xl bg-transparent">
                <img 
                  src="https://yesallofus.com/dltpayslogo1.png" 
                  alt="YesAllOfUs" 
                  className="w-12 h-12 md:w-14 md:h-14 rounded-2xl relative z-10 bg-transparent"
                />
              </div>
            </div>
            <h1 className="text-2xl md:text-3xl font-bold tracking-tight">YesAllOfUs</h1>
            <div className="mt-1 md:mt-2 mb-1">
              <svg viewBox="0 0 160 28" className="w-28 h-5 md:w-32 md:h-6 mx-auto">
                <defs>
                  <linearGradient id="yaofuWelcomeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#10b981" />
                    <stop offset="40%" stopColor="#3b82f6" />
                    <stop offset="100%" stopColor="#8b5cf6" />
                  </linearGradient>
                </defs>
                <text x="80" y="20" textAnchor="middle" fill="url(#yaofuWelcomeGradient)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="6">
                  YAOFUS
                </text>
              </svg>
            </div>
            <p className="text-zinc-500 text-xs md:text-sm mt-1">Tap. Pay. Earn.</p>
          </div>

          {/* User Type Selection */}
          <div className="mb-4">
            
            {/* Install App Button */}
            <InstallAppButton />
            
            <div className="grid grid-cols-2 gap-2 md:gap-3">
              {/* Partner */}
              <button
                onClick={() => router.push('/dashboard')}
                disabled={isLoading !== null}
                className={`group p-3 md:p-4 lg:p-5 rounded-2xl border transition-all duration-300 animate-fade-in-up delay-100 ${
                  isLoading === 'partner'
                    ? 'border-emerald-500 bg-emerald-500/10'
                    : 'border-transparent bg-zinc-800/30 hover:border-emerald-500/50 hover:bg-zinc-800/50 hover:shadow-[0_0_30px_-5px_rgba(16,185,129,0.3)]'
                } disabled:opacity-50`}
              >
                {isLoading === 'partner' ? <LoadingSpinner /> : (
                  <>
                    <div className="w-8 h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 mx-auto mb-2 rounded-xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 flex items-center justify-center group-hover:scale-110 transition-transform">
                      <svg className="w-4 h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72L4.318 3.44A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z" />
                      </svg>
                    </div>
                    <p className="font-semibold text-xs md:text-sm text-white">Partner</p>
                    <p className="text-zinc-500 text-[10px] md:text-xs mt-0.5">Accept payments</p>
                  </>
                )}
              </button>
              
              {/* Member */}
              <button
                onClick={() => handleSelection('member')}
                disabled={isLoading !== null}
                className={`group p-3 md:p-4 lg:p-5 rounded-2xl border transition-all duration-300 animate-fade-in-up delay-200 ${
                  isLoading === 'member'
                    ? 'border-emerald-500 bg-emerald-500/10'
                    : 'border-transparent bg-zinc-800/30 hover:border-sky-500/50 hover:bg-zinc-800/50 hover:shadow-[0_0_30px_-5px_rgba(14,165,233,0.3)]'
                } disabled:opacity-50`}
              >
                {isLoading === 'member' ? <LoadingSpinner /> : (
                  <>
                    <div className="w-8 h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 mx-auto mb-2 rounded-xl bg-gradient-to-br from-sky-500/20 to-sky-600/10 flex items-center justify-center group-hover:scale-110 transition-transform">
                      <svg className="w-4 h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                      </svg>
                    </div>
                    <p className="font-semibold text-xs md:text-sm text-white">Member</p>
                    <p className="text-zinc-500 text-[10px] md:text-xs mt-0.5">Tap & earn</p>
                  </>
                )}
              </button>
              
              {/* Affiliate */}
              <button
                onClick={() => handleSelection('affiliate')}
                disabled={isLoading !== null}
                className={`group p-3 md:p-4 lg:p-5 rounded-2xl border transition-all duration-300 animate-fade-in-up delay-300 ${
                  isLoading === 'affiliate'
                    ? 'border-emerald-500 bg-emerald-500/10'
                    : 'border-transparent bg-zinc-800/30 hover:border-amber-500/50 hover:bg-zinc-800/50 hover:shadow-[0_0_30px_-5px_rgba(245,158,11,0.3)]'
                } disabled:opacity-50`}
              >
                {isLoading === 'affiliate' ? <LoadingSpinner /> : (
                  <>
                    <div className="w-8 h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 mx-auto mb-2 rounded-xl bg-gradient-to-br from-amber-500/20 to-amber-600/10 flex items-center justify-center group-hover:scale-110 transition-transform">
                      <svg className="w-4 h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                      </svg>
                    </div>
                    <p className="font-semibold text-xs md:text-sm text-white">Affiliate</p>
                    <p className="text-zinc-500 text-[10px] md:text-xs mt-0.5">Discover, share & earn</p>
                  </>
                )}
              </button>
              
              {/* Explore */}
              <button
                onClick={() => router.push('/home')}
                disabled={isLoading !== null}
                className="group p-3 md:p-4 lg:p-5 rounded-2xl border border-transparent bg-zinc-800/30 hover:border-zinc-600 hover:bg-zinc-800/50 hover:shadow-[0_0_30px_-5px_rgba(161,161,170,0.2)] transition-all duration-300 animate-fade-in-up delay-400 disabled:opacity-50"
              >
                <div className="w-8 h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 mx-auto mb-2 rounded-xl bg-zinc-800/50 flex items-center justify-center group-hover:scale-110 transition-transform">
                  <svg className="w-4 h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
                  </svg>
                </div>
                <p className="font-semibold text-xs md:text-sm text-white">Explore</p>
                <p className="text-zinc-500 text-[10px] md:text-xs mt-0.5">View site</p>
              </button>
            </div>

            {/* SoundPay Button - Full Width with Video Background */}
            <button
              onClick={handleSoundPay}
              disabled={isLoading !== null}
              className="w-full mt-2 md:mt-3 rounded-2xl overflow-hidden relative animate-fade-in-up delay-500 disabled:opacity-50 group mirror-shine"
            >
              {/* Video Background */}
              <video
                autoPlay
                loop
                muted
                playsInline
                className="absolute inset-0 w-full h-full object-cover"
              >
                <source src="/affiliate-hq.webm" type="video/webm" />
              </video>
              
              {/* Light Overlay - brighter than background */}
              <div className="absolute inset-0 bg-white/5 group-hover:bg-white/8 transition-all duration-300" />
              
              {/* Content */}
              <div className="relative z-10 p-4 md:p-5 lg:p-6 flex items-center justify-center gap-3">
                {isLoading === 'soundpay' ? (
                  <LoadingSpinner />
                ) : soundPayError ? (
                  <div className="text-center">
                    <p className="text-amber-400 font-semibold text-sm">{soundPayError}</p>
                    <p className="text-zinc-400 text-xs mt-1">Tap Member above to register</p>
                  </div>
                ) : (
                  <>
                    {/* Sound Wave Icon */}
                    <div className="w-10 h-10 md:w-12 md:h-12 rounded-xl bg-purple-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                      <svg className="w-5 h-5 md:w-6 md:h-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                      </svg>
                    </div>
                    <div className="text-left">
                      <p className="font-bold text-lg md:text-xl text-white">SoundPay</p>
                      <p className="text-zinc-400 text-xs md:text-sm">Pay with sound waves</p>
                    </div>
                  </>
                )}
              </div>
            </button>
          </div>

          {/* Error */}
          {error && (
            <div className="mb-4 bg-red-500/10 border border-red-500/20 rounded-xl p-4">
              <p className="text-red-400 text-sm">{error}</p>
            </div>
          )}

        </div>
      </main>

      <footer className="py-2 px-3 text-center relative z-10 space-y-1">
        <p className="text-zinc-600 text-xs">
          Powered by <span className="text-zinc-500">XRPL</span> ¬∑ <span className="text-zinc-500">RLUSD</span>
        </p>
        <p className="text-zinc-700 text-xs">¬© 2025 YesAllOfUs. All rights reserved.</p>
      </footer>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(noheader)/receipts/page.tsx
// =================================================
// Imports
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, Suspense } from 'react';
import { safeGetItem } from '@/lib/safeStorage';
import { useRouter, useSearchParams } from 'next/navigation';
import NebulaBackground from '@/components/NebulaBackground'; // adjust path as needed

// Email validation regex
const isValidEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

// MARK: - Types & Interfaces
interface ReceiptItem {
name: string;
quantity: number;
unit_price?: number;
price?: number;
line_total?: number;
}

interface Receipt {
  receipt_id: string;
  receipt_number: string;
  customer_wallet: string;
  items: ReceiptItem[];
  tip_amount?: number;
  subtotal?: number;
  total: number;
  amount_rlusd?: number;
  currency: string;
  payment_method?: string;
  payment_status: string;
  payment_tx_hash: string;
  paid_at: string;
  created_at: string;
  conversion_rate?: {
    rlusd_gbp: number;
    gbp_to_rlusd?: number;
    source?: string;
    captured_at?: string;
    price_age_ms?: number;
  };
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
function ReceiptsPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const from = searchParams.get('from');
  
  // Auth
  const [walletAddress, setWalletAddress] = useState<string | null>(null);
  const [storeId, setStoreId] = useState<string | null>(null);
  const [storeName, setStoreName] = useState<string>('');

  // Logo
  const [storeLogo, setStoreLogo] = useState<string | null>(null);
  
  // Data
  const [receipts, setReceipts] = useState<Receipt[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Filters
  const [dateFilter, setDateFilter] = useState<'today' | 'week' | 'month' | 'all'>('all');
  const [sortBy, setSortBy] = useState<'newest' | 'oldest' | 'highest' | 'lowest'>('newest');
  const [searchQuery, setSearchQuery] = useState('');
  
  // Detail view
  const [selectedReceipt, setSelectedReceipt] = useState<Receipt | null>(null);

  // Pagination
  const [currentPage, setCurrentPage] = useState(1);
  const receiptsPerPage = 20;

  // Print preview modal
  const [showPrintPreview, setShowPrintPreview] = useState(false);
  const [previewReceipt, setPreviewReceipt] = useState<Receipt | null>(null);

  // Email modal
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [emailAddress, setEmailAddress] = useState('');
  const [sendingEmail, setSendingEmail] = useState(false);

  // Load store data

// MARK: - Hooks & Effects
useEffect(() => {
  const stored = safeGetItem('vendorWalletAddress');
  const storeData = safeGetItem('storeData');
  
  if (!stored) {
    router.push('/dashboard');
    return;
  }
  
  setWalletAddress(stored);
  
  if (storeData) {
    const store = JSON.parse(storeData);
    setStoreId(store.store_id || null);
    setStoreName(store.store_name || 'Your Store');
    setStoreLogo(store.logo_url || null);
    
    // Fetch fresh store data to get latest logo
    if (store.store_id) {
      fetch(`${API_URL}/store/public/${store.store_id}`)
        .then(res => res.json())
        .then(data => {
          if (data.success && data.store) {
            setStoreLogo(data.store.logo_url || null);
          }
        })
        .catch(err => console.error('Failed to fetch store:', err));
    }
  }
}, [router]);

  // Fetch receipts
  useEffect(() => {
    if (storeId && walletAddress) {
      fetchReceipts();
    }
  }, [storeId, walletAddress]);

  // Reset to page 1 when filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [dateFilter, sortBy, searchQuery]);


// MARK: - API Calls & Data Fetching
  const fetchReceipts = async () => {
    setLoading(true);
    setError(null);
    try {
      const res = await fetch(
        `${API_URL}/store/${storeId}/receipts?wallet_address=${walletAddress}&limit=500`
      );
      const data = await res.json();
      if (data.success) {
        setReceipts(data.receipts);
      } else {
        setError(data.error || 'Failed to load receipts');
      }
    } catch (err) {
      setError('Failed to load receipts');
    }
    setLoading(false);
  };

  // Filter and sort receipts
  const getFilteredReceipts = () => {
    let filtered = [...receipts];
    
    // Date filter
    const now = new Date();
    if (dateFilter === 'today') {
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      filtered = filtered.filter(r => new Date(r.paid_at) >= todayStart);
    } else if (dateFilter === 'week') {
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(r => new Date(r.paid_at) >= weekAgo);
    } else if (dateFilter === 'month') {
      const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(r => new Date(r.paid_at) >= monthAgo);
    }
    
    // Search filter
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(r => 
        r.receipt_number.toLowerCase().includes(query) ||
        r.payment_tx_hash.toLowerCase().includes(query) ||
        (r.total || 0).toString().includes(query) ||
        r.items.some(item => item.name.toLowerCase().includes(query))
      );
    }
    
    // Sort
    if (sortBy === 'newest') {
      filtered.sort((a, b) => new Date(b.paid_at).getTime() - new Date(a.paid_at).getTime());
    } else if (sortBy === 'oldest') {
      filtered.sort((a, b) => new Date(a.paid_at).getTime() - new Date(b.paid_at).getTime());
    } else if (sortBy === 'highest') {
      filtered.sort((a, b) => b.total - a.total);
    } else if (sortBy === 'lowest') {
      filtered.sort((a, b) => a.total - b.total);
    }
    
    return filtered;
  };

  const filteredReceipts = getFilteredReceipts();
  const totalPages = Math.ceil(filteredReceipts.length / receiptsPerPage);
  const paginatedReceipts = filteredReceipts.slice(
    (currentPage - 1) * receiptsPerPage,
    currentPage * receiptsPerPage
  );
  
  // Stats
  const totalRevenue = filteredReceipts.reduce((sum, r) => sum + r.total, 0);
  const avgTransaction = filteredReceipts.length > 0 ? totalRevenue / filteredReceipts.length : 0;

  // Format date
  const formatDate = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', {
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  // Format time ago
  const timeAgo = (dateStr: string) => {
  if (!dateStr) return 'Just now';
  const date = new Date(dateStr);
  if (isNaN(date.getTime())) return 'Just now';
  const now = new Date();
    const diff = now.getTime() - date.getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return `${days}d ago`;
  };

  // Get payment method display
  const getPaymentMethodDisplay = (method?: string) => {
    if (!method) return 'üí≥ NFC';
    switch (method) {
      case 'xaman_qr':
      case 'qr_xaman':
        return 'üì± Xaman';
      case 'web3auth':
        return 'üîê Web3Auth';
      case 'nfc_card':
        return 'üí≥ NFC';
      default:
        return 'üí≥ ' + method;
    }
  };

  // Show print preview
const showPrintModal = (receipt: Receipt) => {
  setPreviewReceipt(receipt);
  setShowPrintPreview(true);
};

// Actually print

// MARK: - Event Handlers
const handlePrint = () => {
  window.print();
};
// Export to CSV
const exportCSV = () => {
  const headers = ['Receipt #', 'Date', 'Items', 'Total', 'Payment Method', 'TX Hash'];
  const rows = filteredReceipts.map(r => [
    r.receipt_number,
    new Date(r.paid_at).toLocaleString('en-GB'),
    r.items.map(i => `${i.name} x${i.quantity}`).join('; '),
    `¬£${r.total.toFixed(2)}`,
    r.payment_method || 'NFC',
    r.payment_tx_hash
  ]);
  
  const csv = [headers, ...rows].map(row => 
    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
  ).join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `receipts-${storeName}-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

// Export to PDF
const exportPDF = () => {
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Sales Report - ${storeName}</title>
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          padding: 40px;
          color: #1a1a1a;
        }
        .header {
          display: flex;
          align-items: center;
          gap: 16px;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 2px solid #e5e5e5;
        }
        .logo {
          width: 50px;
          height: 50px;
          border-radius: 10px;
          object-fit: cover;
        }
        .title {
          font-size: 24px;
          font-weight: 700;
        }
        .subtitle {
          color: #666;
          font-size: 14px;
        }
        .stats {
          display: flex;
          gap: 30px;
          margin-bottom: 30px;
          padding: 20px;
          background: #f5f5f5;
          border-radius: 10px;
        }
        .stat-item {
          text-align: center;
        }
        .stat-value {
          font-size: 28px;
          font-weight: 700;
          color: #10b981;
        }
        .stat-label {
          font-size: 12px;
          color: #666;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }
        th {
          text-align: left;
          padding: 12px 8px;
          border-bottom: 2px solid #1a1a1a;
          font-size: 12px;
          text-transform: uppercase;
          color: #666;
        }
        td {
          padding: 12px 8px;
          border-bottom: 1px solid #eee;
          font-size: 13px;
        }
        .amount {
          font-weight: 600;
          color: #10b981;
        }
        .footer {
          margin-top: 40px;
          padding-top: 20px;
          border-top: 1px solid #eee;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }
        .footer-logo {
          width: 20px;
          height: 20px;
          border-radius: 4px;
          opacity: 0.6;
        }
        .footer-text {
          color: #999;
          font-size: 11px;
        }
        @media print {
          body { padding: 20px; }
          .logo { filter: invert(1) grayscale(1); }
        }
      </style>
    </head>
    <body>
      <div class="header">
        ${storeLogo 
          ? `<img src="${storeLogo}" alt="${storeName}" class="logo">`
          : `<img src="https://yesallofus.com/dltpayslogo1.png" alt="YesAllOfUs" class="logo">`
        }
        <div>
          <div class="title">${storeLogo ? storeName : 'YesAllOfUs'}</div>
          <div class="subtitle">Sales Report - ${dateFilter === 'today' ? 'Today' : dateFilter === 'week' ? 'This Week' : dateFilter === 'month' ? 'This Month' : 'All Time'}</div>
          ${!storeLogo ? `<div class="subtitle">${storeName}</div>` : ''}
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value">${filteredReceipts.length}</div>
          <div class="stat-label">Transactions</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">¬£${totalRevenue.toFixed(2)}</div>
          <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">¬£${avgTransaction.toFixed(2)}</div>
          <div class="stat-label">Average Sale</div>
        </div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th>Receipt #</th>
            <th>Date</th>
            <th>Items</th>
            <th>Amount</th>
            <th>Method</th>
          </tr>
        </thead>
        <tbody>
          ${filteredReceipts.map(r => `
            <tr>
              <td>${r.receipt_number}</td>
              <td>${new Date(r.paid_at).toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</td>
              <td>${r.items.map(i => `${i.name} x${i.quantity}`).join(', ')}</td>
              <td class="amount">¬£${r.total.toFixed(2)}</td>
              <td>${r.payment_method === 'xaman_qr' ? 'üì± Xaman' : r.payment_method === 'web3auth' ? 'üîê Web3Auth' : 'üí≥ NFC'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      
      <div class="footer" style="flex-direction: column; gap: 4px;">
        <span style="color: #71717a; font-size: 9px; font-weight: 500; letter-spacing: 1px;">REPORT</span>
        <span style="font-size: 16px; font-weight: 800; letter-spacing: 2px;"><span style="color: #10b981;">Y</span><span style="color: #22c55e;">A</span><span style="color: #3b82f6;">O</span><span style="color: #6366f1;">F</span><span style="color: #8b5cf6;">U</span><span style="color: #a855f7;">S</span></span>
        <span style="color: #52525b; font-size: 10px; font-weight: 600; letter-spacing: 1.5px;">INSTANT</span>
        <div style="display: flex; align-items: center; gap: 6px; margin-top: 8px;">
          <img src="https://yesallofus.com/dltpayslogo1.png" alt="YesAllOfUs" class="footer-logo">
          <span class="footer-text">Generated by YesAllOfUs</span>
        </div>
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  if (printWindow) {
    printWindow.document.write(printContent);
    printWindow.document.close();
    setTimeout(() => printWindow.print(), 500);
  }
};


// MARK: - Main Render
  return (
  <div className="min-h-screen bg-[#0a0a0a] text-white font-sans relative">
    {/* Nebula Background */}
    <NebulaBackground opacity={0.3} blur={0} />
    
    {/* Header with orange to black gradient */}
    <header className={`sticky top-0 z-40 bg-gradient-to-r from-orange-600/30 via-orange-900/20 via-amber-950/15 to-zinc-900/20 backdrop-blur border-b border-orange-500/30 ${showPrintPreview || selectedReceipt ? 'hidden' : ''}`}>
      <div className="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
        <button
          onClick={() => router.push(from === 'take-payment' ? '/take-payment' : '/dashboard')}
          className="text-zinc-200 hover:text-white transition flex items-center gap-1"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
          Back
        </button>
        
        <h1 className="text-lg font-bold">Receipts</h1>
        
        <button
          onClick={fetchReceipts}
          className="text-zinc-200 hover:text-white transition p-2"
          title="Refresh"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        </button>
      </div>
    </header>

    {/* Add relative z-10 to main to ensure content appears above nebula */}
    <main className="max-w-2xl mx-auto px-4 pb-8 relative z-10">
        
        {/* Stats */}
        <div className="grid grid-cols-3 gap-3 py-6">
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 text-center">
            <p className="text-zinc-500 text-xs mb-1">Transactions</p>
            <p className="text-2xl font-bold">{filteredReceipts.length}</p>
          </div>
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 text-center">
            <p className="text-zinc-500 text-xs mb-1">Revenue</p>
            <p className="text-2xl font-bold text-emerald-400">¬£{totalRevenue.toFixed(2)}</p>
          </div>
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 text-center">
            <p className="text-zinc-500 text-xs mb-1">Avg Sale</p>
            <p className="text-2xl font-bold">¬£{avgTransaction.toFixed(2)}</p>
          </div>
        </div>

        {/* Search */}
        <div className="mb-4">
          <input
            type="text"
            placeholder="Search receipts..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500"
          />
        </div>

        {/* Filters */}
        <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
          {(['today', 'week', 'month', 'all'] as const).map((filter) => (
            <button
              key={filter}
              onClick={() => setDateFilter(filter)}
              className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition ${
                dateFilter === filter
                  ? 'bg-emerald-500 text-black'
                  : 'bg-zinc-800 text-zinc-400 hover:text-white'
              }`}
            >
              {filter === 'today' ? 'Today' : filter === 'week' ? 'This Week' : filter === 'month' ? 'This Month' : 'All Time'}
            </button>
          ))}
        </div>

        {/* Sort & Export */}
<div className="flex gap-2 mb-6 flex-wrap">
  <select
    value={sortBy}
    onChange={(e) => setSortBy(e.target.value as typeof sortBy)}
    className="bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-2 text-sm text-white focus:outline-none focus:border-emerald-500"
  >
    <option value="newest">Newest First</option>
    <option value="oldest">Oldest First</option>
    <option value="highest">Highest Amount</option>
    <option value="lowest">Lowest Amount</option>
  </select>
  
  <div className="flex gap-2 ml-auto">
  <button
    onClick={exportCSV}
    disabled={filteredReceipts.length === 0}
    className="bg-zinc-800 hover:bg-zinc-700 disabled:opacity-50 px-4 py-2 rounded-xl text-sm transition flex items-center gap-2"
  >
    <svg className="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    CSV
  </button>
  <button
    onClick={exportPDF}
    disabled={filteredReceipts.length === 0}
    className="bg-zinc-800 hover:bg-zinc-700 disabled:opacity-50 px-4 py-2 rounded-xl text-sm transition flex items-center gap-2"
  >
    <svg className="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 13h6m-6 4h4" />
    </svg>
    PDF
  </button>
</div>
</div>

        {/* Loading */}
        {loading && (
          <div className="text-center py-12">
            <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p className="text-zinc-500">Loading receipts...</p>
          </div>
        )}

        {/* Error */}
        {error && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-4">
            <p className="text-red-400 text-sm">{error}</p>
          </div>
        )}

        {/* Empty State */}
        {!loading && !error && filteredReceipts.length === 0 && (
          <div className="text-center py-12">
            <div className="text-6xl mb-4">üßæ</div>
            <p className="text-zinc-400 mb-2">No receipts found</p>
            <p className="text-zinc-600 text-sm">
              {searchQuery ? 'Try a different search' : 'Receipts will appear here after payments'}
            </p>
          </div>
        )}

        {/* Receipts List */}
        {!loading && filteredReceipts.length > 0 && (
          <div className="space-y-3">
            {paginatedReceipts.map((receipt) => (
              <button
                key={receipt.receipt_id}
                onClick={() => setSelectedReceipt(receipt)}
                className="w-full bg-zinc-900 border border-zinc-800 hover:border-zinc-700 rounded-xl p-4 text-left transition"
              >
                <div className="flex items-center justify-between mb-2">
                  <span className="text-zinc-500 text-xs font-mono">{receipt.receipt_number}</span>
                  <span className="text-zinc-500 text-xs">{timeAgo(receipt.paid_at)}</span>
                </div>
                <div className="flex items-center justify-between">
                  <div>
                    <p className="font-medium">
                      {receipt.items.length === 1 
                        ? receipt.items[0].name 
                        : `${receipt.items.length} items`}
                    </p>
                    <p className="text-zinc-500 text-sm">
                      {getPaymentMethodDisplay(receipt.payment_method)} ¬∑ {formatDate(receipt.paid_at)}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-bold text-emerald-400">¬£{(receipt.total || 0).toFixed(2)}</p>
                  </div>
                </div>
              </button>
            ))}
          </div>
        )}

        {/* Pagination */}
        {!loading && totalPages > 1 && (
          <div className="flex items-center justify-center gap-2 mt-6">
            <button
              onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
              disabled={currentPage === 1}
              className="p-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            
            <div className="flex gap-1">
              {Array.from({ length: totalPages }, (_, i) => i + 1)
                .filter(page => {
                  if (page === 1 || page === totalPages) return true;
                  if (Math.abs(page - currentPage) <= 1) return true;
                  return false;
                })
                .map((page, idx, arr) => (
                  <span key={page} className="flex items-center">
                    {idx > 0 && arr[idx - 1] !== page - 1 && (
                      <span className="text-zinc-600 px-1">...</span>
                    )}
                    <button
                      onClick={() => setCurrentPage(page)}
                      className={`w-10 h-10 rounded-lg font-medium transition ${
                        currentPage === page
                          ? 'bg-emerald-500 text-black'
                          : 'bg-zinc-800 hover:bg-zinc-700 text-white'
                      }`}
                    >
                      {page}
                    </button>
                  </span>
                ))}
            </div>
            
            <button
              onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
              disabled={currentPage === totalPages}
              className="p-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        )}

        {/* Page Info */}
        {!loading && totalPages > 1 && (
          <p className="text-center text-zinc-500 text-sm mt-3">
            Showing {((currentPage - 1) * receiptsPerPage) + 1}-{Math.min(currentPage * receiptsPerPage, filteredReceipts.length)} of {filteredReceipts.length}
          </p>
        )}

        {/* Receipt Detail Modal */}
{selectedReceipt && (
  <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
    <div className="bg-zinc-900 rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
      {/* Modal Header */}
      <div className="sticky top-0 bg-zinc-900 p-4 border-b border-zinc-800 flex items-center justify-between">
        <div>
          <p className="font-bold">{selectedReceipt.receipt_number}</p>
          <p className="text-zinc-500 text-sm">{formatDate(selectedReceipt.paid_at)}</p>
        </div>
        <button
          onClick={() => setSelectedReceipt(null)}
          className="text-zinc-400 hover:text-white p-2 transition-colors"
          aria-label="Close receipt modal"
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      {/* Modal Content */}
      <div className="p-4">
        {/* Items */}
        <div className="mb-4">
          <p className="text-zinc-500 text-sm mb-2">Items</p>
          <div className="space-y-2">
            {selectedReceipt.items?.map((item, idx) => (
              <div
                key={idx}
                className="flex justify-between py-2 border-b border-zinc-800 last:border-0"
              >
                <div>
                  <p className="font-medium">{item.name}</p>
                  <p className="text-zinc-500 text-sm">
                    {item.quantity || 1} √ó ¬£{(item.unit_price || item.price || 0).toFixed(2)}
                  </p>
                </div>
                <p className="font-medium">
                  ¬£{((item.line_total || (item.unit_price || item.price || 0) * (item.quantity || 1))).toFixed(2)}
                </p>
              </div>
            )) ?? null}
          </div>
        </div>

        {/* Total */}
        <div className="flex justify-between items-center py-3 border-t border-zinc-700 mb-4">
          <p className="font-semibold">Total</p>
          <p className="text-2xl font-bold text-emerald-400">
            ¬£{Number(selectedReceipt.total || 0).toFixed(2)}
          </p>
        </div>

        {/* Details */}
        <div className="space-y-3 text-sm">
          <div className="flex justify-between">
            <span className="text-zinc-500">Payment Method</span>
            <span>{getPaymentMethodDisplay(selectedReceipt.payment_method)}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-500">Status</span>
            <span className="text-emerald-400">‚úì {selectedReceipt.payment_status}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-500">Customer</span>
            <span className="font-mono text-xs">
              {selectedReceipt.customer_wallet?.slice(0, 8) ?? '‚Äî‚Äî'}...
              {selectedReceipt.customer_wallet?.slice(-4) ?? '‚Äî‚Äî'}
            </span>
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-3 mt-6">
          <button
            onClick={() => setShowEmailModal(true)}
            className="flex-1 bg-zinc-800 hover:bg-zinc-700 rounded-xl p-3 transition flex items-center justify-center gap-2"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <span>Email</span>
          </button>
          <button
            onClick={() => showPrintModal(selectedReceipt)}
            className="flex-1 bg-zinc-800 hover:bg-zinc-700 rounded-xl p-3 transition flex items-center justify-center gap-2"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            <span>Print</span>
          </button>
        </div>

        {/* Transaction Link */}
        {selectedReceipt.payment_tx_hash && (
          <a
            href={`https://livenet.xrpl.org/transactions/${selectedReceipt.payment_tx_hash}`}
            target="_blank"
            rel="noopener noreferrer"
            className="block mt-4 bg-zinc-800 hover:bg-zinc-700 rounded-xl p-3 text-center transition"
          >
            <p className="text-zinc-500 text-xs mb-1">Transaction</p>
            <p className="text-emerald-400 text-sm font-mono break-all">
              {selectedReceipt.payment_tx_hash.slice(0, 12)}...
              {selectedReceipt.payment_tx_hash.slice(-8)} ‚Üó
            </p>
          </a>
        )}
      </div>
    </div>

    {/* Email Modal */}
    {showEmailModal && (
      <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
        <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm">
          <h3 className="text-lg font-bold mb-4">Send Receipt</h3>
          <input
            type="email"
            placeholder="Customer email"
            value={emailAddress}
            onChange={(e) => setEmailAddress(e.target.value)}
            className="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500 mb-4"
            autoFocus
          />
          <div className="flex gap-3">
            <button
              onClick={() => {
                setShowEmailModal(false);
                setEmailAddress('');
              }}
              className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-3 rounded-xl transition"
            >
              Cancel
            </button>
            <button
              onClick={async () => {
                if (!emailAddress || !isValidEmail(emailAddress)) return;
                setSendingEmail(true);
                try {
                  const res = await fetch(`${API_URL}/receipt/email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      email: emailAddress,
                      store_name: storeName,
                      store_id: storeId,
                      amount: selectedReceipt.total,
                      rlusd_amount: selectedReceipt.amount_rlusd,
                      items: selectedReceipt.items,
                      tip_amount: selectedReceipt.tip_amount,
                      tx_hash: selectedReceipt.payment_tx_hash,
                      receipt_number: selectedReceipt.receipt_number,
                      conversion_rate: selectedReceipt.conversion_rate,
                      rate_source: selectedReceipt.conversion_rate?.source,
                      rate_timestamp: selectedReceipt.conversion_rate?.captured_at,
                    }),
                  });
                  const data = await res.json();
                  if (data.success) {
                    setShowEmailModal(false);
                    setEmailAddress('');
                    // Optional: add success toast here
                  } else {
                    console.error('Email API error:', data);
                  }
                } catch (err) {
                  console.error('Failed to send email:', err);
                } finally {
                  setSendingEmail(false);
                }
              }}
              disabled={sendingEmail}
              className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-3 rounded-xl transition disabled:opacity-50"
            >
              {sendingEmail ? 'Sending...' : 'Send'}
            </button>
          </div>
        </div>
      </div>
    )}
  </div>
)}

        {/* Print Preview Modal */}
        {showPrintPreview && previewReceipt && (
          <div className="fixed inset-0 bg-black z-50 overflow-y-auto">
            {/* Print Actions - Hidden when printing */}
            <div className="no-print sticky top-0 z-10 bg-zinc-900/95 backdrop-blur border-b border-zinc-800 p-4">
              <div className="max-w-md mx-auto flex items-center justify-between">
                <h2 className="font-bold">Print Preview</h2>
                <div className="flex gap-2">
                  <button
                    onClick={handlePrint}
                    className="bg-emerald-500 hover:bg-emerald-400 text-black font-bold px-6 py-2 rounded-xl transition flex items-center gap-2"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Print
                  </button>
                  <button
                    onClick={() => {
                      setShowPrintPreview(false);
                      setPreviewReceipt(null);
                    }}
                    className="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-xl transition"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>

            {/* Print Content */}
            <div className="max-w-md mx-auto bg-white text-black p-8 my-8">
              {/* Header */}
              <div className="text-center mb-6 pb-6 border-b-2 border-gray-200">
                {storeLogo ? (
                  <img 
                    src={storeLogo} 
                    alt={storeName} 
                    className="w-16 h-16 rounded-xl object-cover mx-auto mb-3" style={{ filter: 'invert(1) grayscale(1)' }}
                  />
                ) : (
                  <img 
                    src="https://yesallofus.com/dltpayslogo1.png" 
                    alt="YesAllOfUs" 
                    className="w-16 h-16 rounded-xl object-cover mx-auto mb-3" style={{ filter: 'invert(1) grayscale(1)' }}
                  />
                )}
                <h1 className="text-2xl font-bold mb-1">{storeName}</h1>
                <p className="text-sm text-gray-600">{previewReceipt.receipt_number}</p>
              </div>

              {/* Date */}
              <p className="text-sm text-gray-600 mb-6">
                {new Date(previewReceipt.paid_at).toLocaleDateString('en-GB', { 
                  weekday: 'long', 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </p>

              {/* Items */}
              <div className="mb-6">
                {previewReceipt.items.filter(item => item.name.toLowerCase() !== 'tip').map((item, idx) => (
                  <div key={idx} className="flex justify-between py-3 border-b border-gray-200">
                    <div>
                      <p className="font-medium">{item.name}</p>
                      <p className="text-sm text-gray-600">
                        Qty: {item.quantity || 1} √ó ¬£{(item.unit_price || item.price || 0).toFixed(2)}
                      </p>
                    </div>
                    <p className="font-semibold">
                      ¬£{(item.line_total || (item.unit_price || item.price || 0) * (item.quantity || 1)).toFixed(2)}
                    </p>
                  </div>
                ))}

                {/* Tip */}
                {previewReceipt.tip_amount && previewReceipt.tip_amount > 0 && (
                  <div className="flex justify-between py-3 border-t border-gray-200 mt-2">
                    <div className="flex items-center gap-2">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                      </svg>
                      <div>
                        <p className="font-medium text-emerald-600">Tip</p>
                        <p className="text-sm text-gray-600">Thank you!</p>
                      </div>
                    </div>
                    <p className="font-semibold text-emerald-600">
                      ¬£{(previewReceipt.tip_amount * (previewReceipt.conversion_rate?.rlusd_gbp || 0.74)).toFixed(2)}
                    </p>
                  </div>
                )}
              </div>

              {/* Total */}
              <div className="flex justify-between items-center py-4 border-t-2 border-black mb-6">
                <span className="text-lg font-semibold">Total</span>
                <span className="text-3xl font-bold text-emerald-600">
                  ¬£{previewReceipt.total.toFixed(2)}
                </span>
              </div>

              {/* Settlement Details */}
              {previewReceipt.amount_rlusd && previewReceipt.conversion_rate && (
                <div className="mb-6 p-4 bg-emerald-50 rounded-lg border-l-4 border-emerald-500">
                  <p className="text-xs font-semibold text-emerald-800 mb-2">üí± SETTLEMENT DETAILS</p>
                  <div className="text-sm space-y-1">
                    <div className="flex justify-between">
                      <span className="text-gray-600">Amount Quoted:</span>
                      <span>¬£{previewReceipt.total.toFixed(2)} GBP</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Amount Settled:</span>
                      <span className="font-semibold">{previewReceipt.amount_rlusd.toFixed(6)} RLUSD</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Exchange Rate:</span>
                      <span>¬£1 = {previewReceipt.conversion_rate.gbp_to_rlusd?.toFixed(6) || 'N/A'} RLUSD</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">Rate Source:</span>
                      <span>{previewReceipt.conversion_rate.source || 'CoinGecko Pro API'}</span>
                    </div>
                    {previewReceipt.conversion_rate.captured_at && (
                      <div className="flex justify-between">
                        <span className="text-gray-600">Rate Timestamp:</span>
                        <span className="text-xs text-gray-500">{new Date(previewReceipt.conversion_rate.captured_at).toISOString()}</span>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Transaction */}
              <div className="bg-gray-100 rounded-lg p-4 mb-6">
                <p className="text-xs text-gray-600 mb-1">Transaction ID (XRPL)</p>
                <p className="text-xs font-mono break-all text-gray-800">
                  {previewReceipt.payment_tx_hash}
                </p>
              </div>

              {/* Footer */}
              <div className="text-center pt-6 border-t border-gray-200">
                <p className="text-xs text-gray-500 mb-1">RECEIPT</p>
                <p className="text-lg font-extrabold tracking-widest mb-1">
                  <span className="text-emerald-500">Y</span>
                  <span className="text-green-500">A</span>
                  <span className="text-blue-500">O</span>
                  <span className="text-indigo-500">F</span>
                  <span className="text-violet-500">U</span>
                  <span className="text-purple-500">S</span>
                </p>
                <p className="text-xs text-gray-600 font-semibold mb-3">INSTANT</p>
                <div className="flex items-center justify-center gap-2">
                  <img 
                    src="https://yesallofus.com/dltpayslogo1.png" 
                    alt="YesAllOfUs" 
                    className="w-5 h-5 rounded opacity-60"
                  />
                  <span className="text-xs text-gray-500">Powered by YesAllOfUs</span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* YAOFU Pioneers Badge */}
        <div className="mt-8 flex flex-col items-center gap-1">
          <span className="text-zinc-500 text-[10px] font-medium tracking-wider">VERIFIED</span>
          <span className="text-base font-extrabold tracking-widest">
            <span className="text-emerald-500">Y</span>
            <span className="text-green-500">A</span>
            <span className="text-blue-500">O</span>
            <span className="text-indigo-500">F</span>
            <span className="text-violet-500">U</span>
            <span className="text-purple-500">S</span>
          </span>
          <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">RECEIPTS</span>
          <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
            <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
            <span>Powered by YesAllOfUs</span>
          </div>
        </div>

      </main>
    </div>
  );
}

function ReceiptsPageWrapper() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center">
        <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    }>
      <ReceiptsPage />
    </Suspense>
  );
}


// MARK: - Exports
export default ReceiptsPageWrapper;

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(noheader)/signup-customer/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import Logo from '@/components/Logo';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';

function SignupCustomerPage() {
  const searchParams = useSearchParams();
  const storeId = searchParams.get('store');

  const [store, setStore] = useState<any>(null);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  // Form state
  const [cardUid, setCardUid] = useState<string | null>(null);
  const [cardName, setCardName] = useState('');
  const [scanning, setScanning] = useState(false);
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [phone, setPhone] = useState('');
  const [submitting, setSubmitting] = useState(false);

  // Load store info

// MARK: - Hooks & Effects
  useEffect(() => {
    if (!storeId) {
      setError('No store specified');
      setLoading(false);
      return;
    }

    fetch(`${NFC_API_URL}/store/public/${storeId}`)
      .then(res => res.json())
      .then(data => {
        if (data.success && data.store) {
          setStore(data.store);
        } else {
          setError('Store not found');
        }
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load store');
        setLoading(false);
      });
  }, [storeId]);

  // NFC Scan
  const startNFCScan = async () => {
    setError(null);

    if (!('NDEFReader' in window)) {
      setError('NFC is not supported on this device. Please use Chrome on Android.');
      return;
    }

    setScanning(true);

    try {
      const ndef = new (window as any).NDEFReader();
      await ndef.scan();

      ndef.addEventListener('reading', async (event: any) => {
        const serialNumber = event.serialNumber;
        
        if (!serialNumber) {
          setError('Could not read card. Please try again.');
          setScanning(false);
          return;
        }

        // Format card UID (remove colons, uppercase)
        const uid = serialNumber.replace(/:/g, '').toUpperCase();
        setCardUid(uid);
        setScanning(false);
      });

      ndef.addEventListener('readingerror', () => {
        setError('Error reading card. Please try again.');
        setScanning(false);
      });

    } catch (err: any) {
      if (err.name === 'NotAllowedError') {
        setError('NFC permission denied. Please allow NFC access.');
      } else if (err.name === 'NotSupportedError') {
        setError('NFC is not supported on this device.');
      } else {
        setError('Failed to start NFC scan. Make sure NFC is enabled.');
      }
      setScanning(false);
    }
  };

  // Submit form

// MARK: - Event Handlers
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!cardUid) {
      setError('Please tap an NFC card first');
      return;
    }

    if (!email) {
      setError('Email is required');
      return;
    }

    setSubmitting(true);
    setError(null);

    try {
      const res = await fetch(`${NFC_API_URL}/nfc/register-customer`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          card_uid: cardUid,
          card_name: cardName.trim() || null,
          store_id: storeId,
          name: name.trim() || null,
          email: email.trim().toLowerCase(),
          phone: phone.trim() || null
        })
      });

      const data = await res.json();

      if (data.success) {
  setSuccess(true);
  
  // Reset display to idle after 5 seconds
  setTimeout(async () => {
    try {
      await fetch(`${NFC_API_URL}/display/${storeId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'idle' })
      });
    } catch (err) {
      console.error('Failed to reset display:', err);
    }
  }, 5000);
} else {
        setError(data.error || 'Registration failed');
      }
    } catch (err) {
      setError('Failed to register. Please try again.');
    }

    setSubmitting(false);
  };

  // Loading
  if (loading) {

// MARK: - Main Render
    return (
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center">
        <div className="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
      </div>
    );
  }

  // Error - no store
  if (!store) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center p-6">
        <div className="text-center">
          <div className="text-4xl mb-4">‚ùå</div>
          <h1 className="text-xl font-bold mb-2">Store Not Found</h1>
          <p className="text-zinc-400">{error || 'Invalid store link'}</p>
        </div>
      </div>
    );
  }

  // Success
  if (success) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center p-6">
        <div className="max-w-md w-full text-center">
          <div className="mb-6">
  {store.logo_url ? (
    <img 
      src={store.logo_url} 
      alt={store.store_name} 
      className="w-20 h-20 rounded-2xl object-cover mx-auto"
    />
  ) : (
    <div className="flex justify-center">
      <Logo size={80} />
    </div>
  )}
</div>
          <h1 className="text-2xl font-bold mb-2">Welcome to {store.store_name}!</h1>
          <p className="text-zinc-400 mb-6">
            Your card is now linked. Check your email for next steps.
          </p>
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-left">
            <p className="text-zinc-300 text-sm mb-4">
              <strong className="text-white">{store.store_name}</strong> has signed you up!
            </p>
            {cardName && (
              <p className="text-zinc-400 text-sm mb-2">
                Card: <span className="text-white">{cardName}</span>
              </p>
            )}
            <p className="text-zinc-400 text-sm">
              You'll receive a welcome email with a link to set up your member dashboard where you can earn rewards on every purchase.
            </p>
          </div>
          <button
            onClick={() => {
              setSuccess(false);
              setCardUid(null);
              setCardName('');
              setName('');
              setEmail('');
              setPhone('');
            }}
            className="mt-6 text-zinc-500 hover:text-white text-sm transition"
          >
            Register another customer
          </button>
          {/* YAOFU Pioneers Badge */}
          <div className="mt-8 pt-6 border-t border-zinc-800 flex justify-center">
            <svg viewBox="0 0 140 48" className="w-32 h-12">
              <defs>
                <linearGradient id="yaofuGradientSignup" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#10b981" />
                  <stop offset="40%" stopColor="#3b82f6" />
                  <stop offset="100%" stopColor="#8b5cf6" />
                </linearGradient>
              </defs>
              <text x="70" y="12" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="500" fontSize="9" letterSpacing="1">
                WELCOME
              </text>
              <text x="70" y="28" textAnchor="middle" fill="url(#yaofuGradientSignup)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="14" letterSpacing="3">
                YAOFUS
              </text>
              <text x="70" y="43" textAnchor="middle" fill="#52525b" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="10" letterSpacing="1.5">
                INSTANT
              </text>
            </svg>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white">
      {/* Header */}
      <header className="border-b border-zinc-800 p-4">
<div className="max-w-md mx-auto flex items-center justify-between">
          <div className="flex items-center gap-4">
            <a 
              href="/dashboard" 
              className="text-zinc-400 hover:text-white transition flex items-center gap-1"
            >
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
              <span className="text-sm">Dashboard</span>
            </a>
          </div>
          <div className="flex items-center gap-3">
            <span className="text-zinc-500 text-sm">{store.store_name}</span>
            {store.logo_url ? (
              <img 
                src={store.logo_url} 
                alt={store.store_name} 
                className="w-8 h-8 rounded-lg object-cover"
              />
            ) : (
              <Logo size={32} />
            )}
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto px-4 sm:px-6 py-8">
        <h1 className="text-2xl font-bold mb-2">New Member Sign Up</h1>
        <p className="text-zinc-400 mb-8">
          Register a new customer to earn rewards with {store.store_name}
        </p>

        {/* Error */}
        {error && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
            <p className="text-red-400 text-sm">{error}</p>
          </div>
        )}

        {/* Step 1: NFC Card */}
        <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6">
          <div className="flex items-center gap-3 mb-4">
            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${cardUid ? 'bg-emerald-500 text-black' : 'bg-zinc-700 text-white'}`}>
              {cardUid ? '‚úì' : '1'}
            </div>
            <h2 className="font-semibold">Tap NFC Card</h2>
          </div>

          {cardUid ? (
            <div className="space-y-4">
              <div className="flex items-center justify-between p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
                <div className="flex items-center gap-3">
                  <span className="text-emerald-400 text-xl">üí≥</span>
                  <div>
                    <p className="text-emerald-400 font-medium">Card Detected</p>
                    <p className="text-zinc-500 text-sm font-mono">
                      {cardUid.slice(0, 4)}...{cardUid.slice(-4)}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => {
                    setCardUid(null);
                    setCardName('');
                  }}
                  className="text-zinc-400 hover:text-white text-sm transition"
                >
                  Change
                </button>
              </div>
              
              {/* Card Name Input */}
              <div>
                <label className="text-zinc-400 text-sm block mb-2">Card Name <span className="text-zinc-600">(optional)</span></label>
                <input
                  type="text"
                  value={cardName}
                  onChange={(e) => setCardName(e.target.value)}
                  placeholder="e.g., Puffin Bus Card, Gym Card"
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500"
                />
                <p className="text-zinc-600 text-xs mt-1">Help the customer identify this card later</p>
              </div>
            </div>
          ) : scanning ? (
            <div className="text-center py-8">
              <div className="relative w-20 h-20 mx-auto mb-4">
                <div className="absolute inset-0 bg-blue-500/20 rounded-full animate-ping"></div>
                <div className="absolute inset-2 bg-blue-500/30 rounded-full animate-ping" style={{ animationDelay: '0.2s' }}></div>
                <div className="absolute inset-0 flex items-center justify-center">
                  <span className="text-3xl">üí≥</span>
                </div>
              </div>
              <p className="text-blue-400 font-medium mb-2">Ready to scan</p>
              <p className="text-zinc-400 text-sm mb-4">Hold the NFC card near your phone</p>
              <button
                onClick={() => setScanning(false)}
                className="text-zinc-500 hover:text-white text-sm transition"
              >
                Cancel
              </button>
            </div>
          ) : (
            <button
              onClick={startNFCScan}
              className="w-full bg-white hover:bg-zinc-100 text-black font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2"
            >
              <span>üì±</span>
              Tap Card to Scan
            </button>
          )}
        </div>

        {/* Step 2: Customer Info */}
        <form onSubmit={handleSubmit}>
          <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6">
            <div className="flex items-center gap-3 mb-4">
              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${cardUid ? 'bg-zinc-700 text-white' : 'bg-zinc-800 text-zinc-500'}`}>
                2
              </div>
              <h2 className="font-semibold">Customer Details</h2>
            </div>

            <div className="space-y-4">
              <div>
                <label className="text-zinc-400 text-sm block mb-2">Name</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="John Smith"
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500"
                />
              </div>

              <div>
                <label className="text-zinc-400 text-sm block mb-2">Email <span className="text-red-400">*</span></label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="john@example.com"
                  required
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500"
                />
              </div>

              <div>
                <label className="text-zinc-400 text-sm block mb-2">Phone</label>
                <input
                  type="tel"
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  placeholder="+44 7700 900000"
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500"
                />
              </div>
            </div>
          </div>

          {/* Submit */}
          <button
            type="submit"
            disabled={!cardUid || !email || submitting}
            className={`w-full py-4 rounded-xl font-semibold text-lg transition flex items-center justify-center gap-2 ${
              cardUid && email && !submitting
                ? 'bg-white hover:bg-zinc-100 text-black'
                : 'bg-zinc-800 text-zinc-500 cursor-not-allowed'
            }`}
          >
            {submitting ? (
              <>
                <span className="w-5 h-5 border-2 border-zinc-400 border-t-black rounded-full animate-spin"></span>
                Registering...
              </>
            ) : (
              <>
                <span>‚úì</span>
                Register Member
              </>
            )}
          </button>
        </form>

        <p className="text-zinc-600 text-xs text-center mt-6">
          Customer will receive a welcome email with instructions to complete their account setup.
</p>

{/* YAOFUS Instant Badge */}
<div className="mt-8 flex flex-col items-center gap-1">
  <span className="text-zinc-500 text-[10px] font-medium tracking-wider">INSTANT</span>
  <span className="text-base font-extrabold tracking-widest">
    <span className="text-emerald-500">Y</span>
    <span className="text-green-500">A</span>
    <span className="text-blue-500">O</span>
    <span className="text-indigo-500">F</span>
    <span className="text-violet-500">U</span>
    <span className="text-purple-500">S</span>
  </span>
  <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">SIGNUP</span>
  <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
    <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
    <span>Powered by YesAllOfUs</span>
  </div>
</div>
</main>
</div>
  );
}

export default function SignupCustomerPageWrapper() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center">
        <div className="w-8 h-8 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
      </div>
    }>
      <SignupCustomerPage />
    </Suspense>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/(noheader)/take-payment/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect, useRef } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';
import ProductsManager from '@/components/ProductsManager';
import { updateCustomerDisplay, clearCustomerDisplay } from '@/lib/customerDisplay';
import StaffSelector from '@/components/StaffSelector';
import SendPaymentLink from '@/components/SendPaymentLink';
import PendingPayments from '@/components/PendingPayments';
import LiveConversionWidget from '@/components/LiveConversionWidget';
import TakePaymentTour from '@/components/TakePaymentTour';
import ReceiptActions from '../../../components/ReceiptActions';
import NebulaBackground from '@/components/NebulaBackground'; 
import TakePaymentHeader from '@/components/TakePaymentHeader';
import AutoSignModal from '@/components/AutoSignModal';
import { getIconById } from '@/lib/foodIcons';
import SoundPayButton from '@/components/SoundPayButton';
import SoundPaySendButton from '@/components/SoundPaySendButton';
import BarcodeScanner from '@/components/BarcodeScanner';

// MARK: - Types & Interfaces
interface Product {
product_id: string;
name: string;
price: number;
sku: string;
category: string | null;
emoji?: string;
icon_id?: string | null;
image_url?: string | null;
// Inventory fields
track_stock?: boolean;
stock_quantity?: number;
low_stock_threshold?: number;
barcode?: string | null;
}
interface CartItem extends Product {
quantity: number;
}

// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';
// Category emoji mapping
const categoryEmojis: Record<string, string> = {
'hot drinks': '‚òï',
'cold drinks': 'üßä',
'food': 'üçΩÔ∏è',
'snacks': 'üç™',
'desserts': 'üßÅ',
'breakfast': 'ü•ê',
'lunch': 'ü•™',
'default': 'üì¶'
};
// Product name emoji suggestions
const productEmojis: Record<string, string> = {
'coffee': '‚òï', 'latte': '‚òï', 'cappuccino': '‚òï', 'espresso': '‚òï', 'americano': '‚òï',
'flat white': '‚òï', 'mocha': '‚òï', 'macchiato': '‚òï',
'tea': 'üçµ', 'chai': 'üçµ', 'matcha': 'üçµ',
'water': 'üíß', 'juice': 'üßÉ', 'smoothie': 'ü•§', 'soda': 'ü•§', 'cola': 'ü•§',
'croissant': 'ü•ê', 'pastry': 'ü•ê', 'danish': 'ü•ê',
'muffin': 'üßÅ', 'cupcake': 'üßÅ', 'cake': 'üç∞',
'cookie': 'üç™', 'biscuit': 'üç™',
'sandwich': 'ü•™', 'wrap': 'üåØ', 'bagel': 'ü•Ø',
'salad': 'ü•ó', 'soup': 'üç≤',
'burger': 'üçî', 'fries': 'üçü', 'pizza': 'üçï',
'toast': 'üçû', 'bread': 'üçû',
'egg': 'ü•ö', 'bacon': 'ü•ì', 'sausage': 'üå≠',
'ice cream': 'üç¶', 'chocolate': 'üç´',
'beer': 'üç∫', 'wine': 'üç∑', 'cocktail': 'üç∏',
};
function getProductEmoji(product: Product): string {
if (product.emoji) return product.emoji;
const nameLower = product.name.toLowerCase();
for (const [key, emoji] of Object.entries(productEmojis)) {
if (nameLower.includes(key)) return emoji;
  }
if (product.category) {
const catLower = product.category.toLowerCase();
return categoryEmojis[catLower] || categoryEmojis['default'];
  }
return categoryEmojis['default'];
}
// Mobile Staff List Component (inline for mobile modal)

// MARK: - Component Definition
function MobileStaffList({ 
  storeId, 
  walletAddress, 
  activeStaff, 
  onSelect 
}: { 
  storeId: string; 
  walletAddress: string; 
  activeStaff: any; 
  onSelect: (staff: any) => void;
}) {
  const [staffList, setStaffList] = useState<any[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);


// MARK: - Hooks & Effects
  useEffect(() => {

// MARK: - API Calls & Data Fetching
    const fetchStaff = async () => {
      try {
        const res = await fetch(
          `https://api.dltpays.com/nfc/api/v1/store/${storeId}/staff?wallet_address=${walletAddress}`
        );
        const data = await res.json();
        if (data.success) {
          setStaffList(data.staff || []);
        }
      } catch (err) {
        console.error('Failed to fetch staff');
      }
      setLoading(false);
    };
    fetchStaff();
  }, [storeId, walletAddress]);

  if (loading) {

// MARK: - Main Render
    return (
      <div className="p-8 text-center">
        <div className="w-6 h-6 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
      </div>
    );
  }

  if (staffList.length === 0) {
    return (
      <div className="p-6 text-center">
        <p className="text-zinc-500 mb-2">No staff members yet</p>
        <a href="/staff" className="text-emerald-400 text-sm">+ Add staff</a>
      </div>
    );
  }

  return (
    <>
      {staffList.map((staff) => (
        <button
          key={staff.staff_id}

// MARK: - Event Handlers
          onClick={() => onSelect(staff)}
          className={`w-full flex items-center gap-3 px-4 py-4 border-b border-zinc-800 transition ${
            activeStaff?.staff_id === staff.staff_id ? 'bg-zinc-800' : ''
          }`}
        >
          {staff.photo_url ? (
            <img src={staff.photo_url} alt="" className="w-10 h-10 rounded-full object-cover" />
          ) : (
            <div className="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-lg text-emerald-400">
              {staff.name.charAt(0)}
            </div>
          )}
          <div className="flex-1 text-left">
            <p className="text-white">{staff.name}</p>
            <p className="text-zinc-500 text-sm">{staff.role}</p>
          </div>
          {activeStaff?.staff_id === staff.staff_id ? (
            <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          ) : staff.is_clocked_in ? (
            <span className="text-emerald-400 text-xs">‚óè On shift</span>
          ) : (
            <span className="text-zinc-600 text-xs">Off</span>
          )}
        </button>
      ))}
    </>
  );
}
export default function TakePayment() {
const router = useRouter();
// Store data
const [walletAddress, setWalletAddress] = useState<string | null>(null);
const [storeId, setStoreId] = useState<string | null>(null);
const [storeName, setStoreName] = useState<string>('');
const nfcScanActiveRef = useRef(false);
const paymentInProgressRef = useRef(false);
// Products & Cart
const [products, setProducts] = useState<Product[]>([]);
const [cart, setCart] = useState<CartItem[]>([]);
const [loadingProducts, setLoadingProducts] = useState(true);
// UI State
const [showProductsManager, setShowProductsManager] = useState(false);
const [showManualEntry, setShowManualEntry] = useState(false);
const [manualAmount, setManualAmount] = useState('');
// Payment State
const [status, setStatus] = useState<'idle' | 'qr' | 'waiting' | 'processing' | 'success' | 'error' | 'soundpay'>('idle');
const [soundPaymentId, setSoundPaymentId] = useState<string | null>(null);
const [error, setError] = useState<string | null>(null);
const [lastUID, setLastUID] = useState<string | null>(null);
const [txHash, setTxHash] = useState<string | null>(null);
const [receiptId, setReceiptId] = useState<string | null>(null);
const [conversionRate, setConversionRate] = useState<any>(null);
const [qrPaymentUrl, setQrPaymentUrl] = useState<string | null>(null);
// Last order for repeat
const [lastOrder, setLastOrder] = useState<CartItem[] | null>(null);
// Xaman QR Payment
const [xamanQR, setXamanQR] = useState<string | null>(null);
const [xamanPaymentId, setXamanPaymentId] = useState<string | null>(null);
// Search & Filter
const [searchQuery, setSearchQuery] = useState('');
const [activeCategory, setActiveCategory] = useState<string | null>(null);
const [showProductsGrid, setShowProductsGrid] = useState(true);
// Logo
const [storeLogo, setStoreLogo] = useState<string | null>(null);
const [showLogoUpload, setShowLogoUpload] = useState(false);
const [uploadingLogo, setUploadingLogo] = useState(false);
// Staff Dropdown
const [activeStaff, setActiveStaff] = useState<any | null>(null);
// Tip
const [tipsEnabled, setTipsEnabled] = useState<boolean>(false);
const [tipAmount, setTipAmount] = useState<number>(0);
const [showCustomTipModal, setShowCustomTipModal] = useState(false);
const [customTipInput, setCustomTipInput] = useState('');

// Live conversion state
const [liveRate, setLiveRate] = useState<number | null>(null);
const [rlusdAmount, setRlusdAmount] = useState<number | null>(null);
const [priceAge, setPriceAge] = useState<number>(0);
// Split pay email
const [showSendPaymentLink, setShowSendPaymentLink] = useState(false);
// Update share pay modal ui
const [showPendingPayments, setShowPendingPayments] = useState(false);
const [showAutoSignModal, setShowAutoSignModal] = useState(false);
// Header staff UI
const [showStaffModal, setShowStaffModal] = useState(false);
// Wallet status for RLUSD
const [walletReady, setWalletReady] = useState<boolean | null>(null);
const [settingUpWallet, setSettingUpWallet] = useState(false);
// State
const [runTour, setRunTour] = useState(false);
// Mobile products collapse
const [productsExpanded, setProductsExpanded] = useState(false);
// Barcode scanner
const [showBarcodeScanner, setShowBarcodeScanner] = useState(false);

// Stats data
const [stats, setStats] = useState({ totalRevenue: 0, totalSales: 0 });
// Hide prodcuts on mobile
const [showProducts, setShowProducts] = useState(true);

// Convert GBP to RLUSD - Live price from CoinGecko Pro with audit trail
const convertGBPtoRLUSD = async (gbpAmount: number): Promise<number> => {
  try {
    const res = await fetch(`https://api.dltpays.com/convert/gbp-to-rlusd?amount=${gbpAmount}&capture=true`);
    const data = await res.json();
    if (data.success) {
      console.log(`üí± Rate: ¬£1 = ${(1/data.rate.rlusd_gbp).toFixed(6)} RLUSD | Source: ${data.source}`);
      return data.rlusd;
    }
    throw new Error('Conversion failed');
  } catch (err) {
    console.error('Conversion error:', err);
    // Fallback to cached endpoint
    try {
      const fallback = await fetch('https://tokencanvas.io/api/coingecko/simple/price?ids=ripple-usd&vs_currencies=gbp');
      const fallbackData = await fallback.json();
      const rlusdInGbp = fallbackData['ripple-usd']?.gbp;
      if (rlusdInGbp) {
        return Math.round((gbpAmount / rlusdInGbp) * 1000000) / 1000000;
      }
    } catch {}
    return Math.round(gbpAmount * 1.35 * 1000000) / 1000000;
  }
};

// Decrement stock for cart items after successful payment
const decrementStockForCart = async (cartItems: CartItem[]) => {
  if (!storeId || !walletAddress) return;

  // Filter items that have stock tracking enabled
  const stockItems = cartItems.filter(item => item.track_stock);
  if (stockItems.length === 0) return;

  // Decrement stock for each item
  for (const item of stockItems) {
    try {
      await fetch(`${API_URL}/store/${storeId}/inventory/${item.product_id}/adjust`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress,
          adjustment: -item.quantity, // Negative to decrement
          reason: 'sale',
          notes: `POS sale - ${item.quantity} unit(s)`
        })
      });
    } catch (err) {
      console.error(`Failed to decrement stock for ${item.name}:`, err);
      // Don't block payment success for stock errors
    }
  }

  // Refresh products to show updated stock
  fetchProducts();
};

// Load store data
useEffect(() => {
const stored = safeGetItem('vendorWalletAddress');
const storeData = safeGetItem('storeData');
if (!stored) {
router.push('/dashboard');
return;
  }
setWalletAddress(stored);
if (storeData) {
const store = JSON.parse(storeData);
setStoreId(store.store_id || null);
setStoreName(store.store_name || 'Your Store');
setStoreLogo(store.logo_url || null);
// Fetch fresh store data to get latest logo
if (store.store_id) {
fetch(`${API_URL}/store/public/${store.store_id}`)
        .then(res => res.json())
        .then(data => {
if (data.success && data.store) {
setStoreLogo(data.store.logo_url || null);
// Update session storage with fresh data
const updatedStore = { ...store, logo_url: data.store.logo_url };
safeSetItem('storeData', JSON.stringify(updatedStore));
          }
        })
        .catch(err => console.error('Failed to fetch store:', err));
    }
  }
// Check wallet status for RLUSD
fetch(`https://api.dltpays.com/api/v1/wallet/status/${stored}`)
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      setWalletReady(data.funded && data.rlusd_trustline);
    }
  })
  .catch(err => console.error('Failed to check wallet:', err));
}, [router]);

// Fetch products
useEffect(() => {
if (storeId && walletAddress) {
fetchProducts();
    }
  }, [storeId, walletAddress]);
const fetchProducts = async () => {
setLoadingProducts(true);
try {
const res = await fetch(
`${API_URL}/store/${storeId}/products?wallet_address=${walletAddress}`
      );
const data = await res.json();
if (data.success) {
setProducts(data.products);
      }
    } catch (err) {
console.error('Failed to fetch products:', err);
    }
setLoadingProducts(false);
  };
  // Fetch sales stats
useEffect(() => {
  if (storeId && walletAddress) {
    const fetchStats = async () => {
      try {
        const res = await fetch(
          `${API_URL}/store/${storeId}/receipts?wallet_address=${walletAddress}&limit=10000`
        );
        const data = await res.json();
        if (data.success) {
          const totalRevenue = data.receipts.reduce((sum: number, r: any) => sum + r.total, 0);
          const totalSales = data.receipts.length;
          setStats({ totalRevenue, totalSales });
        }
      } catch (err) {
        console.error('Failed to fetch stats');
      }
    };
    fetchStats();
  }
}, [storeId, walletAddress]);

// Poll display status when in soundpay state
useEffect(() => {
  if (status !== 'soundpay' || !storeId) return;
  
  const pollDisplay = async () => {
    try {
      const res = await fetch(`${API_URL}/display/${storeId}`);
      const data = await res.json();
      if (data.status === 'success') {
        decrementStockForCart(cart); // Decrement stock for sold items
        setStatus('success');
        setSoundPaymentId(null);
      }
    } catch (e) {
      console.error('Poll error:', e);
    }
  };
  
  const interval = setInterval(pollDisplay, 1000);
  return () => clearInterval(interval);
}, [status, storeId]);
// Poll for Xaman payment status
useEffect(() => {
if (status !== 'qr' || !xamanPaymentId) return;
const pollInterval = setInterval(async () => {
try {
const res = await fetch(`https://api.dltpays.com/api/v1/xaman/payment/poll/${xamanPaymentId}`);
const data = await res.json();
if (data.status === 'signed') {
          setTxHash(data.tx_hash);
          setReceiptId(data.receipt_id);
          setLastOrder([...cart]);
          decrementStockForCart(cart); // Decrement stock for sold items
          setStatus('success');
paymentInProgressRef.current = false;
if (storeId) updateCustomerDisplay(storeId, storeName, cart, getPaymentAmount(), 'success', null, tipAmount, tipsEnabled, walletAddress || undefined);
if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
} else if (data.status === 'expired' || data.status === 'cancelled' || data.status === 'failed') {
  setError(data.message || `Payment ${data.status}`);
  setStatus('idle');
  paymentInProgressRef.current = false;
  if (storeId) updateCustomerDisplay(storeId, storeName, cart, getPaymentAmount(), 'idle', null, 0, tipsEnabled, walletAddress || undefined);
}
    } catch (err) {
console.error('Poll error:', err);
    }
  }, 2000);
return () => clearInterval(pollInterval);
}, [status, xamanPaymentId, cart]);
// Cart calculations
const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
const customAmount = parseFloat(manualAmount) || 0;

// Auto-start for first time
useEffect(() => {
  if (storeId && !loadingProducts) {
    const hasSeenTour = localStorage.getItem(`take_payment_tour_completed_${storeId}`);
    if (!hasSeenTour) {
      setTimeout(() => setRunTour(true), 1500);
    }
  }
}, [storeId, loadingProducts]);

// Fetch live conversion rate
useEffect(() => {
  const fetchRate = async () => {
    const amount = getPaymentAmount();
    
    try {
      const res = await fetch(`https://api.dltpays.com/convert/gbp-to-rlusd?amount=${Math.max(amount, 1)}&capture=true`);
      if (!res.ok) throw new Error('API error');
      const data = await res.json();
      if (data.success) {
        setLiveRate(data.rate.gbp_to_rlusd);
        setRlusdAmount(data.rlusd);
        setPriceAge(data.price_age_ms);
      }
    } catch (err) {
      // Fallback: estimate rate
      setLiveRate(1.35);
      setRlusdAmount(Math.max(amount, 1) * 1.35);
      setPriceAge(0);
    }
  };

  if (status === 'idle' || status === 'qr') {
    fetchRate();
    const interval = setInterval(fetchRate, 10000);
    return () => clearInterval(interval);
  }
}, [cartTotal, customAmount, tipAmount, status]);

// Sync cart to customer display
useEffect(() => {
if (storeId && status === 'idle' && cart.length > 0) {
updateCustomerDisplay(storeId, storeName, cart, cartTotal + tipAmount, 'idle', null, tipAmount, tipsEnabled, walletAddress || undefined);
  } else if (storeId && status === 'idle' && cart.length === 0) {
clearCustomerDisplay(storeId, storeName);
  }
}, [cart, cartTotal, storeId, storeName, status, tipAmount, tipsEnabled]);

// Fetch receipt data when receiptId is set (for conversion rate display)
useEffect(() => {
  console.log('Receipt useEffect:', { receiptId, status });
  if (!receiptId || status !== 'success') return;
  console.log('Fetching receipt data for:', receiptId);
  
  const fetchReceipt = async () => {
    try {
      const res = await fetch(`${API_URL}/receipts/${receiptId}`);
      const data = await res.json();
      if (data.success && data.receipt) {
        setConversionRate(data.receipt.conversion_rate);
        if (data.receipt.amount_rlusd) {
          setRlusdAmount(data.receipt.amount_rlusd);
        }
      }
    } catch (e) {
      console.error('Failed to fetch receipt:', e);
    }
  };
  
  fetchReceipt();
}, [receiptId, status]);

// Poll for tip changes and customer confirmation from display
useEffect(() => {
if (!storeId || status !== 'idle') return;
if (cart.length === 0 && customAmount === 0) return;

const pollDisplay = async () => {
try {
const res = await fetch(`${API_URL}/display/${storeId}`);
if (!res.ok) return;
const data = await res.json();

// Sync tip from display
if (data.tip !== undefined && data.tip !== tipAmount) {
setTipAmount(data.tip);
      }

// Check if display completed payment (NFC tap-to-pay)
if (data.status === 'success') {
decrementStockForCart(cart); // Decrement stock for sold items
setStatus('success');
setTxHash(data.tx_hash || null);
return;
      }

// Customer confirmed - trigger payment
if (data.customer_confirmed && status === 'idle') {
// Reset flag to prevent double-trigger
fetch(`${API_URL}/display/${storeId}/reset-confirm`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' }
  }).catch(() => {});

// FIX: Use data.total directly - it already contains subtotal + tip
// The API calculates this correctly in the /tip endpoint
const totalFromAPI = data.total;

console.log('Customer confirmed payment:', {
  subtotal: data.subtotal,
  tip: data.tip,
  total: data.total,
  totalFromAPI
});

setTipAmount(data.tip || 0);
showQRPayment(totalFromAPI);
}
    } catch (err) {}
  };

const interval = setInterval(pollDisplay, 1000);
return () => clearInterval(interval);
}, [storeId, status, tipAmount, cart.length, customAmount]);

const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
// Add to cart (increment if exists)
const addToCart = (product: Product) => {
setCart(prev => {
const existing = prev.find(item => item.product_id === product.product_id);
if (existing) {
return prev.map(item =>
item.product_id === product.product_id
? { ...item, quantity: item.quantity + 1 }
: item
        );
      }
return [...prev, { ...product, quantity: 1 }];
    });
// Haptic feedback
if (navigator.vibrate) navigator.vibrate(10);
  };

  // Handle barcode scan - lookup product and add to cart
  const handleBarcodeScan = async (barcode: string, format: string) => {
    setShowBarcodeScanner(false);

    if (!storeId || !walletAddress) return;

    try {
      const res = await fetch(
        `${API_URL}/store/${storeId}/products/barcode/${encodeURIComponent(barcode)}?wallet_address=${walletAddress}`
      );
      const data = await res.json();

      if (data.success && data.product) {
        // Add product to cart
        addToCart(data.product);
        // Success feedback
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
      } else {
        // Product not found - show error
        setError(`No product found with barcode: ${barcode}`);
        setTimeout(() => setError(null), 3000);
      }
    } catch (err) {
      console.error('Barcode lookup error:', err);
      setError('Failed to lookup barcode');
      setTimeout(() => setError(null), 3000);
    }
  };

// Remove from cart
const removeFromCart = (productId: string) => {
setCart(prev => prev.filter(item => item.product_id !== productId));
  };
// Decrease quantity
const decreaseQuantity = (productId: string) => {
setCart(prev => {
const existing = prev.find(item => item.product_id === productId);
if (existing && existing.quantity > 1) {
return prev.map(item =>
item.product_id === productId
? { ...item, quantity: item.quantity - 1 }
: item
        );
      }
return prev.filter(item => item.product_id !== productId);
    });
  };
// Clear cart
const clearCart = () => {
setCart([]);
setManualAmount('');
if (storeId) clearCustomerDisplay(storeId, storeName);
  };
// Get payment amount
const getPaymentAmount = () => {
if (cart.length > 0) {
return cartTotal + tipAmount;
  }
return customAmount + tipAmount;
};
// Handle number pad input
const handleNumberInput = (num: string) => {
if (num === 'clear') {
setManualAmount('');
return;
    }
if (num === 'back') {
setManualAmount(prev => prev.slice(0, -1));
return;
    }
if (num === '.' && manualAmount.includes('.')) return;
if (manualAmount.includes('.') && manualAmount.split('.')[1]?.length >= 2) return;
setManualAmount(prev => prev + num);
  };
// Sync manual amount to customer display
useEffect(() => {
if (storeId && status === 'idle' && showManualEntry && customAmount > 0) {
const manualCart = [{ name: 'Payment', quantity: 1, price: customAmount, emoji: 'üí∑' }];
updateCustomerDisplay(storeId, storeName, manualCart, customAmount + tipAmount, 'idle', null, tipAmount, tipsEnabled, walletAddress || undefined);
  }
}, [customAmount, storeId, storeName, status, showManualEntry, tipAmount, tipsEnabled]);

// Show QR Payment (Xaman)
const showQRPayment = async (overrideAmount?: number) => {
const gbpAmount = overrideAmount ?? getPaymentAmount();
console.log('showQRPayment called with:', { 
  overrideAmount, 
  gbpAmount, 
  tipAmount, 
  cartTotal, 
  customAmount,
  getPaymentAmount: getPaymentAmount()
});

if (gbpAmount <= 0) {
setError('Please add items or enter an amount');
return;
  }

setStatus('qr');
setError(null);

// Convert GBP to RLUSD
const amount = await convertGBPtoRLUSD(gbpAmount);

console.log('Creating Xaman payment:', { gbpAmount, rlusdAmount: amount });

// Start NFC scan in background (Android only)
if ('NDEFReader' in window) {
startNFCScan(amount);
  }

// Don't update display yet - wait for QR code
try {
// Build items array for receipt
const paymentItems = cart.length > 0 
  ? [
      ...cart.map(item => ({
        product_id: item.product_id,
        name: item.name,
        quantity: item.quantity,
        unit_price: item.price,
        line_total: item.price * item.quantity
      })),
      ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
    ]
  : [
      { name: 'Payment', quantity: 1, unit_price: gbpAmount - tipAmount, line_total: gbpAmount - tipAmount },
      ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
    ];

console.log('üßæ QR Payment items being sent:', paymentItems);

const res = await fetch('https://api.dltpays.com/api/v1/xaman/payment', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
amount: amount,
vendor_wallet: walletAddress,
store_id: storeId,
store_name: storeName,
items: paymentItems,
amount_gbp: gbpAmount
      })
    });
const data = await res.json();
if (data.success) {
setXamanQR(data.qr_png);
setXamanPaymentId(data.payment_id);
const displayCart = cart.length > 0 
  ? cart 
  : [{ name: 'Payment', quantity: 1, price: customAmount || gbpAmount, emoji: 'üí∑' }];
if (storeId) updateCustomerDisplay(storeId, storeName, displayCart, gbpAmount, 'qr', data.qr_png, tipAmount, tipsEnabled, walletAddress || undefined);
}else {
setError(data.error || 'Failed to create payment request');
setStatus('idle');
    }
  } catch (err: any) {
setError('Failed to create payment request');
setStatus('idle');
  }
};

// Start NFC Payment
const startNFCPayment = () => {
const amount = getPaymentAmount();
if (amount <= 0) {
setError('Please add items or enter an amount');
return;
    }
setStatus('waiting');
setError(null);
if (storeId) updateCustomerDisplay(storeId, storeName, cart, amount, 'ready', null, tipAmount, tipsEnabled, walletAddress || undefined);
// Try Web NFC if available (Android Chrome)
if ('NDEFReader' in window) {
startNFCScan(amount);
    }
  };
// Web NFC scan (Android only)
const startNFCScan = async (paymentAmount: number) => {
if (nfcScanActiveRef.current) {
  console.log('NFC scan already active, skipping');
  return;
}
nfcScanActiveRef.current = true;
try {
const ndef = new (window as any).NDEFReader();
await ndef.scan();
let lastReadTime = 0;
ndef.addEventListener('reading', async ({ serialNumber }: { serialNumber: string }) => {
  // Debounce: ignore reads within 5 seconds of last read
  const now = Date.now();
  if (now - lastReadTime < 5000) {
    console.log('NFC read debounced');
    return;
  }
  lastReadTime = now;
  setLastUID(serialNumber);
  await processPayment(serialNumber, paymentAmount);
      });
ndef.addEventListener('readingerror', () => {
setError('Could not read NFC tag');
setStatus('idle');
      });
    } catch (err: any) {
console.log('Web NFC not available, using manual mode');
    }
  };
// Manual UID entry (for iOS/demo)
const handleManualUID = async () => {
const amount = getPaymentAmount();
const uid = prompt('Enter customer NFC card UID:', '04:5B:07:0A:FD:75:80');
if (uid) {
setLastUID(uid);
await processPayment(uid, amount);
    }
  };
// Process the payment
const processPayment = async (uid: string, paymentAmount: number) => {
// Prevent duplicate payments (ref is instant, status can have race conditions)
if (paymentInProgressRef.current) {
  console.log('Payment already in progress, skipping');
  return;
}
paymentInProgressRef.current = true;
setStatus('processing');
if (storeId) updateCustomerDisplay(storeId, storeName, cart, paymentAmount, 'processing', null, tipAmount, tipsEnabled, walletAddress || undefined);
try {
// Build items array from cart
const items = cart.length > 0 
? [
...cart.map(item => ({
product_id: item.product_id,
name: item.name,
quantity: item.quantity,
unit_price: item.price,
line_total: item.price * item.quantity
      })),
...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
    ]
: [
    { name: 'Payment', quantity: 1, unit_price: paymentAmount - tipAmount, line_total: paymentAmount - tipAmount },
    ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
  ]
const paymentPayload = {
    uid: uid,
    amount: paymentAmount,
    vendor_wallet: walletAddress,
    store_name: storeName,
    store_id: storeId,
    items: items,
    staff_id: activeStaff?.staff_id || null,
    staff_name: activeStaff?.name || null,
    payment_id: `pay_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`
};
console.log('üí≥ Payment payload:', paymentPayload);
console.log('üí∞ Tip amount state:', tipAmount);
console.log('üßæ Items being sent:', items);

const response = await fetch(`${API_URL}/nfc/payment`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(paymentPayload)
});
const data = await response.json();
if (data.success) {
setTxHash(data.tx_hash);
setReceiptId(data.receipt_id);
setLastOrder([...cart]);
decrementStockForCart(cart); // Decrement stock for sold items
setStatus('success');
if (storeId) updateCustomerDisplay(storeId, storeName, cart, paymentAmount, 'success', null, tipAmount, tipsEnabled, walletAddress || undefined);
// Haptic + sound feedback
if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
} else {
  // Only show error if not already successful (handles race conditions)
  if (status !== 'success') {
    if (data.error === 'NO_SIGNER_AUTHORITY') {
      setShowAutoSignModal(true);
setStatus('idle');
paymentInProgressRef.current = false;
return;
    } else {
      setError(data.error || 'Payment failed');
    }
    setStatus('error');
    paymentInProgressRef.current = false;
    if (storeId) updateCustomerDisplay(storeId, storeName, cart, paymentAmount, 'error', null, tipAmount, tipsEnabled, walletAddress || undefined);
  }
      }
    } catch (err: any) {
  // Only show error if not already successful (handles race conditions)
  if (status !== 'success') {
    setError(err.message || 'Payment failed');
    setStatus('error');
    if (storeId) updateCustomerDisplay(storeId, storeName, cart, paymentAmount, 'error', null, tipAmount, tipsEnabled, walletAddress || undefined);
  }
    }
  };
// Reset for next payment
const resetPayment = () => {
setStatus('idle');
setCart([]);
setManualAmount('');
setTipAmount(0);
setLastUID(null);
setTxHash(null);
setQrPaymentUrl(null);
setXamanQR(null);
setXamanPaymentId(null);
setError(null);
nfcScanActiveRef.current = false;
paymentInProgressRef.current = false;
setShowManualEntry(false);
if (storeId) clearCustomerDisplay(storeId, storeName);
};

// Upload store logo
const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;

  if (file.size > 5 * 1024 * 1024) {
    setError('Image must be less than 5MB');
    return;
  }

  if (!file.type.startsWith('image/')) {
    setError('Please upload an image file');
    return;
  }

  setUploadingLogo(true);
  setError(null);

  try {
    // Upload directly to Cloudinary with unsigned preset
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'store_logos'); // Your unsigned preset name

    const uploadRes = await fetch('https://tokencanvas.io/api/cloudinary/upload', {
  method: 'POST',
  body: formData
});

    const uploadData = await uploadRes.json();
    
    if (!uploadData.secure_url) {
      throw new Error(uploadData.error?.message || 'Upload failed');
    }

    const logoUrl = uploadData.secure_url;

    // Save URL to your backend
    const res = await fetch(`${API_URL}/store/${storeId}/logo`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        logo_url: logoUrl,
        wallet_address: walletAddress
      })
    });

    const data = await res.json();
    if (data.success) {
      setStoreLogo(logoUrl);
      // Update session storage
      const storeData = safeGetItem('storeData');
      if (storeData) {
        const store = JSON.parse(storeData);
        store.logo_url = logoUrl;
        safeSetItem('storeData', JSON.stringify(store));
      }
      setShowLogoUpload(false);
    } else {
      setError('Failed to save logo');
    }
  } catch (err: any) {
    console.error('Upload error:', err);
    setError(err.message || 'Failed to upload logo');
  }
  setUploadingLogo(false);
};

// Remove store logo
const removeLogo = async () => {
setUploadingLogo(true);
try {
const res = await fetch(`${API_URL}/store/${storeId}/logo`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
logo_url: null,
wallet_address: walletAddress
      })
    });
if (res.ok) {
setStoreLogo(null);
const storeData = safeGetItem('storeData');
if (storeData) {
const store = JSON.parse(storeData);
store.logo_url = null;
safeSetItem('storeData', JSON.stringify(store));
      }
setShowLogoUpload(false);
    }
  } catch (err) {
setError('Failed to remove logo');
  }
setUploadingLogo(false);
};

// Setup wallet for RLUSD payments
const setupWalletForPayments = async () => {
  setSettingUpWallet(true);
  try {
    const loginMethod = safeGetItem('loginMethod');
    
    if (loginMethod === 'web3auth') {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth || !web3auth.provider) {
        setError('Please sign in again to set up your wallet');
        setSettingUpWallet(false);
        return;
      }
      
      const trustlineTx = {
        TransactionType: 'TrustSet',
        Account: walletAddress,
        LimitAmount: {
          currency: '524C555344000000000000000000000000000000',
          issuer: 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De',
          value: '1000000',
        },
      };
      
      await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: trustlineTx },
      });
      
      setWalletReady(true);
    } else {
      // For Xaman/Crossmark, redirect to dashboard
      router.push('/affiliate-dashboard?setup=wallet');
    }
  } catch (err: any) {
    console.error('Wallet setup error:', err);
    setError(err.message || 'Failed to set up wallet');
  }
  setSettingUpWallet(false);
};

// Group products by category
const groupedProducts = products.reduce((acc, product) => {
const category = product.category || 'Other';
if (!acc[category]) acc[category] = [];
acc[category].push(product);
return acc;
  }, {} as Record<string, Product[]>);
// Get all categories
const categories = Object.keys(groupedProducts);
// Filter products by search
const filteredProducts = searchQuery
? products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()))
: activeCategory
? groupedProducts[activeCategory] || []
: products;

// Low stock alerts - products with track_stock enabled that are at or below threshold
const lowStockProducts = products.filter(p =>
  p.track_stock &&
  typeof p.stock_quantity === 'number' &&
  typeof p.low_stock_threshold === 'number' &&
  p.stock_quantity <= p.low_stock_threshold &&
  p.stock_quantity > 0
);

// Out of stock products
const outOfStockProducts = products.filter(p =>
  p.track_stock &&
  typeof p.stock_quantity === 'number' &&
  p.stock_quantity <= 0
);

// Helper to check if product is low stock
const isLowStock = (product: Product) =>
  product.track_stock &&
  typeof product.stock_quantity === 'number' &&
  typeof product.low_stock_threshold === 'number' &&
  product.stock_quantity <= product.low_stock_threshold &&
  product.stock_quantity > 0;

// Helper to check if product is out of stock
const isOutOfStock = (product: Product) =>
  product.track_stock &&
  typeof product.stock_quantity === 'number' &&
  product.stock_quantity <= 0;

// =========================================================================
// RENDER
// =========================================================================
return (
  <>
    <NebulaBackground opacity={0.3} />
    <div className="min-h-screen bg-transparent text-white font-sans overflow-x-hidden flex flex-col">
{/* Header */}
<TakePaymentHeader
  storeId={storeId}
  walletAddress={walletAddress}
  storeName={storeName}
  storeLogo={storeLogo}
  activeStaff={activeStaff}
  onStartTour={() => {
    setRunTour(false);
    setTimeout(() => setRunTour(true), 100);
  }}
  onShowLogoUpload={() => setShowLogoUpload(true)}
  onShowStaffModal={() => setShowStaffModal(true)}
  onShowPendingPayments={() => setShowPendingPayments(true)}
  onShowProductsManager={() => setShowProductsManager(true)}
  onStaffChange={(staff) => setActiveStaff(staff)}
/>

<TakePaymentTour 
  run={runTour} 
  onComplete={() => {
    setRunTour(false);
    if (storeId) {
      localStorage.setItem(`take_payment_tour_completed_${storeId}`, 'true');
    }
  }}
/>

{/* Wallet Setup Banner */}
{walletReady === false && (
  <div className="bg-amber-500/10 border-b border-amber-500/30 px-4 py-3">
    <div className="max-w-lg mx-auto sm:max-w-none flex items-center justify-between gap-3">
      <div className="flex items-center gap-2">
        <span className="text-amber-400">‚ö†Ô∏è</span>
        <p className="text-amber-400 text-sm">Wallet not set up to receive payments</p>
      </div>
      <button
        onClick={setupWalletForPayments}
        disabled={settingUpWallet}
        className="bg-amber-500 hover:bg-amber-400 text-black text-sm font-semibold px-4 py-1.5 rounded-lg transition disabled:opacity-50"
      >
        {settingUpWallet ? 'Setting up...' : 'Set Up Now'}
      </button>
    </div>
  </div>
)}

{/* Logo Upload Modal */}
{showLogoUpload && (
<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
<div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm">
<h3 className="text-lg font-bold mb-4">Store Logo</h3>
{storeLogo && (
<div className="mb-4 flex justify-center">
<img src={storeLogo} alt="Current logo" className="w-24 h-24 rounded-xl object-cover" />
</div>
      )}
<label className="block mb-4">
<div className="bg-zinc-800 border-2 border-dashed border-zinc-700 hover:border-emerald-500 rounded-xl p-6 text-center cursor-pointer transition">
{uploadingLogo ? (
<div className="flex flex-col items-center">
<div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mb-2"></div>
<p className="text-zinc-400 text-sm">Uploading...</p>
</div>
          ) : (
<>
<svg className="w-8 h-8 text-zinc-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
</svg>
<p className="text-zinc-400 text-sm">Click to upload image</p>
<p className="text-zinc-600 text-xs mt-1">Max 5MB</p>
</>
          )}
</div>
<input
type="file"
accept="image/*"
onChange={handleLogoUpload}
className="hidden"
disabled={uploadingLogo}
/>
</label>
<div className="flex gap-3">
{storeLogo && (
<button
onClick={removeLogo}
disabled={uploadingLogo}
className="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-3 rounded-xl transition disabled:opacity-50"
>
            Remove
</button>
        )}
<button
onClick={() => setShowLogoUpload(false)}
className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-3 rounded-xl transition"
>
{storeLogo ? 'Done' : 'Cancel'}
</button>
</div>
</div>
</div>
)}
{/* Products Manager Modal */}
{showProductsManager && storeId && walletAddress && (
<div className="fixed inset-0 bg-black/90 z-50 overflow-y-auto">
<div className="min-h-screen flex flex-col">
<div className="sticky top-0 bg-[#0a0a0a] p-4 border-b border-zinc-800 flex items-center justify-between z-10">
<h2 className="text-xl font-bold">Manage Products</h2>
<button
onClick={() => {
setShowProductsManager(false);
fetchProducts();
                }}
className="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-lg transition"
>
                Done
</button>
</div>
<div className="p-4 flex-1">
<ProductsManager storeId={storeId} walletAddress={walletAddress} />
</div>
{/* Live Conversion Widget - Shows actual payment amount */}
<div className="px-4 pb-6 flex justify-center">
  <LiveConversionWidget 
    initialGbpAmount={getPaymentAmount() > 0 ? getPaymentAmount() : 1} 
    compact={true} 
    showCompliance={false} 
  />
</div>

{/* YAOFUS Pioneers Badge - Footer */}
<footer className="py-6 flex flex-col items-center gap-1">
  <span className="text-zinc-500 text-[10px] font-medium tracking-wider">CATALOG</span>
  <span className="text-base font-extrabold tracking-widest">
    <span className="text-emerald-500">Y</span>
    <span className="text-green-500">A</span>
    <span className="text-blue-500">O</span>
    <span className="text-indigo-500">F</span>
    <span className="text-violet-500">U</span>
    <span className="text-purple-500">S</span>
  </span>
  <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">PRODUCTS</span>
  <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
    <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
    <span>Powered by YesAllOfUs</span>
  </div>
</footer>
</div>
</div>
      )}
<main className="w-full max-w-7xl mx-auto px-2 sm:px-4 lg:px-6 lg:py-8 flex-1">

{/* ============================================================= */}
{/* IDLE STATE - Three Column Layout using CSS Grid */}
{/* ============================================================= */}
{status === 'idle' && (
<>
  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    {/* LEFT COLUMN - Products */}
    <div>
      
      {/* Mobile Amount Display - Only show on mobile */}
      <div className="lg:hidden py-8 text-center">
        <p className="text-zinc-500 text-sm mb-1">
          {cartCount > 0 ? `${cartCount} item${cartCount > 1 ? 's' : ''}` : 'Total'}
        </p>
        <div className="text-5xl font-bold tracking-tight">
          ¬£{showManualEntry ? (manualAmount || '0.00') : cartTotal.toFixed(2)}
        </div>
      </div>

      {/* Error */}
      {error && (
        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-4">
          <p className="text-red-400 text-sm">{error}</p>
        </div>
      )}

      {/* Low Stock Alert Banner */}
      {(lowStockProducts.length > 0 || outOfStockProducts.length > 0) && (
        <div className={`rounded-xl p-3 mb-4 flex items-center gap-3 ${
          outOfStockProducts.length > 0
            ? 'bg-red-500/10 border border-red-500/30'
            : 'bg-amber-500/10 border border-amber-500/30'
        }`}>
          <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
            outOfStockProducts.length > 0 ? 'bg-red-500/20' : 'bg-amber-500/20'
          }`}>
            <svg className={`w-4 h-4 ${outOfStockProducts.length > 0 ? 'text-red-400' : 'text-amber-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div className="flex-1 min-w-0">
            {outOfStockProducts.length > 0 && (
              <p className="text-red-400 text-sm font-medium">
                {outOfStockProducts.length} item{outOfStockProducts.length > 1 ? 's' : ''} out of stock
              </p>
            )}
            {lowStockProducts.length > 0 && (
              <p className="text-amber-400 text-sm">
                {lowStockProducts.length} item{lowStockProducts.length > 1 ? 's' : ''} running low
              </p>
            )}
          </div>
          <button
            onClick={() => setShowProductsManager(true)}
            className="text-xs text-zinc-400 hover:text-white px-2 py-1 bg-zinc-800 rounded-lg transition flex-shrink-0"
          >
            Manage
          </button>
        </div>
      )}

      {/* Products Grid or Manual Entry */}
      {!showManualEntry ? (
        <>
          {/* Products */}
          <div id="tp-products-area">
            {loadingProducts ? (
              <div className="text-center py-12">
                <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p className="text-zinc-500">Loading products...</p>
              </div>
            ) : products.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üì¶</div>
                <p className="text-zinc-400 mb-2">No products yet</p>
                <button
                  onClick={() => setShowProductsManager(true)}
                  className="text-emerald-400 hover:text-emerald-300 font-medium"
                >
                  + Add your first product
                </button>
              </div>
            ) : (
              <div className="mb-6">
                {/* Search Bar with Barcode Scan */}
                <div className="mb-4 flex gap-2">
                  <div className="relative flex-1">
                    <input
                      id="tp-search-bar"
                      type="text"
                      placeholder="Search products..."
                      value={searchQuery}
                      onChange={(e) => {
                        setSearchQuery(e.target.value);
                        setActiveCategory(null);
                      }}
                      className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 pr-12 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500"
                    />
                    <button
                      onClick={() => setShowProductsGrid(!showProductsGrid)}
                      className="absolute right-3 top-1/2 -translate-y-1/2 p-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition"
                      title={showProductsGrid ? 'Collapse products' : 'Expand products'}
                    >
                      <svg
                        className={`w-4 h-4 text-zinc-400 transition-transform ${showProductsGrid ? '' : 'rotate-180'}`}
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={showProductsGrid ? "M19 9l-7 7-7-7" : "M5 15l7-7 7 7"} />
                      </svg>
                    </button>
                  </div>
                  {/* Barcode Scan Button */}
                  <button
                    onClick={() => setShowBarcodeScanner(true)}
                    className="bg-zinc-900 border border-zinc-800 hover:border-emerald-500 rounded-xl px-4 py-3 transition flex items-center gap-2"
                    title="Scan barcode"
                  >
                    <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                    </svg>
                    <span className="hidden sm:inline text-zinc-400 text-sm">Scan</span>
                  </button>
                </div>

                {/* Repeat Last Order */}
                {lastOrder && lastOrder.length > 0 && cart.length === 0 && (
                  <button
                    onClick={() => setCart(lastOrder.map(item => ({ ...item })))}
                    className="w-full mb-4 bg-zinc-900 border border-zinc-800 hover:border-emerald-500 rounded-xl p-3 flex items-center justify-between transition"
                  >
                    <div className="flex items-center gap-3">
                      <span className="text-xl">üîÑ</span>
                      <div className="text-left">
                        <p className="text-sm font-medium">Repeat last order</p>
                        <p className="text-zinc-500 text-xs">
                          {lastOrder.length} item{lastOrder.length > 1 ? 's' : ''} ¬∑ ¬£{lastOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}
                        </p>
                      </div>
                    </div>
                    <svg className="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                )}

                {/* Category Tabs */}
                {!searchQuery && categories.length > 1 && (
                  <div className="flex gap-2 overflow-x-auto pb-3 mb-4 scrollbar-hide items-center">
                    <button
                      onClick={() => setActiveCategory(null)}
                      className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition active:scale-95 cursor-pointer ${
                        activeCategory === null
                          ? 'bg-emerald-500 text-black'
                          : 'bg-zinc-800 text-zinc-400 hover:text-white'
                      }`}
                    >
                      All
                    </button>
                    {categories.map((cat) => (
                      <button
                        key={cat}
                        onClick={() => setActiveCategory(cat)}
                        className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition active:scale-95 cursor-pointer ${
                          activeCategory === cat
                            ? 'bg-emerald-500 text-black'
                            : 'bg-zinc-800 text-zinc-400 hover:text-white'
                        }`}
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                )}

                {/* Products Grid */}
                <div id="tp-products-grid" className={`grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-2 xl:grid-cols-3 gap-3 items-end max-h-[calc(100vh-170px)] overflow-y-auto overflow-x-hidden ${!showProductsGrid ? 'hidden' : ''}`}>
                  {filteredProducts.map((product) => {
                    const inCart = cart.find(item => item.product_id === product.product_id);
                    const productOutOfStock = isOutOfStock(product);
                    const productLowStock = isLowStock(product);
                    return (
                      <button
                        key={product.product_id}
                        onClick={() => !productOutOfStock && addToCart(product)}
                        disabled={productOutOfStock}
                        className={`relative bg-zinc-900 border rounded-2xl p-3 text-center transition-all flex flex-col justify-between min-h-[120px] ${
                          productOutOfStock
                            ? 'border-red-500/50 opacity-60 cursor-not-allowed'
                            : productLowStock
                            ? 'border-amber-500/50 hover:bg-zinc-800 active:scale-95 cursor-pointer'
                            : inCart
                            ? 'border-emerald-500 bg-emerald-500/10 hover:bg-zinc-800 active:scale-95 cursor-pointer'
                            : 'border-zinc-800 hover:bg-zinc-800 active:scale-95 cursor-pointer'
                        }`}
                      >
                        {/* Cart quantity badge */}
                        {inCart && !productOutOfStock && (
                          <div className="absolute -top-2 -right-2 w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center text-xs font-bold text-black z-10">
                            {inCart.quantity}
                          </div>
                        )}
                        {/* Out of stock badge */}
                        {productOutOfStock && (
                          <div className="absolute -top-2 -right-2 px-2 py-0.5 bg-red-500 rounded-full text-[10px] font-bold text-white z-10">
                            OUT
                          </div>
                        )}
                        {/* Low stock badge */}
                        {productLowStock && !productOutOfStock && (
                          <div className="absolute -top-2 -left-2 px-1.5 py-0.5 bg-amber-500 rounded-full text-[10px] font-bold text-black z-10">
                            {product.stock_quantity}
                          </div>
                        )}
                        <div className="w-full flex justify-center mb-2">
                          <div className="w-10 h-10 flex items-center justify-center">
                            {product.image_url ? (
                              <img src={product.image_url} alt={product.name} className={`w-10 h-10 rounded-lg object-cover ${productOutOfStock ? 'grayscale' : ''}`} />
                            ) : product.icon_id && getIconById(product.icon_id) ? (
                              <div className={`w-8 h-8 ${productOutOfStock ? 'text-zinc-500' : 'text-emerald-400'}`} dangerouslySetInnerHTML={{ __html: getIconById(product.icon_id)!.svg }} />
                            ) : (
                              <span className={`text-2xl ${productOutOfStock ? 'grayscale opacity-50' : ''}`}>{getProductEmoji(product)}</span>
                            )}
                          </div>
                        </div>
                        <div className="flex-1 flex flex-col justify-between">
                          <p className={`text-xs font-medium truncate mb-1 ${productOutOfStock ? 'text-zinc-500' : ''}`}>{product.name}</p>
                          <p className={`text-sm font-semibold ${productOutOfStock ? 'text-zinc-500' : 'text-emerald-400'}`}>¬£{product.price.toFixed(2)}</p>
                        </div>
                      </button>
                    );
                  })}
                </div>

                {/* No results */}
                {filteredProducts.length === 0 && searchQuery && (
                  <div className="text-center py-8">
                    <p className="text-zinc-500">No products match "{searchQuery}"</p>
                  </div>
                )}
              </div>
            )}
          </div>
        </>
      ) : (
        /* Manual Amount Entry */
        <div className="mb-6">
          <div className="grid grid-cols-3 gap-3 mb-4">
            {['1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '0', 'back'].map((num) => (
              <button
                key={num}
                onClick={() => handleNumberInput(num)}
                className="bg-zinc-900 hover:bg-zinc-800 active:bg-zinc-700 border border-zinc-800 text-white text-2xl font-semibold py-5 rounded-2xl transition active:scale-95 cursor-pointer"
              >
                {num === 'back' ? '‚å´' : num}
              </button>
            ))}
          </div>
          <button
            onClick={() => {
              setShowManualEntry(false);
              setManualAmount('');
            }}
            className="w-full text-zinc-500 hover:text-white text-sm py-2 transition"
          >
            ‚Üê Back to products
          </button>
        </div>
      )}
    </div>

    {/* MIDDLE COLUMN - Checkout & Payment */}
    <div className="lg:sticky lg:top-20 lg:self-start">
      
      {/* Desktop Amount Display */}
      <div id="tp-amount-display" className="hidden lg:block bg-zinc-900/50 border border-zinc-800 rounded-2xl p-6 mb-4">
        <p className="text-zinc-500 text-sm mb-2 text-center">
          {cartCount > 0 ? `${cartCount} item${cartCount > 1 ? 's' : ''}` : 'Total'}
        </p>
        <div className="text-5xl font-bold tracking-tight text-center">
          ¬£{showManualEntry ? (manualAmount || '0.00') : cartTotal.toFixed(2)}
        </div>
      </div>

      {/* Tip Section */}
      <div id="tp-tips-section" className="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 mb-4">
        <div className="flex items-center justify-between mb-3">
          <p className="text-zinc-400 text-sm font-medium">Add Tip</p>
          <button
            type="button"
            onClick={() => {
              setTipsEnabled(!tipsEnabled);
              if (tipsEnabled) setTipAmount(0);
            }}
            className={`relative w-11 h-6 rounded-full transition-colors active:scale-95 cursor-pointer ${
              tipsEnabled ? 'bg-emerald-500' : 'bg-zinc-700'
            }`}
          >
            <span
              className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                tipsEnabled ? 'translate-x-5' : 'translate-x-0'
              }`}
            />
          </button>
        </div>
        
        {tipsEnabled && (
          <>
            <div className="grid grid-cols-2 gap-2 mb-2">
              {[0, 10, 15, 20].map((percent) => {
                const base = cart.length > 0 ? cartTotal : customAmount;
                const tipValue = percent === 0 ? 0 : base * percent / 100;
                const label = percent === 0 ? 'No Tip' : `${percent}%`;
                return (
                  <button
                    key={percent}
                    onClick={() => setTipAmount(tipValue)}
                    className={`py-2.5 rounded-xl text-sm font-medium cursor-pointer text-center transition ${
                      tipAmount === tipValue
                        ? 'bg-emerald-500 text-black'
                        : 'bg-zinc-800 text-white hover:bg-zinc-700'
                    }`}
                  >
                    {label}
                    {percent > 0 && <span className="block text-xs opacity-80">¬£{tipValue.toFixed(2)}</span>}
                  </button>
                );
              })}
            </div>
            <button
              onClick={() => setShowCustomTipModal(true)}
              className="w-full py-2.5 rounded-xl text-sm font-medium cursor-pointer text-center bg-zinc-800 text-white hover:bg-zinc-700 transition"
            >
              Custom Amount
            </button>
            {tipAmount > 0 && (
              <div className="mt-3 pt-3 border-t border-zinc-800 flex justify-between items-center">
                <span className="text-zinc-400 text-sm">Tip</span>
                <span className="text-emerald-400 font-bold">¬£{tipAmount.toFixed(2)}</span>
              </div>
            )}
          </>
        )}
      </div>

      {/* Total */}
      {(cart.length > 0 || customAmount > 0 || tipAmount > 0) && (
        <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 mb-4">
          <div className="flex items-center justify-between">
            <span className="text-lg font-bold">Total</span>
            <span className="text-3xl font-bold text-emerald-400">¬£{getPaymentAmount().toFixed(2)}</span>
          </div>
        </div>
      )}

      {/* Payment Buttons */}
      <div className="space-y-3">
        <button
          id="tp-pay-btn"
          onClick={() => showQRPayment()}
          disabled={getPaymentAmount() <= 0}
          className="w-full bg-emerald-500 hover:bg-emerald-400 disabled:bg-zinc-800 disabled:text-zinc-600 text-black font-bold text-lg py-5 rounded-2xl transition flex items-center justify-center gap-3 cursor-pointer disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25"
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          Pay ¬£{getPaymentAmount().toFixed(2)}
        </button>

        {getPaymentAmount() > 0 && storeId && walletAddress && (
          <SoundPayButton
            storeId={storeId}
            storeName={storeName}
            vendorWallet={walletAddress}
            amount={cart.length > 0 ? cartTotal : customAmount}
            tipAmount={tipAmount}
            items={cart.length > 0 ? cart.map(item => ({
              name: item.name,
              quantity: item.quantity,
              unit_price: item.price,
              emoji: item.emoji || getProductEmoji(item)
            })) : undefined}
            size="w-full h-28"
            onPaymentCreated={(paymentId) => {
              setSoundPaymentId(paymentId);
              setStatus('soundpay');
              setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'instant' });
              }, 50);
            }}
            onError={(error) => {
              setError(error);
            }}
          />
        )}

        {getPaymentAmount() > 0 && (
          <button
            id="tp-send-link-btn"
            onClick={() => setShowSendPaymentLink(true)}
            className="w-full h-14 relative overflow-hidden rounded-xl transition active:scale-95 cursor-pointer"
          >
            <video autoPlay loop muted playsInline className="absolute inset-0 w-full h-full object-cover">
              <source src="/star-space-overlay.webm" type="video/webm" />
            </video>
            <div className="absolute inset-0 bg-black/30" />
            <div className="relative z-10 flex items-center justify-center gap-2 h-full">
              <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              <span className="text-white font-medium">Send Payment Link</span>
            </div>
          </button>
        )}

        {!showManualEntry && (
          <button
            id="tp-manual-btn"
            onClick={() => setShowManualEntry(true)}
            className="w-full bg-zinc-900 hover:bg-zinc-800 active:bg-zinc-700 border border-zinc-800 text-zinc-400 hover:text-white font-medium py-3 rounded-xl transition cursor-pointer"
          >
            Enter amount manually
          </button>
        )}
      </div>
    </div>

    {/* RIGHT COLUMN - Cart */}
    <div className="lg:sticky lg:top-20 lg:self-start">
      {cart.length > 0 && (
        <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 mb-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="font-semibold">Cart</h3>
            <button onClick={clearCart} className="text-zinc-500 hover:text-red-400 text-sm transition">
              Clear
            </button>
          </div>
          <div className="space-y-2 max-h-64 overflow-y-auto">
            {cart.map((item) => (
              <div key={item.product_id} className="flex items-center justify-between py-2 border-b border-zinc-800 last:border-0">
                <div className="flex items-center gap-3">
                  <div className="flex items-center gap-1">
                    <button
                      onClick={() => decreaseQuantity(item.product_id)}
                      className="w-6 h-6 bg-zinc-800 hover:bg-zinc-700 rounded-full flex items-center justify-center text-sm transition"
                    >
                      ‚àí
                    </button>
                    <span className="w-6 text-center text-sm">{item.quantity}</span>
                    <button
                      onClick={() => addToCart(item)}
                      className="w-6 h-6 bg-zinc-800 hover:bg-zinc-700 rounded-full flex items-center justify-center text-sm transition"
                    >
                      +
                    </button>
                  </div>
                  <span className="text-zinc-300 text-sm">{item.name}</span>
                </div>
                <span className="text-zinc-400 text-sm">¬£{(item.price * item.quantity).toFixed(2)}</span>
              </div>
            ))}
          </div>
          <div className="flex items-center justify-between mt-3 pt-3 border-t border-zinc-700">
            <span className="font-semibold">Subtotal</span>
            <span className="text-xl font-bold text-emerald-400">¬£{cartTotal.toFixed(2)}</span>
          </div>
        </div>
      )}
      
      {cart.length === 0 && (
        <div className="hidden lg:block bg-zinc-900/30 border border-zinc-800 border-dashed rounded-2xl p-8 text-center">
          <div className="text-4xl mb-3">üõí</div>
          <p className="text-zinc-500 text-sm">Your cart is empty</p>
          <p className="text-zinc-600 text-xs mt-1">Add products to see them here</p>
        </div>
      )}
    </div>

  </div>

  {/* Statistics Cards - Same grid, perfectly aligned */}
  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
    
    {/* Revenue Card */}
    <div className="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4 flex items-center justify-center">
      <div className="flex items-center gap-3">
        <div className="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
          <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2" />
          </svg>
        </div>
        <div>
          <p className="text-zinc-500 text-sm">Revenue</p>
          <p className="text-2xl font-bold text-emerald-400">¬£{stats.totalRevenue.toFixed(2)}</p>
        </div>
      </div>
    </div>

    {/* Live Conversion Card */}
    <div className="order-first lg:order-none bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <img
            src="https://static.coingecko.com/s/coingecko-logo-8903d34ce19ca4be1c81f0db30e924154750d208683fad7ae6f2ce06c76d0a56.png"
            alt="CoinGecko"
            className="h-5 w-auto object-contain"
          />
          <span className="text-xs text-zinc-500">Live rate from CoinGecko Pro</span>
        </div>
        <div className="flex items-center gap-1.5">
          <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
          <span className="text-xs text-emerald-500 font-medium">LIVE</span>
        </div>
      </div>
      <div className="flex items-baseline justify-between">
        <span className="text-zinc-400 text-sm">Settlement amount</span>
        <div className="text-right">
          <span className="text-2xl font-bold text-white font-mono">
            {rlusdAmount ? rlusdAmount.toFixed(4) : '...'} <span className="text-emerald-400 text-lg">RLUSD</span>
          </span>
          {liveRate && (
            <p className="text-xs text-zinc-500 mt-1">¬£1 = {liveRate.toFixed(4)} RLUSD</p>
          )}
        </div>
      </div>
      <div className="mt-3 pt-3 border-t border-zinc-800 flex items-start gap-2">
        <svg className="w-4 h-4 text-amber-400/80 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="10" />
          <path d="M12 16v-4M12 8h.01" />
        </svg>
        <p className="text-[11px] text-zinc-500 leading-relaxed">
          <span className="text-zinc-400 font-medium">Live price.</span> Updated every 10s via CoinGecko Pro (600+ exchanges). Settlement variance &lt;0.1%.
        </p>
      </div>
    </div>

    {/* Sales Card */}
    <div className="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4 flex items-center justify-center">
      <div className="flex items-center gap-3">
        <div className="w-10 h-10 bg-sky-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
          <svg className="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2" />
          </svg>
        </div>
        <div>
          <p className="text-zinc-500 text-sm">Sales</p>
          <p className="text-2xl font-bold">{stats.totalSales}</p>
        </div>
      </div>
    </div>

  </div>
</>
)}

{/* ============================================================= */}
{/* QR CODE STATE */}
{/* ============================================================= */}
{status === 'qr' && (
<div className="flex-1 flex flex-col items-center justify-center py-8">
  <div className="text-center mb-6">
    <p className="text-zinc-500 text-lg mb-2">Total to pay</p>
    <p className="text-6xl sm:text-7xl font-bold text-emerald-400">¬£{getPaymentAmount().toFixed(2)}</p>
  </div>

  {xamanQR ? (
    <div className="flex flex-col sm:flex-row items-center justify-center gap-10 sm:gap-16 mb-10">
      <div className="flex flex-col items-center">
        <div className="w-40 h-40 sm:w-48 sm:h-48 bg-emerald-500/20 rounded-full flex items-center justify-center relative mb-5">
          <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping" style={{ animationDuration: '2s' }}></div>
          <div className="absolute inset-4 bg-emerald-500/10 rounded-full animate-pulse"></div>
          <svg className="w-20 h-20 sm:w-24 sm:h-24 text-emerald-400 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
          </svg>
        </div>
        <p className="text-2xl sm:text-3xl font-bold text-emerald-400 mb-2">Tap Card</p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Hold NFC card<br/>to phone</p>
      </div>

      <div className="flex items-center gap-4">
        <div className="w-16 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-32 bg-zinc-800"></div>
        <span className="text-zinc-600 text-lg font-medium">or</span>
        <div className="w-16 h-px bg-zinc-800 sm:hidden"></div>
        <div className="hidden sm:block w-px h-32 bg-zinc-800"></div>
      </div>

      <div className="flex flex-col items-center">
        <div className="bg-white rounded-3xl p-5 sm:p-6 mb-5 shadow-2xl shadow-sky-500/10 aspect-square flex items-center justify-center">
          <img src={xamanQR} alt="Scan with Xaman" className="w-40 h-40 sm:w-48 sm:h-48 object-contain" />
        </div>
        <p className="text-2xl sm:text-3xl font-bold text-sky-400 mb-2 whitespace-nowrap">Scan QR</p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Open Xaman<br/>and scan</p>
      </div>
    </div>
  ) : (
    <div className="py-16">
      <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
      <p className="text-zinc-400 text-xl">Creating payment request...</p>
    </div>
  )}

  <button
    onClick={() => {
      setStatus('idle');
      setXamanQR(null);
      setXamanPaymentId(null);
      if (storeId) updateCustomerDisplay(storeId, storeName, cart, getPaymentAmount(), 'idle', null, 0, tipsEnabled, walletAddress || undefined);
    }}
    className="bg-zinc-800 hover:bg-zinc-700 text-white font-semibold px-12 py-4 rounded-2xl transition active:scale-95 cursor-pointer text-lg"
  >
    Cancel
  </button>
</div>
)}

{/* ============================================================= */}
{/* WAITING FOR NFC STATE */}
{/* ============================================================= */}
{status === 'waiting' && (
<div className="text-center py-12">
  <div className="w-40 h-40 mx-auto mb-8 bg-emerald-500/20 rounded-full flex items-center justify-center relative">
    <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping"></div>
    <svg className="w-20 h-20 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </svg>
  </div>
  <p className="text-3xl font-bold mb-2">¬£{getPaymentAmount().toFixed(2)}</p>
  <p className="text-emerald-400 text-xl font-semibold mb-2">Ready for payment</p>
  <p className="text-zinc-500 mb-8">Customer: tap your card on the phone</p>
  <div className="space-y-3">
    <button onClick={handleManualUID} className="bg-zinc-800 hover:bg-zinc-700 text-white px-6 py-3 rounded-xl transition">
      Enter Card ID Manually
    </button>
    <button onClick={() => setStatus('idle')} className="block mx-auto text-zinc-500 hover:text-white transition">
      Cancel
    </button>
  </div>
</div>
)}

{/* ============================================================= */}
{/* PROCESSING STATE */}
{/* ============================================================= */}
{status === 'processing' && (
<div className="text-center py-12">
  <div className="w-40 h-40 mx-auto mb-8 flex items-center justify-center">
    <div className="w-20 h-20 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
  </div>
  <p className="text-3xl font-bold mb-2">¬£{getPaymentAmount().toFixed(2)}</p>
  <p className="text-yellow-400 text-xl font-semibold">Processing...</p>
  <p className="text-zinc-500 text-sm mt-2">Card: {lastUID}</p>
</div>
)}

{/* ============================================================= */}
{/* SUCCESS STATE */}
{/* ============================================================= */}
{status === 'success' && (
<div className="text-center py-12">
  <div className="w-40 h-40 mx-auto mb-8 bg-emerald-500/20 rounded-full flex items-center justify-center">
    <svg className="w-24 h-24 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
    </svg>
  </div>
  <p className="text-4xl font-bold mb-2">¬£{getPaymentAmount().toFixed(2)}</p>
  <p className="text-emerald-400 text-2xl font-semibold mb-4">Payment Complete!</p>
  {txHash && (
    <a
      href={`https://livenet.xrpl.org/transactions/${txHash}`}
      target="_blank"
      rel="noopener noreferrer"
      className="text-zinc-500 hover:text-emerald-400 text-sm mb-8 font-mono block"
    >
      TX: {txHash.slice(0, 8)}...{txHash.slice(-8)} ‚Üó
    </a>
  )}

  {/* Settlement Details */}
  {rlusdAmount && conversionRate && (
    <div className="max-w-sm mx-auto mb-6 p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/30 text-left">
      <p className="text-xs font-semibold text-emerald-400 mb-3">üí± SETTLEMENT DETAILS</p>
      <div className="text-sm space-y-2">
        <div className="flex justify-between">
          <span className="text-zinc-400">Amount Quoted:</span>
          <span className="text-white">¬£{getPaymentAmount().toFixed(2)} GBP</span>
        </div>
        <div className="flex justify-between">
          <span className="text-zinc-400">Amount Settled:</span>
          <span className="text-emerald-400 font-semibold">{rlusdAmount.toFixed(6)} RLUSD</span>
        </div>
        <div className="flex justify-between">
          <span className="text-zinc-400">Exchange Rate:</span>
          <span className="text-white">¬£1 = {(1 / conversionRate.rlusd_gbp).toFixed(6)} RLUSD</span>
        </div>
        <div className="flex justify-between">
          <span className="text-zinc-400">Rate Source:</span>
          <span className="text-white">{conversionRate.source || 'CoinGecko Pro API'}</span>
        </div>
      </div>
    </div>
  )}

  <ReceiptActions
    receiptId={receiptId || undefined}
    txHash={txHash || undefined}
    storeName={storeName}
    storeId={storeId || undefined}
    amount={getPaymentAmount()}
    rlusdAmount={rlusdAmount || undefined}
    items={[
      ...(lastOrder || cart).map(item => ({
        name: item.name,
        quantity: item.quantity,
        unit_price: item.price
      })),
      ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount }] : [])
    ]}
    tipAmount={tipAmount}
    conversionRate={conversionRate || undefined}
    storeLogo={storeLogo || undefined}
    walletAddress={walletAddress || undefined}
  />

  <button
    onClick={resetPayment}
    className="w-full max-w-xs mx-auto bg-emerald-500 hover:bg-emerald-400 text-black font-bold text-lg py-4 rounded-2xl transition mt-8"
  >
    New Payment
  </button>
</div>
)}

{/* ============================================================= */}
{/* ERROR STATE */}
{/* ============================================================= */}
{status === 'error' && (
<div className="text-center py-12">
  <div className="w-40 h-40 mx-auto mb-8 bg-red-500/20 rounded-full flex items-center justify-center">
    <svg className="w-24 h-24 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
    </svg>
  </div>
  <p className="text-3xl font-bold mb-2">¬£{getPaymentAmount().toFixed(2)}</p>
  <p className="text-red-400 text-2xl font-semibold mb-2">Payment Failed</p>
  <p className="text-zinc-500 mb-8">{error}</p>
  <button
    onClick={resetPayment}
    className="w-full max-w-xs mx-auto bg-zinc-800 hover:bg-zinc-700 text-white font-bold text-lg py-4 rounded-2xl transition"
  >
    Try Again
  </button>
</div>
)}

{/* ============================================================= */}
{/* SOUNDPAY STATE */}
{/* ============================================================= */}
{status === 'soundpay' && soundPaymentId && (
<div className="flex-1 flex flex-col items-center justify-center py-8">
  <div className="text-center mb-6">
    <p className="text-zinc-500 text-lg mb-2">Total to pay</p>
    <p className="text-6xl sm:text-7xl font-bold text-emerald-400">¬£{getPaymentAmount().toFixed(2)}</p>
  </div>

  <div className="flex flex-col sm:flex-row items-center justify-center gap-10 sm:gap-16 mb-10">
    <SoundPaySendButton
paymentId={soundPaymentId}
storeId={storeId || ''}
onSuccess={(txHash, receiptId, rlusdAmount) => {
setTxHash(txHash);
setReceiptId(receiptId || null);
setRlusdAmount(rlusdAmount || null);
setLastOrder([...cart]);
decrementStockForCart(cart); // Decrement stock for sold items
setStatus('success');
setSoundPaymentId(null);
if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
if (storeId) updateCustomerDisplay(storeId, storeName, [], 0, 'success', null, 0, tipsEnabled, walletAddress || undefined);
      }}
onError={(error) => {
setError(error);
      }}
/>

    <div className="flex items-center gap-4">
      <div className="w-16 h-px bg-zinc-800 sm:hidden"></div>
      <div className="hidden sm:block w-px h-32 bg-zinc-800"></div>
      <span className="text-zinc-600 text-lg font-medium">or</span>
      <div className="w-16 h-px bg-zinc-800 sm:hidden"></div>
      <div className="hidden sm:block w-px h-32 bg-zinc-800"></div>
    </div>

    <div className="flex flex-col items-center">
      <div className="w-40 h-40 sm:w-48 sm:h-48 bg-emerald-500/20 rounded-full flex items-center justify-center relative mb-5">
        <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping" style={{ animationDuration: '2s' }}></div>
        <div className="absolute inset-4 bg-emerald-500/10 rounded-full animate-pulse"></div>
        <svg className="w-20 h-20 sm:w-24 sm:h-24 text-emerald-400 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
        </svg>
      </div>
      <p className="text-2xl sm:text-3xl font-bold text-emerald-400 mb-2">Tap Card</p>
      <p className="text-zinc-500 text-base sm:text-lg text-center">Hold NFC card<br/>to phone</p>
    </div>
  </div>

  <button
    onClick={() => {
      setStatus('idle');
      setSoundPaymentId(null);
      if (storeId) updateCustomerDisplay(storeId, storeName, cart, getPaymentAmount(), 'idle', null, 0, tipsEnabled, walletAddress || undefined);
    }}
    className="bg-zinc-800 hover:bg-zinc-700 text-white font-semibold px-12 py-4 rounded-2xl transition active:scale-95 cursor-pointer text-lg"
  >
    Cancel
  </button>
</div>
)}

{/* Custom Tip Modal */}
{showCustomTipModal && (
<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
  <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm">
    <h3 className="text-lg font-bold mb-4">Custom Tip</h3>
    <div className="relative mb-4">
      <span className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-400 text-lg">¬£</span>
      <input
        type="number"
        inputMode="decimal"
        step="0.01"
        min="0"
        placeholder="0.00"
        value={customTipInput}
        onChange={(e) => setCustomTipInput(e.target.value)}
        className="w-full bg-zinc-800 border border-zinc-700 rounded-xl pl-8 pr-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500"
        autoFocus
      />
    </div>
    <div className="flex gap-3">
      <button
        onClick={() => {
          setShowCustomTipModal(false);
          setCustomTipInput('');
        }}
        className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-3 rounded-xl transition"
      >
        Cancel
      </button>
      <button
        onClick={() => {
          const tip = parseFloat(customTipInput) || 0;
          setTipAmount(tip);
          setShowCustomTipModal(false);
          setCustomTipInput('');
        }}
        className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-3 rounded-xl transition"
      >
        Add Tip
      </button>
    </div>
  </div>
</div>
)}

{/* Send Payment Link Modal */}
{showSendPaymentLink && storeId && (
<SendPaymentLink
  storeId={storeId}
  storeName={storeName}
  storeLogo={storeLogo}
  amount={getPaymentAmount()}
  tip={tipAmount}
  items={cart.length > 0 ? cart.map(item => ({
    name: item.name,
    quantity: item.quantity,
    unit_price: item.price,
    emoji: item.emoji || getProductEmoji(item)
  })) : undefined}
  onClose={() => setShowSendPaymentLink(false)}
  onSuccess={() => {}}
/>
)}

{/* Pending Payments Modal */}
{showPendingPayments && storeId && (
<PendingPayments
  storeId={storeId}
  onClose={() => setShowPendingPayments(false)}
  onPaymentComplete={(paymentId) => {
    console.log('Payment completed:', paymentId);
  }}
/>
)}

{/* Auto Sign Modal */}
<AutoSignModal
  isOpen={showAutoSignModal}
  onClose={() => setShowAutoSignModal(false)}
  onSuccess={() => {
    setShowAutoSignModal(false);
    setError(null);
  }}
/>

{/* Mobile Staff Modal */}
{showStaffModal && (
<div className="fixed inset-0 bg-black/80 z-50 flex items-start sm:hidden p-4 pt-20">
  <div className="bg-zinc-900 rounded-2xl w-full max-h-[60vh] overflow-hidden">
    <div className="p-4 border-b border-zinc-800 flex items-center justify-between">
      <h3 className="font-bold">Select Staff</h3>
      <button onClick={() => setShowStaffModal(false)} className="text-zinc-500 hover:text-white p-1">
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div className="overflow-y-auto max-h-[40vh]">
      <button
        onClick={() => {
          setActiveStaff(null);
          safeRemoveItem('activeStaff');
          setShowStaffModal(false);
        }}
        className={`w-full flex items-center gap-3 px-4 py-4 border-b border-zinc-800 transition ${!activeStaff ? 'bg-zinc-800' : ''}`}
      >
        <div className="w-10 h-10 rounded-full bg-zinc-700 flex items-center justify-center">
          <svg className="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <div className="flex-1 text-left">
          <p className="text-white">No one</p>
          <p className="text-zinc-500 text-sm">Skip staff selection</p>
        </div>
        {!activeStaff && (
          <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        )}
      </button>

      <MobileStaffList
        storeId={storeId!}
        walletAddress={walletAddress!}
        activeStaff={activeStaff}
        onSelect={(staff) => {
          setActiveStaff(staff);
          if (staff) {
            safeSetItem('activeStaff', JSON.stringify(staff));
          }
          setShowStaffModal(false);
        }}
      />
    </div>
    <button
      onClick={() => {
        setShowStaffModal(false);
        setTimeout(() => {
          router.push('/staffpos');
        }, 100);
      }}
      className="block w-full text-center text-sm text-zinc-400 hover:text-white py-4 border-t border-zinc-800 cursor-pointer"
    >
      Manage Staff ‚Üí
    </button>
  </div>
</div>
)}

{/* Barcode Scanner Modal */}
{showBarcodeScanner && (
  <BarcodeScanner
    onScan={handleBarcodeScan}
    onError={(error) => {
      setError(error);
      setTimeout(() => setError(null), 3000);
    }}
    onClose={() => setShowBarcodeScanner(false)}
  />
)}

</main>

{/* YAOFUS Pioneers Badge - Footer */}
<footer id="tp-footer" className="py-6 flex flex-col items-center gap-1">
  <span className="text-zinc-500 text-[10px] font-medium tracking-wider">INSTANT</span>
  <span className="text-base font-extrabold tracking-widest">
    <span className="text-emerald-500">Y</span>
    <span className="text-green-500">A</span>
    <span className="text-blue-500">O</span>
    <span className="text-indigo-500">F</span>
    <span className="text-violet-500">U</span>
    <span className="text-purple-500">S</span>
  </span>
  <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">PAYMENTS</span>
  <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
    <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
    <span>Powered by YesAllOfUs</span>
  </div>
</footer>
</div>
  </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/affiliate-dashboard/layout.tsx
// =================================================

// MARK: - Component Definition
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a]">
      {children}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/affiliate-dashboard/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, useRef } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';
import { authenticatedFetch, refreshWalletAuth } from '@/lib/walletAuth';
import PayoutsTable from '@/components/PayoutsTable';
import DashboardHeader from "@/components/DashboardHeader";
import QRCodeModal from '@/components/QRCodeModal';
import LinkNFCCard from '@/components/LinkNFCCard';
import LoginScreen from '@/components/LoginScreen';
import MyPendingStatus from '@/components/MyPendingStatus';
import EarnInterest from '@/components/EarnInterest';
import TopUpRLUSD from '@/components/TopUpRLUSD';
import WithdrawRLUSD from '@/components/WithdrawRLUSD';
import Sidebar from '@/components/Sidebar';
import MilestoneChecklist from '@/components/MilestoneChecklist';
import CelebrationToast from '@/components/CelebrationToast';
import NebulaBackground from '@/components/NebulaBackground';
import CollapsibleSection from '@/components/CollapsibleSection';
import { InfoModal, useInfoModal } from '@/components/InfoModal';
import AffiliateDashboardTour from '@/components/AffiliateDashboardTour';
import OnboardingSetup from '@/components/OnboardingSetup';
import DeleteConfirmModal from '@/components/DeleteConfirmModal';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';


// MARK: - Types & Interfaces
interface Store {
  store_id: string;
  store_name: string;
  store_url: string;
  referral_code: string;
  referral_link: string;
  total_earned: number;
  level: number;
  commission_rates?: number[];
  logo_url?: string;  // ADD THIS LINE
}
interface Payout {
  store_name: string;
  order_id: string;
  amount: number;
  currency: string;
  tx_hash: string;
  paid_at: string;
}

interface DashboardData {
  wallet: string;
  total_earned: number;
  stores: Store[];
  recent_payouts: Payout[];
}

interface WalletStatus {
  funded: boolean;
  xrp_balance: number;
  rlusd_trustline: boolean;
  usdc_trustline: boolean;
  rlusd_balance: number;
  usdc_balance: number;
  pending_commissions: {
    total: number;
    threshold: number;
    until_payout: number;
  } | null;
}

interface PublicStore {
  store_id: string;
  store_name: string;
  store_url: string;
  commission_rates: number[];
  affiliates_count: number;
}


// MARK: - Component Definition
const EyeIcon = ({ open }: { open: boolean }) => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    {open ? (
      <>
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
      </>
    ) : (
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
    )}
  </svg>
);

const SocialIcon = ({ provider, size = 'sm' }: { provider: string; size?: 'sm' | 'md' }) => {
  const sizeClasses = size === 'sm' ? 'w-4 h-4' : 'w-5 h-5';
  const iconSize = size === 'sm' ? 'w-2.5 h-2.5' : 'w-3 h-3';
  
  const icons: Record<string, React.ReactNode> = {
    google: (
      <div className={`${sizeClasses} bg-white rounded-full flex items-center justify-center`}>
        <svg className={iconSize} viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
      </div>
    ),
    apple: (
      <div className={`${sizeClasses} bg-black rounded-full flex items-center justify-center border border-zinc-700`}>
        <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
        </svg>
      </div>
    ),
    github: (
      <div className={`${sizeClasses} bg-[#24292e] rounded-full flex items-center justify-center`}>
        <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
        </svg>
      </div>
    ),
    discord: (
      <div className={`${sizeClasses} bg-[#5865F2] rounded-full flex items-center justify-center`}>
        <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
          <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
        </svg>
      </div>
    ),
    twitter: (
      <div className={`${sizeClasses} bg-black rounded-full flex items-center justify-center border border-zinc-700`}>
        <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
      </div>
    ),
    facebook: (
      <div className={`${sizeClasses} bg-[#1877F2] rounded-full flex items-center justify-center`}>
        <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
          <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
        </svg>
      </div>
    ),
  };

  return icons[provider?.toLowerCase()] || (
    <div className={`${sizeClasses} bg-zinc-700 rounded-full flex items-center justify-center`}>
      <svg className={`${iconSize} text-white`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
    </div>
  );
};

export default function AffiliateDashboard() {
  // Core state

// MARK: - State Management
  const [walletAddress, setWalletAddress] = useState('');
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [dashboardData, setDashboardData] = useState<DashboardData | null>(null);
  const [walletStatus, setWalletStatus] = useState<WalletStatus | null>(null);
  const [publicStores, setPublicStores] = useState<PublicStore[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [loginMethod, setLoginMethod] = useState<string | null>(null);
  const [socialProvider, setSocialProvider] = useState<string | null>(null);
  
  // Xaman connection state
  const [connectingXaman, setConnectingXaman] = useState(false);
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [xamanDeepLink, setXamanDeepLink] = useState<string | null>(null);
  const [xamanLoginId, setXamanLoginId] = useState<string | null>(null);
  
  // UI state
  const [copiedCode, setCopiedCode] = useState('');
  const [copiedAddress, setCopiedAddress] = useState(false);
  const [showDiscover, setShowDiscover] = useState(false);
  const [joiningStore, setJoiningStore] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [showBalances, setShowBalances] = useState(false);
  const [allMilestonesComplete, setAllMilestonesComplete] = useState(false);
  const [setupComplete, setSetupComplete] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  // Customer logo state
  const [customerLogo, setCustomerLogo] = useState<string | null>(null);
  const [showLogoUpload, setShowLogoUpload] = useState(false);
  const [uploadingLogo, setUploadingLogo] = useState(false);
  
  // Set sidebar open by default on desktop/tablet only (not mobile)

// MARK: - Hooks & Effects
  useEffect(() => {
    if (typeof window !== 'undefined' && window.innerWidth >= 1024) {
      setSidebarOpen(true);
    }
  }, []);
  
  const [refreshingWallet, setRefreshingWallet] = useState(false);
  
  // Modals
  const [showReceiveModal, setShowReceiveModal] = useState(false);
  const [showQRModal, setShowQRModal] = useState(false);
  const [qrUrl, setQrUrl] = useState('');
  const [qrStoreName, setQrStoreName] = useState('');

  // Auto sign
  const [autoSignEnabled, setAutoSignEnabled] = useState(false);
  const [settingUpAutoSign, setSettingUpAutoSign] = useState(false);
  const [setupProgress, setSetupProgress] = useState<string | null>(null);
  const [showAutoSignPrompt, setShowAutoSignPrompt] = useState(false);

  // NEW: VendorDashboard-style state
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [progressHidden, setProgressHidden] = useState(false);
  const [openSections, setOpenSections] = useState<Record<string, boolean>>({});
  const [celebrateMilestone, setCelebrateMilestone] = useState<string | null>(null);
  const { activeInfo, openInfo, closeInfo, getContent } = useInfoModal();
  // NEW: Tour
  const [runTour, setRunTour] = useState(false);

  const registeringRef = useRef(false);
const rightColumnRef = useRef<HTMLDivElement>(null);
// Delete Affiliate
const [showDeleteModal, setShowDeleteModal] = useState(false);
const [deleting, setDeleting] = useState(false);

// Check if first time user
useEffect(() => {
  if (walletAddress && !loading) {
    const hasSeenTour = localStorage.getItem(`tour_completed_${walletAddress}`);
    if (!hasSeenTour) {
      setTimeout(() => setRunTour(true), 1000);
    }
  }
}, [walletAddress, loading]);

// Check if all milestones complete on login
useEffect(() => {
  const checkMilestones = async () => {
    if (!walletAddress) return;
    try {
      const res = await fetch(`${API_URL}/customer/milestones/${walletAddress}`);
      const data = await res.json();
      if (data.success && data.milestones) {
        const allComplete = Object.values(data.milestones).every(v => v !== null);
        const dismissedKey = `milestones_celebrated_${walletAddress}`;
        const alreadyCelebrated = localStorage.getItem(dismissedKey);
        
        if (allComplete && !alreadyCelebrated) {
          setAllMilestonesComplete(true);
          localStorage.setItem(dismissedKey, 'true');
        }
      }
    } catch (err) {
      console.error('Failed to check milestones:', err);
    }
  };
  checkMilestones();
}, [walletAddress]);

  useEffect(() => {

// MARK: - Event Handlers
  const handleToggle = () => setSidebarOpen(prev => !prev);
  window.addEventListener('toggleSidebar', handleToggle);
  return () => window.removeEventListener('toggleSidebar', handleToggle);
}, []);

  // Load progress hidden state
  useEffect(() => {
    if (walletAddress) {
      const dismissed = localStorage.getItem(`milestones_dismissed_customer_${walletAddress}`);
      setProgressHidden(dismissed === 'true');
    }
  }, [walletAddress]);

  const toggleSection = (id: string) => {
    setOpenSections(prev => ({ ...prev, [id]: !prev[id] }));
  };

  // Fetch customer logo on login
  useEffect(() => {

// MARK: - API Calls & Data Fetching
    const fetchCustomerLogo = async () => {
      if (!walletAddress) return;
      try {
        const res = await fetch(`https://api.dltpays.com/nfc/api/v1/customer/${walletAddress}`);
        if (res.ok) {
          const data = await res.json();
          if (data.logo_url) {
            setCustomerLogo(data.logo_url);
          }
        }
      } catch (err) {
        // No logo found, that's fine
      }
    };
    fetchCustomerLogo();
  }, [walletAddress]);

  // Save URL params before login
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const storeId = urlParams.get('store');
    const join = urlParams.get('join');
    if (email && join === '1') {
      safeSetItem('pendingSignup', JSON.stringify({ email, storeId }));
    }
  }, []);

  const completeCustomerSignup = async (wallet: string) => {
    const urlParams = new URLSearchParams(window.location.search);
    let email = urlParams.get('email');
    let storeId = urlParams.get('store');
    let join = urlParams.get('join');
    
    if (!email || join !== '1') {
      const pending = safeGetItem('pendingSignup');
      if (pending) {
        const parsed = JSON.parse(pending);
        email = parsed.email;
        storeId = parsed.storeId;
        join = '1';
      }
    }
    
    if (!email || join !== '1') return;
    
    try {
      const res = await fetch('https://api.dltpays.com/nfc/api/v1/nfc/complete-customer-signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, wallet_address: wallet, store_id: storeId || null })
      });
      const data = await res.json();
      if (data.success && data.card_linked) {
        console.log('‚úÖ NFC card linked to wallet:', data.card_uid);
      }
      safeRemoveItem('pendingSignup');
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.delete('email');
      newUrl.searchParams.delete('store');
      newUrl.searchParams.delete('join');
      window.history.replaceState({}, '', newUrl.toString());
    } catch (err) {
      console.error('Failed to complete customer signup:', err);
    }
  };

  const checkAutoSignStatus = async (wallet: string, method: string) => {
    if (method !== 'web3auth') return;
    try {
      const res = await fetch(`https://api.dltpays.com/nfc/api/v1/nfc/customer/autosign-status/${wallet}`);
      const data = await res.json();
      if (data.success) {
        setAutoSignEnabled(data.auto_sign_enabled);
        if (!data.auto_sign_enabled) setShowAutoSignPrompt(true);
      }
    } catch (err) {
      console.error('Failed to check auto-sign status:', err);
    }
  };

  const setupAutoSignWeb3Auth = async () => {
    if (!walletAddress) return;
    setSettingUpAutoSign(true);
    setError(null);
    setSetupProgress(null);

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      let web3auth = await getWeb3Auth();
      if (!web3auth) {
        throw new Error('Web3Auth not available. Please refresh and try again.');
      }
      if (!web3auth.connected || !web3auth.provider) {
        setSetupProgress('Reconnecting wallet...');
        await web3auth.connect();
      }
      if (!web3auth.provider) {
        throw new Error('Web3Auth session not available. Please sign in again.');
      }

      setSetupProgress('Checking wallet...');
      const walletStatusRes = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${walletAddress}`);
      const walletStatusData = await walletStatusRes.json();
      
      if (walletStatusData.success && walletStatusData.funded && !walletStatusData.rlusd_trustline) {
        setSetupProgress('Setting up RLUSD trustline... (1/2)');
        const trustlineTx = {
          TransactionType: 'TrustSet',
          Account: walletAddress,
          LimitAmount: {
            currency: '524C555344000000000000000000000000000000',
            issuer: 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De',
            value: '1000000',
          },
        };
        await web3auth.provider.request({
          method: 'xrpl_submitTransaction',
          params: { transaction: trustlineTx },
        });
        setSetupProgress('RLUSD enabled ‚úì Now confirm Tap-to-Pay... (2/2)');
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      setSetupProgress('Preparing Tap-to-Pay...');
      const settingsRes = await fetch('https://api.dltpays.com/nfc/api/v1/nfc/customer/setup-autosign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const settingsData = await settingsRes.json();
      
      if (settingsData.error) throw new Error(settingsData.error);
      if (settingsData.signer_exists || settingsData.auto_sign_enabled) {
        setAutoSignEnabled(true);
        setShowAutoSignPrompt(false);
        setSettingUpAutoSign(false);
        setSetupProgress(null);
        return;
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) throw new Error('Platform signer not configured');

      setSetupProgress('Confirm in your wallet...');
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 1,
        SignerEntries: [{ SignerEntry: { Account: platformSignerAddress, SignerWeight: 1 } }]
      };
      try {
        const txResult = await web3auth.provider.request({
          method: 'xrpl_submitTransaction',
          params: { transaction: signerListSetTx }
        });
      } catch (txErr) {
        throw txErr;
      }

      setSetupProgress('Verifying setup...');
      await new Promise(resolve => setTimeout(resolve, 2000));

      setSetupProgress('Verifying setup...');
      await new Promise(resolve => setTimeout(resolve, 2000));

      const verifyRes = await fetch(`https://api.dltpays.com/nfc/api/v1/nfc/customer/autosign-status/${walletAddress}`);
      const verifyData = await verifyRes.json();
      if (verifyData.auto_sign_enabled) {
        setAutoSignEnabled(true);
        setShowAutoSignPrompt(false);
      } else {
        throw new Error('Auto-sign setup failed. Please try again.');
      }
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to enable auto-sign';
      setError(message);
    }
    setSettingUpAutoSign(false);
    setSetupProgress(null);
  };

  const revokeAutoSign = async () => {
    if (!confirm('Disable auto-pay? You will need to set it up again to use Tap-to-Pay.')) return;
    if (!walletAddress) return;

    setSettingUpAutoSign(true);
    setError(null);

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth || !web3auth.provider) {
        throw new Error('Web3Auth session not available. Please sign in again.');
      }

      // Sign transaction to remove signer from XRPL
      const revokeTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 0,
      };

      await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: revokeTx }
      });

      // Confirm with backend
      await fetch('https://api.dltpays.com/nfc/api/v1/nfc/customer/revoke-autosign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });

      setAutoSignEnabled(false);
      setShowAutoSignPrompt(true);
      
      // Clear success flag so wizard can show success again when re-enabled
      localStorage.removeItem(`onboarding_success_shown_affiliate_${walletAddress}`);
      safeSetItem(`onboarding_active_affiliate_${walletAddress}`, 'true');
      
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to revoke auto-pay';
      setError(message);
    }
    setSettingUpAutoSign(false);
  };

  // Check for existing session on mount
  useEffect(() => {
    const stored = safeGetItem('walletAddress');
    const storedMethod = safeGetItem('loginMethod');
    const storedProvider = safeGetItem('socialProvider');
    const storedLoggedIn = safeGetItem('isLoggedIn');
    
    if (storedLoggedIn === 'true') setIsLoggedIn(true);
    
    if (stored) {
      setWalletAddress(stored);
      setIsLoggedIn(true);
      if (storedMethod) setLoginMethod(storedMethod);
      if (storedProvider) setSocialProvider(storedProvider);
      completeCustomerSignup(stored);
      Promise.all([fetchDashboard(stored), fetchWalletStatus(stored)]);
      if (storedMethod === 'web3auth') checkAutoSignStatus(stored, storedMethod);
    } else {
      setLoading(false);
    }
    
    const interval = setInterval(() => {
      const currentStored = safeGetItem('walletAddress');
      if (currentStored && currentStored !== walletAddress && walletAddress) {
        setWalletAddress(currentStored);
        fetchDashboard(currentStored);
        fetchWalletStatus(currentStored);
      }
    }, 1000);
    
    return () => clearInterval(interval);
  }, [walletAddress]);

  const fetchWalletStatus = async (wallet: string, showLoading = false) => {
    if (showLoading) setRefreshingWallet(true);
    try {
      const res = await fetch(`${API_URL}/wallet/status/${wallet}`);
      const data = await res.json();
      if (data.success) setWalletStatus(data);
    } catch (err) {
      console.error('Failed to fetch wallet status:', err);
    }
    if (showLoading) setRefreshingWallet(false);
  };

  const fetchPublicStores = async () => {
    try {
      const res = await fetch(`${API_URL}/stores/public`);
      const data = await res.json();
      if (data.success) setPublicStores(data.stores);
    } catch (err) {
      console.error('Failed to fetch vendors:', err);
    }
  };

  const fetchDashboard = async (wallet: string) => {
    try {
      setLoading(true);
      setError('');

      // Use authenticated fetch for protected endpoint
      const res = await authenticatedFetch(wallet, `${API_URL}/affiliate/dashboard/${wallet}`);
      const data = await res.json();

      if (!res.ok) {
        // If auth failed, try refreshing token and retry once
        if (res.status === 401) {
          await refreshWalletAuth(wallet);
          const retryRes = await authenticatedFetch(wallet, `${API_URL}/affiliate/dashboard/${wallet}`);
          const retryData = await retryRes.json();
          if (retryRes.ok) {
            setDashboardData(retryData);
            if (retryData.stores.length === 0) {
              setShowDiscover(true);
              await fetchPublicStores();
            }
            return;
          }
        }
        if (res.status === 404) {
          setDashboardData(null);
          setShowDiscover(true);
          await fetchPublicStores();
        } else {
          setError(data.error || 'Failed to load dashboard');
        }
        return;
      }
      
      setDashboardData(data);
      if (data.stores.length === 0) {
        setShowDiscover(true);
        await fetchPublicStores();
      }
    } catch (err) {
      setError('Failed to connect to server');
    } finally {
      setLoading(false);
    }
  };

  const handleJoinStore = async (storeId: string) => {
    if (!walletAddress) return;
    setJoiningStore(storeId);
    try {
      const res = await fetch(`${API_URL}/affiliate/join`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ store_id: storeId, wallet: walletAddress })
      });
      const data = await res.json();
      if (data.success) {
        await fetchDashboard(walletAddress);
        setShowDiscover(false);
      } else {
        setError(data.error || 'Failed to join vendor');
      }
    } catch (err) {
      setError('Failed to join vendor');
    } finally {
      setJoiningStore(null);
    }
  };

  const handleLogin = (wallet: string, method: 'xaman' | 'crossmark' | 'web3auth', extras?: { socialProvider?: string }) => {
    setWalletAddress(wallet);
    setLoginMethod(method);
    setIsLoggedIn(true);
    safeSetItem('walletAddress', wallet);
    safeSetItem('loginMethod', method);
    safeSetItem('isLoggedIn', 'true');
    if (extras?.socialProvider) {
      setSocialProvider(extras.socialProvider);
      safeSetItem('socialProvider', extras.socialProvider);
    }
    completeCustomerSignup(wallet);
    fetchDashboard(wallet);
    fetchWalletStatus(wallet);
    checkAutoSignStatus(wallet, method);
  };

  const handleSignOut = () => {
    safeRemoveItem('walletAddress');
    safeRemoveItem('loginMethod');
    safeRemoveItem('socialProvider');
    safeRemoveItem('isLoggedIn');
    setWalletAddress('');
    setIsLoggedIn(false);
    setDashboardData(null);
    setWalletStatus(null);
    setLoginMethod(null);
    setSocialProvider(null);
    setShowBalances(false);
    setSidebarOpen(false);
    setLoading(false);
  };

  const handleDisconnectWallet = () => {
    // Clear success flag so it shows again on reconnect
    if (walletAddress) {
      localStorage.removeItem(`onboarding_success_shown_affiliate_${walletAddress}`);
    }
    safeRemoveItem('walletAddress');
    safeRemoveItem('loginMethod');
    safeRemoveItem('socialProvider');
    setWalletAddress('');
    setLoginMethod(null);
    setSocialProvider(null);
  };

  const handleCopyLink = (link: string, code: string) => {
    navigator.clipboard.writeText(link);
    setCopiedCode(code);
    setTimeout(() => setCopiedCode(''), 2000);
  };

  const handleCopyAddress = () => {
  navigator.clipboard.writeText(walletAddress);
  setCopiedAddress(true);
  setTimeout(() => setCopiedAddress(false), 2000);
};

const deleteAffiliateData = async () => {
  setDeleting(true);
  try {
    // Use authenticated fetch for protected endpoint
    const res = await authenticatedFetch(walletAddress, `${API_URL}/affiliate/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        wallet_address: walletAddress,
        confirm: 'DELETE'
      })
    });

    const data = await res.json();
    if (data.success) {
      safeRemoveItem('walletAddress');
      safeRemoveItem('loginMethod');
      safeRemoveItem('socialProvider');
      safeRemoveItem('isLoggedIn');
      window.location.href = '/affiliate-dashboard';
    } else {
      setError(data.error || 'Failed to delete data');
      setShowDeleteModal(false);
    }
  } catch (err) {
    setError('Failed to delete data');
    setShowDeleteModal(false);
  }
  setDeleting(false);
};

  const formatBalance = (amount: number, prefix = '$') => showBalances ? `${prefix}${amount.toFixed(2)}` : '****';
  const formatXRP = (amount: number) => showBalances ? `${amount.toFixed(2)} XRP` : '****';
  const abbreviateWallet = (addr: string) => addr ? `${addr.slice(0, 6)}...${addr.slice(-4)}` : '';
  const isJoined = (storeId: string) => dashboardData?.stores.some(s => s.store_id === storeId) || false;
  const filteredStores = publicStores.filter(s => 
    s.store_name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    s.store_url.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const connectXaman = async () => {
    setConnectingXaman(true);
    setError('');
    try {
      const res = await fetch(`${API_URL}/xaman/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ purpose: 'affiliate_dashboard' })
      });
      const data = await res.json();
      if (data.success) {
        setXamanQR(data.qr_png);
        setXamanDeepLink(data.deep_link);
        setXamanLoginId(data.login_id);
      } else {
        setError(data.error || 'Failed to start Xaman login');
        setConnectingXaman(false);
      }
    } catch (err) {
      setError('Failed to connect to Xaman');
      setConnectingXaman(false);
    }
  };

  const cancelXamanConnection = () => {
    setConnectingXaman(false);
    setXamanQR(null);
    setXamanDeepLink(null);
    setXamanLoginId(null);
  };

  useEffect(() => {
    if (!xamanLoginId || !connectingXaman) return;
    const interval = setInterval(async () => {
      try {
        const res = await fetch(`${API_URL}/xaman/login/poll/${xamanLoginId}`);
        const data = await res.json();
        if (data.status === 'signed' && data.wallet_address) {
          clearInterval(interval);
          setConnectingXaman(false);
          setXamanQR(null);
          setXamanLoginId(null);
          safeSetItem('walletAddress', data.wallet_address);
          safeSetItem('loginMethod', 'xaman');
          safeRemoveItem('socialProvider');
          setWalletAddress(data.wallet_address);
          setLoginMethod('xaman');
          setSocialProvider(null);
          fetchDashboard(data.wallet_address);
          fetchWalletStatus(data.wallet_address);
        } else if (data.status === 'expired' || data.status === 'cancelled') {
          clearInterval(interval);
          setError(data.status === 'expired' ? 'QR code expired. Please try again.' : 'Connection cancelled.');
          setConnectingXaman(false);
          setXamanQR(null);
          setXamanLoginId(null);
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 3000);
    return () => clearInterval(interval);
  }, [xamanLoginId, connectingXaman]);

  const scrollToSection = (id: string) => {
    const element = document.getElementById(id);
    if (element) {
      const headerOffset = 80;
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
      window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
    }
    setSidebarOpen(false);
  };

  const handleNavClick = (id: string, onClick?: () => void) => {
    if (onClick) {
      onClick();
    } else {
      // Map nav IDs to collapsible section IDs
      const sectionIdMap: Record<string, string> = {
        'top-up': 'top-up-inner',
        'withdraw': 'withdraw',
        'tap-to-pay': 'tap-to-pay',
        'browser-wallet': 'browser-wallet',
        'xaman-wallet': 'xaman-wallet',
        'payment-cards': 'payment-cards',
      };
      const sectionId = sectionIdMap[id] || id;
      setOpenSections(prev => ({ ...prev, [sectionId]: true }));
      // Wait for section to expand before scrolling
      setTimeout(() => scrollToSection(sectionId), 150);
    }
    // Only close sidebar on mobile
    setSidebarOpen(false);
    // Don't collapse on desktop - let user control it
  };

  // Handle customer logo upload
  const handleLogoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      setError('Please upload an image file');
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      setError('Image must be less than 5MB');
      return;
    }

    setUploadingLogo(true);
    setError(null);

    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'store_logos');

      const uploadRes = await fetch('https://tokencanvas.io/api/cloudinary/upload', {
        method: 'POST',
        body: formData
      });

      const uploadData = await uploadRes.json();

      if (!uploadData.secure_url) {
        throw new Error(uploadData.error?.message || 'Upload failed');
      }

      const logoUrl = uploadData.secure_url;

      const res = await fetch(`https://api.dltpays.com/nfc/api/v1/customer/${walletAddress}/logo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          logo_url: logoUrl,
          wallet_address: walletAddress
        })
      });

      const data = await res.json();
      if (data.success) {
        setCustomerLogo(logoUrl);
        setShowLogoUpload(false);
      } else {
        setError('Failed to save logo');
      }
    } catch (err: any) {
      console.error('Upload error:', err);
      setError(err.message || 'Failed to upload logo');
    }
    setUploadingLogo(false);
  };

  const removeCustomerLogo = async () => {
    setUploadingLogo(true);
    try {
      const res = await fetch(`https://api.dltpays.com/nfc/api/v1/customer/${walletAddress}/logo`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          logo_url: null,
          wallet_address: walletAddress
        })
      });
      if (res.ok) {
        setCustomerLogo(null);
        setShowLogoUpload(false);
      }
    } catch (err) {
      setError('Failed to remove logo');
    }
    setUploadingLogo(false);
  };

  // Navigation items for Sidebar component
  const navItems = [
    { id: 'earnings', label: 'Total Earnings', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> },
    { id: 'wallet-status', label: 'Wallet Status', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>, show: !!walletStatus },
    { id: 'top-up', label: 'Top Up Wallet', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m6-6H6" /></svg>, show: !!walletStatus },
    { id: 'withdraw', label: 'Withdraw', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>, show: !!walletStatus },
    { id: 'payment-cards', label: 'Payment Cards', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg> },
    { id: 'tap-to-pay', label: 'Tap-to-Pay', icon: <img src="/dltpayslogo1.png" alt="Tap to Pay" className="w-5 h-5 rounded object-cover" /> },
    { id: 'browser-wallet', label: 'Browser Wallet', icon: <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-5 h-5 rounded" /> },
    { id: 'xaman-wallet', label: 'Manual Wallet', icon: <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-5 h-5 rounded" /> },
    { id: 'earn-interest', label: 'Earn Interest', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" /></svg>, badge: 'Soon' },
    { id: 'discover', label: 'Discover Vendors', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> },
    { id: 'payouts', label: 'Recent Payouts', icon: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>, show: !!(dashboardData && dashboardData.stores.length > 0) },
    { id: 'danger-zone', label: <span className="text-red-400">Danger Zone</span>, icon: <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg> },
  ].filter(item => item.show !== false);

  // RENDER: Loading
if (loading) {

// MARK: - Main Render
return (
<div className="min-h-screen bg-[#0d0d0d] text-white flex items-center justify-center">
<div className="text-center">
<div className="w-8 h-8 border-2 border-sky-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
<p className="text-zinc-400">Loading dashboard...</p>
</div>
</div>
    );
  }

  // RENDER: Login screen
  if (!isLoggedIn) {
return <LoginScreen onLogin={handleLogin} />;
  }

  // RENDER: Main dashboard
  return (
    <>
      <NebulaBackground opacity={0.3} />
      <DashboardHeader dashboardType="affiliate" walletAddress={walletAddress} onSignOut={handleSignOut} showBalances={showBalances} onToggleBalances={() => setShowBalances(!showBalances)} allMilestonesComplete={allMilestonesComplete} setupComplete={setupComplete} />
      <AffiliateDashboardTour 
  run={runTour} 
  onComplete={() => {
    setRunTour(false);  // This must happen!
    localStorage.setItem(`tour_completed_${walletAddress}`, 'true');
  }}
  hasJoinedVendor={!!(dashboardData && dashboardData.stores.length > 0)}
/>
      <div className="min-h-screen bg-transparent text-white font-sans relative z-10">
        {/* Celebration Toast */}
        {celebrateMilestone && <CelebrationToast milestone={celebrateMilestone} onClose={() => setCelebrateMilestone(null)} />}
        
        {/* Info Modal */}
        {activeInfo && getContent() && <InfoModal content={getContent()!} isOpen={!!activeInfo} onClose={closeInfo} />}

        {/* Sidebar Component */}
        <Sidebar
          isOpen={sidebarOpen}
          isCollapsed={sidebarCollapsed}
          onToggleOpen={() => setSidebarOpen(!sidebarOpen)}
          onToggleCollapsed={() => setSidebarCollapsed(!sidebarCollapsed)}
          dashboardType="affiliate"
          storeName="Member"
          walletAddress={walletAddress}
          navItems={navItems}
          storeLogo={customerLogo}
          onNavClick={handleNavClick}
          onSignOut={handleSignOut}
          onInfoClick={openInfo}
          onLogoClick={() => setShowLogoUpload(true)}
          onTakeTour={() => {
  setSidebarOpen(false);
  window.scrollTo({ top: 0, behavior: 'smooth' });
  // Force reset then set true
  setRunTour(false);
  setTimeout(() => setRunTour(true), 100);
  if (walletAddress) {
    localStorage.removeItem(`milestones_dismissed_customer_${walletAddress}`);
    setProgressHidden(false);
  }
}}
          onShowProgress={() => {
            if (walletAddress) {
              localStorage.removeItem(`milestones_dismissed_customer_${walletAddress}`);
              setProgressHidden(false);
            }
          }}
        />

        {/* Logo Upload Modal */}
        {showLogoUpload && (
          <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
            <div className="bg-zinc-900/95 rounded-2xl p-6 w-full max-w-sm border border-zinc-800">
              <h3 className="text-lg font-bold mb-4">Your Profile Logo</h3>
              {customerLogo && (
                <div className="mb-4 flex justify-center">
                  <img src={customerLogo} alt="Current logo" className="w-24 h-24 rounded-xl object-cover" />
                </div>
              )}
              <label className="block mb-4">
                <div className="bg-zinc-800/90 border-2 border-dashed border-zinc-700 hover:border-lime-500 rounded-xl p-6 text-center cursor-pointer transition">
                  {uploadingLogo ? (
                    <div className="flex flex-col items-center">
                      <div className="w-8 h-8 border-2 border-lime-500 border-t-transparent rounded-full animate-spin mb-2"></div>
                      <p className="text-zinc-400 text-sm">Uploading...</p>
                    </div>
                  ) : (
                    <>
                      <svg className="w-8 h-8 text-zinc-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <p className="text-zinc-400 text-sm">Click to upload image</p>
                      <p className="text-zinc-600 text-xs mt-1">Max 5MB ‚Ä¢ Shows on payment success</p>
                    </>
                  )}
                </div>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleLogoUpload}
                  className="hidden"
                  disabled={uploadingLogo}
                />
              </label>
              <div className="flex gap-3">
                {customerLogo && (
                  <button
                    onClick={removeCustomerLogo}
                    disabled={uploadingLogo}
                    className="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 py-3 rounded-xl transition disabled:opacity-50"
                  >
                    Remove
                  </button>
                )}
                <button
                  onClick={() => setShowLogoUpload(false)}
                  disabled={uploadingLogo}
                  className="flex-1 bg-zinc-800/90 hover:bg-zinc-700 py-3 rounded-xl transition disabled:opacity-50"
                >
                  {customerLogo ? 'Done' : 'Cancel'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Main Content */}
        <main className={`min-h-screen pt-2 lg:pt-0 transition-all duration-300 ${sidebarCollapsed ? 'lg:ml-0' : 'lg:ml-64'}`}>
          <div className={`max-w-3xl lg:max-w-none mx-auto px-3 sm:px-6 lg:px-4 pb-8 ${progressHidden ? 'pt-16' : 'pt-24'}`}>

            {error && (
              <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6">
                <p className="text-red-400">{error}</p>
              </div>
            )}

            {/* MILESTONE CHECKLIST */}
            {!progressHidden && walletAddress && (
              <MilestoneChecklist
  type="customer"
  forceCollapsed={setupComplete}
  onAllComplete={(complete) => {
    if (complete && walletAddress) {
      const dismissedKey = `milestones_celebrated_${walletAddress}`;
      const alreadyCelebrated = localStorage.getItem(dismissedKey);
      if (!alreadyCelebrated) {
        setAllMilestonesComplete(true);
        localStorage.setItem(dismissedKey, 'true');
      }
    }
  }}
  storeId={walletAddress}
                walletAddress={walletAddress}
                autoSignEnabled={autoSignEnabled}
                walletFunded={walletStatus?.funded || false}
                trustlineSet={walletStatus?.rlusd_trustline || false}
                tapPayEnabled={autoSignEnabled}
                nfcCardAdded={false} // TODO: track NFC card state
                joinedAffiliate={!!(dashboardData && dashboardData.stores.length > 0)}
                onMilestoneAchieved={(milestone) => setCelebrateMilestone(milestone)}
                onInfoClick={openInfo}
                onDismiss={() => {
                  localStorage.setItem(`milestones_dismissed_customer_${walletAddress}`, 'true');
                  setProgressHidden(true);
                }}
              />
            )}

            {/* PENDING SIGNUP STATUS */}
            <MyPendingStatus walletAddress={walletAddress} email={new URLSearchParams(typeof window !== 'undefined' ? window.location.search : '').get('email') || undefined} />

            {/* AUTO-SIGN SETUP PROMPT */}
            {/* AUTO-SIGN SETUP PROMPT */}
            {isLoggedIn && (
  <OnboardingSetup
    walletAddress={walletAddress}
    walletStatus={walletStatus}
    autoSignEnabled={autoSignEnabled}
    loginMethod={loginMethod as 'xaman' | 'crossmark' | 'web3auth' | null}
    onSetupComplete={() => {
      setAutoSignEnabled(true);
      setShowAutoSignPrompt(false);
      fetchWalletStatus(walletAddress);
    }}
    onRefreshWallet={() => fetchWalletStatus(walletAddress)}
    onSetupStatusChange={(isComplete) => setSetupComplete(isComplete)}
    storagePrefix="affiliate"
    onVendorEnableAutoPay={walletAddress ? setupAutoSignWeb3Auth : undefined}
  />
)}

            {/* ============================================================= */}
            {/* EARNINGS GROUP */}
            {/* ============================================================= */}
            <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3 mt-2">Earnings</h3>
            <div id="earnings" className="mb-6">
              {dashboardData && dashboardData.stores.length > 0 ? (
                <div className="bg-gradient-to-br from-sky-500/20 to-indigo-500/20 border border-sky-500/30 rounded-xl p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-zinc-400 text-sm mb-1">Total Earned</p>
                      <p className="text-4xl font-bold">{formatBalance(dashboardData.total_earned)}</p>
                      <p className="text-zinc-400 text-sm mt-1">RLUSD</p>
                    </div>
                    <div className="text-right">
                      <p className="text-zinc-400 text-sm mb-1">Active Vendors</p>
                      <p className="text-2xl font-bold">{dashboardData.stores.length}</p>
                    </div>
                  </div>
                </div>
              ) : (
                <button onClick={() => { setShowDiscover(true); fetchPublicStores(); setTimeout(() => scrollToSection('discover'), 100); }} className="w-full bg-gradient-to-br from-emerald-500/20 to-sky-500/20 border border-emerald-500/30 rounded-xl p-6 text-left hover:border-emerald-400/50 transition-colors">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-emerald-400 font-bold text-lg mb-1">üöÄ Join the Affiliate Program</p>
                      <p className="text-zinc-300 text-sm mb-2">Earn commissions 5 levels deep into the chain</p>
                      <p className="text-zinc-500 text-sm">Build passive income by referring customers to your favourite vendors</p>
                    </div>
                    <div className="text-emerald-400">
                      <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                    </div>
                  </div>
                </button>
              )}
            </div>

            {/* ============================================================= */}
            {/* WALLET & PAYMENTS - Two Column Layout */}
            {/* ============================================================= */}
            <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">Wallet</h3>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6 items-stretch">
              {/* LEFT COLUMN: Wallet Status */}
              <div id="wallet-status" className="h-full">
                {walletStatus && (
                  <div className="bg-zinc-900/70 border border-zinc-800 rounded-xl p-5 h-full flex flex-col">
                    <div id="wallet-balances">
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                          <h3 className="text-sm font-semibold text-zinc-400">Wallet Status</h3>
                          {loginMethod === 'web3auth' && socialProvider && (
                            <span className="bg-blue-500/20 text-blue-400 text-xs px-2 py-0.5 rounded capitalize flex items-center gap-1.5">
                              <SocialIcon provider={socialProvider} size="sm" />
                              {socialProvider}
                            </span>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          <button onClick={() => fetchWalletStatus(walletAddress, true)} className="text-zinc-400 hover:text-white transition-colors p-1" title="Refresh" disabled={refreshingWallet}>
                            <svg className={`w-5 h-5 ${refreshingWallet ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                          </button>
                          <button onClick={() => setShowBalances(!showBalances)} className="text-zinc-400 hover:text-white transition-colors p-1">
                            <EyeIcon open={showBalances} />
                          </button>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <p className="text-zinc-500 text-xs mb-1">XRP Balance</p>
                          <p className={`text-lg font-bold ${walletStatus.funded ? 'text-white' : 'text-orange-400'}`}>{walletStatus.funded ? formatXRP(walletStatus.xrp_balance) : 'Not Funded'}</p>
                        </div>
                        <div>
                          <p className="text-zinc-500 text-xs mb-1">RLUSD Balance</p>
                          <p className="text-lg font-bold text-white">{formatBalance(walletStatus.rlusd_balance)}</p>
                        </div>
                        <div>
                          <p className="text-zinc-500 text-xs mb-1">RLUSD Trustline</p>
                          <div className="flex items-center gap-2">
                            <span className={`w-2 h-2 rounded-full ${walletStatus.rlusd_trustline ? 'bg-emerald-500' : 'bg-orange-500'}`}></span>
                            <span className={walletStatus.rlusd_trustline ? 'text-emerald-400 text-sm' : 'text-orange-400 text-sm'}>{walletStatus.rlusd_trustline ? 'Set' : 'Not Set'}</span>
                          </div>
                        </div>
                        <div>
                          <p className="text-zinc-500 text-xs mb-1">Pending</p>
                          {walletStatus.pending_commissions ? (
                            <p className="text-lg font-bold text-amber-400">{formatBalance(walletStatus.pending_commissions.total)}</p>
                          ) : (
                            <p className="text-zinc-500 text-sm">None</p>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Feature Badges */}
                    <div className="flex flex-wrap gap-3 pt-4 border-t border-zinc-800">
                      <div className="flex items-center gap-2 bg-emerald-500/10 border border-emerald-500/20 rounded-lg px-3 py-2 flex-1 min-w-[80px]">
                        <svg className="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                        <div><p className="text-emerald-400 text-xs font-semibold">Instant</p></div>
                      </div>
                      <div className="flex items-center gap-2 bg-sky-500/10 border border-sky-500/20 rounded-lg px-3 py-2 flex-1 min-w-[80px]">
                        <svg className="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
                        <div><p className="text-sky-400 text-xs font-semibold">Secure</p></div>
                      </div>
                      <div className="flex items-center gap-2 bg-violet-500/10 border border-violet-500/20 rounded-lg px-3 py-2 flex-1 min-w-[80px]">
                        <svg className="w-4 h-4 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <div><p className="text-violet-400 text-xs font-semibold">24/7</p></div>
                      </div>
                    </div>

                    {/* Earn Interest - grows to fill remaining space */}
<div id="earn-interest" className="mt-4 pt-4 border-t border-zinc-800 flex-1">
  <EarnInterest noBorder rightColumnRef={rightColumnRef} openSections={openSections} dashboardType="affiliate" />
</div>

                    {!walletStatus.funded && (
                      <div className="mt-4 bg-orange-500/10 border border-orange-500/30 rounded-lg p-3">
                        <p className="text-orange-400 text-sm">üí° Your wallet is not funded yet. Commissions will accumulate until you reach {walletStatus.pending_commissions?.threshold || 1.2} XRP.</p>
                      </div>
                    )}
                    {walletStatus.funded && !walletStatus.rlusd_trustline && (
                      <div className="mt-4 bg-amber-500/10 border border-amber-500/30 rounded-lg p-3">
                        <p className="text-amber-400 text-sm">‚ö†Ô∏è Set up your RLUSD trustline to receive instant payments. <a href="https://xrpl.services/?issuer=rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De&currency=RLUSD&limit=10000000" target="_blank" rel="noopener noreferrer" className="underline ml-1 hover:text-amber-300">Set trustline ‚Üí</a></p>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* RIGHT COLUMN: Payments + Manage Funds in ONE card, same height as Wallet Status */}
<div ref={rightColumnRef} id="top-up" className="bg-zinc-900/70 border border-zinc-800 rounded-xl p-4 sm:p-5 h-full">
                {walletStatus && (
                  <div>
                    {/* PAYMENTS */}
                    <h3 className="text-sm font-semibold text-zinc-400 mb-4">Payments</h3>
                    <div className="space-y-3">
                      {/* TAP-TO-PAY */}
                      <CollapsibleSection dashboardType="affiliate" id="tap-to-pay" title="Tap-to-Pay Wallet" size="tall" icon={<img src="/dltpayslogo1.png" alt="Tap to Pay" className="w-5 h-5 rounded object-cover" />} isOpen={openSections['tap-to-pay']} onToggle={() => toggleSection('tap-to-pay')}>
                        <div className="px-0 py-3">
                          <div className="flex items-center gap-2 text-zinc-300 text-sm mb-4">
  <svg className="w-4 h-4 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
  <span>Auto-pay limit: <strong className="text-white">¬£25</strong> per transaction</span>
</div>
                          {loginMethod === 'web3auth' ? (
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2 text-emerald-400 text-sm"><span className="w-2 h-2 bg-emerald-500 rounded-full"></span>Connected via {socialProvider || 'Social'}</div>
                              <div className="flex items-center gap-3">
                                {autoSignEnabled && (
                                  <button onClick={revokeAutoSign} className="text-zinc-400 hover:text-orange-400 text-sm transition-colors">Revoke Auto-Pay</button>
                                )}
                                <button onClick={handleDisconnectWallet} className="text-zinc-400 hover:text-red-400 text-sm transition-colors">Disconnect</button>
                              </div>
                            </div>
                          ) : (
                            <button onClick={async () => {
                              try {
                                const { loginWithWeb3Auth } = await import('@/lib/web3auth');
                                const result = await loginWithWeb3Auth();
                                if (!result) return;
                                const address = typeof result === 'string' ? result : result.address;
                                const provider = typeof result === 'string' ? 'google' : (result.provider || 'google');
                                safeSetItem('walletAddress', address);
                                safeSetItem('loginMethod', 'web3auth');
                                safeSetItem('socialProvider', provider);
                                setWalletAddress(address);
                                setLoginMethod('web3auth');
                                setSocialProvider(provider);
                                fetchDashboard(address);
                                fetchWalletStatus(address);
                              } catch (err) { console.error('Web3Auth error:', err); }
                            }} className="w-full bg-gradient-to-r from-emerald-500/10 to-sky-500/10 border border-emerald-500/30 hover:border-emerald-500 text-white font-semibold py-3 rounded-xl transition flex items-center justify-center gap-3">
                              <div className="flex -space-x-2">
                                <div className="w-6 h-6 bg-white rounded-full flex items-center justify-center border-2 border-zinc-900">
                                  <svg className="w-3 h-3" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                                </div>
                                <div className="w-6 h-6 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
                                  <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
                                </div>
                                <div className="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center border-2 border-zinc-900">
                                  <span className="text-white text-[8px] font-bold">+10</span>
                                </div>
                              </div>
                              Connect to Tap-to-Pay
                            </button>
                          )}
                        </div>
                      </CollapsibleSection>

                      {/* CROSSMARK */}
                      <CollapsibleSection dashboardType="affiliate" id="browser-wallet" title="Browser Wallet" size="tall" icon={<img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-5 h-5 rounded" />} isOpen={openSections['browser-wallet']} onToggle={() => toggleSection('browser-wallet')}>
                        <div className="px-0 py-3">
                          <p className="text-zinc-400 text-sm mb-4">Crossmark browser extension for XRP Ledger.</p>
                          {loginMethod === 'crossmark' ? (
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2 text-emerald-400 text-sm"><span className="w-2 h-2 bg-emerald-500 rounded-full"></span>Connected</div>
                              <button onClick={handleDisconnectWallet} className="text-zinc-400 hover:text-red-400 text-sm transition-colors">Disconnect</button>
                            </div>
                          ) : (
                            <>
                              <button onClick={async () => {
                                try {
                                  const sdk = (window as any).xrpl?.crossmark;
                                  if (!sdk) { window.open('https://crossmark.io', '_blank'); return; }
                                  const response = await sdk.methods.signInAndWait();
                                  if (response?.response?.data?.address) {
                                    const newAddress = response.response.data.address;
                                    safeSetItem('walletAddress', newAddress);
                                    safeSetItem('loginMethod', 'crossmark');
                                    safeRemoveItem('socialProvider');
                                    setWalletAddress(newAddress);
                                    setLoginMethod('crossmark');
                                    setSocialProvider(null);
                                    fetchDashboard(newAddress);
                                    fetchWalletStatus(newAddress);
                                  }
                                } catch (err) { console.error('Crossmark error:', err); }
                              }} className="w-full bg-white hover:bg-zinc-200 text-black py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2"><img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-5 h-5 rounded" />Connect Browser Wallet</button>
                              <a href="https://crossmark.io" target="_blank" rel="noopener noreferrer" className="block text-center text-zinc-400 hover:text-zinc-300 text-sm mt-3">Get Crossmark ‚Üí</a>
                            </>
                          )}
                        </div>
                      </CollapsibleSection>

                      {/* XAMAN */}
                      <CollapsibleSection dashboardType="affiliate" id="xaman-wallet" title="Manual Wallet" size="tall" icon={<img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-5 h-5 rounded" />} isOpen={openSections['xaman-wallet']} onToggle={() => toggleSection('xaman-wallet')}>
                        <div className="px-0 py-3">
                          {connectingXaman && xamanQR ? (
                            <div className="text-center py-4">
                              <p className="text-zinc-300 mb-4">Scan with Xaman app</p>
                              <img src={xamanQR} alt="Xaman QR" className="mx-auto mb-4 rounded-lg max-w-[180px]" />
                              <div className="flex items-center justify-center gap-2 text-zinc-500 text-sm mb-4"><span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>Waiting...</div>
                              {xamanDeepLink && <a href={xamanDeepLink} className="text-sky-400 text-sm hover:underline block mb-4">Open in Xaman ‚Üí</a>}
                              <button onClick={cancelXamanConnection} className="text-zinc-500 text-sm hover:text-white">Cancel</button>
                            </div>
                          ) : (
                            <>
                              <p className="text-zinc-400 text-sm mb-4">Approve each transaction manually with push notifications.</p>
                              {loginMethod === 'xaman' ? (
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center gap-2 text-emerald-400 text-sm"><span className="w-2 h-2 bg-emerald-500 rounded-full"></span>Connected</div>
                                  <button onClick={handleDisconnectWallet} className="text-zinc-400 hover:text-red-400 text-sm transition-colors">Disconnect</button>
                                </div>
                              ) : (
                                <>
                                  <button onClick={connectXaman} disabled={connectingXaman} className="w-full bg-white hover:bg-zinc-200 disabled:bg-zinc-700 disabled:text-zinc-500 text-black py-3 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                    {connectingXaman && !xamanQR ? (<><span className="w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></span>Connecting...</>) : 'Connect Manual Wallet'}
                                  </button>
                                  <a href="https://xaman.app" target="_blank" rel="noopener noreferrer" className="block text-center text-zinc-400 hover:text-zinc-300 text-sm mt-3">Get Xaman ‚Üí</a>
                                </>
                              )}
                            </>
                          )}
                        </div>
                      </CollapsibleSection>

                      {/* NFC PAYMENT CARDS */}
                      <CollapsibleSection dashboardType="affiliate" id="payment-cards" title="Payment Cards" size="tall" icon={<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>} isOpen={openSections['payment-cards']} onToggle={() => toggleSection('payment-cards')}>
                        {walletAddress ? <LinkNFCCard walletAddress={walletAddress} noBorder /> : <p className="text-zinc-500 text-sm p-4">Connect a wallet to link your NFC cards</p>}
                      </CollapsibleSection>
                    </div>

                    {/* MANAGE FUNDS - below payments */}
                    <div className="mt-6 pt-4 border-t border-zinc-800">
                      <h3 className="text-sm font-semibold text-zinc-400 mb-4">Manage Funds</h3>
                      <div className="space-y-3">
                      <CollapsibleSection dashboardType="affiliate" id="top-up-inner" title="Top Up Wallet" size="tall" icon={<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m6-6H6" /></svg>} isOpen={openSections['top-up-inner']} onToggle={() => toggleSection('top-up-inner')}>
                        <TopUpRLUSD walletAddress={walletAddress} xrpBalance={walletStatus.xrp_balance} rlusdBalance={walletStatus.rlusd_balance} showAmounts={showBalances} onToggleAmounts={() => setShowBalances(!showBalances)} onRefresh={() => fetchWalletStatus(walletAddress)} />
                      </CollapsibleSection>
                      <CollapsibleSection dashboardType="affiliate" id="withdraw" title="Withdraw" size="tall" icon={<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>} isOpen={openSections['withdraw']} onToggle={() => toggleSection('withdraw')}>
                        <WithdrawRLUSD walletAddress={walletAddress} rlusdBalance={walletStatus.rlusd_balance} loginMethod={loginMethod as 'xaman' | 'crossmark' | 'web3auth' | null} showAmounts={showBalances} onToggleAmounts={() => setShowBalances(!showBalances)} onRefresh={() => fetchWalletStatus(walletAddress)} />
                      </CollapsibleSection>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* ============================================================= */}
            {/* VENDORS GROUP */}
            {/* ============================================================= */}
            <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">Vendors</h3>
            
            {/* YOUR VENDORS */}
            {dashboardData && dashboardData.stores.length > 0 && (
              <div id="vendors" className="mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-bold">My Affiliate Programs</h2>
                  <button 
  onClick={() => { setShowDiscover(!showDiscover); if (!showDiscover) fetchPublicStores(); }} 
  className="group relative"
>
  {showDiscover ? (
    <span className="text-zinc-400 hover:text-white text-sm transition-colors">Hide ‚úï</span>
  ) : (
    <svg 
      viewBox="0 0 180 42" 
      className="w-auto h-10 transition-all duration-300 hover:scale-105"
    >
      <defs>
        <linearGradient id="discoverGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stopColor="#06b6d4" />
          <stop offset="50%" stopColor="#3b82f6" />
          <stop offset="100%" stopColor="#8b5cf6" />
        </linearGradient>
        
        <filter id="glow">
          <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      
      <rect 
        x="1" 
        y="1" 
        width="178" 
        height="40" 
        rx="8" 
        fill="rgba(24, 24, 27, 0.6)"
        stroke="url(#discoverGradient)"
        strokeWidth="1.5"
        className="transition-all duration-300 group-hover:fill-zinc-800/80"
      />
      
      <circle cx="15" cy="21" r="1.5" fill="#3b82f6" opacity="0.4" />
      <circle cx="165" cy="21" r="1.5" fill="#8b5cf6" opacity="0.4" />
      
      <text 
        x="35" 
        y="26" 
        fill="url(#discoverGradient)"
        fontFamily="system-ui, -apple-system, sans-serif" 
        fontWeight="600" 
        fontSize="14"
        letterSpacing="0.5"
        filter="url(#glow)"
      >
        Discover More
      </text>
      
      <g transform="translate(145, 16)" className="transition-transform duration-300 group-hover:translate-x-1">
        <path 
          d="M0 5 L8 5 M5 2 L8 5 L5 8" 
          stroke="url(#discoverGradient)" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round"
          fill="none"
        />
      </g>
    </svg>
  )}
</button>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  {dashboardData.stores.map((store, i) => (
                    <div 
  key={`${store.store_id}-${i}`} 
  className="group relative bg-zinc-900/70 border border-zinc-800 hover:border-sky-500/50 rounded-xl p-5 transition-all duration-300 hover:shadow-[0_0_30px_-5px_rgba(14,165,233,0.3)] hover:scale-[1.02]"
>
  {/* Gradient glow on hover */}
  <div className="absolute inset-0 bg-gradient-to-br from-sky-500/0 via-purple-500/0 to-emerald-500/0 group-hover:from-sky-500/5 group-hover:via-purple-500/5 group-hover:to-emerald-500/5 rounded-xl transition-all duration-300 pointer-events-none"></div>
  
  <div className="relative flex items-start gap-4 mb-4">
    {/* Store Logo */}
    <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-sky-500/20 to-purple-500/20 border border-sky-500/30 flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform duration-300">
      {store.logo_url ? (
        <img src={store.logo_url} alt={store.store_name} className="w-full h-full rounded-xl object-cover" />
      ) : (
        <span className="text-2xl font-bold bg-gradient-to-br from-sky-400 to-purple-400 bg-clip-text text-transparent">
          {store.store_name.charAt(0)}
        </span>
      )}
    </div>
    
    <div className="flex-1 min-w-0">
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 min-w-0">
          <h3 className="font-semibold text-lg truncate group-hover:text-sky-400 transition-colors">
            {store.store_name}
          </h3>
          <p className="text-zinc-500 text-sm truncate">{store.store_url}</p>
        </div>
        <div className="text-right flex-shrink-0">
          <p className="text-xl font-bold text-emerald-400">{formatBalance(store.total_earned)}</p>
          <p className="text-zinc-500 text-sm">earned</p>
        </div>
      </div>
      
      {/* Level Badge */}
      <div className="flex items-center gap-2 mt-2">
        <div className="bg-gradient-to-r from-emerald-500/20 to-sky-500/20 border border-emerald-500/30 rounded-full px-3 py-1 text-xs font-semibold text-emerald-400">
          Level {store.level}
        </div>
        {store.commission_rates && store.commission_rates[0] && (
          <div className="text-zinc-500 text-xs">
            {store.commission_rates[0]}% commission
          </div>
        )}
      </div>
    </div>
  </div>
  
  {/* Referral Link Section */}
  <div className="relative bg-zinc-800/50 border border-zinc-700/50 group-hover:border-sky-500/30 rounded-lg p-3 transition-colors">
    {/* Gradient accent line */}
    <div className="absolute top-0 left-0 right-0 h-[2px] bg-gradient-to-r from-sky-500/0 via-sky-500/50 to-sky-500/0 opacity-0 group-hover:opacity-100 transition-opacity rounded-t-lg"></div>
    
    <div className="flex items-center justify-between gap-3 mb-2">
      <div className="flex-1 min-w-0">
        <p className="text-zinc-400 text-xs mb-1">Your Referral Link</p>
        <p className="text-sm font-mono truncate text-sky-400">{store.referral_link}</p>
      </div>
      <div className="flex gap-2 flex-shrink-0">
        <button 
          onClick={() => handleCopyLink(store.referral_link, store.referral_code)} 
          className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
            copiedCode === store.referral_code 
              ? 'bg-emerald-500 text-black scale-95' 
              : 'bg-zinc-700 hover:bg-zinc-600 text-white hover:scale-105'
          }`}
        >
          {copiedCode === store.referral_code ? '‚úì Copied' : 'Copy'}
        </button>
        <button 
          onClick={() => { setQrUrl(store.referral_link); setQrStoreName(store.store_name); setShowQRModal(true); }} 
          className="px-4 py-2 rounded-lg text-sm font-medium bg-gradient-to-r from-emerald-600 to-sky-600 hover:from-emerald-500 hover:to-sky-500 text-white transition-all hover:scale-105 hover:shadow-lg hover:shadow-emerald-500/25"
        >
          QR
        </button>
      </div>
    </div>
    
    <div className="flex items-center justify-between text-xs">
      <p className="text-zinc-500">
        Code: <span className="font-mono text-zinc-300 bg-zinc-900/50 px-2 py-0.5 rounded">{store.referral_code}</span>
      </p>
    </div>
  </div>
</div>
                  ))}
                </div>
              </div>
            )}

            {/* DISCOVER VENDORS */}
            <div id="discover">
              {showDiscover && (
                <section className="mb-6">
<div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-bold">{dashboardData?.stores.length ? 'Discover More Vendors' : 'Join a Vendor to Start Earning'}</h2>
                    {dashboardData?.stores.length ? <button onClick={() => setShowDiscover(false)} className="text-zinc-400 hover:text-white text-sm">Close ‚úï</button> : null}
                  </div>
                  <div className="mb-4">
                    <input type="text" placeholder="Search vendors..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-zinc-900/70 border border-zinc-700 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-sky-500" />
                  </div>
                  {filteredStores.length === 0 ? (
                    <div className="bg-zinc-900/70 border border-zinc-800 rounded-xl p-6 text-center">
                      <p className="text-zinc-400">{publicStores.length === 0 ? 'Loading vendors...' : 'No vendors found matching your search.'}</p>
                    </div>
                  ) : (
                    <div className="grid gap-4 sm:grid-cols-2">
                      {filteredStores.map((store) => (
                        <div key={store.store_id} className="bg-zinc-900/70 border border-zinc-800 rounded-xl p-5">
                          <div className="mb-3">
                            <h3 className="font-semibold text-lg">{store.store_name}</h3>
                            <p className="text-zinc-500 text-sm truncate">{store.store_url}</p>
                          </div>
                          <div className="flex items-center gap-4 mb-4 text-sm">
                            <div><span className="text-zinc-500">L1: </span><span className="text-emerald-400 font-medium">{store.commission_rates[0]}%</span></div>
                            <div><span className="text-zinc-500">Affiliates: </span><span className="text-white">{store.affiliates_count}</span></div>
                          </div>
                          {isJoined(store.store_id) ? (
                            <button disabled className="w-full bg-zinc-700 text-zinc-400 py-2 px-4 rounded-lg text-sm font-medium">‚úì Already Joined</button>
                          ) : (
                            <button onClick={() => handleJoinStore(store.store_id)} disabled={joiningStore === store.store_id} className="w-full bg-sky-600 hover:bg-sky-500 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors disabled:opacity-50">
                              {joiningStore === store.store_id ? <span className="flex items-center justify-center gap-2"><span className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>Joining...</span> : 'Join as Affiliate'}
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </section>
              )}
              {(!dashboardData || dashboardData.stores.length === 0) && !showDiscover && (
                <div className="bg-zinc-900/70 border border-zinc-800 rounded-xl p-8 text-center mb-6">
                  <p className="text-zinc-400 mb-4">You haven&apos;t joined any vendor programs yet.</p>
                  <button onClick={() => { setShowDiscover(true); fetchPublicStores(); }} className="bg-sky-600 hover:bg-sky-500 text-white py-3 px-6 rounded-lg font-medium transition-colors">Discover Vendors</button>
                </div>
              )}
            </div>

            {/* ============================================================= */}
            {/* HISTORY GROUP */}
            {/* ============================================================= */}
            {dashboardData && dashboardData.stores.length > 0 && (
              <>
                <h3 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3">History</h3>
                <CollapsibleSection dashboardType="affiliate" id="payouts" title="Recent Payouts" videoBg="/nebula-bgActivityButton.webm" icon={<svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>} isOpen={openSections['payouts']} onToggle={() => toggleSection('payouts')}>
                  <PayoutsTable payouts={dashboardData.recent_payouts} showBalances={showBalances} />
                </CollapsibleSection>
              </>
            )}

            {/* Danger Zone */}
            <div className="mt-4">
            <CollapsibleSection 
              dashboardType="affiliate"
              id="danger-zone"
              title="Danger Zone"
              icon={
                <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
              }
              isOpen={openSections['danger-zone']}
              onToggle={() => toggleSection('danger-zone')}
            >
              <div className="p-4">
                <p className="text-zinc-400 text-sm mb-4">
                  Permanently delete your affiliate account and all associated data including earnings history, referral links, and wallet connection. This action cannot be undone.
                </p>
                <button
  onClick={() => setShowDeleteModal(true)}
  disabled={loading}
                  className="bg-zinc-900/95 border-2 border-red-500 text-red-400 hover:bg-red-500 hover:text-white px-6 py-2 rounded-lg font-semibold transition disabled:opacity-50 flex items-center gap-2"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                  </svg>
                  Permanently Delete My Data
                </button>
              </div>
            </CollapsibleSection>
            </div>

          </div>
        </main>
      </div>

      {/* Delete Confirmation Modal */}
<DeleteConfirmModal
  isOpen={showDeleteModal}
  onClose={() => setShowDeleteModal(false)}
  onConfirm={deleteAffiliateData}
  title="Delete All Data"
  description="This will permanently delete all your affiliate data, earnings history, referral links, and disconnect your wallet. This action cannot be undone."
  loading={deleting}
/>

      {/* Receive Modal */}
      {showReceiveModal && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
          <div className="bg-zinc-900/70 border border-zinc-800 rounded-xl p-6 max-w-sm w-full">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold">Receive</h3>
              <button onClick={() => setShowReceiveModal(false)} className="text-zinc-400 hover:text-white"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <p className="text-zinc-400 text-sm mb-4">Share your wallet address or QR code to receive XRP or RLUSD.</p>
            <div className="bg-white p-4 rounded-lg mb-4">
              <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${walletAddress}`} alt="Wallet QR Code" className="w-full max-w-[200px] mx-auto" />
            </div>
            <div className="bg-zinc-800 rounded-lg p-3 mb-4">
              <p className="text-zinc-500 text-xs mb-1">Your Address</p>
              <p className="font-mono text-sm break-all">{walletAddress}</p>
            </div>
            <button onClick={() => { navigator.clipboard.writeText(walletAddress); setCopiedAddress(true); setTimeout(() => setCopiedAddress(false), 2000); }} className={`w-full py-3 rounded-lg text-sm font-medium transition-colors ${copiedAddress ? 'bg-emerald-500 text-black' : 'bg-zinc-700 hover:bg-zinc-600 text-white'}`}>{copiedAddress ? '‚úì Copied!' : 'Copy Address'}</button>
          </div>
        </div>
      )}

      <QRCodeModal isOpen={showQRModal} onClose={() => setShowQRModal(false)} url={qrUrl} title="Share Referral Link" subtitle={qrStoreName} />
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/analytics/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, Suspense } from 'react';
import { safeGetItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';
import NebulaBackground from '@/components/NebulaBackground';


// MARK: - Types & Interfaces
interface ReceiptItem {
  name: string;
  quantity: number;
  unit_price: number;
  line_total: number;
}

interface Receipt {
  receipt_id: string;
  receipt_number: string;
  customer_wallet: string;
  items: ReceiptItem[];
  total: number;
  currency: string;
  payment_method?: string;
  payment_status: string;
  payment_tx_hash: string;
  paid_at: string;
  created_at: string;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
function AnalyticsPage() {
  const router = useRouter();
  
  // Auth
  const [walletAddress, setWalletAddress] = useState<string | null>(null);
  const [storeId, setStoreId] = useState<string | null>(null);
  const [storeName, setStoreName] = useState<string>('');
  const [storeLogo, setStoreLogo] = useState<string | null>(null);
  
  // Data
  const [receipts, setReceipts] = useState<Receipt[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  
  // Time period
  const [period, setPeriod] = useState<'today' | 'week' | 'month' | 'all'>('week');

  // Load store data

// MARK: - Hooks & Effects
  useEffect(() => {
    const stored = safeGetItem('vendorWalletAddress');
    const storeData = safeGetItem('storeData');
    
    if (!stored) {
      router.push('/dashboard');
      return;
    }
    
    setWalletAddress(stored);
    
    if (storeData) {
      const store = JSON.parse(storeData);
      setStoreId(store.store_id || null);
      setStoreName(store.store_name || 'Your Store');
      setStoreLogo(store.logo_url || null);
    }
  }, [router]);

  // Fetch receipts
  useEffect(() => {
    if (storeId && walletAddress) {
      fetchReceipts();
    }
  }, [storeId, walletAddress]);


// MARK: - API Calls & Data Fetching
  const fetchReceipts = async () => {
    setLoading(true);
    try {
      const res = await fetch(
        `${API_URL}/store/${storeId}/receipts?wallet_address=${walletAddress}&limit=10000`
      );
      const data = await res.json();
      console.log('üìä Receipts response:', data);
      if (data.success) {
        setReceipts(data.receipts);
        // Debug: Check for tips in receipts
        const receiptsWithTips = data.receipts.filter((r: Receipt) => 
          r.items?.some((i: ReceiptItem) => i.name?.toLowerCase() === 'tip')
        );
        console.log('üßæ Total receipts:', data.receipts.length);
        console.log('üí∞ Receipts with tips:', receiptsWithTips.length);
        if (data.receipts.length > 0) {
          console.log('üìù Sample receipt items:', data.receipts[0].items);
        }
      }
    } catch (err) {
      console.error('Failed to load receipts');
    }
    setLoading(false);
  };

  // Filter receipts by period
  const getFilteredReceipts = () => {
    const now = new Date();
    let filtered = [...receipts];
    
    if (period === 'today') {
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      filtered = filtered.filter(r => new Date(r.paid_at || r.created_at) >= todayStart);
    } else if (period === 'week') {
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(r => new Date(r.paid_at || r.created_at) >= weekAgo);
    } else if (period === 'month') {
      const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(r => new Date(r.paid_at || r.created_at) >= monthAgo);
    }
    
    return filtered.sort((a, b) => new Date(b.paid_at || b.created_at).getTime() - new Date(a.paid_at || a.created_at).getTime());
  };

  const filteredReceipts = getFilteredReceipts();

  // Calculate stats
  const totalRevenue = filteredReceipts.reduce((sum, r) => sum + r.total, 0);
  const transactionCount = filteredReceipts.length;
  const avgTransaction = transactionCount > 0 ? totalRevenue / transactionCount : 0;

  // Previous period comparison
  const getPreviousPeriodReceipts = () => {
    const now = new Date();
    let start: Date, end: Date;
    
    if (period === 'today') {
      end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      start = new Date(end.getTime() - 24 * 60 * 60 * 1000);
    } else if (period === 'week') {
      end = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      start = new Date(end.getTime() - 7 * 24 * 60 * 60 * 1000);
    } else if (period === 'month') {
      end = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      start = new Date(end.getTime() - 30 * 24 * 60 * 60 * 1000);
    } else {
      return [];
    }
    
    return receipts.filter(r => {
      const date = new Date(r.paid_at || r.created_at);
      return date >= start && date < end;
    });
  };

  const previousReceipts = getPreviousPeriodReceipts();
  const previousRevenue = previousReceipts.reduce((sum, r) => sum + r.total, 0);
  const revenueChange = previousRevenue > 0 
    ? ((totalRevenue - previousRevenue) / previousRevenue) * 100 
    : totalRevenue > 0 ? 100 : 0;

  // Tips calculation - check multiple possible tip naming conventions
  const totalTips = filteredReceipts.reduce((sum, r) => {
    const tipItem = r.items.find(i => 
      i.name.toLowerCase() === 'tip' || 
      i.name.toLowerCase() === 'gratuity' ||
      i.name.toLowerCase().includes('tip')
    );
    return sum + (tipItem?.line_total || tipItem?.unit_price || 0);
  }, 0);

  // Payment method breakdown - all methods
  const paymentMethodCounts = filteredReceipts.reduce((acc, r) => {
    const method = r.payment_method || 'unknown';
    acc[method] = (acc[method] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);
  
  const methodLabels: Record<string, string> = {
    'qr_xaman': 'QR (Xaman)',
    'xaman_qr': 'QR (Xaman)',
    'nfc_card': 'NFC Card',
    'web3auth': 'Web3Auth',
    'crossmark': 'Crossmark',
    'sound': 'Sound Payment',
    'unknown': 'Other'
  };
  
  const methodColors: Record<string, string> = {
    'qr_xaman': 'bg-sky-500',
    'xaman_qr': 'bg-sky-500',
    'nfc_card': 'bg-emerald-500',
    'web3auth': 'bg-purple-500',
    'crossmark': 'bg-amber-500',
    'sound': 'bg-pink-500',
    'unknown': 'bg-zinc-500'
  };

  // Top products
const productSales: Record<string, { quantity: number; revenue: number }> = {};
filteredReceipts.forEach(r => {
  r.items.forEach(item => {
    if (item.name.toLowerCase() !== 'tip' && 
        item.name.toLowerCase() !== 'payment' &&
        item.name.toLowerCase() !== 'sound payment') {
      if (!productSales[item.name]) {
        productSales[item.name] = { quantity: 0, revenue: 0 };
      }
      const qty = Number(item.quantity) || 0;
      const lineTotal = Number(item.line_total) || (Number(item.unit_price) * qty) || 0;
      productSales[item.name].quantity += qty;
      productSales[item.name].revenue += lineTotal;
    }
  });
});
  const topProducts = Object.entries(productSales)
    .sort((a, b) => b[1].revenue - a[1].revenue)
    .slice(0, 5);

console.log('üõí Product sales data:', productSales);
console.log('üèÜ Top products:', topProducts);

  // Sales by day - responds to period
const getSalesByDay = () => {
  const days: { day: string; revenue: number; count: number }[] = [];
  const numDays = period === 'week' ? 7 : period === 'month' ? 30 : period === 'today' ? 1 : 90;
  
  for (let i = numDays - 1; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);
    
    const dayReceipts = receipts.filter(r => {
      const rDate = new Date(r.paid_at || r.created_at);
      return rDate >= dayStart && rDate < dayEnd;
    });
    
    days.push({
      day: numDays <= 7 
        ? dayStart.toLocaleDateString('en-GB', { weekday: 'short' })
        : dayStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }),
      revenue: dayReceipts.reduce((sum, r) => sum + r.total, 0),
      count: dayReceipts.length
    });
  }
  
  // For month/all, group into chunks to avoid too many bars
  if (numDays > 14) {
    const chunkSize = Math.ceil(numDays / 10);
    const chunked: typeof days = [];
    for (let i = 0; i < days.length; i += chunkSize) {
      const chunk = days.slice(i, i + chunkSize);
      chunked.push({
        day: chunk[0].day,
        revenue: chunk.reduce((sum, d) => sum + d.revenue, 0),
        count: chunk.reduce((sum, d) => sum + d.count, 0)
      });
    }
    return chunked;
  }
  
  return days;
};

const salesByDay = getSalesByDay();
const maxDayRevenue = Math.max(...salesByDay.map(d => d.revenue), 1);

// Hourly breakdown for the selected period (aggregated)
const getPeriodHourlyData = () => {
  const hourlyTotals: { hour: string; revenue: number; count: number }[] = [];
  
  for (let h = 0; h < 24; h++) {
    hourlyTotals.push({
      hour: `${h.toString().padStart(2, '0')}:00`,
      revenue: 0,
      count: 0
    });
  }
  
  filteredReceipts.forEach(r => {
    const hour = new Date(r.paid_at || r.created_at).getHours();
    hourlyTotals[hour].revenue += r.total;
    hourlyTotals[hour].count += 1;
  });
  
  return hourlyTotals;
};

const periodHourlyData = getPeriodHourlyData();
const maxPeriodHourRevenue = Math.max(...periodHourlyData.map(h => h.revenue), 1);
const periodPeakHour = periodHourlyData.reduce((max, h) => h.revenue > max.revenue ? h : max, periodHourlyData[0]);

  // Format time ago
  const timeAgo = (dateStr: string) => {
  if (!dateStr) return 'Just now';
  const date = new Date(dateStr);
  if (isNaN(date.getTime())) return 'Just now';
  const now = new Date();
    const diff = now.getTime() - date.getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return `${days}d ago`;
  };


// MARK: - Main Render
  return (
    <>
      <NebulaBackground opacity={0.3} />
      <div className="min-h-screen bg-transparent text-white font-sans overflow-x-hidden">
      
        {/* Header */}
      <header className="sticky top-0 z-40 bg-gradient-to-r from-zinc-600/20 via-zinc-400/15 via-zinc-500/10 to-zinc-800/20 backdrop-blur border-b border-zinc-500/30">
        <div className="max-w-4xl lg:max-w-none mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-1">
  <button

// MARK: - Event Handlers
    onClick={() => router.push('/take-payment')}
    className="text-zinc-400 hover:text-white transition flex items-center gap-1 cursor-pointer active:scale-95"
  >
    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </svg>
  </button>
  <button
    onClick={() => router.push('/dashboard')}
    className="text-zinc-400 hover:text-white transition p-2 cursor-pointer active:scale-95"
    title="Dashboard"
  >
    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </svg>
  </button>
</div>
          
          <div className="flex items-center gap-2">
            {storeLogo ? (
              <img src={storeLogo} alt="" className="w-8 h-8 rounded-lg object-cover" />
            ) : null}
            <h1 className="text-lg font-bold">Analytics</h1>
          </div>
          
          <button
            onClick={fetchReceipts}
            className="text-zinc-400 hover:text-white transition p-2 cursor-pointer active:scale-95"
            title="Refresh"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </button>
        </div>
      </header>

      <main className="max-w-4xl lg:max-w-none mx-auto px-4 lg:px-6 pb-8">
        
        {/* Period Selector + Fee Info */}
<div className="flex flex-wrap items-center justify-between gap-4 py-6">
  <div className="flex gap-2 overflow-x-auto pb-2 -mb-2" style={{ scrollbarWidth: 'none', msOverflowStyle: 'none', WebkitOverflowScrolling: 'touch' }}>
  {(['today', 'week', 'month', 'all'] as const).map((p) => (
            <button
              key={p}
              onClick={() => setPeriod(p)}
              className={`px-5 py-2.5 rounded-full text-sm font-medium whitespace-nowrap transition cursor-pointer active:scale-95 ${
                period === p
                  ? 'bg-emerald-500 text-black'
                  : 'bg-zinc-800 text-zinc-400 hover:text-white'
              }`}
            >
              {p === 'today' ? 'Today' : p === 'week' ? 'This Week' : p === 'month' ? 'This Month' : 'All Time'}
            </button>
          ))}
  </div>
  
 {/* Fee Info - Two compact badges */}
  <div className="grid grid-cols-2 gap-2 text-xs w-full sm:w-auto sm:flex">
    <div className="flex items-center justify-center gap-2 bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2">
      <span className="text-zinc-500">Platform:</span>
      <span className="text-amber-400 font-mono font-medium">0.5%</span>
      <span className="text-zinc-600">(¬£{(totalRevenue * 0.005).toFixed(2)})</span>
    </div>
    <div className="flex items-center justify-center gap-2 bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2">
      <span className="text-zinc-500">Commission:</span>
      <span className="text-emerald-400 font-mono font-medium">2.9%</span>
      <span className="text-zinc-600 hidden sm:inline">(Free tier)</span>
    </div>
  </div>
</div>
        {/* Loading */}
        {loading && (
          <div className="text-center py-20">
            <div className="w-10 h-10 border-3 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p className="text-zinc-500">Loading analytics...</p>
          </div>
        )}

        {!loading && (
          <>
            {/* Main Stats */}
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
              {/* Revenue */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
                <p className="text-zinc-500 text-sm mb-1">Revenue</p>
                <p className="text-3xl sm:text-4xl font-bold text-emerald-400">¬£{totalRevenue.toFixed(2)}</p>
                {period !== 'all' && (
                  <p className={`text-sm mt-2 ${revenueChange >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                    {revenueChange >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(revenueChange).toFixed(0)}% vs last {period === 'today' ? 'day' : period}
                  </p>
                )}
              </div>

              {/* Transactions */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
                <p className="text-zinc-500 text-sm mb-1">Transactions</p>
                <p className="text-3xl sm:text-4xl font-bold">{transactionCount}</p>
                <p className="text-zinc-600 text-sm mt-2">
                  {period === 'today' ? 'today' : period === 'week' ? 'this week' : period === 'month' ? 'this month' : 'total'}
                </p>
              </div>

              {/* Average */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
                <p className="text-zinc-500 text-sm mb-1">Avg Sale</p>
                <p className="text-3xl sm:text-4xl font-bold">¬£{avgTransaction.toFixed(2)}</p>
                <p className="text-zinc-600 text-sm mt-2">per transaction</p>
              </div>

              {/* Tips */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
                <p className="text-zinc-500 text-sm mb-1">Tips</p>
                <p className="text-3xl sm:text-4xl font-bold text-amber-400">¬£{totalTips.toFixed(2)}</p>
                <p className="text-zinc-600 text-sm mt-2">
                  {totalRevenue > 0 ? ((totalTips / totalRevenue) * 100).toFixed(1) : 0}% of sales
                </p>
              </div>
            </div>

            {/* Charts Row */}
<div className="grid lg:grid-cols-2 gap-6 mb-8">
  
  {/* Sales Over Time - responds to period */}
  <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
    <h3 className="font-semibold mb-4">
      {period === 'today' ? 'Today by Hour' : period === 'week' ? 'Last 7 Days' : period === 'month' ? 'Last 30 Days' : 'All Time by Month'}
    </h3>
    
    {period === 'today' ? (
  /* Hourly view for today */
  <>
    <div className="flex items-end gap-0.5 h-40 overflow-x-auto max-w-full">
      {periodHourlyData.filter((_, i) => i >= 6 && i <= 22).map((hour, i) => (
        <div key={i} className="flex-1 min-w-0 flex flex-col items-center gap-1">
          <div className="w-full bg-zinc-800 rounded-t relative" style={{ height: '110px' }}>
            <div 
              className="absolute bottom-0 left-0 right-0 bg-emerald-500 rounded-t transition-all duration-500"
              style={{ height: `${(hour.revenue / maxPeriodHourRevenue) * 100}%` }}
            />
          </div>
          <span className="text-zinc-600 text-[10px]">{hour.hour.split(':')[0]}</span>
        </div>
      ))}
    </div>
    <div className="flex justify-between mt-4 text-sm">
      <span className="text-zinc-500">Peak hour</span>
      <span className="font-semibold text-emerald-400">{periodPeakHour?.hour || '--'}</span>
    </div>
  </>
): (
      /* Daily/Weekly/Monthly view */
      <>
        <div className="flex items-end gap-2 h-40 max-w-full">
  {salesByDay.map((day, i) => (
    <div key={i} className="flex-1 min-w-0 flex flex-col items-center gap-2">
              <div className="w-full bg-zinc-800 rounded-t-lg relative" style={{ height: '120px' }}>
                <div 
                  className="absolute bottom-0 left-0 right-0 bg-emerald-500 rounded-t-lg transition-all duration-500"
                  style={{ height: `${(day.revenue / maxDayRevenue) * 100}%` }}
                />
              </div>
              <span className="text-zinc-500 text-xs">{day.day}</span>
            </div>
          ))}
        </div>
        <div className="flex justify-between mt-4 text-sm">
          <span className="text-zinc-500">{period === 'week' ? '7 day' : period === 'month' ? '30 day' : 'Total'}</span>
          <span className="font-semibold text-emerald-400">
            ¬£{salesByDay.reduce((sum, d) => sum + d.revenue, 0).toFixed(2)}
          </span>
        </div>
      </>
    )}
  </div>

  {/* Busiest Times - always shows hourly heatmap for selected period */}
  <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
    <h3 className="font-semibold mb-4">Busiest Hours</h3>
    <div className="flex items-end gap-0.5 h-40 overflow-x-auto max-w-full">
      {periodHourlyData.filter((_, i) => i >= 6 && i <= 22).map((hour, i) => (
        <div key={i} className="flex-1 min-w-0 flex flex-col items-center gap-1">
          <div className="w-full bg-zinc-800 rounded-t relative" style={{ height: '110px' }}>
            <div 
              className="absolute bottom-0 left-0 right-0 bg-sky-500 rounded-t transition-all duration-500"
              style={{ height: `${maxPeriodHourRevenue > 0 ? (hour.revenue / maxPeriodHourRevenue) * 100 : 0}%` }}
            />
          </div>
          <span className="text-zinc-600 text-[10px]">{hour.hour.split(':')[0]}</span>
        </div>
      ))}
    </div>
    <div className="flex justify-between mt-4 text-sm">
      <span className="text-zinc-500">Peak hour ({period === 'today' ? 'today' : period === 'week' ? 'this week' : period === 'month' ? 'this month' : 'all time'})</span>
      <span className="font-semibold text-sky-400">{periodPeakHour?.hour || '--'}</span>
    </div>
  </div>
</div>

            {/* Bottom Row */}
            <div className="grid lg:grid-cols-3 gap-6">
              
              {/* Payment Methods */}
<div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
  <h3 className="font-semibold mb-4">Payment Methods</h3>
  <div className="space-y-3">
    {Object.entries(paymentMethodCounts)
      .sort((a, b) => b[1] - a[1])
      .map(([method, count]) => (
        <div key={method}>
          <div className="flex justify-between text-sm mb-1">
            <span>{methodLabels[method] || method}</span>
            <span className="font-medium">{count}</span>
          </div>
          <div className="h-2 bg-zinc-800 rounded-full overflow-hidden">
            <div 
              className={`h-full ${methodColors[method] || 'bg-zinc-500'} rounded-full transition-all duration-500`}
              style={{ width: `${transactionCount > 0 ? (count / transactionCount) * 100 : 0}%` }}
            />
          </div>
        </div>
      ))}
  </div>
</div>

              {/* Top Products */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
                <h3 className="font-semibold mb-4">Top Products</h3>
                {topProducts.length > 0 ? (
                  <div className="space-y-3">
                    {topProducts.map(([name, data], i) => (
  <div key={name} className="flex items-center justify-between">
    <div className="flex items-center gap-3">
      <span className="text-zinc-600 text-sm font-medium w-5">{i + 1}</span>
      <span className="text-sm truncate max-w-[120px]">{name}</span>
    </div>
    <div className="text-right">
      <p className="text-sm font-medium text-emerald-400">¬£{(data?.revenue || 0).toFixed(2)}</p>
      <p className="text-zinc-600 text-xs">{data?.quantity || 0} sold</p>
    </div>
  </div>
))}
                  </div>
                ) : (
                  <p className="text-zinc-500 text-sm">No product sales yet</p>
                )}
              </div>

              {/* Recent Activity */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-semibold">Recent Activity</h3>
                  <button 
                    onClick={() => router.push('/receipts')}
                    className="text-emerald-400 text-sm hover:underline cursor-pointer"
                  >
                    View all
                  </button>
                </div>
                {filteredReceipts.length > 0 ? (
                  <div className="space-y-3">
                    {filteredReceipts.slice(0, 5).map((r) => (
                      <div key={r.receipt_id} className="flex items-center justify-between py-2 border-b border-zinc-800 last:border-0">
                        <div>
                          <p className="text-sm font-medium">
                            {r.items.length === 1 ? r.items[0].name : `${r.items.length} items`}
                          </p>
                          <p className="text-zinc-500 text-xs">{timeAgo(r.paid_at || r.created_at)}</p>
                        </div>
                        <p className="font-semibold text-emerald-400">¬£{r.total.toFixed(2)}</p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-zinc-500 text-sm">No transactions yet</p>
                )}
              </div>
            </div>

            {/* YAOFUS Pioneers Badge */}
            <div className="mt-8 flex flex-col items-center gap-1">
              <span className="text-zinc-500 text-[10px] font-medium tracking-wider">PRECISION</span>
              <span className="text-base font-extrabold tracking-widest">
                <span className="text-emerald-500">Y</span>
                <span className="text-green-500">A</span>
                <span className="text-blue-500">O</span>
                <span className="text-indigo-500">F</span>
                <span className="text-violet-500">U</span>
                <span className="text-purple-500">S</span>
              </span>
              <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">ANALYTICS</span>
              <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
                <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
                <span>Powered by YesAllOfUs</span>
              </div>
            </div>
          </>
        )}
      </main>
    </div>
    </>
  );
}

export default function AnalyticsPageWrapper() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center">
        <div className="w-10 h-10 border-3 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    }>
      <AnalyticsPage />
    </Suspense>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/api/exchanges/route.ts
// =================================================
export async function GET() {
  try {
    const res = await fetch('https://tokencanvas.io/api/coingecko/coins/ripple/tickers');
    const data = await res.json();
    return Response.json(data);
  } catch (error) {
    return Response.json({ error: 'Failed to fetch' }, { status: 500 });
  }
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/checkout/[sessionId]/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem } from '@/lib/safeStorage';
import { useParams } from 'next/navigation';
import NebulaBackground from '@/components/NebulaBackground';
import PaymentOptions from '@/components/PaymentOptions';
import TipSelector from '@/components/TipSelector';
import SplitBillModal from '@/components/SplitBillModal';
import ReceiptActions from '@/components/ReceiptActions';
import NFCTapPay from '@/components/NFCTapPay';
import AutoSignModal from '@/components/AutoSignModal';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/plugins/api/v1';

// Valid session ID pattern (alphanumeric, underscores, hyphens)
const VALID_ID_PATTERN = /^[a-zA-Z0-9_-]+$/;


// MARK: - Types & Interfaces
interface CheckoutSession {
  session_id: string;
  platform: string;
  store_name: string;
  store_logo: string | null;
  vendor_wallet: string;
  amount: number;
  currency: string;
  order_id: string | null;
  order_reference: string | null;
  items: Array<{ name: string; quantity: number; unit_price: number }>;
  status: string;
  tx_hash: string | null;
  receipt_id: string | null;
  payment_link_id: string | null;
  expires_at: string | null;
  paid_at: string | null;
  success_url: string | null;
  cancel_url: string | null;
}

interface SplitData {
  payment_id: string;
  amount: number;
  split_index: number;
  status: string;
}


// MARK: - Component Definition
export default function CheckoutPage() {
  const params = useParams();
  const rawSessionId = params.sessionId as string;

  // Validate session ID to prevent injection attacks
  const sessionId = VALID_ID_PATTERN.test(rawSessionId) ? rawSessionId : '';

  const [session, setSession] = useState<CheckoutSession | null>(null);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(sessionId ? null : 'Invalid session ID');
  const [showAutoSignModal, setShowAutoSignModal] = useState(false);
  const [txHash, setTxHash] = useState<string | null>(null);
  const [receiptId, setReceiptId] = useState<string | null>(null);
  const [paymentComplete, setPaymentComplete] = useState(false);
  const [rlusdAmount, setRlusdAmount] = useState<number | null>(null);
  const [liveRate, setLiveRate] = useState<number | null>(null);
  
  // Tip state
  const [tipAmount, setTipAmount] = useState(0);
const [isAndroid, setIsAndroid] = useState(false);
const [nfcSupported, setNfcSupported] = useState(false);
const [showPaymentOptions, setShowPaymentOptions] = useState(false);
  
  // Split bill state
  const [showSplitModal, setShowSplitModal] = useState(false);
  const [splits, setSplits] = useState<SplitData[] | null>(null);
  const [currentSplitIndex, setCurrentSplitIndex] = useState(0);
  // User status detection
const [userStatus, setUserStatus] = useState<'checking' | 'registered' | 'new'>('checking');


// MARK: - Hooks & Effects
useEffect(() => {
  setIsAndroid(/android/i.test(navigator.userAgent));
  setNfcSupported('NDEFReader' in window);
}, []);

// Check user registration status
useEffect(() => {
  const checkUserRegistration = async () => {
    if (!session) return;
    
    try {
      // Check if user has a connected wallet
      const walletAddress = localStorage.getItem('yesallofus_wallet') || 
                           safeGetItem('walletAddress');
      
      if (!walletAddress) {
        setUserStatus('new');
        return;
      }

      // Extract store ID from session
      const storeId = session.session_id.replace('sess_', 'store_');
      
      // Check if registered with the store
      const response = await fetch(`https://api.dltpays.com/api/v1/customer/status?wallet=${walletAddress}&store=${storeId}`);
      const data = await response.json();
      
      setUserStatus(data.isRegistered ? 'registered' : 'new');
    } catch (error) {
      console.error('User status check failed:', error);
      setUserStatus('new'); // Default to signup flow
    }
  };

  if (session) {
    checkUserRegistration();
  }
}, [session]);

  // Fetch session data
  useEffect(() => {
    if (!sessionId) return;


// MARK: - API Calls & Data Fetching
    const fetchSession = async () => {
      try {
        const res = await fetch(`${API_URL}/checkout/session/${sessionId}`);
        const data = await res.json();

        if (!data.success) {
          setError(data.error || 'Session not found');
          return;
        }

        setSession(data.session);

        // Check if already paid
        if (data.session.status === 'paid') {
          setPaymentComplete(true);
          setTxHash(data.session.tx_hash);
          setReceiptId(data.session.receipt_id);
        }

        // Check if expired
        if (data.session.status === 'expired') {
          setError('This checkout session has expired');
        }

        // Fetch RLUSD conversion
        if (data.session.status === 'pending') {
          try {
            const rateRes = await fetch(`https://api.dltpays.com/convert/gbp-to-rlusd?amount=${data.session.amount}`);
            const rateData = await rateRes.json();
            if (rateData.success) {
              setRlusdAmount(rateData.rlusd);
              setLiveRate(rateData.rlusd / data.session.amount);
            }
          } catch (e) {
            // Fallback estimate
            setRlusdAmount(data.session.amount * 1.27);
            setLiveRate(1.27);
          }
        }
      } catch (err) {
        setError('Failed to load checkout');
      } finally {
        setLoading(false);
      }
    };

    fetchSession();
  }, [sessionId]);

  // Update RLUSD when tip changes
  useEffect(() => {
    if (!session) return;
    const totalAmount = session.amount + tipAmount;
    const fetchRate = async () => {
      try {
        const rateRes = await fetch(`https://api.dltpays.com/convert/gbp-to-rlusd?amount=${totalAmount}`);
        const rateData = await rateRes.json();
        if (rateData.success) {
          setRlusdAmount(rateData.rlusd);
          setLiveRate(rateData.rlusd / totalAmount);
        }
      } catch (e) {
        setRlusdAmount(totalAmount * 1.27);
        setLiveRate(1.27);
      }
    };
    fetchRate();
  }, [tipAmount, session]);

  // Get current amount (with tip, or split amount)
  const getCurrentAmount = () => {
    if (splits && splits.length > 0) {
      return splits[currentSplitIndex].amount;
    }
    return (session?.amount || 0) + tipAmount;
  };

  // Get current payment ID
  const getCurrentPaymentId = () => {
    if (splits && splits.length > 0) {
      return splits[currentSplitIndex].payment_id;
    }
    return session?.payment_link_id || sessionId;
  };

  // Handle split bill

// MARK: - Event Handlers
  const handleSplitBill = async (numSplits: number) => {
    if (!session) return;
    
    try {
      const res = await fetch(`${API_URL}/checkout/session/${sessionId}/split`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ num_splits: numSplits })
      });

      const result = await res.json();

      if (result.success) {
        setSplits(result.splits.map((s: any) => ({
          payment_id: s.payment_id,
          amount: s.amount,
          split_index: s.split_index,
          status: 'pending'
        })));
        setShowSplitModal(false);
        setCurrentSplitIndex(0);
      } else {
        setError(result.error || 'Failed to split bill');
      }
    } catch (err) {
      setError('Failed to split bill');
    }
  };

  // Handle successful payment
  const handlePaymentSuccess = async (hash: string, receipt?: string) => {
    setTxHash(hash);
    if (receipt) setReceiptId(receipt);

    // Mark session as paid
    try {
      await fetch(`${API_URL}/checkout/session/${sessionId}/pay`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tx_hash: hash,
          payer_wallet: safeGetItem('walletAddress'),
          payment_method: 'web3auth',
          tip_amount: tipAmount
        })
      });
    } catch (e) {
      console.error('Failed to mark session paid:', e);
    }

    // Handle splits
    if (splits && currentSplitIndex < splits.length - 1) {
      // Move to next split
      const updatedSplits = [...splits];
      updatedSplits[currentSplitIndex].status = 'paid';
      setSplits(updatedSplits);
      setCurrentSplitIndex(prev => prev + 1);
    } else {
      setPaymentComplete(true);
    }

    // Vibration feedback
    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
  };

  // Redirect to signup function
  const redirectToSignup = () => {
    if (!session) return;
    
    const currentCheckoutUrl = window.location.href;
    const storeId = session.session_id.replace('sess_', 'store_');
    const signupUrl = `/customer-signup?store=${storeId}&referrer=checkout&redirect=${encodeURIComponent(currentCheckoutUrl)}`;
    window.location.href = signupUrl;
  };

  // Loading state
  if (loading) {

// MARK: - Main Render
    return (
      <>
        <NebulaBackground opacity={0.3} />
        <div className="min-h-screen bg-transparent text-white flex items-center justify-center">
          <div className="text-center">
            <div className="w-10 h-10 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p className="text-zinc-400">Loading checkout...</p>
          </div>
        </div>
      </>
    );
  }

  // Error state
  if (error) {
    return (
      <>
        <NebulaBackground opacity={0.3} />
        <div className="min-h-screen bg-transparent text-white flex items-center justify-center p-6">
          <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-8 max-w-md w-full text-center">
            <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <h1 className="text-xl font-bold text-red-400 mb-2">Checkout Error</h1>
            <p className="text-zinc-400">{error}</p>
          </div>
        </div>
      </>
    );
  }

  // Payment complete state
  if (paymentComplete && session) {
    return (
      <>
        <NebulaBackground opacity={0.3} />
        <div className="min-h-screen bg-transparent text-white flex items-center justify-center p-6">
          <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-8 max-w-md w-full">
            {/* Store branding */}
            <div className="text-center mb-6">
              {session.store_logo ? (
                <img src={session.store_logo} alt={session.store_name} className="w-16 h-16 rounded-xl mx-auto mb-3 object-cover" />
              ) : (
                <div className="w-16 h-16 bg-gradient-to-br from-emerald-500/20 to-sky-500/20 rounded-xl mx-auto mb-3 flex items-center justify-center">
                  <span className="text-2xl font-bold text-emerald-400">{session.store_name.charAt(0)}</span>
                </div>
              )}
              <p className="text-zinc-400 text-sm">{session.store_name}</p>
            </div>

            {/* Success icon */}
            <div className="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
              <svg className="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>

            <h1 className="text-2xl font-bold text-emerald-400 text-center mb-2">Payment Complete!</h1>
            <p className="text-zinc-400 text-center mb-6">Thank you for your order</p>

            {/* Amount */}
            <div className="bg-zinc-800/50 rounded-xl p-4 mb-6">
              <div className="flex justify-between items-center">
                <span className="text-zinc-400">Amount paid</span>
                <span className="text-2xl font-bold text-white">¬£{(session.amount + tipAmount).toFixed(2)}</span>
              </div>
              {tipAmount > 0 && (
                <div className="flex justify-between items-center mt-2 pt-2 border-t border-zinc-700">
                  <span className="text-zinc-500 text-sm">Includes tip</span>
                  <span className="text-emerald-400 text-sm">¬£{tipAmount.toFixed(2)}</span>
                </div>
              )}
              {session.order_reference && (
                <div className="flex justify-between items-center mt-2 pt-2 border-t border-zinc-700">
                  <span className="text-zinc-500 text-sm">Order</span>
                  <span className="text-zinc-300 text-sm">{session.order_reference}</span>
                </div>
              )}
            </div>

            {/* Transaction link */}
            {txHash && (
              <a 
                href={`https://livenet.xrpl.org/transactions/${txHash}`}
                target="_blank"
                rel="noopener noreferrer"
                className="block text-center text-sky-400 text-sm hover:text-sky-300 transition mb-6"
              >
                View on XRPL ‚Üí
              </a>
            )}

            {/* Receipt Actions */}
            <div className="mb-6">
              <ReceiptActions
                receiptId={receiptId || undefined}
                txHash={txHash || undefined}
                storeName={session.store_name}
                storeId={session.session_id}
                amount={session.amount + tipAmount}
                rlusdAmount={rlusdAmount || undefined}
                items={session.items}
                tipAmount={tipAmount}
                storeLogo={session.store_logo || undefined}
                walletAddress={safeGetItem('walletAddress') || undefined}
              />
            </div>

            {/* Close / Return button */}
            {session.success_url ? (
              <a 
                href={session.success_url}
                className="block w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-4 rounded-xl text-center transition"
              >
                Return to Store
              </a>
            ) : (
              <button
                onClick={() => window.close()}
                className="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-semibold py-4 rounded-xl transition"
              >
                Close
              </button>
            )}

            {/* YAOFUS Pioneers Badge - Footer */}
            <footer className="py-6 flex flex-col items-center gap-1 mt-6 border-t border-zinc-800">
              <span className="text-zinc-500 text-[10px] font-medium tracking-wider">CATALOG</span>
              <span className="text-base font-extrabold tracking-widest">
                <span className="text-emerald-500">Y</span>
                <span className="text-green-500">A</span>
                <span className="text-blue-500">O</span>
                <span className="text-indigo-500">F</span>
                <span className="text-violet-500">U</span>
                <span className="text-purple-500">S</span>
              </span>
              <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">PRODUCTS</span>
              <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
                <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
                <span>Powered by YesAllOfUs</span>
              </div>
            </footer>
          </div>
        </div>
      </>
    );
  }

  const currentAmount = getCurrentAmount();
  const totalSplits = splits?.length || null;
  const currentIndex = splits ? currentSplitIndex + 1 : null;

  // Main checkout view
  return (
    <>
      <NebulaBackground opacity={0.3} />
      
      {/* Desktop Conversion Rate - Fixed top right */}
      <div className="hidden md:block fixed top-4 right-4 w-96 z-10">
        <div className="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <img
                src="https://static.coingecko.com/s/coingecko-logo-8903d34ce19ca4be1c81f0db30e924154750d208683fad7ae6f2ce06c76d0a56.png"
                alt="CoinGecko"
                className="h-5 w-auto object-contain"
              />
              <span className="text-xs text-zinc-500">Live rate from CoinGecko Pro</span>
            </div>
            <div className="flex items-center gap-1.5">
              <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
              <span className="text-xs text-emerald-500 font-medium">LIVE</span>
            </div>
          </div>
          
          <div className="flex items-baseline justify-between">
            <span className="text-zinc-400 text-sm">Settlement amount</span>
            <div className="text-right">
              <span className="text-2xl font-bold text-white font-mono">
                {rlusdAmount ? rlusdAmount.toFixed(4) : '...'} <span className="text-emerald-400 text-lg">RLUSD</span>
              </span>
              {liveRate && (
                <p className="text-xs text-zinc-500 mt-1">
                  ¬£1 = {liveRate.toFixed(4)} RLUSD
                </p>
              )}
            </div>
          </div>
          
          <div className="mt-3 pt-3 border-t border-zinc-800 flex items-start gap-2">
            <svg className="w-4 h-4 text-amber-400/80 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 16v-4M12 8h.01" />
            </svg>
            <p className="text-[11px] text-zinc-500 leading-relaxed">
              <span className="text-zinc-400 font-medium">Live price.</span> Updated every 10s via CoinGecko Pro (600+ exchanges). Settlement variance &lt;0.1%.
            </p>
          </div>
        </div>
      </div>

      <div className="min-h-screen bg-transparent text-white flex items-center justify-center p-4">
        <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl w-full max-w-md overflow-hidden">
          
          {/* Header with store branding */}
          <div className="bg-gradient-to-br from-zinc-800/50 to-zinc-900/50 p-6 border-b border-zinc-800">
            <div className="flex items-center gap-4">
              {session?.store_logo ? (
                <img src={session.store_logo} alt={session.store_name} className="w-14 h-14 rounded-xl object-cover" />
              ) : (
                <div className="w-14 h-14 bg-gradient-to-br from-emerald-500/20 to-sky-500/20 rounded-xl flex items-center justify-center">
                  <span className="text-xl font-bold text-emerald-400">{session?.store_name.charAt(0)}</span>
                </div>
              )}
              <div>
                <h1 className="text-lg font-bold text-white">{session?.store_name}</h1>
                <p className="text-zinc-400 text-sm">
                  {totalSplits ? `Payment ${currentIndex} of ${totalSplits}` : 'Secure checkout with XRPL'}
                </p>
              </div>
            </div>
          </div>

          {/* Order summary */}
          <div className="p-6 border-b border-zinc-800">
            <h2 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">Order Summary</h2>

            {session?.order_reference && (
              <div className="flex justify-between items-center mb-4 pb-3 border-b border-zinc-800">
                <span className="text-zinc-500 text-sm">Order Reference</span>
                <span className="text-zinc-300 text-sm font-mono">{session.order_reference}</span>
              </div>
            )}

            {session?.items && session.items.length > 0 ? (
              <div className="space-y-3 mb-4">
                {session.items.map((item, idx) => (
                  <div key={idx} className="flex justify-between items-center">
                    <div>
                      <p className="text-white">{item.name}</p>
                      {item.quantity > 1 && (
                        <p className="text-zinc-500 text-sm">Qty: {item.quantity}</p>
                      )}
                    </div>
                    <p className="text-zinc-300">¬£{(item.unit_price * item.quantity).toFixed(2)}</p>
                  </div>
                ))}
              </div>
            ) : (
              <div className="mb-4">
                <p className="text-zinc-400">Payment to {session?.store_name}</p>
              </div>
            )}

            {/* User Status Check */}
            {userStatus === 'checking' && (
              <div className="bg-zinc-800 border border-zinc-700 rounded-xl p-6 text-center mb-6">
                <div className="w-6 h-6 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p className="text-zinc-400">Checking your account status...</p>
              </div>
            )}

            {/* New User Signup Prompt */}
            {userStatus === 'new' && !showPaymentOptions && (
              <div className="bg-gradient-to-br from-emerald-900/20 to-blue-900/20 border border-emerald-500/30 rounded-xl p-3 text-center mb-3">
                <div className="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-2">
                  <img 
                    src="https://yesallofus.com/dltpayslogo1.png" 
                    alt="YesAllOfUs" 
                    className="w-12 h-12 rounded-xl object-cover"
                  />
                </div>
                
                <h3 className="text-lg font-bold text-white mb-1">Welcome to YesAllOfUs!</h3>
                <p className="text-emerald-300 text-sm mb-2">Join to pay with RLUSD or USDC and join {session?.store_name}&apos;s affiliate program</p>
                
                <div className="flex gap-3">
                  <button
                    onClick={redirectToSignup}
                    className="flex-1 bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 text-white font-semibold py-3 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl"
                  >
                    Sign Up Here
                  </button>
                  {isAndroid && nfcSupported && session && rlusdAmount && (
                    <NFCTapPay
                      amount={currentAmount}
                      storeId={session.session_id}
                      paymentId={getCurrentPaymentId()}
                      onSuccess={handlePaymentSuccess}
                      onError={(err) => err === 'NO_SIGNER_AUTHORITY' ? setShowAutoSignModal(true) : setError(err)}
                      onNotRegistered={redirectToSignup}
                      isCheckoutSession={true}
                      tipAmount={tipAmount}
                    />
                  )}
                </div>
                
                <p className="text-zinc-500 text-xs mt-2">Free to join ‚Ä¢ Pay instantly, no waiting</p>
                
                <button
                  onClick={() => setShowPaymentOptions(true)}
                  className="text-emerald-400 hover:text-emerald-300 text-sm mt-3 underline"
                >
                  Already have an account? Sign in
                </button>
              </div>
            )}

            {/* Tip display if added */}
            {tipAmount > 0 && (
              <div className="flex justify-between items-center py-2 text-emerald-400">
                <span>Tip</span>
                <span>¬£{tipAmount.toFixed(2)}</span>
              </div>
            )}

            {/* Total */}
            <div className="flex justify-between items-center pt-4 border-t border-zinc-800">
              <span className="text-zinc-400 font-medium">Total</span>
              <div className="text-right">
                <p className="text-3xl font-bold text-emerald-400">¬£{currentAmount.toFixed(2)}</p>
                {rlusdAmount && (
                  <p className="text-zinc-500 text-sm">‚âà {rlusdAmount.toFixed(2)} RLUSD</p>
                )}
              </div>
            </div>

            {/* Cancel/Back button */}
            {session?.cancel_url && (
              <a 
                href={session.cancel_url}
                className="block text-center text-zinc-500 hover:text-zinc-300 text-sm mt-4 transition"
              >
                ‚Üê Return to store
              </a>
            )}
          </div>

          {/* Terms and Privacy - between sections */}
          <div className="px-6 py-4 border-t border-zinc-800">
            <p className="text-center text-xs text-zinc-500">
              By completing this payment, you agree to our{' '}
              <a href="/pos-terms" className="text-zinc-400 underline hover:text-white">Terms</a>
              {' '}and{' '}
              <a href="/pos-privacy" className="text-zinc-400 underline hover:text-white">Privacy Policy</a>
            </p>
          </div>

          {/* Payment options */}
          <div className="p-6 border-t border-zinc-800">
            {/* Payment Methods - Only show for registered users */}
            {(userStatus === 'registered' || showPaymentOptions) && (
              <>
                {/* Tip Selector - only show if not split */}
                {!splits && session?.status === 'pending' && (
                  <TipSelector
                    amount={session.amount}
                    onTipChange={setTipAmount}
                  />
                )}

                {showPaymentOptions && userStatus === 'new' && (
                  <button
                    onClick={() => setShowPaymentOptions(false)}
                    className="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 text-sm mb-4 transition"
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back
                  </button>
                )}
                <h2 className="text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-4">Pay with</h2>

                {session && rlusdAmount && (
                  <PaymentOptions
                    amount={currentAmount}
                    rlusdAmount={rlusdAmount}
                    vendorWallet={session.vendor_wallet}
                    storeName={session.store_name}
                    storeId={session.session_id}
                    paymentId={getCurrentPaymentId()}
                    status={session.status as 'pending' | 'paid' | 'expired' | 'processing'}
                    onSuccess={handlePaymentSuccess}
                    onError={(err) => err === 'NO_SIGNER_AUTHORITY' ? setShowAutoSignModal(true) : setError(err)}
                    showSplitBill={!splits && session.status === 'pending'}
                    onSplitBill={() => setShowSplitModal(true)}
                    isCheckoutSession={true}
                    tipAmount={tipAmount}
                  />
                )}
              </>
            )}

            {/* Live Conversion Rate - Mobile only */}
            <div className="md:hidden bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4 mt-6">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2">
                  <img
                    src="https://static.coingecko.com/s/coingecko-logo-8903d34ce19ca4be1c81f0db30e924154750d208683fad7ae6f2ce06c76d0a56.png"
                    alt="CoinGecko"
                    className="h-5 w-auto object-contain"
                  />
                  <span className="text-xs text-zinc-500">Live rate from CoinGecko Pro</span>
                </div>
                <div className="flex items-center gap-1.5">
                  <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
                  <span className="text-xs text-emerald-500 font-medium">LIVE</span>
                </div>
              </div>
              
              <div className="flex items-baseline justify-between">
                <span className="text-zinc-400 text-sm">Settlement amount</span>
                <div className="text-right">
                  <span className="text-2xl font-bold text-white font-mono">
                    {rlusdAmount ? rlusdAmount.toFixed(4) : '...'} <span className="text-emerald-400 text-lg">RLUSD</span>
                  </span>
                  {liveRate && (
                    <p className="text-xs text-zinc-500 mt-1">
                      ¬£1 = {liveRate.toFixed(4)} RLUSD
                    </p>
                  )}
                </div>
              </div>
              
              <div className="mt-3 pt-3 border-t border-zinc-800 flex items-start gap-2">
                <svg className="w-4 h-4 text-amber-400/80 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M12 16v-4M12 8h.01" />
                </svg>
                <p className="text-[11px] text-zinc-500 leading-relaxed">
                  <span className="text-zinc-400 font-medium">Live price.</span> Updated every 10s via CoinGecko Pro (600+ exchanges). Settlement variance &lt;0.1%.
                </p>
              </div>
            </div>

            {/* Security badges */}
            <div className="flex justify-center gap-4 mt-4">
              <div className="flex items-center gap-2 text-zinc-500 text-xs">
                <svg className="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <span>Secure</span>
              </div>
              <div className="flex items-center gap-2 text-zinc-500 text-xs">
                <svg className="w-4 h-4 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>Instant</span>
              </div>
              <div className="flex items-center gap-2 text-zinc-500 text-xs">
                <svg className="w-4 h-4 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span>Encrypted</span>
              </div>
            </div>
          </div>

          {/* YAOFUS Pioneers Badge - Footer */}
          <footer className="py-6 flex flex-col items-center gap-1 border-t border-zinc-800">
            <span className="text-zinc-500 text-[10px] font-medium tracking-wider">CATALOG</span>
            <span className="text-base font-extrabold tracking-widest">
              <span className="text-emerald-500">Y</span>
              <span className="text-green-500">A</span>
              <span className="text-blue-500">O</span>
              <span className="text-indigo-500">F</span>
              <span className="text-violet-500">U</span>
              <span className="text-purple-500">S</span>
            </span>
            <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">PRODUCTS</span>
            <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
              <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
              <span>Powered by YesAllOfUs</span>
            </div>
          </footer>
        </div>
      </div>

      {/* Auto Sign Modal */}
      <AutoSignModal
        isOpen={showAutoSignModal}
        onClose={() => setShowAutoSignModal(false)}
        onSuccess={() => {
          setShowAutoSignModal(false);
          setError(null);
        }}
      />

      {/* Split Bill Modal */}
      {session && (
        <SplitBillModal
          amount={session.amount + tipAmount}
          isOpen={showSplitModal}
          onClose={() => setShowSplitModal(false)}
          onSplit={handleSplitBill}
        />
      )}
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/cover/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useRouter } from 'next/navigation';
import { useState } from 'react';


// MARK: - Component Definition
export default function CoverPage() {
  const router = useRouter();

// MARK: - State Management
  const [showRightArrow, setShowRightArrow] = useState(false);


// MARK: - Main Render
  return (
    <div className="min-h-screen h-screen relative overflow-hidden">
      
      {/* Gradient border frame */}
      <div className="absolute inset-0 z-20 pointer-events-none">
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 left-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 right-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
      </div>

      {/* Navigation - Right Arrow */}
      <div 
        className="absolute right-0 top-0 bottom-0 w-10 lg:w-20 z-30 flex items-center justify-center cursor-pointer"

// MARK: - Event Handlers
        onMouseEnter={() => setShowRightArrow(true)}
        onMouseLeave={() => setShowRightArrow(false)}
        onClick={() => router.push('/problem-opportunity')}
      >
        <svg 
          className={`w-6 h-6 lg:w-10 lg:h-10 text-white transition-opacity duration-300 opacity-50 lg:opacity-0 ${showRightArrow ? 'lg:opacity-70 lg:hover:opacity-100' : ''}`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </div>
      
      {/* Background - yaofus-landing screenshot */}
      <div 
        className="absolute inset-0 w-full h-full bg-cover bg-center bg-no-repeat"
        style={{ backgroundImage: "url('/yaofus-landing.png')" }}
      />

      {/* Title - ALL SCREENS */}
      <div className="absolute top-4 lg:top-12 left-0 right-0 text-center z-10 px-4">
        <h1 className="text-white text-lg md:text-2xl lg:text-4xl xl:text-5xl font-bold tracking-tight" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>
          A New POS{' '}
          <span className="bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400 bg-clip-text text-transparent">Ready</span>
          {' '}to Disrupt
          <span className="hidden lg:inline"> the High Street</span>
        </h1>
      </div>

      {/* ===== DESKTOP ONLY - Cards on sides ===== */}
      
      {/* Left cards - desktop only */}
      <div className="hidden lg:flex absolute left-[calc(2rem+50px)] xl:left-[calc(3rem+50px)] top-[calc(38%-15px)] flex-col gap-4 z-10">
        
        <div className="bg-zinc-800/50 backdrop-blur-sm rounded-2xl p-5 w-[220px] h-[150px] text-center flex flex-col justify-center">
          <p className="text-zinc-400 text-sm mb-2">Guernsey Retail Market</p>
          <p className="text-white text-3xl font-bold mb-1">¬£348m</p>
          <p className="text-emerald-400 text-base font-medium">We Start Here</p>
          <p className="text-zinc-500 text-[10px] mt-2">States of Guernsey 2023</p>
        </div>

        <div className="bg-zinc-800/50 backdrop-blur-sm rounded-2xl p-5 w-[220px] h-[150px] text-center flex flex-col justify-center">
          <p className="text-zinc-400 text-sm mb-2">Card Fees Lost Annually</p>
          <p className="text-white text-3xl font-bold mb-1">¬£10m+</p>
          <p className="text-emerald-400 text-base font-medium">We Keep It Local</p>
          <p className="text-zinc-500 text-[10px] mt-2">Stays on the island</p>
        </div>

      </div>

      {/* Right cards - desktop only */}
      <div className="hidden lg:flex absolute right-[calc(2rem+50px)] xl:right-[calc(3rem+50px)] top-[calc(38%-15px)] flex-col gap-4 z-10">
        
        <div className="bg-zinc-800/50 backdrop-blur-sm rounded-2xl p-5 w-[220px] h-[150px] text-center flex flex-col justify-center">
          <p className="text-zinc-400 text-sm mb-2">Global E-Commerce 2026</p>
          <p className="text-white text-3xl font-bold mb-1">$6.9tn</p>
          <p className="text-emerald-400 text-base font-medium">Ready to Scale</p>
          <p className="text-zinc-500 text-[10px] mt-2">Shopify Global Report 2026</p>
        </div>

        <div className="bg-zinc-800/50 backdrop-blur-sm rounded-2xl p-5 w-[220px] h-[150px] text-center flex flex-col justify-center">
          <p className="text-zinc-400 text-sm mb-2">Projected by 2030</p>
          <p className="text-white text-3xl font-bold mb-1">$80tn+</p>
          <p className="text-emerald-400 text-base font-medium">Exponential Growth</p>
          <p className="text-zinc-500 text-[10px] mt-2">Industry Forecasts</p>
        </div>

      </div>

      {/* Guernsey flag video - desktop only */}
      <div className="hidden lg:block absolute bottom-6 left-8 z-10">
        <video 
          autoPlay 
          loop 
          muted 
          playsInline
          className="w-24 h-auto rounded-lg opacity-80"
        >
          <source src="/guernsey-flag.webm" type="video/webm" />
        </video>
      </div>

      {/* Subheader - desktop only */}
      <div className="hidden lg:block absolute bottom-14 lg:bottom-16 xl:bottom-18 left-0 right-0 text-center z-10 px-4">
        <p className="text-zinc-300 text-xl lg:text-2xl xl:text-3xl" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>
          0.5% Fees and Affiliate Commission Growth Engine for{' '}
          <span className="bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400 bg-clip-text text-transparent font-bold">Everyone</span>
        </p>
      </div>

    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/earn/analytics/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, JSX } from 'react';
import { safeGetItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';
import DashboardHeader from '@/components/DashboardHeader';

// Stable Asset Exchange Logo SVG

// MARK: - Component Definition
const StableAssetLogo = ({ className = "w-10 h-10" }: { className?: string }) => (
  <svg className={className} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="48" height="48" rx="12" fill="url(#sae-gradient-analytics)" />
    <path 
      d="M14 24C14 18.477 18.477 14 24 14V14C29.523 14 34 18.477 34 24V24C34 29.523 29.523 34 24 34V34C18.477 34 14 29.523 14 24V24Z" 
      stroke="white" 
      strokeWidth="2"
    />
    <path 
      d="M24 18V30M18 24H30" 
      stroke="white" 
      strokeWidth="2" 
      strokeLinecap="round"
    />
    <circle cx="24" cy="24" r="3" fill="white" />
    <defs>
      <linearGradient id="sae-gradient-analytics" x1="0" y1="0" x2="48" y2="48" gradientUnits="userSpaceOnUse">
        <stop stopColor="#6366f1" />
        <stop offset="1" stopColor="#8b5cf6" />
      </linearGradient>
    </defs>
  </svg>
);

// Mock holdings data
const mockHoldings = [
  { product: 'Flexible Savings', amount: 523.76, apy: 4.5, earnings: 23.76, color: 'emerald' },
  { product: '90-Day Fixed', amount: 502.47, apy: 6.0, earnings: 2.47, color: 'indigo' },
  { product: 'XRP Staking', amount: 200.00, apy: 3.2, earnings: 0.53, color: 'amber' },
];

// Mock transactions data
const mockTransactions = [
  { id: '1', type: 'deposit', product: 'Flexible Savings', amount: 500, date: '2025-01-04T10:30:00Z', status: 'completed' },
  { id: '2', type: 'interest', product: 'Flexible Savings', amount: 1.87, date: '2025-01-05T00:00:00Z', status: 'completed' },
  { id: '3', type: 'deposit', product: '90-Day Fixed', amount: 500, date: '2025-01-06T14:15:00Z', status: 'completed' },
  { id: '4', type: 'interest', product: 'Flexible Savings', amount: 1.89, date: '2025-01-06T00:00:00Z', status: 'completed' },
  { id: '5', type: 'interest', product: '90-Day Fixed', amount: 2.47, date: '2025-01-06T00:00:00Z', status: 'pending' },
];

export default function EarnAnalyticsPage() {
  const router = useRouter();
  const [period, setPeriod] = useState<'week' | 'month' | 'quarter' | 'year'>('quarter');

  // Calculate totals
  const totalDeposited = mockHoldings.reduce((sum, h) => sum + h.amount, 0);
  const totalEarnings = mockHoldings.reduce((sum, h) => sum + h.earnings, 0);
  const portfolioValue = totalDeposited;
  const avgAPY = mockHoldings.reduce((sum, h) => sum + (h.apy * h.amount), 0) / totalDeposited;

  const holdingColors: Record<string, string> = {
    emerald: 'bg-emerald-500',
    indigo: 'bg-indigo-500',
    amber: 'bg-amber-500',
    purple: 'bg-purple-500',
    sky: 'bg-sky-500',
  };

  const holdingTextColors: Record<string, string> = {
    emerald: 'text-emerald-400',
    indigo: 'text-indigo-400',
    amber: 'text-amber-400',
    purple: 'text-purple-400',
    sky: 'text-sky-400',
  };


// MARK: - Main Render
  return (
    <>
      <DashboardHeader />
      <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">
        
        {/* Header */}
        <header className="sticky top-0 z-40 bg-[#0a0a0a]/95 backdrop-blur border-b border-zinc-800">
          <div className="max-w-5xl lg:max-w-none mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
            <div className="flex items-center gap-1">
              <button

// MARK: - Event Handlers
                onClick={() => router.push('/earn')}
                className="text-zinc-400 hover:text-white transition flex items-center gap-1"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
                <span className="hidden sm:inline">Products</span>
              </button>
              <button
                onClick={() => {
                  // Try to go back to dashboard - check sessionStorage for login type
                  const vendorWallet = safeGetItem('vendorWalletAddress');
                  if (vendorWallet) {
                    router.push('/dashboard');
                  } else {
                    router.push('/affiliate-dashboard');
                  }
                }}
                className="text-zinc-400 hover:text-white transition p-2"
                title="Dashboard"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
              </button>
            </div>
            
            <div className="flex items-center gap-3">
              <StableAssetLogo className="w-8 h-8" />
              <h1 className="text-lg font-bold">Performance</h1>
            </div>
            
            <button
              onClick={() => router.push('/earn')}
              className="text-indigo-400 hover:text-indigo-300 text-sm font-medium"
            >
              View Products
            </button>
          </div>
        </header>

        <main className="max-w-5xl lg:max-w-none mx-auto px-4 lg:px-6 pb-12">
          
          {/* Disclaimer Banner */}
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-2xl p-4 mt-6 mb-6 flex items-center justify-between flex-wrap gap-3">
            <div className="flex items-center gap-3">
              <svg className="w-5 h-5 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div>
                <p className="text-amber-400 text-sm font-medium">For Presentation Purposes Only</p>
                <p className="text-zinc-400 text-xs">
                  This is not a live product. All data shown is simulated for demonstration.
                </p>
              </div>
            </div>
          </div>

          {/* Period Selector */}
          <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
            {(['week', 'month', 'quarter', 'year'] as const).map((p) => (
              <button
                key={p}
                onClick={() => setPeriod(p)}
                className={`px-5 py-2.5 rounded-full text-sm font-medium whitespace-nowrap transition ${
                  period === p
                    ? 'bg-indigo-500 text-white'
                    : 'bg-zinc-800 text-zinc-400 hover:text-white'
                }`}
              >
                {p === 'week' ? '1 Week' : p === 'month' ? '1 Month' : p === 'quarter' ? '3 Months' : '1 Year'}
              </button>
            ))}
          </div>

          {/* Main Stats */}
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <p className="text-zinc-500 text-sm mb-1">Portfolio Value</p>
              <p className="text-3xl font-bold text-white">${portfolioValue.toFixed(2)}</p>
              <p className="text-emerald-400 text-sm mt-1">+${totalEarnings.toFixed(2)} earned</p>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <p className="text-zinc-500 text-sm mb-1">Total Earnings</p>
              <p className="text-3xl font-bold text-emerald-400">${totalEarnings.toFixed(2)}</p>
              <p className="text-zinc-500 text-sm mt-1">All time</p>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <p className="text-zinc-500 text-sm mb-1">Avg. APY</p>
              <p className="text-3xl font-bold text-indigo-400">{avgAPY.toFixed(1)}%</p>
              <p className="text-zinc-500 text-sm mt-1">Weighted average</p>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <p className="text-zinc-500 text-sm mb-1">Active Products</p>
              <p className="text-3xl font-bold text-white">{mockHoldings.length}</p>
              <p className="text-zinc-500 text-sm mt-1">Diversified</p>
            </div>
          </div>

          {/* Charts Row */}
          <div className="grid lg:grid-cols-2 gap-6 mb-8">
            
            {/* Portfolio Growth Chart */}
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <h3 className="font-semibold mb-4">Portfolio Growth</h3>
              <div className="h-48 flex items-end gap-2">
                {[
                  { month: 'Jan', value: 35 },
                  { month: 'Feb', value: 42 },
                  { month: 'Mar', value: 48 },
                  { month: 'Apr', value: 55 },
                  { month: 'May', value: 52 },
                  { month: 'Jun', value: 61 },
                  { month: 'Jul', value: 68 },
                  { month: 'Aug', value: 72 },
                  { month: 'Sep', value: 78 },
                  { month: 'Oct', value: 85 },
                  { month: 'Nov', value: 88 },
                  { month: 'Dec', value: 95 },
                ].map((item, i) => (
                  <div key={i} className="flex-1 flex flex-col items-center gap-2">
                    <div className="w-full bg-zinc-800 rounded-t-lg relative" style={{ height: '140px' }}>
                      <div 
                        className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-indigo-600 to-indigo-400 rounded-t-lg transition-all duration-500"
                        style={{ height: `${item.value}%` }}
                      />
                    </div>
                    <span className="text-zinc-500 text-[10px]">{item.month}</span>
                  </div>
                ))}
              </div>
              <div className="flex justify-between mt-4 text-sm">
                <span className="text-zinc-500">Total growth</span>
                <span className="font-semibold text-emerald-400">+25.6%</span>
              </div>
            </div>

            {/* APY History Chart */}
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <h3 className="font-semibold mb-4">APY History</h3>
              <div className="h-48 flex items-end gap-3">
                {[
                  { month: 'Jul', flexible: 60, fixed30: 70, fixed90: 80 },
                  { month: 'Aug', flexible: 62, fixed30: 72, fixed90: 82 },
                  { month: 'Sep', flexible: 63, fixed30: 73, fixed90: 83 },
                  { month: 'Oct', flexible: 64, fixed30: 74, fixed90: 84 },
                  { month: 'Nov', flexible: 65, fixed30: 75, fixed90: 86 },
                  { month: 'Dec', flexible: 65, fixed30: 76, fixed90: 87 },
                ].map((item, i) => (
                  <div key={i} className="flex-1 flex flex-col gap-1">
                    <div className="flex-1 flex items-end gap-0.5" style={{ height: '140px' }}>
                      <div className="flex-1 bg-zinc-800 rounded-t relative h-full">
                        <div 
                          className="absolute bottom-0 left-0 right-0 bg-emerald-500 rounded-t"
                          style={{ height: `${item.flexible}%` }}
                        />
                      </div>
                      <div className="flex-1 bg-zinc-800 rounded-t relative h-full">
                        <div 
                          className="absolute bottom-0 left-0 right-0 bg-sky-500 rounded-t"
                          style={{ height: `${item.fixed30}%` }}
                        />
                      </div>
                      <div className="flex-1 bg-zinc-800 rounded-t relative h-full">
                        <div 
                          className="absolute bottom-0 left-0 right-0 bg-indigo-500 rounded-t"
                          style={{ height: `${item.fixed90}%` }}
                        />
                      </div>
                    </div>
                    <span className="text-zinc-500 text-xs text-center">{item.month}</span>
                  </div>
                ))}
              </div>
              <div className="flex gap-4 mt-4 text-xs">
                <span className="flex items-center gap-1.5">
                  <span className="w-2 h-2 bg-emerald-500 rounded-full"></span>
                  <span className="text-zinc-500">Flexible 4.5%</span>
                </span>
                <span className="flex items-center gap-1.5">
                  <span className="w-2 h-2 bg-sky-500 rounded-full"></span>
                  <span className="text-zinc-500">30-Day 5.2%</span>
                </span>
                <span className="flex items-center gap-1.5">
                  <span className="w-2 h-2 bg-indigo-500 rounded-full"></span>
                  <span className="text-zinc-500">90-Day 6.0%</span>
                </span>
              </div>
            </div>
          </div>

          {/* Holdings & Transactions */}
          <div className="grid lg:grid-cols-2 gap-6 mb-8">
            
            {/* Holdings Breakdown */}
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <h3 className="font-semibold mb-4">Your Holdings</h3>
              
              {/* Pie chart visual */}
              <div className="flex items-center gap-6 mb-6">
                <div className="relative w-28 h-28">
                  <svg className="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                    {mockHoldings.reduce((acc, holding, i) => {
                      const percentage = (holding.amount / totalDeposited) * 100;
                      const strokeDasharray = `${percentage * 2.51} ${251 - percentage * 2.51}`;
                      const strokeDashoffset = -acc.offset;
                      acc.elements.push(
                        <circle
                          key={i}
                          cx="50"
                          cy="50"
                          r="40"
                          fill="none"
                          stroke={holding.color === 'emerald' ? '#10b981' : holding.color === 'indigo' ? '#6366f1' : '#f59e0b'}
                          strokeWidth="20"
                          strokeDasharray={strokeDasharray}
                          strokeDashoffset={strokeDashoffset}
                        />
                      );
                      acc.offset += percentage * 2.51;
                      return acc;
                    }, { elements: [] as JSX.Element[], offset: 0 }).elements}
                  </svg>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <div className="text-center">
                      <p className="text-lg font-bold">${totalDeposited.toFixed(0)}</p>
                      <p className="text-zinc-500 text-xs">Total</p>
                    </div>
                  </div>
                </div>
                
                <div className="flex-1 space-y-3">
                  {mockHoldings.map((holding, i) => (
                    <div key={i} className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className={`w-3 h-3 rounded-full ${holdingColors[holding.color]}`}></span>
                        <span className="text-sm">{holding.product}</span>
                      </div>
                      <span className="text-sm font-medium">{((holding.amount / totalDeposited) * 100).toFixed(0)}%</span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Holdings list */}
              <div className="space-y-3 border-t border-zinc-800 pt-4">
                {mockHoldings.map((holding, i) => (
                  <div key={i} className="flex items-center justify-between p-3 bg-zinc-800/50 rounded-lg">
                    <div>
                      <p className="font-medium">{holding.product}</p>
                      <p className="text-zinc-500 text-sm">{holding.apy}% APY</p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold">${holding.amount.toFixed(2)}</p>
                      <p className={`text-sm ${holdingTextColors[holding.color]}`}>+${holding.earnings.toFixed(2)}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Recent Transactions */}
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5">
              <h3 className="font-semibold mb-4">Recent Transactions</h3>
              <div className="space-y-3">
                {mockTransactions.map((tx) => (
                  <div key={tx.id} className="flex items-center justify-between py-3 border-b border-zinc-800 last:border-0">
                    <div className="flex items-center gap-3">
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                        tx.type === 'deposit' ? 'bg-sky-500/20' : 'bg-emerald-500/20'
                      }`}>
                        {tx.type === 'deposit' ? (
                          <svg className="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                          </svg>
                        ) : (
                          <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        )}
                      </div>
                      <div>
                        <p className="font-medium capitalize">{tx.type}</p>
                        <p className="text-zinc-500 text-sm">{tx.product}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className={`font-semibold ${tx.type === 'interest' ? 'text-emerald-400' : 'text-white'}`}>
                        {tx.type === 'interest' ? '+' : ''}${tx.amount.toFixed(2)}
                      </p>
                      <p className="text-zinc-500 text-xs">
                        {new Date(tx.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
              
              <button className="w-full mt-4 text-indigo-400 hover:text-indigo-300 text-sm font-medium py-2">
                View All Transactions
              </button>
            </div>
          </div>

          {/* Projected Earnings */}
          <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
            <h3 className="text-xl font-bold mb-6">Projected Earnings</h3>
            <div className="grid md:grid-cols-4 gap-4">
              {[
                { period: '1 Month', amount: (totalDeposited * (avgAPY / 100) / 12).toFixed(2) },
                { period: '3 Months', amount: (totalDeposited * (avgAPY / 100) / 4).toFixed(2) },
                { period: '6 Months', amount: (totalDeposited * (avgAPY / 100) / 2).toFixed(2) },
                { period: '1 Year', amount: (totalDeposited * (avgAPY / 100)).toFixed(2) },
              ].map((projection, i) => (
                <div key={i} className="bg-zinc-800/50 rounded-xl p-4 text-center">
                  <p className="text-zinc-500 text-sm mb-1">{projection.period}</p>
                  <p className="text-2xl font-bold text-emerald-400">+${projection.amount}</p>
                  <p className="text-zinc-600 text-xs mt-1">at current rates</p>
                </div>
              ))}
            </div>
            <p className="text-zinc-600 text-xs text-center mt-4">
              * Projections are estimates based on current APY rates and do not guarantee future returns
            </p>
          </div>

          {/* Disclaimer */}
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-2xl p-4 text-center mt-8">
            <p className="text-amber-400 text-sm font-medium mb-1">For Presentation Purposes Only</p>
            <p className="text-zinc-400 text-xs">This is not a live product. All rates, figures, and portfolio data shown are for demonstration purposes only.</p>
          </div>
        </main>
      </div>
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/earn/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';
import { safeGetItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';
import DashboardHeader from '@/components/DashboardHeader';

// Stable Asset Exchange Logo SVG

// MARK: - Component Definition
const StableAssetLogo = ({ className = "w-10 h-10" }: { className?: string }) => (
  <svg className={className} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="48" height="48" rx="12" fill="url(#sae-gradient-page)" />
    <path 
      d="M14 24C14 18.477 18.477 14 24 14V14C29.523 14 34 18.477 34 24V24C34 29.523 29.523 34 24 34V34C18.477 34 14 29.523 14 24V24Z" 
      stroke="white" 
      strokeWidth="2"
    />
    <path 
      d="M24 18V30M18 24H30" 
      stroke="white" 
      strokeWidth="2" 
      strokeLinecap="round"
    />
    <circle cx="24" cy="24" r="3" fill="white" />
    <defs>
      <linearGradient id="sae-gradient-page" x1="0" y1="0" x2="48" y2="48" gradientUnits="userSpaceOnUse">
        <stop stopColor="#6366f1" />
        <stop offset="1" stopColor="#8b5cf6" />
      </linearGradient>
    </defs>
  </svg>
);


// MARK: - Types & Interfaces
interface Product {
  id: string;
  name: string;
  description: string;
  apy: string;
  apyValue: number;
  risk: 'Low' | 'Medium' | 'High';
  lockPeriod: string;
  minDeposit: string;
  icon: string;
  color: string;
  features: string[];
}

// SVG Icons for products
const ProductIcons = {
  flexibleSavings: (
    <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  ),
  fixed30: (
    <svg className="w-8 h-8 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
  ),
  fixed90: (
    <svg className="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
    </svg>
  ),
  fixed180: (
    <svg className="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
    </svg>
  ),
  liquidityPool: (
    <svg className="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 10V3L4 14h7v7l9-11h-7z" />
    </svg>
  ),
  staking: (
    <svg className="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
    </svg>
  ),
};

const products: Product[] = [
  {
    id: 'flexible-savings',
    name: 'Flexible Savings',
    description: 'Earn daily interest with no lock-up. Withdraw anytime.',
    apy: '4.5%',
    apyValue: 4.5,
    risk: 'Low',
    lockPeriod: 'None',
    minDeposit: '$10',
    icon: 'flexibleSavings',
    color: 'emerald',
    features: ['Daily interest accrual', 'Instant withdrawals', 'No minimum lock', 'Compound earnings']
  },
  {
    id: 'fixed-30',
    name: '30-Day Fixed',
    description: 'Lock your funds for 30 days for higher returns.',
    apy: '5.2%',
    apyValue: 5.2,
    risk: 'Low',
    lockPeriod: '30 Days',
    minDeposit: '$50',
    icon: 'fixed30',
    color: 'sky',
    features: ['Guaranteed rate', 'Auto-renewal option', 'Early exit penalty: 1%', 'Interest paid at maturity']
  },
  {
    id: 'fixed-90',
    name: '90-Day Fixed',
    description: 'Our most popular product. Great balance of yield and flexibility.',
    apy: '6.0%',
    apyValue: 6.0,
    risk: 'Low',
    lockPeriod: '90 Days',
    minDeposit: '$100',
    icon: 'fixed90',
    color: 'indigo',
    features: ['Best fixed rate', 'Monthly interest payouts', 'Early exit penalty: 2%', 'Priority support']
  },
  {
    id: 'fixed-180',
    name: '180-Day Fixed',
    description: 'Maximum returns for patient investors.',
    apy: '7.0%',
    apyValue: 7.0,
    risk: 'Low',
    lockPeriod: '180 Days',
    minDeposit: '$250',
    icon: 'fixed180',
    color: 'purple',
    features: ['Highest fixed APY', 'Monthly compounding', 'Early exit penalty: 3%', 'VIP support']
  },
  {
    id: 'liquidity-pool',
    name: 'Liquidity Pools',
    description: 'Provide liquidity and earn trading fees plus rewards.',
    apy: '8-12%',
    apyValue: 10,
    risk: 'Medium',
    lockPeriod: 'Flexible',
    minDeposit: '$100',
    icon: 'liquidityPool',
    color: 'cyan',
    features: ['Variable APY', 'Trading fee share', 'Impermanent loss risk', 'Bonus rewards']
  },
  {
    id: 'staking',
    name: 'XRP Staking',
    description: 'Stake XRP and earn rewards while supporting the network.',
    apy: '3.2%',
    apyValue: 3.2,
    risk: 'Low',
    lockPeriod: '7 Days',
    minDeposit: '100 XRP',
    icon: 'staking',
    color: 'amber',
    features: ['Network rewards', '7-day unbonding', 'Auto-compound option', 'No slashing risk']
  }
];

const riskColors = {
  Low: 'text-emerald-400 bg-emerald-500/20',
  Medium: 'text-amber-400 bg-amber-500/20',
  High: 'text-red-400 bg-red-500/20'
};

const productColors: Record<string, { bg: string; border: string; text: string }> = {
  emerald: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/30', text: 'text-emerald-400' },
  sky: { bg: 'bg-sky-500/10', border: 'border-sky-500/30', text: 'text-sky-400' },
  indigo: { bg: 'bg-indigo-500/10', border: 'border-indigo-500/30', text: 'text-indigo-400' },
  purple: { bg: 'bg-purple-500/10', border: 'border-purple-500/30', text: 'text-purple-400' },
  cyan: { bg: 'bg-cyan-500/10', border: 'border-cyan-500/30', text: 'text-cyan-400' },
  amber: { bg: 'bg-amber-500/10', border: 'border-amber-500/30', text: 'text-amber-400' }
};

export default function EarnPage() {
  const router = useRouter();
  const [selectedProduct, setSelectedProduct] = useState<Product | null>(null);
  const [filter, setFilter] = useState<'all' | 'flexible' | 'fixed' | 'advanced'>('all');

  const filteredProducts = products.filter(p => {
    if (filter === 'all') return true;
    if (filter === 'flexible') return p.lockPeriod === 'None' || p.lockPeriod === 'Flexible';
    if (filter === 'fixed') return p.lockPeriod.includes('Day');
    if (filter === 'advanced') return p.risk !== 'Low';
    return true;
  });

  const totalTVL = '$2.4M'; // Mock
  const avgAPY = '5.8%'; // Mock
  const activeUsers = '1,247'; // Mock


// MARK: - Main Render
  return (
    <>
      <DashboardHeader />
      <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">
        
        {/* Header */}
        <header className="sticky top-0 z-40 bg-[#0a0a0a]/95 backdrop-blur border-b border-zinc-800">
          <div className="max-w-5xl lg:max-w-none mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
            <div className="flex items-center gap-1">
              <button

// MARK: - Event Handlers
                onClick={() => router.back()}
                className="text-zinc-400 hover:text-white transition p-2"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <button
                onClick={() => {
                  const vendorWallet = safeGetItem('vendorWalletAddress');
                  if (vendorWallet) {
                    router.push('/dashboard');
                  } else {
                    router.push('/affiliate-dashboard');
                  }
                }}
                className="text-zinc-400 hover:text-white transition p-2"
                title="Dashboard"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
              </button>
            </div>
            
            <div className="flex items-center gap-2">
              <StableAssetLogo className="w-8 h-8" />
              <h1 className="text-base sm:text-lg font-bold hidden sm:block">Stable Asset Exchange</h1>
            </div>
            
            <button
              onClick={() => router.push('/earn/analytics')}
              className="text-indigo-400 hover:text-indigo-300 text-sm font-medium flex items-center gap-1"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="hidden sm:inline">Analytics</span>
            </button>
          </div>
        </header>

        <main className="max-w-5xl lg:max-w-none mx-auto px-4 lg:px-6 pb-12">
          
          {/* Coming Soon Banner */}
          <div className="bg-gradient-to-r from-indigo-500/20 to-purple-500/20 border border-indigo-500/30 rounded-2xl p-6 mt-6 mb-8">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div>
                <div className="flex items-center gap-2 mb-2">
                  <span className="bg-indigo-500 text-white text-xs px-2 py-1 rounded-full font-medium animate-pulse">
                    Coming Soon
                  </span>
                </div>
                <h2 className="text-2xl font-bold mb-1">Earn Interest on Your Assets</h2>
                <p className="text-zinc-400">
                  Yield products provided through our regulated partner.
                </p>
              </div>
              <button className="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-6 py-3 rounded-xl transition">
                Join Waitlist
              </button>
            </div>
          </div>

          {/* Platform Stats */}
          <div className="grid grid-cols-3 gap-2 sm:gap-4 mb-8">
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl sm:rounded-2xl p-3 sm:p-5 text-center">
              <p className="text-zinc-500 text-xs sm:text-sm mb-1">Total Value Locked</p>
              <p className="text-xl sm:text-3xl font-bold text-white">{totalTVL}</p>
              <p className="text-emerald-400 text-xs sm:text-sm mt-1">+12.4%</p>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl sm:rounded-2xl p-3 sm:p-5 text-center">
              <p className="text-zinc-500 text-xs sm:text-sm mb-1">Average APY</p>
              <p className="text-xl sm:text-3xl font-bold text-indigo-400">{avgAPY}</p>
              <p className="text-zinc-500 text-xs sm:text-sm mt-1">All products</p>
            </div>
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl sm:rounded-2xl p-3 sm:p-5 text-center">
              <p className="text-zinc-500 text-xs sm:text-sm mb-1">Active Users</p>
              <p className="text-xl sm:text-3xl font-bold text-white">{activeUsers}</p>
              <p className="text-emerald-400 text-xs sm:text-sm mt-1">+89</p>
            </div>
          </div>

          {/* Filter Tabs */}
          <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
            {[
              { id: 'all', label: 'All Products' },
              { id: 'flexible', label: 'Flexible' },
              { id: 'fixed', label: 'Fixed Term' },
              { id: 'advanced', label: 'Advanced' }
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setFilter(tab.id as typeof filter)}
                className={`px-5 py-2.5 rounded-full text-sm font-medium whitespace-nowrap transition ${
                  filter === tab.id
                    ? 'bg-indigo-500 text-white'
                    : 'bg-zinc-800 text-zinc-400 hover:text-white'
                }`}
              >
                {tab.label}
              </button>
            ))}
          </div>

          {/* Products Grid */}
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            {filteredProducts.map((product) => {
              const colors = productColors[product.color];
              return (
                <div
                  key={product.id}
                  onClick={() => setSelectedProduct(product)}
                  className={`${colors.bg} border ${colors.border} rounded-2xl p-5 cursor-pointer hover:scale-[1.02] transition-all`}
                >
                  <div className="flex items-start justify-between mb-4">
                    <div>{ProductIcons[product.icon as keyof typeof ProductIcons]}</div>
                    <span className={`text-xs px-2 py-1 rounded-full ${riskColors[product.risk]}`}>
                      {product.risk} Risk
                    </span>
                  </div>
                  
                  <h3 className="text-lg font-bold mb-1">{product.name}</h3>
                  <p className="text-zinc-400 text-sm mb-4">{product.description}</p>
                  
                  <div className="flex items-end justify-between">
                    <div>
                      <p className="text-zinc-500 text-xs">APY</p>
                      <p className={`text-2xl font-bold ${colors.text}`}>{product.apy}</p>
                    </div>
                    <div className="text-right">
                      <p className="text-zinc-500 text-xs">Lock Period</p>
                      <p className="text-white font-medium">{product.lockPeriod}</p>
                    </div>
                  </div>
                  
                  <div className="mt-4 pt-4 border-t border-zinc-700/50">
                    <p className="text-zinc-500 text-xs">Min. Deposit: <span className="text-white">{product.minDeposit}</span></p>
                  </div>
                </div>
              );
            })}
          </div>

          {/* How It Works */}
          <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 mb-8">
            <h3 className="text-xl font-bold mb-6">How It Works</h3>
            <div className="grid md:grid-cols-4 gap-6">
              {[
                { step: '1', title: 'Connect', desc: 'Link your wallet or sign in with social login', icon: (
                  <svg className="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                  </svg>
                )},
                { step: '2', title: 'Deposit', desc: 'Transfer RLUSD or XRP to your earn account', icon: (
                  <svg className="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                  </svg>
                )},
                { step: '3', title: 'Choose Product', desc: 'Select a product that matches your goals', icon: (
                  <svg className="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                )},
                { step: '4', title: 'Earn', desc: 'Watch your balance grow with compound interest', icon: (
                  <svg className="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                )}
              ].map((item) => (
                <div key={item.step} className="text-center">
                  <div className="w-12 h-12 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    {item.icon}
                  </div>
                  <div className="text-indigo-400 text-sm font-medium mb-1">Step {item.step}</div>
                  <h4 className="font-semibold mb-1">{item.title}</h4>
                  <p className="text-zinc-500 text-sm">{item.desc}</p>
                </div>
              ))}
            </div>
          </div>

          {/* Security & Compliance */}
          <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 mb-6">
            <h3 className="text-xl font-bold mb-4">Security & Compliance</h3>
            <div className="grid md:grid-cols-3 gap-4">
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                </div>
                <div>
                  <h4 className="font-semibold mb-1">Regulated Partner</h4>
                  <p className="text-zinc-500 text-sm">Fully licensed and regulated in multiple jurisdictions</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 bg-sky-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg className="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
                <div>
                  <h4 className="font-semibold mb-1">Secure Custody</h4>
                  <p className="text-zinc-500 text-sm">Assets held in institutional-grade cold storage</p>
                </div>
              </div>
              <div className="flex items-start gap-3">
                <div className="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                  <svg className="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                  </svg>
                </div>
                <div>
                  <h4 className="font-semibold mb-1">Audited</h4>
                  <p className="text-zinc-500 text-sm">Regular third-party security audits</p>
                </div>
              </div>
            </div>
          </div>

          {/* Disclaimer */}
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-2xl p-4 text-center">
            <p className="text-amber-400 text-sm font-medium mb-1">For Presentation Purposes Only</p>
            <p className="text-zinc-400 text-xs">This is not a live product. All rates, figures, and features shown are for demonstration purposes only.</p>
          </div>
        </main>

        {/* Product Detail Modal */}
        {selectedProduct && (
          <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
            <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  {ProductIcons[selectedProduct.icon as keyof typeof ProductIcons]}
                  <h3 className="text-xl font-bold">{selectedProduct.name}</h3>
                </div>
                <button
                  onClick={() => setSelectedProduct(null)}
                  className="text-zinc-400 hover:text-white"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <p className="text-zinc-400 mb-6">{selectedProduct.description}</p>

              <div className="grid grid-cols-2 gap-4 mb-6">
                <div className="bg-zinc-800/50 rounded-lg p-3">
                  <p className="text-zinc-500 text-xs mb-1">APY</p>
                  <p className={`text-2xl font-bold ${productColors[selectedProduct.color].text}`}>
                    {selectedProduct.apy}
                  </p>
                </div>
                <div className="bg-zinc-800/50 rounded-lg p-3">
                  <p className="text-zinc-500 text-xs mb-1">Lock Period</p>
                  <p className="text-xl font-bold">{selectedProduct.lockPeriod}</p>
                </div>
                <div className="bg-zinc-800/50 rounded-lg p-3">
                  <p className="text-zinc-500 text-xs mb-1">Min. Deposit</p>
                  <p className="text-xl font-bold">{selectedProduct.minDeposit}</p>
                </div>
                <div className="bg-zinc-800/50 rounded-lg p-3">
                  <p className="text-zinc-500 text-xs mb-1">Risk Level</p>
                  <p className={`text-xl font-bold ${riskColors[selectedProduct.risk].split(' ')[0]}`}>
                    {selectedProduct.risk}
                  </p>
                </div>
              </div>

              <div className="mb-6">
                <h4 className="font-semibold mb-3">Features</h4>
                <ul className="space-y-2">
                  {selectedProduct.features.map((feature, i) => (
                    <li key={i} className="flex items-center gap-2 text-sm text-zinc-300">
                      <svg className="w-4 h-4 text-emerald-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                      </svg>
                      {feature}
                    </li>
                  ))}
                </ul>
              </div>

              <button
                disabled
                className="w-full bg-zinc-700 text-zinc-400 font-semibold py-3 rounded-xl cursor-not-allowed"
              >
                Coming Soon
              </button>
            </div>
          </div>
        )}
      </div>
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/install/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { QRCodeSVG } from 'qrcode.react';


// MARK: - Types & Interfaces
interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

type BrowserType = 'chrome' | 'edge' | 'brave' | 'safari' | 'firefox' | 'samsung' | 'other';
type DeviceType = 'ios' | 'android' | 'desktop';


// MARK: - Component Definition
export default function InstallPage() {
  const [installPrompt, setInstallPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [device, setDevice] = useState<DeviceType>('desktop');
  const [browser, setBrowser] = useState<BrowserType>('other');

// MARK: - State Management
  const [isInstalled, setIsInstalled] = useState(false);
  const [installing, setInstalling] = useState(false);
  const [showInstructions, setShowInstructions] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
      return;
    }

    // Detect device
    const ua = navigator.userAgent;
    if (/iPad|iPhone|iPod/.test(ua)) {
      setDevice('ios');
    } else if (/Android/.test(ua)) {
      setDevice('android');
    } else {
      setDevice('desktop');
    }

    // Detect browser
    if ((navigator as any).brave?.isBrave) {
      setBrowser('brave');
    } else if (ua.includes('Edg/')) {
      setBrowser('edge');
    } else if (ua.includes('Chrome') && !ua.includes('Edg/')) {
      setBrowser('chrome');
    } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
      setBrowser('safari');
    } else if (ua.includes('Firefox')) {
      setBrowser('firefox');
    } else if (ua.includes('SamsungBrowser')) {
      setBrowser('samsung');
    }

    // Listen for install prompt (Chromium browsers)
    const handler = (e: Event) => {
      e.preventDefault();
      setInstallPrompt(e as BeforeInstallPromptEvent);
    };

    window.addEventListener('beforeinstallprompt', handler);
    window.addEventListener('appinstalled', () => setIsInstalled(true));

    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);


// MARK: - Event Handlers
  const handleInstall = async () => {
    // If we have the native prompt, use it
    if (installPrompt) {
      setInstalling(true);
      installPrompt.prompt();
      const result = await installPrompt.userChoice;
      if (result.outcome === 'accepted') {
        setIsInstalled(true);
      }
      setInstalling(false);
      return;
    }

    // Otherwise show instructions
    setShowInstructions(true);
  };

  const supportsNativePrompt = installPrompt !== null;

  // Get browser-specific instructions

// MARK: - API Calls & Data Fetching
  const getInstructions = () => {
    if (device === 'ios') {
      return {
        title: 'Install on iPhone/iPad',
        steps: [
          { text: 'Tap the Share button', icon: 'share' },
          { text: 'Scroll and tap "Add to Home Screen"', icon: 'plus' },
          { text: 'Tap "Add"', icon: 'check' },
        ],
      };
    }

    if (device === 'android') {
      if (browser === 'firefox') {
        return {
          title: 'Install on Android (Firefox)',
          steps: [
            { text: 'Tap the menu (‚ãÆ)', icon: 'menu' },
            { text: 'Tap "Install"', icon: 'plus' },
            { text: 'Confirm installation', icon: 'check' },
          ],
        };
      }
      return {
        title: 'Install on Android',
        steps: [
          { text: 'Tap the menu (‚ãÆ)', icon: 'menu' },
          { text: 'Tap "Add to Home Screen" or "Install App"', icon: 'plus' },
          { text: 'Tap "Install"', icon: 'check' },
        ],
      };
    }

    // Desktop
    if (browser === 'safari') {
      return {
        title: 'Install on Safari (Mac)',
        steps: [
          { text: 'Click File in the menu bar', icon: 'menu' },
          { text: 'Click "Add to Dock"', icon: 'plus' },
          { text: 'Click "Add"', icon: 'check' },
        ],
      };
    }

    if (browser === 'firefox') {
      return {
        title: 'Install on Firefox',
        steps: [
          { text: 'Firefox has limited PWA support', icon: 'info' },
          { text: 'Try opening in Chrome, Edge, or Brave', icon: 'browser' },
          { text: 'Or scan the QR code on mobile', icon: 'qr' },
        ],
      };
    }

    if (browser === 'edge') {
      return {
        title: 'Install on Edge',
        steps: [
          { text: 'Click the install icon in the address bar', icon: 'plus' },
          { text: 'Or click menu (‚ãØ) ‚Üí Apps ‚Üí Install', icon: 'menu' },
          { text: 'Click "Install"', icon: 'check' },
        ],
      };
    }

    if (browser === 'brave') {
      return {
        title: 'Install on Brave',
        steps: [
          { text: 'Click the install icon in the address bar', icon: 'plus' },
          { text: 'Or click menu ‚Üí "Install YesAllOfUs"', icon: 'menu' },
          { text: 'Click "Install"', icon: 'check' },
        ],
      };
    }

    // Chrome default
    return {
      title: 'Install App',
      steps: [
        { text: 'Click the install icon in the address bar', icon: 'plus' },
        { text: 'Or click menu (‚ãÆ) ‚Üí "Install YesAllOfUs"', icon: 'menu' },
        { text: 'Click "Install"', icon: 'check' },
      ],
    };
  };

  const instructions = getInstructions();

  const getIcon = (icon: string) => {
    switch (icon) {
      case 'share':

// MARK: - Main Render
        return (
          <svg className="w-5 h-5 text-sky-400" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2l3 3h-2v6h-2V5H9l3-3zm-7 9v10h14V11h-2v8H7v-8H5z" />
          </svg>
        );
      case 'plus':
        return (
          <svg className="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
        );
      case 'check':
        return (
          <svg className="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        );
      case 'menu':
        return (
          <svg className="w-5 h-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
          </svg>
        );
      case 'info':
        return (
          <svg className="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
          </svg>
        );
      case 'browser':
        return (
          <svg className="w-5 h-5 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
          </svg>
        );
      case 'qr':
        return (
          <svg className="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" />
            <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75zM6.75 16.5h.75v.75h-.75v-.75zM16.5 6.75h.75v.75h-.75v-.75zM13.5 13.5h.75v.75h-.75v-.75zM13.5 19.5h.75v.75h-.75v-.75zM19.5 13.5h.75v.75h-.75v-.75zM19.5 19.5h.75v.75h-.75v-.75zM16.5 16.5h.75v.75h-.75v-.75z" />
          </svg>
        );
      default:
        return null;
    }
  };

  // Already installed view
  if (isInstalled) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] text-white flex flex-col items-center justify-center p-6">
        <div className="w-full max-w-md text-center">
          <div className="relative mb-8">
            <div className="absolute inset-0 bg-emerald-500/20 rounded-full blur-3xl animate-pulse" />
            <div className="relative w-32 h-32 mx-auto bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-3xl flex items-center justify-center shadow-2xl shadow-emerald-500/30">
              <svg className="w-16 h-16 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
              </svg>
            </div>
          </div>
          <h1 className="text-3xl font-bold mb-3">You're All Set!</h1>
          <p className="text-zinc-400 mb-8">YesAllOfUs is installed on your device. Find it on your home screen.</p>
          
           <a href="/dashboard"
            className="inline-flex items-center gap-2 px-8 py-4 bg-emerald-500 hover:bg-emerald-400 text-black font-bold rounded-2xl transition active:scale-95"
          >
            Open Dashboard
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white overflow-x-hidden">
      
      {/* Background Effects */}
      <div className="fixed inset-0 pointer-events-none">
        <div className="absolute top-1/4 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-emerald-500/10 rounded-full blur-[120px]" />
        <div className="absolute bottom-0 left-0 w-[400px] h-[400px] bg-sky-500/5 rounded-full blur-[100px]" />
      </div>

      <div className="relative z-10 min-h-screen flex flex-col">
        
        {/* Header */}
        <header className="p-6">
          <a href="/" className="inline-flex items-center gap-2 text-zinc-400 hover:text-white transition">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
            Back
          </a>
        </header>

        {/* Main Content */}
        <main className="flex-1 flex flex-col items-center justify-center p-6 pb-12">
          <div className="w-full max-w-md">
            
            {/* Logo */}
<div className="relative mb-6">
  <div className="absolute inset-0 bg-emerald-500/20 rounded-full blur-3xl animate-pulse" />
  <div className="relative w-24 h-24 mx-auto rounded-2xl overflow-hidden shadow-2xl shadow-black/50 ring-1 ring-white/10">
    <img 
      src="/dltpayslogo1.png" 
      alt="YesAllOfUs" 
      className="w-full h-full object-cover"
    />
  </div>
</div>

            {/* Title */}
<div className="text-center mb-6">
  <h1 className="text-3xl font-bold mb-2 bg-gradient-to-r from-white to-zinc-400 bg-clip-text text-transparent">
    Get the App
  </h1>
  <p className="text-zinc-400">
    Install YesAllOfUs for the best experience
  </p>
</div>

            {/* QR Code - Desktop only */}
{device === 'desktop' && (
  <div className="flex flex-col items-center mb-6">
    <div className="bg-white p-3 rounded-xl mb-3">
      <QRCodeSVG 
        value="https://yesallofus.com/install"
        size={120}
        level="H"
        bgColor="#ffffff"
        fgColor="#0a0a0a"
      />
    </div>
    <p className="text-zinc-500 text-xs">Scan with your phone to install</p>
  </div>
)}

            {/* Install Button */}
<button
  onClick={handleInstall}
  disabled={installing}
  className="group w-full p-3 rounded-2xl border border-zinc-800/50 bg-gradient-to-r from-emerald-500/5 to-sky-500/5 hover:from-emerald-500/10 hover:to-sky-500/10 hover:border-emerald-500/30 transition-all duration-300 mb-6"
>
  <div className="flex items-center gap-3">
    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 flex items-center justify-center group-hover:scale-110 transition-transform">
      {installing ? (
        <div className="w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin" />
      ) : (
        <svg className="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25" />
        </svg>
      )}
    </div>
    
    <div className="flex-1 text-left">
      <p className="font-semibold text-white text-sm">{installing ? 'Installing...' : 'Install App'}</p>
      <p className="text-zinc-500 text-xs">
        {supportsNativePrompt ? 'One tap install' : `Instructions for ${browser === 'other' ? 'your browser' : browser.charAt(0).toUpperCase() + browser.slice(1)}`}
      </p>
    </div>
    
    <svg className="w-5 h-5 text-zinc-600 group-hover:text-emerald-400 group-hover:translate-x-1 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
    </svg>
  </div>
</button>

            {/* Features */}
<div className="grid gap-3">
  <div className="flex items-center gap-3 bg-zinc-900/50 border border-zinc-800 rounded-xl p-3">
    <div className="w-10 h-10 bg-emerald-500/10 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
    </div>
    <div>
      <p className="font-semibold text-sm">Lightning Fast</p>
      <p className="text-xs text-zinc-500">Instant access from your home screen</p>
    </div>
  </div>

  <div className="flex items-center gap-3 bg-zinc-900/50 border border-zinc-800 rounded-xl p-3">
    <div className="w-10 h-10 bg-sky-500/10 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg className="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
    </div>
    <div>
      <p className="font-semibold text-sm">Native Experience</p>
      <p className="text-xs text-zinc-500">Works like a real app, no browser UI</p>
    </div>
  </div>

  <div className="flex items-center gap-3 bg-zinc-900/50 border border-zinc-800 rounded-xl p-3">
    <div className="w-10 h-10 bg-amber-500/10 rounded-lg flex items-center justify-center flex-shrink-0">
      <svg className="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
    </div>
    <div>
      <p className="font-semibold text-sm">Stay Updated</p>
      <p className="text-xs text-zinc-500">Get notified on payments instantly</p>
    </div>
  </div>
</div>

          </div>
        </main>

        {/* Footer */}
        <footer className="p-6 text-center">
          <p className="text-zinc-600 text-sm">
            No app store required ‚Ä¢ Instant install ‚Ä¢ Always up to date
          </p>
        </footer>

      </div>

      {/* Instructions Modal */}
      {showInstructions && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
          <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-sm w-full">
            
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-lg font-bold">{instructions.title}</h3>
              <button 
                onClick={() => setShowInstructions(false)}
                className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center hover:bg-zinc-700 transition"
              >
                <svg className="w-4 h-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            {/* Steps */}
            <div className="space-y-4">
              {instructions.steps.map((step, i) => (
                <div key={i} className="flex items-center gap-4 p-3 rounded-xl bg-zinc-800/50">
                  <div className="w-10 h-10 rounded-xl bg-zinc-700 flex items-center justify-center font-bold text-sm">
                    {i + 1}
                  </div>
                  <div className="flex-1">
                    <p className="text-sm text-zinc-300">{step.text}</p>
                  </div>
                  <div className="w-10 h-10 rounded-xl bg-zinc-800 flex items-center justify-center">
                    {getIcon(step.icon)}
                  </div>
                </div>
              ))}
            </div>

            {/* Footer */}
            <button
              onClick={() => setShowInstructions(false)}
              className="w-full mt-6 py-3 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold rounded-xl transition active:scale-[0.98]"
            >
              Got it
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/layout.tsx
// =================================================
// MARK: - Imports & Dependencies
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import TourProvider from '@/components/TourProvider';

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "YesAllofUs - Instant Affiliate Commissions on XRPL",
  description: "Pay affiliate commissions in 4 seconds, not 30 days. Instant RLUSD payouts via XRP Ledger. No custody. WordPress plugin + API.",
  keywords: ["affiliate", "commissions", "XRPL", "XRP", "RLUSD", "instant payouts", "WordPress", "WooCommerce"],
  authors: [{ name: "Mark", url: "https://yesallofus.com" }],
  creator: "YesAllofUs",
  publisher: "YesAllofUs",
  metadataBase: new URL("https://yesallofus.com"),
  icons: {
  icon: "/favicon.ico",
  apple: "/apple-touch-icon.png",
},
  openGraph: {
    type: "website",
    locale: "en_GB",
    url: "https://yesallofus.com",
    siteName: "YesAllofUs",
    title: "YesAllofUs - Instant Affiliate Commissions on XRPL",
    description: "Pay affiliate commissions in 4 seconds, not 30 days. Instant RLUSD payouts via XRP Ledger.",
    images: [
      {
        url: "/og-image.png",
        width: 1200,
        height: 630,
        alt: "YesAllofUs - Instant Affiliate Commissions",
      },
    ],
  },
  twitter: {
    card: "summary_large_image",
    site: "@YesAllofUs",
    creator: "@YesAllofUs",
    title: "YesAllofUs - Instant Affiliate Commissions on XRPL",
    description: "Pay affiliate commissions in 4 seconds, not 30 days. Instant RLUSD payouts via XRP Ledger.",
    images: ["/og-image.png"],
  },
  applicationName: "YesAllofUs",
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
    },
  },
  category: "technology",
};


// MARK: - Component Definition
export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {

// MARK: - Main Render
  return (
    <html lang="en">
      <head>
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/favicon.ico" sizes="48x48" />
  <meta name="theme-color" content="#0d0d0d" />
        <script src="https://unpkg.com/@aspect-dev/crossmark-sdk@1.0.5/dist/umd/index.js" async></script>
        <script src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js" type="module" async></script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-13PHKRLJ2R"></script>
        <script
          dangerouslySetInnerHTML={{
            __html: `
              if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                  navigator.serviceWorker.register('/sw.js');
                });
              }
            `,
          }}
        />
      </head>
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
        <TourProvider>
          {children}
        </TourProvider>
      </body>
    </html>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/pay/[paymentId]/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, useRef } from 'react';
import { useParams } from 'next/navigation';
import { safeGetItem } from '@/lib/safeStorage';
import InstantPay from '@/components/InstantPay';
import { QRCodeSVG } from 'qrcode.react';
import ReceiptActions from '@/components/ReceiptActions';
import PaymentSuccess from '@/components/PaymentSuccess';
import TipSelector from '@/components/TipSelector';
import NebulaBackground from '@/components/NebulaBackground';
import SoundPay from '@/components/SoundPay'


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';

// Valid payment ID pattern (alphanumeric, underscores, hyphens)
const VALID_ID_PATTERN = /^[a-zA-Z0-9_-]+$/;


// MARK: - Types & Interfaces
interface PaymentData {
  payment_id: string;
  store_id: string;
  store_name: string;
  store_logo: string | null;
  vendor_wallet: string;
  amount: number;
  currency: string;
  items: any[];
  tip: number;
  customer_tip?: number;
  status: string;
  split_index: number | null;
  total_splits: number | null;
  expires_at: string | null;
  paid_at: string | null;
  payer_wallet: string | null;
  customer_logo: string | null;
  receipt_id?: string | null;
}

interface SplitData {
  payment_id: string;
  amount: number;
  split_index: number;
  status: string;
  tip: number;  // Add this line
}


// MARK: - Component Definition
export default function PayPage() {
  const params = useParams();
  const rawPaymentId = params.paymentId as string;

  // Validate payment ID to prevent injection attacks
  const paymentId = VALID_ID_PATTERN.test(rawPaymentId) ? rawPaymentId : '';

  const [payment, setPayment] = useState<PaymentData | null>(null);

// MARK: - State Management
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(paymentId ? null : 'Invalid payment ID');
  const [processing, setProcessing] = useState(false);
  const [txHash, setTxHash] = useState<string | null>(null);
  const [receiptId, setReceiptId] = useState<string | null>(null);

  // Split bill state
  const [showSplitModal, setShowSplitModal] = useState(false);
  const [splitCount, setSplitCount] = useState(2);
  const [splits, setSplits] = useState<SplitData[] | null>(null);
  const [currentSplitIndex, setCurrentSplitIndex] = useState(0);
  const [splitting, setSplitting] = useState(false);
  const [allPaid, setAllPaid] = useState(false);

  // Ref for currentSplitIndex to avoid stale closures in event handlers
  const currentSplitIndexRef = useRef(currentSplitIndex);
  currentSplitIndexRef.current = currentSplitIndex;

  // Ref to prevent TOCTOU race in split creation
  const splitCreationInProgress = useRef(false);

  // L3: Track consecutive poll failures
  const pollFailureCount = useRef(0);

  // Xaman QR state
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [xamanPaymentId, setXamanPaymentId] = useState<string | null>(null);

  // NFC state
  const [nfcSupported, setNfcSupported] = useState(false);
  const [nfcScanning, setNfcScanning] = useState(false);
  const [nfcController, setNfcController] = useState<AbortController | null>(null);


  // Sound payment state
  // Live conversion state
  const [liveRate, setLiveRate] = useState<number | null>(null);
  const [rlusdAmount, setRlusdAmount] = useState<number | null>(null);
const [priceAge, setPriceAge] = useState<number>(0);
const [rateStale, setRateStale] = useState(false); // M5: Track if rate is stale
const [conversionRate, setConversionRate] = useState<{
  rlusd_gbp: number;
  source: string;
  captured_at: string;
} | null>(null);

// M6: Ref for amount to reduce useEffect dependency churn
const amountRef = useRef<number>(0);

// Split success message
  const [showToast, setShowToast] = useState(false);

  // Split share state
  const [copiedSplitId, setCopiedSplitId] = useState<string | null>(null);
  const [showSplitQR, setShowSplitQR] = useState<string | null>(null);
  const [showSplitEmailModal, setShowSplitEmailModal] = useState(false);
  const [splitEmailTarget, setSplitEmailTarget] = useState<SplitData | null>(null);
  const [splitEmailAddress, setSplitEmailAddress] = useState('');
  const [sendingSplitEmail, setSendingSplitEmail] = useState(false);
  // Tip selector
  const [tipAmount, setTipAmount] = useState(0);

  // Fetch live conversion rate - M6: Use ref to reduce dependency churn

// MARK: - Hooks & Effects
  useEffect(() => {

// MARK: - API Calls & Data Fetching
    const fetchRate = async () => {
      const amount = getCurrentAmount();
      amountRef.current = amount;
      if (amount <= 0) return;

      try {
        const res = await fetch(`https://api.dltpays.com/convert/gbp-to-rlusd?amount=${amount}&capture=true`);
        const data = await res.json();
        if (data.success) {
          setLiveRate(data.rate.gbp_to_rlusd);
          setRlusdAmount(data.rlusd);
          setPriceAge(data.price_age_ms);
          // M5: Check if rate is stale (> 30 seconds old)
          setRateStale(data.price_age_ms > 30000);
          setConversionRate({
            rlusd_gbp: data.rate.rlusd_gbp || (1 / data.rate.gbp_to_rlusd),
            source: data.rate.source || 'CoinGecko Pro API',
            captured_at: data.rate.captured_at || new Date().toISOString()
          });
        }
      } catch (err) {
        console.error('Rate fetch error:', err);
        setRateStale(true); // Mark as stale on fetch error
      }
    };

    fetchRate();
    const interval = setInterval(fetchRate, 10000); // Refresh every 10s
    return () => clearInterval(interval);
  }, [payment, splits]);

  // Convert GBP to RLUSD
  const convertGBPtoRLUSD = async (gbpAmount: number): Promise<number> => {
  try {
    const res = await fetch(`https://api.dltpays.com/convert/gbp-to-rlusd?amount=${gbpAmount}&capture=true`);
    const data = await res.json();
    if (data.success) {
      return data.rlusd;
    }
    throw new Error('Conversion failed');
  } catch (err) {
    console.error('Price conversion error:', err);
    // Fallback
    return Math.round(gbpAmount * 1.35 * 100) / 100;
  }
};

// Check NFC support on mount
useEffect(() => {
  if ('NDEFReader' in window) {
    setNfcSupported(true);
  }
}, []);

  // Fetch payment data
  useEffect(() => {
    if (!paymentId) return;

    const fetchPayment = async () => {
      try {
        const res = await fetch(`${API_URL}/payment-link/${paymentId}`);
        const data = await res.json();

        if (!data.success) {
          setError(data.error || 'Payment not found');
          return;
        }

        setPayment(data.payment);
      } catch (err) {
        setError('Failed to load payment');
      } finally {
        setLoading(false);
      }
    };

    fetchPayment();
  }, [paymentId]);

  // Poll for Xaman payment status
  useEffect(() => {
    if (!xamanPaymentId) return;

    // L3: Reset failure count when starting new poll
    pollFailureCount.current = 0;

    const pollInterval = setInterval(async () => {
      try {
        const res = await fetch(`https://api.dltpays.com/api/v1/xaman/payment/poll/${xamanPaymentId}`);
        const data = await res.json();

        // L3: Reset failure count on successful poll
        pollFailureCount.current = 0;

        if (data.status === 'signed') {
          setTxHash(data.tx_hash);
          if (data.receipt_id) setReceiptId(data.receipt_id);
          setXamanQR(null);
          setXamanPaymentId(null);

          // Mark payment as paid in our system
          const payRes = await fetch(`${API_URL}/payment-link/${getCurrentPaymentId()}/pay`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payer_wallet: 'xaman_payment', tx_hash: data.tx_hash })
          });
          const payData = await payRes.json();
          if (payData.receipt_id) setReceiptId(payData.receipt_id);

          // Move to next split or show success - use ref for fresh value
          const splitIdx = currentSplitIndexRef.current;
          if (splits && splitIdx < splits.length - 1) {
            setCurrentSplitIndex(prev => prev + 1);
          } else {
            setAllPaid(true);
          }

          if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        } else if (data.status === 'expired' || data.status === 'cancelled' || data.status === 'failed') {
          setError(data.message || `Payment ${data.status}`);
          setXamanQR(null);
          setXamanPaymentId(null);
        }
      } catch (err) {
        // L3: Track consecutive failures and show error after 3
        pollFailureCount.current++;
        console.error('Poll error:', err, `(failure ${pollFailureCount.current})`);
        if (pollFailureCount.current >= 3) {
          setError('Connection lost. Please check your payment in Xaman and refresh.');
        }
      }
    }, 2000);

    return () => clearInterval(pollInterval);
  }, [xamanPaymentId, splits]);

  // Save tip to backend when changed
  useEffect(() => {
    const saveTip = async () => {
      if (tipAmount > 0) {
        try {
          const res = await fetch(`${API_URL}/payment-link/${getCurrentPaymentId()}/tip`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tip_amount: tipAmount })
          });
          if (!res.ok) {
            console.error('Tip save failed:', res.status);
            // L1: Don't block payment for tip save failure, just log
          } else {
            console.log('üí∞ Tip saved:', tipAmount);
          }
        } catch (err) {
          // L1: Log but don't block - tip save is non-critical
          console.error('Failed to save tip:', err);
        }
      }
    };
    saveTip();
  }, [tipAmount, currentSplitIndex]);

  const getCurrentPaymentId = () => {
    if (splits && splits.length > 0) {
      return splits[currentSplitIndex].payment_id;
    }
    return paymentId;
  };

  const getCurrentAmount = () => {
    if (splits && splits.length > 0) {
      return splits[currentSplitIndex].amount;
    }
    return payment?.amount || 0;
  };

  // Generate Xaman QR
  const generateXamanQR = async () => {
    const amount = getCurrentAmount();
    const rlusdAmount = await convertGBPtoRLUSD(amount);

    try {
      const res = await fetch('https://api.dltpays.com/api/v1/xaman/payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: rlusdAmount,
          vendor_wallet: payment?.vendor_wallet,
          store_id: payment?.store_id,
          store_name: payment?.store_name
        })
      });

      const data = await res.json();
      if (data.success) {
        setXamanQR(data.qr_png);
        setXamanPaymentId(data.payment_id);
      } else {
        setError(data.error || 'Failed to create payment');
      }
    } catch (err) {
      setError('Failed to create payment request');
    }
  };

  // Stop NFC scan
  const stopNFCScan = () => {
    if (nfcController) {
      nfcController.abort();
      setNfcController(null);
    }
    setNfcScanning(false);
  };

  // Start NFC scan
  const startNFCScan = async () => {
    if (!('NDEFReader' in window)) {
      setError('NFC not supported on this device');
      return;
    }

    // Always abort any existing scan first
    stopNFCScan();

    const controller = new AbortController();
    setNfcController(controller);
    setNfcScanning(true);
    setError(null);

    try {
      const ndef = new (window as any).NDEFReader();
      await ndef.scan({ signal: controller.signal });

      ndef.addEventListener('reading', async (event: any) => {
        // Immediately abort to prevent duplicate reads
        controller.abort();
        
        const uid = event.serialNumber?.replace(/:/g, '').toUpperCase();
        if (!uid) {
          setError('Could not read card');
          setNfcScanning(false);
          setNfcController(null);
          return;
        }

        setNfcScanning(false);
        setNfcController(null);
        setProcessing(true);

        // Get the current payment ID at the moment of scan using ref for fresh value
        const splitIdx = currentSplitIndexRef.current;
        const currentPaymentId = splits && splits.length > 0
          ? splits[splitIdx]?.payment_id
          : paymentId;

        // Check if this split is already paid
        if (splits && splits[splitIdx]?.status === 'paid') {
          setError(null);
          setProcessing(false);
          return;
        }

        try {
          const res = await fetch(`${API_URL}/payment-link/${currentPaymentId}/pay`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card_uid: uid })
          });

          const result = await res.json();

          if (result.success) {
  setTxHash(result.tx_hash);
  setReceiptId(result.receipt_id);
  setError(null);
  
  // Mark current split as paid using ref for fresh value
  const paidIdx = currentSplitIndexRef.current;
  if (splits) {
    setSplits(prev => prev!.map((s, idx) =>
      idx === paidIdx ? { ...s, status: 'paid' } : s
    ));
  }

  // Show success toast
  setShowToast(true);
  setTimeout(() => setShowToast(false), 2500);

  // Move to next split or show success
  if (splits && paidIdx < splits.length - 1) {
    setTimeout(() => {
      setCurrentSplitIndex(prev => prev + 1);
    }, 800);
  } else {
    setAllPaid(true);
  }
  
  if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
} else {
  if (result.error === 'NO_SIGNER_AUTHORITY') {
  setError('Wallet not set up for tap-to-pay');
} else if (result.error?.includes('not found') || result.error?.includes('not linked') || result.error?.includes('not registered')) {
  setError('Card not linked to a wallet');
} else {
  setError(result.error || 'Payment failed');
}
}
        } catch (err) {
          setError('Payment failed');
        } finally {
          setProcessing(false);
          setNfcScanning(false);
          setNfcController(null);
        }
      });

      ndef.addEventListener('readingerror', () => {
        setError('Error reading card');
        stopNFCScan();
      });

    } catch (err: any) {
      if (err.name === 'NotAllowedError') {
        setError('NFC permission denied');
      } else if (err.name !== 'AbortError') {
        setError('Failed to start NFC');
      }
      stopNFCScan();
    }
  };

  // Handle split bill

// MARK: - Event Handlers
const handleSplitBill = async () => {
  // Prevent TOCTOU: check and set atomically with ref
  if (splitCreationInProgress.current) return;
  splitCreationInProgress.current = true;

  // Prevent if already split
  if (payment?.status === 'split' || splits) {
    setError('This bill has already been split');
    setShowSplitModal(false);
    splitCreationInProgress.current = false;
    return;
  }

  setSplitting(true);
  setError(null);

  try {
    const res = await fetch(`${API_URL}/payment-link/${paymentId}/split`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ num_splits: splitCount })
      });

      const result = await res.json();

      if (result.success) {
        setSplits(result.splits.map((s: any) => ({
          payment_id: s.payment_id,
          amount: s.amount,
          split_index: s.split_index,
          status: 'pending'
        })));
        setShowSplitModal(false);
        setCurrentSplitIndex(0);
      } else {
        setError(result.error || 'Failed to split bill');
      }
    } catch (err) {
      setError('Failed to split bill');
    } finally {
      setSplitting(false);
      splitCreationInProgress.current = false;
    }
  };

  // Share link
  const shareLink = async (url: string, index: number, amount: number) => {
    const text = `Pay your share (${index}/${splits?.length}): ¬£${amount.toFixed(2)}`;
    
    if (navigator.share) {
      try {
        await navigator.share({ title: 'Split Bill Payment', text, url });
      } catch (err) {
        // User cancelled
      }
    } else {
      await navigator.clipboard.writeText(url);
      alert('Link copied to clipboard!');
    }
  };

  // Loading state
  if (loading) {

// MARK: - Main Render
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center">
        <div className="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    );
  }

  // Error state (no payment)
  if (error && !payment) {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center p-6">
        <div className="text-center">
          <div className="text-6xl mb-6">‚ùå</div>
          <h1 className="text-2xl font-bold mb-2">Payment Not Found</h1>
          <p className="text-zinc-400">{error}</p>
        </div>
      </div>
    );
  }

  // Expired state
  if (payment?.status === 'expired') {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center p-6">
        <div className="text-center">
          <div className="text-6xl mb-6">‚è∞</div>
          <h1 className="text-2xl font-bold mb-2">Payment Expired</h1>
          <p className="text-zinc-400">This payment link has expired</p>
        </div>
      </div>
    );
  }

  // All paid success state
  if (allPaid || payment?.status === 'paid') {
  console.log('üßæ PaymentSuccess render - receiptId:', receiptId, 'payment.receipt_id:', payment?.receipt_id);
  return (
    <PaymentSuccess
        storeName={payment?.store_name || ''}
        storeId={payment?.store_id}
        storeLogo={payment?.store_logo}
        amount={payment?.amount || 0}
        tip={payment?.customer_tip || payment?.tip || 0}
        txHash={txHash || undefined}
        receiptId={receiptId || payment?.receipt_id || undefined}
        rlusdAmount={rlusdAmount || undefined}
        conversionRate={conversionRate || undefined}
        items={payment?.items || []}
        isSplit={!!(splits && splits.length > 0)}
        splitAmount={splits ? getCurrentAmount() : undefined}
        splitTip={splits ? (payment?.customer_tip || payment?.tip || 0) : undefined}
        walletAddress={safeGetItem('walletAddress')}
      />
    );
  }

  // Main payment view
  const currentAmount = getCurrentAmount();
  const currentIndex = splits ? currentSplitIndex + 1 : (payment?.split_index || null);
  const totalSplits = splits?.length || payment?.total_splits || null;

  return (
    <div className="min-h-screen bg-transparent text-white">
      <NebulaBackground opacity={0.3} />

      <div className="relative z-10 max-w-md mx-auto p-6">
        {/* Store header */}
<div className="text-center mb-6">
  {payment?.store_logo ? (
    <img 
      src={payment.store_logo} 
      alt={payment.store_name} 
      className="w-16 h-16 rounded-xl object-cover mx-auto mb-3"
    />
  ) : (
    <div className="w-16 h-16 bg-zinc-800 rounded-xl flex items-center justify-center mx-auto mb-3">
      <span className="text-2xl">üè™</span>
    </div>
  )}
  <h1 className="text-xl font-bold">{payment?.store_name}</h1>
  {totalSplits && (
    <p className="text-emerald-400 text-sm font-medium">
      Payment {currentIndex} of {totalSplits}
    </p>
  )}
</div>

{/* Success Toast */}
{showToast && (
  <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-emerald-500 text-black px-6 py-3 rounded-full font-semibold flex items-center gap-2 shadow-lg animate-pulse">
    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
    </svg>
    Payment successful!
  </div>
)}

        {/* Amount */}
        <div className="text-center mb-4">
          <p className="text-zinc-400 mb-2">Amount to pay</p>
          <p className="text-6xl font-bold text-emerald-400">
            ¬£{currentAmount.toFixed(2)}
          </p>
        </div>

        {/* Live Conversion Rate - Powered by CoinGecko */}
        <div className="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4 mb-6">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              <img
                src="https://static.coingecko.com/s/coingecko-logo-8903d34ce19ca4be1c81f0db30e924154750d208683fad7ae6f2ce06c76d0a56.png"
                alt="CoinGecko"
                className="h-5 w-auto object-contain"
              />
              <span className="text-xs text-zinc-500">Live rate from CoinGecko Pro</span>
            </div>
            <div className="flex items-center gap-1.5">
              {rateStale ? (
                <>
                  <div className="w-2 h-2 bg-amber-500 rounded-full" />
                  <span className="text-xs text-amber-500 font-medium">STALE</span>
                </>
              ) : (
                <>
                  <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" />
                  <span className="text-xs text-emerald-500 font-medium">LIVE</span>
                </>
              )}
            </div>
          </div>
          
          <div className="flex items-baseline justify-between">
            <span className="text-zinc-400 text-sm">Settlement amount</span>
            <div className="text-right">
              <span className="text-2xl font-bold text-white font-mono">
                {rlusdAmount ? rlusdAmount.toFixed(4) : '...'} <span className="text-emerald-400 text-lg">RLUSD</span>
              </span>
              {liveRate && (
                <p className="text-xs text-zinc-500 mt-1">
                  ¬£1 = {liveRate.toFixed(4)} RLUSD
                </p>
              )}
            </div>
          </div>
          
          <div className="mt-3 pt-3 border-t border-zinc-800 flex items-start gap-2">
            <svg className="w-4 h-4 text-amber-400/80 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 16v-4M12 8h.01" />
            </svg>
            <p className="text-[11px] text-zinc-500 leading-relaxed">
              <span className="text-zinc-400 font-medium">Live price.</span> Updated every 10s via CoinGecko Pro (600+ exchanges). Settlement variance &lt;0.1%.
            </p>
          </div>

          {/* M5: Rate staleness warning */}
          {rateStale && (
            <div className="mt-3 bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 flex items-start gap-2">
              <svg className="w-4 h-4 text-amber-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <p className="text-xs text-amber-400">
                Rate data is stale. Please wait for fresh pricing before completing payment.
              </p>
            </div>
          )}
        </div>

        {error && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6 text-center">
            {error === 'INSUFFICIENT_FUNDS' ? (
              <>
                <p className="text-red-400 font-medium mb-2">Insufficient funds in your wallet</p>
                <p className="text-zinc-400 text-sm mb-3">Please top up your RLUSD balance to complete this payment.</p>
                <a href="/affiliate-dashboard"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center gap-2 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-4 py-2 rounded-lg transition"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                  Top Up Wallet
                </a>
              </>
            ) : error === 'SELF_PAYMENT_NOT_ALLOWED' ? (
              <>
                <p className="text-red-400 font-medium mb-2">Cannot pay to your own wallet</p>
                <p className="text-zinc-400 text-sm">You're trying to pay with the same wallet that receives payments for this store.</p>
              </>
            ) : error === 'WALLET_NOT_READY' ? (
              <>
                <p className="text-red-400 font-medium mb-2">Wallet not ready for payments</p>
                <p className="text-zinc-400 text-sm mb-3">Your wallet needs to be set up to send RLUSD payments.</p>
                <a href="/affiliate-dashboard"
                  className="inline-flex items-center gap-2 bg-amber-500 hover:bg-amber-400 text-black font-semibold px-4 py-2 rounded-lg transition"
                >
                  Set Up Wallet
                </a>
              </>
            ) : (
              <p className="text-red-400">{error}</p>
            )}
          </div>
        )}

        {/* Processing overlay */}
        {processing && (
          <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-xl">Processing payment...</p>
            </div>
          </div>
        )}

        {/* Payment Options */}
{!xamanQR ? (
  <>
    {/* Already Paid Message */}
    {payment && payment.status !== 'pending' && !allPaid && (
      <div className="bg-emerald-500/20 border border-emerald-500/50 rounded-2xl p-6 text-center mb-4">
        <div className="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 className="text-xl font-bold text-emerald-400 mb-2">Payment Already Complete</h3>
        <p className="text-zinc-400">This payment has already been processed.</p>
      </div>
    )}

    {/* Instant Pay with Web3Auth/Biometrics - Only show if pending */}
    {payment?.status === 'pending' && (
      <div className="mb-4">
        <TipSelector 
          amount={currentAmount}
          onTipChange={setTipAmount} 
        />
        <InstantPay
  amount={currentAmount + tipAmount}
  rlusdAmount={rlusdAmount || currentAmount * 1.35}
  vendorWallet={payment?.vendor_wallet || ''}
  storeName={payment?.store_name || ''}
  storeId={payment?.store_id || ''}
  paymentId={getCurrentPaymentId()}
  tipAmount={tipAmount}
  onSuccess={(txHash, receiptId) => {
            console.log('DEBUG onSuccess:', { txHash, receiptId });
            // Play success ding
            const ding = new Audio('/ding.mp3');
            ding.volume = 0.4;
            ding.play().catch(() => {});
            setTxHash(txHash);
            if (receiptId) setReceiptId(receiptId);
            setShowToast(true);
            setTimeout(() => setShowToast(false), 3000);
            
            if (splits && currentSplitIndex < splits.length - 1) {
              setCurrentSplitIndex(prev => prev + 1);
            } else {
              setAllPaid(true);
            }
          }}
          onError={(error) => setError(error)}
        />
      </div>
    )}

    {/* NFC Tap Zone - Only show if pending */}
{payment?.status === 'pending' && nfcSupported && (
<button
onClick={startNFCScan}
                disabled={nfcScanning || processing}
                className="w-full mb-4"
              >
                <div className={`bg-zinc-900 rounded-2xl p-8 border-2 transition ${
                  nfcScanning ? 'border-emerald-500' : 'border-zinc-800 hover:border-zinc-700'
                }`}>
                  <div className="flex flex-col items-center">
                    <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${
                      nfcScanning ? 'bg-emerald-500/20 animate-pulse' : 'bg-zinc-800'
                    }`}>
                      <svg className={`w-10 h-10 ${nfcScanning ? 'text-emerald-400' : 'text-zinc-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                      </svg>
                    </div>
                    <p className="text-lg font-semibold mb-1">
                      {nfcScanning ? 'Tap your card now...' : 'Tap to Pay'}
                    </p>
                    <p className="text-zinc-500 text-sm">Hold your NFC card to your phone</p>
                  </div>
                </div>
              </button>
            )}

            {/* Sound Payment Listen */}
            {console.log('DEBUG splits:', splits, 'currentSplitIndex:', currentSplitIndex, 'payment_id:', splits?.[currentSplitIndex]?.payment_id)}
{(payment?.status === 'pending' || splits?.[currentSplitIndex]) && (
              <div className="mb-4">
                <SoundPay
  paymentId={splits?.[currentSplitIndex]?.payment_id || paymentId}
  amount={(splits?.[currentSplitIndex]?.amount || payment?.amount || 0) + tipAmount}
  storeName={payment?.store_name || ''}
  tipAmount={tipAmount}
                  onError={(err) => setError(err)}
                  onSuccess={(txHash) => { 
  const ding = new Audio("/ding.mp3"); 
  ding.volume = 0.4; 
  ding.play().catch(() => {}); 
  setTxHash(txHash); 
  setShowToast(true); 
  setTimeout(() => setShowToast(false), 3000); 
  
  // Fetch receipt_id after payment
  const pId = splits?.[currentSplitIndex]?.payment_id || paymentId;
  fetch(`${API_URL}/payment-link/${pId}`)
    .then(res => res.json())
    .then(data => {
      if (data.success && data.payment?.receipt_id) {
        setReceiptId(data.payment.receipt_id);
      }
    });
  
  if (splits && splits.length > 0) { 
    const updatedSplits = [...splits]; 
    updatedSplits[currentSplitIndex] = { ...updatedSplits[currentSplitIndex], status: 'paid' }; 
    setSplits(updatedSplits); 
    const nextUnpaid = updatedSplits.findIndex((s, i) => i > currentSplitIndex && s.status !== 'paid'); 
    if (nextUnpaid !== -1) { 
      setCurrentSplitIndex(nextUnpaid); 
    } else { 
      setAllPaid(true); 
    } 
  } else { 
    setAllPaid(true); 
  } 
}}
                />
              </div>
            )}

            {payment?.status === 'pending' && (
  <>
    <div className="text-center text-zinc-500 my-4">or</div>
    {/* Xaman button */}
    <button 
      onClick={generateXamanQR}
      className="w-full bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 rounded-2xl p-5 flex items-center justify-center gap-3 transition mb-6"
    >
      <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded-lg" />
      <span className="font-medium">Pay with Xaman</span>
    </button>
  </>
)}

            {/* Split bill button (only if not already split) */}
{!payment?.split_index && !splits && payment?.status === 'pending' && (
  <button
    onClick={() => setShowSplitModal(true)}
                className="w-full bg-zinc-800 hover:bg-zinc-700 rounded-xl py-4 font-medium transition mb-6"
              >
                Split Bill
              </button>
            )}

            {/* Share links for other splits */}
            {splits && splits.length > 1 && (
              <div className="border-t border-zinc-800 pt-6">
                <p className="text-zinc-400 text-sm mb-3">Share with friends:</p>
                <div className="space-y-3">
                  {splits.filter((_, idx) => idx > currentSplitIndex).map((split) => (
                    <div 
                      key={split.payment_id}
                      className="bg-zinc-900 rounded-xl p-4 border border-zinc-800"
                    >
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <span className="text-zinc-400 text-sm">Person {split.split_index}</span>
                          <p className="text-xl font-bold text-emerald-400">¬£{split.amount.toFixed(2)}</p>
                        </div>
                        <button
                          onClick={() => setShowSplitQR(split.payment_id)}
                          className="bg-zinc-800 hover:bg-zinc-700 p-2 rounded-lg transition"
                          title="Show QR"
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                          </svg>
                        </button>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={async () => {
                            await navigator.clipboard.writeText(`https://yesallofus.com/pay/${split.payment_id}`);
                            setCopiedSplitId(split.payment_id);
                            setTimeout(() => setCopiedSplitId(null), 2000);
                          }}
                          className={`flex-1 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 ${
                            copiedSplitId === split.payment_id 
                              ? 'bg-emerald-500 text-black' 
                              : 'bg-zinc-800 hover:bg-zinc-700'
                          }`}
                        >
                          {copiedSplitId === split.payment_id ? (
                            <>
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                              </svg>
                              Copied!
                            </>
                          ) : (
                            <>
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                              Copy
                            </>
                          )}
                        </button>
                        <button
                          onClick={() => {
                            setSplitEmailTarget(split);
                            setShowSplitEmailModal(true);
                          }}
                          className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                          </svg>
                          Email
                        </button>
                        <button
                          onClick={() => shareLink(`https://yesallofus.com/pay/${split.payment_id}`, split.split_index, split.amount)}
                          className="bg-zinc-800 hover:bg-zinc-700 py-2 px-3 rounded-lg text-sm font-medium transition"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </>
        ) : (
          /* QR Code View */
          <div className="text-center">
            <div className="bg-white rounded-3xl p-6 mb-6 inline-block">
              <img 
                src={xamanQR} 
                alt="Scan with Xaman" 
                className="w-56 h-56"
              />
            </div>
            <p className="text-xl font-semibold text-sky-400 mb-2">Scan with Xaman</p>
            <p className="text-zinc-500 mb-6">Open Xaman wallet and scan the QR code</p>
            
            <button
              onClick={() => {
                setXamanQR(null);
                setXamanPaymentId(null);
              }}
              className="bg-zinc-800 hover:bg-zinc-700 px-8 py-3 rounded-xl font-medium transition"
            >
              Cancel
            </button>
          </div>
        )}

        {/* Footer */}
        <div className="mt-10 pt-6 border-t border-zinc-800 flex flex-col items-center gap-1">
          <span className="text-zinc-500 text-[10px] font-medium tracking-wider">COMPLETE PAYMENT</span>
          <span className="text-base font-extrabold tracking-widest">
            <span className="text-emerald-500">Y</span>
            <span className="text-green-500">A</span>
            <span className="text-blue-500">O</span>
            <span className="text-indigo-500">F</span>
            <span className="text-violet-500">U</span>
            <span className="text-purple-500">S</span>
          </span>
          <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">INSTANT</span>
          <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
            <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
            <span>Powered by YesAllOfUs</span>
          </div>
        </div>

      {/* Split Bill Modal */}
      {showSplitModal && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
          <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm">
            <h2 className="text-xl font-bold mb-6">Split Bill</h2>
            
            <p className="text-zinc-400 mb-4">How many people?</p>
            
            <div className="flex items-center justify-center gap-6 mb-6">
              <button
                onClick={() => setSplitCount(Math.max(2, splitCount - 1))}
                className="w-14 h-14 rounded-full bg-zinc-800 hover:bg-zinc-700 text-2xl font-bold transition"
              >
                ‚àí
              </button>
              <span className="text-5xl font-bold w-20 text-center">{splitCount}</span>
              <button
                onClick={() => setSplitCount(Math.min(100, splitCount + 1))}
                className="w-14 h-14 rounded-full bg-zinc-800 hover:bg-zinc-700 text-2xl font-bold transition"
              >
                +
              </button>
            </div>

            <div className="bg-zinc-800 rounded-xl p-4 mb-6">
              <div className="flex justify-between text-zinc-400 mb-2">
                <span>Total</span>
                <span>¬£{payment?.amount.toFixed(2)}</span>
              </div>
              <div className="flex justify-between font-bold text-lg">
                <span>Each pays</span>
                <span className="text-emerald-400">
                  ¬£{((payment?.amount || 0) / splitCount).toFixed(2)}
                </span>
              </div>
            </div>

            <div className="flex gap-3">
              <button
                onClick={() => setShowSplitModal(false)}
                className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-4 rounded-xl font-medium transition"
              >
                Cancel
              </button>
              <button
                onClick={handleSplitBill}
                disabled={splitting}
                className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black py-4 rounded-xl font-bold transition disabled:opacity-50"
              >
                {splitting ? 'Splitting...' : 'Split'}
              </button>
            </div>
          </div>
        </div>
      )}
      {/* Split QR Modal */}
      {showSplitQR && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm text-center">
            <h3 className="text-lg font-bold mb-4">Scan to Pay</h3>
            <div className="bg-white rounded-2xl p-4 mb-4 inline-block">
              <QRCodeSVG 
                value={`https://yesallofus.com/pay/${showSplitQR}`}
                size={200}
                level="M"
              />
            </div>
            <p className="text-zinc-400 text-sm mb-4">
              {splits?.find(s => s.payment_id === showSplitQR)?.amount && 
                `¬£${splits.find(s => s.payment_id === showSplitQR)!.amount.toFixed(2)}`
              }
            </p>
            <button
              onClick={() => setShowSplitQR(null)}
              className="bg-zinc-800 hover:bg-zinc-700 px-6 py-3 rounded-xl font-medium transition"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Split Email Modal */}
      {showSplitEmailModal && splitEmailTarget && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-sm">
            <h3 className="text-lg font-bold mb-2">Send Payment Link</h3>
            <p className="text-zinc-400 text-sm mb-4">
              Person {splitEmailTarget.split_index} ¬∑ ¬£{splitEmailTarget.amount.toFixed(2)}
            </p>
            <input
              type="email"
              placeholder="friend@email.com"
              value={splitEmailAddress}
              onChange={(e) => setSplitEmailAddress(e.target.value)}
              className="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500 mb-4"
              autoFocus
            />
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setShowSplitEmailModal(false);
                  setSplitEmailAddress('');
                  setSplitEmailTarget(null);
                }}
                className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-3 rounded-xl transition"
              >
                Cancel
              </button>
              <button
                onClick={async () => {
                  if (!splitEmailAddress || !splitEmailAddress.includes('@')) return;
                  setSendingSplitEmail(true);
                  try {
                    await fetch(`${API_URL}/payment-link/send-email`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        email: splitEmailAddress,
                        payment_url: `https://yesallofus.com/pay/${splitEmailTarget.payment_id}`,
                        store_name: payment?.store_name,
                        amount: splitEmailTarget.amount,
                        tip: splitEmailTarget.tip 
                      })
                    });
                    setShowSplitEmailModal(false);
                    setSplitEmailAddress('');
                    setSplitEmailTarget(null);
                  } catch (err) {
                    console.error('Failed to send email');
                  }
                  setSendingSplitEmail(false);
                }}
                disabled={sendingSplitEmail}
                className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-3 rounded-xl transition disabled:opacity-50"
              >
                {sendingSplitEmail ? 'Sending...' : 'Send'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Sound Payment Confirmation Modal */}
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/pos-privacy/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React from 'react';


// MARK: - Component Definition
export default function POSPrivacy() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">
      <main className="max-w-3xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-10">
          <h1 className="text-3xl font-bold text-slate-900 mb-3">Payment Privacy Notice</h1>
          <p className="text-slate-600 text-sm">Last updated: 17 January 2026</p>
        </div>

        {/* Plain English Summary */}
        <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-5 mb-10">
          <h2 className="font-semibold text-emerald-900 mb-2">Privacy at a Glance</h2>
          <ul className="text-emerald-800 text-sm space-y-1.5">
            <li>‚Ä¢ We collect <strong>minimal data</strong> ‚Äî only what&apos;s needed to process your payment</li>
            <li>‚Ä¢ We <strong>never sell your data</strong> to anyone</li>
            <li>‚Ä¢ Blockchain transactions are <strong>public</strong> ‚Äî wallet addresses and amounts are visible</li>
            <li>‚Ä¢ We recommend <strong>not storing large amounts</strong> in your payment wallet</li>
            <li>‚Ä¢ You can request <strong>deletion</strong> of your account data (blockchain records are permanent)</li>
          </ul>
        </div>

        {/* Content */}
        <div className="prose prose-slate prose-sm max-w-none">

          {/* 1. Who We Are */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">1. Who We Are</h2>
            <p className="text-slate-700">
              YesAllofUs is a payment technology provider operated by Mark Flynn, based in Guernsey, Channel Islands. We are the data controller for personal data processed through our checkout service.
            </p>
          </section>

          {/* 2. Data We Collect */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">2. Data We Collect</h2>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-4 mb-2">When you pay through our checkout:</h3>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Data</th>
                  <th className="px-4 py-2 text-left text-slate-700">Why We Need It</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">Wallet address</td>
                  <td className="px-4 py-2">To process your payment and send receipts</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Email address</td>
                  <td className="px-4 py-2">To send transaction receipts (if provided)</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Name</td>
                  <td className="px-4 py-2">To personalise your account (if provided)</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Transaction details</td>
                  <td className="px-4 py-2">Order amounts, items, timestamps</td>
                </tr>
              </tbody>
            </table>

            <h3 className="text-lg font-semibold text-slate-800 mt-4 mb-2">We do NOT collect:</h3>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li>Private keys or wallet seeds</li>
              <li>Bank account details</li>
              <li>Government ID or passport numbers</li>
              <li>Physical address (unless shipping is required by vendor)</li>
            </ul>
          </section>

          {/* 3. Blockchain Transparency */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">3. Blockchain Transparency</h2>
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-3">
              <p className="text-amber-800 text-sm">
                <strong>Important:</strong> The XRP Ledger is a public blockchain. Transaction data is permanent and visible to anyone.
              </p>
            </div>
            
            <h3 className="text-lg font-semibold text-slate-800 mt-4 mb-2">What&apos;s publicly visible on the blockchain:</h3>
            <ul className="list-disc pl-5 text-slate-700 space-y-1 mb-3">
              <li>Your wallet address</li>
              <li>Transaction amounts</li>
              <li>Transaction timestamps</li>
              <li>Recipient wallet addresses</li>
            </ul>

            <h3 className="text-lg font-semibold text-slate-800 mt-4 mb-2">What&apos;s NOT on the blockchain:</h3>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li>Your name or email</li>
              <li>What you purchased</li>
              <li>Your identity</li>
            </ul>
            <p className="text-slate-700 mt-3">
              Wallet addresses are pseudonymous ‚Äî they don&apos;t reveal your identity unless you publicly link them to yourself.
            </p>
          </section>

          {/* 4. How We Use Your Data */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">4. How We Use Your Data</h2>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li><strong>Process payments</strong> ‚Äî execute transactions on the XRP Ledger</li>
              <li><strong>Send receipts</strong> ‚Äî email confirmations of your purchases</li>
              <li><strong>Manage your account</strong> ‚Äî affiliate programme, wallet connections</li>
              <li><strong>Prevent fraud</strong> ‚Äî monitor for suspicious activity</li>
              <li><strong>Comply with law</strong> ‚Äî respond to legal requirements</li>
            </ul>
          </section>

          {/* 5. Who We Share Data With */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">5. Who We Share Data With</h2>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Recipient</th>
                  <th className="px-4 py-2 text-left text-slate-700">What Data</th>
                  <th className="px-4 py-2 text-left text-slate-700">Why</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">XRP Ledger</td>
                  <td className="px-4 py-2">Wallet addresses, amounts</td>
                  <td className="px-4 py-2">Payment processing</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Vendors</td>
                  <td className="px-4 py-2">Your wallet, order details</td>
                  <td className="px-4 py-2">Order fulfilment</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Firebase (Google)</td>
                  <td className="px-4 py-2">Account data</td>
                  <td className="px-4 py-2">Database hosting</td>
                </tr>
              </tbody>
            </table>
            
            <p className="text-slate-700 font-medium">We never sell your data to third parties.</p>
          </section>

          {/* 6. Data Retention */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">6. How Long We Keep Your Data</h2>
            <table className="w-full text-sm border border-slate-200 rounded-lg overflow-hidden mb-4">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-4 py-2 text-left text-slate-700">Data Type</th>
                  <th className="px-4 py-2 text-left text-slate-700">Retention</th>
                </tr>
              </thead>
              <tbody className="text-slate-600">
                <tr className="border-t">
                  <td className="px-4 py-2">Account data</td>
                  <td className="px-4 py-2">Until you request deletion</td>
                </tr>
                <tr className="border-t bg-slate-50">
                  <td className="px-4 py-2">Transaction records</td>
                  <td className="px-4 py-2">7 years (legal requirement)</td>
                </tr>
                <tr className="border-t">
                  <td className="px-4 py-2">Blockchain data</td>
                  <td className="px-4 py-2">Permanent (cannot be deleted)</td>
                </tr>
              </tbody>
            </table>
          </section>

          {/* 7. Your Rights */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">7. Your Rights</h2>
            <p className="text-slate-700 mb-3">You have the right to:</p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li><strong>Access</strong> ‚Äî request a copy of your data</li>
              <li><strong>Correct</strong> ‚Äî fix inaccurate information</li>
              <li><strong>Delete</strong> ‚Äî request removal of your account data</li>
              <li><strong>Export</strong> ‚Äî receive your data in a portable format</li>
            </ul>
            <p className="text-slate-700 mt-3">
              Note: We cannot delete blockchain records ‚Äî they are permanent by design.
            </p>
            <p className="text-slate-700 mt-3">
              To exercise these rights, email <a href="mailto:mark@yesallofus.com" className="text-blue-600 hover:underline">mark@yesallofus.com</a>.
            </p>
          </section>

          {/* 8. Security */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">8. Security</h2>
            <p className="text-slate-700 mb-3">We protect your data with:</p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li>Encryption in transit (TLS 1.2+)</li>
              <li>Encryption at rest (AES-256)</li>
              <li>Access controls and monitoring</li>
            </ul>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
              <p className="text-blue-800 text-sm">
                <strong>Your responsibility:</strong> Keep your wallet credentials secure. We recommend not storing large amounts in your payment wallet ‚Äî transfer only what you need.
              </p>
            </div>
          </section>

          {/* 9. Cookies */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">9. Cookies</h2>
            <p className="text-slate-700">
              We use only essential cookies required for the checkout to function. We do not use tracking, advertising, or analytics cookies.
            </p>
          </section>

          {/* 10. Contact */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">10. Contact</h2>
            <p className="text-slate-700 mb-3">For privacy questions:</p>
            <div className="bg-slate-50 rounded-lg p-4">
              <p className="text-slate-700"><strong>YesAllofUs</strong></p>
              <p className="text-slate-700">Guernsey, Channel Islands</p>
              <p className="text-slate-700 mt-2">
                <strong>Email:</strong> <a href="mailto:mark@yesallofus.com" className="text-blue-600 hover:underline">mark@yesallofus.com</a>
              </p>
            </div>
          </section>

          {/* 11. Full Privacy Policy */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">11. Full Privacy Policy</h2>
            <p className="text-slate-700">
              This is a summary for checkout users. For the complete privacy policy covering all YesAllofUs services, see our <a href="/privacy" className="text-blue-600 hover:underline">full Privacy Policy</a>.
            </p>
          </section>

        </div>

        {/* Acceptance */}
        <div className="border-t border-slate-200 pt-6 mt-10">
          <p className="text-slate-600 text-sm">
            By using YesAllofUs checkout, you acknowledge this privacy notice.
          </p>
        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/pos-terms/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import React from 'react';


// MARK: - Component Definition
export default function POSTerms() {

// MARK: - Main Render
  return (
    <div className="min-h-screen bg-white">
      <main className="max-w-3xl mx-auto px-6 py-12">
        {/* Title */}
        <div className="mb-10">
          <h1 className="text-3xl font-bold text-slate-900 mb-3">Payment Terms</h1>
          <p className="text-slate-600 text-sm">Last updated: 17 January 2026</p>
        </div>

        {/* Plain English Summary */}
        <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-5 mb-10">
          <h2 className="font-semibold text-emerald-900 mb-2">Quick Summary</h2>
          <ul className="text-emerald-800 text-sm space-y-1.5">
            <li>‚Ä¢ You&apos;re paying with <strong>RLUSD stablecoin</strong> on the XRP Ledger</li>
            <li>‚Ä¢ Payments are <strong>instant and final</strong> ‚Äî they cannot be reversed</li>
            <li>‚Ä¢ For refunds or product issues, <strong>contact the vendor directly</strong></li>
            <li>‚Ä¢ This service is currently available to <strong>Guernsey residents only</strong> as part of a pilot</li>
            <li>‚Ä¢ Transactions under ¬£100 do not require additional verification</li>
          </ul>
        </div>

        {/* Content */}
        <div className="prose prose-slate prose-sm max-w-none">

          {/* 1. About This Service */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">1. About This Service</h2>
            <p className="text-slate-700 mb-3">
              YesAllofUs provides payment processing technology that enables you to pay vendors using RLUSD (Ripple USD stablecoin) on the XRP Ledger. When you complete a payment through our checkout, you are:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1 mb-3">
              <li>Sending RLUSD directly from your wallet to the vendor&apos;s wallet</li>
              <li>Joining the vendor&apos;s affiliate program (if applicable)</li>
              <li>Agreeing to these payment terms</li>
            </ul>
            <p className="text-slate-700">
              YesAllofUs is operated by Mark Flynn, based in Guernsey, Channel Islands.
            </p>
          </section>

          {/* 2. Payment Finality */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">2. Payment Finality</h2>
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-3">
              <p className="text-amber-800 text-sm font-medium">
                ‚ö†Ô∏è All payments are final and irreversible once confirmed on the XRP Ledger.
              </p>
            </div>
            <p className="text-slate-700 mb-3">
              Unlike card payments, blockchain transactions cannot be reversed, cancelled, or charged back. Once you approve a payment:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li>The transaction is recorded permanently on the public XRP Ledger</li>
              <li>YesAllofUs cannot reverse or modify the transaction</li>
              <li>The vendor receives payment within seconds</li>
            </ul>
          </section>

          {/* 3. Refunds and Disputes */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">3. Refunds and Disputes</h2>
            <p className="text-slate-700 mb-3">
              <strong>YesAllofUs is a payment processor, not the seller.</strong> For any issues with:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1 mb-3">
              <li>Product quality or defects</li>
              <li>Non-delivery or shipping issues</li>
              <li>Refund requests</li>
              <li>Order cancellations</li>
            </ul>
            <p className="text-slate-700">
              <strong>Contact the vendor directly.</strong> The vendor is solely responsible for their products, services, and refund policies. If a vendor agrees to a refund, they will send RLUSD back to your wallet as a separate transaction.
            </p>
          </section>

          {/* 4. Currency and Conversion */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">4. Currency and Conversion</h2>
            <p className="text-slate-700 mb-3">
              Prices are displayed in GBP (¬£) and converted to RLUSD at checkout using live exchange rates from CoinGecko Pro (aggregating 600+ exchanges).
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li>We aim for less than 0.1% variance between the quoted and settled amount</li>
              <li>The final RLUSD amount is locked when you approve the transaction</li>
              <li>RLUSD is a stablecoin pegged to the US Dollar, issued by Ripple</li>
              <li>YesAllofUs does not guarantee the value or stability of RLUSD</li>
            </ul>
          </section>

          {/* 5. Eligibility */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">5. Eligibility</h2>
            <p className="text-slate-700 mb-3">
              This payment service is currently available as a pilot programme:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li><strong>Geographic restriction:</strong> Available to Guernsey residents only</li>
              <li><strong>Age requirement:</strong> You must be at least 18 years old</li>
              <li><strong>Transaction limit:</strong> Individual transactions under ¬£100 do not require additional verification</li>
            </ul>
          </section>

          {/* 6. Your Wallet */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">6. Your Wallet</h2>
            <p className="text-slate-700 mb-3">
              When you pay through YesAllofUs checkout, you connect a cryptocurrency wallet. You are responsible for:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1 mb-3">
              <li>Maintaining sufficient RLUSD balance to complete payments</li>
              <li>Keeping your wallet credentials secure</li>
              <li>Ensuring your wallet has an active RLUSD trustline</li>
            </ul>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <p className="text-blue-800 text-sm">
                <strong>Security tip:</strong> Do not store large amounts in your payment wallet. Transfer only what you need for purchases.
              </p>
            </div>
          </section>

          {/* 7. What We're Not Responsible For */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">7. What We&apos;re Not Responsible For</h2>
            <p className="text-slate-700 mb-3">
              YesAllofUs is not liable for:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li>The quality, safety, or legality of products or services sold by vendors</li>
              <li>Vendor delivery, shipping, or fulfilment</li>
              <li>Vendor refund policies or disputes</li>
              <li>Loss of wallet access or credentials</li>
              <li>XRP Ledger network issues or delays</li>
              <li>Fluctuations in cryptocurrency values</li>
              <li>Payments sent to incorrect wallet addresses</li>
            </ul>
          </section>

          {/* 8. Data We Collect */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">8. Data We Collect</h2>
            <p className="text-slate-700 mb-3">
              When you complete a payment, we collect and store:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1 mb-3">
              <li><strong>Wallet address</strong> ‚Äî your public XRP Ledger address</li>
              <li><strong>Email address</strong> ‚Äî if you provide it for receipts</li>
              <li><strong>Name</strong> ‚Äî if you provide it during signup</li>
              <li><strong>Transaction details</strong> ‚Äî amounts, timestamps, vendor information</li>
            </ul>
            <p className="text-slate-700 mb-3">
              All transactions are recorded on the public XRP Ledger. Wallet addresses and transaction amounts are publicly visible on the blockchain.
            </p>
            <p className="text-slate-700">
              See our full <a href="/privacy" className="text-blue-600 hover:underline">Privacy Policy</a> for details.
            </p>
          </section>

          {/* 9. Affiliate Programme */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">9. Affiliate Programme</h2>
            <p className="text-slate-700 mb-3">
              When you sign up to pay a vendor, you may automatically join their affiliate programme. This means:
            </p>
            <ul className="list-disc pl-5 text-slate-700 space-y-1">
              <li>You may earn commission by referring others to that vendor</li>
              <li>Commission rates are set by each vendor</li>
              <li>Commissions are paid in RLUSD to your wallet</li>
              <li>You are responsible for any tax obligations on earnings</li>
            </ul>
          </section>

          {/* 10. Changes to Terms */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">10. Changes to These Terms</h2>
            <p className="text-slate-700">
              We may update these terms from time to time. Continued use of the payment service after changes are posted constitutes acceptance of the updated terms.
            </p>
          </section>

          {/* 11. Contact */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">11. Contact</h2>
            <p className="text-slate-700 mb-3">
              For questions about these payment terms:
            </p>
            <div className="bg-slate-50 rounded-lg p-4">
              <p className="text-slate-700"><strong>YesAllofUs</strong></p>
              <p className="text-slate-700">Guernsey, Channel Islands</p>
              <p className="text-slate-700 mt-2">
                <strong>Email:</strong> <a href="mailto:mark@yesallofus.com" className="text-blue-600 hover:underline">mark@yesallofus.com</a>
              </p>
            </div>
          </section>

          {/* 12. Governing Law */}
          <section className="mb-8">
            <h2 className="text-xl font-bold text-slate-900 mb-3">12. Governing Law</h2>
            <p className="text-slate-700">
              These terms are governed by the laws of Guernsey, Channel Islands.
            </p>
          </section>

        </div>

        {/* Acceptance */}
        <div className="border-t border-slate-200 pt-6 mt-10">
          <p className="text-slate-600 text-sm">
            By completing a payment through YesAllofUs checkout, you acknowledge that you have read, understood, and agree to these Payment Terms.
          </p>
        </div>
      </main>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/problem-opportunity/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useRouter } from 'next/navigation';
import { useState } from 'react';
import Image from 'next/image';


// MARK: - Component Definition
export default function ProblemOpportunityPage() {
  const router = useRouter();

// MARK: - State Management
  const [showLeftArrow, setShowLeftArrow] = useState(false);
  const [showRightArrow, setShowRightArrow] = useState(false);


// MARK: - Main Render
  return (
    <div className="min-h-screen h-screen relative overflow-hidden">
      
      {/* Gradient border frame */}
      <div className="absolute inset-0 z-20 pointer-events-none">
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 left-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 right-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
      </div>
      
      {/* Background */}
      <div 
        className="absolute inset-0 w-full h-full bg-cover bg-center bg-no-repeat"
        style={{ backgroundImage: "url('/background.jpg')" }}
      />

      {/* Navigation - Left Arrow */}
      <div 
        className="absolute left-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer"

// MARK: - Event Handlers
        onMouseEnter={() => setShowLeftArrow(true)}
        onMouseLeave={() => setShowLeftArrow(false)}
        onClick={() => router.push('/cover')}
      >
        <svg 
          className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showLeftArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
      </div>

      {/* Navigation - Right Arrow */}
      <div 
        className="absolute right-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer"
        onMouseEnter={() => setShowRightArrow(true)}
        onMouseLeave={() => setShowRightArrow(false)}
        onClick={() => router.push('/solution')}
      >
        <svg 
          className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showRightArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </div>

      {/* Pre-payment image top right - hidden on mobile */}
      <div className="hidden md:block absolute top-4 right-8 z-10 w-56 md:w-72">
        <Image 
          src="/pre-payment.jpg" 
          alt="NFC tap-to-pay demo"
          width={936}
          height={508}
          className="rounded-2xl shadow-2xl"
        />
      </div>

      {/* Main Content - Scrollable */}
      <div className="absolute top-4 md:top-32 bottom-4 md:bottom-8 left-4 md:left-8 right-4 md:right-8 z-10 flex flex-col md:flex-row gap-3 md:gap-8 overflow-y-auto md:overflow-visible">
        
        {/* Left Column - Problems */}
        <div className="md:flex-1 flex flex-col gap-2 md:gap-4">
          <h2 className="text-red-400 text-base md:text-xl font-semibold">The Problems We Solve</h2>
          
          {/* Problem Card 1 */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="flex items-center gap-2 mb-2 md:mb-3">
              <svg className="w-4 h-4 md:w-5 md:h-5 text-red-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p className="text-white text-xs md:text-base font-semibold">Merchants Bleeding on Fees</p>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-6 md:pl-7">
              <p>‚Ä¢ Card processors take 2-3% every transaction</p>
              <p>‚Ä¢ Small businesses lose ¬£10k-50k/year</p>
              <p>‚Ä¢ Chargebacks cost time + money</p>
            </div>
          </div>

          {/* Problem Card 2 */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="flex items-center gap-2 mb-2 md:mb-3">
              <svg className="w-4 h-4 md:w-5 md:h-5 text-red-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
              <p className="text-white text-xs md:text-base font-semibold">Small Merchants Locked Out</p>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-6 md:pl-7">
              <p>‚Ä¢ 25M+ stores earn under ¬£1k/year</p>
              <p>‚Ä¢ Affiliate platforms charge ¬£50-500/month</p>
              <p>‚Ä¢ Net-30/60 payouts exclude small brands</p>
            </div>
          </div>

          {/* Problem Card 3 */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="flex items-center gap-2 mb-2 md:mb-3">
              <svg className="w-4 h-4 md:w-5 md:h-5 text-red-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <p className="text-white text-xs md:text-base font-semibold">Wealth Creation Gated</p>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-6 md:pl-7">
              <p>‚Ä¢ Tokenised assets only for institutions</p>
              <p>‚Ä¢ Retail excluded from yield</p>
              <p>‚Ä¢ High minimums in traditional finance</p>
            </div>
          </div>

          {/* Video - Hidden on mobile */}
          <div className="hidden md:block mt-auto">
            <video 
              autoPlay 
              loop 
              muted 
              playsInline
              className="w-24 h-auto rounded-lg opacity-80"
            >
              <source src="/guernsey-flag.webm" type="video/webm" />
            </video>
          </div>
        </div>

        {/* Right Column - Opportunity */}
        <div className="md:flex-1 flex flex-col gap-2 md:gap-4">
          <h2 className="text-emerald-400 text-base md:text-xl font-semibold">The YesAllOfUs Opportunity</h2>
          
          {/* Opportunity Card 1 */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="flex items-center gap-2 mb-2 md:mb-3">
              <svg className="w-4 h-4 md:w-5 md:h-5 text-emerald-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
              <p className="text-white text-xs md:text-base font-semibold">First-Mover Moat</p>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-6 md:pl-7">
              <p>‚Ä¢ First POS, no wallet/crypto knowledge</p>
              <p>‚Ä¢ GFSC pathway (Q1 2026)</p>
              <p>‚Ä¢ Globally exportable with XRPL Commons</p>
            </div>
          </div>

          {/* Opportunity Card 2 */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="flex items-center gap-2 mb-2 md:mb-3">
              <svg className="w-4 h-4 md:w-5 md:h-5 text-emerald-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              <p className="text-white text-xs md:text-base font-semibold">Unlocking the Long-Tail</p>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-6 md:pl-7">
              <p>‚Ä¢ First 5-deep instant commission on XRPL</p>
              <p>‚Ä¢ Zero subscription ‚Äî pay on success</p>
              <p>‚Ä¢ Opens to 25M+ underserved stores</p>
            </div>
          </div>

          {/* Opportunity Card 3 */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="flex items-center gap-2 mb-2 md:mb-3">
              <svg className="w-4 h-4 md:w-5 md:h-5 text-emerald-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <p className="text-white text-xs md:text-base font-semibold">Viral Growth Engine</p>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-6 md:pl-7">
              <p>‚Ä¢ 5-level affiliate automation</p>
              <p>‚Ä¢ Every customer = promoter</p>
              <p>‚Ä¢ Network effects drive adoption</p>
            </div>
          </div>

          {/* Opportunity Card 4 */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="flex items-center gap-2 mb-2 md:mb-3">
              <svg className="w-4 h-4 md:w-5 md:h-5 text-emerald-400 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p className="text-white text-xs md:text-base font-semibold">Superior Economics</p>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-6 md:pl-7">
              <p>‚Ä¢ XRPL: 3-5 seconds, &lt;¬£0.01 fees</p>
              <p>‚Ä¢ 99.5% cheaper than cards</p>
              <p>‚Ä¢ Everyone profits</p>
            </div>
          </div>
        </div>

      </div>

    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/sitemap.ts
// =================================================
// MARK: - Imports & Dependencies
import { MetadataRoute } from 'next'


// MARK: - Component Definition
export default function sitemap(): MetadataRoute.Sitemap {
  return [
    {
      url: 'https://yesallofus.com',
      lastModified: new Date(),
      changeFrequency: 'weekly',
      priority: 1,
    },
    {
      url: 'https://yesallofus.com/docs',
      lastModified: new Date(),
      changeFrequency: 'weekly',
      priority: 0.9,
    },
    {
      url: 'https://yesallofus.com/affiliate-dashboard',
      lastModified: new Date(),
      changeFrequency: 'weekly',
      priority: 0.8,
    },
    {
      url: 'https://yesallofus.com/guides/wordpress',
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 0.8,
    },
    {
      url: 'https://yesallofus.com/about',
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 0.5,
    },
    {
      url: 'https://yesallofus.com/faq',
      lastModified: new Date(),
      changeFrequency: 'monthly',
      priority: 0.6,
    },
    {
      url: 'https://yesallofus.com/terms',
      lastModified: new Date(),
      changeFrequency: 'yearly',
      priority: 0.3,
    },
    {
      url: 'https://yesallofus.com/privacy',
      lastModified: new Date(),
      changeFrequency: 'yearly',
      priority: 0.3,
    },
    {
      url: 'https://yesallofus.com/cookies',
      lastModified: new Date(),
      changeFrequency: 'yearly',
      priority: 0.3,
    },
    {
      url: 'https://yesallofus.com/acceptable-use',
      lastModified: new Date(),
      changeFrequency: 'yearly',
      priority: 0.3,
    },
    {
      url: 'https://yesallofus.com/announcements',
      lastModified: new Date(),
      changeFrequency: 'weekly',
      priority: 0.5,
    },
  ]
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/solution/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useRouter } from 'next/navigation';
import { useState, useRef } from 'react';
import Image from 'next/image';

const milestoneDetails = {
  q1: {
    title: "Q1 2026 ‚Äî Prove",
    color: "emerald",
    details: [
      { label: "GFSC Engagement", value: "Submit Innovation Sandbox application, attend consultation sessions" },
      { label: "Target Merchants", value: "5 Guernsey-based retailers (cafes, boutiques, service providers)" },
      { label: "XRPL Commons", value: "Begin 3-month residency in Paris, access to ¬£200k non-dilutive funding pool" },
      { label: "KPIs", value: "100+ transactions, <3s avg settlement, 99.9% uptime" },
      { label: "Risk Mitigation", value: "Manual KYC for pilot merchants, daily reconciliation checks" },
    ]
  },
  q2: {
    title: "Q2 2026 ‚Äî Scale Locally",
    color: "blue",
    details: [
      { label: "Merchant Target", value: "50 active merchants across Guernsey retail sector" },
      { label: "Volume Goal", value: "¬£50k+ monthly transaction volume processed" },
      { label: "Affiliate Launch", value: "5-deep commission structure live, first affiliate payouts within 30 seconds" },
      { label: "Compliance", value: "Full GFSC reporting integration, automated AML monitoring via Chainalysis" },
      { label: "Tech Milestone", value: "WordPress/WooCommerce plugin public release" },
    ]
  },
  q3: {
    title: "Q3 2026 ‚Äî Export Framework",
    color: "purple",
    details: [
      { label: "Merchant Scale", value: "100 merchants (pilot 'Excellent' target achieved)" },
      { label: "Expansion", value: "Jersey FSC and Isle of Man FSA licensing applications submitted" },
      { label: "RWA Integration", value: "Tokenised gold/commodity yield products accessible via wallet" },
      { label: "Partnerships", value: "2-3 strategic announcements (payment providers, e-commerce platforms)" },
      { label: "Revenue", value: "¬£5k+ monthly platform fees, break-even trajectory" },
    ]
  },
  q4: {
    title: "Q4 2026 ‚Äî Growth Phase",
    color: "pink",
    details: [
      { label: "Merchant Network", value: "500+ merchants across Channel Islands" },
      { label: "Monthly Volume", value: "¬£500k+ TPV, 10,000+ transactions/month" },
      { label: "Multi-Jurisdiction", value: "Live operations in Guernsey, Jersey, Isle of Man" },
      { label: "Funding", value: "Seed round discussions at ¬£1.2-2M valuation (partnership dependent)" },
      { label: "UK/EU Roadmap", value: "FCA sandbox application, EU MiCA compliance assessment" },
    ]
  }
};


// MARK: - Component Definition
export default function TractionRoadmapPage() {
  const router = useRouter();

// MARK: - State Management
  const [showLeftArrow, setShowLeftArrow] = useState(false);
  const [showRightArrow, setShowRightArrow] = useState(false);
  const [activeModal, setActiveModal] = useState<string | null>(null);
  const scrollRef = useRef<HTMLDivElement>(null);

  const scrollLeft = () => {
    if (scrollRef.current) {
      scrollRef.current.scrollBy({ left: -scrollRef.current.offsetWidth, behavior: 'smooth' });
    }
  };

  const scrollRight = () => {
    if (scrollRef.current) {
      scrollRef.current.scrollBy({ left: scrollRef.current.offsetWidth, behavior: 'smooth' });
    }
  };


// MARK: - Main Render
  return (
    <div className="min-h-screen h-screen relative overflow-hidden">
      
      {/* Gradient border frame */}
      <div className="absolute inset-0 z-20 pointer-events-none">
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 left-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 right-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
      </div>
      
      {/* Background */}
      <div 
        className="absolute inset-0 w-full h-full bg-cover bg-center bg-no-repeat"
        style={{ backgroundImage: "url('/background.jpg')" }}
      />

      {/* Navigation - Left Arrow */}
      <div 
        className="absolute left-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer"

// MARK: - Event Handlers
        onMouseEnter={() => setShowLeftArrow(true)}
        onMouseLeave={() => setShowLeftArrow(false)}
        onClick={() => router.push('/problem-opportunity')}
      >
        <svg 
          className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showLeftArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
      </div>

      {/* Navigation - Right Arrow */}
      <div 
        className="absolute right-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer"
        onMouseEnter={() => setShowRightArrow(true)}
        onMouseLeave={() => setShowRightArrow(false)}
        onClick={() => router.push('/team')}
      >
        <svg 
          className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showRightArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </div>

      {/* Title */}
      <div className="absolute top-4 md:top-10 left-0 right-0 text-center z-10 px-4">
        <h1 className="text-white text-2xl md:text-4xl lg:text-5xl font-bold tracking-tight" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>
          Traction &{' '}
          <span className="bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400 bg-clip-text text-transparent">Roadmap</span>
        </h1>
      </div>

      {/* Main Content - Scrollable on mobile */}
      <div className="absolute top-16 md:top-32 bottom-4 md:bottom-8 left-4 md:left-8 right-4 md:right-8 z-10 flex flex-col md:flex-row gap-4 md:gap-8 overflow-y-auto md:overflow-visible">
        
        {/* Left Column - Current Status & Images */}
        <div className="md:flex-1 flex flex-col gap-3 md:gap-4">
          <h2 className="text-emerald-400 text-base md:text-xl font-semibold">Current Status</h2>
          
          {/* Status Card */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <div className="space-y-2 md:space-y-3 text-zinc-300 text-xs md:text-sm">
              <div className="flex items-start gap-2">
                <span className="text-emerald-400 font-bold text-xs">Product:</span>
                <span className="text-xs">‚úì Live NFC tap-to-pay, 443 transactions</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="text-emerald-400 font-bold text-xs">Regulatory:</span>
                <span className="text-xs">‚úì GFSC pathway (Q1 2026)</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="text-emerald-400 font-bold text-xs">Ecosystem:</span>
                <span className="text-xs">‚úì XRPL Commons residency (April 2026)</span>
              </div>
              <div className="flex items-start gap-2">
                <span className="text-emerald-400 font-bold text-xs">Validation:</span>
                <span className="text-xs">‚úì First POS, no wallet/crypto knowledge needed</span>
              </div>
            </div>
          </div>

          {/* Photo Album - Two Images at a Time Swipe */}
          <div className="relative min-h-[200px] md:min-h-[300px] md:flex-1">
            {/* Scroll Left Button */}
            <button 
              onClick={(e) => { e.preventDefault(); e.stopPropagation(); scrollLeft(); }}
              onMouseDown={(e) => e.stopPropagation()}
              className="absolute left-8 md:left-12 top-1/2 -translate-y-1/2 z-30 bg-black/70 hover:bg-black/90 rounded-full p-2 md:p-3 transition-all shadow-lg"
            >
              <svg className="w-4 h-4 md:w-6 md:h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            
            {/* Scroll Right Button */}
            <button 
              onClick={(e) => { e.preventDefault(); e.stopPropagation(); scrollRight(); }}
              onMouseDown={(e) => e.stopPropagation()}
              className="absolute right-8 md:right-12 top-1/2 -translate-y-1/2 z-30 bg-black/70 hover:bg-black/90 rounded-full p-2 md:p-3 transition-all shadow-lg"
            >
              <svg className="w-4 h-4 md:w-6 md:h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </button>

            {/* Two-Image Swipe Container */}
            <div 
              ref={scrollRef}
              className="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide h-full"
              style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
            >
              {/* Page 1: Images 1 & 2 */}
              <div className="flex-shrink-0 w-full flex gap-2 md:gap-4 justify-center items-center snap-center px-8 md:px-12 py-2">
                <div className="w-1/2 max-w-[140px] md:max-w-[200px]">
                  <Image 
                    src="/Paying-2.jpg" 
                    alt="Pre-payment screen"
                    width={400}
                    height={700}
                    className="rounded-xl md:rounded-2xl shadow-2xl object-cover w-full h-auto"
                  />
                </div>
                <div className="w-1/2 max-w-[140px] md:max-w-[200px]">
                  <Image 
                    src="/payment-processing-notification.jpg" 
                    alt="Payment notification"
                    width={400}
                    height={700}
                    className="rounded-xl md:rounded-2xl shadow-2xl object-cover w-full h-auto"
                  />
                </div>
              </div>
              
              {/* Page 2: Images 3 & 4 */}
              <div className="flex-shrink-0 w-full flex gap-2 md:gap-4 justify-center items-center snap-center px-8 md:px-12 py-2">
                <div className="w-1/2 max-w-[140px] md:max-w-[200px]">
                  <Image 
                    src="/payment-complete.jpg" 
                    alt="Payment complete"
                    width={400}
                    height={700}
                    className="rounded-xl md:rounded-2xl shadow-2xl object-cover w-full h-auto"
                  />
                </div>
                <div className="w-1/2 max-w-[140px] md:max-w-[200px]">
                  <Image 
                    src="/receipt-items.jpg" 
                    alt="Receipt with items"
                    width={400}
                    height={700}
                    className="rounded-xl md:rounded-2xl shadow-2xl object-cover w-full h-auto"
                  />
                </div>
              </div>
            </div>
            
            {/* Dot Indicators */}
            <div className="flex justify-center gap-2 mt-2">
              <div className="w-2 h-2 rounded-full bg-emerald-400"></div>
              <div className="w-2 h-2 rounded-full bg-zinc-600"></div>
            </div>
          </div>

          {/* Video - Hidden on mobile */}
          <div className="hidden md:block mt-auto">
            <video 
              autoPlay 
              loop 
              muted 
              playsInline
              className="w-24 h-auto rounded-lg opacity-80"
            >
              <source src="/guernsey-flag.webm" type="video/webm" />
            </video>
          </div>
        </div>

        {/* Right Column - Roadmap (Scrollable) */}
        <div className="md:flex-1 flex flex-col gap-2 md:gap-3 md:overflow-y-auto md:pr-2" style={{ scrollbarWidth: 'thin' }}>
          <h2 className="text-blue-400 text-base md:text-xl font-semibold sticky top-0 bg-transparent">12-Month Milestones</h2>
          
          {/* Q1 2026 */}
          <div 
            onClick={() => setActiveModal('q1')}
            className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5 cursor-pointer hover:bg-zinc-700/50 transition-all hover:scale-[1.02]"
          >
            <div className="flex items-center gap-2 mb-1 md:mb-2">
              <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-emerald-400"></div>
              <p className="text-white text-xs md:text-base font-semibold">Q1 2026 ‚Äî Prove</p>
              <svg className="w-3 h-3 md:w-4 md:h-4 text-zinc-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-4 md:pl-5">
              <p>‚Ä¢ GFSC Digital Finance Consultation</p>
              <p>‚Ä¢ First Guernsey merchants onboarded</p>
              <p>‚Ä¢ XRPL Commons residency begins</p>
            </div>
          </div>

          {/* Q2 2026 */}
          <div 
            onClick={() => setActiveModal('q2')}
            className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5 cursor-pointer hover:bg-zinc-700/50 transition-all hover:scale-[1.02]"
          >
            <div className="flex items-center gap-2 mb-1 md:mb-2">
              <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-blue-400"></div>
              <p className="text-white text-xs md:text-base font-semibold">Q2 2026 ‚Äî Scale Locally</p>
              <svg className="w-3 h-3 md:w-4 md:h-4 text-zinc-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-4 md:pl-5">
              <p>‚Ä¢ 50 merchants target</p>
              <p>‚Ä¢ Affiliate network proof-of-concept</p>
              <p>‚Ä¢ 5-deep commission automation</p>
            </div>
          </div>

          {/* Q3 2026 */}
          <div 
            onClick={() => setActiveModal('q3')}
            className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5 cursor-pointer hover:bg-zinc-700/50 transition-all hover:scale-[1.02]"
          >
            <div className="flex items-center gap-2 mb-1 md:mb-2">
              <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-purple-400"></div>
              <p className="text-white text-xs md:text-base font-semibold">Q3 2026 ‚Äî Export Framework</p>
              <svg className="w-3 h-3 md:w-4 md:h-4 text-zinc-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-4 md:pl-5">
              <p>‚Ä¢ 100 merchants target</p>
              <p>‚Ä¢ Jersey/Isle of Man expansion</p>
              <p>‚Ä¢ RWA bridge integration</p>
            </div>
          </div>

          {/* Q4 2026 */}
          <div 
            onClick={() => setActiveModal('q4')}
            className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5 cursor-pointer hover:bg-zinc-700/50 transition-all hover:scale-[1.02]"
          >
            <div className="flex items-center gap-2 mb-1 md:mb-2">
              <div className="w-2 h-2 md:w-3 md:h-3 rounded-full bg-pink-400"></div>
              <p className="text-white text-xs md:text-base font-semibold">Q4 2026 ‚Äî Growth Phase</p>
              <svg className="w-3 h-3 md:w-4 md:h-4 text-zinc-500 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </div>
            <div className="space-y-1 text-zinc-400 text-xs pl-4 md:pl-5">
              <p>‚Ä¢ 500+ merchants</p>
              <p>‚Ä¢ Multi-jurisdiction operations</p>
              <p>‚Ä¢ Seed raise discussion</p>
            </div>
          </div>

          {/* Exit Note */}
          <div className="bg-zinc-900/50 backdrop-blur-sm rounded-lg md:rounded-xl p-2 md:p-3 border border-zinc-700/50">
            <p className="text-zinc-400 text-xs">
              <span className="text-white font-medium">Exit:</span> Stripe/Square/Revolut acquisition target
            </p>
          </div>
        </div>

      </div>

      {/* Modal Overlay */}
      {activeModal && (
        <div 
          className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"
          onClick={() => setActiveModal(null)}
        >
          <div 
            className="bg-zinc-900 rounded-2xl p-5 md:p-6 max-w-lg w-full max-h-[80vh] overflow-y-auto border border-zinc-700 shadow-2xl"
            onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-3">
                <div className={`w-4 h-4 rounded-full ${
                  activeModal === 'q1' ? 'bg-emerald-400' :
                  activeModal === 'q2' ? 'bg-blue-400' :
                  activeModal === 'q3' ? 'bg-purple-400' :
                  'bg-pink-400'
                }`}></div>
                <h3 className="text-white text-lg md:text-xl font-bold">
                  {milestoneDetails[activeModal as keyof typeof milestoneDetails]?.title}
                </h3>
              </div>
              <button 
                onClick={() => setActiveModal(null)}
                className="text-zinc-400 hover:text-white p-1"
              >
                <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            {/* Modal Content */}
            <div className="space-y-4">
              {milestoneDetails[activeModal as keyof typeof milestoneDetails]?.details.map((item, index) => (
                <div key={index} className="border-l-2 border-zinc-700 pl-4">
                  <p className={`text-sm font-semibold mb-1 ${
                    activeModal === 'q1' ? 'text-emerald-400' :
                    activeModal === 'q2' ? 'text-blue-400' :
                    activeModal === 'q3' ? 'text-purple-400' :
                    'text-pink-400'
                  }`}>{item.label}</p>
                  <p className="text-zinc-300 text-sm">{item.value}</p>
                </div>
              ))}
            </div>

            {/* Close Button */}
            <button 
              onClick={() => setActiveModal(null)}
              className={`mt-6 w-full py-2 rounded-lg font-medium text-white transition-all ${
                activeModal === 'q1' ? 'bg-emerald-500 hover:bg-emerald-600' :
                activeModal === 'q2' ? 'bg-blue-500 hover:bg-blue-600' :
                activeModal === 'q3' ? 'bg-purple-500 hover:bg-purple-600' :
                'bg-pink-500 hover:bg-pink-600'
              }`}
            >
              Close
            </button>
          </div>
        </div>
      )}

    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/sound-pay/page.tsx
// =================================================
// MARK: - Imports & Dependencies
import SoundPaymentPage from '@/components/SoundPaymentPage';


// MARK: - Component Definition
export default function SoundPayPage() {
  return <SoundPaymentPage />;
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/staff/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useRouter } from 'next/navigation';
import { useState, useRef, useEffect } from 'react';
import Image from 'next/image';

// Team members data - add more members here
const teamMembers = [
  {
    id: 'mark',
    name: 'Mark Flynn',
    role: 'Founder & Technical Lead',
    image: '/mark.jpg', // Add your headshot to public folder
    bullets: [
      'Self-taught dev: 0 ‚Üí production in 6 months',
      '10 years entrepreneurship',
      'Licensed Social Worker & VIG Practitioner',
    ],
    extra: 'Family legacy: Sister (Real Lives mental health) ¬∑ Brother-in-law (GeoSLAM ¬£22M exit to FARO)',
    note: 'First male practitioner for children in care, Guernsey',
  },
  // ADD MORE TEAM MEMBERS HERE:
  // {
  //   id: 'member2',
  //   name: 'Name Here',
  //   role: 'Role Here',
  //   image: '/member2.jpg',
  //   bullets: ['Bullet 1', 'Bullet 2', 'Bullet 3'],
  //   extra: 'Additional info',
  //   note: 'Notable achievement',
  // },
];

const partnerships = [
  {
    id: 'tvvin',
    abbrev: 'TV',
    name: 'TVVIN',
    description: 'VASP license holder ¬∑ Tokenized asset platform',
    colorClass: 'bg-blue-500/20 text-blue-400',
  },
  {
    id: 'identity',
    abbrev: 'ID',
    name: 'Digital Identity Partner',
    description: '40k lines ¬∑ Trust scoring ¬∑ Privacy-first KYC',
    colorClass: 'bg-purple-500/20 text-purple-400',
  },
  {
    id: 'xrpl',
    abbrev: 'XC',
    name: 'XRPL Commons',
    description: 'Ecosystem support ¬∑ Potential ¬£200k grant',
    colorClass: 'bg-emerald-500/20 text-emerald-400',
  },
];


// MARK: - Component Definition
export default function TeamAskPage() {
  const router = useRouter();

// MARK: - State Management
  const [showLeftArrow, setShowLeftArrow] = useState(false);
  const [showRightArrow, setShowRightArrow] = useState(false);
  const [currentSlide, setCurrentSlide] = useState(0);
  const [isAutoPlaying, setIsAutoPlaying] = useState(true);
  const autoPlayRef = useRef<NodeJS.Timeout | null>(null);

  const totalSlides = teamMembers.length + 1; // +1 for partnerships slide

  // Auto-scroll functionality

// MARK: - Hooks & Effects
  useEffect(() => {
    if (isAutoPlaying && totalSlides > 1) {
      autoPlayRef.current = setInterval(() => {
        setCurrentSlide((prev) => (prev + 1) % totalSlides);
      }, 5000); // Change slide every 5 seconds
    }

    return () => {
      if (autoPlayRef.current) {
        clearInterval(autoPlayRef.current);
      }
    };
  }, [isAutoPlaying, totalSlides]);

  const goToSlide = (index: number) => {
    setCurrentSlide(index);
    setIsAutoPlaying(false); // Pause auto-play when user interacts
    // Resume auto-play after 10 seconds of inactivity
    setTimeout(() => setIsAutoPlaying(true), 10000);
  };

  const prevSlide = () => {
    goToSlide((currentSlide - 1 + totalSlides) % totalSlides);
  };

  const nextSlide = () => {
    goToSlide((currentSlide + 1) % totalSlides);
  };


// MARK: - Main Render
  return (
    <div className="min-h-screen h-screen relative overflow-hidden">
      
      {/* Gradient border frame */}
      <div className="absolute inset-0 z-20 pointer-events-none">
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 left-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 right-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
      </div>
      
      {/* Background */}
      <div 
        className="absolute inset-0 w-full h-full bg-cover bg-center bg-no-repeat"
        style={{ backgroundImage: "url('/background.jpg')" }}
      />

      {/* Navigation - Left Arrow (page nav) */}
      <div 
        className="absolute left-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer"

// MARK: - Event Handlers
        onMouseEnter={() => setShowLeftArrow(true)}
        onMouseLeave={() => setShowLeftArrow(false)}
        onClick={() => router.push('/solution')}
      >
        <svg 
          className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showLeftArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
      </div>

      {/* Navigation - Right Arrow (page nav - loops back to cover) */}
      <div 
        className="absolute right-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer"
        onMouseEnter={() => setShowRightArrow(true)}
        onMouseLeave={() => setShowRightArrow(false)}
        onClick={() => router.push('/cover')}
      >
        <svg 
          className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showRightArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`}
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          strokeWidth={2}
        >
          <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </div>

      {/* Title */}
      <div className="absolute top-4 md:top-10 left-0 right-0 text-center z-10 px-4">
        <h1 className="text-white text-2xl md:text-4xl lg:text-5xl font-bold tracking-tight" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>
          The Team &{' '}
          <span className="bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400 bg-clip-text text-transparent">The Ask</span>
        </h1>
      </div>

      {/* Main Content */}
      <div className="absolute top-16 md:top-28 bottom-4 md:bottom-8 left-4 md:left-8 right-4 md:right-8 z-10 flex flex-col md:flex-row gap-4 md:gap-6 overflow-y-auto md:overflow-visible">
        
        {/* Left Column - Team Carousel */}
        <div className="md:flex-1 flex flex-col gap-3 md:gap-4 relative">
          <h2 className="text-emerald-400 text-base md:text-xl font-semibold">The Team</h2>
          
          {/* Carousel Container */}
          <div className="relative flex-1 min-h-[380px] md:min-h-0">
            
            {/* Carousel Navigation - Left */}
            <button 
              onClick={prevSlide}
              className="absolute left-0 top-1/2 -translate-y-1/2 z-20 bg-black/60 hover:bg-black/80 rounded-full p-2 transition-all shadow-lg"
            >
              <svg className="w-4 h-4 md:w-5 md:h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            
            {/* Carousel Navigation - Right */}
            <button 
              onClick={nextSlide}
              className="absolute right-0 top-1/2 -translate-y-1/2 z-20 bg-black/60 hover:bg-black/80 rounded-full p-2 transition-all shadow-lg"
            >
              <svg className="w-4 h-4 md:w-5 md:h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </button>

            {/* Slides Container */}
            <div className="h-full overflow-hidden mx-10">
              <div 
                className="flex transition-transform duration-500 ease-in-out h-full"
                style={{ transform: `translateX(-${currentSlide * 100}%)` }}
              >
                {/* Team Member Slides */}
                {teamMembers.map((member) => (
                  <div key={member.id} className="w-full flex-shrink-0 h-full flex flex-col gap-3 px-1">
                    {/* Member Card */}
                    <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 md:p-5 flex-1">
                      <div className="flex gap-4">
                        {/* Profile Image */}
                        <div className="w-24 h-24 md:w-28 md:h-28 rounded-xl overflow-hidden flex-shrink-0 bg-gradient-to-br from-emerald-400 to-blue-400 relative">
                          <Image 
                            src={member.image} 
                            alt={member.name}
                            fill
                            className="object-cover"
                          />
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-white text-base md:text-lg font-semibold">{member.name}</p>
                          <p className="text-emerald-400 text-xs md:text-sm">{member.role}</p>
                          <div className="mt-3 space-y-1.5 text-zinc-400 text-xs md:text-sm">
                            {member.bullets.map((bullet, idx) => (
                              <p key={idx}>‚Ä¢ {bullet}</p>
                            ))}
                          </div>
                        </div>
                      </div>
                      {(member.extra || member.note) && (
                        <div className="mt-4 pt-3 border-t border-zinc-700/50">
                          {member.extra && (
                            <p className="text-zinc-400 text-xs md:text-sm">{member.extra}</p>
                          )}
                          {member.note && (
                            <p className="text-zinc-500 text-xs mt-1">{member.note}</p>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                ))}

                {/* Partnerships Slide */}
                <div className="w-full flex-shrink-0 h-full flex flex-col gap-3 px-1">
                  <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 md:p-5 flex-1">
                    <h3 className="text-blue-400 text-sm md:text-base font-semibold mb-3">Strategic Partnerships</h3>
                    <div className="space-y-3">
                      {partnerships.map((partner) => (
                        <div key={partner.id} className="bg-zinc-700/30 rounded-lg p-3">
                          <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-sm font-bold ${partner.colorClass}`}>
                              {partner.abbrev}
                            </div>
                            <div>
                              <p className="text-white text-sm font-medium">{partner.name}</p>
                              <p className="text-zinc-500 text-xs">{partner.description}</p>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    {/* Advisory */}
                    <h3 className="text-purple-400 text-sm md:text-base font-semibold mt-5 mb-2">Advisory (Forming)</h3>
                    <div className="flex flex-wrap gap-2">
                      <span className="px-3 py-1.5 bg-zinc-700/50 rounded-full text-zinc-400 text-xs">Regulatory Compliance</span>
                      <span className="px-3 py-1.5 bg-zinc-700/50 rounded-full text-zinc-400 text-xs">Fintech Scaling</span>
                      <span className="px-3 py-1.5 bg-zinc-700/50 rounded-full text-zinc-400 text-xs">XRPL Ecosystem</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Dot Indicators */}
            <div className="flex justify-center gap-2 mt-3">
              {Array.from({ length: totalSlides }).map((_, idx) => (
                <button
                  key={idx}
                  onClick={() => goToSlide(idx)}
                  className={`h-2 rounded-full transition-all ${
                    currentSlide === idx 
                      ? 'bg-emerald-400 w-6' 
                      : 'bg-zinc-600 hover:bg-zinc-500 w-2'
                  }`}
                />
              ))}
            </div>

            {/* Auto-play indicator */}
            {isAutoPlaying && totalSlides > 1 && (
              <div className="flex justify-center mt-2">
                <div className="flex items-center gap-1.5 text-zinc-500 text-xs">
                  <div className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></div>
                  <span>Auto-scroll</span>
                </div>
              </div>
            )}
          </div>

          {/* Guernsey flag video - desktop only */}
          <div className="hidden md:block mt-auto pt-2">
            <video 
              autoPlay 
              loop 
              muted 
              playsInline
              className="w-20 h-auto rounded-lg opacity-80"
            >
              <source src="/guernsey-flag.webm" type="video/webm" />
            </video>
          </div>
        </div>

        {/* Right Column - The Ask */}
        <div className="md:flex-1 flex flex-col gap-3 md:gap-4 md:overflow-y-auto md:pr-2" style={{ scrollbarWidth: 'thin' }}>
          <h2 className="text-blue-400 text-base md:text-xl font-semibold">The Ask</h2>
          
          {/* Raise Card */}
          <div className="bg-gradient-to-br from-emerald-500/20 to-blue-500/20 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 md:p-5 border border-emerald-500/30">
            <div className="text-center">
              <p className="text-zinc-400 text-sm mb-1">Raising</p>
              <p className="text-white text-3xl md:text-4xl font-bold">¬£200k</p>
              <p className="text-emerald-400 text-sm mt-1">Pre-seed at ¬£2M pre-money</p>
              <p className="text-zinc-500 text-xs mt-1">10% dilution</p>
            </div>
          </div>

          {/* Use of Funds */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <h3 className="text-white text-sm md:text-base font-semibold mb-3">Use of Funds</h3>
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                <div className="w-12 text-right">
                  <span className="text-emerald-400 text-sm md:text-base font-bold">¬£100k</span>
                </div>
                <div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden">
                  <div className="h-full bg-emerald-400 rounded-full" style={{ width: '50%' }}></div>
                </div>
                <span className="text-zinc-400 text-xs w-32">24-mo founder runway</span>
              </div>
              <div className="flex items-center gap-3">
                <div className="w-12 text-right">
                  <span className="text-blue-400 text-sm md:text-base font-bold">¬£60k</span>
                </div>
                <div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden">
                  <div className="h-full bg-blue-400 rounded-full" style={{ width: '30%' }}></div>
                </div>
                <span className="text-zinc-400 text-xs w-32">XRPL developer hire</span>
              </div>
              <div className="flex items-center gap-3">
                <div className="w-12 text-right">
                  <span className="text-purple-400 text-sm md:text-base font-bold">¬£20k</span>
                </div>
                <div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden">
                  <div className="h-full bg-purple-400 rounded-full" style={{ width: '10%' }}></div>
                </div>
                <span className="text-zinc-400 text-xs w-32">Merchant onboarding</span>
              </div>
              <div className="flex items-center gap-3">
                <div className="w-12 text-right">
                  <span className="text-pink-400 text-sm md:text-base font-bold">¬£20k</span>
                </div>
                <div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden">
                  <div className="h-full bg-pink-400 rounded-full" style={{ width: '10%' }}></div>
                </div>
                <span className="text-zinc-400 text-xs w-32">Regulatory & legal</span>
              </div>
            </div>
          </div>

          {/* Why ¬£2M Valuation */}
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <h3 className="text-white text-sm md:text-base font-semibold mb-2">Why ¬£2M Valuation</h3>
            <div className="space-y-1 text-zinc-400 text-xs">
              <p>‚Ä¢ <span className="text-emerald-400">First-mover moat</span> ‚Äî Only regulated retail crypto POS</p>
              <p>‚Ä¢ <span className="text-blue-400">Working product</span> ‚Äî 443+ live transactions</p>
              <p>‚Ä¢ <span className="text-purple-400">Regulatory pathway</span> ‚Äî GFSC Innovation Sandbox</p>
              <p>‚Ä¢ <span className="text-pink-400">Viral mechanics</span> ‚Äî 5-level commission automation</p>
              <p>‚Ä¢ <span className="text-emerald-400">Exportable</span> ‚Äî 50+ jurisdictions addressable</p>
            </div>
            <div className="mt-3 pt-2 border-t border-zinc-700/50">
              <p className="text-zinc-500 text-xs">
                <span className="text-zinc-400">Comparables:</span> Stripe $20M seed (2011) ¬∑ Square $40M seed (2010)
              </p>
            </div>
          </div>

          {/* Timeline */}
          <div className="bg-zinc-900/50 backdrop-blur-sm rounded-lg md:rounded-xl p-3 border border-zinc-700/50">
            <p className="text-zinc-400 text-xs">
              <span className="text-white font-medium">Timeline:</span> Close by March 2026 ‚Äî aligns with Innovation Sandbox approval & XRPL Commons residency
            </p>
          </div>

          {/* Contact */}
          <div className="bg-gradient-to-r from-emerald-500/10 to-blue-500/10 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 border border-emerald-500/20 mt-auto">
            <div className="text-center">
              <p className="text-white text-sm md:text-base font-semibold mb-1">Let's Talk</p>
              <a 
                href="mailto:mark@yesallofus.com" 
                className="text-emerald-400 text-sm md:text-base hover:text-emerald-300 transition-colors"
              >
                mark@yesallofus.com
              </a>
              <p className="text-zinc-500 text-xs mt-2">Mark Flynn ¬∑ Guernsey, Channel Islands</p>
            </div>
          </div>
        </div>

      </div>

    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/staffpos/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, Suspense } from 'react';
import { safeGetItem, safeSetItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';


// MARK: - Types & Interfaces
interface StaffMember {
  staff_id: string;
  name: string;
  photo_url?: string;
  role: 'admin' | 'cashier' | 'manager';
  pin?: string;
  hourly_rate?: number;
  created_at: string;
  is_clocked_in?: boolean;
  current_shift_start?: string;
}

interface Shift {
  shift_id: string;
  staff_id: string;
  staff_name: string;
  clock_in: string;
  clock_out?: string;
  duration_minutes?: number;
  total_sales?: number;
  tips_earned?: number;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
function StaffPage() {
  const router = useRouter();
  
  // Auth
  const [walletAddress, setWalletAddress] = useState<string | null>(null);
  const [storeId, setStoreId] = useState<string | null>(null);
  const [storeName, setStoreName] = useState<string>('');
  
  // Data
  const [staff, setStaff] = useState<StaffMember[]>([]);
  const [shifts, setShifts] = useState<Shift[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  
  // UI State
  const [showAddModal, setShowAddModal] = useState(false);
  const [editingStaff, setEditingStaff] = useState<StaffMember | null>(null);
  const [activeTab, setActiveTab] = useState<'staff' | 'shifts'>('staff');
  
  // Form state
  const [formName, setFormName] = useState('');
  const [formRole, setFormRole] = useState<'admin' | 'cashier' | 'manager'>('cashier');
  const [formPin, setFormPin] = useState('');
  const [formHourlyRate, setFormHourlyRate] = useState('');
  const [formPhoto, setFormPhoto] = useState<string | null>(null);
  const [uploading, setUploading] = useState(false);
  const [saving, setSaving] = useState(false);

  // Load store data

// MARK: - Hooks & Effects
  useEffect(() => {
    const stored = safeGetItem('vendorWalletAddress');
    const storeData = safeGetItem('storeData');
    
    if (!stored) {
      router.push('/dashboard');
      return;
    }
    
    setWalletAddress(stored);
    
    if (storeData) {
      const store = JSON.parse(storeData);
      setStoreId(store.store_id || null);
      setStoreName(store.store_name || 'Your Store');
    }
  }, [router]);

  // Fetch staff
  useEffect(() => {
    if (storeId && walletAddress) {
      fetchStaff();
      fetchShifts();
    }
  }, [storeId, walletAddress]);


// MARK: - API Calls & Data Fetching
  const fetchStaff = async () => {
    setLoading(true);
    try {
      const res = await fetch(
        `${API_URL}/store/${storeId}/staff?wallet_address=${walletAddress}`
      );
      const data = await res.json();
      if (data.success) {
        setStaff(data.staff || []);
      }
    } catch (err) {
      console.error('Failed to load staff');
    }
    setLoading(false);
  };

  const fetchShifts = async () => {
    try {
      const res = await fetch(
        `${API_URL}/store/${storeId}/shifts?wallet_address=${walletAddress}&limit=50`
      );
      const data = await res.json();
      if (data.success) {
        setShifts(data.shifts || []);
      }
    } catch (err) {
      console.error('Failed to load shifts');
    }
  };


// MARK: - Event Handlers
  const handlePhotoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      alert('Image must be less than 5MB');
      return;
    }

    setUploading(true);
    
    // Compress the image
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // Max 200x200 for staff photos
      const maxSize = 200;
      let width = img.width;
      let height = img.height;
      
      if (width > height) {
        if (width > maxSize) {
          height = (height * maxSize) / width;
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width = (width * maxSize) / height;
          height = maxSize;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx?.drawImage(img, 0, 0, width, height);
      
      // Convert to compressed JPEG
      const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
      setFormPhoto(compressedBase64);
      setUploading(false);
    };
    
    img.src = URL.createObjectURL(file);
  };

  const resetForm = () => {
    setFormName('');
    setFormRole('cashier');
    setFormPin('');
    setFormHourlyRate('');
    setFormPhoto(null);
    setEditingStaff(null);
  };

  const openAddModal = () => {
    resetForm();
    setShowAddModal(true);
  };

  const openEditModal = (member: StaffMember) => {
    setEditingStaff(member);
    setFormName(member.name);
    setFormRole(member.role);
    setFormPin(member.pin || '');
    setFormHourlyRate(member.hourly_rate?.toString() || '');
    setFormPhoto(member.photo_url || null);
    setShowAddModal(true);
  };

  const saveStaff = async () => {
    if (!formName.trim()) {
      alert('Please enter a name');
      return;
    }

    setSaving(true);
    try {
      const endpoint = editingStaff 
        ? `${API_URL}/store/${storeId}/staff/${editingStaff.staff_id}`
        : `${API_URL}/store/${storeId}/staff`;
      
      const res = await fetch(endpoint, {
        method: editingStaff ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress,
          name: formName.trim(),
          role: formRole,
          pin: formPin || null,
          hourly_rate: formHourlyRate ? parseFloat(formHourlyRate) : null,
          photo_url: formPhoto
        })
      });

      const data = await res.json();
      if (data.success) {
        fetchStaff();
        setShowAddModal(false);
        resetForm();
      } else {
        alert(data.error || 'Failed to save');
      }
    } catch (err) {
      alert('Failed to save staff member');
    }
    setSaving(false);
  };

  const deleteStaff = async (staffId: string) => {
    if (!confirm('Are you sure you want to remove this staff member?')) return;

    try {
      const res = await fetch(
        `${API_URL}/store/${storeId}/staff/${staffId}?wallet_address=${walletAddress}`,
        { method: 'DELETE' }
      );
      const data = await res.json();
      if (data.success) {
        fetchStaff();
      }
    } catch (err) {
      alert('Failed to delete');
    }
  };

  const clockIn = async (staffId: string) => {
    try {
      const res = await fetch(`${API_URL}/store/${storeId}/staff/${staffId}/clock-in`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const data = await res.json();
      if (data.success) {
        fetchStaff();
        fetchShifts();
      }
    } catch (err) {
      alert('Failed to clock in');
    }
  };

  const clockOut = async (staffId: string) => {
    try {
      const res = await fetch(`${API_URL}/store/${storeId}/staff/${staffId}/clock-out`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const data = await res.json();
      if (data.success) {
        fetchStaff();
        fetchShifts();
      }
    } catch (err) {
      alert('Failed to clock out');
    }
  };

  const formatDuration = (minutes: number) => {
    const hrs = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
  };

  const formatTime = (dateStr: string) => {
    return new Date(dateStr).toLocaleTimeString('en-GB', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  };

  const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString('en-GB', { 
      day: 'numeric',
      month: 'short'
    });
  };

  const getShiftDuration = (clockIn: string, clockOut?: string) => {
    const start = new Date(clockIn).getTime();
    const end = clockOut ? new Date(clockOut).getTime() : Date.now();
    return Math.floor((end - start) / 60000);
  };

  const roleColors = {
    admin: 'bg-purple-500/20 text-purple-400',
    manager: 'bg-blue-500/20 text-blue-400',
    cashier: 'bg-emerald-500/20 text-emerald-400'
  };


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans">
      
      {/* Header */}
      <header className="sticky top-0 z-40 bg-[#0a0a0a]/95 backdrop-blur border-b border-zinc-800">
        <div className="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-1">
            <button
              onClick={() => router.push('/take-payment')}
              className="text-zinc-400 hover:text-white transition p-2 cursor-pointer active:scale-95"
              title="Take Payment"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
              </svg>
            </button>
            <button
              onClick={() => router.push('/dashboard')}
              className="text-zinc-400 hover:text-white transition p-2 cursor-pointer active:scale-95"
              title="Dashboard"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
            </button>
          </div>
          
          <h1 className="text-lg font-bold">Staff</h1>
          
          <button
            onClick={openAddModal}
            className="text-zinc-400 hover:text-white transition p-2 cursor-pointer active:scale-95"
            title="Add Staff"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>
      </header>

      <main className="max-w-2xl mx-auto px-4 pb-8">
        
        {/* Tabs */}
        <div className="flex gap-2 py-6">
          <button
            onClick={() => setActiveTab('staff')}
            className={`px-5 py-2.5 rounded-full text-sm font-medium transition cursor-pointer active:scale-95 ${
              activeTab === 'staff'
                ? 'bg-emerald-500 text-black'
                : 'bg-zinc-800 text-zinc-400 hover:text-white'
            }`}
          >
            Staff ({staff.length})
          </button>
          <button
            onClick={() => setActiveTab('shifts')}
            className={`px-5 py-2.5 rounded-full text-sm font-medium transition cursor-pointer active:scale-95 ${
              activeTab === 'shifts'
                ? 'bg-emerald-500 text-black'
                : 'bg-zinc-800 text-zinc-400 hover:text-white'
            }`}
          >
            Shifts
          </button>
        </div>

        {/* Loading */}
        {loading && (
          <div className="text-center py-12">
            <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
            <p className="text-zinc-500">Loading...</p>
          </div>
        )}

        {/* Staff Tab */}
        {!loading && activeTab === 'staff' && (
          <>
            {staff.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üë•</div>
                <p className="text-zinc-400 mb-2">No staff members yet</p>
                <button
                  onClick={openAddModal}
                  className="text-emerald-400 hover:text-emerald-300 font-medium cursor-pointer"
                >
                  + Add your first staff member
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                {staff.map((member) => (
                  <div
                    key={member.staff_id}
                    className="bg-zinc-900 border border-zinc-800 rounded-xl p-4"
                  >
                    <div className="flex items-center gap-4">
                      {/* Photo */}
                      <div className="relative">
                        {member.photo_url ? (
                          <img
                            src={member.photo_url}
                            alt={member.name}
                            className="w-14 h-14 rounded-full object-cover"
                          />
                        ) : (
                          <div className="w-14 h-14 rounded-full bg-zinc-800 flex items-center justify-center text-2xl">
                            {member.name.charAt(0).toUpperCase()}
                          </div>
                        )}
                        {member.is_clocked_in && (
                          <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full border-2 border-zinc-900 flex items-center justify-center">
                            <span className="text-[10px]">‚úì</span>
                          </div>
                        )}
                      </div>

                      {/* Info */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <p className="font-semibold truncate">{member.name}</p>
                          <span className={`text-xs px-2 py-0.5 rounded-full ${roleColors[member.role]}`}>
                            {member.role}
                          </span>
                        </div>
                        {member.is_clocked_in && member.current_shift_start && (
                          <p className="text-emerald-400 text-sm">
                            On shift ¬∑ {formatDuration(getShiftDuration(member.current_shift_start))}
                          </p>
                        )}
                        {!member.is_clocked_in && (
                          <p className="text-zinc-500 text-sm">Off duty</p>
                        )}
                      </div>

                      {/* Actions */}
                      <div className="flex items-center gap-2">
                        {member.is_clocked_in ? (
                          <button
                            onClick={() => clockOut(member.staff_id)}
                            className="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-3 py-2 rounded-lg text-sm font-medium transition cursor-pointer active:scale-95"
                          >
                            Clock Out
                          </button>
                        ) : (
                          <button
                            onClick={() => clockIn(member.staff_id)}
                            className="bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 px-3 py-2 rounded-lg text-sm font-medium transition cursor-pointer active:scale-95"
                          >
                            Clock In
                          </button>
                        )}
                        <button
                          onClick={() => openEditModal(member)}
                          className="text-zinc-400 hover:text-white p-2 transition cursor-pointer"
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </>
        )}

        {/* Shifts Tab */}
        {!loading && activeTab === 'shifts' && (
          <>
            {shifts.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üìÖ</div>
                <p className="text-zinc-400">No shifts recorded yet</p>
              </div>
            ) : (
              <div className="space-y-3">
                {shifts.map((shift) => (
                  <div
                    key={shift.shift_id}
                    className="bg-zinc-900 border border-zinc-800 rounded-xl p-4"
                  >
                    <div className="flex items-center justify-between mb-2">
                      <p className="font-semibold">{shift.staff_name}</p>
                      <p className="text-zinc-500 text-sm">{formatDate(shift.clock_in)}</p>
                    </div>
                    <div className="flex items-center justify-between text-sm">
                      <div className="flex items-center gap-4">
                        <span className="text-zinc-400">
                          {formatTime(shift.clock_in)} ‚Üí {shift.clock_out ? formatTime(shift.clock_out) : <span className="text-emerald-400">Active</span>}
                        </span>
                        <span className="text-zinc-500">
                          {shift.duration_minutes 
                            ? formatDuration(shift.duration_minutes)
                            : formatDuration(getShiftDuration(shift.clock_in))
                          }
                        </span>
                      </div>
                      {(shift.total_sales !== undefined && shift.total_sales > 0) && (
                        <span className="text-emerald-400 font-medium">
                          ¬£{shift.total_sales.toFixed(2)} sales
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </>
        )}
      </main>

      {/* Add/Edit Modal */}
      {showAddModal && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div className="bg-zinc-900 rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-zinc-900 p-4 border-b border-zinc-800 flex items-center justify-between">
              <h2 className="text-lg font-bold">
                {editingStaff ? 'Edit Staff' : 'Add Staff'}
              </h2>
              <button
                onClick={() => { setShowAddModal(false); resetForm(); }}
                className="text-zinc-400 hover:text-white p-2 cursor-pointer"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="p-4 space-y-4">
              {/* Photo */}
              <div className="flex justify-center">
                <label className="cursor-pointer">
                  {formPhoto ? (
                    <div className="relative">
                      <img
                        src={formPhoto}
                        alt="Staff photo"
                        className="w-24 h-24 rounded-full object-cover"
                      />
                      <div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 hover:opacity-100 transition">
                        <span className="text-white text-sm">Change</span>
                      </div>
                      <button
                        type="button"
                        onClick={(e) => { e.preventDefault(); e.stopPropagation(); setFormPhoto(null); }}
                        className="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white text-xs hover:bg-red-400 cursor-pointer"
                      >
                        ‚úï
                      </button>
                    </div>
                  ) : (
                    <div className="w-24 h-24 rounded-full bg-zinc-800 border-2 border-dashed border-zinc-700 hover:border-emerald-500 flex flex-col items-center justify-center transition">
                      {uploading ? (
                        <div className="w-6 h-6 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
                      ) : (
                        <>
                          <svg className="w-8 h-8 text-zinc-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                          </svg>
                          <span className="text-zinc-500 text-xs">Add photo</span>
                        </>
                      )}
                    </div>
                  )}
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handlePhotoUpload}
                    className="hidden"
                    disabled={uploading}
                  />
                </label>
              </div>

              {/* Name */}
              <div>
                <label className="text-zinc-400 text-sm block mb-2">Name *</label>
                <input
                  type="text"
                  value={formName}
                  onChange={(e) => setFormName(e.target.value)}
                  placeholder="Staff name"
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500"
                />
              </div>

              {/* Role */}
              <div>
                <label className="text-zinc-400 text-sm block mb-2">Role</label>
                <div className="flex gap-2">
                  {(['cashier', 'manager', 'admin'] as const).map((role) => (
                    <button
                      key={role}
                      type="button"
                      onClick={() => setFormRole(role)}
                      className={`flex-1 py-2 rounded-xl text-sm font-medium transition cursor-pointer active:scale-95 ${
                        formRole === role
                          ? 'bg-emerald-500 text-black'
                          : 'bg-zinc-800 text-zinc-400 hover:text-white'
                      }`}
                    >
                      {role.charAt(0).toUpperCase() + role.slice(1)}
                    </button>
                  ))}
                </div>
              </div>

              {/* PIN */}
              <div>
                <label className="text-zinc-400 text-sm block mb-2">PIN (optional)</label>
                <input
                  type="password"
                  value={formPin}
                  onChange={(e) => setFormPin(e.target.value.replace(/\D/g, '').slice(0, 4))}
                  placeholder="4-digit PIN"
                  maxLength={4}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500 tracking-widest"
                />
                <p className="text-zinc-600 text-xs mt-1">For clock in verification</p>
              </div>

              {/* Hourly Rate */}
              <div>
                <label className="text-zinc-400 text-sm block mb-2">Hourly Rate (optional)</label>
                <div className="relative">
                  <span className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-400">¬£</span>
                  <input
                    type="number"
                    value={formHourlyRate}
                    onChange={(e) => setFormHourlyRate(e.target.value)}
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                    className="w-full bg-zinc-800 border border-zinc-700 rounded-xl pl-8 pr-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500"
                  />
                </div>
              </div>

              {/* Actions */}
              <div className="flex gap-3 pt-4">
                {editingStaff && (
                  <button
                    onClick={() => {
                      deleteStaff(editingStaff.staff_id);
                      setShowAddModal(false);
                      resetForm();
                    }}
                    className="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-4 py-3 rounded-xl transition cursor-pointer active:scale-95"
                  >
                    Delete
                  </button>
                )}
                <button
                  onClick={() => { setShowAddModal(false); resetForm(); }}
                  className="flex-1 bg-zinc-800 hover:bg-zinc-700 py-3 rounded-xl transition cursor-pointer active:scale-95"
                >
                  Cancel
                </button>
                <button
                  onClick={saveStaff}
                  disabled={saving || !formName.trim()}
                  className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-3 rounded-xl transition disabled:opacity-50 cursor-pointer active:scale-95"
                >
                  {saving ? 'Saving...' : editingStaff ? 'Save' : 'Add Staff'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default function StaffPageWrapper() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-[#0a0a0a] text-white flex items-center justify-center">
        <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
      </div>
    }>
      <StaffPage />
    </Suspense>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/app/team/page.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useRouter } from 'next/navigation';
import { useState, useRef, useEffect } from 'react';
import Image from 'next/image';

const teamMembers = [
  {
    id: 'mark',
    name: 'Mark Flynn',
    role: 'Founder & Technical Lead',
    image: '/mark.jpg',
    bullets: [
      'Self-taught dev: 0 ‚Üí production in 6 months',
      '10 years entrepreneurship',
      'Licensed Social Worker & VIG Practitioner',
    ],
    extra: 'Family legacy: Sister (Real Lives mental health) ¬∑ Brother-in-law (GeoSLAM ¬£22M exit to FARO)',
    note: 'First male practitioner for children in care, Guernsey',
  },
];

const partnerships = [
  { id: 'tvvin', abbrev: 'TV', name: 'TVVIN', description: 'VASP license holder ¬∑ Tokenized asset platform', colorClass: 'bg-blue-500/20 text-blue-400' },
  { id: 'identity', abbrev: 'ID', name: 'Digital Identity Partner', description: '40k lines ¬∑ Trust scoring ¬∑ Privacy-first KYC', colorClass: 'bg-purple-500/20 text-purple-400' },
  { id: 'xrpl', abbrev: 'XC', name: 'XRPL Commons', description: 'Ecosystem support ¬∑ Potential ¬£200k grant', colorClass: 'bg-emerald-500/20 text-emerald-400' },
];


// MARK: - Component Definition
export default function TeamAskPage() {
  const router = useRouter();

// MARK: - State Management
  const [showLeftArrow, setShowLeftArrow] = useState(false);
  const [showRightArrow, setShowRightArrow] = useState(false);
  const [currentSlide, setCurrentSlide] = useState(0);
  const [isAutoPlaying, setIsAutoPlaying] = useState(true);
  const autoPlayRef = useRef<NodeJS.Timeout | null>(null);
  const totalSlides = teamMembers.length + 1;


// MARK: - Hooks & Effects
  useEffect(() => {
    if (isAutoPlaying && totalSlides > 1) {
      autoPlayRef.current = setInterval(() => {
        setCurrentSlide((prev) => (prev + 1) % totalSlides);
      }, 5000);
    }
    return () => { if (autoPlayRef.current) clearInterval(autoPlayRef.current); };
  }, [isAutoPlaying, totalSlides]);

  const goToSlide = (index: number) => {
    setCurrentSlide(index);
    setIsAutoPlaying(false);
    setTimeout(() => setIsAutoPlaying(true), 10000);
  };

  const prevSlide = () => goToSlide((currentSlide - 1 + totalSlides) % totalSlides);
  const nextSlide = () => goToSlide((currentSlide + 1) % totalSlides);


// MARK: - Main Render
  return (
    <div className="min-h-screen h-screen relative overflow-hidden">
      <div className="absolute inset-0 z-20 pointer-events-none">
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 left-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
        <div className="absolute top-0 bottom-0 right-0 w-1 bg-gradient-to-b from-emerald-400 via-blue-400 to-purple-400"></div>
      </div>
      <div className="absolute inset-0 w-full h-full bg-cover bg-center bg-no-repeat" style={{ backgroundImage: "url('/background.jpg')" }} />
      <div className="absolute left-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer" onMouseEnter={() => setShowLeftArrow(true)} onMouseLeave={() => setShowLeftArrow(false)} onClick={() => router.push('/solution')}>
        <svg className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showLeftArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg>
      </div>
      <div className="absolute right-0 top-0 bottom-0 w-10 md:w-20 z-30 flex items-center justify-center cursor-pointer" onMouseEnter={() => setShowRightArrow(true)} onMouseLeave={() => setShowRightArrow(false)} onClick={() => router.push('/cover')}>
        <svg className={`w-6 h-6 md:w-10 md:h-10 text-white transition-opacity duration-300 ${showRightArrow ? 'opacity-70 hover:opacity-100' : 'opacity-0 md:opacity-0'} opacity-50 md:opacity-0`} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
      </div>
      <div className="absolute top-4 md:top-10 left-0 right-0 text-center z-10 px-4">
        <h1 className="text-white text-2xl md:text-4xl lg:text-5xl font-bold tracking-tight" style={{ fontFamily: 'system-ui, -apple-system, sans-serif' }}>The Team &{' '}<span className="bg-gradient-to-r from-emerald-400 via-blue-400 to-purple-400 bg-clip-text text-transparent">The Ask</span></h1>
      </div>
      <div className="absolute top-16 md:top-28 bottom-4 md:bottom-8 left-4 md:left-8 right-4 md:right-8 z-10 flex flex-col md:flex-row gap-4 md:gap-6 overflow-y-auto md:overflow-visible">
        <div className="md:flex-1 flex flex-col gap-3 md:gap-4 relative">
          <h2 className="text-emerald-400 text-base md:text-xl font-semibold">The Team</h2>
          <div className="relative flex-1 min-h-[380px] md:min-h-0">
            <button onClick={prevSlide} className="absolute left-0 top-1/2 -translate-y-1/2 z-20 bg-black/60 hover:bg-black/80 rounded-full p-2 transition-all shadow-lg"><svg className="w-4 h-4 md:w-5 md:h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
            <button onClick={nextSlide} className="absolute right-0 top-1/2 -translate-y-1/2 z-20 bg-black/60 hover:bg-black/80 rounded-full p-2 transition-all shadow-lg"><svg className="w-4 h-4 md:w-5 md:h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg></button>
            <div className="h-full overflow-hidden mx-10">
              <div className="flex transition-transform duration-500 ease-in-out h-full" style={{ transform: `translateX(-${currentSlide * 100}%)` }}>
                {teamMembers.map((member) => (
                  <div key={member.id} className="w-full flex-shrink-0 h-full flex flex-col gap-3 px-1">
                    <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 md:p-5 flex-1">
                      <div className="flex gap-4">
                        <div className="w-24 h-24 md:w-28 md:h-28 rounded-xl overflow-hidden flex-shrink-0 bg-gradient-to-br from-emerald-400 to-blue-400 relative">
                          <Image src={member.image} alt={member.name} fill className="object-cover" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-white text-base md:text-lg font-semibold">{member.name}</p>
                          <p className="text-emerald-400 text-xs md:text-sm">{member.role}</p>
                          <div className="mt-3 space-y-1.5 text-zinc-400 text-xs md:text-sm">
                            {member.bullets.map((bullet, idx) => (<p key={idx}>‚Ä¢ {bullet}</p>))}
                          </div>
                        </div>
                      </div>
                      {(member.extra || member.note) && (
                        <div className="mt-4 pt-3 border-t border-zinc-700/50">
                          {member.extra && <p className="text-zinc-400 text-xs md:text-sm">{member.extra}</p>}
                          {member.note && <p className="text-zinc-500 text-xs mt-1">{member.note}</p>}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
                <div className="w-full flex-shrink-0 h-full flex flex-col gap-3 px-1">
                  <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 md:p-5 flex-1">
                    <h3 className="text-blue-400 text-sm md:text-base font-semibold mb-3">Strategic Partnerships</h3>
                    <div className="space-y-3">
                      {partnerships.map((partner) => (
                        <div key={partner.id} className="bg-zinc-700/30 rounded-lg p-3">
                          <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-sm font-bold ${partner.colorClass}`}>{partner.abbrev}</div>
                            <div><p className="text-white text-sm font-medium">{partner.name}</p><p className="text-zinc-500 text-xs">{partner.description}</p></div>
                          </div>
                        </div>
                      ))}
                    </div>
                    <h3 className="text-purple-400 text-sm md:text-base font-semibold mt-5 mb-2">Advisory (Forming)</h3>
                    <div className="flex flex-wrap gap-2">
                      <span className="px-3 py-1.5 bg-zinc-700/50 rounded-full text-zinc-400 text-xs">Regulatory Compliance</span>
                      <span className="px-3 py-1.5 bg-zinc-700/50 rounded-full text-zinc-400 text-xs">Fintech Scaling</span>
                      <span className="px-3 py-1.5 bg-zinc-700/50 rounded-full text-zinc-400 text-xs">XRPL Ecosystem</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div className="flex justify-center gap-2 mt-3">
              {Array.from({ length: totalSlides }).map((_, idx) => (<button key={idx} onClick={() => goToSlide(idx)} className={`h-2 rounded-full transition-all ${currentSlide === idx ? 'bg-emerald-400 w-6' : 'bg-zinc-600 hover:bg-zinc-500 w-2'}`} />))}
            </div>
            {isAutoPlaying && totalSlides > 1 && (<div className="flex justify-center mt-2"><div className="flex items-center gap-1.5 text-zinc-500 text-xs"><div className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></div><span>Auto-scroll</span></div></div>)}
          </div>
          <div className="hidden md:block mt-auto pt-2"><video autoPlay loop muted playsInline className="w-20 h-auto rounded-lg opacity-80"><source src="/guernsey-flag.webm" type="video/webm" /></video></div>
        </div>
        <div className="md:flex-1 flex flex-col gap-3 md:gap-4 md:overflow-y-auto md:pr-2" style={{ scrollbarWidth: 'thin' }}>
          <h2 className="text-blue-400 text-base md:text-xl font-semibold">The Ask</h2>
          <div className="bg-gradient-to-br from-emerald-500/20 to-blue-500/20 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 md:p-5 border border-emerald-500/30">
            <div className="text-center"><p className="text-zinc-400 text-sm mb-1">Raising</p><p className="text-white text-3xl md:text-4xl font-bold">¬£200k</p><p className="text-emerald-400 text-sm mt-1">Pre-seed at ¬£2M pre-money</p><p className="text-zinc-500 text-xs mt-1">10% dilution</p></div>
          </div>
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <h3 className="text-white text-sm md:text-base font-semibold mb-3">Use of Funds</h3>
            <div className="space-y-3">
              <div className="flex items-center gap-3"><div className="w-12 text-right"><span className="text-emerald-400 text-sm md:text-base font-bold">¬£100k</span></div><div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden"><div className="h-full bg-emerald-400 rounded-full" style={{ width: '50%' }}></div></div><span className="text-zinc-400 text-xs w-32">24-mo founder runway</span></div>
              <div className="flex items-center gap-3"><div className="w-12 text-right"><span className="text-blue-400 text-sm md:text-base font-bold">¬£60k</span></div><div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden"><div className="h-full bg-blue-400 rounded-full" style={{ width: '30%' }}></div></div><span className="text-zinc-400 text-xs w-32">XRPL developer hire</span></div>
              <div className="flex items-center gap-3"><div className="w-12 text-right"><span className="text-purple-400 text-sm md:text-base font-bold">¬£20k</span></div><div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden"><div className="h-full bg-purple-400 rounded-full" style={{ width: '10%' }}></div></div><span className="text-zinc-400 text-xs w-32">Merchant onboarding</span></div>
              <div className="flex items-center gap-3"><div className="w-12 text-right"><span className="text-pink-400 text-sm md:text-base font-bold">¬£20k</span></div><div className="flex-1 h-2 bg-zinc-700 rounded-full overflow-hidden"><div className="h-full bg-pink-400 rounded-full" style={{ width: '10%' }}></div></div><span className="text-zinc-400 text-xs w-32">Regulatory & legal</span></div>
            </div>
          </div>
          <div className="bg-zinc-800/50 backdrop-blur-sm rounded-xl md:rounded-2xl p-3 md:p-5">
            <h3 className="text-white text-sm md:text-base font-semibold mb-2">Why ¬£2M Valuation</h3>
            <div className="space-y-1 text-zinc-400 text-xs">
              <p>‚Ä¢ <span className="text-emerald-400">First-mover moat</span> ‚Äî Only regulated retail crypto POS</p>
              <p>‚Ä¢ <span className="text-blue-400">Working product</span> ‚Äî 443+ live transactions</p>
              <p>‚Ä¢ <span className="text-purple-400">Regulatory pathway</span> ‚Äî GFSC Innovation Sandbox</p>
              <p>‚Ä¢ <span className="text-pink-400">Viral mechanics</span> ‚Äî 5-level commission automation</p>
              <p>‚Ä¢ <span className="text-emerald-400">Exportable</span> ‚Äî 50+ jurisdictions addressable</p>
            </div>
            <div className="mt-3 pt-2 border-t border-zinc-700/50"><p className="text-zinc-500 text-xs"><span className="text-zinc-400">Comparables:</span> Stripe $20M seed (2011) ¬∑ Square $40M seed (2010)</p></div>
          </div>
          <div className="bg-zinc-900/50 backdrop-blur-sm rounded-lg md:rounded-xl p-3 border border-zinc-700/50"><p className="text-zinc-400 text-xs"><span className="text-white font-medium">Timeline:</span> Close by March 2026 ‚Äî aligns with Innovation Sandbox approval & XRPL Commons residency</p></div>
          <div className="bg-gradient-to-r from-emerald-500/10 to-blue-500/10 backdrop-blur-sm rounded-xl md:rounded-2xl p-4 border border-emerald-500/20 mt-auto">
            <div className="text-center"><p className="text-white text-sm md:text-base font-semibold mb-1">Let's Talk</p><a href="mailto:mark@yesallofus.com" className="text-emerald-400 text-sm md:text-base hover:text-emerald-300 transition-colors">mark@yesallofus.com</a><p className="text-zinc-500 text-xs mt-2">Mark Flynn ¬∑ Guernsey, Channel Islands</p></div>
          </div>
        </div>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/cli/index.js
// =================================================
#!/usr/bin/env node
// MARK: - Imports & Dependencies
const readline = require('readline');
const https = require('https');
const { exec } = require('child_process');


// MARK: - Constants & Configuration
const API_URL = 'api.dltpays.com';

// Colors
const c = {
  reset: '\x1b[0m',
  bold: '\x1b[1m',
  dim: '\x1b[2m',
  green: '\x1b[32m',
  cyan: '\x1b[36m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  magenta: '\x1b[35m',
  blue: '\x1b[34m',
  bgBlue: '\x1b[44m',
  bgGreen: '\x1b[42m',
  bgMagenta: '\x1b[45m',
  white: '\x1b[37m',
  gray: '\x1b[90m'
};

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function ask(question) {
  return new Promise(resolve => rl.question(question, resolve));
}

function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

function isValidUrl(url) {
  try {
    const parsed = new URL(url.startsWith('http') ? url : `https://${url}`);
    return parsed.hostname.includes('.');
  } catch {
    return false;
  }
}

function normalizeUrl(url) {
  if (!url.startsWith('http')) {
    return `https://${url}`;
  }
  return url;
}

async function askWithValidation(question, validator, errorMessage, normalizer = null) {
  while (true) {
    const answer = await ask(question);
    
    if (!answer.trim()) {
      console.log(`${c.red}  ‚úó This field is required${c.reset}`);
      continue;
    }
    
    if (validator && !validator(answer.trim())) {
      console.log(`${c.red}  ‚úó ${errorMessage}${c.reset}`);
      continue;
    }
    
    return normalizer ? normalizer(answer.trim()) : answer.trim();
  }
}

function apiCall(method, path, data = null) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: API_URL,
      port: 443,
      path: `/api/v1${path}`,
      method,
      headers: { 'Content-Type': 'application/json' }
    };
    const req = https.request(options, res => {
      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        try {
          resolve(JSON.parse(body));
        } catch {
          resolve(body);
        }
      });
    });
    req.on('error', reject);
    if (data) req.write(JSON.stringify(data));
    req.end();
  });
}

function openBrowser(url) {
  const platform = process.platform;
  let command;
  
  if (platform === 'darwin') {
    command = `open "${url}"`;
  } else if (platform === 'win32') {
    command = `start "" "${url}"`;
  } else {
    command = `xdg-open "${url}"`;
  }
  
  exec(command, (err) => {
    if (err) {
      console.log(`${c.dim}  Could not open browser automatically.${c.reset}`);
    }
  });
}

function banner() {
  console.log('');
  console.log(`${c.cyan}    ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó${c.reset}`);
  console.log(`${c.cyan}    ‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù${c.reset}`);
  console.log(`${c.green}     ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó${c.reset}`);
  console.log(`${c.green}      ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë${c.reset}`);
  console.log(`${c.cyan}       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë${c.reset}`);
  console.log(`${c.cyan}       ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${c.reset}`);
  console.log('');
  console.log(`${c.bold}${c.white}                    ‚ö° Instant Affiliate Commissions on XRPL ‚ö°${c.reset}`);
  console.log(`${c.dim}                      Pay affiliates in seconds, not months${c.reset}`);
  console.log('');
  console.log(`${c.gray}  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${c.reset}`);
  console.log('');
}

function section(emoji, title) {
  console.log('');
  console.log(`${c.gray}  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${c.reset}`);
  console.log(`${c.bold}  ${emoji} ${title}${c.reset}`);
  console.log(`${c.gray}  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${c.reset}`);
}

function box(lines, color = c.cyan) {
  const maxLen = Math.max(...lines.map(l => l.replace(/\x1b\[[0-9;]*m/g, '').length));
  const pad = (s) => {
    const plainLen = s.replace(/\x1b\[[0-9;]*m/g, '').length;
    return s + ' '.repeat(maxLen - plainLen);
  };
  console.log(`${color}  ‚ï≠${'‚îÄ'.repeat(maxLen + 2)}‚ïÆ${c.reset}`);
  lines.forEach(line => {
    console.log(`${color}  ‚îÇ${c.reset} ${pad(line)} ${color}‚îÇ${c.reset}`);
  });
  console.log(`${color}  ‚ï∞${'‚îÄ'.repeat(maxLen + 2)}‚ïØ${c.reset}`);
}

function success(msg) {
  console.log(`${c.green}  ‚úì ${msg}${c.reset}`);
}

function info(label, value, indent = '  ') {
  const labelPad = 15;
  const paddedLabel = label.padEnd(labelPad);
  console.log(`${indent}${c.dim}${paddedLabel}${c.reset}${c.bold}${value}${c.reset}`);
}

function spinner(text) {
  const frames = ['‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è'];
  let i = 0;
  process.stdout.write(`\n${c.yellow}  ${frames[0]} ${text}${c.reset}`);
  return setInterval(() => {
    i = (i + 1) % frames.length;
    process.stdout.clearLine(0);
    process.stdout.cursorTo(0);
    process.stdout.write(`${c.yellow}  ${frames[i]} ${text}${c.reset}`);
  }, 80);
}

function stopSpinner(interval) {
  clearInterval(interval);
  process.stdout.clearLine(0);
  process.stdout.cursorTo(0);
}

const PLATFORMS = {
  '1': { name: 'WooCommerce / WordPress', key: 'woocommerce' },
  '2': { name: 'Shopify', key: 'shopify' },
  '3': { name: 'Custom / API Integration', key: 'custom' },
  '4': { name: 'Stripe Checkout', key: 'stripe' },
  '5': { name: 'Gumroad', key: 'gumroad' },
  '6': { name: 'LemonSqueezy', key: 'lemonsqueezy' },
  '7': { name: 'Paddle', key: 'paddle' }
};

function showPlatformMenu() {
  console.log('');
  console.log(`${c.bold}  What platform is your store on?${c.reset}`);
  console.log('');
  Object.entries(PLATFORMS).forEach(([num, platform]) => {
    const icon = num === '1' ? 'üü¢' : num === '2' ? 'üü£' : num === '3' ? '‚ö°' : '‚óã';
    console.log(`${c.dim}    ${icon}${c.reset} ${c.cyan}[${num}]${c.reset} ${platform.name}`);
  });
  console.log('');
}

function getWooCommerceInstructions(storeId, apiSecret) {
  return `
${c.bold}${c.green}  WooCommerce Setup (Easiest - 2 minutes)${c.reset}

  ${c.bold}Step 1:${c.reset} Download the plugin
  ${c.cyan}https://github.com/TokenCanvasIO/YesAllofUs-wordpress/releases/download/v1.0.0/YesAllofUs.zip${c.reset}

  ${c.bold}Step 2:${c.reset} Install in WordPress
  ${c.dim}WordPress Admin ‚Üí Plugins ‚Üí Add New ‚Üí Upload Plugin ‚Üí Select the .zip${c.reset}

  ${c.bold}Step 3:${c.reset} Activate & Configure
  ${c.dim}Go to Settings ‚Üí YesAllofUs and enter your API credentials${c.reset}

  ${c.bold}What you get:${c.reset}
  ${c.green}‚úì${c.reset} Affiliate signup page        ${c.dim}[yesallofus_affiliate_signup]${c.reset}
  ${c.green}‚úì${c.reset} Affiliate dashboard           ${c.dim}[yesallofus_affiliate_dashboard]${c.reset}
  ${c.green}‚úì${c.reset} Auto commission tracking      ${c.dim}on every WooCommerce order${c.reset}
  ${c.green}‚úì${c.reset} Store admin dashboard         ${c.dim}manage affiliates & payouts${c.reset}
  ${c.green}‚úì${c.reset} Instant RLUSD payouts         ${c.dim}via Xaman or Crossmark auto-sign${c.reset}
`;
}

function getShopifyInstructions(storeId, apiSecret) {
  return `
${c.bold}${c.magenta}  Shopify Setup${c.reset}

  ${c.bold}Step 1:${c.reset} Add tracking script to your theme
  ${c.dim}Online Store ‚Üí Themes ‚Üí Edit Code ‚Üí theme.liquid (before </head>)${c.reset}

${c.blue}  <script>
    (function() {
      const ref = new URLSearchParams(window.location.search).get('ref');
      if (ref) {
        document.cookie = 'yesallofus_ref=' + ref + ';path=/;max-age=2592000';
      }
    })();
  </script>${c.reset}

  ${c.bold}Step 2:${c.reset} Create a Shopify Flow or use webhooks
  ${c.dim}Settings ‚Üí Notifications ‚Üí Webhooks ‚Üí Create webhook${c.reset}
  ${c.dim}Event: Order payment ‚Üí URL: Your server endpoint${c.reset}

  ${c.bold}Step 3:${c.reset} Call YesAllofUs API on order completion
  ${c.dim}(See API integration below)${c.reset}

  ${c.yellow}‚ö† Shopify requires a small backend to call our API.${c.reset}
  ${c.dim}We're building a native Shopify app - join the waitlist: mark@yesallofus.com${c.reset}
`;
}

function getCustomInstructions(storeId, apiSecret) {
  return `
${c.bold}${c.cyan}  Custom API Integration${c.reset}

  ${c.bold}Step 1:${c.reset} Track referral codes
  ${c.dim}Capture the ?ref= parameter and store it with the user/order${c.reset}

  ${c.bold}Step 2:${c.reset} Call payout endpoint on successful order

${c.blue}  // When order completes successfully:
  const response = await fetch('https://api.dltpays.com/api/v1/payout', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ${c.yellow}${apiSecret}${c.blue}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      order_id: orderId,           // Your unique order ID
      order_total: 49.99,          // Order amount in USD
      referral_code: refCode       // The ?ref= code from cookie
    })
  });${c.reset}

  ${c.bold}Step 3:${c.reset} Share your affiliate signup link
  ${c.cyan}https://yesallofus.com/affiliate-signup?store=${storeId}${c.reset}
`;
}

function getStripeInstructions(storeId, apiSecret) {
  return `
${c.bold}${c.blue}  Stripe Checkout Integration${c.reset}

  ${c.bold}Step 1:${c.reset} Add metadata to checkout session

${c.blue}  const session = await stripe.checkout.sessions.create({
    // ... your config
    metadata: {
      referral_code: req.cookies.yesallofus_ref || ''
    }
  });${c.reset}

  ${c.bold}Step 2:${c.reset} Handle checkout.session.completed webhook

${c.blue}  // In your Stripe webhook handler:
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;
    
    await fetch('https://api.dltpays.com/api/v1/payout', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ${c.yellow}${apiSecret}${c.blue}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        order_id: session.id,
        order_total: session.amount_total / 100,
        referral_code: session.metadata.referral_code
      })
    });
  }${c.reset}
`;
}

function getGenericInstructions(platform, storeId, apiSecret) {
  return `
${c.bold}${c.yellow}  ${PLATFORMS[platform].name} Integration${c.reset}

  ${c.dim}We're working on native integrations for ${PLATFORMS[platform].name}.${c.reset}
  ${c.dim}For now, use the webhook/API approach:${c.reset}

  ${c.bold}Core concept:${c.reset}
  ${c.cyan}1.${c.reset} Track ?ref= parameter in cookies
  ${c.cyan}2.${c.reset} On successful payment, POST to our API
  ${c.cyan}3.${c.reset} We handle commission calculation & instant payout

  ${c.bold}API Endpoint:${c.reset}
  ${c.cyan}POST https://api.dltpays.com/api/v1/payout${c.reset}

  ${c.bold}Request body:${c.reset}
${c.blue}  {
    "order_id": "unique_order_123",
    "order_total": 99.99,
    "referral_code": "ABC123"
  }${c.reset}

  ${c.bold}Need help?${c.reset} ${c.cyan}mark@yesallofus.com${c.reset}
`;
}

async function main() {
  banner();

  console.log(`${c.bold}  Let's get your store set up with instant affiliate payouts${c.reset}`);
  console.log(`${c.dim}  Takes about 2 minutes for WooCommerce, 5-10 for custom integrations${c.reset}`);
  console.log('');

  // Store details with validation
  const storeName = await askWithValidation(
    `${c.cyan}  Store name: ${c.reset}`,
    (name) => name.length >= 2,
    'Store name must be at least 2 characters'
  );
  
  const storeUrl = await askWithValidation(
    `${c.cyan}  Website URL: ${c.reset}`,
    isValidUrl,
    'Please enter a valid URL (e.g. mystore.com or https://mystore.com)',
    normalizeUrl
  );
  
  const email = await askWithValidation(
    `${c.cyan}  Email: ${c.reset}`,
    isValidEmail,
    'Please enter a valid email address'
  );

  // Referral code (optional)
  const referralCode = await ask(`${c.cyan}  Referral code (optional): ${c.reset}`);
  
  let referred_by_store = null;
  if (referralCode.trim()) {
    const lookupResult = await apiCall('GET', `/store/lookup-referral/${referralCode.trim()}`);
    if (lookupResult.success) {
      referred_by_store = lookupResult.store_id;
      console.log(`${c.green}  ‚úì Referred by: ${lookupResult.store_name} (50% off first month!)${c.reset}`);
    } else {
      console.log(`${c.yellow}  ‚ö† Referral code not found - continuing without referral${c.reset}`);
    }
  }

  // Platform selection
  showPlatformMenu();
  const platformChoice = await ask(`${c.cyan}  Select platform [1-7]: ${c.reset}`);
  const platform = PLATFORMS[platformChoice] || PLATFORMS['3'];

  const spin = spinner('Registering your store...');

  const result = await apiCall('POST', '/store/register', {
    store_name: storeName,
    store_url: storeUrl,
    email: email,
    platform: platform.key,
    referred_by_store: referred_by_store
  });

  stopSpinner(spin);

if (result.error) {
  console.log(`\n${c.red}  ‚úó Error: ${result.error}${c.reset}\n`);
  rl.close();
  return;
}

// ADD THIS BLOCK
if (result.reconnected) {
  console.log('');
  console.log(`${c.yellow}  ‚ö† Store already registered for ${storeUrl}${c.reset}`);
  console.log('');
  console.log(`${c.bold}  Log in to your dashboard:${c.reset}`);
  console.log(`${c.cyan}  https://yesallofus.com/dashboard?claim=${result.claim_token}${c.reset}`);
  console.log('');
  console.log(`${c.dim}  Need a new API secret? Regenerate it from the dashboard.${c.reset}`);
  console.log('');
  rl.close();
  return;
}

console.log('');
success('Store registered successfully!');
// ... rest of the success flow

  // Credentials
  section('üîê', 'Your Credentials');
  console.log('');
  box([
    `${c.dim}Store ID${c.reset}       ${c.bold}${result.store_id}${c.reset}`,
    `${c.dim}API Key${c.reset}        ${c.bold}${result.api_key}${c.reset}`,
    `${c.dim}API Secret${c.reset}     ${c.bold}${c.yellow}${result.api_secret}${c.reset}`,
    `${c.dim}Referral Code${c.reset}  ${c.bold}${result.store_referral_code}${c.reset}`
  ]);
  console.log(`\n${c.yellow}  ‚ö†  Save your API Secret now - it cannot be retrieved later${c.reset}`);

  // Platform-specific instructions
  section('üì¶', `${platform.name} Setup`);
  
  switch (platform.key) {
    case 'woocommerce':
      console.log(getWooCommerceInstructions(result.store_id, result.api_secret));
      break;
    case 'shopify':
      console.log(getShopifyInstructions(result.store_id, result.api_secret));
      console.log(getCustomInstructions(result.store_id, result.api_secret));
      break;
    case 'stripe':
      console.log(getStripeInstructions(result.store_id, result.api_secret));
      break;
    case 'custom':
      console.log(getCustomInstructions(result.store_id, result.api_secret));
      break;
    default:
      console.log(getGenericInstructions(platformChoice, result.store_id, result.api_secret));
      console.log(getCustomInstructions(result.store_id, result.api_secret));
  }

  // Affiliate signup
  section('üéØ', 'Affiliate Signup Page');
  console.log('');
  console.log(`${c.dim}  Share this link for affiliates to register:${c.reset}`);
  console.log('');
  console.log(`${c.bold}${c.cyan}  https://yesallofus.com/affiliate-signup?store=${result.store_id}${c.reset}`);
  
  if (platform.key === 'woocommerce') {
    console.log('');
    console.log(`${c.dim}  Or use the shortcode on any WordPress page:${c.reset}`);
    console.log(`${c.blue}  [yesallofus_affiliate_signup]${c.reset}`);
  }

  // Resources
  section('üìö', 'Resources');
  console.log('');
  info('Documentation', 'https://yesallofus.com/docs');
  info('Support', 'mark@yesallofus.com');
  info('Twitter', '@YesAllofUs');
  
  console.log('');
  console.log(`${c.gray}  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${c.reset}`);
  console.log('');
  console.log(`${c.bold}${c.green}  üöÄ You're ready to pay affiliates instantly!${c.reset}`);
  console.log(`${c.dim}     Lagos to London, same speed. That's the future.${c.reset}`);
  console.log('');

  // Wallet connection
  section('üëõ', 'Connect Your Wallet');
console.log('');
console.log(`${c.dim}  Payout options:${c.reset}`);
console.log(`${c.white}  ‚Ä¢ Google${c.reset} ${c.dim}- Easiest setup, automatic 24/7 payouts${c.reset}`);
console.log(`${c.green}  ‚Ä¢ Xaman${c.reset} ${c.dim}- Manual approval via push notification${c.reset}`);
console.log(`${c.blue}  ‚Ä¢ Crossmark${c.reset} ${c.dim}- Automatic 24/7 payouts (browser extension)${c.reset}`);
  console.log('');
  
  const dashboardUrl = `https://yesallofus.com/dashboard?claim=${result.claim_token}`;
  
  console.log(`${c.bold}  Open this URL to connect your wallet:${c.reset}`);
  console.log('');
  console.log(`${c.cyan}  ${dashboardUrl}${c.reset}`);
  console.log('');
  console.log(`${c.yellow}  üí° Use Chrome or Brave for best experience (required for Crossmark)${c.reset}`)
  
  console.log('');
  console.log(`${c.gray}  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${c.reset}`);
  console.log('');
  console.log(`${c.bold}${c.white}  Thanks for choosing YesAllofUs! ü§ù${c.reset}`);
  console.log(`${c.dim}  Questions? mark@yesallofus.com${c.reset}`);
  console.log('');

  rl.close();
}

main().catch(err => {
  console.error(`${c.red}Error: ${err.message}${c.reset}`);
  rl.close();
});
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/AffiliateDashboardTour.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect } from 'react';
import { useNextStep } from 'nextstepjs';


// MARK: - Types & Interfaces
interface AffiliateDashboardTourProps {
  run: boolean;
  onComplete: () => void;
  hasJoinedVendor?: boolean;
}

export const tourSteps = [
  {
    tour: 'affiliateDashboard',
    steps: [
      {
        icon: null,
        title: 'Welcome to YesAllOfUs',
        content: 'Your wallet for instant payments and rewards. Let me show you around - it only takes a minute.',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: '‚Üë Show Your Balances',
        content: 'Your balances are hidden for privacy. Tap the eye icon in the top right anytime to reveal or hide your amounts.',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Your Earnings',
        content: 'Track your total earnings here. Once you join vendor programs, you will see your commissions and active vendors.',
        selector: '#earnings',
        side: 'bottom' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Wallet Status',
        content: 'Check your XRP and RLUSD balances. You need XRP for fees and RLUSD for payments.',
        selector: '#wallet-balances',
        side: 'bottom' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Payment Methods',
        content: 'Connect a wallet to make payments. Use Tap-to-Pay for contactless NFC, Browser Wallet for Crossmark, or Manual Wallet for Xaman.',
        selector: '#tap-to-pay',
        side: 'left' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Top Up Your Wallet',
        content: 'Add funds to your wallet here. Expand this section to deposit XRP or RLUSD.',
        selector: '#top-up-inner',
        side: 'left' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Withdraw Funds',
        content: 'Send RLUSD or XRP to another wallet. Enter the amount and destination address, then confirm.',
        selector: '#withdraw',
        side: 'left' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Find Vendors',
        content: 'Browse vendors to shop with or earn from. Join their affiliate programs to start earning commissions.',
        selector: '#vendors',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'You are Ready',
        content: 'That covers the basics. Use the menu to navigate, and check your progress to unlock all features.',
        side: 'top' as const,
        showControls: true,
        showSkip: false,
      },
    ],
  },
];


// MARK: - Component Definition
export default function AffiliateDashboardTour({ run, onComplete, hasJoinedVendor = false }: AffiliateDashboardTourProps) {
  const { startNextStep, closeNextStep } = useNextStep();


// MARK: - Hooks & Effects
  useEffect(() => {
    if (run) {
      console.log('Starting affiliate tour...');
      try {
        closeNextStep();
      } catch (e) {
        // Ignore if no tour running
      }
      const timeout = setTimeout(() => {
        startNextStep('affiliateDashboard');
        // Save immediately when tour starts - user has seen it
        onComplete();
      }, 700);
      return () => clearTimeout(timeout);
    }
  }, [run]);

  return null;
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/AutoSignModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';

// L7: Map technical errors to user-friendly messages
const sanitizeError = (error: string): string => {
  if (error.includes('tec') || error.includes('tem') || error.includes('tef')) {
    return 'Transaction failed. Please try again.';
  }
  if (error.includes('timeout') || error.includes('Timeout')) {
    return 'Request timed out. Please try again.';
  }
  if (error.includes('network') || error.includes('Network') || error.includes('fetch')) {
    return 'Network error. Please check your connection.';
  }
  if (error.includes('User rejected') || error.includes('user rejected')) {
    return 'Setup cancelled.';
  }
  // Avoid exposing internal errors
  if (error.length > 100 || error.includes('Error:') || error.includes('at ')) {
    return 'Setup failed. Please try again.';
  }
  return error;
};


// MARK: - Types & Interfaces
interface AutoSignModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;
}


// MARK: - Component Definition
export default function AutoSignModal({ 
  isOpen, 
  onClose, 
  onSuccess
}: AutoSignModalProps) {

// MARK: - State Management
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [progress, setProgress] = useState<string | null>(null);
  const [step, setStep] = useState<'login' | 'setup'>('login');
  const [walletAddress, setWalletAddress] = useState<string | null>(null);

  if (!isOpen) return null;

  const loginAndSetup = async () => {
    setLoading(true);
    setError(null);
    setProgress('Signing in...');

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth) {
        throw new Error('Failed to initialize login');
      }

      // Check if already logged in
      if (!web3auth.connected) {
        await web3auth.connect();
      }

      if (!web3auth.provider) {
        throw new Error('Login failed');
      }

      // Get wallet address
      const accounts = await web3auth.provider.request({
        method: 'xrpl_getAccounts'
      }) as string[];
      
      const wallet = accounts?.[0];
      if (!wallet) {
        throw new Error('No wallet found');
      }

      setWalletAddress(wallet);
      setStep('setup');
      setProgress('Checking wallet status...');

      // Check wallet status (funded + trustline)
      const statusRes = await fetch(`https://api.dltpays.com/nfc/api/v1/nfc/customer/autosign-status/${wallet}`);
      const statusData = await statusRes.json();

      if (statusData.wallet_not_funded) {
        throw new Error('Your wallet needs funding. Please add at least 2 XRP first.');
      }

      if (statusData.auto_sign_enabled) {
        // Already set up!
        setProgress('Already set up!');
        setTimeout(() => onSuccess(), 500);
        return;
      }

      // Get platform signer
      setProgress('Preparing tap-to-pay...');
      const settingsRes = await fetch('https://api.dltpays.com/nfc/api/v1/nfc/customer/setup-autosign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: wallet })
      });
      const settingsData = await settingsRes.json();
      
      if (settingsData.error) throw new Error(settingsData.error);
      
      if (settingsData.signer_exists) {
        await fetch('https://api.dltpays.com/nfc/api/v1/nfc/customer/enable-autosign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet_address: wallet, max_transaction: 25 })
        });
        onSuccess();
        return;
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) throw new Error('Platform signer not configured');

      setProgress('Confirm in your wallet...');
      
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: wallet,
        SignerQuorum: 1,
        SignerEntries: [{ SignerEntry: { Account: platformSignerAddress, SignerWeight: 1 } }]
      };
      
      await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: signerListSetTx }
      });

      setProgress('Verifying setup...');
      await new Promise(resolve => setTimeout(resolve, 2000));

      const verifyRes = await fetch(`https://api.dltpays.com/nfc/api/v1/nfc/customer/autosign-status/${wallet}`);
      const verifyData = await verifyRes.json();
      
      if (verifyData.auto_sign_enabled) {
        setProgress('Success! Tap your card again.');
        setTimeout(() => onSuccess(), 1500);
      } else {
        throw new Error('Setup failed. Please try again.');
      }

    } catch (err: any) {
      console.error('AutoSign setup error:', err);
      // L7: Sanitize error to prevent info disclosure
      setError(sanitizeError(err.message || 'Failed to set up wallet'));
      setStep('login');
    }
    setLoading(false);
    setProgress(null);
  };


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-zinc-900 border border-zinc-800 rounded-2xl max-w-md w-full p-6">
        <div className="text-center mb-6">
          <div className="w-16 h-16 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h2 className="text-xl font-bold text-white mb-2">Wallet Not Set Up</h2>
          <p className="text-zinc-400 text-sm">
            {step === 'login' 
              ? 'Sign in to enable tap-to-pay for your NFC card.'
              : 'Setting up tap-to-pay...'}
          </p>
        </div>

        {error && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3 mb-4">
            <p className="text-red-400 text-sm text-center">{error}</p>
          </div>
        )}

        {progress && (
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-3 mb-4 flex items-center justify-center gap-2">
            <div className="w-4 h-4 border-2 border-amber-400 border-t-transparent rounded-full animate-spin" />
            <p className="text-amber-400 text-sm">{progress}</p>
          </div>
        )}

        <div className="space-y-3">
          <button

// MARK: - Event Handlers
            onClick={loginAndSetup}
            disabled={loading}
            className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 disabled:opacity-50 text-black font-bold py-4 rounded-xl transition flex items-center justify-center gap-2"
          >
            {loading ? (
              <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin" />
            ) : (
              <>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                {step === 'login' ? 'Sign In & Enable Tap-to-Pay' : 'Enable Tap-to-Pay'}
              </>
            )}
          </button>

          <button
            onClick={onClose}
            disabled={loading}
            className="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-medium py-3 rounded-xl transition"
          >
            Cancel
          </button>
        </div>

        <p className="text-zinc-500 text-xs text-center mt-4">
          This authorizes automatic payments up to ¬£25 per transaction.
        </p>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/BackgroundVideo.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useRef } from 'react';


// MARK: - Types & Interfaces
interface BackgroundVideoProps {
  src: string;
  overlay?: boolean;
}


// MARK: - Component Definition
export default function BackgroundVideo({ 
  src, 
  overlay = true 
}: BackgroundVideoProps) {
  const videoRef = useRef<HTMLVideoElement>(null);


// MARK: - Hooks & Effects
  useEffect(() => {
    if (videoRef.current) {
      videoRef.current.playbackRate = 0.4; // 40% speed (60% slower)
    }
  }, []);


// MARK: - Main Render
  return (
    <div className="fixed inset-0 z-0 overflow-hidden" style={{ minHeight: '100vh' }}>
      <video
  ref={videoRef}
  autoPlay
  loop
  muted
  playsInline
  className="absolute min-w-full min-h-full w-full h-full object-cover"
  style={{ minHeight: '100vh', minWidth: '100vw' }}
>
        <source src={src} type="video/webm" />
      </video>
      {overlay && <div className="absolute inset-0 bg-black/40" />}
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/BarcodeScanner.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useRef, useState } from 'react';
import { Html5Qrcode, Html5QrcodeSupportedFormats } from 'html5-qrcode';


// MARK: - Types & Interfaces
interface BarcodeScannerProps {
  onScan: (barcode: string, format: string) => void;
  onError?: (error: string) => void;
  onClose: () => void;
}


// MARK: - Constants & Configuration
const SUPPORTED_FORMATS = [
  Html5QrcodeSupportedFormats.EAN_13,
  Html5QrcodeSupportedFormats.EAN_8,
  Html5QrcodeSupportedFormats.UPC_A,
  Html5QrcodeSupportedFormats.UPC_E,
  Html5QrcodeSupportedFormats.CODE_128,
  Html5QrcodeSupportedFormats.CODE_39,
  Html5QrcodeSupportedFormats.CODE_93,
  Html5QrcodeSupportedFormats.CODABAR,
  Html5QrcodeSupportedFormats.ITF,
  Html5QrcodeSupportedFormats.QR_CODE,
];


// MARK: - Component Definition
export default function BarcodeScanner({ onScan, onError, onClose }: BarcodeScannerProps) {
  const scannerRef = useRef<Html5Qrcode | null>(null);
  const [hasPermission, setHasPermission] = useState<boolean | null>(null);

// MARK: - State Management
  const [isStarting, setIsStarting] = useState(true);
  const [manualBarcode, setManualBarcode] = useState('');
  const [showManualInput, setShowManualInput] = useState(false);
  const [lastScanned, setLastScanned] = useState<string | null>(null);


// MARK: - Hooks & Effects
  useEffect(() => {
    const scannerId = 'barcode-scanner-container';
    let mounted = true;

    const startScanner = async () => {
      try {
        // Create scanner instance
        const scanner = new Html5Qrcode(scannerId, {
          formatsToSupport: SUPPORTED_FORMATS,
          verbose: false,
        });
        scannerRef.current = scanner;

        // Get available cameras
        const cameras = await Html5Qrcode.getCameras();
        if (cameras.length === 0) {
          throw new Error('No cameras found');
        }

        // Prefer back camera
        const backCamera = cameras.find(c =>
          c.label.toLowerCase().includes('back') ||
          c.label.toLowerCase().includes('rear') ||
          c.label.toLowerCase().includes('environment')
        );
        const cameraId = backCamera?.id || cameras[0].id;

        await scanner.start(
          cameraId,
          {
            fps: 10,
            qrbox: { width: 280, height: 160 },
            aspectRatio: 1.777778,
          },
          (decodedText, result) => {
            // Prevent duplicate scans within 2 seconds
            if (decodedText === lastScanned) return;
            setLastScanned(decodedText);
            setTimeout(() => setLastScanned(null), 2000);

            // Vibrate on success
            if (navigator.vibrate) navigator.vibrate(100);

            // Play beep sound
            try {
              const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();
              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);
              oscillator.frequency.value = 1800;
              oscillator.type = 'sine';
              gainNode.gain.value = 0.1;
              oscillator.start();
              oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
              // Audio not available
            }

            // Get format name
            const formatName = result.result.format?.formatName || 'Unknown';

            // Stop scanner and return result
            scanner.stop().then(() => {
              if (mounted) {
                onScan(decodedText, formatName);
              }
            }).catch(() => {});
          },
          () => {
            // Ignore scan failures (no barcode in frame)
          }
        );

        if (mounted) {
          setHasPermission(true);
          setIsStarting(false);
        }
      } catch (err: any) {
        console.error('Scanner error:', err);
        if (mounted) {
          setHasPermission(false);
          setIsStarting(false);
          if (err.message?.includes('Permission')) {
            onError?.('Camera permission denied. Please allow camera access.');
          } else if (err.message?.includes('NotFound') || err.message?.includes('No cameras')) {
            onError?.('No camera found on this device.');
          } else {
            onError?.(err.message || 'Failed to start camera');
          }
        }
      }
    };

    startScanner();

    return () => {
      mounted = false;
      if (scannerRef.current?.isScanning) {
        scannerRef.current.stop().catch(() => {});
      }
    };
  }, [onScan, onError]);


// MARK: - Event Handlers
  const handleManualSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const barcode = manualBarcode.trim();
    if (barcode) {
      // Stop scanner if running
      if (scannerRef.current?.isScanning) {
        scannerRef.current.stop().catch(() => {});
      }
      onScan(barcode, 'Manual');
    }
  };


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black z-[80] flex flex-col">
      {/* Header */}
      <div className="safe-area-top bg-black/80 backdrop-blur">
        <div className="flex items-center justify-between p-4">
          <h2 className="text-white font-bold text-lg">Scan Barcode</h2>
          <button
            onClick={onClose}
            className="text-white p-2 hover:bg-white/10 rounded-lg transition"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      {/* Scanner viewport */}
      <div className="flex-1 relative overflow-hidden">
        {/* Camera feed container */}
        <div
          id="barcode-scanner-container"
          className="absolute inset-0"
          style={{
            width: '100%',
            height: '100%',
          }}
        />

        {/* Loading state */}
        {isStarting && (
          <div className="absolute inset-0 flex items-center justify-center bg-black">
            <div className="text-center">
              <div className="w-12 h-12 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
              <p className="text-white">Starting camera...</p>
            </div>
          </div>
        )}

        {/* Permission denied state */}
        {hasPermission === false && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/95 p-6">
            <div className="text-center max-w-sm">
              <div className="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg className="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                    d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
              </div>
              <h3 className="text-white font-bold text-lg mb-2">Camera Access Required</h3>
              <p className="text-zinc-400 text-sm mb-6">
                Please enable camera permissions in your browser settings to scan barcodes.
              </p>
              <button
                onClick={() => setShowManualInput(true)}
                className="bg-zinc-800 hover:bg-zinc-700 text-white px-6 py-3 rounded-xl transition"
              >
                Enter Barcode Manually
              </button>
            </div>
          </div>
        )}

        {/* Scan overlay - only show when camera is active */}
        {hasPermission && !isStarting && (
          <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
            {/* Darkened edges */}
            <div className="absolute inset-0 bg-black/40" />

            {/* Scan window */}
            <div className="relative">
              {/* Clear window */}
              <div
                className="w-72 h-40 border-2 border-emerald-400 rounded-xl bg-transparent relative"
                style={{ boxShadow: '0 0 0 9999px rgba(0,0,0,0.5)' }}
              >
                {/* Corner markers */}
                <div className="absolute -top-0.5 -left-0.5 w-6 h-6 border-t-4 border-l-4 border-emerald-400 rounded-tl-lg" />
                <div className="absolute -top-0.5 -right-0.5 w-6 h-6 border-t-4 border-r-4 border-emerald-400 rounded-tr-lg" />
                <div className="absolute -bottom-0.5 -left-0.5 w-6 h-6 border-b-4 border-l-4 border-emerald-400 rounded-bl-lg" />
                <div className="absolute -bottom-0.5 -right-0.5 w-6 h-6 border-b-4 border-r-4 border-emerald-400 rounded-br-lg" />

                {/* Scanning line animation */}
                <div className="absolute inset-x-4 top-1/2 h-0.5 bg-emerald-400/80 animate-pulse" />
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Footer */}
      <div className="safe-area-bottom bg-black/80 backdrop-blur">
        <div className="p-4 space-y-3">
          {/* Instructions */}
          <p className="text-zinc-400 text-sm text-center">
            Position the barcode within the frame
          </p>

          {/* Manual entry toggle */}
          <button
            onClick={() => setShowManualInput(!showManualInput)}
            className="w-full text-emerald-400 text-sm py-2 hover:text-emerald-300 transition"
          >
            {showManualInput ? 'Hide manual entry' : 'Enter barcode manually'}
          </button>

          {/* Manual entry form */}
          {showManualInput && (
            <form onSubmit={handleManualSubmit} className="flex gap-2">
              <input
                type="text"
                value={manualBarcode}
                onChange={(e) => setManualBarcode(e.target.value)}
                placeholder="Enter barcode..."
                className="flex-1 bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-emerald-500 font-mono"
                autoFocus
              />
              <button
                type="submit"
                disabled={!manualBarcode.trim()}
                className="bg-emerald-500 hover:bg-emerald-400 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold px-6 py-3 rounded-xl transition"
              >
                Go
              </button>
            </form>
          )}

          {/* Supported formats info */}
          <p className="text-zinc-600 text-xs text-center">
            Supports EAN-13, UPC-A, Code 128, QR Code & more
          </p>
        </div>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/CelebrationToast.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useState } from 'react';


// MARK: - Types & Interfaces
interface CelebrationToastProps {
  milestone: string;
  onClose: () => void;
}

const milestoneConfig: Record<string, { title: string; message: string; icon: React.ReactNode }> = {
  wallet_funded: {
    title: 'Wallet Activated!',
    message: 'Your wallet is now live on the XRP Ledger.',
    icon: (
      <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
    )
  },
  trustline_set: {
    title: 'RLUSD Ready!',
    message: 'You can now receive RLUSD payments.',
    icon: (
      <svg className="w-8 h-8 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
      </svg>
    )
  },
  auto_sign_enabled: {
    title: 'Auto-Sign Enabled!',
    message: 'Payouts will process automatically 24/7.',
    icon: (
      <svg className="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
    )
  },
  first_affiliate: {
    title: 'First Affiliate!',
    message: 'Congratulations! Your first affiliate just signed up.',
    icon: (
      <svg className="w-8 h-8 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
      </svg>
    )
  },
  first_payment_received: {
    title: 'First Payment!',
    message: 'You just received your first RLUSD payment.',
    icon: (
      <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    )
  },
  first_payout_sent: {
    title: 'First Payout Sent!',
    message: 'Your first affiliate commission has been paid.',
    icon: (
      <svg className="w-8 h-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
      </svg>
    )
  },
  first_partner_signed: {
    title: 'First Partner!',
    message: 'Another vendor signed up using your referral.',
    icon: (
      <svg className="w-8 h-8 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
    )
  }
};


// MARK: - Component Definition
export default function CelebrationToast({ milestone, onClose }: CelebrationToastProps) {

// MARK: - State Management
  const [visible, setVisible] = useState(false);
  const config = milestoneConfig[milestone];


// MARK: - Hooks & Effects
  useEffect(() => {
    setTimeout(() => setVisible(true), 50);
    
    const timer = setTimeout(() => {
      setVisible(false);
      setTimeout(onClose, 300);
    }, 5000);

    return () => clearTimeout(timer);
  }, [onClose]);

  if (!config) return null;


// MARK: - Main Render
  return (
    <div className="fixed top-20 right-4 z-[100] pointer-events-none">
      <div
        className={`
          pointer-events-auto
          bg-gradient-to-br from-emerald-900/95 to-zinc-900/95 
          border border-emerald-500/30 
          rounded-xl p-4 shadow-2xl shadow-emerald-500/20
          max-w-sm
          transform transition-all duration-300
          ${visible ? 'translate-x-0 opacity-100' : 'translate-x-full opacity-0'}
        `}
      >
        <div className="flex items-start gap-3">
          <div className="flex-shrink-0 w-12 h-12 bg-zinc-800/50 rounded-lg flex items-center justify-center">
            {config.icon}
          </div>
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-1">
              <span className="text-emerald-400 font-bold">{config.title}</span>
              <svg className="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
              </svg>
            </div>
            <p className="text-zinc-300 text-sm">{config.message}</p>
          </div>
          <button

// MARK: - Event Handlers
            onClick={() => {
              setVisible(false);
              setTimeout(onClose, 300);
            }}
            className="text-zinc-500 hover:text-white transition flex-shrink-0"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/CollapsibleCard.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, ReactNode } from 'react';


// MARK: - Types & Interfaces
interface CollapsibleCardProps {
  title: string;
  icon?: string;
  defaultOpen?: boolean;
  badge?: string;
  badgeColor?: 'emerald' | 'yellow' | 'red' | 'blue';
  children: ReactNode;
}


// MARK: - Component Definition
export default function CollapsibleCard({
  title,
  icon,
  defaultOpen = false,
  badge,
  badgeColor = 'emerald',
  children
}: CollapsibleCardProps) {

// MARK: - State Management
  const [isOpen, setIsOpen] = useState(defaultOpen);

  const badgeColors = {
    emerald: 'bg-emerald-500/20 text-emerald-400',
    yellow: 'bg-yellow-500/20 text-yellow-400',
    red: 'bg-red-500/20 text-red-400',
    blue: 'bg-blue-500/20 text-blue-400',
  };


// MARK: - Main Render
  return (
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden mb-6">
      <button

// MARK: - Event Handlers
        onClick={() => setIsOpen(!isOpen)}
        className="w-full flex items-center justify-between p-4 sm:p-6 cursor-pointer hover:bg-zinc-800/50 transition"
      >
        <div className="flex items-center gap-3">
          {icon && <span className="text-xl">{icon}</span>}
          <h2 className="text-lg font-bold">{title}</h2>
          {badge && (
            <span className={`text-xs px-2 py-0.5 rounded ${badgeColors[badgeColor]}`}>
              {badge}
            </span>
          )}
        </div>
        <svg
          className={`w-5 h-5 text-zinc-400 transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      
      <div
        className={`grid transition-all duration-300 ease-in-out ${
          isOpen ? 'grid-rows-[1fr] opacity-100' : 'grid-rows-[0fr] opacity-0'
        }`}
      >
        <div className="overflow-hidden">
          <div className="px-4 sm:px-6 pb-4 sm:pb-6 pt-0">
            {children}
          </div>
        </div>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/CollapsibleSection.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect, useRef, ReactNode } from 'react';


// MARK: - Types & Interfaces
interface CollapsibleSectionProps {
  id: string;
  title: string;
  icon?: ReactNode;
  defaultOpen?: boolean;
  isOpen?: boolean;
  onToggle?: (isOpen: boolean) => void;
  size?: 'default' | 'tall';
  dashboardType?: 'vendor' | 'affiliate';
  videoBg?: string;
  children: ReactNode;
}


// MARK: - Component Definition
export default function CollapsibleSection({
  id,
  title,
  icon,
  defaultOpen = false,
  isOpen: controlledIsOpen,
  onToggle,
  size = 'default',
  dashboardType = 'vendor',
  videoBg,
  children
}: CollapsibleSectionProps) {

// MARK: - State Management
  const [internalOpen, setInternalOpen] = useState(defaultOpen);
  const sectionRef = useRef<HTMLDivElement>(null);

  // Support both controlled and uncontrolled modes
  const isOpen = controlledIsOpen !== undefined ? controlledIsOpen : internalOpen;


// MARK: - Event Handlers
  const handleToggle = () => {
    const newState = !isOpen;
    if (onToggle) {
      onToggle(newState);
    } else {
      setInternalOpen(newState);
    }
  };

  // Auto-scroll into view when opened

// MARK: - Hooks & Effects
  useEffect(() => {
    if (isOpen && sectionRef.current) {
      setTimeout(() => {
        sectionRef.current?.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'nearest' 
        });
      }, 250);
    }
  }, [isOpen]);

  const paddingClass = size === 'tall' ? 'py-[22px] px-4' : 'p-4';


// MARK: - Main Render
  return (
    <div ref={sectionRef} id={id} className="bg-zinc-900/50 rounded-xl overflow-hidden">
      <button
  onClick={handleToggle}
  className={`w-full flex items-center justify-between ${paddingClass} hover:bg-zinc-800/50 transition relative overflow-hidden`}
>
  {videoBg && (
    <>
      <video
        autoPlay
        loop
        muted
        playsInline
        className="absolute inset-0 w-full h-full object-cover z-0"
      >
        <source src={videoBg} type="video/webm" />
      </video>
      <div className="absolute inset-0 bg-gradient-to-r from-pink-900/60 via-purple-900/50 to-black/60 z-[1]"></div>
    </>
  )}
        <div className="flex items-center gap-3 relative z-[2]">
  {icon && <span className="text-zinc-400">{icon}</span>}
  <span className="font-medium">{title}</span>
</div>
        <div className="relative z-[2]">
        {isOpen ? (
          <svg className={`w-5 h-5 transition-all duration-200 ${dashboardType === 'vendor' ? 'text-emerald-400' : 'text-violet-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 12H4" />
          </svg>
        ) : (
          <svg className={`w-5 h-5 transition-all duration-200 ${dashboardType === 'vendor' ? 'text-emerald-400' : 'text-violet-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
          </svg>
        )}
        </div>
</button>
      <div
        className={`transition-all duration-200 ease-in-out overflow-hidden ${
          isOpen ? 'max-h-[2000px] opacity-100' : 'max-h-0 opacity-0'
        }`}
      >
        <div className="px-0 pt-2">
          {children}
        </div>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/CSVImportModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useCallback } from 'react';
import Papa from 'papaparse';


// MARK: - Types & Interfaces
interface CSVImportModalProps {
  isOpen: boolean;
  onClose: () => void;
  onImport: (data: Record<string, string>[]) => Promise<{ success: number; failed: number; errors: string[] }>;
  templateColumns: string[];
  requiredColumns: string[];
  templateName: string;
}

interface ParsedRow {
  data: Record<string, string>;
  errors: string[];
  rowIndex: number;
}


// MARK: - Component Definition
export default function CSVImportModal({
  isOpen,
  onClose,
  onImport,
  templateColumns,
  requiredColumns,
  templateName
}: CSVImportModalProps) {
  // All hooks must be called before any conditional returns
  const [file, setFile] = useState<File | null>(null);
  const [parsedData, setParsedData] = useState<ParsedRow[]>([]);
  const [parseErrors, setParseErrors] = useState<string[]>([]);

// MARK: - State Management
  const [importing, setImporting] = useState(false);
  const [progress, setProgress] = useState(0);
  const [result, setResult] = useState<{ success: number; failed: number; errors: string[] } | null>(null);
  const [isDragging, setIsDragging] = useState(false);


// MARK: - Event Handlers
  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
  }, []);

  const handleDragOver = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(true);
  }, []);

  const handleDragLeave = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
  }, []);

  // Early return after all hooks
  if (!isOpen) return null;

  const resetState = () => {
    setFile(null);
    setParsedData([]);
    setParseErrors([]);
    setResult(null);
    setProgress(0);
  };

  const handleFile = (selectedFile: File) => {
    if (!selectedFile.name.toLowerCase().endsWith('.csv')) {
      setParseErrors(['Please select a CSV file']);
      return;
    }

    setFile(selectedFile);
    setParseErrors([]);
    setParsedData([]);
    setResult(null);

    Papa.parse(selectedFile, {
      header: true,
      skipEmptyLines: true,
      transformHeader: (header) => header.trim().toLowerCase(),
      complete: (results) => {
        const errors: string[] = [];

        // Check for required columns
        const headers = results.meta.fields || [];
        const normalizedRequired = requiredColumns.map(c => c.toLowerCase());
        const missingColumns = normalizedRequired.filter(col => !headers.includes(col));

        if (missingColumns.length > 0) {
          errors.push(`Missing required columns: ${missingColumns.join(', ')}`);
        }

        // Parse errors from Papa Parse
        if (results.errors.length > 0) {
          results.errors.slice(0, 5).forEach(err => {
            errors.push(`Row ${(err.row || 0) + 2}: ${err.message}`);
          });
        }

        if (errors.length > 0) {
          setParseErrors(errors);
          return;
        }

        // Validate each row
        const parsed: ParsedRow[] = (results.data as Record<string, string>[]).map((row, index) => {
          const rowErrors: string[] = [];

          // Validate required fields
          normalizedRequired.forEach(col => {
            if (!row[col] || row[col].trim() === '') {
              rowErrors.push(`${col} is required`);
            }
          });

          // Validate price if present
          if (row.price !== undefined) {
            const price = parseFloat(row.price);
            if (isNaN(price) || price < 0) {
              rowErrors.push('price must be a valid positive number');
            }
          }

          // Validate quantity if present
          if (row.quantity !== undefined && row.quantity !== '') {
            const qty = parseInt(row.quantity);
            if (isNaN(qty) || qty < 0) {
              rowErrors.push('quantity must be a non-negative integer');
            }
          }

          return {
            data: row,
            errors: rowErrors,
            rowIndex: index + 2 // +2 for header row and 0-index
          };
        });

        setParsedData(parsed);
      },
      error: (error) => {
        setParseErrors([`Failed to parse CSV: ${error.message}`]);
      }
    });
  };

  // Handle file drop - wrapper that calls handleFile
  const onFileDrop = (e: React.DragEvent) => {
    handleDrop(e);
    const droppedFile = e.dataTransfer.files[0];
    if (droppedFile) handleFile(droppedFile);
  };

  const handleImport = async () => {
    const validRows = parsedData.filter(row => row.errors.length === 0);
    if (validRows.length === 0) return;

    setImporting(true);
    setProgress(0);

    try {
      // Simulate progress updates
      const progressInterval = setInterval(() => {
        setProgress(p => Math.min(p + 10, 90));
      }, 200);

      const importResult = await onImport(validRows.map(r => r.data));

      clearInterval(progressInterval);
      setProgress(100);
      setResult(importResult);
    } catch (err: any) {
      setResult({
        success: 0,
        failed: validRows.length,
        errors: [err.message || 'Import failed']
      });
    } finally {
      setImporting(false);
    }
  };

  const downloadTemplate = () => {
    const csv = Papa.unparse({
      fields: templateColumns,
      data: [
        // Example row
        templateColumns.reduce((acc, col) => {
          if (col === 'name') acc[col] = 'Example Product';
          else if (col === 'price') acc[col] = '9.99';
          else if (col === 'category') acc[col] = 'Category';
          else if (col === 'barcode') acc[col] = '5901234123457';
          else if (col === 'sku') acc[col] = 'SKU001';
          else if (col === 'quantity') acc[col] = '100';
          else if (col === 'low_stock_threshold') acc[col] = '10';
          else acc[col] = '';
          return acc;
        }, {} as Record<string, string>)
      ]
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${templateName}-template.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const validCount = parsedData.filter(r => r.errors.length === 0).length;
  const invalidCount = parsedData.filter(r => r.errors.length > 0).length;


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
      <div className="bg-zinc-900 border border-zinc-800 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="p-6 border-b border-zinc-800 flex items-center justify-between">
          <h2 className="text-xl font-bold text-white">Import {templateName}</h2>
          <button onClick={onClose} className="text-zinc-400 hover:text-white transition">
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto flex-1">
          {/* Template download */}
          <div className="mb-6">
            <button
              onClick={downloadTemplate}
              className="text-emerald-400 hover:text-emerald-300 text-sm flex items-center gap-2 transition"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              Download CSV Template
            </button>
            <p className="text-zinc-500 text-xs mt-1">
              Required columns: {requiredColumns.join(', ')}
            </p>
          </div>

          {/* Drop zone */}
          {!file && !result && (
            <div
              onDrop={onFileDrop}
              onDragOver={handleDragOver}
              onDragLeave={handleDragLeave}
              className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors ${
                isDragging
                  ? 'border-emerald-500 bg-emerald-500/10'
                  : 'border-zinc-700 hover:border-zinc-600'
              }`}
            >
              <svg className="w-12 h-12 text-zinc-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p className="text-zinc-400 mb-2">Drag and drop your CSV file here</p>
              <p className="text-zinc-500 text-sm mb-4">or</p>
              <label className="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 rounded-lg cursor-pointer transition">
                Browse Files
                <input
                  type="file"
                  accept=".csv"
                  onChange={(e) => e.target.files?.[0] && handleFile(e.target.files[0])}
                  className="hidden"
                />
              </label>
            </div>
          )}

          {/* File selected indicator */}
          {file && !result && (
            <div className="flex items-center gap-3 mb-4 p-3 bg-zinc-800 rounded-lg">
              <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <span className="text-white flex-1 truncate">{file.name}</span>
              <button
                onClick={resetState}
                className="text-zinc-400 hover:text-white transition"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          )}

          {/* Parse errors */}
          {parseErrors.length > 0 && (
            <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
              <p className="text-red-400 font-medium mb-2">Errors found:</p>
              <ul className="text-sm text-red-300 space-y-1">
                {parseErrors.map((err, i) => (
                  <li key={i}>{err}</li>
                ))}
              </ul>
            </div>
          )}

          {/* Preview */}
          {parsedData.length > 0 && !result && (
            <div>
              {/* Summary */}
              <div className="flex gap-4 mb-4">
                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg px-4 py-2">
                  <span className="text-emerald-400 font-bold">{validCount}</span>
                  <span className="text-zinc-400 text-sm ml-2">valid rows</span>
                </div>
                {invalidCount > 0 && (
                  <div className="bg-red-500/10 border border-red-500/30 rounded-lg px-4 py-2">
                    <span className="text-red-400 font-bold">{invalidCount}</span>
                    <span className="text-zinc-400 text-sm ml-2">invalid rows</span>
                  </div>
                )}
              </div>

              {/* Preview table */}
              <div className="border border-zinc-800 rounded-lg overflow-hidden max-h-64 overflow-y-auto">
                <table className="w-full text-sm">
                  <thead className="bg-zinc-800 sticky top-0">
                    <tr>
                      <th className="px-3 py-2 text-left text-zinc-400 w-12">Row</th>
                      <th className="px-3 py-2 text-left text-zinc-400">Name</th>
                      <th className="px-3 py-2 text-left text-zinc-400">Price</th>
                      <th className="px-3 py-2 text-left text-zinc-400">Category</th>
                      <th className="px-3 py-2 text-left text-zinc-400 w-20">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {parsedData.slice(0, 50).map((row) => (
                      <tr key={row.rowIndex} className="border-t border-zinc-800">
                        <td className="px-3 py-2 text-zinc-500">{row.rowIndex}</td>
                        <td className="px-3 py-2 text-white truncate max-w-[150px]">
                          {row.data.name || '-'}
                        </td>
                        <td className="px-3 py-2 text-white">
                          {row.data.price ? `¬£${parseFloat(row.data.price).toFixed(2)}` : '-'}
                        </td>
                        <td className="px-3 py-2 text-zinc-400 truncate max-w-[100px]">
                          {row.data.category || '-'}
                        </td>
                        <td className="px-3 py-2">
                          {row.errors.length === 0 ? (
                            <span className="text-emerald-400 text-xs">Valid</span>
                          ) : (
                            <span
                              className="text-red-400 text-xs cursor-help"
                              title={row.errors.join(', ')}
                            >
                              Invalid
                            </span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {parsedData.length > 50 && (
                  <div className="p-3 text-center text-zinc-500 text-sm bg-zinc-800/50">
                    Showing first 50 of {parsedData.length} rows
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Progress */}
          {importing && (
            <div className="mt-4">
              <div className="flex justify-between text-sm mb-2">
                <span className="text-zinc-400">Importing products...</span>
                <span className="text-white">{progress}%</span>
              </div>
              <div className="h-2 bg-zinc-800 rounded-full overflow-hidden">
                <div
                  className="h-full bg-emerald-500 transition-all duration-300"
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>
          )}

          {/* Result */}
          {result && (
            <div className="mt-4">
              <div className={`rounded-lg p-4 ${
                result.failed === 0
                  ? 'bg-emerald-500/10 border border-emerald-500/30'
                  : 'bg-amber-500/10 border border-amber-500/30'
              }`}>
                <div className="flex items-center gap-2 mb-2">
                  {result.failed === 0 ? (
                    <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                    </svg>
                  ) : (
                    <svg className="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                  )}
                  <p className={`font-medium ${result.failed === 0 ? 'text-emerald-400' : 'text-amber-400'}`}>
                    Import Complete
                  </p>
                </div>
                <p className="text-sm text-zinc-400">
                  {result.success} product{result.success !== 1 ? 's' : ''} imported successfully
                  {result.failed > 0 && `, ${result.failed} failed`}
                </p>
                {result.errors.length > 0 && (
                  <ul className="mt-3 text-sm text-red-400 space-y-1 max-h-32 overflow-y-auto">
                    {result.errors.slice(0, 10).map((err, i) => (
                      <li key={i} className="truncate">{err}</li>
                    ))}
                    {result.errors.length > 10 && (
                      <li className="text-zinc-500">...and {result.errors.length - 10} more errors</li>
                    )}
                  </ul>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-6 border-t border-zinc-800 flex gap-3">
          {!result ? (
            <>
              <button
                onClick={onClose}
                className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl transition"
              >
                Cancel
              </button>
              <button
                onClick={handleImport}
                disabled={validCount === 0 || importing}
                className="flex-1 bg-emerald-500 hover:bg-emerald-400 disabled:opacity-50 disabled:cursor-not-allowed text-black font-bold py-3 rounded-xl transition"
              >
                {importing ? (
                  <span className="flex items-center justify-center gap-2">
                    <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                    </svg>
                    Importing...
                  </span>
                ) : (
                  `Import ${validCount} Product${validCount !== 1 ? 's' : ''}`
                )}
              </button>
            </>
          ) : (
            <>
              <button
                onClick={() => {
                  resetState();
                }}
                className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl transition"
              >
                Import More
              </button>
              <button
                onClick={onClose}
                className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-3 rounded-xl transition"
              >
                Done
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/DashboardHeader.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import Logo from '@/components/Logo';


// MARK: - Types & Interfaces
interface DashboardHeaderProps {
  walletAddress?: string;
  storeId?: string;
  onSignOut?: () => void;
  showBalances?: boolean;
  onToggleBalances?: () => void;
  dashboardType?: 'vendor' | 'affiliate';
  allMilestonesComplete?: boolean;
  setupComplete?: boolean;
}

// Eye icon component

// MARK: - Component Definition
const EyeIcon = ({ open }: { open: boolean }) => (
  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    {open ? (
      <>
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
      </>
    ) : (
      <>
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
      </>
    )}
  </svg>
);

export default function DashboardHeader({ walletAddress, storeId, onSignOut, showBalances = false, onToggleBalances, dashboardType = 'vendor', allMilestonesComplete = false, setupComplete = false }: DashboardHeaderProps) {
  const router = useRouter();
  const shortWallet = walletAddress 
    ? `${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`
    : null;
  const isConnected = !!walletAddress;


// MARK: - Main Render
  return (
    <header className={`fixed top-0 left-0 right-0 z-40 backdrop-blur-sm w-full overflow-hidden ${
  allMilestonesComplete
    ? 'border-b border-purple-500/50'
    : dashboardType === 'vendor' 
      ? 'bg-gradient-to-r from-emerald-300/55 via-emerald-500/50 via-green-600/45 to-green-900/50 border-b border-emerald-400/50'
      : 'bg-gradient-to-r from-lime-300/50 via-teal-400/50 via-cyan-400/55 via-blue-500/55 to-violet-500/60 border-b border-cyan-400/50'
}`}>
      {/* Video background when all milestones complete */}
{allMilestonesComplete && (
  <video
    autoPlay
    loop
    muted
    playsInline
    className="absolute inset-0 w-full h-full object-cover -z-10"
    style={{ filter: 'brightness(0.6)' }}
  >
    <source src="/nebula-bgActivityButton.webm" type="video/webm" />
  </video>
)}
      <div className="px-6 py-3 flex items-center justify-between w-full max-w-full">
<div className="flex items-center gap-3">
  {/* Mobile hamburger - only show when logged in */}
  {isConnected && (
    <button 
      className="lg:hidden text-zinc-400 hover:text-white p-2 -ml-3 landscape:-ml-5"

// MARK: - Event Handlers
      onClick={() => {
        const event = new CustomEvent('toggleSidebar');
        window.dispatchEvent(event);
      }}
    >
      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  )}
  <Link href="/" className="flex items-center hover:opacity-80 md:ml-12 gap-3">
  {!walletAddress && dashboardType === 'vendor' && (
    <img src="https://yesallofus.com/dltpayslogo1.png" alt="YesAllofUs" className="w-8 h-8 rounded-lg" />
  )}
  <span className={`font-bold text-white text-xl ${isConnected ? 'hidden md:block' : 'block'}`}>YesAllofUs</span>
{setupComplete && (
  <span className="hidden md:inline-flex landscape:inline-flex items-center gap-1 bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 text-xs font-semibold px-2 py-0.5 rounded-full ml-2">
    <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
    Live
  </span>
)}
</Link>

{/* Logo flush top-left - desktop/tablet only, logged in only */}
{walletAddress && (
  <div className="hidden md:block absolute top-0 left-0 z-50 h-full">
    <img 
      src="https://yesallofus.com/dltpayslogo1.png" 
      alt="YesAllofUs" 
      className="h-full w-auto object-cover" 
    />
  </div>
)}
</div>
        <div className="flex items-center gap-2">
          {isConnected && storeId && (
            <>
              {/* Take Payment */}
              <div className="relative group">
                <button
                  onClick={() => router.push('/take-payment')}
                  className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                  </svg>
                </button>
                <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                  Take Payment
                </span>
              </div>

              {/* Analytics */}
              <div className="relative group">
                <button
                  onClick={() => router.push('/analytics')}
                  className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                </button>
                <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                  Analytics
                </span>
              </div>

              {/* Receipts */}
              <div className="relative group">
                <button
                  onClick={() => router.push('/receipts')}
                  className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </button>
                <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                  Receipts
                </span>
              </div>

              {/* Customer Display */}
              <div className="relative group">
                <button
                  onClick={() => window.open(`/display?store=${storeId}`, '_blank')}
                  className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </button>
                <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                  Customer Display
                </span>
              </div>

              {/* Staff */}
              <div className="relative group">
                <button
                  onClick={() => router.push('/staffpos')}
                  className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </button>
                <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                  Staff
                </span>
              </div>

              <div className="w-px h-6 bg-zinc-700 mx-1"></div>
            </>
          )}

          {/* Eye icon - show/hide balances */}
{isConnected && onToggleBalances && (
  <div className="relative group">
    <button
      id="balance-toggle"
      onClick={onToggleBalances}
      className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
    >
      <EyeIcon open={showBalances} />
    </button>
              <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                {showBalances ? 'Hide balances' : 'Show balances'}
              </span>
            </div>
          )}

          {isConnected ? (
  <>
    <div className="hidden md:flex items-center gap-2 bg-zinc-800 px-3 py-1.5 rounded-lg">
      <div className="w-2 h-2 bg-emerald-500 rounded-full"></div>
      <span className="text-zinc-300 text-xs font-mono">{shortWallet}</span>
    </div>
    {onSignOut && (
      <button
onClick={onSignOut}
className="text-zinc-300 hover:text-white text-sm px-3 py-1.5 hidden md:block"
>
        Sign out
</button>
    )}
  </>
) : (
  <div className="hidden md:flex items-center gap-2 bg-zinc-800 px-3 py-1.5 rounded-lg">
    <div className="w-2 h-2 bg-red-500 rounded-full"></div>
    <span className="text-zinc-400 text-xs">Not connected</span>
  </div>
)}
        </div>
      </div>
    </header>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/DeleteConfirmModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState } from 'react';


// MARK: - Types & Interfaces
interface DeleteConfirmModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title?: string;
  description?: string;
  confirmText?: string;
  loading?: boolean;
}


// MARK: - Component Definition
export default function DeleteConfirmModal({
  isOpen,
  onClose,
  onConfirm,
  title = 'Delete Data',
  description = 'This will permanently delete all your data. This action cannot be undone.',
  confirmText = 'DELETE',
  loading = false
}: DeleteConfirmModalProps) {

// MARK: - State Management
  const [inputValue, setInputValue] = useState('');
  const [step, setStep] = useState<'warning' | 'confirm'>('warning');


// MARK: - Event Handlers
  const handleClose = () => {
    setStep('warning');
    setInputValue('');
    onClose();
  };

  const handleProceed = () => {
    setStep('confirm');
  };

  const handleConfirm = () => {
    if (inputValue === confirmText) {
      onConfirm();
    }
  };

  if (!isOpen) return null;


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-zinc-900 border border-red-500/30 rounded-2xl max-w-md w-full overflow-hidden shadow-2xl shadow-red-500/10">
        {/* Header */}
        <div className="bg-gradient-to-r from-red-500/20 to-orange-500/10 border-b border-red-500/20 px-6 py-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-red-500/20 rounded-xl flex items-center justify-center">
              <svg className="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
            </div>
            <div>
              <h2 className="text-lg font-bold text-white">{title}</h2>
              <p className="text-red-400 text-sm">This action is irreversible</p>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-6">
          {step === 'warning' ? (
            <>
              <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-4 mb-6">
                <div className="flex gap-3">
                  <svg className="w-5 h-5 text-red-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                  </svg>
                  <p className="text-zinc-300 text-sm leading-relaxed">{description}</p>
                </div>
              </div>

              <div className="space-y-3 mb-6">
                <div className="flex items-center gap-3 text-zinc-400 text-sm">
                  <svg className="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  <span>All affiliate connections removed</span>
                </div>
                <div className="flex items-center gap-3 text-zinc-400 text-sm">
                  <svg className="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  <span>Earnings history deleted</span>
                </div>
                <div className="flex items-center gap-3 text-zinc-400 text-sm">
                  <svg className="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  <span>Wallet disconnected</span>
                </div>
                <div className="flex items-center gap-3 text-zinc-400 text-sm">
                  <svg className="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  <span>NFC cards unlinked</span>
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={handleClose}
                  className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-medium py-3 rounded-xl transition"
                >
                  Cancel
                </button>
                <button
                  onClick={handleProceed}
                  className="flex-1 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 text-red-400 font-medium py-3 rounded-xl transition"
                >
                  Continue
                </button>
              </div>
            </>
          ) : (
            <>
              <p className="text-zinc-400 text-sm mb-4">
                Type <span className="text-red-400 font-mono font-bold">{confirmText}</span> to confirm deletion:
              </p>

              <input
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value.toUpperCase())}
                placeholder={confirmText}
                className="w-full bg-zinc-800 border border-zinc-700 focus:border-red-500/50 rounded-xl px-4 py-3 text-white font-mono text-center text-lg tracking-widest placeholder:text-zinc-600 outline-none transition mb-6"
                autoFocus
              />

              <div className="flex gap-3">
                <button
                  onClick={handleClose}
                  className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-medium py-3 rounded-xl transition"
                >
                  Cancel
                </button>
                <button
                  onClick={handleConfirm}
                  disabled={inputValue !== confirmText || loading}
                  className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-zinc-700 disabled:text-zinc-500 text-white font-semibold py-3 rounded-xl transition flex items-center justify-center gap-2"
                >
                  {loading ? (
                    <>
                      <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                      Deleting...
                    </>
                  ) : (
                    <>
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                      </svg>
                      Delete Forever
                    </>
                  )}
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/EarnInterest.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useRouter } from 'next/navigation';
import { useState, useEffect, useRef } from 'react';

// Product data - same as earn page
const products = [
  {
    id: 'flexible-savings',
    name: 'Flexible Savings',
    description: 'No lock-up, withdraw anytime',
    fullDescription: 'Earn daily interest with no lock-up. Withdraw anytime.',
    apy: '4.5%',
    risk: 'Low' as const,
    lockPeriod: 'None',
    minDeposit: '$10',
    color: 'emerald',
    features: ['Daily interest accrual', 'Instant withdrawals', 'No minimum lock', 'Compound earnings']
  },
  {
    id: 'fixed-30',
    name: '30-Day Fixed',
    description: 'Higher returns with 30-day lock',
    fullDescription: 'Lock your funds for 30 days for higher returns.',
    apy: '5.2%',
    risk: 'Low' as const,
    lockPeriod: '30 Days',
    minDeposit: '$50',
    color: 'sky',
    features: ['Guaranteed rate', 'Auto-renewal option', 'Early exit penalty: 1%', 'Interest paid at maturity']
  },
  {
    id: 'fixed-90',
    name: '90-Day Fixed',
    description: 'Best balance of yield & flexibility',
    fullDescription: 'Our most popular product. Great balance of yield and flexibility.',
    apy: '6.0%',
    risk: 'Low' as const,
    lockPeriod: '90 Days',
    minDeposit: '$100',
    color: 'indigo',
    features: ['Best fixed rate', 'Monthly interest payouts', 'Early exit penalty: 2%', 'Priority support']
  },
  {
    id: 'fixed-180',
    name: '180-Day Fixed',
    description: 'Maximum returns for patient investors.',
    fullDescription: 'Maximum returns for patient investors.',
    apy: '7.0%',
    risk: 'Low' as const,
    lockPeriod: '180 Days',
    minDeposit: '$250',
    color: 'purple',
    features: ['Highest fixed APY', 'Monthly compounding', 'Early exit penalty: 3%', 'VIP support']
  },
  {
    id: 'liquidity-pool',
    name: 'Liquidity Pools',
    description: 'Earn trading fees plus rewards',
    fullDescription: 'Provide liquidity and earn trading fees plus rewards.',
    apy: '8-12%',
    risk: 'Medium' as const,
    lockPeriod: 'Flexible',
    minDeposit: '$100',
    color: 'cyan',
    features: ['Variable APY', 'Trading fee share', 'Impermanent loss risk', 'Bonus rewards']
  },
  {
    id: 'staking',
    name: 'XRP Staking',
    description: 'Network rewards',
    fullDescription: 'Stake XRP and earn rewards while supporting the network.',
    apy: '3.2%',
    risk: 'Low' as const,
    lockPeriod: '7 Days',
    minDeposit: '100 XRP',
    color: 'amber',
    features: ['Network rewards', '7-day unbonding', 'Auto-compound option', 'No slashing risk']
  }
];

const productColors: Record<string, { bg: string; border: string; text: string }> = {
  emerald: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', text: 'text-emerald-400' },
  sky: { bg: 'bg-sky-500/10', border: 'border-sky-500/20', text: 'text-sky-400' },
  indigo: { bg: 'bg-indigo-500/10', border: 'border-indigo-500/20', text: 'text-indigo-400' },
  purple: { bg: 'bg-purple-500/10', border: 'border-purple-500/20', text: 'text-purple-400' },
  cyan: { bg: 'bg-cyan-500/10', border: 'border-cyan-500/20', text: 'text-cyan-400' },
  amber: { bg: 'bg-amber-500/10', border: 'border-amber-500/20', text: 'text-amber-400' }
};

const riskColors = {
  Low: 'text-emerald-400 bg-emerald-500/20',
  Medium: 'text-amber-400 bg-amber-500/20',
  High: 'text-red-400 bg-red-500/20'
};

// Stable Asset Exchange Logo SVG

// MARK: - Component Definition
const StableAssetLogo = ({ className = "w-10 h-10" }: { className?: string }) => (
  <svg className={className} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="48" height="48" rx="12" fill="url(#sae-gradient)" />
    <path 
      d="M14 24C14 18.477 18.477 14 24 14V14C29.523 14 34 18.477 34 24V24C34 29.523 29.523 34 24 34V34C18.477 34 14 29.523 14 24V24Z" 
      stroke="white" 
      strokeWidth="2"
    />
    <path 
      d="M24 18V30M18 24H30" 
      stroke="white" 
      strokeWidth="2" 
      strokeLinecap="round"
    />
    <circle cx="24" cy="24" r="3" fill="white" />
    <defs>
      <linearGradient id="sae-gradient" x1="0" y1="0" x2="48" y2="48" gradientUnits="userSpaceOnUse">
        <stop stopColor="#6366f1" />
        <stop offset="1" stopColor="#8b5cf6" />
      </linearGradient>
    </defs>
  </svg>
);

// Small product card component
const SmallProductCard = ({ product, onClick }: { product: typeof products[0]; onClick: () => void }) => {
  const colors = productColors[product.color];

// MARK: - Main Render
  return (
    <button

// MARK: - Event Handlers
      onClick={onClick}
      className={`w-full ${colors.bg} border ${colors.border} rounded-lg p-3 text-left hover:scale-[1.01] transition-all`}
    >
      <div className="flex items-center justify-between">
        <div className="flex-1 min-w-0">
          <h4 className="font-medium text-white text-sm">{product.name}</h4>
          <p className="text-zinc-500 text-xs truncate">{product.description}</p>
        </div>
        <p className={`font-bold ${colors.text} ml-3`}>{product.apy}</p>
      </div>
    </button>
  );
};

// Full product modal component
const FullProductModal = ({ product }: { product: typeof products[0] }) => {
  const colors = productColors[product.color];
  return (
    <div className={`${colors.bg} border ${colors.border} rounded-xl p-4`}>
      <div className="flex items-start justify-between mb-3">
        <div>
          <h4 className="font-bold text-white">{product.name}</h4>
          <p className="text-zinc-400 text-sm">{product.fullDescription}</p>
        </div>
        <span className={`text-xs px-2 py-1 rounded-full ${riskColors[product.risk]}`}>
          {product.risk} Risk
        </span>
      </div>
      <div className="grid grid-cols-3 gap-2 mb-3">
        <div className="bg-zinc-900/50 rounded-lg p-2 text-center">
          <p className="text-zinc-500 text-xs">APY</p>
          <p className={`font-bold ${colors.text}`}>{product.apy}</p>
        </div>
        <div className="bg-zinc-900/50 rounded-lg p-2 text-center">
          <p className="text-zinc-500 text-xs">Lock</p>
          <p className="font-bold text-white text-sm">{product.lockPeriod}</p>
        </div>
        <div className="bg-zinc-900/50 rounded-lg p-2 text-center">
          <p className="text-zinc-500 text-xs">Min</p>
          <p className="font-bold text-white text-sm">{product.minDeposit}</p>
        </div>
      </div>
      <div className="space-y-1">
        {product.features.map((feature, i) => (
          <div key={i} className="flex items-center gap-2 text-xs text-zinc-300">
            <svg className="w-3 h-3 text-emerald-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
            {feature}
          </div>
        ))}
      </div>
    </div>
  );
};


// MARK: - Types & Interfaces
interface EarnInterestProps {
  noBorder?: boolean;
  rightColumnRef?: React.RefObject<HTMLDivElement | null>;
  openSections?: Record<string, boolean>;
  dashboardType?: 'vendor' | 'affiliate';
}

// Base height of the card without products (header + stats + button + footer)
const BASE_HEIGHT = 320;
// Height of each small product card
const SMALL_CARD_HEIGHT = 60;
// Height of each full modal
const FULL_MODAL_HEIGHT = 220;

export default function EarnInterest({ noBorder = false, rightColumnRef, openSections = {}, dashboardType = 'vendor' }: EarnInterestProps) {
  const router = useRouter();
  const containerRef = useRef<HTMLDivElement>(null);

// MARK: - State Management
  const [isTwoColumn, setIsTwoColumn] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    const checkLayout = () => {
      setIsTwoColumn(window.innerWidth >= 1024);
    };
    checkLayout();
    window.addEventListener('resize', checkLayout);

    return () => {
      window.removeEventListener('resize', checkLayout);
    };
  }, []);

  // Calculate how many sections are open
  const openCount = Object.values(openSections).filter(Boolean).length;

  // Calculate what to show based on open sections
  let smallCardsCount = 0;
  let fullModalsCount = 0;

  if (isTwoColumn && openCount > 0) {
  // Each open section adds roughly 350px of space
  const estimatedExtraHeight = openCount * 350;
  
  // First allocate full modals (they look better with more space)
  fullModalsCount = Math.floor(estimatedExtraHeight / FULL_MODAL_HEIGHT);
  
  // Then fill remaining space with small cards
  const remainingHeight = estimatedExtraHeight - (fullModalsCount * FULL_MODAL_HEIGHT);
  smallCardsCount = Math.floor(remainingHeight / SMALL_CARD_HEIGHT);
  
  // Cap totals to available products
  const totalProducts = products.length;
  fullModalsCount = Math.min(fullModalsCount, totalProducts);
  smallCardsCount = Math.min(smallCardsCount, Math.max(0, totalProducts - fullModalsCount));
}

  const smallCards = products.slice(0, smallCardsCount);
  const fullModals = products.slice(smallCardsCount, smallCardsCount + fullModalsCount);

  return (
    <div 
      ref={containerRef}
      className={`h-full ${noBorder ? "" : "bg-gradient-to-br from-indigo-500/10 to-purple-500/10 border border-indigo-500/30 rounded-xl p-6 mb-6"}`}
    >
      <div className="flex items-start gap-4">
        <StableAssetLogo className="w-12 h-12 flex-shrink-0" />
        <div className="flex-1">
          <div className="flex items-center justify-between gap-2 mb-1">
            <h3 className="text-lg font-bold text-white">Earn Interest</h3>
            <span className="bg-indigo-500/20 text-indigo-400 text-xs px-2 py-0.5 rounded-full font-medium whitespace-nowrap">
              Coming Soon
            </span>
          </div>
          <p className="text-zinc-400 text-sm">
            Yield products provided through our regulated partner.
          </p>
        </div>
      </div>

      {/* Preview Stats */}
<div className="grid grid-cols-3 gap-3 mt-5">
  <div className="bg-zinc-900/50 rounded-lg p-3 text-center">
    <p className={`text-xl font-bold ${dashboardType === 'vendor' ? 'text-emerald-400' : 'text-cyan-400'}`}>4.5%</p>
    <p className="text-zinc-500 text-xs">Flexible APY</p>
  </div>
  <div className="bg-zinc-900/50 rounded-lg p-3 text-center">
    <p className={`text-xl font-bold ${dashboardType === 'vendor' ? 'text-teal-400' : 'text-blue-400'}`}>6.0%</p>
    <p className="text-zinc-500 text-xs">90-Day Fixed</p>
  </div>
  <div className="bg-zinc-900/50 rounded-lg p-3 text-center">
    <p className={`text-xl font-bold ${dashboardType === 'vendor' ? 'text-green-400' : 'text-violet-400'}`}>8.5%</p>
    <p className="text-zinc-500 text-xs">Liquidity Pools</p>
  </div>
</div>

      {/* Dynamic product display based on available height */}
      {(smallCards.length > 0 || fullModals.length > 0) && (
        <div className="mt-4 space-y-3">
          {/* Small cards first */}
          {smallCards.length > 0 && (
            <div className="space-y-2">
              {smallCards.map((product) => (
                <SmallProductCard 
                  key={product.id} 
                  product={product} 
                  onClick={() => router.push('/earn')} 
                />
              ))}
            </div>
          )}
          
          {/* Full modals */}
          {fullModals.map((product) => (
            <FullProductModal key={product.id} product={product} />
          ))}
        </div>
      )}

      {/* CTA Button */}
      <button
        onClick={() => router.push('/earn')}
        className="w-full mt-5 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 rounded-xl transition flex items-center justify-center gap-2"
      >
        <span>Explore Products</span>
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
        </svg>
      </button>

      {/* Powered By */}
      <p className="text-zinc-600 text-xs text-center mt-3">
        Powered by Stable Asset Exchange ¬∑ Regulated & Secure
      </p>

      {/* Disclaimer */}
      <div className="mt-4 pt-3 border-t border-zinc-700/50">
        <p className="text-zinc-500 text-[10px] text-center leading-relaxed">
          For presentation purposes only. This is not a live product.
        </p>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/EmailReceiptModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Types & Interfaces
interface EmailReceiptModalProps {
  isOpen: boolean;
  onClose: () => void;
  receiptId?: string;
  txHash?: string;
  storeName: string;
  storeId?: string;
  amount: number;
  rlusdAmount?: number;
  items?: Array<{ name: string; quantity: number; unit_price: number }>;
  tipAmount?: number;
  conversionRate?: {
    rlusd_gbp: number;
    source: string;
    captured_at: string;
  };
  walletAddress?: string;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';

// Email validation regex
const isValidEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);


// MARK: - Component Definition
export default function EmailReceiptModal({
  isOpen,
  onClose,
  receiptId,
  txHash,
  storeName,
  storeId,
  amount,
  rlusdAmount,
  items,
  tipAmount,
  conversionRate,
  walletAddress
}: EmailReceiptModalProps) {

// MARK: - State Management
  const [emailAddress, setEmailAddress] = useState('');
  const [sending, setSending] = useState(false);
  const [sent, setSent] = useState(false);
  const [error, setError] = useState<string | null>(null);

  if (!isOpen) return null;


// MARK: - Event Handlers
  const handleSend = async () => {
    if (!emailAddress || !isValidEmail(emailAddress)) {
      setError('Please enter a valid email address');
      return;
    }

    setSending(true);
    setError(null);

    try {
      let payload: any = {
  email: emailAddress,
  store_name: storeName,
  store_id: storeId,
  amount,
  rlusd_amount: rlusdAmount,
  items: items || [],
  tip_amount: tipAmount || 0,
  tx_hash: txHash,
  conversion_rate: conversionRate
};

      if (receiptId) {
        const url = walletAddress
          ? `${API_URL}/receipts/${receiptId}?wallet_address=${walletAddress}`
          : `${API_URL}/receipts/${receiptId}`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`Failed to fetch receipt: ${res.status}`);
        }
        const data = await res.json();
        if (data.success && data.receipt) {
          const r = data.receipt;
          payload = {
            email: emailAddress,
            store_name: r.store_name || storeName,
            store_id: r.store_id || storeId,
            amount: r.total,
            rlusd_amount: r.amount_rlusd,
            items: r.items,
            tip_amount: r.tip_amount,
            tx_hash: r.payment_tx_hash || txHash,
            receipt_number: r.receipt_number,
            conversion_rate: r.conversion_rate,
            rate_source: r.conversion_rate?.source,
            rate_timestamp: r.conversion_rate?.captured_at
          };
        }
      }

      const emailRes = await fetch(`${API_URL}/receipt/email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!emailRes.ok) {
        throw new Error(`Failed to send email: ${emailRes.status}`);
      }

      setSent(true);
      setTimeout(() => {
        onClose();
        setEmailAddress('');
        setSent(false);
      }, 2000);
    } catch (err) {
      setError('Failed to send email. Please try again.');
    } finally {
      setSending(false);
    }
  };

  const handleClose = () => {
    onClose();
    setEmailAddress('');
    setError(null);
    setSent(false);
  };


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-6">
      <div className="bg-gradient-to-b from-zinc-900 to-zinc-950 border border-zinc-800 rounded-3xl p-8 w-full max-w-sm shadow-2xl shadow-black/50">
        
        {sent ? (
          /* Success State */
          <div className="text-center py-4">
            <div className="w-20 h-20 bg-gradient-to-br from-emerald-500/20 to-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
              <svg className="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-white mb-2">Receipt Sent!</h2>
            <p className="text-zinc-400">Check your inbox at</p>
            <p className="text-emerald-400 font-medium mt-1">{emailAddress}</p>
          </div>
        ) : (
          <>
            {/* Header */}
            <div className="text-center mb-8">
              <div className="w-16 h-16 bg-gradient-to-br from-emerald-500/20 to-sky-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
              </div>
              <h2 className="text-2xl font-bold text-white">Email Receipt</h2>
              <p className="text-zinc-500 text-sm mt-1">Get a copy of your receipt</p>
            </div>

            {/* Email Input */}
            <div className="mb-6">
              <label className="block text-zinc-400 text-sm mb-2">Email address</label>
              <div className="relative">
                <div className="absolute left-4 top-1/2 -translate-y-1/2">
                  <svg className="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
                  </svg>
                </div>
                <input
                  type="email"
                  placeholder="you@example.com"
                  value={emailAddress}
                  onChange={(e) => {
                    setEmailAddress(e.target.value);
                    setError(null);
                  }}
                  className="w-full bg-zinc-800/50 border border-zinc-700 rounded-xl pl-12 pr-4 py-4 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/50 transition"
                  autoFocus
                />
              </div>
              {error && (
                <p className="text-red-400 text-sm mt-2 flex items-center gap-1">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  {error}
                </p>
              )}
            </div>

            {/* Receipt Preview */}
            <div className="bg-zinc-800/30 border border-zinc-700/50 rounded-xl p-4 mb-6">
              <div className="flex justify-between items-center text-sm">
                <span className="text-zinc-500">Receipt for</span>
                <span className="text-white font-medium">{storeName}</span>
              </div>
              <div className="flex justify-between items-center text-sm mt-2">
                <span className="text-zinc-500">Amount</span>
                <span className="text-emerald-400 font-bold">¬£{amount.toFixed(2)}</span>
              </div>
            </div>

            {/* Actions */}
            <div className="flex gap-3">
              <button
                onClick={handleClose}
                className="flex-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-4 rounded-xl font-medium transition text-zinc-300"
              >
                Cancel
              </button>
              <button
                onClick={handleSend}
                disabled={sending || !emailAddress}
                className="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-black py-4 rounded-xl font-bold transition disabled:opacity-50 shadow-lg shadow-emerald-500/25 flex items-center justify-center gap-2"
              >
                {sending ? (
                  <>
                    <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin" />
                    Sending...
                  </>
                ) : (
                  <>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    Send
                  </>
                )}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/Footer.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { usePathname } from 'next/navigation';


// MARK: - Component Definition
export default function Footer() {
  const pathname = usePathname();
  
  // Hide on dashboard pages
  if (pathname?.startsWith('/dashboard') || pathname?.startsWith('/affiliate-dashboard')) {
    return null;
  }


// MARK: - Main Render
  return (
    <footer className="bg-[#080808] border-t border-zinc-800">
      {/* Main Footer */}
      <div className="max-w-7xl mx-auto px-6 py-16">
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-8 lg:gap-12">
          
          {/* Brand Column */}
          <div className="col-span-2 md:col-span-4 lg:col-span-1 mb-8 lg:mb-0">
            <a href="/" className="flex items-center gap-3 mb-4">
              <img src="/mark.jpg" alt="Mark" className="w-10 h-10 rounded-full object-cover" />
              <span className="text-white font-bold text-xl">A Product by YesAllofUs</span>
            </a>
            <p className="text-zinc-400 text-sm leading-relaxed mb-6">
              Instant affiliate commissions on the XRP Ledger. Pay your affiliates in seconds, not months.
            </p>
            {/* Social Links */}
            <div className="flex gap-4">
              <a href="https://x.com/YesAllofUs" target="_blank" rel="noopener noreferrer" className="text-zinc-500 hover:text-white transition-colors">
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                </svg>
              </a>
              <a href="https://www.linkedin.com/in/yesallofus-saas-8a154139b/" target="_blank" rel="noopener noreferrer" className="text-zinc-500 hover:text-white transition-colors">
                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
              </a>
              <a href="/blog/attunement" className="text-zinc-500 hover:text-white transition-colors">
  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
  </svg>
</a>
              <a href="mailto:mark@yesallofus.com" className="text-zinc-500 hover:text-white transition-colors">
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </a>
            </div>
            {/* YAOFU Badge */}
            <div className="mt-6">
              <svg viewBox="0 0 140 58" className="w-28 h-14">
                <defs>
                  <linearGradient id="yaofuGradientFooter" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#10b981" />
                    <stop offset="40%" stopColor="#3b82f6" />
                    <stop offset="100%" stopColor="#8b5cf6" />
                  </linearGradient>
                </defs>
                <text x="70" y="12" textAnchor="middle" fill="#52525b" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="500" fontSize="9" letterSpacing="1">
                  BE INSPIRED
                </text>
                <text x="70" y="32" textAnchor="middle" fill="url(#yaofuGradientFooter)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="4">
                  YAOFUS
                </text>
                <text x="70" y="50" textAnchor="middle" fill="#52525b" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="10" letterSpacing="2">
                  INSTANT
                </text>
              </svg>
            </div>
          </div>

          {/* Product Column */}
          <div>
            <h3 className="text-white font-semibold mb-4">Product</h3>
            <ul className="space-y-3">
              <li><a href="/dashboard" className="text-zinc-400 hover:text-white transition-colors text-sm">Vendor</a></li>
              <li><a href="/affiliate-dashboard" className="text-zinc-400 hover:text-white transition-colors text-sm">Affilaites</a></li>
              <li><a href="/discover-vendors" className="text-zinc-400 hover:text-white transition-colors text-sm">Discover Vendors</a></li>
              <li><a href="/home#how-it-works" className="text-zinc-400 hover:text-white transition-colors text-sm">How It Works</a></li>
              <li><a href="/home#pricing" className="text-zinc-400 hover:text-white transition-colors text-sm">Pricing</a></li>
            </ul>
          </div>

          {/* Resources Column */}
          <div>
            <h3 className="text-white font-semibold mb-4">Resources</h3>
            <ul className="space-y-3">
              <li><a href="/wallet-guide" className="text-zinc-400 hover:text-white transition-colors text-sm">Safety | Wallet Guide</a></li>
              <li><a href="/trustline" className="text-zinc-400 hover:text-white transition-colors text-sm">RLUSD Trustline</a></li>
              <li><a href="/resources" className="text-zinc-400 hover:text-white transition-colors text-sm">üìÑ Downloads</a></li>
              <li><a href="/guides/wordpress" className="text-zinc-400 hover:text-white transition-colors text-sm">WP/WooCommerce Guide</a></li>
              <li><a href="/docs" className="text-zinc-400 hover:text-white transition-colors text-sm">API Docs</a></li>
              <li><a href="/faq" className="text-zinc-400 hover:text-white transition-colors text-sm">FAQ</a></li>
            </ul>
          </div>

          {/* Company Column */}
          <div>
            <h3 className="text-white font-semibold mb-4">Start Up</h3>
            <ul className="space-y-3">
              <li><a href="https://calendly.com/tokencanvasio/30min" target="_blank" rel="noopener noreferrer" className="text-zinc-400 hover:text-white transition-colors text-sm">Book a Call</a></li>
              <li><a href="/announcements" className="text-zinc-400 hover:text-white transition-colors text-sm">üì¢ Announcements</a></li>
              <li><a href="/about" className="text-zinc-400 hover:text-white transition-colors text-sm">About</a></li>
              <li><a href="mailto:mark@yesallofus.com" className="text-zinc-400 hover:text-white transition-colors text-sm">Contact</a></li>
              <li><a href="/press" className="text-zinc-400 hover:text-white transition-colors text-sm">Press</a></li>
            </ul>
          </div>

          {/* Legal Column */}
          <div>
            <h3 className="text-white font-semibold mb-4">Legal</h3>
            <ul className="space-y-3">
              <li><a href="/affiliate-terms" className="text-zinc-400 hover:text-white transition-colors text-sm">Affiliate Terms</a></li>
              <li><a href="/terms" className="text-zinc-400 hover:text-white transition-colors text-sm">Terms of Service</a></li>
              <li><a href="/privacy" className="text-zinc-400 hover:text-white transition-colors text-sm">Privacy Policy</a></li>
              <li><a href="/acceptable-use" className="text-zinc-400 hover:text-white transition-colors text-sm">Acceptable Use</a></li>
              <li><a href="/cookies" className="text-zinc-400 hover:text-white transition-colors text-sm">Cookie Policy</a></li>
            </ul>
          </div>

        </div>
      </div>

      {/* Bottom Bar */}
      <div className="border-t border-zinc-800">
        <div className="max-w-7xl mx-auto px-6 py-6">
          <div className="flex flex-col md:flex-row justify-between items-center gap-4">
            <p className="text-zinc-500 text-sm flex items-center gap-2">
  ¬© 2025 YesAllofUs. All rights reserved.
  <img src="/favicon.svg" alt="YesAllofUs" className="w-5 h-5 rounded-md" />
</p>
            <div className="flex items-center gap-6">
              <span className="text-zinc-600 text-sm">Built on</span>
              <a href="https://xrpl.org" target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-zinc-400 hover:text-white transition-colors">
                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0L3 5.5v13L12 24l9-5.5v-13L12 0zm0 2.3l6.5 4v2.7L12 13l-6.5-4V6.3L12 2.3zM5.5 11l6.5 4 6.5-4v2.7L12 17.7l-6.5-4V11z"/>
                </svg>
                <span className="text-sm font-medium">XRP Ledger</span>
              </a>
              <span className="text-zinc-700">|</span>
              <span className="text-zinc-500 text-sm">Guernsey, Channel Islands</span>
            </div>
          </div>
        </div>
      </div>
    </footer>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/Header.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useRef, useEffect } from 'react';
import { usePathname } from 'next/navigation';
import Link from "next/link";
import Logo from "./Logo";


// MARK: - Component Definition
export default function Header() {
  const pathname = usePathname();

// MARK: - State Management
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [resourcesOpen, setResourcesOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Close dropdown when clicking outside

// MARK: - Hooks & Effects
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setResourcesOpen(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Hide on dashboard pages
  if (pathname?.startsWith('/dashboard') || pathname?.startsWith('/affiliate-dashboard')) {
    return null;
  }


// MARK: - Main Render
  return (
    <header className="sticky top-0 z-50 bg-[#0d0d0d]/90 backdrop-blur border-b border-zinc-800/50">
      <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <Link href="/" className="flex items-center gap-3">
          <Logo size={40} />
          <span className="font-bold text-xl hidden sm:inline text-white">YesAllofUs</span>
        </Link>

        {/* Desktop nav */}
        <nav className="hidden md:flex items-center gap-1">
          <Link href="/docs" className="text-zinc-400 hover:text-white text-sm transition px-3 py-2 rounded-lg hover:bg-zinc-800/50">
            Docs
          </Link>
          <button

// MARK: - Event Handlers
  onClick={() => {
    if (pathname === '/' || pathname === '/home') {
      document.getElementById('pricing')?.scrollIntoView({ behavior: 'smooth' });
    } else {
      window.location.href = '/home#pricing';
    }
  }}
  className="text-zinc-400 hover:text-white text-sm transition px-3 py-2 rounded-lg hover:bg-zinc-800/50"
>
  Pricing
</button>
          <Link href="/affiliate-dashboard" className="text-zinc-400 hover:text-white text-sm transition px-3 py-2 rounded-lg hover:bg-zinc-800/50">
  Affiliates
</Link>
          
          {/* Resources Dropdown */}
          <div className="relative" ref={dropdownRef}>
            <button
              onClick={() => setResourcesOpen(!resourcesOpen)}
              className="flex items-center gap-1 text-zinc-400 hover:text-white text-sm transition px-3 py-2 rounded-lg hover:bg-zinc-800/50"
            >
              Resources
              <svg 
                className={`w-4 h-4 transition-transform ${resourcesOpen ? 'rotate-180' : ''}`} 
                fill="none" 
                viewBox="0 0 24 24" 
                stroke="currentColor" 
                strokeWidth={2}
              >
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            
            {resourcesOpen && (
              <div className="absolute top-full right-0 mt-2 w-64 bg-[#141414] border border-zinc-800 rounded-xl shadow-xl shadow-black/20 overflow-hidden">
                {/* Interactive Page */}
                <Link 
                  href="/resources"
                  onClick={() => setResourcesOpen(false)}
                  className="flex items-center gap-3 px-4 py-3 hover:bg-zinc-800/50 transition border-b border-zinc-800/50"
                >
                  <div className="w-8 h-8 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                    <svg className="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </div>
                  <div>
                    <p className="text-white text-sm font-medium">Interactive Guide</p>
                    <p className="text-zinc-500 text-xs">Explore costs & savings</p>
                  </div>
                </Link>

                {/* PDF Downloads */}
                <div className="px-4 py-2">
                  <p className="text-zinc-600 text-xs uppercase tracking-wider mb-2">Download PDFs</p>
                </div>
                
                <a 
                  href="/pdfs/YesAllofUs-Cost-Comparison.pdf"
                  download
                  className="flex items-center gap-3 px-4 py-2.5 hover:bg-zinc-800/50 transition"
                >
                  <div className="w-6 h-6 bg-red-500/20 rounded flex items-center justify-center">
                    <span className="text-xs">üìä</span>
                  </div>
                  <span className="text-zinc-300 text-sm">Cost Comparison</span>
                  <svg className="w-4 h-4 text-zinc-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                </a>
                
                <a 
                  href="/pdfs/YesAllofUs-Savings-Calculator.pdf"
                  download
                  className="flex items-center gap-3 px-4 py-2.5 hover:bg-zinc-800/50 transition"
                >
                  <div className="w-6 h-6 bg-emerald-500/20 rounded flex items-center justify-center">
                    <span className="text-xs">üßÆ</span>
                  </div>
                  <span className="text-zinc-300 text-sm">Savings Calculator</span>
                  <svg className="w-4 h-4 text-zinc-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                </a>
                
                <a 
                  href="/pdfs/YesAllofUs-One-Pager.pdf"
                  download
                  className="flex items-center gap-3 px-4 py-2.5 hover:bg-zinc-800/50 transition"
                >
                  <div className="w-6 h-6 bg-purple-500/20 rounded flex items-center justify-center">
                    <span className="text-xs">üìã</span>
                  </div>
                  <span className="text-zinc-300 text-sm">One-Pager</span>
                  <svg className="w-4 h-4 text-zinc-600 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                </a>
              </div>
            )}
          </div>

          <Link 
            href="/dashboard" 
            className="flex items-center gap-2 bg-white hover:bg-zinc-200 text-black font-semibold px-4 py-2 rounded-lg text-sm transition ml-2"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Store Login
          </Link>
        </nav>

        {/* Mobile hamburger button */}
        <button 
          onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
          className="md:hidden p-2 text-zinc-400 hover:text-white"
          aria-label="Toggle menu"
        >
          {mobileMenuOpen ? (
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          ) : (
            <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          )}
        </button>
      </div>

      {/* Mobile menu */}
      {mobileMenuOpen && (
        <div className="md:hidden bg-[#0d0d0d] border-t border-zinc-800">
          <nav className="flex flex-col px-6 py-4 space-y-1">
            <Link 
              href="/docs" 
              onClick={() => setMobileMenuOpen(false)}
              className="text-zinc-400 hover:text-white text-sm transition py-3 border-b border-zinc-800/50"
            >
              Docs
            </Link>
            <button 
onClick={() => {
  setMobileMenuOpen(false);
  if (pathname === '/' || pathname === '/home') {
    document.getElementById('pricing')?.scrollIntoView({ behavior: 'smooth' });
  } else {
    window.location.href = '/#pricing';
  }
}}
className="text-zinc-400 hover:text-white text-sm transition py-3 border-b border-zinc-800/50 text-left w-full"
>
  Pricing
</button>
            <Link 
  href="/affiliate-dashboard" 
  onClick={() => setMobileMenuOpen(false)}
  className="text-zinc-400 hover:text-white text-sm transition py-3 border-b border-zinc-800/50"
>
  Affiliates
</Link>
            
            {/* Mobile Resources Section */}
            <div className="py-3 border-b border-zinc-800/50">
              <p className="text-zinc-600 text-xs uppercase tracking-wider mb-3">Resources</p>
              <div className="space-y-2">
                <Link 
                  href="/resources"
                  onClick={() => setMobileMenuOpen(false)}
                  className="flex items-center gap-3 text-zinc-300 hover:text-white text-sm transition py-2"
                >
                  <span>üìÑ</span>
                  Interactive Guide
                </Link>
                <a 
                  href="/pdfs/YesAllofUs-Cost-Comparison.pdf"
                  download
                  className="flex items-center gap-3 text-zinc-400 hover:text-white text-sm transition py-2"
                >
                  <span>üìä</span>
                  Cost Comparison PDF
                </a>
                <a 
                  href="/pdfs/YesAllofUs-Savings-Calculator.pdf"
                  download
                  className="flex items-center gap-3 text-zinc-400 hover:text-white text-sm transition py-2"
                >
                  <span>üßÆ</span>
                  Savings Calculator PDF
                </a>
                <a 
                  href="/pdfs/YesAllofUs-One-Pager.pdf"
                  download
                  className="flex items-center gap-3 text-zinc-400 hover:text-white text-sm transition py-2"
                >
                  <span>üìã</span>
                  One-Pager PDF
                </a>
              </div>
            </div>

            <Link 
              href="/dashboard" 
              onClick={() => setMobileMenuOpen(false)}
              className="flex items-center justify-center gap-2 bg-white hover:bg-zinc-200 text-black font-semibold px-4 py-3 rounded-lg text-sm transition mt-3"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              Store Login
            </Link>
          </nav>
        </div>
      )}
    </header>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/InfoModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Types & Interfaces
interface InfoContent {
  title: string;
  what: string;
  why: string;
  how: string;
  tip: string;
}

interface InfoModalProps {
  content: InfoContent;
  isOpen: boolean;
  onClose: () => void;
}

const infoContent: Record<string, InfoContent> = {
  // Vendor Dashboard items
  'take-payment': {
    title: 'Take Payment',
    what: 'Accept contactless payments from customers using their NFC card or phone.',
    why: 'Fast, secure payments that automatically calculate and distribute affiliate commissions.',
    how: 'Tap the button, enter the amount, and have your customer tap their card or phone.',
    tip: 'Every payment builds your network and rewards your affiliates instantly!'
  },
  'signup-customer': {
    title: 'Sign Up Customer',
    what: 'Register new customers and link them to an NFC card for tap-to-pay.',
    why: 'Customers become affiliates who earn rewards and refer others to your store.',
    how: 'Click the button, have the customer enter their details, and tap their NFC card to link.',
    tip: 'Each customer you sign up can become your best promoter!'
  },
  'wallet-funding': {
    title: 'Top Up Wallet',
    what: 'Add RLUSD to your store wallet manually. Partner and affiliate wallets auto-top-up, but you can add funds anytime.',
    why: 'Your wallet needs funds to pay affiliate commissions. Affiliates and partner vendors have auto-top-up enabled by default.',
    how: 'For manual top-up: send RLUSD from an exchange or another wallet to your store wallet address. Open banking top-ups coming soon!',
    tip: 'Auto-top-up handles most cases - manual is here when you need extra control!'
  },
  'withdraw': {
    title: 'Withdraw',
    what: 'Send RLUSD from your store wallet to your personal wallet or exchange.',
    why: 'Take profits or move funds to where you need them.',
    how: 'Enter the destination address and amount, then confirm the transaction.',
    tip: 'Your earnings are always under your control!'
  },
  'payout-method': {
    title: 'Payout Method',
    what: 'How your store pays affiliate commissions - automatic or manual approval.',
    why: 'Auto-sign means 24/7 instant payouts. Manual means you approve each one.',
    how: 'Connect a wallet and enable auto-sign for the best affiliate experience.',
    tip: 'Instant payouts keep your affiliates motivated and engaged!'
  },
  'pending-customers': {
    title: 'Pending Customers',
    what: 'Customers who started signup but need wallet activation.',
    why: 'New wallets need a small XRP amount to activate on the blockchain.',
    how: 'Review pending customers and complete their activation when ready.',
    tip: 'Quick activations mean happy customers ready to spend!'
  },
  'earn-interest': {
    title: 'Earn Interest',
    what: 'Coming soon - earn yield on your RLUSD balance.',
    why: 'Make your idle funds work for you while waiting for payouts.',
    how: 'Simply hold RLUSD in your wallet and earn automatically.',
    tip: 'Your money grows even when you sleep!'
  },
  'auto-sign': {
    title: 'Auto-Sign',
    what: 'Automatic transaction signing for instant affiliate payouts.',
    why: 'No manual approval needed - commissions pay out 24/7 instantly.',
    how: 'Enable auto-sign with your wallet, set limits, and forget about it.',
    tip: 'Instant payouts = happy affiliates = more referrals!'
  },
  'commission-rates': {
    title: 'Commission Rates',
    what: 'Set how much affiliates earn at each level of your referral network.',
    why: 'Competitive rates attract more affiliates and drive more sales.',
    how: 'Set percentages for 5 levels - direct referrals earn most.',
    tip: 'Generous commissions build loyal, motivated promoters!'
  },
  'affiliate-link': {
    title: 'Affiliate Link',
    what: 'Your unique link that tracks referrals to your store.',
    why: 'Share this link so new affiliates join under your network.',
    how: 'Copy the link and share via social media, email, or messaging.',
    tip: 'Every share is a seed planted for future growth!'
  },
  'api-credentials': {
    title: 'API Credentials',
    what: 'Keys for integrating YesAllofUs with your website or app.',
    why: 'Automate payments and affiliate tracking on your own platform.',
    how: 'Copy your API key and secret, then follow our documentation.',
    tip: 'Integration unlocks the full power of automated affiliate marketing!'
  },
  'quick-links': {
    title: 'Quick Links',
    what: 'Helpful resources including documentation, terms, and plugins.',
    why: 'Everything you need to get the most from YesAllofUs.',
    how: 'Click any link to access guides, legal info, or integrations.',
    tip: 'Knowledge is power - explore and grow!'
  },
  'activity': {
    title: 'Activity',
    what: 'View your affiliates, transactions, and payment history.',
    why: 'Track performance and see your network growing.',
    how: 'Switch between tabs to see affiliates or recent payments.',
    tip: 'Watching your numbers grow is the best motivation!'
  },
  'danger-zone': {
    title: 'Danger Zone',
    what: 'Permanent actions like deleting your store.',
    why: 'Sometimes you need a fresh start or to close down.',
    how: 'Confirm carefully - these actions cannot be undone.',
    tip: 'We hope you never need this - but it is here if you do.'
  },
  
  // Milestone items (shared)
  'wallet_funded': {
    title: 'Wallet Funded',
    what: 'Your wallet has been activated on the XRP Ledger with XRP.',
    why: 'A funded wallet is required to hold RLUSD and process transactions.',
    how: 'This happened automatically when XRP was sent to your wallet address.',
    tip: 'Your wallet is live and ready for action!'
  },
  'trustline_set': {
    title: 'Trustline Set',
    what: 'Your wallet can now hold and receive RLUSD stablecoin.',
    why: 'RLUSD is used for all payments and commissions in the system.',
    how: 'The trustline was added when you set up your wallet.',
    tip: 'You are connected to the RLUSD payment network!'
  },
  'auto_sign_enabled': {
    title: 'Auto-Sign Enabled',
    what: 'Your wallet automatically signs transactions for instant payouts.',
    why: 'Affiliates receive commissions instantly without manual approval.',
    how: 'You enabled this by signing a transaction that authorizes the platform.',
    tip: 'Your affiliates love instant payments - great choice!'
  },
  'first_affiliate': {
    title: 'First Affiliate Joined',
    what: 'Someone has signed up as an affiliate for your store.',
    why: 'Affiliates promote your products and earn commission on sales.',
    how: 'They joined using your affiliate link or referral code.',
    tip: 'Your network is growing - every affiliate expands your reach!'
  },
  'first_payment_received': {
    title: 'First Payment Received',
    what: 'RLUSD has arrived in your store wallet.',
    why: 'This confirms your payment system is working correctly.',
    how: 'A customer made a purchase or you topped up manually.',
    tip: 'The money is flowing - your business is live!'
  },
  'first_payout_sent': {
    title: 'First Payout Sent',
    what: 'You have paid your first affiliate commission.',
    why: 'This proves your entire affiliate system is working end-to-end.',
    how: 'A sale was made through an affiliate link and commission was paid.',
    tip: 'You are building a team of motivated promoters!'
  },
  'first_partner_signed': {
    title: 'First Partner Signed Up',
    what: 'Another vendor joined using your referral code.',
    why: 'You earn commission when your referred vendors make sales.',
    how: 'They signed up with your store referral code.',
    tip: 'Vendor-to-vendor referrals multiply your earning potential!'
  },

  // Affiliate Dashboard nav items
  'earnings': {
    title: 'Total Earnings',
    what: 'Your total RLUSD earned from affiliate commissions.',
    why: 'Track your progress and see how your referrals are paying off.',
    how: 'Earnings accumulate automatically when customers you referred make purchases.',
    tip: 'Every purchase in your network earns you a commission!'
  },
  'wallet-status': {
    title: 'Wallet Status',
    what: 'Overview of your wallet balances and trustline status.',
    why: 'Know exactly how much XRP and RLUSD you have available.',
    how: 'Your wallet is automatically updated when transactions occur.',
    tip: 'A healthy wallet means you are ready to receive commissions!'
  },
  'top-up': {
    title: 'Top Up Wallet',
    what: 'Add funds to your wallet using card, bank transfer, or crypto swap.',
    why: 'Keep your wallet funded to cover transaction fees and receive payments.',
    how: 'Choose a payment method and follow the prompts to add funds.',
    tip: 'Card payments are the fastest way to get started!'
  },
  'payment-cards': {
    title: 'Payment Cards',
    what: 'Link NFC cards to your wallet for tap-to-pay purchases.',
    why: 'Use physical cards to make payments at participating vendors.',
    how: 'Hold your NFC card to your phone to link it to your account.',
    tip: 'NFC cards make paying as easy as a tap!'
  },
  'tap-to-pay': {
    title: 'Tap-to-Pay',
    what: 'Enable your phone to make contactless payments.',
    why: 'Pay at any participating vendor by tapping your phone.',
    how: 'Enable auto-sign and set a spending limit to activate tap-to-pay.',
    tip: 'No card needed - your phone is your wallet!'
  },
  'browser-wallet': {
    title: 'Browser Wallet',
    what: 'Connect Crossmark wallet for automatic transaction signing.',
    why: 'Crossmark enables instant payments without manual approval each time.',
    how: 'Install the Crossmark extension and connect to your account.',
    tip: 'Best for desktop users who want seamless payments!'
  },
  'xaman-wallet': {
    title: 'Manual Wallet',
    what: 'Use Xaman (formerly XUMM) to manually approve transactions.',
    why: 'Maximum security - you approve every transaction on your phone.',
    how: 'Scan QR codes with Xaman app to approve payments.',
    tip: 'Perfect for users who want full control over every transaction!'
  },
  'discover': {
    title: 'Discover Vendors',
    what: 'Find and join vendors to start earning affiliate commissions.',
    why: 'The more vendors you join, the more ways you can earn.',
    how: 'Browse available vendors and click Join to become their affiliate.',
    tip: 'Join vendors you actually shop at for natural referrals!'
  },
  'payouts': {
    title: 'Recent Payouts',
    what: 'History of commission payments you have received.',
    why: 'Track your earnings and see which referrals are performing best.',
    how: 'Payouts appear here automatically when commissions are paid.',
    tip: 'Watch your payouts grow as your network expands!'
  },
  
  // Customer milestone items
  'tap_pay_enabled': {
    title: 'Tap to Pay Enabled',
    what: 'Your phone can now make contactless payments.',
    why: 'Pay instantly at any participating vendor with just a tap.',
    how: 'You enabled auto-sign which allows automatic payment approval.',
    tip: 'Shopping just got a whole lot faster!'
  },
  'nfc_card_added': {
    title: 'NFC Card Linked',
    what: 'A physical payment card is linked to your account.',
    why: 'Use your card to pay at vendors even without your phone.',
    how: 'You tapped your NFC card to link it to your wallet.',
    tip: 'Your card is now a direct line to your RLUSD balance!'
  },
  'joined_affiliate': {
    title: 'Joined as Affiliate',
    what: 'You are now earning commissions from a vendor.',
    why: 'Every purchase made through your referrals earns you RLUSD.',
    how: 'You joined a vendor affiliate program.',
    tip: 'Share your link and watch the commissions roll in!'
  }
};


// MARK: - Component Definition
export function InfoButton({ sectionId, onClick }: { sectionId: string; onClick: () => void }) {

// MARK: - Main Render
  return (
    <button

// MARK: - Event Handlers
      onClick={(e) => {
        e.stopPropagation();
        onClick();
      }}
      className="p-1 text-zinc-500 hover:text-sky-400 transition-colors"
      title="Learn more"
    >
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
      </svg>
    </button>
  );
}

export function InfoModal({ content, isOpen, onClose }: InfoModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4" onClick={onClose}>
      <div 
        className="bg-zinc-900 border border-zinc-700 rounded-2xl p-6 w-full max-w-md transform transition-all"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-sky-500/20 rounded-lg flex items-center justify-center">
              <svg className="w-6 h-6 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
              </svg>
            </div>
            <h3 className="text-lg font-bold text-white">{content.title}</h3>
          </div>
          <button
            onClick={onClose}
            className="text-zinc-500 hover:text-white transition"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="space-y-4">
          <div>
            <p className="text-sky-400 text-xs font-semibold uppercase tracking-wide mb-1">What</p>
            <p className="text-zinc-300 text-sm">{content.what}</p>
          </div>
          <div>
            <p className="text-emerald-400 text-xs font-semibold uppercase tracking-wide mb-1">Why</p>
            <p className="text-zinc-300 text-sm">{content.why}</p>
          </div>
          <div>
            <p className="text-violet-400 text-xs font-semibold uppercase tracking-wide mb-1">How</p>
            <p className="text-zinc-300 text-sm">{content.how}</p>
          </div>
        </div>

        {/* Tip */}
        <div className="mt-6 bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
          <div className="flex items-start gap-2">
            <svg className="w-5 h-5 text-emerald-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
            <p className="text-emerald-300 text-sm">{content.tip}</p>
          </div>
        </div>

        {/* Close button */}
        <button
          onClick={onClose}
          className="w-full mt-6 bg-zinc-800 hover:bg-zinc-700 text-white font-medium py-3 rounded-xl transition"
        >
          Got it!
        </button>
      </div>
    </div>
  );
}

export function useInfoModal() {
  const [activeInfo, setActiveInfo] = useState<string | null>(null);

  const openInfo = (sectionId: string) => setActiveInfo(sectionId);
  const closeInfo = () => setActiveInfo(null);

// MARK: - API Calls & Data Fetching
  const getContent = () => activeInfo ? infoContent[activeInfo] : null;

  return { activeInfo, openInfo, closeInfo, getContent };
}

export { infoContent };
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/InstallAppButton.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Types & Interfaces
interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

type BrowserType = 'chrome' | 'edge' | 'brave' | 'safari' | 'firefox' | 'other';


// MARK: - Component Definition
export default function InstallAppButton() {
  const [installPrompt, setInstallPrompt] = useState<BeforeInstallPromptEvent | null>(null);

// MARK: - State Management
  const [isIOS, setIsIOS] = useState(false);
  const [browser, setBrowser] = useState<BrowserType>('other');
  const [showModal, setShowModal] = useState(false);
  const [isInstalled, setIsInstalled] = useState(false);
  const [installing, setInstalling] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
      return;
    }

    const ua = navigator.userAgent;
    setIsIOS(/iPad|iPhone|iPod/.test(ua));

    // Detect browser
    if (ua.includes('Edg/')) {
      setBrowser('edge');
    } else if (ua.includes('Chrome') && !ua.includes('Edg/')) {
      setBrowser('chrome');
    } else if (ua.includes('Safari') && !ua.includes('Chrome')) {
      setBrowser('safari');
    } else if (ua.includes('Firefox')) {
      setBrowser('firefox');
    }

    const handler = (e: Event) => {
      e.preventDefault();
      setInstallPrompt(e as BeforeInstallPromptEvent);
    };

    window.addEventListener('beforeinstallprompt', handler);
    window.addEventListener('appinstalled', () => setIsInstalled(true));

    return () => window.removeEventListener('beforeinstallprompt', handler);
  }, []);


// MARK: - Event Handlers
  const handleInstall = async () => {
    // Native prompt available - use it
    if (installPrompt) {
      setInstalling(true);
      installPrompt.prompt();
      const result = await installPrompt.userChoice;
      if (result.outcome === 'accepted') {
        setIsInstalled(true);
      }
      setInstalling(false);
      return;
    }

    // No native prompt - show instructions modal
    setShowModal(true);
  };


// MARK: - API Calls & Data Fetching
  const getInstructions = () => {
    if (isIOS) {
      return {
        title: 'Install on iPhone/iPad',
        steps: [
          { text: 'Tap the share button', icon: 'share' },
          { text: 'Scroll & tap "Add to Home Screen"', icon: 'plus' },
          { text: 'Tap "Add"', icon: 'check' },
        ],
      };
    }

    if (browser === 'safari') {
      return {
        title: 'Install on Safari',
        steps: [
          { text: 'Click File in the menu bar', icon: 'menu' },
          { text: 'Click "Add to Dock"', icon: 'plus' },
          { text: 'Click "Add"', icon: 'check' },
        ],
      };
    }

    if (browser === 'firefox') {
      return {
        title: 'Install on Firefox',
        steps: [
          { text: 'Firefox has limited PWA support', icon: 'info' },
          { text: 'Try Chrome, Edge, or Safari instead', icon: 'browser' },
          { text: 'Or use our mobile app', icon: 'phone' },
        ],
      };
    }

    if (browser === 'edge') {
      return {
        title: 'Install on Edge',
        steps: [
          { text: 'Click ‚ãØ menu in the toolbar', icon: 'menu' },
          { text: 'Click Apps ‚Üí Install this site', icon: 'plus' },
          { text: 'Click "Install"', icon: 'check' },
        ],
      };
    }

    // Chrome/other fallback
    return {
      title: 'Install App',
      steps: [
        { text: 'Click ‚ãÆ menu in the toolbar', icon: 'menu' },
        { text: 'Click "Install YesAllOfUs"', icon: 'plus' },
        { text: 'Click "Install"', icon: 'check' },
      ],
    };
  };

  const getIcon = (icon: string) => {
    switch (icon) {
      case 'share':

// MARK: - Main Render
        return (
          <svg className="w-5 h-5 text-sky-400" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2l3 3h-2v6h-2V5H9l3-3zm-7 9v10h14V11h-2v8H7v-8H5z" />
          </svg>
        );
      case 'plus':
        return (
          <svg className="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
        );
      case 'check':
        return (
          <svg className="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        );
      case 'menu':
        return (
          <svg className="w-5 h-5 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        );
      case 'info':
        return (
          <svg className="w-5 h-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
        );
      case 'browser':
        return (
          <svg className="w-5 h-5 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />
          </svg>
        );
      case 'phone':
        return (
          <svg className="w-5 h-5 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
          </svg>
        );
      default:
        return null;
    }
  };

  const instructions = getInstructions();

  if (isInstalled) return null;

  return (
    <>
      <button
        onClick={handleInstall}
        disabled={installing}
        className="group w-full mb-4 p-4 rounded-2xl border border-zinc-800/50 bg-gradient-to-r from-emerald-500/5 to-sky-500/5 hover:from-emerald-500/10 hover:to-sky-500/10 hover:border-emerald-500/30 transition-all duration-300"
      >
        <div className="flex items-center gap-4">
          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 flex items-center justify-center group-hover:scale-110 transition-transform">
            {installing ? (
              <div className="w-5 h-5 border-2 border-emerald-400 border-t-transparent rounded-full animate-spin" />
            ) : (
              <svg className="w-6 h-6 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 8.25H7.5a2.25 2.25 0 00-2.25 2.25v9a2.25 2.25 0 002.25 2.25h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3V2.25" />
              </svg>
            )}
          </div>
          
          <div className="flex-1 text-left">
            <p className="font-semibold text-white text-sm">Install App</p>
            <p className="text-zinc-500 text-xs">Add to home screen</p>
          </div>
          
          <svg className="w-5 h-5 text-zinc-600 group-hover:text-emerald-400 group-hover:translate-x-1 transition-all" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </div>
      </button>

      {/* Instructions Modal */}
      {showModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
          <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-6 max-w-sm w-full">
            
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-lg font-bold">{instructions.title}</h3>
              <button 
                onClick={() => setShowModal(false)}
                className="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center hover:bg-zinc-700 transition"
              >
                <svg className="w-4 h-4 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="space-y-4">
              {instructions.steps.map((step, i) => (
                <div key={i} className="flex items-center gap-4 p-3 rounded-xl bg-zinc-800/50">
                  <div className="w-10 h-10 rounded-xl bg-zinc-700 flex items-center justify-center font-bold text-sm">
                    {i + 1}
                  </div>
                  <div className="flex-1">
                    <p className="text-sm text-zinc-300">{step.text}</p>
                  </div>
                  <div className="w-10 h-10 rounded-xl bg-zinc-800 flex items-center justify-center">
                    {getIcon(step.icon)}
                  </div>
                </div>
              ))}
            </div>

            <button
              onClick={() => setShowModal(false)}
              className="w-full mt-6 py-3 bg-emerald-500 hover:bg-emerald-400 text-black font-semibold rounded-xl transition active:scale-[0.98]"
            >
              Got it
            </button>
          </div>
        </div>
      )}
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/InstantPay.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem } from '@/lib/safeStorage';
import AutoSignModal from './AutoSignModal';


// MARK: - Constants & Configuration

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';
const PLUGINS_API_URL = 'https://api.dltpays.com/plugins/api/v1';

// L7: Map technical errors to user-friendly messages
const sanitizeError = (error: string): string => {
  // Known error codes that should pass through
  if (['INSUFFICIENT_FUNDS', 'SELF_PAYMENT_NOT_ALLOWED', 'WALLET_NOT_READY'].includes(error)) {
    return error;
  }
  // Map technical errors to friendly messages
  if (error.includes('tec') || error.includes('tem') || error.includes('tef')) {
    return 'Transaction failed. Please try again.';
  }
  if (error.includes('timeout') || error.includes('Timeout')) {
    return 'Request timed out. Please try again.';
  }
  if (error.includes('network') || error.includes('Network') || error.includes('fetch')) {
    return 'Network error. Please check your connection.';
  }
  // Avoid exposing internal errors
  if (error.length > 100 || error.includes('Error:') || error.includes('at ')) {
    return 'Payment failed. Please try again.';
  }
  return error;
};


// MARK: - Types & Interfaces
interface InstantPayProps {
  amount: number;
  rlusdAmount: number;
  vendorWallet: string;
  storeName: string;
  storeId: string;
  paymentId: string;
  onSuccess: (txHash: string, receiptId?: string) => void;
  onError: (error: string) => void;
  isCheckoutSession?: boolean;
  tipAmount?: number;
}

export default function InstantPay({
  amount,
  rlusdAmount,
  vendorWallet,
  storeName,
  storeId,
  paymentId,
  onSuccess,
  onError,
  isCheckoutSession = false,
  tipAmount = 0
}: InstantPayProps) {
  const [step, setStep] = useState<'login' | 'setup' | 'reauth' | 'ready'>('login');
  const [walletAddress, setWalletAddress] = useState<string | null>(null);

// MARK: - State Management
  const [loading, setLoading] = useState(false);
  const [paying, setPaying] = useState(false);
  const [showAutoSignModal, setShowAutoSignModal] = useState(false);

  // Helper function to get the correct pay endpoint

// MARK: - API Calls & Data Fetching
  const getPayEndpoint = () => {
    if (isCheckoutSession) {
      // For checkout sessions, use the plugins API with session ID (storeId contains session_id)
      return `${PLUGINS_API_URL}/checkout/session/${storeId}/pay`;
    }
    // For regular payment links, use NFC API
    return `${NFC_API_URL}/payment-link/${paymentId}/pay`;
  };

  // Check if user is already logged in and set up

// MARK: - Hooks & Effects
  useEffect(() => {
    const checkSession = async () => {
      try {
        const stored = safeGetItem('walletAddress');
        const method = safeGetItem('loginMethod');
        
        if (stored && method === 'web3auth') {
          setWalletAddress(stored);
          const res = await fetch(`${NFC_API_URL}/nfc/customer/autosign-status/${stored}`);
          const data = await res.json();
          
          if (data.auto_sign_enabled) {
            setStep('ready');
          } else {
            setStep('setup');
          }
        }
      } catch (err) {
        console.error('Session check error:', err);
      }
    };
    checkSession();
  }, []);

  // Helper to convert string to hex (browser-safe)
  const toHex = (str: string) => {
    return Array.from(str)
      .map(c => c.charCodeAt(0).toString(16).padStart(2, '0'))
      .join('')
      .toUpperCase();
  };

  const processPaymentWithWallet = async (wallet: string) => {
    // Check for self-payment
    if (wallet.toLowerCase() === vendorWallet.toLowerCase()) {
      onError('SELF_PAYMENT_NOT_ALLOWED');
      return;
    }

    // Check if wallet is ready (funded + RLUSD enabled)
    try {
      const statusRes = await fetch(`${NFC_API_URL}/wallet/status/${wallet}`);
      if (!statusRes.ok) {
        console.warn('Wallet status check failed:', statusRes.status);
      }
      const statusData = await statusRes.json();

      if (statusData.success && (!statusData.funded || !statusData.rlusd_trustline)) {
        onError('WALLET_NOT_READY');
        return;
      }
    } catch (err) {
      console.error('Wallet status check failed:', err);
    }

    setPaying(true);
    try {
      // Call backend to process payment using signer list authority
      const res = await fetch(getPayEndpoint(), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          payer_wallet: wallet,
          tip_amount: tipAmount
        })
      });

      if (!res.ok) {
        throw new Error(`Payment request failed: ${res.status}`);
      }

      const result = await res.json();

      if (!result.success) {
        if (result.error === 'NO_SIGNER_AUTHORITY') {
          setStep('setup');
          return;
        }
        throw new Error(result.error || 'Payment failed');
      }

      onSuccess(result.tx_hash, result.receipt_id);
      if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
    } catch (error: any) {
      console.error('Payment error:', error);
      const errorMsg = error.message || error.toString() || 'Payment failed';
      
      if (
        errorMsg.includes('tecUNFUNDED_PAYMENT') ||
        errorMsg.includes('tecPATH_PARTIAL') ||
        errorMsg.includes('tecPATH_DRY') ||
        errorMsg.includes('insufficient') ||
        errorMsg.includes('Insufficient') ||
        errorMsg.includes('unfunded') ||
        errorMsg.includes('balance') ||
        errorMsg.includes('not enough') ||
        errorMsg.includes('NO_SIGNER_AUTHORITY')
      ) {
        if (errorMsg.includes('NO_SIGNER_AUTHORITY')) {
          setStep('setup');
          return;
        }
        onError('INSUFFICIENT_FUNDS');
      } else {
        // L7: Sanitize error to prevent info disclosure
        onError(sanitizeError(errorMsg));
      }
    } finally {
      setPaying(false);
    }
  };

  // Login with Web3Auth
  const login = async () => {
    setLoading(true);
    try {
      const { loginWithWeb3Auth } = await import('@/lib/web3auth');
      const result = await loginWithWeb3Auth();
      
      if (!result) {
        setLoading(false);
        return;
      }

      const address = typeof result === 'string' ? result : result.address;
      const provider = typeof result === 'string' ? 'google' : (result.provider || 'google');
      
      safeSetItem('walletAddress', address);
      safeSetItem('loginMethod', 'web3auth');
      safeSetItem('socialProvider', provider);
      
      setWalletAddress(address);

      const res = await fetch(`${NFC_API_URL}/nfc/customer/autosign-status/${address}`);
      const data = await res.json();
      
      if (data.auto_sign_enabled) {
        setStep('ready');
        setTimeout(() => {
          processPaymentWithWallet(address);
        }, 500);
      } else {
        setStep('setup');
      }
    } catch (error: any) {
      console.error('Login error:', error);
      const errorMsg = error.message || error.toString() || 'Login failed';
      
      if (
        errorMsg.includes('tecUNFUNDED_PAYMENT') ||
        errorMsg.includes('tecPATH_PARTIAL') ||
        errorMsg.includes('tecPATH_DRY') ||
        errorMsg.includes('insufficient') ||
        errorMsg.includes('Insufficient')
      ) {
        onError('INSUFFICIENT_FUNDS');
      } else {
        // L7: Sanitize error to prevent info disclosure
        onError(sanitizeError(errorMsg));
      }
    } finally {
      setLoading(false);
    }
  };

  // Re-authenticate and continue
  const reauth = async () => {
    setLoading(true);
    try {
      const { loginWithWeb3Auth } = await import('@/lib/web3auth');
      const result = await loginWithWeb3Auth();
      
      if (!result) {
        setLoading(false);
        return;
      }

      const address = typeof result === 'string' ? result : result.address;
      safeSetItem('walletAddress', address);
      safeSetItem('loginMethod', 'web3auth');
      
      setWalletAddress(address);
      
      // Check auto-sign status before allowing payment
      const res = await fetch(`${NFC_API_URL}/nfc/customer/autosign-status/${address}`);
      const data = await res.json();
      
      if (data.auto_sign_enabled) {
        setStep('ready');
        setTimeout(() => {
          processPaymentWithWallet(address);
        }, 500);
      } else {
        setStep('setup');
      }
    } catch (error: any) {
      console.error('Reauth error:', error);
      onError(error.message || 'Login failed');
    } finally {
      setLoading(false);
    }
  };

  // Enable auto-sign
  const enableAutoSign = async () => {
    setLoading(true);
    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth || !web3auth.provider) {
        setStep('reauth');
        setLoading(false);
        return;
      }

      // Get platform signer address
      const res = await fetch('https://api.dltpays.com/nfc/api/v1/nfc/customer/setup-autosign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const data = await res.json();
      
      if (data.error) throw new Error(data.error);
      
      // If signer already exists, just proceed
      if (data.signer_exists || data.auto_sign_enabled) {
        setStep('ready');
        return;
      }

      const platformSignerAddress = data.platform_signer_address;
      if (!platformSignerAddress) throw new Error('Platform signer not configured');

      // Build and sign SignerListSet transaction
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 1,
        SignerEntries: [{ SignerEntry: { Account: platformSignerAddress, SignerWeight: 1 } }]
      };
      
      await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: signerListSetTx }
      });

      // Verify setup worked
      await new Promise(resolve => setTimeout(resolve, 2000));
      const verifyRes = await fetch(`https://api.dltpays.com/nfc/api/v1/nfc/customer/autosign-status/${walletAddress}`);
      const verifyData = await verifyRes.json();
      
      if (verifyData.auto_sign_enabled) {
        setStep('ready');
      } else {
        throw new Error('Setup failed. Please try again.');
      }
    } catch (error: any) {
      console.error('Setup error:', error);
      onError(error.message || 'Setup failed');
    } finally {
      setLoading(false);
    }
  };

  // Process payment
  const processPayment = async () => {
    if (!walletAddress || paying) return;
    await processPaymentWithWallet(walletAddress);
  };

  // STEP 1: Not logged in
  if (step === 'login') {

// MARK: - Main Render
    return (
      <button

// MARK: - Event Handlers
        onClick={login}
        disabled={loading}
        className="w-full bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 disabled:opacity-50 text-white font-bold py-5 rounded-2xl transition flex items-center justify-center gap-3"
      >
        {loading ? (
          <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin" />
        ) : (
          <>
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4" />
            </svg>
            Instant Pay with Biometrics
          </>
        )}
      </button>
    );
  }

  // STEP 2: Logged in but needs setup - show modal
  if (step === 'setup') {
    return (
      <>
        <AutoSignModal
          isOpen={true}
          onClose={() => setStep('login')}
          onSuccess={() => {
            setStep('ready');
            if (walletAddress) {
              setTimeout(() => processPaymentWithWallet(walletAddress), 500);
            }
          }}
        />
        <button
          disabled={true}
          className="w-full bg-gradient-to-r from-amber-500 to-orange-500 opacity-50 text-black font-bold py-5 rounded-2xl transition flex items-center justify-center gap-3"
        >
          <div className="w-6 h-6 border-2 border-black border-t-transparent rounded-full animate-spin" />
          Setting up wallet...
        </button>
      </>
    );
  }

  // STEP 2.5: Session expired - need to re-login (friendly message)
  if (step === 'reauth') {
    return (
      <div className="space-y-3">
        <div className="bg-sky-500/10 border border-sky-500/30 rounded-xl p-3 flex items-center gap-3">
          <svg className="w-5 h-5 text-sky-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p className="text-sky-400 text-sm">Session expired. Please sign in again to continue.</p>
        </div>
        <button
          onClick={reauth}
          disabled={loading}
          className="w-full bg-gradient-to-r from-sky-500 to-blue-500 hover:from-sky-400 hover:to-blue-400 disabled:opacity-50 text-white font-bold py-5 rounded-2xl transition flex items-center justify-center gap-3"
        >
          {loading ? (
            <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin" />
          ) : (
            <>
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
              Sign In to Continue
            </>
          )}
        </button>
      </div>
    );
  }

  // STEP 3: Ready to pay
  return (
    <button
      onClick={processPayment}
      disabled={paying}
      className="w-full bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-400 hover:to-green-400 disabled:opacity-70 text-black font-bold py-5 rounded-2xl transition flex items-center justify-center gap-3 shadow-lg shadow-emerald-500/25"
    >
      {paying ? (
        <>
          <div className="w-6 h-6 border-2 border-black border-t-transparent rounded-full animate-spin" />
          Processing...
        </>
      ) : (
        <>
          <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
          <span className="text-xl">Pay ¬£{amount.toFixed(2)} Now</span>
        </>
      )}
    </button>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/InventoryHistoryModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Types & Interfaces
interface InventoryHistoryEntry {
  history_id: string;
  product_id: string;
  product_name?: string;
  previous_quantity: number;
  new_quantity: number;
  adjustment: number;
  reason: string;
  notes?: string;
  created_at: string;
  created_by?: string;
}

interface InventoryHistoryModalProps {
  storeId: string;
  walletAddress: string;
  productId?: string; // If provided, filter to this product only
  productName?: string;
  onClose: () => void;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';

const reasonLabels: Record<string, { label: string; color: string; icon: string }> = {
  sale: { label: 'Sale', color: 'text-blue-400 bg-blue-500/20', icon: 'üõí' },
  restock: { label: 'Restock', color: 'text-emerald-400 bg-emerald-500/20', icon: 'üì¶' },
  adjustment: { label: 'Adjustment', color: 'text-amber-400 bg-amber-500/20', icon: '‚úèÔ∏è' },
  return: { label: 'Return', color: 'text-purple-400 bg-purple-500/20', icon: '‚Ü©Ô∏è' },
  damage: { label: 'Damage', color: 'text-red-400 bg-red-500/20', icon: 'üíî' },
  expired: { label: 'Expired', color: 'text-orange-400 bg-orange-500/20', icon: '‚è∞' },
  transfer: { label: 'Transfer', color: 'text-cyan-400 bg-cyan-500/20', icon: 'üîÑ' },
  initial: { label: 'Initial Stock', color: 'text-zinc-400 bg-zinc-500/20', icon: 'üÜï' },
};

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;

  return date.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'short',
    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
  });
}


// MARK: - Component Definition
export default function InventoryHistoryModal({
  storeId,
  walletAddress,
  productId,
  productName,
  onClose,
}: InventoryHistoryModalProps) {
  const [history, setHistory] = useState<InventoryHistoryEntry[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);


// MARK: - Hooks & Effects
  useEffect(() => {

// MARK: - API Calls & Data Fetching
    const fetchHistory = async () => {
      try {
        setLoading(true);
        const url = productId
          ? `${API_URL}/store/${storeId}/inventory/history?wallet_address=${walletAddress}&product_id=${productId}&limit=50`
          : `${API_URL}/store/${storeId}/inventory/history?wallet_address=${walletAddress}&limit=100`;

        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
          setHistory(data.history || []);
        } else {
          setError(data.error || 'Failed to load history');
        }
      } catch (err) {
        setError('Failed to connect to server');
      }
      setLoading(false);
    };

    fetchHistory();
  }, [storeId, walletAddress, productId]);


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
      <div className="bg-zinc-900 rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden">
        {/* Header */}
        <div className="p-4 border-b border-zinc-800 flex items-center justify-between">
          <div>
            <h2 className="text-lg font-bold">Inventory History</h2>
            {productName && (
              <p className="text-zinc-500 text-sm">{productName}</p>
            )}
          </div>
          <button

// MARK: - Event Handlers
            onClick={onClose}
            className="p-2 text-zinc-400 hover:text-white hover:bg-zinc-800 rounded-lg transition"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-4">
          {loading ? (
            <div className="flex items-center justify-center py-12">
              <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin" />
            </div>
          ) : error ? (
            <div className="text-center py-12">
              <div className="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg className="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <p className="text-red-400">{error}</p>
            </div>
          ) : history.length === 0 ? (
            <div className="text-center py-12">
              <div className="w-12 h-12 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg className="w-6 h-6 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
              </div>
              <p className="text-zinc-500">No inventory history yet</p>
              <p className="text-zinc-600 text-sm mt-1">Stock changes will appear here</p>
            </div>
          ) : (
            <div className="space-y-2">
              {history.map((entry) => {
                const reasonInfo = reasonLabels[entry.reason] || {
                  label: entry.reason,
                  color: 'text-zinc-400 bg-zinc-500/20',
                  icon: 'üìã',
                };
                const isPositive = entry.adjustment > 0;

                return (
                  <div
                    key={entry.history_id}
                    className="bg-zinc-800/50 hover:bg-zinc-800 rounded-xl p-3 transition"
                  >
                    <div className="flex items-start gap-3">
                      {/* Icon */}
                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 ${reasonInfo.color}`}>
                        <span className="text-lg">{reasonInfo.icon}</span>
                      </div>

                      {/* Content */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between gap-2">
                          <div className="flex items-center gap-2 min-w-0">
                            {!productId && entry.product_name && (
                              <span className="font-medium truncate">{entry.product_name}</span>
                            )}
                            <span className={`text-xs px-2 py-0.5 rounded-full ${reasonInfo.color}`}>
                              {reasonInfo.label}
                            </span>
                          </div>
                          <span className="text-zinc-500 text-xs flex-shrink-0">
                            {formatDate(entry.created_at)}
                          </span>
                        </div>

                        <div className="flex items-center gap-2 mt-1">
                          <span className="text-zinc-500 text-sm">
                            {entry.previous_quantity}
                          </span>
                          <svg className="w-4 h-4 text-zinc-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                          </svg>
                          <span className="text-white font-medium">
                            {entry.new_quantity}
                          </span>
                          <span className={`text-sm font-medium ${isPositive ? 'text-emerald-400' : 'text-red-400'}`}>
                            ({isPositive ? '+' : ''}{entry.adjustment})
                          </span>
                        </div>

                        {entry.notes && (
                          <p className="text-zinc-500 text-xs mt-1 truncate">{entry.notes}</p>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t border-zinc-800">
          <button
            onClick={onClose}
            className="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-medium py-3 rounded-xl transition"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/LinkNFCCard.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { authenticatedFetch } from '@/lib/walletAuth';


// MARK: - Types & Interfaces
interface Card {
  card_uid: string;
  card_uid_display: string;
  card_name: string | null;
  linked_at: string | null;
}

interface LinkNFCCardProps {
  walletAddress: string;
  onCardLinked?: () => void;
  noBorder?: boolean;
}


// MARK: - Component Definition
export default function LinkNFCCard({ walletAddress, onCardLinked, noBorder = false }: LinkNFCCardProps) {
  const [cards, setCards] = useState<Card[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [scanning, setScanning] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [editingCard, setEditingCard] = useState<string | null>(null);
  const [editName, setEditName] = useState('');
  const [nfcSupported, setNfcSupported] = useState(true);
  const [soundRegistered, setSoundRegistered] = useState(false);
  const [nfcController, setNfcController] = useState<AbortController | null>(null);

  const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';

  // Check NFC support on mount

// MARK: - Hooks & Effects
  useEffect(() => {
    setNfcSupported('NDEFReader' in window);
  }, []);

  // Load all linked cards + auto-register sound device
  useEffect(() => {
    fetchCards();
    
    // Auto-register sound device if wallet exists and not already registered
    if (walletAddress) {
      const existingSoundId = localStorage.getItem('yesallofus_sound_id');
      if (!existingSoundId) {
        const soundId = 'snd_' + Math.random().toString(36).slice(2,6);
        const secretKey = Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
        
        localStorage.setItem('yesallofus_sound_id', soundId);
        localStorage.setItem('yesallofus_sound_secret', secretKey);
        
        fetch(`${NFC_API_URL}/sound/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet_address: walletAddress,
            sound_id: soundId,
            secret_key: secretKey
          })
        }).then(res => res.json()).then(data => {
          if (data.success) {
            console.log('üîä Sound device registered:', soundId);
            setSoundRegistered(true);
          }
        }).catch(err => {
          console.warn('Sound registration failed:', err);
        });
      } else {
        console.log('üîä Sound device already registered:', existingSoundId);
        setSoundRegistered(true);
      }
    }
  }, [walletAddress]);


// MARK: - API Calls & Data Fetching
  const fetchCards = async () => {
    setLoading(true);
    try {
      const res = await fetch(`${NFC_API_URL}/nfc/cards-by-wallet/${walletAddress}`);
      if (!res.ok) {
        setCards([]);
        setLoading(false);
        return;
      }
      const data = await res.json();
      if (data.success && data.cards) {
        setCards(data.cards);
      } else {
        setCards([]);
      }
    } catch (err) {
      console.error('Failed to fetch cards:', err);
      setCards([]);
    }
    setLoading(false);
  };

  // Stop any existing NFC scan
  const stopNFCScan = () => {
    if (nfcController) {
      nfcController.abort();
      setNfcController(null);
    }
    setScanning(false);
  };

  const startNFCScan = async () => {
    setError(null);
    setSuccess(null);

    if (!('NDEFReader' in window)) {
      setError('Your browser doesn\'t support NFC. Please open this page in Chrome on Android.');
      return;
    }

    // Abort any existing scan first
    stopNFCScan();

    const controller = new AbortController();
    setNfcController(controller);
    setScanning(true);

    try {
      const ndef = new (window as any).NDEFReader();
      await ndef.scan({ signal: controller.signal });

      ndef.addEventListener('reading', async (event: any) => {
        // Abort to prevent duplicate reads
        controller.abort();
        setNfcController(null);

        const serialNumber = event.serialNumber;

        if (!serialNumber) {
          setError('Could not read card. Please try again.');
          setScanning(false);
          return;
        }

        const cardUid = serialNumber.replace(/:/g, '').toUpperCase();
        await linkCard(cardUid);
        setScanning(false);
      }, { signal: controller.signal });

      ndef.addEventListener('readingerror', () => {
        setError('Error reading card. Please try again.');
        stopNFCScan();
      }, { signal: controller.signal });

    } catch (err: any) {
      console.error('NFC error:', err);
      if (err.name === 'AbortError') {
        // User cancelled - ignore
        return;
      }
      if (err.name === 'NotAllowedError') {
        setError('NFC permission denied. Please allow NFC access.');
      } else if (err.name === 'NotSupportedError') {
        setError('NFC is not supported on this device.');
      } else {
        setError('Failed to start NFC scan. Make sure NFC is enabled.');
      }
      stopNFCScan();
    }
  };

  const linkCard = async (cardUid: string) => {
    try {
      // Use authenticated fetch for protected endpoint
      const res = await authenticatedFetch(walletAddress, `${NFC_API_URL}/nfc/link-card`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress,
          card_uid: cardUid
        })
      });

      const data = await res.json();

      if (data.success) {
        setSuccess('Card linked successfully!');
        await fetchCards();
        onCardLinked?.();
        // Auto-open edit mode for naming
        setEditingCard(cardUid.toLowerCase().replace(/:/g, ''));
        setEditName('');
      } else {
        setError(data.error || 'Failed to link card');
      }
    } catch (err) {
      setError('Failed to link card. Please try again.');
    }
  };

  const unlinkCard = async (cardUid: string, cardName: string | null) => {
    const displayName = cardName || `Card ...${cardUid.slice(-4)}`;
    if (!confirm(`Remove "${displayName}"? You will need to tap it again to re-link.`)) return;

    try {
      // Use authenticated fetch for protected endpoint
      const res = await authenticatedFetch(walletAddress, `${NFC_API_URL}/nfc/unlink-card`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress,
          card_uid: cardUid
        })
      });

      const data = await res.json();

      if (data.success) {
        setSuccess('Card removed successfully');
        await fetchCards();
      } else {
        setError(data.error || 'Failed to remove card');
      }
    } catch (err) {
      setError('Failed to remove card. Please try again.');
    }
  };

  const startEditing = (card: Card) => {
    setEditingCard(card.card_uid);
    setEditName(card.card_name || '');
  };

  const saveCardName = async (cardUid: string) => {
    try {
      const res = await fetch(`${NFC_API_URL}/nfc/card/${cardUid}/name`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress,
          card_name: editName.trim() || null
        })
      });

      const data = await res.json();

      if (data.success) {
        setEditingCard(null);
        setEditName('');
        setSuccess('Card name saved!');
        await fetchCards();
      } else {
        setError(data.error || 'Failed to update card name');
      }
    } catch (err) {
      setError('Failed to update card name. Please try again.');
    }
  };

  const cancelEditing = () => {
    setEditingCard(null);
    setEditName('');
  };

  const formatDate = (dateStr: string | null) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', { 
      day: 'numeric', 
      month: 'short', 
      year: 'numeric' 
    });
  };

  if (loading) {

// MARK: - Main Render
    return (
      <div className={noBorder ? "p-4" : "bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6"}>
        <div className="flex items-center gap-3">
          <div className="w-5 h-5 border-2 border-zinc-500 border-t-white rounded-full animate-spin"></div>
          <span className="text-zinc-400">Loading cards...</span>
        </div>
      </div>
    );
  }

  return (
    <div className={noBorder ? "p-4" : "bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6 mt-6"}>
      {/* Browser Warning - Show if NFC not supported */}
      {!nfcSupported && (
        <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4">
          <div className="flex items-start gap-3">
            <span className="text-amber-400 text-lg">‚ö†Ô∏è</span>
            <div>
              <p className="text-amber-400 font-medium text-sm">Browser not supported</p>
              <p className="text-amber-400/80 text-sm mt-1">NFC card linking requires <strong>Chrome</strong> on Android. Open this page in Chrome to add cards.</p>
            </div>
          </div>
        </div>
      )}

      {/* Header - only show if not noBorder (since CollapsibleSection has its own header) */}
      {!noBorder && (
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <svg className="w-8 h-8 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            <div>
              <h2 className="text-lg font-bold">Payment Cards</h2>
              <p className="text-zinc-500 text-sm">{cards.length} card{cards.length !== 1 ? 's' : ''} linked</p>
            </div>
          </div>
          {cards.length > 0 && cards.length < 5 && !scanning && nfcSupported && (
            <button

// MARK: - Event Handlers
              onClick={startNFCScan}
              className="bg-zinc-800 hover:bg-zinc-700 text-white text-xs font-medium py-1.5 px-3 rounded-lg transition flex items-center gap-1"
            >
              <span>+</span>
              Add
            </button>
          )}
        </div>
      )}

      {/* Card count for noBorder mode */}
      {noBorder && cards.length > 0 && (
        <div className="flex items-center justify-between mb-4">
          <p className="text-zinc-500 text-sm">{cards.length} card{cards.length !== 1 ? 's' : ''} linked</p>
          {cards.length < 5 && !scanning && nfcSupported && (
            <button
              onClick={startNFCScan}
              className="bg-zinc-800 hover:bg-zinc-700 text-white text-xs font-medium py-1.5 px-3 rounded-lg transition flex items-center gap-1"
            >
              <span>+</span>
              Add
            </button>
          )}
        </div>
      )}

      {/* Error */}
      {error && (
        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3 mb-4">
          <p className="text-red-400 text-sm">{error}</p>
          <button 
            onClick={() => setError(null)} 
            className="text-red-400/60 hover:text-red-400 text-xs mt-1"
          >
            Dismiss
          </button>
        </div>
      )}

      {/* Success */}
      {success && (
        <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3 mb-4">
          <p className="text-emerald-400 text-sm">{success}</p>
          <button 
            onClick={() => setSuccess(null)} 
            className="text-emerald-400/60 hover:text-emerald-400 text-xs mt-1"
          >
            Dismiss
          </button>
        </div>
      )}

      {/* Cards List */}
      {cards.length > 0 && (
        <div className="space-y-3 mb-4">
          {cards.map((card) => (
            <div 
              key={card.card_uid}
              className="bg-zinc-800/50 border border-zinc-700/50 rounded-lg p-4"
            >
              {editingCard === card.card_uid ? (
                /* Editing Mode - FIXED FOR MOBILE */
                <div className="space-y-3">
                  <input
                    type="text"
                    value={editName}
                    onChange={(e) => setEditName(e.target.value)}
                    placeholder="e.g., My Black Card"
                    className="w-full bg-zinc-700 border border-zinc-600 rounded-lg px-3 py-3 text-white placeholder-zinc-500 text-sm focus:outline-none focus:border-emerald-500"
                    autoFocus
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') saveCardName(card.card_uid);
                      if (e.key === 'Escape') cancelEditing();
                    }}
                  />
                  <div className="flex gap-2">
                    <button
                      onClick={() => saveCardName(card.card_uid)}
                      className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition"
                    >
                      Save
                    </button>
                    <button
                      onClick={cancelEditing}
                      className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white text-sm font-medium py-2.5 px-4 rounded-lg transition"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              ) : (
                /* Display Mode */
                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <div className="flex items-center gap-3">
                    <span className="text-emerald-400 text-lg">‚úì</span>
                    <div>
                      <div className="flex items-center gap-2">
                        <p className="text-white font-medium">
                          {card.card_name || 'Unnamed Card'}
                        </p>
                        <button
                          onClick={() => startEditing(card)}
                          className="text-zinc-500 hover:text-white transition"
                          title="Edit name"
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                          </svg>
                        </button>
                      </div>
                      <p className="text-zinc-500 text-sm font-mono">
                        {card.card_uid.slice(0, 4)}...{card.card_uid.slice(-4)}
                        {card.linked_at && (
                          <span className="font-sans ml-2">¬∑ Added {formatDate(card.linked_at)}</span>
                        )}
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={() => unlinkCard(card.card_uid, card.card_name)}
                    className="text-zinc-500 hover:text-red-400 text-sm transition self-end sm:self-auto"
                  >
                    Remove
                  </button>
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {/* Scanning State */}
      {scanning && (
        <div className="text-center py-8">
          <div className="relative w-24 h-24 mx-auto mb-4">
            <div className="absolute inset-0 bg-emerald-500/20 rounded-full animate-ping"></div>
            <div className="absolute inset-2 bg-emerald-500/30 rounded-full animate-ping" style={{ animationDelay: '0.2s' }}></div>
            <div className="absolute inset-4 bg-emerald-500/40 rounded-full animate-ping" style={{ animationDelay: '0.4s' }}></div>
            <div className="absolute inset-0 flex items-center justify-center">
              <span className="text-4xl">üí≥</span>
            </div>
          </div>
          <p className="text-emerald-400 font-medium mb-2">Ready to scan</p>
          <p className="text-zinc-400 text-sm mb-4">Hold your NFC card near the back of your phone</p>
          <button
            onClick={stopNFCScan}
            className="text-zinc-500 hover:text-white text-sm transition"
          >
            Cancel
          </button>
        </div>
      )}

      {/* No Cards - Show Add Button */}
      {cards.length === 0 && !scanning && (
        <div>
          <p className="text-zinc-400 text-sm mb-4">
            Link an NFC card to pay at vendors by tapping your card. You can add up to 5 cards.
          </p>
          {nfcSupported ? (
            <>
              <button
                onClick={startNFCScan}
                className="w-full bg-white hover:bg-zinc-100 text-black font-semibold py-4 rounded-xl transition flex items-center justify-center gap-3 shadow-lg"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
                Add NFC Card
              </button>
              <p className="text-zinc-500 text-sm text-center mt-3">
                Requires Chrome on Android with NFC enabled
              </p>
            </>
          ) : (
            <div className="w-full bg-zinc-800 text-zinc-400 font-medium py-4 rounded-xl flex items-center justify-center gap-3">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
              </svg>
              Open in Chrome to add cards
            </div>
          )}
        </div>
      )}

      {/* Max cards reached */}
      {cards.length >= 5 && !scanning && (
        <p className="text-zinc-500 text-sm text-center">
          Maximum 5 cards reached. Remove a card to add another.
        </p>
      )}

      {/* Help text */}
      {cards.length > 0 && !scanning && (
        <p className="text-zinc-600 text-xs mt-4">
          Tap your card at any YesAllOfUs vendor to pay instantly.
        </p>
      )}

      {/* Sound Payment Status */}
      {soundRegistered && (
        <div className="mt-6 pt-6 border-t border-zinc-800">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
              <svg className="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
              </svg>
            </div>
            <div>
              <p className="text-white font-medium text-sm">Sound Payment</p>
              <p className="text-emerald-400 text-xs">Ready</p>
            </div>
            <span className="ml-auto text-emerald-400">‚úì</span>
          </div>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/LiveConversionWidget.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, useCallback } from 'react';


// MARK: - Types & Interfaces
interface ConversionData {
  success: boolean;
  gbp: number;
  rlusd: number;
  rate: {
    rlusd_gbp: number;
    rlusd_usd: number;
    gbp_to_rlusd: number;
    source: string;
    source_url: string;
    aggregated_from: string;
  };
  timestamp: string;
  price_fetched_at: string;
  price_age_ms: number;
  compliance: {
    standard: string;
    data_source: string;
    manipulation_resistant: boolean;
    jurisdiction: string;
  };
}

interface LiveConversionWidgetProps {
  initialGbpAmount?: number;
  onConversionComplete?: (data: ConversionData) => void;
  compact?: boolean;
  showCompliance?: boolean;
}


// MARK: - Component Definition
export default function LiveConversionWidget({
  initialGbpAmount = 0,
  onConversionComplete,
  compact = false,
  showCompliance = true
}: LiveConversionWidgetProps) {

// MARK: - State Management
  const [gbpAmount, setGbpAmount] = useState(initialGbpAmount);
  const [conversionData, setConversionData] = useState<ConversionData | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);
  const [priceAge, setPriceAge] = useState<number>(0);
  const [pulseActive, setPulseActive] = useState(false);

  // Fetch conversion
  const fetchConversion = useCallback(async (amount: number) => {
    if (amount <= 0) {
      setConversionData(null);
      return;
    }

    setIsLoading(true);
    try {
      const res = await fetch(
        `https://api.dltpays.com/convert/gbp-to-rlusd?amount=${amount}&capture=true`
      );
      const data = await res.json();

      if (data.success) {
        setConversionData(data);
        setLastUpdate(new Date());
        setPriceAge(data.price_age_ms);
        setPulseActive(true);
        setTimeout(() => setPulseActive(false), 500);

        if (onConversionComplete) {
          onConversionComplete(data);
        }
      }
    } catch (err) {
      console.error('Conversion error:', err);
    }
    setIsLoading(false);
  }, [onConversionComplete]);

  // Auto-refresh every 10 seconds

// MARK: - Hooks & Effects
  useEffect(() => {
    if (gbpAmount > 0) {
      fetchConversion(gbpAmount);
      const interval = setInterval(() => fetchConversion(gbpAmount), 10000);
      return () => clearInterval(interval);
    }
  }, [gbpAmount, fetchConversion]);

  // Update price age counter
  useEffect(() => {
    const interval = setInterval(() => {
      if (lastUpdate) {
        setPriceAge(Date.now() - lastUpdate.getTime());
      }
    }, 100);
    return () => clearInterval(interval);
  }, [lastUpdate]);

  // Format price age
  const formatPriceAge = (ms: number) => {
    if (ms < 1000) return `${ms}ms`;
    if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
    return `${Math.floor(ms / 60000)}m`;
  };

  // Get freshness color

// MARK: - API Calls & Data Fetching
  const getFreshnessColor = (ms: number) => {
    if (ms < 5000) return '#10b981'; // Green - very fresh
    if (ms < 15000) return '#f59e0b'; // Amber - getting stale
    return '#ef4444'; // Red - stale
  };

  if (compact) {

// MARK: - Main Render
    return (
      <div className="live-conversion-compact">
        <style jsx>{`
          .live-conversion-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            border: 1px solid #30363d;
            border-radius: 8px;
            font-family: 'SF Mono', 'Fira Code', monospace;
          }
          .gecko-icon {
            width: 20px;
            height: 20px;
          }
          .rate-display {
            color: #8cc63f;
            font-size: 13px;
            font-weight: 600;
          }
          .live-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
          }
          @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
          }
        `}</style>
        <img 
  src="https://www.coingecko.com/favicon-96x96.png" 
  alt="CoinGecko" 
  className="h-5 w-auto"
/>
        <span className="rate-display">
          ¬£1 = {conversionData ? conversionData.rate.gbp_to_rlusd.toFixed(4) : '...'} RLUSD
        </span>
        <div className="live-dot" />
      </div>
    );
  }

  return (
    <div className="live-conversion-widget">
      <style jsx>{`
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

        .live-conversion-widget {
          font-family: 'Space Grotesk', sans-serif;
          background: linear-gradient(165deg, #0a0f0d 0%, #0d1810 50%, #081510 100%);
          border: 1px solid rgba(140, 198, 63, 0.2);
          border-radius: 20px;
          padding: 28px;
          position: relative;
          overflow: hidden;
          max-width: 420px;
        }

        .live-conversion-widget::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 2px;
          background: linear-gradient(90deg, transparent, #8cc63f, transparent);
          opacity: 0.6;
        }

        .live-conversion-widget::after {
          content: '';
          position: absolute;
          top: -50%;
          right: -50%;
          width: 100%;
          height: 100%;
          background: radial-gradient(circle, rgba(140, 198, 63, 0.03) 0%, transparent 70%);
          pointer-events: none;
        }

        /* Header */
        .widget-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 24px;
        }

        .coingecko-brand {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .coingecko-logo {
          width: 32px;
          height: 32px;
          filter: drop-shadow(0 0 8px rgba(140, 198, 63, 0.3));
        }

        .brand-text {
          display: flex;
          flex-direction: column;
        }

        .powered-by {
          font-size: 10px;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 1.5px;
        }

        .coingecko-name {
          font-size: 14px;
          font-weight: 600;
          color: #8cc63f;
        }

        .live-indicator {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 6px 12px;
          background: rgba(16, 185, 129, 0.1);
          border: 1px solid rgba(16, 185, 129, 0.3);
          border-radius: 20px;
        }

        .live-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          animation: livePulse 2s ease-in-out infinite;
        }

        @keyframes livePulse {
          0%, 100% { 
            opacity: 1; 
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
          }
          50% { 
            opacity: 0.7; 
            box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
          }
        }

        .live-text {
          font-size: 11px;
          font-weight: 600;
          color: #10b981;
          text-transform: uppercase;
          letter-spacing: 1px;
        }

        /* Conversion Display */
        .conversion-display {
          background: linear-gradient(135deg, rgba(140, 198, 63, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
          border: 1px solid rgba(140, 198, 63, 0.15);
          border-radius: 16px;
          padding: 20px;
          margin-bottom: 20px;
        }

        .rate-row {
          display: flex;
          align-items: baseline;
          justify-content: center;
          gap: 12px;
          margin-bottom: 16px;
        }

        .currency-amount {
          font-family: 'JetBrains Mono', monospace;
        }

        .gbp-amount {
          font-size: 32px;
          font-weight: 700;
          color: #ffffff;
        }

        .gbp-symbol {
          color: #6b7280;
        }

        .equals {
          font-size: 24px;
          color: #4b5563;
        }

        .rlusd-amount {
          font-size: 32px;
          font-weight: 700;
          background: linear-gradient(135deg, #8cc63f 0%, #10b981 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          transition: transform 0.3s ease;
        }

        .rlusd-amount.pulse {
          animation: pricePulse 0.5s ease-out;
        }

        @keyframes pricePulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }

        .rlusd-label {
          font-size: 14px;
          color: #8cc63f;
          font-weight: 600;
        }

        /* Rate Details */
        .rate-details {
          display: flex;
          justify-content: center;
          gap: 24px;
          padding-top: 16px;
          border-top: 1px solid rgba(140, 198, 63, 0.1);
        }

        .rate-item {
          text-align: center;
        }

        .rate-label {
          font-size: 10px;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 1px;
          margin-bottom: 4px;
        }

        .rate-value {
          font-family: 'JetBrains Mono', monospace;
          font-size: 13px;
          color: #d1d5db;
          font-weight: 500;
        }

        /* Freshness Indicator */
        .freshness-bar {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
          background: rgba(0, 0, 0, 0.3);
          border-radius: 10px;
          margin-bottom: 16px;
        }

        .freshness-left {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .freshness-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
          transition: background-color 0.3s ease;
        }

        .freshness-label {
          font-size: 12px;
          color: #9ca3af;
        }

        .freshness-time {
          font-family: 'JetBrains Mono', monospace;
          font-size: 12px;
          font-weight: 600;
          transition: color 0.3s ease;
        }

        /* Compliance Badge */
        .compliance-section {
          background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
          border: 1px solid rgba(59, 130, 246, 0.2);
          border-radius: 12px;
          padding: 16px;
        }

        .compliance-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 12px;
        }

        .shield-icon {
          width: 16px;
          height: 16px;
          color: #3b82f6;
        }

        .compliance-title {
          font-size: 11px;
          font-weight: 600;
          color: #3b82f6;
          text-transform: uppercase;
          letter-spacing: 1px;
        }

        .compliance-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }

        .compliance-item {
          display: flex;
          flex-direction: column;
          gap: 2px;
        }

        .compliance-key {
          font-size: 9px;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .compliance-value {
          font-size: 11px;
          color: #d1d5db;
          font-weight: 500;
        }

        /* Slippage Notice */
        .slippage-notice {
          display: flex;
          gap: 12px;
          padding: 14px 16px;
          background: linear-gradient(135deg, rgba(251, 191, 36, 0.05) 0%, rgba(245, 158, 11, 0.05) 100%);
          border: 1px solid rgba(251, 191, 36, 0.15);
          border-radius: 12px;
          margin-bottom: 16px;
        }

        .slippage-icon {
          flex-shrink: 0;
          width: 20px;
          height: 20px;
          color: #fbbf24;
          opacity: 0.8;
        }

        .slippage-icon svg {
          width: 100%;
          height: 100%;
        }

        .slippage-content {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .slippage-title {
          font-size: 11px;
          font-weight: 600;
          color: #fbbf24;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .slippage-text {
          font-size: 11px;
          color: #9ca3af;
          line-height: 1.5;
        }

        /* Footer */
        .widget-footer {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          margin-top: 16px;
          padding-top: 16px;
          border-top: 1px solid rgba(140, 198, 63, 0.1);
        }

        .exchanges-badge {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 4px 10px;
          background: rgba(140, 198, 63, 0.1);
          border-radius: 12px;
        }

        .exchanges-count {
          font-family: 'JetBrains Mono', monospace;
          font-size: 12px;
          font-weight: 700;
          color: #8cc63f;
        }

        .exchanges-label {
          font-size: 10px;
          color: #6b7280;
        }

        /* Loading State */
        .loading-overlay {
          position: absolute;
          inset: 0;
          background: rgba(10, 15, 13, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 20px;
        }

        .loading-spinner {
          width: 32px;
          height: 32px;
          border: 3px solid rgba(140, 198, 63, 0.2);
          border-top-color: #8cc63f;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        /* Input Section */
        .input-section {
          margin-bottom: 20px;
        }

        .input-wrapper {
          position: relative;
          display: flex;
          align-items: center;
        }

        .currency-prefix {
          position: absolute;
          left: 16px;
          font-size: 24px;
          font-weight: 600;
          color: #6b7280;
          pointer-events: none;
        }

        .amount-input {
          width: 100%;
          padding: 16px 16px 16px 40px;
          font-family: 'JetBrains Mono', monospace;
          font-size: 24px;
          font-weight: 600;
          color: #ffffff;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(140, 198, 63, 0.2);
          border-radius: 12px;
          outline: none;
          transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .amount-input:focus {
          border-color: #8cc63f;
          box-shadow: 0 0 0 3px rgba(140, 198, 63, 0.1);
        }

        .amount-input::placeholder {
          color: #4b5563;
        }
      `}</style>

      {/* Header */}
      <div className="widget-header">
        <div className="coingecko-brand">
          <img
            src="https://static.coingecko.com/s/coingecko-branding-guide-8447de673439420efa0ab1e0e03a1f8b0137c3f142f84f5c41b7fb3cc37eb605.png"
            alt="CoinGecko"
            className="coingecko-logo"
          />
          <div className="brand-text">
            <span className="powered-by">Powered by</span>
            <span className="coingecko-name">CoinGecko Pro</span>
          </div>
        </div>
        <div className="live-indicator">
          <div 
            className="live-dot" 
            style={{ backgroundColor: getFreshnessColor(priceAge) }}
          />
          <span className="live-text">Live</span>
        </div>
      </div>

      {/* Input */}
      <div className="input-section">
        <div className="input-wrapper">
          <span className="currency-prefix">¬£</span>
          <input
            type="number"
            className="amount-input"
            value={gbpAmount || ''}

// MARK: - Event Handlers
            onChange={(e) => setGbpAmount(parseFloat(e.target.value) || 0)}
            placeholder="0.00"
            step="0.01"
            min="0"
          />
        </div>
      </div>

      {/* Conversion Display */}
      {conversionData && (
        <>
          <div className="conversion-display">
            <div className="rate-row">
              <span className="currency-amount gbp-amount">
                <span className="gbp-symbol">¬£</span>
                {conversionData.gbp.toFixed(2)}
              </span>
              <span className="equals">=</span>
              <span className={`currency-amount rlusd-amount ${pulseActive ? 'pulse' : ''}`}>
                {conversionData.rlusd.toFixed(6)}
              </span>
              <span className="rlusd-label">RLUSD</span>
            </div>

            <div className="rate-details">
              <div className="rate-item">
                <div className="rate-label">Rate</div>
                <div className="rate-value">
                  ¬£1 = {conversionData.rate.gbp_to_rlusd.toFixed(6)} RLUSD
                </div>
              </div>
              <div className="rate-item">
                <div className="rate-label">USD Peg</div>
                <div className="rate-value">
                  ${conversionData.rate.rlusd_usd.toFixed(6)}
                </div>
              </div>
            </div>
          </div>

          {/* Freshness Bar */}
          <div className="freshness-bar">
            <div className="freshness-left">
              <div 
                className="freshness-dot" 
                style={{ backgroundColor: getFreshnessColor(priceAge) }}
              />
              <span className="freshness-label">Price Age</span>
            </div>
            <span 
              className="freshness-time"
              style={{ color: getFreshnessColor(priceAge) }}
            >
              {formatPriceAge(priceAge)}
            </span>
          </div>

          {/* Compliance Section */}
          {showCompliance && conversionData.compliance && (
            <div className="compliance-section">
              <div className="compliance-header">
                <svg className="shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                </svg>
                <span className="compliance-title">Regulatory Compliance</span>
              </div>
              <div className="compliance-grid">
                <div className="compliance-item">
                  <span className="compliance-key">Standard</span>
                  <span className="compliance-value">{conversionData.compliance.standard}</span>
                </div>
                <div className="compliance-item">
                  <span className="compliance-key">Jurisdiction</span>
                  <span className="compliance-value">{conversionData.compliance.jurisdiction}</span>
                </div>
                <div className="compliance-item">
                  <span className="compliance-key">Data Source</span>
                  <span className="compliance-value">{conversionData.compliance.data_source}</span>
                </div>
                <div className="compliance-item">
                  <span className="compliance-key">Manipulation Resistant</span>
                  <span className="compliance-value">
                    {conversionData.compliance.manipulation_resistant ? '‚úì Yes' : 'No'}
                  </span>
                </div>
              </div>
            </div>
          )}

          {/* Slippage Disclaimer */}
          <div className="slippage-notice">
            <div className="slippage-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 16v-4M12 8h.01" />
              </svg>
            </div>
            <div className="slippage-content">
              <span className="slippage-title">Settlement Protection</span>
              <span className="slippage-text">
                Final settlement may vary by up to 0.3% from the quoted rate ‚Äî this is standard practice 
                used by major payment providers including Visa, Mastercard, and institutional FX desks 
                to ensure reliable transaction completion.
              </span>
            </div>
          </div>

          {/* Footer */}
          <div className="widget-footer">
            <div className="exchanges-badge">
              <span className="exchanges-count">600+</span>
              <span className="exchanges-label">exchanges aggregated</span>
            </div>
          </div>
        </>
      )}

      {/* Loading Overlay */}
      {isLoading && !conversionData && (
        <div className="loading-overlay">
          <div className="loading-spinner" />
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/LoginScreen.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';
import { refreshWalletAuth } from '@/lib/walletAuth';
import BackgroundVideo from './BackgroundVideo';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';


// MARK: - Types & Interfaces
interface LoginScreenProps {
  onLogin: (
    wallet: string, 
    method: 'xaman' | 'crossmark' | 'web3auth', 
    extras?: {
      socialProvider?: string;
      xamanUserToken?: string;
    }
  ) => void;
  // Vendor-specific props
  requireTrustline?: boolean;
  claimStore?: { store_name: string } | null;
  referringStore?: { store_name: string; store_id: string } | null;
  storagePrefix?: 'vendor' | 'affiliate';
  title?: string;
  subtitle?: string;
  showLogo?: boolean;
}


// MARK: - Component Definition
export default function LoginScreen({ 
  onLogin,
  requireTrustline = false,
  claimStore = null,
  referringStore = null,
  storagePrefix = 'affiliate',
  title = 'Members & Affiliate Dashboard',
  subtitle = 'Connect your wallet to view your earnings',
  showLogo = false
}: LoginScreenProps) {

// MARK: - State Management
  const [error, setError] = useState('');
  const [connecting, setConnecting] = useState<'none' | 'xaman' | 'crossmark' | 'web3auth'>('none');
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [xamanDeepLink, setXamanDeepLink] = useState<string | null>(null);
  const [loginId, setLoginId] = useState<string | null>(null);
  const [trustlineConfirmed, setTrustlineConfirmed] = useState(!requireTrustline);
  const [termsAccepted, setTermsAccepted] = useState(false);
  // Detect if we're on affiliate dashboard route
const isAffiliateDashboard = typeof window !== 'undefined' && window.location.pathname === '/affiliate-dashboard';
const displayTitle = isAffiliateDashboard ? 'AFFILIATES' : 'MEMBERS';

  // Storage keys based on prefix
  const walletKey = storagePrefix === 'vendor' ? 'vendorWalletAddress' : 'walletAddress';
  const methodKey = storagePrefix === 'vendor' ? 'vendorLoginMethod' : 'loginMethod';

  // Complete customer signup from email link (affiliate only)
const completeCustomerSignup = async (wallet: string) => {
  if (storagePrefix !== 'affiliate') return;
  
  // First check URL params
  const urlParams = new URLSearchParams(window.location.search);
  let email = urlParams.get('email');
  let storeId = urlParams.get('store');
  let join = urlParams.get('join');
  
  // If not in URL, check sessionStorage (saved before login)
  if (!email || join !== '1') {
    const pending = safeGetItem('pendingSignup');
    if (pending) {
      const parsed = JSON.parse(pending);
      email = parsed.email;
      storeId = parsed.storeId;
      join = '1';
    }
  }
  
  if (!email || join !== '1') return;
  
  try {
    const res = await fetch('https://api.dltpays.com/nfc/api/v1/nfc/complete-customer-signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: email,
        wallet_address: wallet,
        store_id: storeId || null
      })
    });
    
    const data = await res.json();
    
    if (data.success && data.card_linked) {
      console.log('‚úÖ NFC card linked to wallet:', data.card_uid);
    }
    
    // Clean up
    safeRemoveItem('pendingSignup');
    
    // Clean up URL params
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.delete('email');
    newUrl.searchParams.delete('store');
    newUrl.searchParams.delete('join');
    window.history.replaceState({}, '', newUrl.toString());
    
  } catch (err) {
    console.error('Failed to complete customer signup:', err);
  }
};

  // Handle store auto-join from URL params (affiliate only)

// MARK: - Event Handlers
  const handleStoreAutoJoin = async (wallet: string) => {
    if (storagePrefix !== 'affiliate') return;
    
    const params = new URLSearchParams(window.location.search);
    const storeId = params.get('store');
    
    if (storeId) {
      const parentRef = params.get('ref') || '';
      try {
        await fetch(`${API_URL}/affiliate/register-public`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            store_id: storeId, 
            wallet: wallet,
            parent_referral_code: parentRef
          })
        });
        window.history.replaceState({}, '', window.location.pathname);
        await new Promise(r => setTimeout(r, 500));
      } catch (err) {
        console.error('Failed to auto-join store:', err);
      }
    }
  };

  // Xaman polling

// MARK: - Hooks & Effects
  useEffect(() => {
    if (!loginId || connecting !== 'xaman') return;
    
    const interval = setInterval(async () => {
      try {
        const res = await fetch(`${API_URL}/xaman/login/poll/${loginId}`);
        const data = await res.json();
        
        if (data.status === 'signed' && data.wallet_address) {
          clearInterval(interval);
          
          await handleStoreAutoJoin(data.wallet_address);
          await completeCustomerSignup(data.wallet_address);
          
          safeSetItem(walletKey, data.wallet_address);
          safeSetItem(methodKey, 'xaman');

          // Refresh wallet auth token for protected API calls
          await refreshWalletAuth(data.wallet_address);

          setConnecting('none');
          setXamanQR(null);
          setLoginId(null);

          onLogin(data.wallet_address, 'xaman', { xamanUserToken: data.xaman_user_token });
          
        } else if (data.status === 'expired' || data.status === 'cancelled') {
          clearInterval(interval);
          setError(data.status === 'expired' ? 'QR code expired. Please try again.' : 'Login cancelled.');
          setConnecting('none');
          setXamanQR(null);
          setLoginId(null);
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 3000);

    // Clean up after 5 minutes
    const timeout = setTimeout(() => {
      clearInterval(interval);
      if (connecting === 'xaman') {
        setError('Connection timed out. Please try again.');
        setConnecting('none');
        setXamanQR(null);
        setLoginId(null);
      }
    }, 300000);

    return () => {
      clearInterval(interval);
      clearTimeout(timeout);
    };
  }, [loginId, connecting, onLogin, walletKey, methodKey]);

  const connectXaman = async () => {
    if (!termsAccepted) return;
    
    setConnecting('xaman');
    setError('');
    
    try {
      const res = await fetch(`${API_URL}/xaman/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const data = await res.json();
      
      if (data.error) {
        setError(data.error);
        setConnecting('none');
        return;
      }
      
      setXamanQR(data.qr_png);
      setXamanDeepLink(data.deep_link);
      setLoginId(data.login_id);
    } catch (err) {
      setError('Failed to connect. Please try again.');
      setConnecting('none');
    }
  };

  const connectCrossmark = async () => {
    if (!termsAccepted) return;
    
    setConnecting('crossmark');
    setError('');
    
    try {
      const sdk = (window as any).xrpl?.crossmark;
      if (!sdk) {
        setError('Crossmark not installed. Please install the browser extension.');
        setConnecting('none');
        return;
      }
      
      const res = await sdk.methods.signInAndWait();
      const address = res.response?.data?.address;
      
      if (!address) {
        throw new Error('Connection cancelled');
      }
      
      // Save to Firebase for vendor
      if (storagePrefix === 'vendor') {
        await fetch(`${API_URL}/store/save-crossmark-wallet`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet_address: address, store_id: null })
        });
      }
      
      await handleStoreAutoJoin(address);
      await completeCustomerSignup(address);

      safeSetItem(walletKey, address);
      safeSetItem(methodKey, 'crossmark');

      // Refresh wallet auth token for protected API calls
      await refreshWalletAuth(address);

      onLogin(address, 'crossmark');
      
    } catch (err: any) {
      if (!err.message?.includes('cancelled')) {
        setError('Failed to connect Crossmark. Please try again.');
      }
    }
    setConnecting('none');
  };

  const connectWeb3Auth = async () => {
    if (!termsAccepted) return;
    
    setConnecting('web3auth');
    setError('');
    
    try {
      const { loginWithWeb3Auth } = await import('@/lib/web3auth');
      const result = await loginWithWeb3Auth();
      
      if (!result) {
        setError('Login cancelled');
        setConnecting('none');
        return;
      }
      
      const address = typeof result === 'string' ? result : result.address;
      const provider = typeof result === 'string' ? 'google' : (result.provider || 'google');
      
      await handleStoreAutoJoin(address);
      await completeCustomerSignup(address);

      safeSetItem(walletKey, address);
      safeSetItem(methodKey, 'web3auth');
      safeSetItem('socialProvider', provider);

      // Refresh wallet auth token for protected API calls
      await refreshWalletAuth(address);

      onLogin(address, 'web3auth', { socialProvider: provider });
      
    } catch (err: any) {
      console.error('Web3Auth error:', err);
      if (!err.message?.includes('cancelled') && !err.message?.includes('closed')) {
        setError('Failed to connect. Please try again.');
      }
    }
    setConnecting('none');
  };

  const cancelXamanLogin = () => {
    setConnecting('none');
    setXamanQR(null);
    setXamanDeepLink(null);
    setLoginId(null);
  };

  // Check if wallet options should be enabled
  const walletOptionsEnabled = !requireTrustline || trustlineConfirmed;


// MARK: - Main Render
  return (
  <div className="min-h-screen bg-[#0d0d0d] text-white font-sans relative flex flex-col overflow-x-hidden">
    {/* Background Video - same for both vendor and affiliate */}
    <BackgroundVideo 
      src="/affiliate-hq.webm"
      overlay={true}
    />
    
    <main className="relative z-10 w-full max-w-xl lg:max-w-4xl xl:max-w-5xl mx-auto px-4 sm:px-6 flex-1 flex items-center justify-center py-8">
  <div className="w-full max-w-full">
        {/* Title - SVG Badge Style */}
        <div className="flex flex-col items-center mb-4 mt-2 md:mb-6 md:mt-4">
          <svg viewBox="0 0 280 85" className="w-full max-w-72 h-auto">
            <defs>
              <linearGradient id="partnerGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stopColor="#10b981" />
                <stop offset="50%" stopColor="#3b82f6" />
                <stop offset="100%" stopColor="#8b5cf6" />
              </linearGradient>
            </defs>
            
            {/* Dynamic text - PARTNERS or MEMBERS */}
<text x="140" y="28" textAnchor="middle" fill="url(#partnerGradient)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="4">
  {storagePrefix === 'vendor' ? 'PARTNERS' : displayTitle}
</text>
            
            {/* DASHBOARD text */}
            <text x="140" y="48" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="11" letterSpacing="3">
              DASHBOARD
            </text>
            
            {/* Divider line */}
            <line x1="80" y1="60" x2="200" y2="60" stroke="#27272a" strokeWidth="1"/>
            
            {/* Subtitle */}
<text x="140" y="76" textAnchor="middle" fill="#a1a1aa" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="400" fontSize="10" letterSpacing="0.5">
  {storagePrefix === 'vendor' ? 'Sign in to manage your account' : 'Sign in to manage your affiliate commissions'}
</text>
          </svg>
        </div>

        {/* Error Message */}
        {error && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
            <p className="text-red-400 text-sm">{error}</p>
          </div>
        )}

          {/* Claim Store Banner (vendor only) */}
          {claimStore && (
            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6 mb-6">
              <h3 className="font-semibold text-emerald-400 mb-2">‚úì Dashboard ready to connect</h3>
              <p className="text-zinc-300 text-sm mb-1">
                <strong>{claimStore.store_name}</strong>
              </p>
              <p className="text-zinc-500 text-sm">
                Connect your wallet below to complete setup.
              </p>
            </div>
          )}

          {/* Referral Store Banner (vendor only) */}
          {referringStore && (
            <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6 mb-6">
              <h3 className="font-semibold text-blue-400 mb-2">üéÅ Referred by {referringStore.store_name}</h3>
              <p className="text-zinc-300 text-sm mb-1">
                You'll get <strong className="text-white">50% off platform fees</strong> for your first month!
              </p>
              <p className="text-zinc-500 text-sm">
                Connect your wallet below to get started.
              </p>
            </div>
          )}
          
          {/* Xaman QR Screen */}
          {connecting === 'xaman' && xamanQR && (
            <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8 mb-6">
              <p className="text-zinc-300 mb-4 text-center">Scan with Xaman app</p>
              <img src={xamanQR} alt="Xaman QR" className="mx-auto mb-4 rounded-lg max-w-[200px]" />
              <div className="flex items-center justify-center gap-2 text-zinc-400 text-sm mb-4">
                <span className="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></span>
                Waiting for signature...
              </div>
              {xamanDeepLink && (
                <a href={xamanDeepLink} className="text-sky-400 text-sm hover:underline block text-center mb-4">
                  Open in Xaman app ‚Üí
                </a>
              )}
              <button onClick={cancelXamanLogin} className="text-zinc-500 text-sm hover:text-white w-full text-center">
                ‚Üê Back
              </button>
            </div>
          )}
          
          {/* Login Options - 3 Column Grid */}
{connecting === 'none' && (
  <div className="space-y-4 w-full max-w-full overflow-hidden">

    {/* Terms Agreement - Above all cards */}
<label className="flex items-center justify-center gap-2 cursor-pointer text-xs md:text-sm text-zinc-400 hover:text-zinc-300 px-2 md:px-0 w-full max-w-full">
  <span className="leading-tight text-center md:text-left">
    I agree to the{' '}
    <a href="/terms" target="_blank" className="text-sky-400 hover:underline">Terms of Service</a>
    {' '}and{' '}
    <a href="/privacy" target="_blank" className="text-sky-400 hover:underline">Privacy</a>{' '}
<span className="text-sky-400">Policy</span>
    {' '}
    <input
      type="checkbox"
      checked={termsAccepted}
      onChange={(e) => setTermsAccepted(e.target.checked)}
      className="w-4 h-4 inline-block align-middle"
    />
  </span>
</label>

    {/* 3 Column Grid */}
    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 lg:gap-6 w-full max-w-full px-1 py-2">
      
      <button
  onClick={connectXaman}
  disabled={!termsAccepted}
  className={`order-2 md:order-1 group relative bg-zinc-900 border rounded-xl p-4 lg:p-6 xl:p-8 transition-all ${
    termsAccepted
      ? 'border-zinc-800 hover:border-sky-500 hover:shadow-[0_0_30px_-5px_rgba(14,165,233,0.3)] hover:scale-[1.02]'
      : 'border-zinc-800 opacity-50 cursor-not-allowed'
  }`}
>
        {/* Badge */}
        <div className="absolute top-3 right-3 bg-emerald-500/20 text-emerald-400 text-[10px] px-2 py-0.5 rounded font-semibold">
          LIVE
        </div>

        {/* Logo */}
<div className="w-14 h-14 lg:w-20 lg:h-20 xl:w-24 xl:h-24 mx-auto mb-3 lg:mb-4 rounded-xl overflow-hidden">
  <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-full h-full object-cover" />
</div>

        {/* Title */}
<h3 className="font-bold text-center mb-2 lg:text-lg xl:text-xl">Xaman</h3>
<p className="text-zinc-500 text-xs lg:text-sm xl:text-base text-center mb-4">Mobile wallet with push notifications</p>

{/* Connect Button */}
<div className="mt-4 pt-4 border-t border-zinc-800">
  <span className="text-sm lg:text-base font-medium text-center block group-hover:text-emerald-400 transition-colors">
    Connect ‚Üí
  </span>
</div>
      </button>

      {/* CENTER: Web3Auth (Primary) */}
<button
  onClick={connectWeb3Auth}
  disabled={!termsAccepted}
  className={`order-1 md:order-2 group relative bg-gradient-to-br from-emerald-500/10 to-sky-500/10 border-2 rounded-xl p-4 lg:p-6 xl:p-8 transition-all ${
    termsAccepted
      ? 'border-emerald-500/50 hover:border-emerald-500 hover:shadow-[0_0_40px_-5px_rgba(16,185,129,0.4)] hover:scale-[1.02]'
      : 'border-zinc-700 opacity-50 cursor-not-allowed'
  }`}
>
  {/* Badge */}
  <div className="absolute top-3 right-3 bg-emerald-500/30 text-emerald-300 text-[10px] px-2 py-0.5 rounded font-bold">
    EASIEST
  </div>
  {/* Social Icons Stack */}
<div className="flex justify-center -space-x-2 lg:-space-x-3 mb-3 mt-4">
    {/* Google */}
    <div className="w-10 h-10 lg:w-14 lg:h-14 bg-white rounded-full flex items-center justify-center border-2 border-zinc-900 shadow-lg">
  <svg className="w-5 h-5 lg:w-7 lg:h-7" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
    </div>
    {/* Apple */}
    <div className="w-10 h-10 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900 shadow-lg">
      <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
      </svg>
    </div>
    {/* More Badge */}
    <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center border-2 border-zinc-900 shadow-lg">
      <span className="text-white text-[10px] font-bold">+10</span>
    </div>
  </div>
  {/* Title */}
<h3 className="font-bold text-center mb-2 lg:text-lg xl:text-xl">Social Login</h3>
<p className="text-zinc-400 text-xs lg:text-sm xl:text-base text-center mb-4">Instant wallet with Google, Apple & more</p>

{/* Connect Button */}
<div className="mt-4 pt-4 border-t border-zinc-800">
    <span className="text-sm font-medium text-center block group-hover:text-emerald-400 transition-colors">
      Connect ‚Üí
    </span>
  </div>
</button>

      {/* RIGHT: Crossmark */}
<button
  onClick={connectCrossmark}
  disabled={!termsAccepted}
  className={`hidden md:block order-3 group relative bg-zinc-900 border rounded-xl p-4 lg:p-6 xl:p-8 transition-all ${
    termsAccepted
      ? 'border-zinc-800 hover:border-sky-500 hover:shadow-[0_0_30px_-5px_rgba(14,165,233,0.3)] hover:scale-[1.02]'
      : 'border-zinc-800 opacity-50 cursor-not-allowed'
  }`}
>
        {/* Badge - Browser Icons Stack */}
<div className="absolute top-2 right-2 flex flex-col items-center gap-1">
  <div className="flex -space-x-1">
    {/* Chrome */}
    <div className="w-5 h-5 bg-white rounded-full flex items-center justify-center border border-zinc-800 shadow-sm">
      <img 
        src="https://www.google.com/chrome/static/images/chrome-logo.svg" 
        alt="Chrome" 
        className="w-4 h-4"
      />
    </div>
    {/* Edge */}
    <div className="w-5 h-5 bg-white rounded-full flex items-center justify-center border border-zinc-800 shadow-sm">
      <img 
        src="https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg" 
        alt="Edge" 
        className="w-4 h-4"
      />
    </div>
    {/* Brave - Icon only */}
    <div className="w-5 h-5 bg-white rounded-full flex items-center justify-center border border-zinc-800 shadow-sm">
      <img 
        src="https://cdn.svgporn.com/logos/brave.svg" 
        alt="Brave" 
        className="w-3.5 h-3.5"
      />
    </div>
  </div>
  <span className="text-[7px] text-zinc-500 font-semibold tracking-wide">BROWSER</span>
</div>

        {/* Logo */}
        <div className="w-14 h-14 lg:w-20 lg:h-20 xl:w-24 xl:h-24 mx-auto mb-3 lg:mb-4 rounded-xl overflow-hidden">
  <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-full h-full object-cover" />
</div>

        {/* Title */}
<h3 className="font-bold text-center mb-2 lg:text-lg xl:text-xl">Crossmark</h3>
<p className="text-zinc-500 text-xs lg:text-sm xl:text-base text-center mb-4">Browser extension with auto-sign</p>

{/* Connect Button */}
<div className="mt-4 pt-4 border-t border-zinc-800">
          <span className="text-sm lg:text-base font-medium text-center block group-hover:text-sky-400 transition-colors">
  Connect ‚Üí
</span>
        </div>
      </button>
    </div>

    {/* Download Links */}
    <p className="text-zinc-500 text-xs text-center">
      New to crypto?{' '}
      <a href="https://xaman.app" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline">Get Xaman</a>
      {' '}or{' '}
      <a href="https://crossmark.io" target="_blank" rel="noopener noreferrer" className="text-sky-400 hover:underline">Crossmark</a>
    </p>
  </div>
)}

{/* Back to Homepage */}
<a 
  href="/" 
  className="flex items-center justify-center gap-2 text-zinc-500 hover:text-zinc-300 text-sm mb-8 transition"
>
  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
  </svg>
  <span>Back to Homepage</span>
</a>

{/* Connecting States */}
{(connecting === 'crossmark' || connecting === 'web3auth') && (
  <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-8">
    <div className="flex items-center justify-center gap-2 text-zinc-400">
      <div className="w-5 h-5 border-2 border-sky-500 border-t-transparent rounded-full animate-spin"></div>
      <span>Connecting{connecting === 'web3auth' ? ' with Social' : ' to Crossmark'}...</span>
    </div>
  </div>
)}
        </div>
</main>

{/* YAOFUS Instant Badge - Footer */}
{/* YAOFUS Instant Badge - Footer */}
<footer className="relative z-10 py-4 flex flex-col items-center gap-0.5 mt-auto">
  <span className="text-zinc-500 text-[10px] font-medium tracking-wider">SECURE</span>
  <span className="text-base font-extrabold tracking-widest">
    <span className="text-emerald-500">Y</span>
    <span className="text-green-500">A</span>
    <span className="text-blue-500">O</span>
    <span className="text-indigo-500">F</span>
    <span className="text-violet-500">U</span>
    <span className="text-purple-500">S</span>
  </span>
  <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">LOGIN</span>
  <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
    <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
    <span>Powered by YesAllOfUs</span>
  </div>
</footer>
</div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/Logo.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';


// MARK: - Component Definition
export default function Logo({ size = 40 }: { size?: number }) {

// MARK: - State Management
  const [use3D, setUse3D] = useState(false);
  const [checked, setChecked] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    // Check if device can handle 3D
    const isDesktop = window.matchMedia('(min-width: 768px)').matches;
    const hasGoodCPU = navigator.hardwareConcurrency > 4;
    
    // Check WebGL support
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    const hasWebGL = !!gl;
    
    setUse3D(isDesktop && hasWebGL && hasGoodCPU);
    setChecked(true);
  }, []);

  // Show static logo until check completes (prevents flash)
  if (!checked) {

// MARK: - Main Render
    return (
      <Image 
        src="/dltpayslogo1.png" 
        alt="YesAllofUs" 
        width={size} 
        height={size} 
        className="rounded-lg"
      />
    );
  }

  if (use3D) {
    return (
      <div style={{ width: size, height: size }}>
        {/* @ts-ignore - model-viewer is a web component */}
        <model-viewer
          src="https://arweave.net/hdTXnxScjddEJr4FIvLpfeC1ZaAOwIr5bANUZ9zDC9c"
          auto-rotate
          rotation-per-second="30deg"
          disable-zoom
          disable-tap
          disable-pan
          interaction-prompt="none"
          style={{ 
            width: '100%', 
            height: '100%',
            '--poster-color': 'transparent'
          }}
        />
      </div>
    );
  }

  return (
    <Image 
      src="/dltpayslogo1.png" 
      alt="YesAllofUs" 
      width={size} 
      height={size} 
      className="rounded-lg"
    />
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/MilestoneChecklist.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect } from 'react';


// MARK: - Types & Interfaces
interface Milestone {
  id: string;
  label: string;
  icon: React.ReactNode;
  timestamp: string | null;
}

interface MilestoneChecklistProps {
  type?: 'vendor' | 'customer';
  forceCollapsed?: boolean;
  storeId: string;
  walletAddress: string;
  autoSignEnabled?: boolean;
  // Direct status props for customer milestones (DEPRECATED - now fetches from API)
  walletFunded?: boolean;
  trustlineSet?: boolean;
  tapPayEnabled?: boolean;
  nfcCardAdded?: boolean;
  joinedAffiliate?: boolean;
  onMilestoneAchieved?: (milestone: string) => void;
  onInfoClick?: (milestoneId: string) => void;
  onDismiss?: () => void;
onAllComplete?: (isComplete: boolean) => void;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';


// MARK: - Component Definition
export default function MilestoneChecklist({ 
  type = 'vendor',
  forceCollapsed = false,
  storeId, 
  walletAddress,
  autoSignEnabled,
  walletFunded,
  trustlineSet,
  tapPayEnabled,
  nfcCardAdded,
  joinedAffiliate,
  onMilestoneAchieved,
  onInfoClick,
  onDismiss,
onAllComplete
}: MilestoneChecklistProps) {
  const [milestones, setMilestones] = useState<Record<string, string | null>>({});

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [isExpanded, setIsExpanded] = useState(true);
  
  // Force collapsed when prop is set

// MARK: - Hooks & Effects
  useEffect(() => {
    if (forceCollapsed) {
      setIsExpanded(false);
    }
  }, [forceCollapsed]);

  // Color scheme based on type - matches dashboard header gradients
  const colors = type === 'customer' ? {
    progressBg: 'from-lime-300 via-teal-400 via-cyan-400 via-blue-500 to-violet-500',
    completeBg: 'bg-gradient-to-r from-lime-300/15 via-teal-400/15 via-cyan-400/18 via-blue-500/18 to-violet-500/20',
    completeBorder: 'border-cyan-400/20',
    completeTextClass: 'bg-gradient-to-r from-emerald-400 via-teal-400 via-cyan-400 via-blue-400 to-violet-400 bg-clip-text text-transparent',
    iconComplete: 'text-emerald-500',
    iconIncomplete: 'text-zinc-600',
    completeHover: 'hover:text-emerald-400',
    tickGradientId: 'customerTickGradient',
    tickGradient: (
      <linearGradient id="customerTickGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stopColor="#10b981" />
        <stop offset="100%" stopColor="#10b981" />
      </linearGradient>
    ),
  } : {
    progressBg: 'from-emerald-300 via-emerald-500 via-green-600 to-green-900',
    completeBg: 'bg-gradient-to-r from-emerald-500/10 via-green-500/10 to-green-700/10',
    completeBorder: 'border-emerald-500/30',
    completeTextClass: 'bg-gradient-to-r from-emerald-300 via-emerald-400 to-green-500 bg-clip-text text-transparent',
    iconComplete: 'text-emerald-400',
    iconIncomplete: 'text-zinc-600',
    completeHover: 'hover:text-emerald-400',
    tickGradientId: 'vendorTickGradient',
    tickGradient: (
      <linearGradient id="vendorTickGradient" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stopColor="#6ee7b7" />
        <stop offset="50%" stopColor="#10b981" />
        <stop offset="100%" stopColor="#15803d" />
      </linearGradient>
    ),
  };

  // Vendor milestones
  const vendorMilestoneConfig: Milestone[] = [
    {
      id: 'wallet_funded',
      label: 'Wallet funded',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'trustline_set',
      label: 'Trustline set',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'auto_sign_enabled',
      label: 'Auto-sign enabled',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'first_affiliate',
      label: 'First affiliate joined',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'first_payment_received',
      label: 'First payment received',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'first_payout_sent',
      label: 'First payout sent',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'first_partner_signed',
      label: 'First partner signed up',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      ),
      timestamp: null
    }
  ];

  // Customer/Affiliate milestones - UPDATED with trustlines_set
  const customerMilestoneConfig: Milestone[] = [
    {
      id: 'wallet_funded',
      label: 'Wallet funded (1.5 XRP)',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'trustlines_set',
      label: 'RLUSD & USDC added',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'tap_pay_enabled',
      label: 'Tap-to-Pay enabled',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'nfc_card_added',
      label: 'NFC card linked',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
        </svg>
      ),
      timestamp: null
    },
    {
      id: 'joined_affiliate',
      label: 'Joined as affiliate',
      icon: (
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      ),
      timestamp: null
    }
  ];

  const milestoneConfig = type === 'customer' ? customerMilestoneConfig : vendorMilestoneConfig;
  const storageKey = type === 'customer' ? `milestones_collapsed_customer_${walletAddress}` : `milestones_collapsed_${storeId}`;
  const dismissKey = type === 'customer' ? `milestones_dismissed_customer_${walletAddress}` : `milestones_dismissed_${storeId}`;

  // Fetch milestones from API with polling
  useEffect(() => {
    const collapsed = localStorage.getItem(storageKey);
    if (collapsed === 'true') {
      setIsExpanded(false);
    }

    if (type === 'customer') {
      fetchCustomerMilestones();
      const pollInterval = setInterval(() => {
        fetchCustomerMilestones();
      }, 5000);
      return () => clearInterval(pollInterval);
    } else {
      fetchMilestones();
      const pollInterval = setInterval(() => {
        fetchMilestones();
      }, 5000);
      return () => clearInterval(pollInterval);
    }
  }, [storeId, walletAddress, type]);


// MARK: - API Calls & Data Fetching
  const fetchMilestones = async () => {
    try {
      const endpoint = `${API_URL}/store/${storeId}/milestones`;
      const res = await fetch(endpoint);
      const data = await res.json();
      if (data.success) {
        setMilestones(data.milestones);
      }
    } catch (err) {
      console.error('Failed to fetch milestones:', err);
    }
    if (loading) {
      setLoading(false);
    }
  };

  const fetchCustomerMilestones = async () => {
    try {
      const endpoint = `${API_URL}/customer/milestones/${walletAddress}`;
      const res = await fetch(endpoint);
      const data = await res.json();
      if (data.success) {
        setMilestones(data.milestones);
      }
    } catch (err) {
      console.error('Failed to fetch customer milestones:', err);
    }
    if (loading) {
      setLoading(false);
    }
  };

  const completed = Object.values(milestones).filter(v => v !== null).length;
  const total = milestoneConfig.length;


// MARK: - Event Handlers
  const handleToggleExpand = () => {
    const newState = !isExpanded;
    setIsExpanded(newState);
    localStorage.setItem(storageKey, (!newState).toString());
  };

  const handleDismiss = () => {
    localStorage.setItem(dismissKey, 'true');
    onDismiss?.();
  };

  const progressPercent = Math.round((completed / total) * 100);
  const isComplete = completed === total;

  // Notify parent of completion status
useEffect(() => {
  onAllComplete?.(isComplete);
}, [isComplete, onAllComplete]);

  const GradientTick = () => (
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24">
      <defs>
        {colors.tickGradient}
      </defs>
      <path 
        stroke={`url(#${colors.tickGradientId})`} 
        strokeLinecap="round" 
        strokeLinejoin="round" 
        strokeWidth={2.5} 
        d="M5 13l4 4L19 7" 
      />
    </svg>
  );

  if (loading) {

// MARK: - Main Render
    return (
      <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6">
        <div className="flex items-center gap-2 text-zinc-500">
          <div className="w-4 h-4 border-2 border-zinc-600 border-t-zinc-400 rounded-full animate-spin"></div>
          Loading progress...
        </div>
      </div>
    );
  }

  // Complete and collapsed
  if (isComplete && !isExpanded) {
    return (
      <div className={`${colors.completeBg} border ${colors.completeBorder} rounded-xl p-4 mb-6 flex items-center justify-between`}>
        <div className="flex items-center gap-3">
          <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24">
            <defs>
              {colors.tickGradient}
            </defs>
            <path 
              stroke={`url(#${colors.tickGradientId})`}
              strokeLinecap="round" 
              strokeLinejoin="round" 
              strokeWidth={2} 
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" 
            />
          </svg>
          <span className={`font-medium ${colors.completeTextClass}`}>All milestones complete!</span>
          <span className="text-zinc-500 text-sm">{completed}/{total}</span>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={handleToggleExpand}
            className={`p-1.5 text-zinc-500 ${colors.completeHover} transition`}
            title="Expand"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <button
            onClick={handleDismiss}
            className="p-1.5 text-zinc-500 hover:text-zinc-300 transition"
            title="Hide permanently"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
    );
  }

  // Collapsed state (not complete)
  if (!isExpanded) {
    return (
      <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 mb-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3 flex-1">
            <span className="font-medium">Your Progress</span>
            <span className="text-zinc-500 text-sm mr-2">{completed}/{total}</span>
          </div>
          <div className="flex items-center gap-3 flex-1 max-w-xs">
            <div className="h-2 bg-zinc-800 rounded-full flex-1 overflow-hidden">
              <div 
                className={`h-full bg-gradient-to-r ${colors.progressBg} transition-all duration-500`}
                style={{ width: `${progressPercent}%` }}
              />
            </div>
            <span className="text-zinc-500 text-sm">{progressPercent}%</span>
          </div>
          <div className="flex items-center gap-1 ml-3">
            <button
              onClick={handleToggleExpand}
              className="p-1.5 text-zinc-500 hover:text-white transition"
              title="Expand"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <button
              onClick={handleDismiss}
              className="p-1.5 text-zinc-500 hover:text-zinc-300 transition"
              title="Hide progress"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Expanded state
  return (
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6">
      <svg width="0" height="0" className="absolute">
        <defs>
          {colors.tickGradient}
        </defs>
      </svg>

      <div className="flex items-center justify-between mb-4">
        <h3 className="font-bold">Your Progress</h3>
        <div className="flex items-center gap-2">
          <span className="text-zinc-500 text-sm">{completed}/{total}</span>
          <button
            onClick={handleToggleExpand}
            className="p-1.5 text-zinc-500 hover:text-white transition"
            title="Collapse"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
            </svg>
          </button>
          {isComplete && (
            <button
              onClick={handleDismiss}
              className="p-1.5 text-zinc-500 hover:text-zinc-300 transition"
              title="Hide permanently"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          )}
        </div>
      </div>

      <div className="h-2 bg-zinc-800 rounded-full mb-6 overflow-hidden">
        <div 
          className={`h-full bg-gradient-to-r ${colors.progressBg} transition-all duration-500`}
          style={{ width: `${progressPercent}%` }}
        />
      </div>

      <div className="space-y-3">
        {milestoneConfig.map((m) => {
          const isItemComplete = !!milestones[m.id];
          return (
            <div 
              key={m.id}
              className={`flex items-center gap-3 p-3 rounded-lg transition group ${
                isItemComplete ? colors.completeBg : 'bg-zinc-800/50'
              }`}
            >
              <div className={isItemComplete ? '' : colors.iconIncomplete}>
                {isItemComplete ? (
                  <GradientTick />
                ) : (
                  m.icon
                )}
              </div>
              <span className={`flex-1 text-sm font-medium ${isItemComplete ? colors.completeTextClass : 'text-zinc-400'}`}>
                {m.label}
              </span>
              {onInfoClick && (
                <button
                  onClick={() => onInfoClick(m.id)}
                  className="p-1 text-zinc-600 hover:text-sky-400 lg:opacity-0 lg:group-hover:opacity-100 transition-all"
                  title="Learn more"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                  </svg>
                </button>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/MoveCloserAnimation.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { motion } from 'framer-motion';


// MARK: - Types & Interfaces
interface MoveCloserAnimationProps {
  className?: string;
}


// MARK: - Component Definition
export default function MoveCloserAnimation({ className = '' }: MoveCloserAnimationProps) {

// MARK: - Main Render
  return (
    <div className={`flex flex-col items-center justify-center flex-1 min-h-[280px] py-6 ${className}`}>
      {/* Main animation area */}
      <div className="relative flex flex-col items-center justify-center flex-1 w-full">
        
        {/* Sound waves emanating upward */}
        <div className="absolute top-0 left-1/2 -translate-x-1/2">
          {[0, 1, 2, 3].map((i) => (
            <motion.div
              key={i}
              className="absolute left-1/2 -translate-x-1/2 rounded-full border border-purple-500/60"
              style={{ width: 40 + i * 20, height: 20 + i * 10 }}
              initial={{ opacity: 0, y: 30 }}
              animate={{ 
                opacity: [0, 0.5, 0],
                y: [30, -30, -90],
                scale: [0.8, 1, 1.2],
              }}
              transition={{
                duration: 2,
                repeat: Infinity,
                delay: i * 0.35,
                ease: "easeOut"
              }}
            />
          ))}
        </div>

        {/* Phone moving down (suggesting "bring closer") */}
        <motion.div
          className="relative z-10 mt-8"
          animate={{ 
            y: [0, 20, 0],
          }}
          transition={{ 
            duration: 2.5, 
            repeat: Infinity, 
            ease: "easeInOut" 
          }}
        >
          {/* Phone body */}
          <div className="relative w-28 h-52 bg-zinc-800/80 rounded-3xl border-2 border-purple-500/50 shadow-xl shadow-purple-500/30 backdrop-blur-sm">
            {/* Notch */}
            <div className="absolute top-3 left-1/2 -translate-x-1/2 w-14 h-2 bg-zinc-700 rounded-full" />
            
            {/* Screen */}
            <div className="absolute inset-3 top-7 bg-gradient-to-b from-purple-500/20 to-blue-500/20 rounded-2xl flex items-center justify-center">
              {/* Mic icon pulsing */}
              <motion.div
                className="w-16 h-16 rounded-full bg-purple-500/30 flex items-center justify-center"
                animate={{ scale: [1, 1.2, 1] }}
                transition={{ duration: 1.2, repeat: Infinity }}
              >
                <svg className="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
              </motion.div>
            </div>
            
            {/* Home indicator */}
            <div className="absolute bottom-2 left-1/2 -translate-x-1/2 w-12 h-1.5 bg-zinc-600 rounded-full" />
          </div>
        </motion.div>
      </div>

      {/* Instruction text */}
      <motion.p 
  className="text-zinc-400 text-xl mt-8 text-center font-medium"
  animate={{ opacity: [0.5, 1, 0.5] }}
  transition={{ duration: 2, repeat: Infinity }}
>
  Hold phone near sender device
</motion.p>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/MyPendingStatus.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Constants & Configuration

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface PendingCustomer {
  id: string;
  name: string | null;
  email: string;
  card_uid: string;
  card_name: string | null;
  store_id: string | null;
  created_at: string | null;
}

export default function MyPendingStatus({ 
  walletAddress,
  email 
}: { 
  walletAddress?: string;
  email?: string;
}) {
  const [pending, setPending] = useState<PendingCustomer | null>(null);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [editing, setEditing] = useState(false);
  const [newEmail, setNewEmail] = useState('');
  const [updating, setUpdating] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);


// MARK: - API Calls & Data Fetching
  const fetchStatus = async () => {
    if (!walletAddress && !email) {
      setLoading(false);
      return;
    }
    
    try {
      const params = new URLSearchParams();
      if (walletAddress) params.append('wallet_address', walletAddress);
      if (email) params.append('email', email);
      
      const res = await fetch(`${NFC_API_URL}/nfc/my-pending-status?${params}`);
      const data = await res.json();
      
      if (data.success && data.pending) {
        setPending(data.customer);
      } else {
        setPending(null);
      }
    } catch (err) {
      console.error('Failed to fetch pending status:', err);
    }
    setLoading(false);
  };


// MARK: - Hooks & Effects
  useEffect(() => {
    fetchStatus();
  }, [walletAddress, email]);


// MARK: - Event Handlers
  const handleUpdateEmail = async () => {
    if (!newEmail.trim() || !pending) {
      setMessage({ type: 'error', text: 'Please enter a valid email' });
      return;
    }

    setUpdating(true);
    setMessage(null);

    try {
      const res = await fetch(`${NFC_API_URL}/nfc/pending/update-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          card_uid: pending.card_uid,
          email: newEmail.trim()
        })
      });

      const data = await res.json();

      if (data.success) {
        setMessage({ type: 'success', text: `Welcome email sent to ${data.new_email}` });
        setEditing(false);
        setNewEmail('');
        fetchStatus();
      } else {
        setMessage({ type: 'error', text: data.error || 'Failed to update email' });
      }
    } catch (err) {
      setMessage({ type: 'error', text: 'Failed to update email' });
    }

    setUpdating(false);
  };

  const handleResendEmail = async () => {
    if (!pending) return;
    
    setUpdating(true);
    setMessage(null);

    try {
      const res = await fetch(`${NFC_API_URL}/nfc/pending/update-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          card_uid: pending.card_uid,
          email: pending.email
        })
      });

      const data = await res.json();

      if (data.success) {
        setMessage({ type: 'success', text: `Welcome email resent to ${pending.email}` });
      } else {
        setMessage({ type: 'error', text: data.error || 'Failed to resend email' });
      }
    } catch (err) {
      setMessage({ type: 'error', text: 'Failed to resend email' });
    }

    setUpdating(false);
  };

  // Don't show anything if not pending
  if (loading || !pending) {
    return null;
  }


// MARK: - Main Render
  return (
    <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-5 mb-6">
      <div className="flex items-start gap-3 mb-4">
        <div className="text-2xl">üìß</div>
        <div className="flex-1">
          <h3 className="font-bold text-amber-400">Complete Your Signup</h3>
          <p className="text-zinc-400 text-sm mt-1">
            Check your email ({pending.email}) for a welcome link to complete your account setup.
          </p>
        </div>
      </div>

      {message && (
        <div className={`mb-4 p-3 rounded-lg text-sm ${
          message.type === 'success' 
            ? 'bg-emerald-500/10 border border-emerald-500/30 text-emerald-400'
            : 'bg-red-500/10 border border-red-500/30 text-red-400'
        }`}>
          {message.text}
        </div>
      )}

      {editing ? (
        <div className="space-y-3">
          <div>
            <label className="text-zinc-500 text-xs block mb-1">New Email Address</label>
            <input
              type="email"
              value={newEmail}
              onChange={(e) => setNewEmail(e.target.value)}
              placeholder="your@email.com"
              className="w-full bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-2.5 text-white placeholder-zinc-500 focus:outline-none focus:border-amber-500"
              autoFocus
            />
          </div>
          <div className="flex gap-2">
            <button
              onClick={handleUpdateEmail}
              disabled={updating}
              className="flex-1 bg-amber-500 hover:bg-amber-400 text-black font-medium py-2.5 rounded-lg transition disabled:opacity-50"
            >
              {updating ? 'Sending...' : 'Update & Send Email'}
            </button>
            <button
              onClick={() => {
                setEditing(false);
                setNewEmail('');
                setMessage(null);
              }}
              className="px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg transition"
            >
              Cancel
            </button>
          </div>
        </div>
      ) : (
        <div className="flex flex-col sm:flex-row gap-2">
          <button
            onClick={handleResendEmail}
            disabled={updating}
            className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-2.5 px-4 rounded-lg text-sm font-medium transition disabled:opacity-50"
          >
            {updating ? 'Sending...' : 'Resend Welcome Email'}
          </button>
          <button
            onClick={() => {
              setEditing(true);
              setNewEmail(pending.email);
              setMessage(null);
            }}
            className="flex-1 sm:flex-none bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-2.5 px-4 rounded-lg text-sm transition"
          >
            Wrong Email? Update It
          </button>
        </div>
      )}

      {pending.card_name && (
        <p className="text-zinc-600 text-xs mt-3">
          Card: {pending.card_name}
        </p>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/NebulaBackground.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useState, useRef } from 'react';


// MARK: - Types & Interfaces
interface NebulaBackgroundProps {
  opacity?: number;
  blur?: number;
}


// MARK: - Constants & Configuration
const VIDEOS = ['/nebula-bg.webm'];
const CYCLE_DURATION = 60000; // 1 minute


// MARK: - Component Definition
export default function NebulaBackground({ opacity = 0.4, blur = 0 }: NebulaBackgroundProps) {

// MARK: - State Management
  const [currentVideo, setCurrentVideo] = useState(0);
  const [fading, setFading] = useState(false);
  const videoRef = useRef<HTMLVideoElement>(null);


// MARK: - Hooks & Effects
  useEffect(() => {
    const interval = setInterval(() => {
      setFading(true);
      
      setTimeout(() => {
        setCurrentVideo(prev => (prev + 1) % VIDEOS.length);
        setFading(false);
      }, 1000); // 1s fade transition
      
    }, CYCLE_DURATION);

    return () => clearInterval(interval);
  }, []);

  // Play video when source changes
  useEffect(() => {
  if (videoRef.current) {
    videoRef.current.load();
    videoRef.current.playbackRate = 0.3;
    videoRef.current.play().catch(() => {});
  }
}, [currentVideo]);


// MARK: - Main Render
  return (
    <div 
      className="fixed inset-0 z-0 pointer-events-none overflow-hidden"
      aria-hidden="true"
    >
      <video
        ref={videoRef}
        autoPlay
        muted
        loop
        playsInline
        preload="auto"
        className="absolute inset-0 w-full h-full object-cover transition-opacity duration-1000"
        style={{ 
          opacity: fading ? 0 : opacity,
          filter: blur > 0 ? `blur(${blur}px)` : undefined,
        }}
      >
        <source src={VIDEOS[currentVideo]} type="video/webm" />
<source src="/nebula-bg.mp4" type="video/mp4" />
      </video>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/NFCPayment.jsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState } from 'react';


// MARK: - Component Definition
export default function NFCPayment() {

// MARK: - State Management
  const [status, setStatus] = useState('idle');
  const [lastUID, setLastUID] = useState(null);
  const [error, setError] = useState(null);

  const startNFCScan = async () => {
    if (!('NDEFReader' in window)) {
      // Fallback: try Web NFC or show manual option
      setError('Web NFC not supported. Use Chrome on Android, or tap to test manually.');
      return;
    }

    setStatus('scanning');
    setError(null);

    try {
      const ndef = new NDEFReader();
      await ndef.scan();

      ndef.addEventListener('reading', async ({ serialNumber }) => {
        console.log('NFC UID:', serialNumber);
        setLastUID(serialNumber);
        setStatus('processing');

        // Call your API
        window.location.href = `https://api.dltpays.com/api/v1/nfc/tap/${serialNumber}`;
      });

      ndef.addEventListener('readingerror', () => {
        setError('Could not read NFC tag');
        setStatus('idle');
      });

    } catch (err) {
      setError(err.message);
      setStatus('idle');
    }
  };

  // Manual test for iPhone (Web NFC not supported on iOS Safari)
  const manualTest = () => {
    const uid = prompt('Enter NFC UID (or use test123):', '04:5B:07:0A:FD:75:80');
    if (uid) {
      window.location.href = `https://api.dltpays.com/api/v1/nfc/tap/${uid}`;
    }
  };


// MARK: - Main Render
  return (
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6">
      <h2 className="text-lg font-bold mb-4">üí≥ Tap to Pay</h2>
      
      {status === 'idle' && (
        <>
          <p className="text-zinc-400 text-sm mb-4">
            Customer taps their card on your device to pay.
          </p>
          <button

// MARK: - Event Handlers
            onClick={startNFCScan}
            className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-semibold py-4 rounded-xl transition text-lg mb-3"
          >
            üì± Start NFC Scan
          </button>
          <button
            onClick={manualTest}
            className="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-xl transition text-sm"
          >
            Manual Test (for demo)
          </button>
        </>
      )}

      {status === 'scanning' && (
        <div className="text-center py-8">
          <div className="text-6xl mb-4 animate-pulse">üì±</div>
          <p className="text-emerald-400 font-semibold text-lg">Ready to scan...</p>
          <p className="text-zinc-500 text-sm mt-2">Hold card to back of phone</p>
          <button
            onClick={() => setStatus('idle')}
            className="mt-6 text-zinc-500 hover:text-white text-sm"
          >
            Cancel
          </button>
        </div>
      )}

      {status === 'processing' && (
        <div className="text-center py-8">
          <div className="text-6xl mb-4">‚è≥</div>
          <p className="text-yellow-400 font-semibold">Processing payment...</p>
          <p className="text-zinc-500 text-sm mt-2">UID: {lastUID}</p>
        </div>
      )}

      {error && (
        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mt-4">
          <p className="text-red-400 text-sm">{error}</p>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/NFCTapPay.tsx
// =================================================
// components/NFCTapPay.tsx
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Constants & Configuration
const PLUGINS_API_URL = 'https://api.dltpays.com/plugins/api/v1';

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface NFCTapPayProps {
  amount: number;
  storeId: string;
  paymentId: string;
  onSuccess: (txHash: string, receiptId?: string) => void;
  onError: (error: string) => void;
  onNotRegistered: () => void; // Redirect to signup
  isCheckoutSession?: boolean;
  tipAmount?: number;
}

export default function NFCTapPay({
  amount,
  storeId,
  paymentId,
  onSuccess,
  onError,
  onNotRegistered,
  isCheckoutSession = false,
  tipAmount = 0
}: NFCTapPayProps) {

// MARK: - State Management
  const [nfcSupported, setNfcSupported] = useState(false);
  const [isAndroid, setIsAndroid] = useState(false);
  const [nfcScanning, setNfcScanning] = useState(false);
  const [nfcController, setNfcController] = useState<AbortController | null>(null);
  const [processing, setProcessing] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    setNfcSupported('NDEFReader' in window);
    setIsAndroid(/android/i.test(navigator.userAgent));
  }, []);


// MARK: - API Calls & Data Fetching
  const getPayEndpoint = () => {
    if (isCheckoutSession) {
      return `${PLUGINS_API_URL}/checkout/session/${storeId}/pay`;
    }
    return `${NFC_API_URL}/payment-link/${paymentId}/pay`;
  };

  const stopNFCScan = () => {
    if (nfcController) {
      nfcController.abort();
      setNfcController(null);
    }
    setNfcScanning(false);
  };

  const startNFCScan = async () => {
    if (!('NDEFReader' in window)) {
      onError('NFC not supported on this device');
      return;
    }

    stopNFCScan();

    const controller = new AbortController();
    setNfcController(controller);
    setNfcScanning(true);

    try {
      const ndef = new (window as any).NDEFReader();
      await ndef.scan({ signal: controller.signal });

      ndef.addEventListener('reading', async (event: any) => {
        controller.abort();
        
        const uid = event.serialNumber?.replace(/:/g, '').toUpperCase();
        if (!uid) {
          onError('Could not read card');
          setNfcScanning(false);
          setNfcController(null);
          return;
        }

        setNfcScanning(false);
        setNfcController(null);
        setProcessing(true);

        try {
          const res = await fetch(getPayEndpoint(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card_uid: uid, tip_amount: tipAmount, split_payment_id: paymentId })
          });

          const result = await res.json();

          if (result.success) {
            onSuccess(result.tx_hash, result.receipt_id);
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
          } else {
            // Check for not registered errors
            if (result.error?.includes('not found') || 
                result.error?.includes('not linked') ||
                result.error?.includes('not registered') ||
                result.error?.includes('Card not recognized')) {
              onNotRegistered();
            } else if (result.error === 'NO_SIGNER_AUTHORITY') {
              onError('NO_SIGNER_AUTHORITY');
            } else {
              onError(result.error || 'Payment failed');
            }
          }
        } catch (err) {
          onError('Payment failed');
        } finally {
          setProcessing(false);
        }
      });

      ndef.addEventListener('readingerror', () => {
        onError('Error reading card');
        stopNFCScan();
      });

    } catch (err: any) {
      if (err.name === 'NotAllowedError') {
        onError('NFC permission denied');
      } else if (err.name !== 'AbortError') {
        onError('Failed to start NFC');
      }
      stopNFCScan();
    }
  };

  // Don't render if not Android or NFC not supported
  if (!isAndroid || !nfcSupported) {
    return null;
  }

  if (processing) {

// MARK: - Main Render
    return (
      <div className="flex items-center justify-center gap-2 py-3">
        <div className="w-5 h-5 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
        <span className="text-emerald-400">Processing...</span>
      </div>
    );
  }

  return (
    <button

// MARK: - Event Handlers
      onClick={startNFCScan}
      disabled={nfcScanning}
      className={`flex-1 font-semibold py-3 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl ${
        nfcScanning 
          ? 'bg-emerald-600 text-white animate-pulse' 
          : 'bg-emerald-500 hover:bg-emerald-400 text-white'
      }`}
    >
      {nfcScanning ? 'Tap Card Now...' : 'Pay Now'}
    </button>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/OnboardingSetup.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';
import { QRCodeSVG } from 'qrcode.react';
import SuccessMessage from './SuccessMessage';


// MARK: - Types & Interfaces
interface OnboardingSetupProps {
  walletAddress: string | null;
  walletStatus: {
    funded: boolean;
    xrp_balance: number;
    rlusd_trustline: boolean;
    usdc_trustline?: boolean;
    rlusd_balance: number;
    usdc_balance?: number;
  } | null;
  autoSignEnabled: boolean;
  loginMethod: 'xaman' | 'crossmark' | 'web3auth' | null;
  onSetupComplete: () => void;
  onRefreshWallet: () => void;
  onSetupStatusChange?: (isComplete: boolean) => void;
  storagePrefix?: 'vendor' | 'affiliate';
  onVendorEnableAutoPay?: () => Promise<void>;
}

// USDC on XRPL

// MARK: - Constants & Configuration
const USDC_CURRENCY = '5553444300000000000000000000000000000000';
const USDC_ISSUER = 'rcEGREd8NmkKRE8GE424sksyt1tJVFZwu';

// RLUSD on XRPL
const RLUSD_CURRENCY = '524C555344000000000000000000000000000000';
const RLUSD_ISSUER = 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De';


// MARK: - Component Definition
export default function OnboardingSetup({
walletAddress,
walletStatus,
autoSignEnabled,
loginMethod,
onSetupComplete,
onRefreshWallet,
onSetupStatusChange,
storagePrefix = 'affiliate',
onVendorEnableAutoPay
}: OnboardingSetupProps) {

// MARK: - State Management
const [showSuccess, setShowSuccess] = useState(false);
const [settingUp, setSettingUp] = useState(false);
  const [setupProgress, setSetupProgress] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [copied, setCopied] = useState(false);
  const [showQR, setShowQR] = useState(false);
  const [expandedStep, setExpandedStep] = useState<number | null>(null);
  const [refreshing, setRefreshing] = useState(false);
const [xamanQR, setXamanQR] = useState<string | null>(null);
const [xamanDeepLink, setXamanDeepLink] = useState<string | null>(null);
const [loginId, setLoginId] = useState<string | null>(null);
const [connectingXaman, setConnectingXaman] = useState(false);

  // Determine current step

// MARK: - API Calls & Data Fetching
  const getOnboardingStep = () => {
  if (!walletAddress) return 'connect_wallet';
  if (!walletStatus) return 'loading';
  if (!walletStatus?.funded || walletStatus?.xrp_balance < 1.5) return 'fund_wallet';
    if (!walletStatus?.rlusd_trustline || !walletStatus?.usdc_trustline) return 'add_trustlines';
    if (!autoSignEnabled && (loginMethod === 'web3auth' || storagePrefix === 'vendor')) return 'enable_autopay';
    return 'complete';
  };

  const currentStep = getOnboardingStep();

// Notify parent of setup status

// MARK: - Hooks & Effects
useEffect(() => {
  onSetupStatusChange?.(currentStep === 'complete');
}, [currentStep, onSetupStatusChange]);

// Mark wizard as active when showing steps
useEffect(() => {
  if (currentStep && currentStep !== 'complete' && currentStep !== 'loading') {
    const sessionKey = `onboarding_active_${storagePrefix}_${walletAddress}`;
    console.log('WIZARD ACTIVE - setting key:', sessionKey, 'step:', currentStep);
    safeSetItem(sessionKey, 'true');
  }
}, [currentStep, storagePrefix, walletAddress]);

// Auto-refresh wallet status
useEffect(() => {
  if (currentStep !== 'add_trustlines') return;
  
  const interval = setInterval(() => {
    onRefreshWallet();
  }, 10000);
  
  return () => clearInterval(interval);
}, [currentStep, onRefreshWallet]);

// Show success once when all steps complete AND wizard was actively used
useEffect(() => {
  if (currentStep === 'complete' && walletAddress) {
    const sessionKey = `onboarding_active_${storagePrefix}_${walletAddress}`;
    const wizardWasActive = typeof window !== 'undefined' && safeGetItem(sessionKey);
    
    // Only show success if wizard was actively used this session
    if (wizardWasActive) {
      const shownKey = `onboarding_success_shown_${storagePrefix}_${walletAddress}`;
      const alreadyShown = typeof window !== 'undefined' && localStorage.getItem(shownKey);
      if (!alreadyShown) {
        setShowSuccess(true);
        localStorage.setItem(shownKey, 'true');
      }
      // Clear the active flag after showing success
      safeRemoveItem(sessionKey);
    }
  }
}, [currentStep, storagePrefix, walletAddress]);

// Xaman polling
useEffect(() => {
  if (!loginId || !connectingXaman) return;
  
  const interval = setInterval(async () => {
    try {
      const res = await fetch(`https://api.dltpays.com/api/v1/xaman/login/poll/${loginId}`);
      const data = await res.json();
      
      if (data.status === 'signed' && data.wallet_address) {
        clearInterval(interval);
        
        const walletKey = storagePrefix === 'vendor' ? 'vendorWalletAddress' : 'walletAddress';
const methodKey = storagePrefix === 'vendor' ? 'vendorLoginMethod' : 'loginMethod';
safeSetItem(walletKey, data.wallet_address);
safeSetItem(methodKey, 'xaman');
        
        setConnectingXaman(false);
        setXamanQR(null);
        setLoginId(null);
        
        window.location.reload();
        
      } else if (data.status === 'expired' || data.status === 'cancelled') {
        clearInterval(interval);
        setError(data.status === 'expired' ? 'QR code expired. Please try again.' : 'Login cancelled.');
        setConnectingXaman(false);
        setXamanQR(null);
        setLoginId(null);
      }
    } catch (err) {
      console.error('Poll error:', err);
    }
  }, 3000);

  const timeout = setTimeout(() => {
    clearInterval(interval);
    if (connectingXaman) {
      setError('Connection timed out. Please try again.');
      setConnectingXaman(false);
      setXamanQR(null);
      setLoginId(null);
    }
  }, 300000);

  return () => {
    clearInterval(interval);
    clearTimeout(timeout);
  };
}, [loginId, connectingXaman]);

  const copyAddress = () => {
  if (!walletAddress) return;
  navigator.clipboard.writeText(walletAddress);
  setCopied(true);
  setTimeout(() => setCopied(false), 2000);
};


// MARK: - Event Handlers
  const handleRefresh = async () => {
  setRefreshing(true);
  await onRefreshWallet();
  setTimeout(() => setRefreshing(false), 1000);
};

// Xaman login
const connectXaman = async () => {
  setConnectingXaman(true);
  setError(null);
  
  try {
    const res = await fetch('https://api.dltpays.com/api/v1/xaman/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await res.json();
    
    if (data.error) {
      setError(data.error);
      setConnectingXaman(false);
      return;
    }
    
    setXamanQR(data.qr_png);
    setXamanDeepLink(data.deep_link);
    setLoginId(data.login_id);
  } catch (err) {
    setError('Failed to connect. Please try again.');
    setConnectingXaman(false);
  }
};

const cancelXamanLogin = () => {
  setConnectingXaman(false);
  setXamanQR(null);
  setXamanDeepLink(null);
  setLoginId(null);
};

  // Setup trustlines - Web3Auth automatic
  const setupTrustlinesWeb3Auth = async () => {
    if (!walletAddress || loginMethod !== 'web3auth') return;
    
    setSettingUp(true);
    setError(null);
    setSetupProgress('Connecting to wallet...');

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth || !web3auth.provider) {
        throw new Error('Web3Auth session not available. Please sign in again.');
      }

      const walletStatusRes = await fetch(`https://api.dltpays.com/api/v1/wallet/status/${walletAddress}`);
      const walletStatusData = await walletStatusRes.json();

      if (!walletStatusData.rlusd_trustline) {
        setSetupProgress('Adding RLUSD trustline...');
        const rlusdTrustlineTx = {
          TransactionType: 'TrustSet',
          Account: walletAddress,
          LimitAmount: {
            currency: RLUSD_CURRENCY,
            issuer: RLUSD_ISSUER,
            value: '1000000',
          },
        };
        await web3auth.provider.request({
          method: 'xrpl_submitTransaction',
          params: { transaction: rlusdTrustlineTx },
        });
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      if (!walletStatusData.usdc_trustline) {
        setSetupProgress('Adding USDC trustline...');
        const usdcTrustlineTx = {
          TransactionType: 'TrustSet',
          Account: walletAddress,
          LimitAmount: {
            currency: USDC_CURRENCY,
            issuer: USDC_ISSUER,
            value: '1000000',
          },
        };
        await web3auth.provider.request({
          method: 'xrpl_submitTransaction',
          params: { transaction: usdcTrustlineTx },
        });
        setSetupProgress('Confirming...');
        await new Promise(resolve => setTimeout(resolve, 3000));
      }

      setSetupProgress('Trustlines added ‚úì');
      await new Promise(resolve => setTimeout(resolve, 1000));
      onRefreshWallet();
      
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to add trustlines';
      setError(message);
    }
    
    setSettingUp(false);
    setSetupProgress(null);
  };

  // Setup trustlines - Crossmark
  const setupTrustlinesCrossmark = async (currency: 'rlusd' | 'usdc') => {
  if (!walletAddress || loginMethod !== 'crossmark') return;
  
  setSettingUp(true);
  setError(null);
  setSetupProgress(`Opening Crossmark for ${currency.toUpperCase()}...`);

  try {
    const sdk = (window as any).xrpl?.crossmark;
    if (!sdk) {
      window.open('https://crossmark.io', '_blank');
      throw new Error('Crossmark not detected. Please install Crossmark and refresh.');
    }

      const trustlineConfig = currency === 'rlusd' 
        ? { currency: RLUSD_CURRENCY, issuer: RLUSD_ISSUER }
        : { currency: USDC_CURRENCY, issuer: USDC_ISSUER };

      const response = await sdk.methods.signAndSubmitAndWait({
  TransactionType: 'TrustSet',
  Account: walletAddress,
  LimitAmount: {
    currency: trustlineConfig.currency,
    issuer: trustlineConfig.issuer,
    value: '1000000',
  },
});

if (response?.response?.data?.resp?.result?.validated) {
        setSetupProgress(`${currency.toUpperCase()} trustline added ‚úì`);
        await new Promise(resolve => setTimeout(resolve, 1500));
        onRefreshWallet();
      } else {
        throw new Error('Transaction was not validated');
      }
      
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to add trustline';
      setError(message);
    }
    
    setSettingUp(false);
    setSetupProgress(null);
  };

  // Setup trustlines - Xaman (opens deep link)
  const setupTrustlinesXaman = (currency: 'rlusd' | 'usdc') => {
    const trustlineConfig = currency === 'rlusd' 
      ? { currency: 'RLUSD', issuer: RLUSD_ISSUER }
      : { currency: USDC_CURRENCY, issuer: USDC_ISSUER };

    // Xaman deep link for TrustSet
    const xamanUrl = `https://xumm.app/detect/xapp:xumm.tangem-cards?tx=${encodeURIComponent(JSON.stringify({
      TransactionType: 'TrustSet',
      LimitAmount: {
        currency: trustlineConfig.currency,
        issuer: trustlineConfig.issuer,
        value: '1000000',
      },
    }))}`;
    
    window.open(xamanUrl, '_blank');
  };

  // Enable auto-pay (Web3Auth only)
  const enableAutoPay = async () => {
    if (!walletAddress || loginMethod !== 'web3auth') return;
    
    setSettingUp(true);
    setError(null);
    setSetupProgress('Preparing Tap-to-Pay...');

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth || !web3auth.provider) {
        throw new Error('Web3Auth session not available. Please sign in again.');
      }

      const settingsRes = await fetch('https://api.dltpays.com/nfc/api/v1/nfc/customer/setup-autosign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const settingsData = await settingsRes.json();
      
      if (settingsData.error) throw new Error(settingsData.error);
      
      if (settingsData.signer_exists || settingsData.auto_sign_enabled) {
        // Update milestone in Firebase via enable-autosign endpoint
        try {
          await fetch('https://api.dltpays.com/nfc/api/v1/nfc/customer/enable-autosign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              wallet_address: walletAddress,
              max_transaction: 25
            })
          });
        } catch (e) {
          console.error('Failed to update milestone:', e);
        }
        onRefreshWallet();
        onSetupComplete();
        return;
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) throw new Error('Platform signer not configured');

      setSetupProgress('Confirm in your wallet...');
      
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 1,
        SignerEntries: [{ SignerEntry: { Account: platformSignerAddress, SignerWeight: 1 } }]
      };
      
      await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: signerListSetTx }
      });

      setSetupProgress('Verifying setup...');
      await new Promise(resolve => setTimeout(resolve, 2000));

      const verifyRes = await fetch(`https://api.dltpays.com/nfc/api/v1/nfc/customer/autosign-status/${walletAddress}`);
      const verifyData = await verifyRes.json();
      
      if (verifyData.auto_sign_enabled) {
        // Update milestone in Firebase
        try {
          await fetch('https://api.dltpays.com/api/v1/store/update-milestone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              wallet_address: walletAddress,
              milestone: 'auto_sign_enabled'
            })
          });
        } catch (e) {
          console.error('Failed to update milestone:', e);
        }
        onRefreshWallet();
        onSetupComplete();
      } else {
        throw new Error('Auto-sign setup failed. Please try again.');
      }
      
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to enable Tap-to-Pay';
      setError(message);
    }
    
    setSettingUp(false);
    setSetupProgress(null);
  };

  // Show success message when complete (only once per session)
if (currentStep === 'complete') {
  if (showSuccess) {

// MARK: - Main Render
    return (
      <SuccessMessage
        walletAddress={walletAddress || undefined}
        loginMethod={loginMethod}
      />
    );
  }
  return null;
}

  // Loading state
  if (currentStep === 'loading') {
    return (
      <div className="bg-zinc-900/80 backdrop-blur border border-zinc-800 rounded-2xl p-6 mb-6">
        <div className="flex items-center gap-3">
          <div className="w-5 h-5 border-2 border-zinc-600 border-t-amber-500 rounded-full animate-spin"></div>
          <span className="text-zinc-400">Loading wallet status...</span>
        </div>
      </div>
    );
  }

  // Step completion status
  const steps = [
  {
    id: 0,
    name: 'Connect Wallet',
    complete: !!walletAddress,
    active: currentStep === 'connect_wallet'
  },
  { 
    id: 1, 
    name: 'Fund Wallet', 
    complete: walletAddress && walletStatus ? walletStatus?.funded && (walletStatus?.xrp_balance || 0) >= 1.5 : false,
    active: currentStep === 'fund_wallet'
  },
    { 
  id: 2, 
  name: 'Add Trustlines', 
  complete: walletStatus?.rlusd_trustline && walletStatus?.usdc_trustline,
  active: currentStep === 'add_trustlines'
},
    { 
      id: 3, 
      name: loginMethod === 'web3auth' ? 'Enable Tap-to-Pay' : 'Ready!', 
      complete: loginMethod !== 'web3auth' || autoSignEnabled,
      active: currentStep === 'enable_autopay'
    },
  ];

  return (
    <div className="bg-gradient-to-br from-zinc-900 via-zinc-900 to-amber-950/20 border border-amber-500/20 rounded-2xl overflow-hidden mb-6 shadow-xl shadow-amber-500/5">
      {/* Header */}
      <div className="bg-gradient-to-r from-amber-500/10 to-orange-500/10 border-b border-amber-500/20 px-6 py-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl flex items-center justify-center shadow-lg shadow-amber-500/20 overflow-hidden">
              <img src="/dltpayslogo1.png" alt="YesAllOfUs" className="w-10 h-10 object-cover" />
            </div>
            <div>
              <h2 className="text-lg font-bold text-white">Complete Your Setup</h2>
              <p className="text-zinc-400 text-sm">3 quick steps to start earning</p>
            </div>
          </div>
          <button
  onClick={handleRefresh}
  disabled={refreshing}
  className="flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition text-sm font-medium text-zinc-300"
>
  <svg className={`w-4 h-4 ${refreshing ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
  </svg>
  {refreshing ? 'Checking...' : 'Refresh'}
</button>
        </div>
      </div>

      {/* Progress Steps */}
      <div className="px-6 py-4 border-b border-zinc-800/50 landscape:mt-8">
        <div className="flex items-center justify-around lg:justify-start">
          {steps.map((step, index) => (
            <div key={step.id} className={`flex items-start lg:items-center flex-none lg:flex-1 ${index === steps.length - 1 ? 'lg:flex-none' : ''}`}>
              <div className="flex flex-col items-center w-16 lg:w-auto">
                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all duration-300 ${index < steps.length - 1 ? 'mt-4 lg:mt-0' : ''} ${
                  step.complete 
                    ? 'bg-emerald-500 text-black shadow-lg shadow-emerald-500/30' 
                    : step.active 
                      ? 'bg-amber-500 text-black shadow-lg shadow-amber-500/30 animate-pulse' 
                      : 'bg-zinc-800 text-zinc-500'
                }`}>
                  {step.complete ? (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                    </svg>
                  ) : step.id}
                </div>
                <span className={`text-xs mt-2 text-center ${step.active ? 'text-amber-400 font-medium' : step.complete ? 'text-emerald-400' : 'text-zinc-500'}`}>
                  {step.name}
                </span>
              </div>
              {index < steps.length - 1 && (
                <div className={`hidden lg:block flex-1 h-1 mx-3 rounded-full transition-all duration-500 ${
                  step.complete ? 'bg-emerald-500' : 'bg-zinc-800'
                }`}></div>
              )}
            </div>
          ))}
          
          {/* Message for Crossmark/Xaman vendors */}
          {storagePrefix === 'vendor' && (loginMethod === 'crossmark' || loginMethod === 'xaman') && !autoSignEnabled && (
            <p className="hidden lg:block text-amber-400 text-xs pl-4 max-w-[220px] flex-shrink-0">
              Complete Auto-Sign Below
            </p>
          )}
        </div>
        
        {/* Mobile message for Crossmark/Xaman vendors */}
        {storagePrefix === 'vendor' && (loginMethod === 'crossmark' || loginMethod === 'xaman') && !autoSignEnabled && (
          <p className="lg:hidden text-amber-400 text-xs text-center px-6 pt-6 pb-2">
            Complete Auto-Sign Below
          </p>
        )}
      </div>

      {/* Error Display */}
      {error && (
        <div className="mx-6 mt-4 bg-red-500/10 border border-red-500/30 rounded-xl p-4">
          <div className="flex items-start gap-3">
            <svg className="w-5 h-5 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div className="flex-1">
              <p className="text-red-400 text-sm">{error}</p>
              <button onClick={() => setError(null)} className="text-red-400/70 text-xs mt-1 hover:text-red-400 transition">Dismiss</button>
            </div>
          </div>
        </div>
      )}

      {/* Step Content */}
      <div className="p-6">
        {/* STEP 0: Connect Wallet */}
{currentStep === 'connect_wallet' && (
  <div className="space-y-5">
    <div className="flex items-center gap-4">
      <div className="w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden">
        <img src="/XRP-logo.webp" alt="XRP" className="w-14 h-14 object-cover" />
      </div>
      <div>
        <h3 className="text-xl font-bold text-white">Connect Your Wallet</h3>
        <p className="text-zinc-400">Link an XRPL wallet to receive payments</p>
      </div>
    </div>

    {/* Xaman QR Display */}
    {connectingXaman && xamanQR ? (
      <div className="bg-zinc-800/50 rounded-xl p-6">
        <p className="text-zinc-300 mb-4 text-center">Scan with Xaman app</p>
        <img src={xamanQR} alt="Xaman QR" className="mx-auto mb-4 rounded-lg max-w-[200px]" />
        <div className="flex items-center justify-center gap-2 text-zinc-400 text-sm mb-4">
          <span className="w-2 h-2 bg-sky-500 rounded-full animate-pulse"></span>
          Waiting for signature...
        </div>
        {xamanDeepLink && (
          <a href={xamanDeepLink} className="text-sky-400 text-sm hover:underline block text-center mb-4">
            Open in Xaman app ‚Üí
          </a>
        )}
        <button onClick={cancelXamanLogin} className="text-zinc-500 text-sm hover:text-white w-full text-center">
          ‚Üê Back
        </button>
      </div>
    ) : (
      <div className="grid gap-3">
      {/* Social Login - TOP */}
      <button
        onClick={async () => {
          try {
            const { loginWithWeb3Auth } = await import('@/lib/web3auth');
            const result = await loginWithWeb3Auth();
            if (result) {
              const address = typeof result === 'string' ? result : result.address;
              const provider = typeof result === 'string' ? 'google' : (result.provider || 'google');
              const walletKey = storagePrefix === 'vendor' ? 'vendorWalletAddress' : 'walletAddress';
const methodKey = storagePrefix === 'vendor' ? 'vendorLoginMethod' : 'loginMethod';
safeSetItem(walletKey, address);
safeSetItem(methodKey, 'web3auth');
safeSetItem('socialProvider', provider);
              window.location.reload();
            }
          } catch (err) { console.error('Social login error:', err); }
        }}
        className="flex items-center gap-4 bg-gradient-to-r from-emerald-500/10 to-sky-500/10 border border-emerald-500/30 hover:border-emerald-500 p-4 rounded-xl transition w-full"
      >
        <div className="flex -space-x-2">
          <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center border-2 border-zinc-900">
            <svg className="w-4 h-4" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
          </div>
          <div className="w-8 h-8 bg-black rounded-full flex items-center justify-center border-2 border-zinc-900">
            <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
            </svg>
          </div>
          <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center border-2 border-zinc-900">
            <span className="text-white text-[10px] font-bold">+10</span>
          </div>
        </div>
        <div className="text-left">
          <p className="text-white font-medium">Social Login</p>
          <p className="text-zinc-500 text-sm">Tap and Pay with Google, Apple & more</p>
        </div>
      </button>

      {/* Crossmark */}
        <button
          onClick={async () => {
            try {
              const sdk = (window as any).xrpl?.crossmark;
              if (!sdk) { window.open('https://crossmark.io', '_blank'); return; }
              const response = await sdk.methods.signInAndWait();
              if (response?.response?.data?.address) {
                const walletKey = storagePrefix === 'vendor' ? 'vendorWalletAddress' : 'walletAddress';
const methodKey = storagePrefix === 'vendor' ? 'vendorLoginMethod' : 'loginMethod';
safeSetItem(walletKey, response.response.data.address);
safeSetItem(methodKey, 'crossmark');
                window.location.reload();
              }
            } catch (err) { console.error('Crossmark error:', err); }
          }}
          className="flex items-center gap-4 bg-zinc-800 hover:bg-zinc-700 p-4 rounded-xl transition"
        >
          <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-10 h-10 rounded-lg" />
          <div className="text-left">
            <p className="text-white font-medium">Crossmark</p>
            <p className="text-zinc-500 text-sm">Browser extension</p>
          </div>
        </button>

        {/* Xaman */}
        <button
        onClick={connectXaman}
        disabled={connectingXaman}
        className="flex items-center gap-4 bg-zinc-800 hover:bg-zinc-700 p-4 rounded-xl transition w-full"
      >
        <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-10 h-10 rounded-lg" />
        <div className="text-left">
          <p className="text-white font-medium">Xaman (Xumm)</p>
          <p className="text-zinc-500 text-sm">Mobile wallet</p>
        </div>
      </button>
    </div>
    )}
  </div>
)}
        {/* STEP 1: Fund Wallet */}
        {currentStep === 'fund_wallet' && (
          <div className="space-y-5">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 bg-gradient-to-br from-amber-500/20 to-orange-500/20 rounded-2xl flex items-center justify-center">
                <svg className="w-7 h-7 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Add XRP to Activate</h3>
                <p className="text-zinc-400">Send at least 1.5 XRP to fund your wallet</p>
              </div>
            </div>

            {/* Current Balance */}
            <div className="bg-zinc-800/50 rounded-xl p-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-zinc-500 text-xs uppercase tracking-wider">Current Balance</p>
                  <p className="text-2xl font-bold text-white mt-1">{walletStatus?.xrp_balance?.toFixed(4) || '0.0000'} <span className="text-zinc-400 text-lg">XRP</span></p>
                </div>
                <div className={`px-3 py-1.5 rounded-full text-xs font-medium ${
                  (walletStatus?.xrp_balance || 0) >= 1.5 
                    ? 'bg-emerald-500/20 text-emerald-400' 
                    : 'bg-amber-500/20 text-amber-400'
                }`}>
                  {(walletStatus?.xrp_balance || 0) >= 1.5 ? 'Funded' : `Need ${(1.5 - (walletStatus?.xrp_balance || 0)).toFixed(2)} more`}
                </div>
              </div>
            </div>

            {/* Wallet Address */}
            <div className="bg-zinc-800/30 rounded-xl p-4 space-y-3">
              <p className="text-zinc-400 text-sm">Send XRP to this address:</p>
              <div className="flex items-center gap-2">
                <code className="flex-1 bg-zinc-900 rounded-lg px-4 py-3 text-emerald-400 font-mono text-sm break-all">
                  {walletAddress}
                </code>
                <button
                  onClick={copyAddress}
                  className={`p-3 rounded-lg transition ${copied ? 'bg-emerald-500 text-black' : 'bg-zinc-700 hover:bg-zinc-600 text-white'}`}
                >
                  {copied ? (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                    </svg>
                  ) : (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                  )}
                </button>
              </div>
              
              <button
                onClick={() => setShowQR(!showQR)}
                className="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 py-2 rounded-lg text-sm transition flex items-center justify-center gap-2"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
                {showQR ? 'Hide QR Code' : 'Show QR Code'}
              </button>
              
              {showQR && (
                <div className="flex justify-center pt-2">
                  <div className="bg-white p-4 rounded-xl">
                    <QRCodeSVG value={walletAddress || ''} size={180} level="M" />
                  </div>
                </div>
              )}
            </div>

            {/* Buy XRP Options */}
            <div className="space-y-3">
              <p className="text-zinc-400 text-sm">Need XRP? Buy with card:</p>
              <div className="grid grid-cols-2 gap-3">
                <a
                  href={`https://guardarian.com/buy-xrp?address=${walletAddress}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 bg-zinc-800 hover:bg-zinc-700 p-3 rounded-xl transition"
                >
                  <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                    <img src="/guardarian-blue.svg" alt="Guardarian" className="w-8 h-8 object-contain" />
                  </div>
                  <div>
                    <p className="text-white text-sm font-medium">Guardarian</p>
                    <p className="text-zinc-500 text-xs">No KYC small amounts</p>
                  </div>
                </a>
                <a
                  href="https://global.transak.com/"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 bg-zinc-800 hover:bg-zinc-700 p-3 rounded-xl transition"
                >
                  <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                    <img src="/transak.svg" alt="Transak" className="w-8 h-8 object-contain" />
                  </div>
                  <div>
                    <p className="text-white text-sm font-medium">Transak</p>
                    <p className="text-zinc-500 text-xs">Global coverage</p>
                  </div>
                </a>
              </div>
            </div>

            {/* Info */}
            <div className="flex items-start gap-3 bg-blue-500/10 border border-blue-500/20 rounded-xl p-4">
              <svg className="w-5 h-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p className="text-blue-300 text-sm">
                1.5 XRP covers the XRPL base reserve (1 XRP) plus trustline reserves. Keep at least 1.2 XRP to stay active.
              </p>
            </div>
          </div>
        )}

        {/* STEP 2: Add Trustlines */}
        {currentStep === 'add_trustlines' && (
          <div className="space-y-5">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 bg-gradient-to-br from-amber-500/20 to-orange-500/20 rounded-2xl flex items-center justify-center">
                <svg className="w-7 h-7 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                </svg>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Enable Stablecoins</h3>
                <p className="text-zinc-400">Add trustlines to receive RLUSD & USDC payments</p>
              </div>
            </div>

            {/* Trustline Status Cards */}
            <div className="grid grid-cols-2 gap-4">
              {/* RLUSD Card */}
              <div className={`rounded-xl p-4 border transition-all ${
                walletStatus?.rlusd_trustline 
                  ? 'bg-emerald-500/10 border-emerald-500/30' 
                  : 'bg-zinc-800/50 border-zinc-700 hover:border-amber-500/30'
              }`}>
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-xs font-bold">R</div>
                    <span className="font-semibold text-white">RLUSD</span>
                  </div>
                  {walletStatus?.rlusd_trustline ? (
                    <div className="w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center">
                      <svg className="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                  ) : (
                    <div className="w-6 h-6 border-2 border-zinc-600 rounded-full"></div>
                  )}
                </div>
                <p className="text-zinc-400 text-xs">Ripple USD Stablecoin</p>
                {walletStatus?.rlusd_trustline ? (
                  <p className="text-emerald-400 text-sm mt-2 font-medium">Active</p>
                ) : (
                  loginMethod === 'crossmark' && (
                    <button
                      onClick={() => setupTrustlinesCrossmark('rlusd')}
                      disabled={settingUp}
                      className="mt-3 w-full bg-amber-500 hover:bg-amber-400 text-black text-sm font-medium py-2 rounded-lg transition disabled:opacity-50"
                    >
                      Add RLUSD
                    </button>
                  )
                )}
                {!walletStatus?.rlusd_trustline && loginMethod === 'xaman' && (
                  <button
                    onClick={() => setupTrustlinesXaman('rlusd')}
                    className="mt-3 w-full bg-amber-500 hover:bg-amber-400 text-black text-sm font-medium py-2 rounded-lg transition"
                  >
                    Add RLUSD
                  </button>
                )}
              </div>

              {/* USDC Card */}
              <div className={`rounded-xl p-4 border transition-all ${
                walletStatus?.usdc_trustline 
                  ? 'bg-emerald-500/10 border-emerald-500/30' 
                  : 'bg-zinc-800/50 border-zinc-700 hover:border-amber-500/30'
              }`}>
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-xs font-bold">$</div>
                    <span className="font-semibold text-white">USDC</span>
                  </div>
                  {walletStatus?.usdc_trustline ? (
                    <div className="w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center">
                      <svg className="w-4 h-4 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                  ) : (
                    <div className="w-6 h-6 border-2 border-zinc-600 rounded-full"></div>
                  )}
                </div>
                <p className="text-zinc-400 text-xs">Circle USD Stablecoin</p>
                {walletStatus?.usdc_trustline ? (
                  <p className="text-emerald-400 text-sm mt-2 font-medium">Active</p>
                ) : (
                  loginMethod === 'crossmark' && (
                    <button
                      onClick={() => setupTrustlinesCrossmark('usdc')}
                      disabled={settingUp}
                      className="mt-3 w-full bg-amber-500 hover:bg-amber-400 text-black text-sm font-medium py-2 rounded-lg transition disabled:opacity-50"
                    >
                      Add USDC
                    </button>
                  )
                )}
                {!walletStatus?.usdc_trustline && loginMethod === 'xaman' && (
  
   <a href="https://xumm.app"
    target="_blank"
    rel="noopener noreferrer"
    className="mt-3 w-full bg-zinc-700 hover:bg-zinc-600 text-white text-sm font-medium py-2 rounded-lg transition block text-center"
  >
    Add in Xaman ‚Üí
  </a>
)}
              </div>
            </div>

            {/* Web3Auth: Single button for both */}
            {loginMethod === 'web3auth' && (!walletStatus?.rlusd_trustline || !walletStatus?.usdc_trustline) && (
              <button
                onClick={setupTrustlinesWeb3Auth}
                disabled={settingUp}
                className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 text-black font-semibold py-4 rounded-xl transition flex items-center justify-center gap-2 disabled:opacity-50 shadow-lg shadow-amber-500/20"
              >
                {settingUp ? (
                  <>
                    <span className="w-5 h-5 border-2 border-black/30 border-t-black rounded-full animate-spin"></span>
                    {setupProgress || 'Setting up...'}
                  </>
                ) : (
                  <>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101" />
                    </svg>
                    Add Both Trustlines
                  </>
                )}
              </button>
            )}

            {/* Skip option for Xaman users - USDC only */}
{loginMethod === 'xaman' && walletStatus?.rlusd_trustline && !walletStatus?.usdc_trustline && (
  <div className="mt-4 pt-4 border-t border-zinc-800">
    <p className="text-zinc-500 text-sm text-center mb-3">
      Add trustlines manually in your Xaman wallet, or skip for now
    </p>
    <button
      onClick={onSetupComplete}
      className="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-medium py-3 rounded-xl transition"
    >
      Skip for Now ‚Üí
    </button>
  </div>
)}

            {/* Progress indicator for Crossmark/Xaman */}
            {settingUp && loginMethod !== 'web3auth' && (
              <div className="flex items-center justify-center gap-3 py-4">
                <span className="w-5 h-5 border-2 border-amber-500/30 border-t-amber-500 rounded-full animate-spin"></span>
                <span className="text-amber-400">{setupProgress || 'Processing...'}</span>
              </div>
            )}
          </div>
        )}

        {/* STEP 3: Enable Auto-Pay (Web3Auth only) */}
        {currentStep === 'enable_autopay' && loginMethod === 'web3auth' && (
          <div className="space-y-5">
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 bg-gradient-to-br from-amber-500/20 to-orange-500/20 rounded-2xl flex items-center justify-center">
                <svg className="w-7 h-7 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
              </div>
              <div>
                <h3 className="text-xl font-bold text-white">Enable Tap-to-Pay</h3>
                <p className="text-zinc-400">Final step - enable instant NFC payments</p>
              </div>
            </div>

            <div className="bg-zinc-800/30 rounded-xl p-4">
              <p className="text-zinc-300 text-sm leading-relaxed">
                Sign once to authorize automatic payments when you tap your NFC card at participating vendors. 
                You control the spending limit.
              </p>
            </div>

            <button
              onClick={async () => {
                setSettingUp(true);
                setSetupProgress('Setting up Tap-to-Pay...');
                try {
                  if (onVendorEnableAutoPay) {
                    await onVendorEnableAutoPay();
                    onSetupComplete();
                  } else {
                    await enableAutoPay();
                  }
                } finally {
                  setSettingUp(false);
                  setSetupProgress(null);
                }
              }}
              disabled={settingUp}
              className="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 text-black font-semibold py-4 rounded-xl transition flex items-center justify-center gap-2 disabled:opacity-50 shadow-lg shadow-amber-500/20"
            >
              {settingUp ? (
                <>
                  <span className="w-5 h-5 border-2 border-black/30 border-t-black rounded-full animate-spin"></span>
                  {setupProgress || 'Setting up...'}
                </>
              ) : (
                <>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                  Complete Setup
                </>
              )}
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/PaymentOptions.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import InstantPay from './InstantPay';


// MARK: - Constants & Configuration

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';
const PLUGINS_API_URL = 'https://api.dltpays.com/plugins/api/v1';


// MARK: - Types & Interfaces
interface PaymentOptionsProps {
  amount: number;
  rlusdAmount: number;
  vendorWallet: string;
  storeName: string;
  storeId: string;
  paymentId: string;
  status: 'pending' | 'paid' | 'expired' | 'processing';
  onSuccess: (txHash: string, receiptId?: string) => void;
  onError: (error: string) => void;
  showSplitBill?: boolean;
  onSplitBill?: () => void;
  isCheckoutSession?: boolean;
  tipAmount?: number;
}

export default function PaymentOptions({
  amount,
  rlusdAmount,
  vendorWallet,
  storeName,
  storeId,
  paymentId,
  status,
  onSuccess,
  onError,
  showSplitBill = false,
  onSplitBill,
  isCheckoutSession = false,
  tipAmount = 0
}: PaymentOptionsProps) {
  // NFC state

// MARK: - State Management
  const [nfcSupported, setNfcSupported] = useState(false);
  const [nfcScanning, setNfcScanning] = useState(false);
  const [nfcController, setNfcController] = useState<AbortController | null>(null);
  const [processing, setProcessing] = useState(false);

  // Xaman state
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [xamanPaymentId, setXamanPaymentId] = useState<string | null>(null);

  // Helper function to get the correct pay endpoint

// MARK: - API Calls & Data Fetching
  const getPayEndpoint = () => {
    if (isCheckoutSession) {
      // For checkout sessions, use the plugins API with session ID (storeId contains session_id)
      return `${PLUGINS_API_URL}/checkout/session/${storeId}/pay`;
    }
    // For regular payment links, use NFC API
    return `${NFC_API_URL}/payment-link/${paymentId}/pay`;
  };

  // Check NFC support on mount

// MARK: - Hooks & Effects
  useEffect(() => {
    if ('NDEFReader' in window) {
      setNfcSupported(true);
    }
  }, []);

  // Poll for Xaman payment status
  useEffect(() => {
    if (!xamanPaymentId) return;

    const pollInterval = setInterval(async () => {
      try {
        const res = await fetch(`https://api.dltpays.com/api/v1/xaman/payment/poll/${xamanPaymentId}`);
        const data = await res.json();

        if (data.status === 'signed') {
          clearInterval(pollInterval);
          setXamanQR(null);
          setXamanPaymentId(null);
          
          // Mark payment as paid in our system
          const payRes = await fetch(getPayEndpoint(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payer_wallet: 'xaman_payment', tx_hash: data.tx_hash, tip_amount: tipAmount, split_payment_id: paymentId })
          });
          const payData = await payRes.json();
          
          onSuccess(data.tx_hash, payData.receipt_id);
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 3000);

    return () => clearInterval(pollInterval);
  }, [xamanPaymentId, paymentId, storeId, isCheckoutSession, onSuccess]);

  // Generate Xaman QR
  const generateXamanQR = async () => {
    try {
      const res = await fetch('https://api.dltpays.com/api/v1/xaman/payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: rlusdAmount,
          vendor_wallet: vendorWallet,
          store_id: storeId,
          store_name: storeName
        })
      });

      const data = await res.json();
      if (data.success) {
        setXamanQR(data.qr_png);
        setXamanPaymentId(data.payment_id);
      } else {
        onError(data.error || 'Failed to create payment');
      }
    } catch (err) {
      onError('Failed to create payment request');
    }
  };

  // Stop NFC scan
  const stopNFCScan = () => {
    if (nfcController) {
      nfcController.abort();
      setNfcController(null);
    }
    setNfcScanning(false);
  };

  // Start NFC scan
  const startNFCScan = async () => {
    if (!('NDEFReader' in window)) {
      onError('NFC not supported on this device');
      return;
    }

    stopNFCScan();

    const controller = new AbortController();
    setNfcController(controller);
    setNfcScanning(true);

    try {
      const ndef = new (window as any).NDEFReader();
      await ndef.scan({ signal: controller.signal });

      ndef.addEventListener('reading', async (event: any) => {
        controller.abort();
        
        const uid = event.serialNumber?.replace(/:/g, '').toUpperCase();
        if (!uid) {
          onError('Could not read card');
          setNfcScanning(false);
          setNfcController(null);
          return;
        }

        setNfcScanning(false);
        setNfcController(null);
        setProcessing(true);

        try {
          const res = await fetch(getPayEndpoint(), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card_uid: uid, tip_amount: tipAmount, split_payment_id: paymentId })
          });

          const result = await res.json();

          if (result.success) {
            onSuccess(result.tx_hash, result.receipt_id);
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
          } else {
            if (result.error === 'NO_SIGNER_AUTHORITY') {
              onError('NO_SIGNER_AUTHORITY');
            } else {
              onError(result.error || 'Payment failed');
            }
          }
        } catch (err) {
          onError('Payment failed');
        } finally {
          setProcessing(false);
        }
      });

      ndef.addEventListener('readingerror', () => {
        onError('Error reading card');
        stopNFCScan();
      });

    } catch (err: any) {
      if (err.name === 'NotAllowedError') {
        onError('NFC permission denied');
      } else if (err.name !== 'AbortError') {
        onError('Failed to start NFC');
      }
      stopNFCScan();
    }
  };

  // Already paid message
  if (status !== 'pending') {

// MARK: - Main Render
    return (
      <div className="bg-emerald-500/20 border border-emerald-500/50 rounded-2xl p-6 text-center">
        <div className="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 className="text-xl font-bold text-emerald-400 mb-2">Payment Already Complete</h3>
        <p className="text-zinc-400">This payment has already been processed.</p>
      </div>
    );
  }

  // Processing overlay
  if (processing) {
    return (
      <div className="text-center py-8">
        <div className="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p className="text-xl text-white">Processing payment...</p>
      </div>
    );
  }

  // Xaman QR View
  if (xamanQR) {
    return (
      <div className="text-center">
        <div className="bg-white rounded-3xl p-6 mb-6 inline-block">
          <img
            src={xamanQR}
            alt="Scan with Xaman"
            className="w-56 h-56"
          />
        </div>
        <p className="text-xl font-semibold text-sky-400 mb-2">Scan with Xaman</p>
        <p className="text-zinc-500 mb-6">Open Xaman wallet and scan the QR code</p>
        
        <button

// MARK: - Event Handlers
          onClick={() => {
            setXamanQR(null);
            setXamanPaymentId(null);
          }}
          className="bg-zinc-800 hover:bg-zinc-700 px-8 py-3 rounded-xl font-medium transition"
        >
          Cancel
        </button>
      </div>
    );
  }

  // Main payment options view
  return (
    <div className="space-y-4">
      {/* InstantPay (Web3Auth/Biometrics) */}
      <InstantPay
        amount={amount}
        rlusdAmount={rlusdAmount}
        vendorWallet={vendorWallet}
        storeName={storeName}
        storeId={storeId}
        paymentId={paymentId}
        onSuccess={onSuccess}
        onError={onError}
        isCheckoutSession={isCheckoutSession}
        tipAmount={tipAmount}
      />

      {/* NFC Tap to Pay */}
      {nfcSupported && (
        <button
          onClick={startNFCScan}
          disabled={nfcScanning}
          className="w-full"
        >
          <div className={`bg-zinc-900 rounded-2xl p-6 border-2 transition ${
            nfcScanning ? 'border-emerald-500' : 'border-zinc-800 hover:border-zinc-700'
          }`}>
            <div className="flex flex-col items-center">
              <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-3 ${
                nfcScanning ? 'bg-emerald-500/20 animate-pulse' : 'bg-zinc-800'
              }`}>
                <svg className={`w-8 h-8 ${nfcScanning ? 'text-emerald-400' : 'text-zinc-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
              </div>
              <p className="text-lg font-semibold mb-1">
                {nfcScanning ? 'Tap your card now...' : 'Tap to Pay'}
              </p>
              <p className="text-zinc-500 text-sm">Hold your NFC card to your phone</p>
            </div>
          </div>
        </button>
      )}

      <div className="text-center text-zinc-500 my-2">or</div>

      {/* Xaman button */}
      <button 
        onClick={generateXamanQR}
        className="w-full bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 rounded-2xl p-4 flex items-center justify-center gap-3 transition"
      >
        <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded-lg" />
        <span className="font-medium">Pay with Xaman</span>
      </button>

      {/* Split bill button */}
      {showSplitBill && onSplitBill && (
        <button
          onClick={onSplitBill}
          className="w-full bg-zinc-800 hover:bg-zinc-700 rounded-xl py-4 font-medium transition"
        >
          Split Bill
        </button>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/PaymentSuccess.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import ReceiptActions from '@/components/ReceiptActions';


// MARK: - Types & Interfaces
interface PaymentSuccessProps {
  storeName: string;
  storeId?: string;
  storeLogo?: string | null;
  amount: number;
  tip?: number;
  txHash?: string | null;
  receiptId?: string | null;
  rlusdAmount?: number | null;
  items?: any[];
  // ADD: conversionRate prop
  conversionRate?: {
    rlusd_gbp: number;
    source: string;
    captured_at: string;
  } | null;
  // For split bills
  splitAmount?: number | null;
  splitTip?: number | null;
  isSplit?: boolean;
  // For receipt authorization
  walletAddress?: string | null;
}


// MARK: - Component Definition
export default function PaymentSuccess({
  storeName,
  storeId,
  storeLogo,
  amount,
  tip = 0,
  txHash,
  receiptId,
  rlusdAmount,
  items = [],
  conversionRate,  // ADD: destructure conversionRate
  splitAmount,
  splitTip,
  isSplit = false,
  walletAddress
}: PaymentSuccessProps) {
  

// MARK: - State Management
  const [showSuccessVideo, setShowSuccessVideo] = useState(true);
  
  const displayAmount = isSplit && splitAmount ? splitAmount : amount;
  const displayTip = (isSplit && splitTip !== undefined ? splitTip : tip) || 0;

  // Hide success video after 6 seconds

// MARK: - Hooks & Effects
  useEffect(() => {
    const timer = setTimeout(() => setShowSuccessVideo(false), 6000);
    return () => clearTimeout(timer);
  }, []);


// MARK: - Main Render
  return (
    <div className="min-h-screen bg-black text-white flex items-center justify-center p-6">
      <div className="text-center">
        {/* Store Logo with Success Video Overlay */}
        <div className="relative w-20 h-20 mx-auto mb-6">
          {storeLogo ? (
            <img 
              src={storeLogo} 
              alt={storeName} 
              className="w-20 h-20 rounded-2xl object-cover"
            />
          ) : (
            <img 
              src="https://yesallofus.com/dltpayslogo1.png" 
              alt="YesAllOfUs" 
              className="w-20 h-20 rounded-2xl"
            />
          )}
          {showSuccessVideo && (
            <video
              autoPlay
              muted
              playsInline

// MARK: - Event Handlers
              onEnded={() => setShowSuccessVideo(false)}
              className="absolute inset-0 w-20 h-20 rounded-2xl object-cover"
            >
              <source src="/successmessage.webm" type="video/webm" />
            </video>
          )}
        </div>

        {/* Success Checkmark */}
        <div className="w-24 h-24 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg className="w-12 h-12 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
          </svg>
        </div>

        {/* Success Text */}
        <h1 className="text-3xl font-bold text-emerald-400 mb-2">Payment Complete!</h1>
        <p className="text-xl text-zinc-400 mb-2">Thank you for shopping at</p>
        <p className="text-2xl font-bold mb-4">{storeName}</p>

        {/* Payment Summary */}
        <div className="bg-zinc-900/50 rounded-xl p-4 mb-6">
          {isSplit ? (
            <>
              <div className="text-zinc-400 text-sm mb-2">Your payment:</div>
              <div className="text-2xl font-bold text-emerald-400">¬£{displayAmount.toFixed(2)}</div>
              {displayTip > 0 && (
                <div className="text-zinc-500 text-sm mt-1">
                  (¬£{(displayAmount - displayTip).toFixed(2)} + ¬£{displayTip.toFixed(2)} tip)
                </div>
              )}
            </>
          ) : (
            <>
              <div className="text-zinc-400 text-sm mb-2">Amount paid:</div>
              <div className="text-2xl font-bold text-emerald-400">¬£{displayAmount.toFixed(2)}</div>
              {displayTip > 0 && (
                <div className="text-zinc-500 text-sm mt-1">Includes ¬£{displayTip.toFixed(2)} tip</div>
              )}
            </>
          )}
        </div>

        {/* XRPL Link */}
        {txHash && (
          <a 
            href={`https://livenet.xrpl.org/transactions/${txHash}`}
            target="_blank"
            rel="noopener noreferrer"
            className="text-sky-400 text-sm underline block mb-6"
          >
            View on XRPL ‚Üí
          </a>
        )}

        {/* Receipt Actions - Pass split-adjusted amount for split payments */}
        <ReceiptActions
          receiptId={receiptId || undefined}
          txHash={txHash || undefined}
          storeName={storeName}
          storeId={storeId}
          amount={displayAmount}
          rlusdAmount={rlusdAmount || undefined}
          items={items}
          tipAmount={displayTip}
          conversionRate={conversionRate || undefined}
          storeLogo={storeLogo || undefined}
          walletAddress={walletAddress || undefined}
          isSplit={isSplit}
        />

        {/* Footer Branding */}
        <div className="mt-8 pt-6 border-t border-zinc-800 flex flex-col items-center gap-1">
          <span className="text-zinc-500 text-[10px] font-medium tracking-wider">RECEIPT</span>
          <span className="text-base font-extrabold tracking-widest">
            <span className="text-emerald-500">Y</span>
            <span className="text-green-500">A</span>
            <span className="text-blue-500">O</span>
            <span className="text-indigo-500">F</span>
            <span className="text-violet-500">U</span>
            <span className="text-purple-500">S</span>
          </span>
          <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">INSTANT</span>
          <div className="flex items-center gap-2 mt-2">
            <img src="https://yesallofus.com/dltpayslogo1.png" alt="YesAllOfUs" className="w-5 h-5 rounded opacity-60" />
            <span className="text-zinc-600 text-xs">Powered by YesAllOfUs</span>
          </div>
        </div>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/PayoutsTable.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';


// MARK: - Types & Interfaces
interface Payout {
  store_name: string;
  order_id: string;
  amount: number;
  currency: string;
  tx_hash: string;
  paid_at: string;
}

interface PayoutsTableProps {
  payouts: Payout[];
  showBalances?: boolean;
}


// MARK: - Component Definition
export default function PayoutsTable({ payouts, showBalances = false }: PayoutsTableProps) {
  const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString('en-GB', {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const formatAmount = (amount: number) => {
    return showBalances ? `$${amount.toFixed(2)}` : '****';
  };

  if (payouts.length === 0) {

// MARK: - Main Render
    return (
      <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 text-center">
        <p className="text-zinc-400">No payouts yet. Share your referral links to start earning!</p>
      </div>
    );
  }

  return (
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden">
      <div className="overflow-x-auto sm:overflow-visible">
        <table className="min-w-[500px] sm:min-w-0 w-full">
          <thead>
            <tr className="border-b border-zinc-800">
              <th className="text-left text-zinc-400 text-sm font-medium px-4 py-3">Date</th>
              <th className="text-left text-zinc-400 text-sm font-medium px-4 py-3">Store</th>
              <th className="text-right text-zinc-400 text-sm font-medium px-4 py-3">Amount</th>
              <th className="text-right text-zinc-400 text-sm font-medium px-4 py-3">Transaction</th>
            </tr>
          </thead>
          <tbody>
            {payouts.map((payout, index) => (
              <tr key={index} className="border-b border-zinc-800/50 last:border-0">
                <td className="px-4 py-3 text-sm text-zinc-300 whitespace-nowrap">
                  {formatDate(payout.paid_at)}
                </td>
                <td className="px-4 py-3 text-sm whitespace-nowrap">{payout.store_name}</td>
                <td className="px-4 py-3 text-sm text-right text-emerald-400 font-medium whitespace-nowrap">
                  {formatAmount(payout.amount)}
                </td>
                <td className="px-4 py-3 text-sm text-right whitespace-nowrap">
                  {payout.tx_hash ? (
                    <a 
                      href={`https://livenet.xrpl.org/transactions/${payout.tx_hash}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-sky-400 hover:text-sky-300 font-mono"
                    >
                      {payout.tx_hash.slice(0, 8)}...
                    </a>
                  ) : (
                    <span className="text-zinc-500">Pending</span>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/PendingCustomers.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Constants & Configuration

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface PendingCustomer {
  id: string;
  name: string | null;
  email: string;
  phone: string | null;
  card_uid: string;
  card_name: string | null;
  created_at: string | null;
}

export default function PendingCustomers({ 
  storeId, 
  walletAddress 
}: { 
  storeId: string; 
  walletAddress: string | null;
}) {
  const [customers, setCustomers] = useState<PendingCustomer[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [newEmail, setNewEmail] = useState('');
  const [updating, setUpdating] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);


// MARK: - API Calls & Data Fetching
  const fetchCustomers = async () => {
    if (!storeId || !walletAddress) return;
    
    try {
      const res = await fetch(
        `${NFC_API_URL}/store/${storeId}/pending-customers?wallet_address=${walletAddress}`
      );
      const data = await res.json();
      
      if (data.success) {
        setCustomers(data.customers || []);
      }
    } catch (err) {
      console.error('Failed to fetch pending customers:', err);
    }
    setLoading(false);
  };


// MARK: - Hooks & Effects
  useEffect(() => {
    fetchCustomers();
  }, [storeId, walletAddress]);


// MARK: - Event Handlers
  const handleUpdateEmail = async (customer: PendingCustomer) => {
    if (!newEmail.trim()) {
      setMessage({ type: 'error', text: 'Email is required' });
      return;
    }

    setUpdating(true);
    setMessage(null);

    try {
      const res = await fetch(`${NFC_API_URL}/nfc/pending/update-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          card_uid: customer.card_uid,
          email: newEmail.trim(),
          store_id: storeId
        })
      });

      const data = await res.json();

      if (data.success) {
        setMessage({ type: 'success', text: `Welcome email sent to ${data.new_email}` });
        setEditingId(null);
        setNewEmail('');
        fetchCustomers();
      } else {
        setMessage({ type: 'error', text: data.error || 'Failed to update email' });
      }
    } catch (err) {
      setMessage({ type: 'error', text: 'Failed to update email' });
    }

    setUpdating(false);
  };

  const handleResendEmail = async (customer: PendingCustomer) => {
    setUpdating(true);
    setMessage(null);

    try {
      const res = await fetch(`${NFC_API_URL}/nfc/pending/update-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          card_uid: customer.card_uid,
          email: customer.email,
          store_id: storeId
        })
      });

      const data = await res.json();

      if (data.success) {
        setMessage({ type: 'success', text: `Welcome email resent to ${customer.email}` });
      } else {
        setMessage({ type: 'error', text: data.error || 'Failed to resend email' });
      }
    } catch (err) {
      setMessage({ type: 'error', text: 'Failed to resend email' });
    }

    setUpdating(false);
  };

  if (loading) {

// MARK: - Main Render
    return (
<div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 h-full">
        <h2 className="text-lg font-bold mb-4">Pending Customers</h2>
        <div className="flex items-center justify-center py-8">
          <div className="w-6 h-6 border-2 border-zinc-600 border-t-white rounded-full animate-spin" />
        </div>
      </div>
    );
  }

  return (
<div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 h-full flex flex-col">
<div className="flex items-center justify-between mb-4">
        <h2 className="text-lg font-bold">Pending Customers</h2>
        <span className="text-zinc-500 text-sm">{customers.length} pending</span>
      </div>

      {message && (
        <div className={`mb-4 p-3 rounded-lg text-sm ${
          message.type === 'success' 
            ? 'bg-emerald-500/10 border border-emerald-500/30 text-emerald-400'
            : 'bg-red-500/10 border border-red-500/30 text-red-400'
        }`}>
          {message.text}
        </div>
      )}

      {customers.length === 0 ? (
        <div className="text-center py-8">
          <div className="text-4xl mb-3">üë•</div>
          <p className="text-zinc-400">No pending customers</p>
          <p className="text-zinc-600 text-sm mt-1">
            Customers who scan their NFC card will appear here until they complete signup
          </p>
        </div>
      ) : (
        <div className="space-y-3">
          {customers.map((customer) => (
            <div 
              key={customer.id}
              className="bg-zinc-800/50 border border-zinc-700 rounded-lg p-4"
            >
              <div className="flex items-start justify-between gap-4">
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="font-medium text-white">
                      {customer.name || 'No name'}
                    </span>
                    {customer.card_name && (
                      <span className="text-xs bg-zinc-700 text-zinc-300 px-2 py-0.5 rounded">
                        {customer.card_name}
                      </span>
                    )}
                  </div>
                  
                  {editingId === customer.id ? (
                    <div className="mt-2 space-y-2">
                      <input
                        type="email"
                        value={newEmail}
                        onChange={(e) => setNewEmail(e.target.value)}
                        placeholder="New email address"
                        className="w-full bg-zinc-900 border border-zinc-600 rounded-lg px-3 py-2 text-sm text-white"
                        autoFocus
                      />
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleUpdateEmail(customer)}
                          disabled={updating}
                          className="bg-emerald-500 hover:bg-emerald-400 text-black text-sm font-medium px-3 py-1.5 rounded-lg transition disabled:opacity-50"
                        >
                          {updating ? 'Sending...' : 'Update & Send'}
                        </button>
                        <button
                          onClick={() => {
                            setEditingId(null);
                            setNewEmail('');
                          }}
                          className="text-zinc-400 hover:text-white text-sm px-3 py-1.5 transition"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <>
                      <p className="text-zinc-400 text-sm truncate">{customer.email}</p>
                      {customer.phone && (
                        <p className="text-zinc-500 text-xs">{customer.phone}</p>
                      )}
                    </>
                  )}
                </div>

                {editingId !== customer.id && (
                  <div className="flex flex-col gap-1">
                    <button
                      onClick={() => {
                        setEditingId(customer.id);
                        setNewEmail(customer.email);
                        setMessage(null);
                      }}
                      className="text-xs text-zinc-400 hover:text-white transition"
                    >
                      Edit Email
                    </button>
                    <button
                      onClick={() => handleResendEmail(customer)}
                      disabled={updating}
                      className="text-xs text-blue-400 hover:text-blue-300 transition disabled:opacity-50"
                    >
                      Resend
                    </button>
                  </div>
                )}
              </div>

              <div className="mt-2 pt-2 border-t border-zinc-700/50 flex items-center justify-between">
                <span className="text-zinc-600 text-xs font-mono">
                  {customer.card_uid.slice(0, 4)}...{customer.card_uid.slice(-4)}
                </span>
                {customer.created_at && (
                  <span className="text-zinc-600 text-xs">
                    {new Date(customer.created_at).toLocaleDateString()}
                  </span>
                )}
              </div>
            </div>
          ))}
        </div>
      )}

      <button
        onClick={fetchCustomers}
        className="w-full mt-4 text-zinc-500 hover:text-zinc-300 text-sm transition"
      >
        ‚Üª Refresh
      </button>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/PendingPayments.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Types & Interfaces
interface PaymentItem {
  name: string;
  quantity: number;
  price?: number;
  unit_price?: number;
  line_total?: number;
}

interface PendingPayment {
  payment_id: string;
  amount: number;
  status: string;
  created_at: string;
  expires_at: string;
  items?: PaymentItem[];
  tip?: number;
  currency?: string;
}

interface PendingPaymentsProps {
  storeId: string;
  onClose: () => void;
  onPaymentComplete?: (paymentId: string) => void;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
export default function PendingPayments({ storeId, onClose, onPaymentComplete }: PendingPaymentsProps) {
  const [payments, setPayments] = useState<PendingPayment[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [cancellingId, setCancellingId] = useState<string | null>(null);
  const [refreshing, setRefreshing] = useState(false);
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [copiedId, setCopiedId] = useState<string | null>(null);

  // Fetch pending payments

// MARK: - API Calls & Data Fetching
  const fetchPendingPayments = async () => {
    setRefreshing(true);
    try {
      const res = await fetch(`${API_URL}/store/${storeId}/pending-payments`);
      const data = await res.json();
      if (data.success) {
        setPayments(data.payments || []);
      }
    } catch (err) {
      console.error('Failed to fetch pending payments:', err);
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };


// MARK: - Hooks & Effects
  useEffect(() => {
    fetchPendingPayments();
    
    // Poll for updates every 3 seconds
    const interval = setInterval(fetchPendingPayments, 3000);
    return () => clearInterval(interval);
  }, [storeId]);

  // Check for completed payments
  useEffect(() => {
    const completed = payments.find(p => p.status === 'paid' || p.status === 'complete');
    if (completed && onPaymentComplete) {
      onPaymentComplete(completed.payment_id);
    }
  }, [payments, onPaymentComplete]);

  const formatTime = (dateStr: string) => {
    const date = new Date(dateStr);
    return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  };

  const getTimeRemaining = (expiresAt: string) => {
    const now = new Date();
    const expires = new Date(expiresAt);
    const diff = expires.getTime() - now.getTime();
    
    if (diff <= 0) return 'Expired';
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (days > 30) return 'Active';
    if (days > 0) return `${days}d left`;
    if (hours > 0) return `${hours}h left`;
    if (minutes < 1) return 'Less than 1 min';
    return `${minutes} min left`;
  };

  const getShortRef = (paymentId: string) => {
    // Extract last 6 chars for display: pay_abc123xyz ‚Üí xyz
    return paymentId.slice(-6).toUpperCase();
  };

  const copyPaymentLink = async (paymentId: string) => {
    const url = `https://yesallofus.com/pay/${paymentId}`;
    await navigator.clipboard.writeText(url);
    setCopiedId(paymentId);
    setTimeout(() => setCopiedId(null), 2000);
  };

  const sharePaymentLink = async (payment: PendingPayment) => {
    const url = `https://yesallofus.com/pay/${payment.payment_id}`;
    const text = `Payment request for ¬£${payment.amount.toFixed(2)}`;
    
    if (navigator.share) {
      try {
        await navigator.share({ title: 'Payment Link', text, url });
      } catch (err) {
        // User cancelled or not supported
        await copyPaymentLink(payment.payment_id);
      }
    } else {
      await copyPaymentLink(payment.payment_id);
    }
  };

  const getItemPrice = (item: PaymentItem) => {
    return item.price || item.unit_price || 0;
  };

  const pendingPayments = payments.filter(p => p.status === 'pending');
  const completedPayments = payments.filter(p => p.status === 'paid' || p.status === 'complete');


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
      <div className="bg-zinc-900 rounded-2xl w-full max-w-md max-h-[80vh] overflow-hidden flex flex-col">
        
        {/* Header */}
        <div className="p-4 border-b border-zinc-800 flex items-center justify-between">
          <h2 className="text-lg font-bold">Payment Links</h2>
          <button 

// MARK: - Event Handlers
            onClick={onClose}
            className="text-zinc-500 hover:text-white transition p-1"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-4">
          {loading ? (
            <div className="flex items-center justify-center py-12">
              <div className="w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
            </div>
          ) : pendingPayments.length === 0 && completedPayments.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-4xl mb-3">üì≠</div>
              <p className="text-zinc-400">No payment links</p>
              <p className="text-zinc-600 text-sm mt-1">Create a payment link to see it here</p>
            </div>
          ) : (
            <>
              {/* Pending */}
              {pendingPayments.length > 0 && (
                <div className="mb-6">
                  <p className="text-zinc-500 text-xs font-medium mb-2 uppercase tracking-wider">
                    Waiting for Payment ({pendingPayments.length})
                  </p>
                  <div className="space-y-2">
                    {pendingPayments.map((payment) => (
                      <div 
                        key={payment.payment_id}
                        className="bg-zinc-800 rounded-xl overflow-hidden"
                      >
                        {/* Main row */}
                        <div 
                          className="p-4 flex items-center justify-between cursor-pointer hover:bg-zinc-750 transition"
                          onClick={() => setExpandedId(expandedId === payment.payment_id ? null : payment.payment_id)}
                        >
                          <div className="flex items-center gap-3">
                            {/* Expand arrow */}
                            <svg 
                              className={`w-4 h-4 text-zinc-500 transition-transform ${expandedId === payment.payment_id ? 'rotate-90' : ''}`} 
                              fill="none" 
                              stroke="currentColor" 
                              viewBox="0 0 24 24"
                            >
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                            </svg>
                            <div>
                              <div className="flex items-center gap-2">
                                <p className="text-xl font-bold text-white">¬£{payment.amount.toFixed(2)}</p>
                                <span className="text-xs bg-zinc-700 text-zinc-300 px-2 py-0.5 rounded font-mono">
                                  #{getShortRef(payment.payment_id)}
                                </span>
                              </div>
                              <p className="text-zinc-500 text-xs">
                                {formatTime(payment.created_at)} ¬∑ {getTimeRemaining(payment.expires_at)}
                                {payment.items && payment.items.length > 0 && (
                                  <span> ¬∑ {payment.items.length} item{payment.items.length !== 1 ? 's' : ''}</span>
                                )}
                              </p>
                            </div>
                          </div>
                          <div className="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div>
                        </div>

                        {/* Expanded details */}
                        {expandedId === payment.payment_id && (
                          <div className="px-4 pb-4 border-t border-zinc-700">
                            {/* Items list */}
                            {payment.items && payment.items.length > 0 ? (
                              <div className="mt-3 space-y-2">
                                <p className="text-zinc-500 text-xs font-medium uppercase tracking-wider">Order Items</p>
                                {payment.items.map((item, idx) => (
                                  <div key={idx} className="flex justify-between text-sm">
                                    <span className="text-zinc-300">
                                      {item.quantity}√ó {item.name}
                                    </span>
                                    <span className="text-zinc-400">
                                      ¬£{(getItemPrice(item) * item.quantity).toFixed(2)}
                                    </span>
                                  </div>
                                ))}
                                {payment.tip && payment.tip > 0 && (
                                  <div className="flex justify-between text-sm pt-1 border-t border-zinc-700">
                                    <span className="text-zinc-300">Tip</span>
                                    <span className="text-emerald-400">¬£{payment.tip.toFixed(2)}</span>
                                  </div>
                                )}
                              </div>
                            ) : (
                              <div className="mt-3">
                                <p className="text-zinc-500 text-sm">No items recorded</p>
                              </div>
                            )}

                            {/* Action buttons */}
                            <div className="mt-4 flex gap-2">
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  copyPaymentLink(payment.payment_id);
                                }}
                                className={`flex-1 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 ${
                                  copiedId === payment.payment_id
                                    ? 'bg-emerald-500 text-black'
                                    : 'bg-zinc-700 hover:bg-zinc-600 text-white'
                                }`}
                              >
                                {copiedId === payment.payment_id ? (
                                  <>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                    Copied!
                                  </>
                                ) : (
                                  <>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Copy Link
                                  </>
                                )}
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  sharePaymentLink(payment);
                                }}
                                className="flex-1 bg-zinc-700 hover:bg-zinc-600 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                                Share
                              </button>
                              <button
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setCancellingId(payment.payment_id);
                                }}
                                className="bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 px-3 rounded-lg text-sm font-medium transition"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Completed (last 5) */}
              {completedPayments.length > 0 && (
                <div>
                  <p className="text-zinc-500 text-xs font-medium mb-2 uppercase tracking-wider">
                    Recently Completed
                  </p>
                  <div className="space-y-2">
                    {completedPayments.slice(0, 5).map((payment) => (
                      <div 
                        key={payment.payment_id}
                        className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl overflow-hidden"
                      >
                        <div 
                          className="p-4 flex items-center justify-between cursor-pointer"
                          onClick={() => setExpandedId(expandedId === payment.payment_id ? null : payment.payment_id)}
                        >
                          <div className="flex items-center gap-3">
                            <svg 
                              className={`w-4 h-4 text-emerald-500 transition-transform ${expandedId === payment.payment_id ? 'rotate-90' : ''}`} 
                              fill="none" 
                              stroke="currentColor" 
                              viewBox="0 0 24 24"
                            >
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                            </svg>
                            <div>
                              <div className="flex items-center gap-2">
                                <p className="text-xl font-bold text-emerald-400">¬£{payment.amount.toFixed(2)}</p>
                                <span className="text-xs bg-emerald-500/20 text-emerald-300 px-2 py-0.5 rounded font-mono">
                                  #{getShortRef(payment.payment_id)}
                                </span>
                              </div>
                              <p className="text-zinc-500 text-xs">
                                Paid at {formatTime(payment.created_at)}
                                {payment.items && payment.items.length > 0 && (
                                  <span> ¬∑ {payment.items.length} item{payment.items.length !== 1 ? 's' : ''}</span>
                                )}
                              </p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                            </svg>
                          </div>
                        </div>

                        {/* Expanded details for completed */}
                        {expandedId === payment.payment_id && payment.items && payment.items.length > 0 && (
                          <div className="px-4 pb-4 border-t border-emerald-500/20">
                            <div className="mt-3 space-y-2">
                              <p className="text-emerald-500/70 text-xs font-medium uppercase tracking-wider">Order Items</p>
                              {payment.items.map((item, idx) => (
                                <div key={idx} className="flex justify-between text-sm">
                                  <span className="text-zinc-300">
                                    {item.quantity}√ó {item.name}
                                  </span>
                                  <span className="text-zinc-400">
                                    ¬£{(getItemPrice(item) * item.quantity).toFixed(2)}
                                  </span>
                                </div>
                              ))}
                              {payment.tip && payment.tip > 0 && (
                                <div className="flex justify-between text-sm pt-1 border-t border-emerald-500/20">
                                  <span className="text-zinc-300">Tip</span>
                                  <span className="text-emerald-400">¬£{payment.tip.toFixed(2)}</span>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </>
          )}
        </div>

        {/* Footer */}
        <div className="p-4 border-t border-zinc-800">
          <button
            onClick={fetchPendingPayments}
            disabled={refreshing}
            className="w-full bg-zinc-800 hover:bg-zinc-700 disabled:opacity-50 text-white py-3 rounded-xl font-medium transition flex items-center justify-center gap-2"
          >
            <svg className={`w-5 h-5 ${refreshing ? 'animate-spin' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            {refreshing ? 'Refreshing...' : 'Refresh'}
          </button>
        </div>
      </div>

      {/* Cancel Confirmation Modal */}
      {cancellingId && (
        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
          <div className="bg-zinc-800 rounded-2xl p-6 w-full max-w-xs text-center">
            <p className="text-white font-medium mb-4">Cancel this payment link?</p>
            <div className="flex gap-3">
              <button
                onClick={() => setCancellingId(null)}
                className="flex-1 bg-zinc-700 hover:bg-zinc-600 py-3 rounded-xl font-medium transition"
              >
                Keep
              </button>
              <button
                onClick={async () => {
                  try {
                    await fetch(`${API_URL}/payment-link/${cancellingId}/cancel`, {
                      method: 'POST'
                    });
                    fetchPendingPayments();
                  } catch (err) {
                    console.error('Failed to cancel:', err);
                  }
                  setCancellingId(null);
                }}
                className="flex-1 bg-red-500 hover:bg-red-400 text-white py-3 rounded-xl font-medium transition"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/ProductsManager.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, useRef } from 'react';
import dynamic from 'next/dynamic';
import Papa from 'papaparse';
import { Theme } from 'emoji-picker-react';
import { foodIcons, foodIconCategories, findIconForProduct, getIconById, FoodIcon } from '@/lib/foodIcons';
import CSVImportModal from './CSVImportModal';
import InventoryHistoryModal from './InventoryHistoryModal';


// MARK: - Component Definition
const EmojiPicker = dynamic(() => import('emoji-picker-react'), { ssr: false });


// MARK: - Types & Interfaces
interface Product {
  product_id: string;
  name: string;
  price: number;
  sku: string;
  category: string | null;
  emoji?: string | null;
  icon_id?: string | null;
  image_url?: string | null;
  // Inventory fields
  barcode?: string | null;
  track_stock?: boolean;
  quantity?: number;
  low_stock_threshold?: number;
  allow_negative_stock?: boolean;
}

interface ProductsManagerProps {
  storeId: string;
  walletAddress: string;
}

const API_URL = 'https://api.dltpays.com/nfc/api/v1';

const productEmojis: Record<string, string> = {
  'coffee': '‚òï', 'latte': '‚òï', 'cappuccino': '‚òï', 'espresso': '‚òï',
  'tea': 'üçµ', 'hot chocolate': 'üç´', 'water': 'üíß', 'juice': 'üßÉ',
  'smoothie': 'ü•§', 'soda': 'ü•§', 'beer': 'üç∫', 'wine': 'üç∑',
  'croissant': 'ü•ê', 'bagel': 'ü•Ø', 'toast': 'üçû', 'waffle': 'üßá',
  'pancake': 'ü•û', 'egg': 'ü•ö', 'bacon': 'ü•ì', 'sandwich': 'ü•™',
  'burger': 'üçî', 'pizza': 'üçï', 'salad': 'ü•ó', 'soup': 'üç≤',
  'pasta': 'üçù', 'sushi': 'üç£', 'cookie': 'üç™', 'cake': 'üç∞',
  'donut': 'üç©', 'ice cream': 'üç¶', 'fries': 'üçü', 'taco': 'üåÆ',
};

function getAutoEmoji(name: string, category: string | null): string {
  const nameLower = name.toLowerCase();
  for (const [key, emoji] of Object.entries(productEmojis)) {
    if (nameLower.includes(key)) return emoji;
  }
  return 'üì¶';
}

function ProductIcon({ product, size = 40 }: { product: Product; size?: number }) {
  if (product.image_url) {

// MARK: - Main Render
    return (
      <img 
        src={product.image_url} 
        alt={product.name}
        className="object-cover rounded-lg"
        style={{ width: size, height: size }}
      />
    );
  }
  
  if (product.icon_id) {
    const icon = getIconById(product.icon_id);
    if (icon) {
      return (
        <div 
          className="bg-zinc-700 rounded-lg flex items-center justify-center text-emerald-400"
          style={{ width: size, height: size, padding: size * 0.15 }}
          dangerouslySetInnerHTML={{ __html: icon.svg }}
        />
      );
    }
  }
  
  const emoji = product.emoji || getAutoEmoji(product.name, product.category);
  return (
    <div 
      className="bg-zinc-700 rounded-lg flex items-center justify-center"
      style={{ width: size, height: size, fontSize: size * 0.5 }}
    >
      {emoji}
    </div>
  );
}

export default function ProductsManager({ storeId, walletAddress }: ProductsManagerProps) {
  const [products, setProducts] = useState<Product[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [showForm, setShowForm] = useState(false);
  const [editingProduct, setEditingProduct] = useState<Product | null>(null);
  const [saving, setSaving] = useState(false);
  const [showIconPicker, setShowIconPicker] = useState(false);
  const [iconTab, setIconTab] = useState<'icons' | 'emoji' | 'upload'>('icons');
  const [iconSearch, setIconSearch] = useState('');
  const [selectedIconCategory, setSelectedIconCategory] = useState<string | null>(null);
  const [uploading, setUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const [formName, setFormName] = useState('');
  const [formPrice, setFormPrice] = useState('');
  const [formSku, setFormSku] = useState('');
  const [formCategory, setFormCategory] = useState('');
  const [formEmoji, setFormEmoji] = useState('');
  const [formIconId, setFormIconId] = useState<string | null>(null);
  const [formImageUrl, setFormImageUrl] = useState<string | null>(null);
  // Inventory form fields
  const [formBarcode, setFormBarcode] = useState('');
  const [formTrackStock, setFormTrackStock] = useState(false);
  const [formQuantity, setFormQuantity] = useState('');
  const [formLowStockThreshold, setFormLowStockThreshold] = useState('5');

  // CSV Import/Export
  const [showImportModal, setShowImportModal] = useState(false);

  // Inventory History
  const [showHistoryModal, setShowHistoryModal] = useState(false);
  const [historyProduct, setHistoryProduct] = useState<Product | null>(null);


// MARK: - API Calls & Data Fetching
  const fetchProducts = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${API_URL}/store/${storeId}/products?wallet_address=${walletAddress}`);
      const data = await res.json();
      if (data.success) setProducts(data.products);
      else setError(data.error || 'Failed to load products');
    } catch {
      setError('Failed to connect to server');
    }
    setLoading(false);
  };


// MARK: - Hooks & Effects
  useEffect(() => {
    if (storeId && walletAddress) fetchProducts();
  }, [storeId, walletAddress]);

  // CSV Import Handler

// MARK: - Event Handlers
  const handleCSVImport = async (rows: Record<string, string>[]): Promise<{ success: number; failed: number; errors: string[] }> => {
    try {
      const products = rows.map(row => ({
        name: row.name?.trim(),
        price: parseFloat(row.price),
        category: row.category?.trim() || null,
        sku: row.sku?.trim() || null,
        barcode: row.barcode?.trim() || null,
        track_stock: row.quantity !== undefined && row.quantity !== '',
        quantity: parseInt(row.quantity) || 0,
        low_stock_threshold: parseInt(row.low_stock_threshold) || 5
      }));

      const res = await fetch(`${API_URL}/store/${storeId}/products/bulk`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress,
          products
        })
      });

      const data = await res.json();

      if (data.success) {
        await fetchProducts(); // Refresh the product list
        return {
          success: data.created || 0,
          failed: data.errors?.length || 0,
          errors: data.errors || []
        };
      } else {
        return {
          success: 0,
          failed: rows.length,
          errors: [data.error || 'Import failed']
        };
      }
    } catch (err: any) {
      return {
        success: 0,
        failed: rows.length,
        errors: [err.message || 'Network error']
      };
    }
  };

  // CSV Export Handler
  const handleCSVExport = () => {
    const csv = Papa.unparse({
      fields: ['name', 'price', 'category', 'sku', 'barcode', 'quantity', 'low_stock_threshold'],
      data: products.map(p => ({
        name: p.name,
        price: p.price.toFixed(2),
        category: p.category || '',
        sku: p.sku || '',
        barcode: p.barcode || '',
        quantity: p.track_stock ? (p.quantity || 0).toString() : '',
        low_stock_threshold: p.track_stock ? (p.low_stock_threshold || 5).toString() : ''
      }))
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `products-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  };

  useEffect(() => {
    if (formName && !editingProduct && !formIconId && !formImageUrl) {
      const icon = findIconForProduct(formName, formCategory);
      if (icon) {
        setFormIconId(icon.id);
        setFormEmoji('');
      } else {
        setFormEmoji(getAutoEmoji(formName, formCategory));
        setFormIconId(null);
      }
    }
  }, [formName, formCategory, editingProduct, formIconId, formImageUrl]);

  const resetForm = () => {
    setFormName(''); setFormPrice(''); setFormSku(''); setFormCategory('');
    setFormEmoji(''); setFormIconId(null); setFormImageUrl(null);
    setFormBarcode(''); setFormTrackStock(false); setFormQuantity(''); setFormLowStockThreshold('5');
    setEditingProduct(null); setShowForm(false); setShowIconPicker(false);
    setIconSearch(''); setSelectedIconCategory(null); setError(null);
  };

  const openEditForm = (product: Product) => {
    setEditingProduct(product);
    setFormName(product.name);
    setFormPrice(product.price.toString());
    setFormSku(product.sku);
    setFormCategory(product.category || '');
    setFormEmoji(product.emoji || '');
    setFormIconId(product.icon_id || null);
    setFormImageUrl(product.image_url || null);
    // Inventory fields
    setFormBarcode(product.barcode || '');
    setFormTrackStock(product.track_stock || false);
    setFormQuantity(product.quantity?.toString() || '0');
    setFormLowStockThreshold(product.low_stock_threshold?.toString() || '5');
    setShowForm(true);
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!formName.trim() || !formPrice) { setError('Name and price are required'); return; }
    const price = parseFloat(formPrice);
    if (isNaN(price) || price <= 0) { setError('Please enter a valid price'); return; }

    setSaving(true); setError(null);
    try {
      const url = editingProduct
        ? `${API_URL}/store/${storeId}/products/${editingProduct.product_id}`
        : `${API_URL}/store/${storeId}/products`;

      const res = await fetch(url, {
        method: editingProduct ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress,
          name: formName.trim(),
          price,
          sku: formSku.trim() || undefined,
          category: formCategory.trim() || null,
          emoji: formIconId || formImageUrl ? null : (formEmoji || null),
          icon_id: formIconId || null,
          image_url: formImageUrl || null,
          // Inventory fields
          barcode: formBarcode.trim() || null,
          track_stock: formTrackStock,
          quantity: parseInt(formQuantity) || 0,
          low_stock_threshold: parseInt(formLowStockThreshold) || 5
        })
      });
      const data = await res.json();
      if (data.success) { await fetchProducts(); resetForm(); }
      else setError(data.error || 'Failed to save product');
    } catch { setError('Failed to save product'); }
    setSaving(false);
  };

  const handleDelete = async (product: Product) => {
    if (!confirm(`Delete "${product.name}"?`)) return;
    try {
      const res = await fetch(`${API_URL}/store/${storeId}/products/${product.product_id}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const data = await res.json();
      if (data.success) setProducts(products.filter(p => p.product_id !== product.product_id));
      else setError(data.error || 'Failed to delete product');
    } catch { setError('Failed to delete product'); }
  };

  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { 
    setError('Image must be less than 5MB'); 
    return; 
  }

  setUploading(true); 
  setError(null);
  
  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 't7wy0r6e');
    formData.append('eager', 'q_auto,f_auto,w_400,h_400,c_limit');
    
    const res = await fetch('https://api.cloudinary.com/v1_1/dghhmw3q3/image/upload', { 
      method: 'POST', 
      body: formData 
    });
    const data = await res.json();
    
    if (data.secure_url) {
      setFormImageUrl(data.secure_url);
      setFormIconId(null); 
      setFormEmoji(''); 
      setShowIconPicker(false);
    } else {
      setError('Failed to upload image');
    }
  } catch (err) {
    console.error('Upload error:', err);
    setError('Failed to upload image');
  }
  
  setUploading(false);
};

  const selectIcon = (icon: FoodIcon) => {
    setFormIconId(icon.id); setFormEmoji(''); setFormImageUrl(null); setShowIconPicker(false);
  };

  const selectEmoji = (emoji: string) => {
    setFormEmoji(emoji); setFormIconId(null); setFormImageUrl(null); setShowIconPicker(false);
  };

  const filteredIcons = foodIcons.filter(icon => {
    if (selectedIconCategory && icon.category !== selectedIconCategory) return false;
    if (iconSearch) {
      const search = iconSearch.toLowerCase();
      return icon.name.toLowerCase().includes(search) || icon.keywords.some(k => k.includes(search));
    }
    return true;
  });

  const categories = [...new Set(products.map(p => p.category).filter(Boolean))] as string[];

  const currentPreview = formImageUrl ? (
    <img src={formImageUrl} alt="Preview" className="w-full h-full object-cover rounded-xl" />
  ) : formIconId ? (
    <div className="w-full h-full flex items-center justify-center text-emerald-400 p-2" dangerouslySetInnerHTML={{ __html: getIconById(formIconId)?.svg || '' }} />
  ) : (
    <span className="text-4xl">{formEmoji || 'üì¶'}</span>
  );

  return (
    <div className="bg-zinc-900 rounded-xl p-6">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h2 className="text-lg font-bold">Products</h2>
          <p className="text-zinc-500 text-sm">Manage your product catalog</p>
        </div>
        <div className="flex items-center gap-2">
          {/* Import/Export dropdown for mobile, buttons for desktop */}
          <div className="hidden sm:flex items-center gap-2">
            <button
              onClick={() => setShowImportModal(true)}
              className="bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-2 rounded-lg transition flex items-center gap-2 text-sm"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
              Import
            </button>
            {products.length > 0 && (
              <button
                onClick={handleCSVExport}
                className="bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-2 rounded-lg transition flex items-center gap-2 text-sm"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Export
              </button>
            )}
          </div>
          {/* Mobile: compact buttons */}
          <div className="flex sm:hidden items-center gap-1">
            <button
              onClick={() => setShowImportModal(true)}
              className="bg-zinc-800 hover:bg-zinc-700 text-white p-2 rounded-lg transition"
              title="Import CSV"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
            </button>
            {products.length > 0 && (
              <button
                onClick={handleCSVExport}
                className="bg-zinc-800 hover:bg-zinc-700 text-white p-2 rounded-lg transition"
                title="Export CSV"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </button>
            )}
          </div>
          <button onClick={() => { resetForm(); setShowForm(true); }} className="bg-emerald-500 hover:bg-emerald-400 text-black font-semibold px-4 py-2 rounded-lg transition flex items-center gap-2">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
            <span className="hidden sm:inline">Add Product</span>
            <span className="sm:hidden">Add</span>
          </button>
        </div>
      </div>

      {error && (
        <div className="bg-red-500/10 rounded-lg p-4 mb-4">
          <p className="text-red-400 text-sm">{error}</p>
          <button onClick={() => setError(null)} className="text-red-400 text-xs mt-1 hover:underline">Dismiss</button>
        </div>
      )}

      {/* Low Stock Alert */}
      {(() => {
        const lowStockProducts = products.filter(p =>
          p.track_stock && (p.quantity || 0) <= (p.low_stock_threshold || 5)
        );
        if (lowStockProducts.length === 0) return null;

        const outOfStock = lowStockProducts.filter(p => (p.quantity || 0) === 0);

        return (
          <div className={`rounded-lg p-4 mb-4 ${outOfStock.length > 0 ? 'bg-red-500/10 border border-red-500/30' : 'bg-amber-500/10 border border-amber-500/30'}`}>
            <div className="flex items-center gap-2 mb-2">
              <svg className={`w-5 h-5 ${outOfStock.length > 0 ? 'text-red-400' : 'text-amber-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span className={`font-semibold ${outOfStock.length > 0 ? 'text-red-400' : 'text-amber-400'}`}>
                {outOfStock.length > 0 ? `${outOfStock.length} out of stock` : 'Low Stock Alert'}
              </span>
            </div>
            <ul className="text-sm text-zinc-400 space-y-1">
              {lowStockProducts.slice(0, 5).map(p => (
                <li key={p.product_id} className="flex items-center justify-between">
                  <span>{p.name}</span>
                  <span className={`font-mono ${(p.quantity || 0) === 0 ? 'text-red-400' : 'text-amber-400'}`}>
                    {p.quantity || 0} left
                  </span>
                </li>
              ))}
              {lowStockProducts.length > 5 && (
                <li className="text-zinc-500">...and {lowStockProducts.length - 5} more</li>
              )}
            </ul>
          </div>
        );
      })()}

      {showForm && (
        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[60] p-4">
          <div className="bg-zinc-900 rounded-xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-bold">{editingProduct ? 'Edit Product' : 'Add Product'}</h3>
              <button onClick={resetForm} className="text-zinc-400 hover:text-white transition">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
              </button>
            </div>

            <form onSubmit={handleSave} className="space-y-4">
              <div>
                <label className="text-zinc-400 text-sm block mb-2">Icon</label>
                <div className="flex items-center gap-3">
                  <button type="button" onClick={() => setShowIconPicker(!showIconPicker)} className="w-16 h-16 bg-zinc-800 hover:bg-zinc-700 rounded-xl flex items-center justify-center transition overflow-hidden">
                    {currentPreview}
                  </button>
                  <div className="text-zinc-500 text-sm">
                    <p>Tap to choose</p>
                    <p className="text-zinc-600 text-xs">{formImageUrl ? 'Custom image' : formIconId ? 'SVG icon' : 'Emoji'}</p>
                  </div>
                </div>

                {showIconPicker && (
                  <div className="mt-3 bg-zinc-800 rounded-xl p-4">
                    <div className="flex gap-1 mb-4 bg-zinc-900 rounded-lg p-1">
                      {(['icons', 'emoji', 'upload'] as const).map(tab => (
                        <button key={tab} type="button" onClick={() => setIconTab(tab)} className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition ${iconTab === tab ? 'bg-zinc-700 text-white' : 'text-zinc-400 hover:text-white'}`}>
                          {tab === 'icons' ? 'üé® Icons' : tab === 'emoji' ? 'üòÄ Emoji' : 'üì∑ Upload'}
                        </button>
                      ))}
                    </div>

                    {iconTab === 'icons' && (
                      <div>
                        <input type="text" placeholder="Search icons..." value={iconSearch} onChange={e => setIconSearch(e.target.value)} className="w-full bg-zinc-900 rounded-lg px-3 py-2 text-sm mb-3 focus:outline-none focus:ring-1 focus:ring-emerald-500" />
                        <div className="flex flex-wrap gap-1 mb-3">
                          <button type="button" onClick={() => setSelectedIconCategory(null)} className={`px-2 py-1 rounded text-xs transition ${!selectedIconCategory ? 'bg-emerald-500 text-black' : 'bg-zinc-700 text-zinc-300 hover:bg-zinc-600'}`}>All</button>
                          {foodIconCategories.map(cat => (
                            <button key={cat} type="button" onClick={() => setSelectedIconCategory(cat)} className={`px-2 py-1 rounded text-xs transition ${selectedIconCategory === cat ? 'bg-emerald-500 text-black' : 'bg-zinc-700 text-zinc-300 hover:bg-zinc-600'}`}>{cat}</button>
                          ))}
                        </div>
                        <div className="grid grid-cols-6 gap-2 max-h-48 overflow-y-auto">
                          {filteredIcons.map(icon => (
                            <button key={icon.id} type="button" onClick={() => selectIcon(icon)} title={icon.name} className={`w-10 h-10 rounded-lg flex items-center justify-center text-emerald-400 transition hover:bg-zinc-600 ${formIconId === icon.id ? 'bg-emerald-500/20 ring-2 ring-emerald-500' : 'bg-zinc-700'}`}>
                              <div className="w-6 h-6" dangerouslySetInnerHTML={{ __html: icon.svg }} />
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    {iconTab === 'emoji' && (
                      <EmojiPicker onEmojiClick={(data) => selectEmoji(data.emoji)} theme={Theme.DARK} width="100%" height={300} />
                    )}

                    {iconTab === 'upload' && (
                      <div className="text-center py-8">
                        <input ref={fileInputRef} type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                        <button type="button" onClick={() => fileInputRef.current?.click()} disabled={uploading} className="bg-zinc-700 hover:bg-zinc-600 px-6 py-3 rounded-lg transition disabled:opacity-50">
                          {uploading ? 'Uploading...' : 'üì∑ Choose Image'}
                        </button>
                        <p className="text-zinc-500 text-xs mt-2">Max 5MB, JPG/PNG</p>
                      </div>
                    )}
                  </div>
                )}
              </div>

              <div>
                <label className="text-zinc-400 text-sm block mb-1">Product Name <span className="text-red-400">*</span></label>
                <input type="text" value={formName} onChange={e => setFormName(e.target.value)} placeholder="e.g. Flat White" className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-emerald-500" autoFocus />
              </div>

              <div>
                <label className="text-zinc-400 text-sm block mb-1">Price (¬£) <span className="text-red-400">*</span></label>
                <input type="number" step="0.01" min="0" value={formPrice} onChange={e => setFormPrice(e.target.value)} placeholder="0.00" className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-emerald-500" />
              </div>

              <div>
                <label className="text-zinc-400 text-sm block mb-1">Category <span className="text-zinc-600">(optional)</span></label>
                <input type="text" value={formCategory} onChange={e => setFormCategory(e.target.value)} placeholder="e.g. Hot Drinks" list="categories" className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-emerald-500" />
                {categories.length > 0 && <datalist id="categories">{categories.map(cat => <option key={cat} value={cat} />)}</datalist>}
              </div>

              <div>
                <label className="text-zinc-400 text-sm block mb-1">SKU <span className="text-zinc-600">(optional)</span></label>
                <input type="text" value={formSku} onChange={e => setFormSku(e.target.value.toUpperCase())} placeholder="e.g. FLATWHT" className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 font-mono" />
              </div>

              <div>
                <label className="text-zinc-400 text-sm block mb-1">Barcode <span className="text-zinc-600">(optional)</span></label>
                <input type="text" value={formBarcode} onChange={e => setFormBarcode(e.target.value)} placeholder="e.g. 5901234123457" className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-emerald-500 font-mono" />
              </div>

              {/* Inventory Section */}
              <div className="border-t border-zinc-700 pt-4 mt-4">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <label className="text-zinc-300 text-sm font-medium">Track Stock</label>
                    <p className="text-zinc-500 text-xs">Monitor inventory levels</p>
                  </div>
                  <button
                    type="button"
                    onClick={() => setFormTrackStock(!formTrackStock)}
                    className={`w-12 h-6 rounded-full transition-colors relative ${formTrackStock ? 'bg-emerald-500' : 'bg-zinc-700'}`}
                  >
                    <span className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${formTrackStock ? 'left-7' : 'left-1'}`} />
                  </button>
                </div>

                {formTrackStock && (
                  <div className="space-y-4 bg-zinc-800/50 rounded-lg p-4">
                    <div>
                      <label className="text-zinc-400 text-sm block mb-1">Current Stock</label>
                      <input
                        type="number"
                        min="0"
                        value={formQuantity}
                        onChange={e => setFormQuantity(e.target.value)}
                        placeholder="0"
                        className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
                      />
                    </div>
                    <div>
                      <label className="text-zinc-400 text-sm block mb-1">Low Stock Alert</label>
                      <p className="text-zinc-500 text-xs mb-2">Alert when stock falls to this level</p>
                      <input
                        type="number"
                        min="0"
                        value={formLowStockThreshold}
                        onChange={e => setFormLowStockThreshold(e.target.value)}
                        placeholder="5"
                        className="w-full bg-zinc-800 rounded-lg px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
                      />
                    </div>
                  </div>
                )}
              </div>

              <div className="flex gap-3 pt-2">
                <button type="button" onClick={resetForm} className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-lg font-medium transition">Cancel</button>
                <button type="submit" disabled={saving} className="flex-1 bg-emerald-500 hover:bg-emerald-400 text-black py-3 rounded-lg font-semibold transition disabled:opacity-50">
                  {saving ? 'Saving...' : editingProduct ? 'Update' : 'Add Product'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {loading ? (
        <div className="text-center py-8">
          <div className="w-6 h-6 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-2" />
          <p className="text-zinc-500 text-sm">Loading products...</p>
        </div>
      ) : products.length === 0 ? (
        <div className="text-center py-12 bg-zinc-800/50 rounded-xl">
          <div className="text-4xl mb-3">üì¶</div>
          <p className="text-zinc-400 mb-2">No products yet</p>
          <p className="text-zinc-500 text-sm">Add products to enable quick checkout</p>
        </div>
      ) : (
        <div className="space-y-2">
          {categories.length > 0 ? (
            <>
              {categories.map(category => (
                <div key={category} className="mb-4">
                  <h3 className="text-zinc-500 text-xs font-semibold uppercase tracking-wide mb-2">{category}</h3>
                  <div className="space-y-2">
                    {products.filter(p => p.category === category).map(product => (
                      <ProductRow
                        key={product.product_id}
                        product={product}
                        onEdit={() => openEditForm(product)}
                        onDelete={() => handleDelete(product)}
                        onHistory={() => { setHistoryProduct(product); setShowHistoryModal(true); }}
                      />
                    ))}
                  </div>
                </div>
              ))}
              {products.filter(p => !p.category).length > 0 && (
                <div>
                  <h3 className="text-zinc-500 text-xs font-semibold uppercase tracking-wide mb-2">Uncategorized</h3>
                  <div className="space-y-2">
                    {products.filter(p => !p.category).map(product => (
                      <ProductRow
                        key={product.product_id}
                        product={product}
                        onEdit={() => openEditForm(product)}
                        onDelete={() => handleDelete(product)}
                        onHistory={() => { setHistoryProduct(product); setShowHistoryModal(true); }}
                      />
                    ))}
                  </div>
                </div>
              )}
            </>
          ) : (
            products.map(product => (
              <ProductRow
                key={product.product_id}
                product={product}
                onEdit={() => openEditForm(product)}
                onDelete={() => handleDelete(product)}
                onHistory={() => { setHistoryProduct(product); setShowHistoryModal(true); }}
              />
            ))
          )}
        </div>
      )}

      {products.length > 0 && (
        <div className="mt-4 pt-4 flex items-center justify-between text-sm text-zinc-500">
          <span>{products.length} product{products.length !== 1 ? 's' : ''}</span>
          <div className="flex items-center gap-4">
            {(() => {
              const tracked = products.filter(p => p.track_stock);
              const lowStock = tracked.filter(p => (p.quantity || 0) <= (p.low_stock_threshold || 5));
              if (tracked.length === 0) return null;
              return (
                <>
                  <span className={lowStock.length > 0 ? 'text-amber-400' : 'text-zinc-500'}>
                    {lowStock.length > 0 ? `${lowStock.length} low stock` : `${tracked.length} tracked`}
                  </span>
                  <button
                    onClick={() => { setHistoryProduct(null); setShowHistoryModal(true); }}
                    className="text-cyan-400 hover:text-cyan-300 transition flex items-center gap-1"
                  >
                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    History
                  </button>
                </>
              );
            })()}
            {categories.length > 0 && <span>{categories.length} categor{categories.length !== 1 ? 'ies' : 'y'}</span>}
          </div>
        </div>
      )}

      {/* CSV Import Modal */}
      <CSVImportModal
        isOpen={showImportModal}
        onClose={() => setShowImportModal(false)}
        onImport={handleCSVImport}
        templateColumns={['name', 'price', 'category', 'sku', 'barcode', 'quantity', 'low_stock_threshold']}
        requiredColumns={['name', 'price']}
        templateName="Products"
      />

      {/* Inventory History Modal */}
      {showHistoryModal && (
        <InventoryHistoryModal
          storeId={storeId}
          walletAddress={walletAddress}
          productId={historyProduct?.product_id}
          productName={historyProduct?.name}
          onClose={() => {
            setShowHistoryModal(false);
            setHistoryProduct(null);
          }}
        />
      )}
    </div>
  );
}

function ProductRow({ product, onEdit, onDelete, onHistory }: { product: Product; onEdit: () => void; onDelete: () => void; onHistory?: () => void }) {
  const isLowStock = product.track_stock && (product.quantity || 0) <= (product.low_stock_threshold || 5);
  const isOutOfStock = product.track_stock && (product.quantity || 0) === 0;

  return (
    <div className="flex items-center justify-between bg-zinc-800/50 hover:bg-zinc-800 rounded-lg p-3 transition group">
      <div className="flex items-center gap-3 min-w-0">
        <div className="relative">
          <ProductIcon product={product} size={40} />
          {isOutOfStock && (
            <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center">
              <span className="text-[8px] font-bold text-white">0</span>
            </div>
          )}
        </div>
        <div className="min-w-0">
          <p className="font-medium truncate">{product.name}</p>
          <div className="flex items-center gap-2">
            <p className="text-zinc-500 text-xs font-mono">{product.sku}</p>
            {product.barcode && (
              <p className="text-zinc-600 text-xs">‚Ä¢ {product.barcode}</p>
            )}
          </div>
        </div>
      </div>
      <div className="flex items-center gap-3">
        {product.track_stock && (
          <div className={`text-xs px-2 py-1 rounded-full font-medium ${
            isOutOfStock ? 'bg-red-500/20 text-red-400' :
            isLowStock ? 'bg-amber-500/20 text-amber-400' :
            'bg-zinc-700 text-zinc-400'
          }`}>
            {product.quantity || 0} in stock
          </div>
        )}
        <span className="text-emerald-400 font-semibold">¬£{product.price.toFixed(2)}</span>
        <div className="flex items-center gap-1 sm:opacity-0 sm:group-hover:opacity-100 transition">
          {product.track_stock && onHistory && (
            <button onClick={onHistory} className="p-2 text-zinc-400 hover:text-cyan-400 hover:bg-zinc-700 rounded-lg transition" title="View history">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
          )}
          <button onClick={onEdit} className="p-2 text-zinc-400 hover:text-white hover:bg-zinc-700 rounded-lg transition" title="Edit">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
          </button>
          <button onClick={onDelete} className="p-2 text-zinc-400 hover:text-red-400 hover:bg-zinc-700 rounded-lg transition" title="Delete">
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
          </button>
        </div>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/QRCodeModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useEffect, useRef, useState } from 'react';
import QRCodeStyling from 'qr-code-styling';


// MARK: - Types & Interfaces
interface QRCodeModalProps {
  isOpen: boolean;
  onClose: () => void;
  url: string;
  title?: string;
  subtitle?: string;
}


// MARK: - Component Definition
export default function QRCodeModal({ isOpen, onClose, url, title = "Share Your Link", subtitle }: QRCodeModalProps) {
  const qrRef = useRef<HTMLDivElement>(null);
  const qrCode = useRef<QRCodeStyling | null>(null);

// MARK: - State Management
  const [copied, setCopied] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    if (!isOpen) return;

    qrCode.current = new QRCodeStyling({
      width: 280,
      height: 280,
      type: "svg",
      data: url,
      image: "/dltpayslogo1.png",
      dotsOptions: {
        color: "#10b981",
        type: "rounded"
      },
      cornersSquareOptions: {
        color: "#059669",
        type: "extra-rounded"
      },
      cornersDotOptions: {
        color: "#047857",
        type: "dot"
      },
      backgroundOptions: {
        color: "#18181b"
      },
      imageOptions: {
        crossOrigin: "anonymous",
        margin: 8,
        imageSize: 0.4
      }
    });

    if (qrRef.current) {
      qrRef.current.innerHTML = '';
      qrCode.current.append(qrRef.current);
    }
  }, [isOpen, url]);


// MARK: - Event Handlers
  const handleCopy = () => {
    navigator.clipboard.writeText(url);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const handleDownload = () => {
    if (qrCode.current) {
      qrCode.current.download({
        name: "yesallofus-qr",
        extension: "png"
      });
    }
  };

  const handleShare = (platform: string) => {
    const encodedUrl = encodeURIComponent(url);
    const text = encodeURIComponent("Join me on YesAllofUs and start earning!");
    
    const shareUrls: Record<string, string> = {
      whatsapp: `https://wa.me/?text=${text}%20${encodedUrl}`,
      twitter: `https://twitter.com/intent/tweet?text=${text}&url=${encodedUrl}`,
      facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
      email: `mailto:?subject=Join%20YesAllofUs&body=${text}%20${encodedUrl}`,
      telegram: `https://t.me/share/url?url=${encodedUrl}&text=${text}`,
    };

    if (shareUrls[platform]) {
      window.open(shareUrls[platform], '_blank', 'noopener,noreferrer');
    }
  };

  if (!isOpen) return null;


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-4 max-w-sm w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="flex items-center justify-between mb-4">
          <div>
            <h3 className="text-lg font-bold text-white">{title}</h3>
            {subtitle && <p className="text-zinc-400 text-sm">{subtitle}</p>}
          </div>
          <button
            onClick={onClose}
            className="text-zinc-400 hover:text-white transition-colors p-1"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* QR Code */}
        <div className="bg-zinc-800 rounded-xl p-4 mb-4 flex justify-center">
          <div ref={qrRef} className="rounded-lg overflow-hidden" />
        </div>

        {/* URL Display */}
        <div className="bg-zinc-800 rounded-lg p-3 mb-4">
          <p className="text-zinc-500 text-xs mb-1">Your Link</p>
          <p className="text-sm font-mono text-emerald-400 break-all">{url}</p>
        </div>

        {/* Copy Button */}
        <button
          onClick={handleCopy}
          className={`w-full py-3 rounded-lg text-sm font-semibold transition-colors mb-4 ${
            copied
              ? 'bg-emerald-500 text-black'
              : 'bg-zinc-800 hover:bg-zinc-700 text-white'
          }`}
        >
          {copied ? '‚úì Copied to Clipboard!' : 'Copy Link'}
        </button>

        {/* Share Buttons */}
        <div className="mb-4">
          <p className="text-zinc-500 text-xs mb-3 text-center">Share via</p>
          <div className="flex justify-center gap-3">
            {/* WhatsApp */}
            <button
              onClick={() => handleShare('whatsapp')}
              className="w-12 h-12 bg-[#25D366] hover:bg-[#20bd5a] rounded-full flex items-center justify-center transition-colors"
              title="Share on WhatsApp"
            >
              <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
            </button>

            {/* Twitter/X */}
            <button
              onClick={() => handleShare('twitter')}
              className="w-12 h-12 bg-black hover:bg-zinc-800 border border-zinc-700 rounded-full flex items-center justify-center transition-colors"
              title="Share on X"
            >
              <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </button>

            {/* Facebook */}
            <button
              onClick={() => handleShare('facebook')}
              className="w-12 h-12 bg-[#1877F2] hover:bg-[#166fe5] rounded-full flex items-center justify-center transition-colors"
              title="Share on Facebook"
            >
              <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </button>

            {/* Telegram */}
            <button
              onClick={() => handleShare('telegram')}
              className="w-12 h-12 bg-[#0088cc] hover:bg-[#007ab8] rounded-full flex items-center justify-center transition-colors"
              title="Share on Telegram"
            >
              <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
              </svg>
            </button>

            {/* Email */}
            <button
              onClick={() => handleShare('email')}
              className="w-12 h-12 bg-zinc-700 hover:bg-zinc-600 rounded-full flex items-center justify-center transition-colors"
              title="Share via Email"
            >
              <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </button>
          </div>
        </div>

        {/* Download Button */}
        <button
          onClick={handleDownload}
          className="w-full py-3 rounded-lg text-sm font-semibold bg-emerald-600 hover:bg-emerald-500 text-white transition-colors flex items-center justify-center gap-2"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          Download QR Code
        </button>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/ReceiptActions.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import EmailReceiptModal from './EmailReceiptModal';


// MARK: - Types & Interfaces
interface ReceiptActionsProps {
  receiptId?: string;
  txHash?: string;
  storeName: string;
  storeId?: string;
  amount: number;
  rlusdAmount?: number;
  items?: Array<{ name: string; quantity: number; unit_price: number }>;
  tipAmount?: number;
  conversionRate?: {
    rlusd_gbp: number;
    source: string;
    captured_at: string;
  };
  storeLogo?: string;
  walletAddress?: string;
  isSplit?: boolean;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
export default function ReceiptActions({
  receiptId,
  txHash,
  storeName,
  storeId,
  amount,
  rlusdAmount,
  items,
  tipAmount,
  conversionRate,
  storeLogo,
  walletAddress,
  isSplit = false,
}: ReceiptActionsProps) {

// MARK: - State Management
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [showPrintPreview, setShowPrintPreview] = useState(false);
  const [receiptData, setReceiptData] = useState<any>(null);
  const [loading, setLoading] = useState(false);

  // Fetch receipt data when print preview is opened
  const openPrintPreview = async () => {
  console.log('üñ®Ô∏è Print clicked, receiptId:', receiptId);
  setLoading(true);
    
    if (receiptId) {
      try {
        const url = walletAddress
          ? `${API_URL}/receipts/${receiptId}?wallet_address=${walletAddress}`
          : `${API_URL}/receipts/${receiptId}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.success && data.receipt) {
  console.log('üìù Receipt fetched:', data.receipt);
  console.log('üìù Tip amount:', data.receipt.tip_amount);
  setReceiptData(data.receipt);
  setLoading(false);
  setShowPrintPreview(true);
  return;
}
      } catch (e) {
        console.error('Failed to fetch receipt:', e);
      }
    }
    
    setLoading(false);
    setShowPrintPreview(true);
  };


// MARK: - Event Handlers
  const handlePrint = () => {
    window.print();
  };

  const tip = receiptData?.tip_amount || tipAmount || 0;
  const finalItems = receiptData?.items || items || [{ name: 'Payment', quantity: 1, unit_price: amount }];
  const finalAmount = receiptData?.total || (amount + (tipAmount || 0));
  const finalRlusd = receiptData?.amount_rlusd || rlusdAmount;
  const finalRate = receiptData?.conversion_rate || conversionRate;
  const finalTxHash = receiptData?.tx_hash || txHash;


// MARK: - Main Render
  return (
    <>
      <div className="flex justify-center gap-3">
        <button
          onClick={() => setShowEmailModal(true)}
          className="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 px-5 py-3 rounded-xl text-sm transition flex items-center gap-2"
        >
          <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Email Receipt
        </button>
        <button 
          onClick={openPrintPreview}
          disabled={loading}
          className="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 px-5 py-3 rounded-xl text-sm transition flex items-center gap-2"
        >
          {loading ? (
            <div className="w-5 h-5 border-2 border-sky-400 border-t-transparent rounded-full animate-spin" />
          ) : (
            <svg className="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
          )}
          Print
        </button>
      </div>

      <EmailReceiptModal
        isOpen={showEmailModal}
        onClose={() => setShowEmailModal(false)}
        receiptId={receiptId}
        txHash={txHash}
        storeName={storeName}
        storeId={storeId}
        amount={amount}
        rlusdAmount={rlusdAmount}
        items={items}
        tipAmount={tipAmount}
        conversionRate={conversionRate}
        walletAddress={walletAddress}
      />

      {/* Print Preview Modal */}
      {showPrintPreview && (
        <div className="fixed inset-0 bg-black z-50 overflow-y-auto">
          {/* Print Actions - Hidden when printing */}
          <div className="no-print sticky top-0 z-10 bg-zinc-900/95 backdrop-blur border-b border-zinc-800 p-4">
            <div className="max-w-md mx-auto flex items-center justify-between">
              <h2 className="font-bold text-white">Print Preview</h2>
              <div className="flex gap-2">
                <button
                  onClick={handlePrint}
                  className="bg-emerald-500 hover:bg-emerald-400 text-black font-bold px-6 py-2 rounded-xl transition flex items-center gap-2"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                  </svg>
                  Print
                </button>
                <button
                  onClick={() => {
                    setShowPrintPreview(false);
                    setReceiptData(null);
                  }}
                  className="bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-xl transition text-white"
                >
                  Close
                </button>
              </div>
            </div>
          </div>

          {/* Print Content */}
          <div className="max-w-md mx-auto bg-white text-black p-8 my-8 rounded-xl">
            {/* Header with dark banner */}
            <div className="text-center mb-6 pb-6 border-b-2 border-gray-200 bg-zinc-900 -mx-8 -mt-8 px-8 pt-8 pb-6 rounded-t-xl">
              {storeLogo ? (
                <img 
                  src={storeLogo} 
                  alt={storeName} 
                  className="w-16 h-16 rounded-xl object-cover mx-auto mb-3"
                />
              ) : (
                <img 
                  src="https://yesallofus.com/dltpayslogo1.png" 
                  alt="YesAllOfUs" 
                  className="w-16 h-16 rounded-xl object-cover mx-auto mb-3"
                />
              )}
              <h1 className="text-2xl font-bold mb-1 text-white">{storeName}</h1>
              {receiptData?.receipt_number && (
                <p className="text-sm text-zinc-400">Receipt #{receiptData.receipt_number}</p>
              )}
            </div>

            {/* Date */}
            <p className="text-sm text-gray-600 mb-6">
              {new Date().toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}
            </p>

            {/* Items */}
            <div className="mb-6">
              {finalItems.filter((item: any) => item.name.toLowerCase() !== 'tip').map((item: any, idx: number) => (
                <div key={idx} className="flex justify-between py-3 border-b border-gray-200">
                  <div>
                    <p className="font-medium">{item.name}</p>
                    <p className="text-sm text-gray-600">
                      Qty: {item.quantity || 1} √ó ¬£{(item.unit_price || item.price || 0).toFixed(2)}
                    </p>
                  </div>
                  <p className="font-semibold">
                    ¬£{(item.line_total || (item.unit_price || item.price || 0) * (item.quantity || 1)).toFixed(2)}
                  </p>
                </div>
              ))}

              {/* Tip */}
              {tip > 0 && (
                <div className="flex justify-between py-3 border-t border-gray-200 mt-2">
                  <div className="flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    <div>
                      <p className="font-medium text-emerald-600">Tip</p>
                      <p className="text-sm text-gray-600">Thank you!</p>
                    </div>
                  </div>
                  <p className="font-semibold text-emerald-600">
                    ¬£{tip.toFixed(2)}
                  </p>
                </div>
              )}
            </div>

            {/* Total */}
            <div className="flex justify-between items-center py-4 border-t-2 border-black mb-6">
              <span className="text-lg font-semibold">Total</span>
              <span className="text-3xl font-bold text-emerald-600">
                ¬£{finalAmount.toFixed(2)}
              </span>
            </div>

            {/* Settlement Details */}
            {finalRlusd && finalRate && (
              <div className="mb-6 p-4 bg-emerald-50 rounded-lg border-l-4 border-emerald-500">
                <p className="text-xs font-semibold text-emerald-800 mb-2">üí± SETTLEMENT DETAILS</p>
                <div className="text-sm space-y-1">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Amount Quoted:</span>
                    <span>¬£{finalAmount.toFixed(2)} GBP</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Amount Settled:</span>
                    <span className="font-semibold">{finalRlusd.toFixed(6)} RLUSD</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Exchange Rate:</span>
                    <span>¬£1 = {(1 / finalRate.rlusd_gbp)?.toFixed(6) || 'N/A'} RLUSD</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Rate Source:</span>
                    <span>{finalRate.source || 'CoinGecko Pro API'}</span>
                  </div>
                  {finalRate.captured_at && (
                    <div className="flex justify-between">
                      <span className="text-gray-600">Rate Timestamp:</span>
                      <span className="text-xs text-gray-500">{new Date(finalRate.captured_at).toISOString()}</span>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Transaction Hash */}
            {finalTxHash && (
              <div className="mb-6 p-3 bg-gray-100 rounded-lg">
                <p className="text-xs text-gray-500 mb-1">XRPL TRANSACTION</p>
                <p className="text-xs font-mono break-all text-gray-700">{finalTxHash}</p>
              </div>
            )}

            {/* Footer */}
            <div className="text-center pt-4 border-t border-gray-200">
              <div className="flex flex-col items-center gap-1">
                <span className="text-zinc-400 text-[9px] font-medium tracking-widest">RECEIPT</span>
                <span className="text-base font-extrabold tracking-widest">
                  <span className="text-emerald-500">Y</span>
                  <span className="text-green-500">A</span>
                  <span className="text-blue-500">O</span>
                  <span className="text-indigo-500">F</span>
                  <span className="text-violet-500">U</span>
                  <span className="text-purple-500">S</span>
                </span>
                <span className="text-zinc-500 text-[10px] font-semibold tracking-widest">INSTANT</span>
                <div className="flex items-center gap-2 mt-2">
                  <img src="https://yesallofus.com/dltpayslogo1.png" alt="YesAllOfUs" className="w-4 h-4 rounded opacity-60" />
                  <span className="text-gray-400 text-xs">Powered by YesAllOfUs</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Print styles */}
      <style jsx global>{`
        @media print {
          .no-print {
            display: none !important;
          }
          body {
            background: white !important;
          }
          .fixed {
            position: static !important;
          }
        }
      `}</style>
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SendPaymentLink.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { QRCodeSVG } from 'qrcode.react';


// MARK: - Types & Interfaces
interface SendPaymentLinkProps {
  storeId: string;
  storeName: string;
  storeLogo: string | null;
  amount: number;
  items?: any[];
  tip?: number;
  onClose: () => void;
  onSuccess?: () => void;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
export default function SendPaymentLink({ 
  storeId, 
  storeName, 
  storeLogo, 
  amount, 
  items,
  tip = 0,
  onClose,
  onSuccess 
}: SendPaymentLinkProps) {
  const [paymentUrl, setPaymentUrl] = useState<string | null>(null);
  const [paymentId, setPaymentId] = useState<string | null>(null);

// MARK: - State Management
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [copied, setCopied] = useState(false);
  
  // QR code display
  const [showQR, setShowQR] = useState(false);
  
  // Waiting state
  const [waitingForPayment, setWaitingForPayment] = useState(false);
  const [paymentComplete, setPaymentComplete] = useState(false);
  
  // Email form
  const [showEmailForm, setShowEmailForm] = useState(false);
  const [email, setEmail] = useState('');
  const [sendingEmail, setSendingEmail] = useState(false);
  const [emailSent, setEmailSent] = useState(false);

  // Create payment link

// MARK: - API Calls & Data Fetching
  const createPaymentLink = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const res = await fetch(`${API_URL}/payment-link/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: storeId,
          amount: amount,
          items: items || [],
          tip: tip || 0,
          currency: 'GBP'
        })
      });
      
      const data = await res.json();
      
      if (data.success) {
  setPaymentUrl(data.payment_url);
  setPaymentId(data.payment_id);
  
  // Update customer display
  const { updateCustomerDisplay } = await import('@/lib/customerDisplay');
  const cart = items?.map(item => ({
    name: item.name,
    quantity: item.quantity,
    price: item.unit_price || item.price,
    emoji: 'üí∑'
  })) || [{ name: 'Payment', quantity: 1, price: amount, emoji: 'üí∑' }];
  
  await updateCustomerDisplay(storeId, storeName, cart, amount, 'link_pending', null, 0);
} else {
        setError(data.error || 'Failed to create payment link');
      }
    } catch (err) {
      setError('Failed to create payment link');
    } finally {
      setLoading(false);
    }
  };

  // Copy to clipboard
  const copyLink = async () => {
    if (!paymentUrl) return;
    
    try {
      await navigator.clipboard.writeText(paymentUrl);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      // Fallback for older browsers
      const input = document.createElement('input');
      input.value = paymentUrl;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    }
  };

  // Email validation regex
  const isValidEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  // Send via email
  const sendEmail = async () => {
    if (!email || !isValidEmail(email)) {
      setError('Please enter a valid email');
      return;
    }
    
    setSendingEmail(true);
    setError(null);
    
    try {
      const res = await fetch(`${API_URL}/payment-link/send-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: email.trim().toLowerCase(),
          payment_url: paymentUrl,
          store_name: storeName,
          store_logo: storeLogo,
          amount: amount
        })
      });
      
      const data = await res.json();
      
      if (data.success) {
        setEmailSent(true);
        if (onSuccess) onSuccess();
      } else {
        setError(data.error || 'Failed to send email');
      }
    } catch (err) {
      setError('Failed to send email');
    } finally {
      setSendingEmail(false);
    }
  };

// Poll for payment status - ALWAYS poll once we have a payment ID

// MARK: - Hooks & Effects
useEffect(() => {
  if (!paymentId) return;
  
  const pollInterval = setInterval(async () => {
    try {
      const res = await fetch(`${API_URL}/payment-link/${paymentId}`);
      const data = await res.json();
      
      console.log('Payment status:', data.payment?.status);
      
      // Check for direct payment completion
      if (data.payment?.status === 'paid' || data.payment?.status === 'complete' || data.payment?.status === 'completed') {
clearInterval(pollInterval);
setPaymentComplete(true);
        setPaymentComplete(true);
        setWaitingForPayment(false);
        
        // Update customer display to success
        try {
          const { updateCustomerDisplay } = await import('@/lib/customerDisplay');
          await updateCustomerDisplay(storeId, storeName, [], amount, 'success', null, 0);
        } catch (displayErr) {
          console.error('Display update error:', displayErr);
        }
        
        // Haptic feedback
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        
        if (onSuccess) onSuccess();
        return;
      }
      
      // Check for split payment completion
      if (data.payment?.status === 'split') {
        // Poll split status to see if all splits are paid
        const splitRes = await fetch(`${API_URL}/payment-link/${paymentId}/split-status`);
        const splitData = await splitRes.json();
        
        console.log('Split status:', splitData);
        
        if (splitData.success && splitData.all_paid) {
          setPaymentComplete(true);
          setWaitingForPayment(false);
          
          // Update customer display to success
          try {
            const { updateCustomerDisplay } = await import('@/lib/customerDisplay');
            await updateCustomerDisplay(storeId, storeName, [], amount, 'success', null, 0);
          } catch (displayErr) {
            console.error('Display update error:', displayErr);
          }
          
          // Haptic feedback
          if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
          
          if (onSuccess) onSuccess();
        }
      }
    } catch (err) {
      console.error('Poll error:', err);
    }
  }, 2000);
  
  return () => clearInterval(pollInterval);
}, [paymentId, storeId, storeName, amount, onSuccess]);
  

// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
      <div className="bg-zinc-900 rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
        
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-xl font-bold">Send Payment Link</h2>
          <button 

// MARK: - Event Handlers
            onClick={onClose}
            className="text-zinc-500 hover:text-white transition"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Amount */}
        <div className="text-center mb-6">
          <p className="text-zinc-400 text-sm mb-1">Amount</p>
          <p className="text-4xl font-bold text-emerald-400">¬£{amount.toFixed(2)}</p>
          {tip > 0 && (
            <p className="text-emerald-400/70 text-sm mt-1">
              (includes ¬£{tip.toFixed(2)} tip)
            </p>
          )}
          <p className="text-zinc-500 text-sm mt-1">{storeName}</p>
        </div>

        {/* Create Link Button (initial state) */}
        {!paymentUrl && !loading && (
          <button
            onClick={createPaymentLink}
            className="w-full bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-4 rounded-xl transition cursor-pointer"
          >
            Create Payment Link
          </button>
        )}

        {/* Loading */}
        {loading && (
          <div className="flex items-center justify-center py-8">
            <div className="w-8 h-8 border-3 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
          </div>
        )}

        {/* Payment Link Created */}
        {paymentUrl && !emailSent && !waitingForPayment && !paymentComplete && (
          <>
            {/* QR Code Display */}
            {showQR && paymentUrl && (
              <div className="mb-6">
                <div className="bg-white rounded-2xl p-4 mx-auto w-fit">
                  <QRCodeSVG 
                    value={paymentUrl}
                    size={192}
                    level="M"
                  />
                </div>
                <p className="text-zinc-500 text-xs text-center mt-2">
                  Customer scans this with their phone camera
                </p>
              </div>
            )}

            {/* Link Display */}
            <div className="bg-zinc-800 rounded-xl p-4 mb-4">
              <p className="text-zinc-400 text-xs mb-2">Payment Link</p>
              <p className="text-white text-sm break-all font-mono select-all">{paymentUrl}</p>
            </div>

            {/* Action Buttons */}
            <div className="grid grid-cols-2 gap-3 mb-4">
              {/* Copy Button */}
              <button
                onClick={copyLink}
                className={`py-3 rounded-xl font-medium transition flex items-center justify-center gap-2 cursor-pointer ${
                  copied 
                    ? 'bg-emerald-500 text-black' 
                    : 'bg-zinc-800 hover:bg-zinc-700 text-white'
                }`}
              >
                {copied ? (
                  <>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                    </svg>
                    Copied!
                  </>
                ) : (
                  <>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                    Copy
                  </>
                )}
              </button>

              {/* Show/Hide QR Button */}
              <button
                onClick={() => setShowQR(!showQR)}
                className="py-3 rounded-xl font-medium transition flex items-center justify-center gap-2 cursor-pointer bg-zinc-800 hover:bg-zinc-700 text-white"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
                {showQR ? 'Hide QR' : 'Show QR'}
              </button>
            </div>

            {/* Quick Send Info */}
            <div className="bg-zinc-800/50 rounded-xl p-3 mb-4">
              <p className="text-zinc-400 text-xs text-center">
                üìã Copy link ‚Üí Paste in WhatsApp, SMS, or any app
              </p>
            </div>

            {/* Wait for Payment Button */}
            <button
              onClick={() => setWaitingForPayment(true)}
              className="w-full bg-sky-600 hover:bg-sky-500 text-white py-4 rounded-xl font-bold transition flex items-center justify-center gap-2 cursor-pointer mt-4"
            >
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Wait for Payment
            </button>

            {/* Divider */}
            <div className="flex items-center gap-3 my-4">
              <div className="flex-1 h-px bg-zinc-800"></div>
              <span className="text-zinc-500 text-sm">or send via email</span>
              <div className="flex-1 h-px bg-zinc-800"></div>
            </div>

            {/* Email Form */}
            {!showEmailForm ? (
              <button
                onClick={() => setShowEmailForm(true)}
                className="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-4 rounded-xl font-medium transition flex items-center justify-center gap-2 cursor-pointer"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                Send via Email
              </button>
            ) : (
              <div className="space-y-3">
                <input
                  type="email"
                  placeholder="customer@email.com"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full bg-zinc-800 border border-zinc-700 rounded-xl px-4 py-3 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500"
                  autoFocus
                />
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => setShowEmailForm(false)}
                    className="py-3 rounded-xl font-medium transition bg-zinc-800 hover:bg-zinc-700 text-white cursor-pointer"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={sendEmail}
                    disabled={sendingEmail || !email}
                    className="py-3 rounded-xl font-bold transition bg-emerald-500 hover:bg-emerald-400 disabled:bg-emerald-500/50 text-black cursor-pointer disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {sendingEmail ? (
                      <>
                        <div className="w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                        Sending
                      </>
                    ) : (
                      'Send'
                    )}
                  </button>
                </div>
              </div>
            )}
          </>
        )}

        {/* Waiting for Payment State */}
        {waitingForPayment && !paymentComplete && (
          <div className="flex flex-col items-center justify-center py-8">
            {/* YAOFU Badge */}
            <div className="mb-8">
              <svg viewBox="0 0 140 52" className="w-36 h-14">
                <text x="70" y="14" textAnchor="middle" fill="#71717a" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="500" fontSize="10" letterSpacing="1">
                  PARTNER
                </text>
                <text x="70" y="32" textAnchor="middle" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="16" letterSpacing="3">
  <tspan fill="#10b981">Y</tspan>
  <tspan fill="#22c55e">A</tspan>
  <tspan fill="#3b82f6">O</tspan>
  <tspan fill="#6366f1">F</tspan>
  <tspan fill="#8b5cf6">U</tspan>
  <tspan fill="#a855f7">S</tspan>
</text>
                <text x="70" y="47" textAnchor="middle" fill="#52525b" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="10" letterSpacing="1.5">
                  DISPLAY
                </text>
              </svg>
            </div>
            
            {/* Amount */}
            <p className="text-5xl font-bold text-emerald-400 mb-4">¬£{amount.toFixed(2)}</p>
            
            {/* Waiting Animation */}
            <div className="flex items-center gap-3 mb-6">
              <div className="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
              <p className="text-zinc-400 text-lg">Waiting for payment...</p>
            </div>
            
            {/* Store Name */}
            <p className="text-zinc-500 text-sm mb-8">{storeName}</p>
            
            {/* Cancel Button */}
            <button
              onClick={() => setWaitingForPayment(false)}
              className="text-zinc-500 hover:text-white transition text-sm"
            >
              ‚Üê Back to link
            </button>
          </div>
        )}

        {/* Payment Complete State */}
        {paymentComplete && (
          <div className="flex flex-col items-center justify-center py-8">
            <div className="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mb-6">
              <svg className="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <p className="text-3xl font-bold text-emerald-400 mb-2">Payment Complete!</p>
            <p className="text-zinc-400 mb-6">¬£{amount.toFixed(2)}</p>
            <button
              onClick={onClose}
              className="bg-emerald-500 hover:bg-emerald-400 text-black font-bold py-3 px-8 rounded-xl transition"
            >
              Done
            </button>
          </div>
        )}

        {/* Email Sent Success */}
        {emailSent && (
          <div className="text-center py-6">
            <div className="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <p className="text-xl font-bold text-emerald-400 mb-2">Email Sent!</p>
            <p className="text-zinc-400">Payment link sent to {email}</p>
            
            <button
              onClick={onClose}
              className="mt-6 bg-zinc-800 hover:bg-zinc-700 text-white py-3 px-8 rounded-xl font-medium transition cursor-pointer"
            >
              Done
            </button>
          </div>
        )}

        {/* Error */}
        {error && (
          <div className="bg-red-500/10 border border-red-500/30 text-red-400 rounded-xl p-3 mt-4 text-center text-sm">
            {error}
          </div>
        )}
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/Sidebar.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { ReactNode } from 'react';


// MARK: - Types & Interfaces
interface NavItem {
  id: string;
  label: string | ReactNode;
  icon: ReactNode;
  onClick?: () => void;
  show?: boolean;
}

interface SidebarProps {
  isOpen: boolean;
  isCollapsed: boolean;
  onToggleOpen: () => void;
  onToggleCollapsed: () => void;
  dashboardType?: 'vendor' | 'affiliate';
  storeName?: string;
  storeLogo?: string | null;
  walletAddress?: string | null;
  navItems: NavItem[];
  onNavClick: (id: string, onClick?: () => void) => void;
  onLogoClick: () => void;
  onSignOut: () => void;
  onTakeTour?: () => void;
  onInfoClick?: (sectionId: string) => void;
  onShowProgress?: () => void;
}


// MARK: - Component Definition
export default function Sidebar({
  isOpen,
  isCollapsed,
  onToggleOpen,
  onToggleCollapsed,
  dashboardType = 'vendor',
  storeName,
  storeLogo,
  walletAddress,
  navItems,
  onNavClick,
  onLogoClick,
  onSignOut,
  onTakeTour,
  onInfoClick,
  onShowProgress
}: SidebarProps) {

// MARK: - Main Render
  return (
    <>
      {/* Mobile Overlay */}
      {isOpen && (
        <div 
          className="lg:hidden fixed inset-0 bg-black/50 z-40" 

// MARK: - Event Handlers
          onClick={onToggleOpen} 
        />
      )}

      {/* Desktop Collapsed Tab Handle */}
      {isCollapsed && (
  <button
  id="sidebar-tab"
  onClick={onToggleCollapsed}
  className="hidden lg:flex fixed left-0 top-1/2 -translate-y-1/2 z-50 w-6 h-24 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 border-l-0 rounded-r-lg items-center justify-center transition-colors animate-pulse"
  title="Open menu"
>
    <svg 
      className="w-4 h-4 text-zinc-400" 
      fill="none" 
      stroke="currentColor" 
      viewBox="0 0 24 24"
    >
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
    </svg>
  </button>
)}

      {/* Sidebar */}
      <aside
  className={`
    fixed left-0 w-64 bg-zinc-900 lg:bg-zinc-900/90 border-r border-zinc-800 z-[60]
    transform transition-transform duration-300 ease-in-out
    top-14 h-[calc(100vh-3.5rem)] lg:rounded-tr-2xl lg:rounded-br-2xl
    flex flex-col
    ${isOpen ? 'translate-x-0' : '-translate-x-full'}
    ${!isCollapsed ? 'lg:translate-x-0' : 'lg:-translate-x-full'}
  `}
>
        {/* Close button (desktop only when expanded) */}
        <button
          onClick={onToggleCollapsed}
          className="hidden lg:flex absolute top-4 right-4 w-8 h-8 items-center justify-center text-zinc-500 hover:text-white hover:bg-zinc-800 rounded-lg transition"
          title="Collapse menu"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        {/* Store Info Header */}
<div className="p-6 landscape:p-2 landscape:pt-4 border-b border-zinc-800 flex-shrink-0">
          <div className="flex items-center gap-3 mb-2">
            <button
onClick={onLogoClick}
className={`relative w-10 h-10 landscape:w-7 landscape:h-7 rounded-lg overflow-hidden transition flex-shrink-0 cursor-pointer ${
                storeLogo ? 'hover:opacity-80' : 'border border-zinc-700 hover:border-emerald-500'
              }`}
              title={dashboardType === 'affiliate' ? 'Member logo' : 'Partner logo'}
            >
              {storeLogo ? (
                <img src={storeLogo} alt="Logo" className="w-full h-full object-cover" />
              ) : (
                <div className="w-full h-full bg-zinc-800 flex items-center justify-center">
                  <svg className="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                  </svg>
                </div>
              )}
            </button>
          </div>
          <p className="font-medium text-zinc-300 truncate landscape:text-sm">
            {storeName || 'Get Started'}
          </p>
          {walletAddress && (
            <p className="text-zinc-500 text-xs font-mono mt-1">
              {walletAddress.substring(0, 8)}...{walletAddress.slice(-6)}
            </p>
          )}
        </div>

        {/* Navigation - scrollable area */}
        <nav className="flex-1 p-4 landscape:p-2 space-y-1 overflow-y-auto bg-gradient-to-b from-transparent to-zinc-900/20">
          {navItems
            .filter(item => item.show !== false)
            .map((item) => (
              <div key={item.id} className="flex items-center group">
                <button
  onClick={() => onNavClick(item.id, item.onClick)}
  className={`flex-1 flex items-center gap-3 px-3 py-2 landscape:py-1.5 text-left text-zinc-400 hover:bg-zinc-800 rounded-lg transition ${
    dashboardType === 'vendor' 
  ? 'hover:text-emerald-400' 
  : 'hover:text-lime-400'
  }`}
>
                  <span className="text-zinc-500">{item.icon}</span>
                  <span className="text-sm">{item.label}</span>
                </button>
                {onInfoClick && (
                  <button
  onClick={(e) => {
    e.stopPropagation();
    onInfoClick(item.id);
  }}
  className={`p-1.5 transition-all opacity-100 lg:opacity-0 lg:group-hover:opacity-100 ${
  dashboardType === 'vendor' 
  ? 'text-zinc-500 hover:text-emerald-400' 
  : 'text-zinc-500 hover:text-lime-400'
}`}
  title="Learn more"
>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
                      <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                  </button>
                )}
              </div>
            ))}
        </nav>

        {/* Footer - fixed at bottom */}
<div className="flex-shrink-0 p-4 landscape:p-2 border-t border-zinc-800 bg-zinc-900 lg:bg-transparent relative">
  {/* Guernsey Flag Video Background - desktop only */}
  <div className="hidden lg:block absolute inset-0 z-0 pointer-events-none">
    <video
  autoPlay
  loop
  muted
  playsInline
  className="w-full h-full object-cover"
  ref={(el) => { if (el) el.playbackRate = 0.2; }}
>
      <source src="/guernsey-flag.webm" type="video/webm" />
    </video>
    <div className="absolute inset-0 bg-gradient-to-b from-zinc-900/90 via-zinc-900/85 to-zinc-900/95" style={{ mixBlendMode: 'multiply' }}></div>
  </div>
  <div className="relative z-10 space-y-1">
          {/* Show Progress Button */}
          {onShowProgress && (
            <button
              onClick={onShowProgress}
              className="w-full flex items-center gap-3 px-3 py-2 landscape:py-1.5 text-zinc-400 hover:text-sky-400 hover:bg-zinc-800 rounded-lg transition"
            >
              <svg className="w-5 h-5 landscape:w-4 landscape:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              <span className="text-sm">Show Progress</span>
            </button>
          )}

          {/* Take Tour Button */}
          {onTakeTour && (
            <button
              onClick={onTakeTour}
              className="w-full flex items-center gap-3 px-3 py-2 landscape:py-1.5 text-zinc-400 hover:text-emerald-400 hover:bg-zinc-800 rounded-lg transition"
            >
              <svg className="w-5 h-5 landscape:w-4 landscape:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
              <span className="text-sm">Take Tour</span>
            </button>
          )}

          {/* YAOFU Badge - desktop only */}
          <div className="hidden lg:flex mt-3 mb-3 justify-center">
            <svg viewBox="0 0 140 58" className="w-28 h-auto">
              <defs>
                <linearGradient id="yaofuGradientSidebar" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stopColor="#10b981" />
                  <stop offset="40%" stopColor="#3b82f6" />
                  <stop offset="100%" stopColor="#8b5cf6" />
                </linearGradient>
              </defs>
              <text x="70" y="12" textAnchor="middle" fill="#52525b" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="500" fontSize="9" letterSpacing="1">
                {dashboardType === 'affiliate' ? 'AFFILIATE' : 'PARTNER'}
              </text>
              <text x="70" y="32" textAnchor="middle" fill="url(#yaofuGradientSidebar)" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="800" fontSize="18" letterSpacing="4">
                YAOFUS
              </text>
              <text x="70" y="50" textAnchor="middle" fill="#52525b" fontFamily="system-ui, -apple-system, sans-serif" fontWeight="600" fontSize="10" letterSpacing="2">
                DASHBOARD
              </text>
            </svg>
          </div>

          {/* Sign Out */}
          <button
            onClick={onSignOut}
            className="w-full flex items-center gap-3 px-3 py-2 landscape:py-1.5 text-zinc-400 hover:text-red-400 hover:bg-zinc-800 rounded-lg transition"
          >
            <svg className="w-5 h-5 landscape:w-4 landscape:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            <span className="text-sm">Sign out</span>
          </button>
  </div>
</div>
      </aside>
    </>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SignUpCustomerCard.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';


// MARK: - Types & Interfaces
interface SignUpCustomerCardProps {
  storeId: string;
  walletAddress: string | null;
  onSignUp: () => void;
}


// MARK: - Component Definition
export default function SignUpCustomerCard({ storeId, walletAddress, onSignUp }: SignUpCustomerCardProps) {

// MARK: - State Management
  const [stats, setStats] = useState({ total: 0, hasPayouts: false });
  const [loading, setLoading] = useState(true);
  const [copied, setCopied] = useState(false);

  const affiliateLink = `https://yesallofus.com/affiliate-dashboard?store=${storeId}`;


// MARK: - Hooks & Effects
  useEffect(() => {

// MARK: - API Calls & Data Fetching
    const fetchStats = async () => {
      if (!storeId || !walletAddress) return;
      
      try {
        const res = await fetch(`${API_URL}/store/${storeId}/affiliate-count?wallet_address=${walletAddress}`);
        const data = await res.json();
        
        if (data.success) {
          setStats({
            total: data.affiliates_count || 0,
            hasPayouts: data.has_payouts || false
          });
        }
      } catch (err) {
        console.error('Failed to fetch stats:', err);
      }
      setLoading(false);
    };

    fetchStats();
  }, [storeId, walletAddress]);

  const copyLink = () => {
    navigator.clipboard.writeText(affiliateLink);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };


// MARK: - Main Render
  return (
    <div id="signup-customer" className="bg-gradient-to-br from-zinc-900 to-zinc-800 border border-zinc-700 rounded-xl p-6 h-full flex flex-col">
      <button

// MARK: - Event Handlers
        onClick={onSignUp}
        className="w-full bg-zinc-800 hover:bg-zinc-700 border border-zinc-600 text-white font-semibold text-lg py-4 rounded-xl transition flex items-center justify-center gap-3"
      >
        {/* User Plus Icon */}
        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
        </svg>
        Sign Up New Customer
      </button>
      
      <p className="text-zinc-500 text-sm text-center mt-3">Register customers with NFC card to earn rewards</p>

      {/* Stats Row */}
      <div className="mt-4 pt-4 border-t border-zinc-700/50 grid grid-cols-3 gap-3">
        {/* Total Customers */}
        <div className="text-center">
          <div className="flex items-center justify-center mb-1">
            <svg className="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
            </svg>
          </div>
          <p className="text-lg font-bold text-white">
            {loading ? '‚Äî' : stats.total}
          </p>
          <p className="text-zinc-500 text-xs">Total</p>
        </div>

        {/* Active Status */}
        <div className="text-center">
          <div className="flex items-center justify-center mb-1">
            <svg className="w-4 h-4 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
            </svg>
          </div>
          <p className="text-lg font-bold text-white">
            {loading ? '‚Äî' : (stats.hasPayouts ? 'Yes' : 'No')}
          </p>
          <p className="text-zinc-500 text-xs">Payouts</p>
        </div>

        {/* Rewards Icon */}
        <div className="text-center">
          <div className="flex items-center justify-center mb-1">
            <svg className="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M21 11.25v8.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5v-8.25M12 4.875A2.625 2.625 0 1 0 9.375 7.5H12m0-2.625V7.5m0-2.625A2.625 2.625 0 1 1 14.625 7.5H12m0 0V21m-8.625-9.75h18c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125h-18c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
            </svg>
          </div>
          <p className="text-lg font-bold text-white">
            {loading ? '‚Äî' : (stats.total > 0 ? 'Active' : 'Ready')}
          </p>
          <p className="text-zinc-500 text-xs">Rewards</p>
        </div>
      </div>

      {/* Affiliate Link */}
      <div className="mt-4 pt-4 border-t border-zinc-700/50">
        <p className="text-zinc-500 text-xs mb-2">Affiliate Link</p>
        <div className="flex items-center gap-2">
          <code className="flex-1 bg-zinc-800 px-3 py-2 rounded-lg font-mono text-xs text-emerald-400 truncate">
            {affiliateLink}
          </code>
          <button
            onClick={copyLink}
            className={`px-3 py-2 rounded-lg text-xs font-medium transition ${
              copied 
                ? 'bg-emerald-500 text-black' 
                : 'bg-zinc-700 hover:bg-zinc-600 text-white'
            }`}
          >
            {copied ? '‚úì' : 'Copy'}
          </button>
        </div>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundBroadcast.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';
import { broadcastToken, initSoundPayment } from '@/utils/soundPayment';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface SoundBroadcastProps {
  paymentId: string;
  storeId: string;
  apiSecret: string;
  amount: number;
  onSuccess?: () => void;
  onError?: (error: string) => void;
}


// MARK: - Component Definition
export default function SoundBroadcast({
  paymentId,
  storeId,
  apiSecret,
  amount,
  onSuccess,
  onError
}: SoundBroadcastProps) {

// MARK: - State Management
  const [broadcasting, setBroadcasting] = useState(false);
  const [status, setStatus] = useState<'idle' | 'broadcasting' | 'sent'>('idle');


// MARK: - Event Handlers
  const handleBroadcast = async () => {
    try {
      setBroadcasting(true);
      setStatus('broadcasting');

      // Initialize sound system
      await initSoundPayment();

      // Get token from backend
      const res = await fetch(`${API_URL}/sound-payment/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ payment_id: paymentId, store_id: storeId, api_secret: apiSecret })
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to get token');
      }

      // Broadcast the token
      await broadcastToken(data.token);

      setStatus('sent');
      onSuccess?.();

      // Reset after 3 seconds
      setTimeout(() => setStatus('idle'), 3000);

    } catch (error) {
      console.error('Broadcast error:', error);
      setStatus('idle');
      onError?.(String(error));
    } finally {
      setBroadcasting(false);
    }
  };


// MARK: - Main Render
  return (
    <button
      onClick={handleBroadcast}
      disabled={broadcasting}
      className={`w-full rounded-2xl p-6 transition-all ${
        status === 'sent'
          ? 'bg-emerald-500/20 border-2 border-emerald-500'
          : status === 'broadcasting'
          ? 'bg-blue-500/20 border-2 border-blue-500 animate-pulse'
          : 'bg-zinc-900 border-2 border-zinc-800 hover:border-zinc-700'
      }`}
    >
      <div className="flex flex-col items-center">
        <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-3 ${
          status === 'sent'
            ? 'bg-emerald-500/20'
            : status === 'broadcasting'
            ? 'bg-blue-500/20'
            : 'bg-zinc-800'
        }`}>
          {status === 'sent' ? (
            <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          ) : (
            <svg className={`w-8 h-8 ${status === 'broadcasting' ? 'text-blue-400' : 'text-zinc-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 012.828-2.828" />
            </svg>
          )}
        </div>
        <p className="text-lg font-semibold mb-1">
          {status === 'sent' ? 'Sent!' : status === 'broadcasting' ? 'Broadcasting...' : 'Broadcast Payment'}
        </p>
        <p className="text-zinc-500 text-sm">
          {status === 'sent' ? 'Waiting for customer' : `¬£${amount.toFixed(2)} via sound`}
        </p>
      </div>
    </button>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundListen.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, useCallback } from 'react';
import dynamic from 'next/dynamic';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface PaymentDetails {
  payment_id: string;
  store_id: string;
  store_name: string;
  store_logo: string | null;
  amount: number;
  currency: string;
  vendor_wallet: string;
}

interface SoundListenProps {
  onPaymentReceived: (payment: PaymentDetails, token: string) => void;
  onError?: (error: string) => void;
  autoStart?: boolean;
}

// Sound utilities - loaded dynamically
let soundUtils: any = null;

async function loadSoundUtils() {
  if (soundUtils) return soundUtils;
  if (typeof window === 'undefined') return null;
  soundUtils = await import('@/utils/soundPayment');
  return soundUtils;
}


// MARK: - Component Definition
export default function SoundListen({
  onPaymentReceived,
  onError,
  autoStart = false
}: SoundListenProps) {

// MARK: - State Management
  const [listening, setListening] = useState(false);
  const [status, setStatus] = useState<'idle' | 'listening' | 'received'>('idle');
  const [stopFn, setStopFn] = useState<(() => void) | null>(null);
  const [supported, setSupported] = useState(true);

  // Check support on mount

// MARK: - Hooks & Effects
  useEffect(() => {
    loadSoundUtils().then(utils => {
      if (utils && !utils.isSupported()) {
        setSupported(false);
      }
    });
  }, []);


// MARK: - Event Handlers
  const handleTokenReceived = useCallback(async (token: string) => {
    try {
      setStatus('received');
      
      // Redeem token to get payment details
      const res = await fetch(`${API_URL}/sound-payment/redeem/${token}`);
      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || 'Failed to redeem token');
      }

      // Pass payment details to parent
      onPaymentReceived(data, token);

    } catch (error) {
      console.error('Token redeem error:', error);
      onError?.(String(error));
      setStatus('listening');
    }
  }, [onPaymentReceived, onError]);

  const startListen = async () => {
    try {
      const utils = await loadSoundUtils();
      if (!utils) {
        onError?.('Sound payment not available');
        return;
      }

      setListening(true);
      setStatus('listening');

      // Initialize sound system
      await utils.initSoundPayment();

      // Start listening
      const stop = await utils.startListening(
        handleTokenReceived,
        (error: string) => {
          onError?.(error);
          setStatus('idle');
          setListening(false);
        }
      );

      setStopFn(() => stop);

    } catch (error) {
      console.error('Listen error:', error);
      setStatus('idle');
      setListening(false);
      onError?.(String(error));
    }
  };

  const stopListen = () => {
    if (stopFn) {
      stopFn();
      setStopFn(null);
    }
    setListening(false);
    setStatus('idle');
  };

  // Auto-start if enabled
  useEffect(() => {
    if (autoStart && supported) {
      startListen();
    }
    return () => {
      loadSoundUtils().then(utils => {
        if (utils) utils.cleanup();
      });
      if (stopFn) stopFn();
    };
  }, [autoStart, supported]);

  if (!supported) {
    return null; // Don't show if not supported
  }


// MARK: - Main Render
  return (
    <button
      onClick={listening ? stopListen : startListen}
      className={`w-full rounded-2xl p-6 transition-all ${
        status === 'received'
          ? 'bg-emerald-500/20 border-2 border-emerald-500'
          : status === 'listening'
          ? 'bg-purple-500/20 border-2 border-purple-500 animate-pulse'
          : 'bg-zinc-900 border-2 border-zinc-800 hover:border-zinc-700'
      }`}
    >
      <div className="flex flex-col items-center">
        <div className={`w-16 h-16 rounded-full flex items-center justify-center mb-3 ${
          status === 'received'
            ? 'bg-emerald-500/20'
            : status === 'listening'
            ? 'bg-purple-500/20'
            : 'bg-zinc-800'
        }`}>
          {status === 'received' ? (
            <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          ) : (
            <svg className={`w-8 h-8 ${status === 'listening' ? 'text-purple-400' : 'text-zinc-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          )}
        </div>
        <p className="text-lg font-semibold mb-1">
          {status === 'received' ? 'Payment Found!' : status === 'listening' ? 'Listening...' : 'Listen for Payment'}
        </p>
        <p className="text-zinc-500 text-sm">
          {status === 'listening' ? 'Tap again to stop' : 'Receive payment via sound'}
        </p>
      </div>
    </button>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPay copy.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Types & Interfaces
interface SoundPayProps {
  paymentId: string;
  amount: number;
  storeName: string;
  onSuccess?: (txHash: string) => void;
  onError?: (error: string) => void;
}

let soundUtils: any = null;

async function loadSoundUtils() {
  if (soundUtils) return soundUtils;
  if (typeof window === 'undefined') return null;
  soundUtils = await import('@/utils/soundPayment');
  return soundUtils;
}


// MARK: - Component Definition
export default function SoundPay({
  paymentId,
  amount,
  storeName,
  onSuccess,
  onError
}: SoundPayProps) {
  const [status, setStatus] = useState<'idle' | 'active' | 'success' | 'error'>('idle');
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

// MARK: - State Management
  const [attempt, setAttempt] = useState(0);


// MARK: - Event Handlers
  const handleSend = async () => {
    if (status === 'active') return;
    
    try {
      setStatus('active');
      setErrorMsg(null);
      setAttempt(0);

      const utils = await loadSoundUtils();
      if (!utils) throw new Error('Sound not available');

      await utils.initSoundPayment();
      await utils.warmupAudio();
      
      const shortToken = paymentId.slice(-4).toUpperCase();
      
      // Retry settings: each attempt is more robust
      const attempts = [
        { volume: 0.4, toneDuration: 0.05, silenceDuration: 0.02 },
        { volume: 0.7, toneDuration: 0.08, silenceDuration: 0.03 },
        { volume: 1.0, toneDuration: 0.12, silenceDuration: 0.04 },
      ];
      
      let paid = false;
      
      for (let i = 0; i < attempts.length && !paid; i++) {
        const settings = attempts[i];
        setAttempt(i + 1);
        console.log(`üîä SoundPay: Attempt ${i + 1}/${attempts.length}:`, shortToken, settings);
        
        await utils.broadcastToken(shortToken, settings);
        
        const pollDuration = 9000;
        const pollStart = Date.now();
        
        while (Date.now() - pollStart < pollDuration && !paid) {
          try {
            const res = await fetch(`https://api.dltpays.com/nfc/api/v1/payment-link/${paymentId}`);
            const data = await res.json();
            
            if (data.payment?.status === 'paid') {
              paid = true;
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              onSuccess?.(data.payment.tx_hash);
              setTimeout(() => setStatus('idle'), 3000);
              return;
            }
          } catch (e) {
            console.warn('Poll error:', e);
          }
          await new Promise(r => setTimeout(r, 500));
        }
      }
      
      if (!paid) {
        setErrorMsg('Sound payment unavailable');
        setStatus('error');
        onError?.('Sound payment failed after 3 attempts');
      }

    } catch (error: any) {
      console.error('Send error:', error);
      setErrorMsg(error.message || 'Failed to send');
      setStatus('error');
      onError?.(error.message || 'Failed to send');
    }
  };

  const handleAction = () => {
    if (status === 'error') {
      setStatus('idle');
      setErrorMsg(null);
      return;
    }
    handleSend();
  };


// MARK: - Main Render
  return (
    <div className="bg-zinc-900 rounded-3xl p-6 border border-zinc-800">
      {/* Header with Icon */}
      <div className="text-center mb-6">
        <div className="inline-flex items-center justify-center w-14 h-14 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 mb-3">
          <svg className="w-7 h-7 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M9 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <h3 className="text-lg font-semibold text-white">SoundPay</h3>
        <p className="text-zinc-400 text-sm mt-1">Send payment via sound</p>
      </div>

      {/* Volume Reminder */}
      <div className="flex items-center justify-center gap-2 mb-4 px-4 py-3 rounded-xl bg-blue-500/10 text-blue-300">
        <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072M12 6v12m0-12l-4 4m4-4l4 4" />
        </svg>
        <span className="text-sm font-medium">Turn volume up</span>
      </div>

      {/* Main Action Button */}
      <button
        onClick={handleAction}
        disabled={status === 'active'}
        className={`w-full aspect-square max-h-44 rounded-3xl transition-all flex flex-col items-center justify-center gap-3 ${
          status === 'success'
            ? 'bg-emerald-500/20 border-2 border-emerald-500'
            : status === 'error'
            ? 'bg-red-500/20 border-2 border-red-500'
            : status === 'active'
            ? 'bg-blue-500/10 border-2 border-blue-500'
            : 'bg-zinc-800 border-2 border-zinc-700 active:scale-95'
        }`}
      >
        {status === 'success' ? (
          <>
            <div className="w-14 h-14 rounded-full bg-emerald-500/20 flex items-center justify-center">
              <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <span className="text-lg font-semibold text-emerald-400">Paid!</span>
          </>
        ) : status === 'error' ? (
          <>
            <div className="w-14 h-14 rounded-full bg-red-500/20 flex items-center justify-center">
              <svg className="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <span className="text-base font-semibold text-red-400">{errorMsg || 'Failed'}</span>
            <span className="text-xs text-zinc-500">Tap to retry</span>
          </>
        ) : status === 'active' ? (
          <>
            {/* Animated sound waves */}
            <div className="relative w-16 h-16 flex items-center justify-center">
              <div className="absolute inset-0 rounded-full bg-blue-500/20 animate-ping" />
              <div className="absolute inset-2 rounded-full bg-blue-500/30 animate-pulse" />
              <div className="relative w-10 h-10 rounded-full bg-blue-500/40 flex items-center justify-center">
                <svg className="w-5 h-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                </svg>
              </div>
            </div>
            <span className="text-base font-medium text-blue-400">
              {attempt === 1 ? 'Sending...' 
                : attempt === 2 ? 'Trying again...'
                : attempt === 3 ? 'One more try...'
                : 'Sending...'}
            </span>
            <span className="text-xs text-zinc-500">Keep devices close</span>
          </>
        ) : (
          <>
            <div className="w-14 h-14 rounded-full bg-blue-500/20 flex items-center justify-center">
              <svg className="w-7 h-7 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
              </svg>
            </div>
            <span className="text-lg font-semibold text-white">Send</span>
          </>
        )}
      </button>

      {/* Payment Info */}
      <div className="mt-5 pt-4 border-t border-zinc-800 text-center">
        <p className="text-zinc-500 text-sm">{storeName}</p>
        <p className="text-xl font-bold text-white mt-1">¬£{amount.toFixed(2)}</p>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPay.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';
import MoveCloserAnimation from '@/components/MoveCloserAnimation';


// MARK: - Types & Interfaces
interface SoundPaymentProps {
  paymentId: string;
  amount: number;
  storeName: string;
  tipAmount?: number;
  onSuccess?: (txHash: string) => void;
  onError?: (error: string) => void;
}

let soundUtils: any = null;

async function loadSoundUtils() {
  if (soundUtils) return soundUtils;
  if (typeof window === 'undefined') return null;
  soundUtils = await import('@/utils/soundPayment');
  return soundUtils;
}


// MARK: - Component Definition
export default function SoundPayment({
  paymentId,
  amount,
  storeName,
  tipAmount = 0,
  onSuccess,
  onError
}: SoundPaymentProps) {
  const router = useRouter();
  const [mode, setMode] = useState<'send' | 'receive'>('send');
  const [status, setStatus] = useState<'idle' | 'active' | 'processing' | 'success' | 'error'>('idle');
  const [stopFn, setStopFn] = useState<(() => void) | null>(null);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

// MARK: - State Management
  const [attempt, setAttempt] = useState(0);
  const [listenState, setListenState] = useState<'idle' | 'ready' | 'sync' | 'receiving'>('idle');
  const [receivedChars, setReceivedChars] = useState('');
  const [isRegistered, setIsRegistered] = useState(true);

  // Registration check removed - Web3Auth login handles this in handleReceive

  // Generate HMAC signature (for customer response)
  const generateSignature = async (paymentId: string, soundId: string, timestamp: string, secretKey: string): Promise<string> => {
    const encoder = new TextEncoder();
    const data = encoder.encode(paymentId + soundId + timestamp);
    const keyData = encoder.encode(secretKey);
    
    const cryptoKey = await crypto.subtle.importKey(
      'raw',
      keyData,
      { name: 'HMAC', hash: 'SHA-256' },
      false,
      ['sign']
    );
    
    const signature = await crypto.subtle.sign('HMAC', cryptoKey, data);
    return Array.from(new Uint8Array(signature))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  };

  // SEND (POS) - Broadcast payment ID with auto-retry

// MARK: - Event Handlers
  const handleSend = async () => {
    try {
      setStatus('active');
      setErrorMsg(null);

      // Save customer tip before processing
      if (tipAmount > 0) {
        try {
          await fetch(`https://api.dltpays.com/nfc/api/v1/payment-link/${paymentId}/tip`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tip_amount: tipAmount })
          });
          console.log(`üí∞ Tip saved: ¬£${tipAmount}`);
        } catch (tipErr) {
          console.warn('Could not save tip:', tipErr);
        }
      }

      const utils = await loadSoundUtils();
      if (!utils) throw new Error('Sound not available');

      await utils.initSoundPayment();
      await utils.warmupAudio();
      
      const shortToken = paymentId.slice(-4).toUpperCase();
      
      // Retry settings: each attempt is more robust
      const attempts = [
  { volume: 1.0, toneDuration: 0.08, silenceDuration: 0.03 },
  { volume: 1.0, toneDuration: 0.10, silenceDuration: 0.04 },
  { volume: 1.0, toneDuration: 0.12, silenceDuration: 0.05 },
];
      
      let paid = false;
      
      for (let attempt = 0; attempt < attempts.length && !paid; attempt++) {
        const settings = attempts[attempt];
        setAttempt(attempt + 1);
        console.log(`üîä POS: Attempt ${attempt + 1}/${attempts.length}:`, shortToken, settings);
        
        await utils.broadcastToken(shortToken, settings);
        
        // Poll for 8 seconds before retrying
        const pollDuration = 8000;
        const pollStart = Date.now();
        
        while (Date.now() - pollStart < pollDuration && !paid) {
          try {
            const res = await fetch(`https://api.dltpays.com/nfc/api/v1/payment-link/${paymentId}`);
            const data = await res.json();
            
            if (data.payment?.status === 'paid') {
              paid = true;
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              onSuccess?.(data.payment.tx_hash);
              setTimeout(() => setStatus('idle'), 3000);
              return;
            }
          } catch (e) {
            console.warn('Poll error:', e);
          }
          await new Promise(r => setTimeout(r, 500));
        }
      }
      
      // All attempts failed
      if (!paid) {
        setErrorMsg('Sound payment unavailable - try Tap to Pay or QR');
        setStatus('error');
        onError?.('Sound payment failed after 3 attempts');
      }

    } catch (error: any) {
      console.error('Send error:', error);
      setErrorMsg(error.message || 'Failed to send');
      setStatus('error');
      onError?.(error.message || 'Failed to send');
    }
  };

  // RECEIVE (Customer) - Listen for payment ID, broadcast signed response
  const handleReceive = async () => {
    try {
      // Save customer tip before processing
      if (tipAmount > 0) {
        try {
          await fetch(`https://api.dltpays.com/nfc/api/v1/payment-link/${paymentId}/tip`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tip_amount: tipAmount })
          });
          console.log(`üí∞ Tip saved: ¬£${tipAmount}`);
        } catch (tipErr) {
          console.warn('Could not save tip:', tipErr);
        }
      }

      // Check if logged in, if not ‚Üí login with Web3Auth
      const { loginWithWeb3Auth } = await import('@/lib/web3auth');
      
      let wallet = safeGetItem('walletAddress');
      
      if (!wallet) {
        setStatus('processing');
        const result = await loginWithWeb3Auth();
        wallet = result?.address || safeGetItem('walletAddress');
      }
      
      if (!wallet) {
        setErrorMsg('Please login to pay');
        setStatus('error');
        return;
      }
      
      // Get sound_id from server using wallet
      const deviceRes = await fetch(`https://api.dltpays.com/nfc/api/v1/sound/device-by-wallet/${wallet}`);
      const deviceData = await deviceRes.json();
      
      if (!deviceData.success || !deviceData.sound_id) {
        setErrorMsg('Enable Tap-to-Pay in dashboard first');
        setStatus('error');
        return;
      }
      
      const soundId = deviceData.sound_id;

      const utils = await loadSoundUtils();
      if (!utils) throw new Error('Sound not available');

      if (status === 'active' && stopFn) {
        stopFn();
        setStopFn(null);
        setStatus('idle');
        return;
      }

      setStatus('active');
      setErrorMsg(null);
      await utils.initSoundPayment();
      await utils.warmupAudio();

      console.log('üîä Customer: Listening for payment request...');

      const stop = await utils.startListening(
        async (token: string) => {
          // Received short token from POS (e.g. "A9F2")
          if (token.length >= 4) {
            console.log('üîä Heard token:', token);
            stop();
            setStopFn(null);
            
            setStatus('processing');
            setListenState('idle');
            setReceivedChars('');
            
            try {
              // Call API directly - no broadcast back
              const res = await fetch(`https://api.dltpays.com/nfc/api/v1/p/${token}?sid=${soundId}`);
              const data = await res.json();
              
              if (!data.success) {
                throw new Error(data.error || 'Payment failed');
              }
              
              console.log('üîä Payment complete:', data.tx_hash);
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              onSuccess?.(data.tx_hash);
              
              setTimeout(() => setStatus('idle'), 3000);
              
            } catch (err: any) {
              console.error('üîä Payment error:', err);
              setErrorMsg(err.message || 'Payment failed');
              setStatus('error');
              onError?.(err.message || 'Payment failed');
            }
          }
        },
        (error: string) => {
          setErrorMsg(error);
          setStatus('error');
          setListenState('idle');
          onError?.(error);
        },
        (state: 'ready' | 'sync' | 'receiving', chars?: string) => {
          setListenState(state);
          if (chars) setReceivedChars(chars);
        }
      );

      setStopFn(() => stop);

    } catch (error: any) {
      console.error('Listen error:', error);
      setErrorMsg(error.message || 'Failed to listen');
      setStatus('error');
      onError?.(error.message || 'Failed to listen');
    }
  };

  const handleAction = () => {
    if (status === 'error') {
      setStatus('idle');
      setErrorMsg(null);
      return;
    }
    if (mode === 'send') handleSend();
    else handleReceive();
  };

  const switchMode = (newMode: 'send' | 'receive') => {
    if (stopFn) stopFn();
    setStopFn(null);
    setStatus('idle');
    setErrorMsg(null);
    setMode(newMode);
  };


// MARK: - Main Render
  return (
    <div className="bg-zinc-900 rounded-3xl p-6 border border-zinc-800">
      {/* Header */}
      <div className="text-center mb-6">
        <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-zinc-800 mb-3">
          <svg className="w-6 h-6 text-zinc-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 012.828-2.828" />
          </svg>
        </div>
        <h3 className="text-lg font-semibold">Sound Payment</h3>
      </div>

      {/* Mode Toggle - Large tap targets */}
      <div className="grid grid-cols-2 gap-3 mb-4">
        <button
          onClick={() => switchMode('send')}
          className={`p-4 rounded-2xl border-2 transition-all ${
            mode === 'send'
              ? 'bg-blue-500/20 border-blue-500 text-blue-400'
              : 'bg-zinc-800/50 border-zinc-700 text-zinc-400'
          }`}
        >
          <div className="flex flex-col items-center gap-2">
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
            </svg>
            <span className="text-base font-medium">Send</span>
          </div>
        </button>
        <button
          onClick={() => switchMode('receive')}
          className={`p-4 rounded-2xl border-2 transition-all ${
            mode === 'receive'
              ? 'bg-purple-500/20 border-purple-500 text-purple-400'
              : 'bg-zinc-800/50 border-zinc-700 text-zinc-400'
          }`}
        >
          <div className="flex flex-col items-center gap-2">
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <span className="text-base font-medium">Receive</span>
          </div>
        </button>
      </div>

      {/* Volume/Mic Reminder */}
      <div className={`flex items-center justify-center gap-2 mb-4 px-4 py-3 rounded-xl ${
        mode === 'send' ? 'bg-blue-500/10 text-blue-300' : 'bg-purple-500/10 text-purple-300'
      }`}>
        {mode === 'send' ? (
          <>
            <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072M12 6v12m0-12l-4 4m4-4l4 4" />
            </svg>
            <span className="text-sm font-medium">Volume up to 50% or higher</span>
          </>
        ) : (
          <>
            <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <span className="text-sm font-medium">{isRegistered ? 'Allow microphone access' : 'Enable Tap-to-Pay first'}</span>
          </>
        )}
      </div>

      {/* Description */}
      <p className="text-zinc-400 text-center mb-6 text-base">
        {mode === 'send'
          ? 'Send payment request to customer'
          : isRegistered ? 'Listen & pay instantly' : 'Set up Tap-to-Pay to use this'}
      </p>

      {/* Main Action Button */}
      <button
        onClick={handleAction}
        disabled={status === 'processing' || (mode === 'receive' && !isRegistered)}
        className={`w-full aspect-square max-h-48 rounded-3xl transition-all flex flex-col items-center justify-center gap-4 ${
          status === 'success'
            ? 'bg-emerald-500/20 border-2 border-emerald-500'
            : status === 'error'
            ? 'bg-red-500/20 border-2 border-red-500'
            : status === 'processing'
            ? 'bg-amber-500/10 border-2 border-amber-500'
            : status === 'active'
            ? mode === 'send'
              ? 'bg-blue-500/10 border-2 border-blue-500'
              : 'bg-purple-500/10 border-2 border-purple-500'
            : (mode === 'receive' && !isRegistered)
            ? 'bg-zinc-800/50 border-2 border-zinc-700 cursor-not-allowed'
            : 'bg-zinc-800 border-2 border-zinc-700 active:scale-95'
        }`}
      >
        {status === 'success' ? (
          <>
            <div className="w-16 h-16 rounded-full bg-emerald-500/20 flex items-center justify-center">
              <svg className="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <span className="text-xl font-semibold text-emerald-400">
              {mode === 'send' ? 'Payment Complete!' : 'Sent!'}
            </span>
          </>
        ) : status === 'error' ? (
          <>
            <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
              <svg className="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <span className="text-lg font-semibold text-red-400">{errorMsg || 'Error'}</span>
            <span className="text-sm text-zinc-500">Tap to retry</span>
          </>
        ) : status === 'processing' ? (
          <>
            <div className="relative w-20 h-20 flex items-center justify-center">
              <div className="absolute inset-0 rounded-full bg-amber-500/20 animate-pulse" />
              <div className="relative w-12 h-12 rounded-full bg-amber-500/40 flex items-center justify-center">
                <svg className="w-6 h-6 text-amber-300 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
            </div>
            <span className="text-lg font-medium text-amber-400">
              {mode === 'send' ? 'Processing Payment...' : 'Sending...'}
            </span>
          </>
        ) : status === 'active' ? (
          <>
            {/* Animated sound waves */}
            <div className="relative w-20 h-20 flex items-center justify-center">
              <div className={`absolute inset-0 rounded-full ${mode === 'send' ? 'bg-blue-500/20' : 'bg-purple-500/20'} animate-ping`} />
              <div className={`absolute inset-2 rounded-full ${mode === 'send' ? 'bg-blue-500/30' : 'bg-purple-500/30'} animate-pulse`} />
              <div className={`relative w-12 h-12 rounded-full ${mode === 'send' ? 'bg-blue-500/40' : 'bg-purple-500/40'} flex items-center justify-center`}>
                {mode === 'send' ? (
                  <svg className="w-6 h-6 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                  </svg>
                ) : (
                  <svg className="w-6 h-6 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                  </svg>
                )}
              </div>
            </div>
           <span className={`text-lg font-medium ${mode === 'send' ? 'text-blue-400' : 'text-purple-400'}`}>
              {mode === 'send' 
                ? attempt === 1 ? 'Sending payment...' 
                  : attempt === 2 ? 'Trying again...'
                  : attempt === 3 ? 'One more try...'
                  : 'Sending...'
                : listenState === 'ready' ? 'Ready - listening...'
                  : listenState === 'sync' ? 'Heard signal...'
                  : listenState === 'receiving' ? `Receiving ${receivedChars}...`
                  : 'Starting...'}
            </span>
            <span className="text-sm text-zinc-500">Tap to cancel</span>
          </>
        ) : (
          <>
            <div className={`w-16 h-16 rounded-full ${mode === 'send' ? 'bg-blue-500/20' : 'bg-purple-500/20'} flex items-center justify-center`}>
              {mode === 'send' ? (
                <svg className="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                </svg>
              ) : (
                <svg className={`w-8 h-8 ${isRegistered ? 'text-purple-400' : 'text-zinc-600'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
              )}
            </div>
            <span className={`text-xl font-semibold ${(mode === 'receive' && !isRegistered) ? 'text-zinc-600' : 'text-white'}`}>
              {mode === 'send' ? 'Tap to Send' : isRegistered ? 'Tap to Listen' : 'Not Available'}
            </span>
          </>
        )}
      </button>

      {/* Move Closer Animation - shows when receiving and active */}
      {mode === 'receive' && status === 'active' && (
        <MoveCloserAnimation className="mt-6" />
      )}

      {/* Payment Info */}
      <div className="mt-6 pt-4 border-t border-zinc-800 text-center">
        <p className="text-zinc-400 text-sm">{storeName}</p>
        <p className="text-2xl font-bold text-white mt-1">¬£{amount.toFixed(2)}</p>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPayButton.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface SoundPayButtonProps {
  /** Store ID */
  storeId: string;
  /** Store name for receipt */
  storeName: string;
  /** Vendor wallet address */
  vendorWallet: string;
  /** Payment amount in GBP */
  amount: number;
  /** Optional tip amount in GBP */
  tipAmount?: number;
  /** Optional cart items for receipt */
  items?: Array<{ name: string; quantity: number; unit_price: number; emoji?: string }>;
  /** Callback when payment link is created - triggers state change */
  onPaymentCreated?: (paymentId: string) => void;
  /** Callback on error */
  onError?: (error: string) => void;
  /** Button size - number (px), string (Tailwind class), or preset */
  size?: number | string | 'sm' | 'md' | 'lg' | 'xl' | 'full';
  /** Custom class name */
  className?: string;
  /** Disable the button */
  disabled?: boolean;
}

type Status = 'idle' | 'creating' | 'error';


// MARK: - Component Definition
export default function SoundPayButton({
  storeId,
  storeName,
  vendorWallet,
  amount,
  tipAmount = 0,
  items,
  onPaymentCreated,
  onError,
  size = 'md',
  className = '',
  disabled = false,
}: SoundPayButtonProps) {
  const [status, setStatus] = useState<Status>('idle');

  // Determine size classes

// MARK: - API Calls & Data Fetching
  const getSizeStyle = (): { style: React.CSSProperties; className: string } => {
    if (typeof size === 'number') {
      return { style: { width: size, height: size }, className: '' };
    }
    switch (size) {
      case 'sm':
        return { style: {}, className: 'w-16 h-16' };
      case 'md':
        return { style: {}, className: 'w-24 h-24' };
      case 'lg':
        return { style: {}, className: 'w-32 h-32' };
      case 'xl':
        return { style: {}, className: 'w-40 h-40' };
      case 'full':
        return { style: {}, className: 'w-full h-14' };
      default:
        return { style: {}, className: size };
    }
  };

  const sizeConfig = getSizeStyle();
  const isFullWidth = size === 'full' || (typeof size === 'string' && size.includes('w-full'));


// MARK: - Event Handlers
  const handleClick = async () => {
    if (status === 'creating' || disabled) return;

    try {
      setStatus('creating');

      // 1. Create payment link
      const totalAmount = amount + tipAmount;
      const paymentItems = items 
        ? [
            ...items.map(item => ({
              name: item.name,
              quantity: item.quantity,
              unit_price: item.unit_price,
              line_total: item.unit_price * item.quantity
            })),
            ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
          ]
        : [
            { name: 'Payment', quantity: 1, unit_price: amount, line_total: amount },
            ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
          ];

      const linkRes = await fetch(`${API_URL}/payment-link/create`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    store_id: storeId,
    store_name: storeName,
    vendor_wallet: vendorWallet,
    amount: totalAmount,
    tip: tipAmount,
    items: paymentItems,
    payment_type: 'soundpay',
  }),
});
      
      const linkData = await linkRes.json();
      if (!linkData.success || !linkData.payment_id) {
        throw new Error(linkData.error || 'Failed to create payment');
      }

      const paymentId = linkData.payment_id;
      console.log('üîä SoundPay: Created payment', paymentId);

      // 2. Update display to soundpay status
      const displayCart = items ? items.map(item => ({
        name: item.name,
        quantity: item.quantity,
        price: item.unit_price,
        emoji: item.emoji || 'üì¶'
      })) : [];

      try {
        await fetch(`${API_URL}/display/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            store_id: storeId,
            store_name: storeName,
            cart: displayCart,
            total: totalAmount,
            status: 'soundpay',
            tip: tipAmount,
            vendor_wallet: vendorWallet,
            payment_id: paymentId,
          }),
        });
      } catch (err) {
        console.error('Display update failed:', err);
        // Continue anyway - display update is non-critical
      }

      // 3. Callback with payment ID - parent handles state change
      // Only reset to idle after all operations complete
      setStatus('idle');
      onPaymentCreated?.(paymentId);

    } catch (error: any) {
      console.error('SoundPay error:', error);
      setStatus('error');
      onError?.(error.message || 'Failed to create payment');
      setTimeout(() => setStatus('idle'), 3000);
    }
  };


// MARK: - Main Render
  return (
    <button
      onClick={handleClick}
      disabled={disabled || status === 'creating'}
      style={sizeConfig.style}
      className={`
        relative overflow-hidden rounded-2xl transition-all
        ${sizeConfig.className}
        ${disabled ? 'opacity-50 cursor-not-allowed' : 'active:scale-95 cursor-pointer'}
        ${status === 'error' ? 'ring-2 ring-red-500' : ''}
        ${status === 'creating' ? 'ring-2 ring-purple-500' : ''}
        ${className}
      `}
    >
      {/* Video Background */}
      <video
        autoPlay
        loop
        muted
        playsInline
        className="absolute inset-0 w-full h-full object-cover"
      >
        <source src="/soundpay-button-bg.webm" type="video/webm" />
      </video>

      {/* Dark Overlay */}
      <div
        className={`absolute inset-0 transition-colors ${
          status === 'error'
            ? 'bg-red-900/50'
            : status === 'creating'
            ? 'bg-purple-900/40'
            : 'bg-black/30'
        }`}
      />

      {/* Content */}
      <div className={`relative z-10 flex items-center justify-center h-full ${isFullWidth ? 'flex-row gap-3' : 'flex-col'}`}>
        {status === 'error' ? (
          <>
            <svg
              className={isFullWidth ? 'w-6 h-6 text-red-400' : 'w-1/3 h-1/3 text-red-400'}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
            </svg>
            {isFullWidth && <span className="text-red-400 font-bold">Failed</span>}
          </>
        ) : status === 'creating' ? (
          <>
            {isFullWidth ? (
              <>
                <div className="w-5 h-5 border-2 border-purple-300 border-t-transparent rounded-full animate-spin" />
                <span className="text-purple-300 font-bold">Preparing...</span>
              </>
            ) : (
              <>
                <div className="w-6 h-6 border-2 border-purple-300 border-t-transparent rounded-full animate-spin" />
                <span className="text-purple-300 font-bold text-xs mt-1">Preparing</span>
              </>
            )}
          </>
        ) : (
          <>
            {isFullWidth ? (
              <>
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
                  <circle cx="12" cy="12" r="2" />
                  <path strokeLinecap="round" strokeLinejoin="round" d="M16.24 7.76a6 6 0 010 8.49M7.76 16.24a6 6 0 010-8.49M19.07 4.93a10 10 0 010 14.14M4.93 19.07a10 10 0 010-14.14" />
                </svg>
                <span className="text-white font-bold">SoundPay</span>
              </>
            ) : (
              <>
                <span className="text-white font-bold text-sm leading-tight">SoundPay</span>
                <span className="text-white/70 text-xs">Send</span>
              </>
            )}
          </>
        )}
      </div>
    </button>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPayInstructions.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { motion, AnimatePresence } from 'framer-motion';
import { useState, useEffect } from 'react';


// MARK: - Types & Interfaces
interface SoundPayInstructionsProps {
  mode?: 'send' | 'receive';
  autoPlay?: boolean;
  showSteps?: boolean;
}


// MARK: - Component Definition
export default function SoundPayInstructions({ 
  mode = 'receive', 
  autoPlay = true,
  showSteps = true 
}: SoundPayInstructionsProps) {

// MARK: - State Management
  const [currentStep, setCurrentStep] = useState(0);
  const [devicePair, setDevicePair] = useState(0);
  const totalSteps = 4;


// MARK: - Hooks & Effects
  useEffect(() => {
    if (!autoPlay) return;
    
    const interval = setInterval(() => {
      setCurrentStep((prev) => (prev + 1) % totalSteps);
    }, 3375); // Was 6750
    
    return () => clearInterval(interval);
  }, [autoPlay]);

  // Cycle device pairs when on step 3 (device compatibility)
  useEffect(() => {
    if (currentStep !== 2) return;
    
    const deviceInterval = setInterval(() => {
      setDevicePair((prev) => (prev + 1) % 3);
    }, 1125); // Was 2250
    
    return () => clearInterval(deviceInterval);
  }, [currentStep]);

  const steps = mode === 'receive' 
    ? [
        { title: 'Tap to Pay', subtitle: 'Start receiving' },
        { title: 'Position Phone', subtitle: 'Hold near sender device' },
        { title: 'Works Everywhere', subtitle: 'Any device to any device' },
        { title: 'Payment Sent', subtitle: 'Automatic when sound heard' },
      ]
    : [
        { title: 'Wait for Receiver', subtitle: 'They tap Listen first' },
        { title: 'Position Devices', subtitle: 'Hold phones close together' },
        { title: 'Works Everywhere', subtitle: 'Any device to any device' },
        { title: 'Tap Send', subtitle: 'Broadcast payment sound' },
      ];


// MARK: - Main Render
  return (
    <div className="w-full">
      {/* Animation Container */}
      <div className="relative w-full h-40 md:h-80 rounded-2xl overflow-hidden">
        
        {/* Ambient glow - subtle */}
        <div className="absolute inset-0 opacity-10">
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 md:w-64 md:h-64 bg-purple-500/20 rounded-full blur-3xl" />
        </div>

        {/* Scale wrapper for desktop/tablet */}
        <div className="absolute inset-0 md:scale-[2] md:origin-center">
          <AnimatePresence mode="wait">
            {/* Step 1: Tap to Pay / Wait for Receiver */}
            {currentStep === 0 && (
              <motion.div
                key="step1"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.25 }}
                className="absolute inset-0 flex items-center justify-center"
              >
                <div className="relative">
                  {/* Phone */}
                  <motion.div 
                    className="relative w-14 h-24 bg-zinc-800 rounded-xl border-2 border-zinc-600 shadow-2xl"
                    animate={{ y: [0, -2, 0] }}
                    transition={{ duration: 4.5, repeat: Infinity, ease: "easeInOut" }}
                  >
                    {/* Notch */}
                    <div className="absolute top-1.5 left-1/2 -translate-x-1/2 w-7 h-1 bg-zinc-700 rounded-full" />
                    
                    {/* Screen */}
                    <div className="absolute inset-1.5 top-4 bg-zinc-900 rounded-lg flex flex-col items-center justify-center gap-1">
                      {mode === 'receive' ? (
                        <>
                          {/* Mic icon */}
                          <motion.div
                            className="w-7 h-7 rounded-full bg-purple-500/20 flex items-center justify-center"
                            animate={{ scale: [1, 1.1, 1] }}
                            transition={{ duration: 3.375, repeat: Infinity }}
                          >
                            <svg className="w-3.5 h-3.5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                          </motion.div>
                          <span className="text-[7px] text-purple-300 font-medium">Pay</span>
                        </>
                      ) : (
                        <>
                          {/* Waiting indicator */}
                          <motion.div
                            className="flex gap-1"
                            animate={{ opacity: [0.3, 1, 0.3] }}
                            transition={{ duration: 3.375, repeat: Infinity }}
                          >
                            {[0, 1, 2].map((i) => (
                              <motion.div
                                key={i}
                                className="w-1 h-1 rounded-full bg-blue-400"
                                animate={{ x: [0, -3, 0] }}
                                transition={{ duration: 1.35, repeat: Infinity, delay: i * 0.3375 }}
                              />
                            ))}
                          </motion.div>
                          <span className="text-[7px] text-blue-300 font-medium">Waiting</span>
                        </>
                      )}
                    </div>
                  </motion.div>

                  {/* Tap finger */}
                  {mode === 'receive' && (
                    <motion.div
                      className="absolute -bottom-2 -right-2"
                      initial={{ scale: 0.8, opacity: 0 }}
                      animate={{ 
                        scale: [0.8, 1, 0.9, 1],
                        opacity: [0, 1, 1, 1],
                        y: [8, 0, 4, 0]
                      }}
                      transition={{ duration: 3.375, repeat: Infinity }}
                    >
                      <div className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                        <svg className="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                      </div>
                    </motion.div>
                  )}
                </div>
              </motion.div>
            )}

            {/* Step 2: Position Phones - Horizontal Layout */}
            {currentStep === 1 && (
              <motion.div
                key="step2"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.25 }}
                className="absolute inset-0 flex items-center justify-center"
              >
                {/* Horizontal - side by side */}
                <div className="relative flex items-center gap-3">
                  
                  {/* Receiver Phone */}
                  <motion.div 
                    className="relative w-10 h-[72px] bg-zinc-800 rounded-lg border-2 border-purple-500/50 shadow-lg shadow-purple-500/20 z-10"
                    animate={{ x: [0, 3, 0] }}
                    transition={{ duration: 4.5, repeat: Infinity, ease: "easeInOut" }}
                  >
                    {/* Notch */}
                    <div className="absolute top-1 left-1/2 -translate-x-1/2 w-4 h-0.5 bg-zinc-700 rounded-full" />
                    {/* Screen */}
                    <div className="absolute inset-1 top-2.5 bg-purple-500/10 rounded flex items-center justify-center">
                      <motion.div
                        className="w-4 h-4 rounded-full bg-purple-500/30 flex items-center justify-center"
                        animate={{ scale: [1, 1.2, 1] }}
                        transition={{ duration: 2.25, repeat: Infinity }}
                      >
                        <svg className="w-2 h-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                      </motion.div>
                    </div>
                    {/* Label */}
                    <div className="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[7px] text-purple-400 font-medium">
                      Receiver
                    </div>
                  </motion.div>

                  {/* Sound waves in the gap - hidden on small mobile and desktop */}
<div className="relative w-6 hidden sm:flex lg:hidden items-center justify-center">
                    {[0, 1, 2].map((i) => (
                      <motion.div
                        key={i}
                        className="absolute w-1.5 h-1.5 rounded-full border border-emerald-400"
                        initial={{ scale: 0.5, opacity: 0 }}
                        animate={{ 
                          scale: [0.5, 1.5, 2],
                          opacity: [0.8, 0.4, 0],
                          x: [-8, 0, 8]
                        }}
                        transition={{
                          duration: 2.25,
                          repeat: Infinity,
                          delay: i * 0.5625,
                          ease: "easeOut"
                        }}
                      />
                    ))}
                  </div>

                  {/* Sender Phone */}
                  <motion.div 
                    className="relative w-10 h-[72px] bg-zinc-800 rounded-lg border-2 border-blue-500/50 shadow-lg shadow-blue-500/20"
                    animate={{ x: [0, -3, 0] }}
                    transition={{ duration: 4.5, repeat: Infinity, ease: "easeInOut", delay: 1.125 }}
                  >
                    {/* Notch */}
                    <div className="absolute top-1 left-1/2 -translate-x-1/2 w-4 h-0.5 bg-zinc-700 rounded-full" />
                    {/* Screen */}
                    <div className="absolute inset-1 top-2.5 bg-blue-500/10 rounded flex items-center justify-center">
                      <motion.div
                        className="w-4 h-4 rounded-full bg-blue-500/30 flex items-center justify-center"
                        animate={{ scale: [1, 1.2, 1] }}
                        transition={{ duration: 2.25, repeat: Infinity, delay: 0.675 }}
                      >
                        <svg className="w-2 h-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                        </svg>
                      </motion.div>
                    </div>
                    {/* Label */}
                    <div className="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[7px] text-blue-400 font-medium">
                      Sender
                    </div>
                  </motion.div>
                </div>
              </motion.div>
            )}

            {/* Step 3: Different Device Combinations */}
            {currentStep === 2 && (
              <motion.div
                key="step3"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.25 }}
                className="absolute inset-0 flex items-center justify-center"
              >
                <div className="relative flex items-center gap-4">
                  {/* Receiver Device */}
                  <AnimatePresence mode="wait">
                    <motion.div
                      key={`receiver-${devicePair}`}
                      initial={{ opacity: 0, x: -10 }}
                      animate={{ opacity: 1, x: 0 }}
                      exit={{ opacity: 0, x: -10 }}
                      transition={{ duration: 0.15 }}
                      className="relative"
                    >
                      {/* Phone */}
                      {devicePair === 0 && (
                        <div className="w-8 h-14 bg-zinc-800 rounded-lg border-2 border-purple-500/50 flex items-center justify-center">
                          <div className="w-5 h-9 bg-purple-500/20 rounded flex items-center justify-center">
                            <svg className="w-3 h-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                          </div>
                        </div>
                      )}
                      {/* Tablet */}
                      {devicePair === 1 && (
                        <div className="w-12 h-16 bg-zinc-800 rounded-lg border-2 border-purple-500/50 flex items-center justify-center">
                          <div className="w-9 h-12 bg-purple-500/20 rounded flex items-center justify-center">
                            <svg className="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                          </div>
                        </div>
                      )}
                      {/* Phone again */}
                      {devicePair === 2 && (
                        <div className="w-8 h-14 bg-zinc-800 rounded-lg border-2 border-purple-500/50 flex items-center justify-center">
                          <div className="w-5 h-9 bg-purple-500/20 rounded flex items-center justify-center">
                            <svg className="w-3 h-3 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                          </div>
                        </div>
                      )}
                    </motion.div>
                  </AnimatePresence>

                  {/* Sound waves */}
                  {/* Sound waves - hidden on small mobile and desktop */}
<div className="relative w-8 hidden sm:flex lg:hidden items-center justify-center">
                    {[0, 1, 2].map((i) => (
                      <motion.div
                        key={i}
                        className="absolute w-2 h-2 rounded-full border border-emerald-400"
                        animate={{ 
                          scale: [0.5, 1.5, 2],
                          opacity: [0.8, 0.4, 0],
                          x: [0, 8, 16]
                        }}
                        transition={{
                          duration: 2.25,
                          repeat: Infinity,
                          delay: i * 0.5625,
                          ease: "easeOut"
                        }}
                      />
                    ))}
                  </div>

                  {/* Sender Device */}
                  <AnimatePresence mode="wait">
                    <motion.div
                      key={`sender-${devicePair}`}
                      initial={{ opacity: 0, x: 10 }}
                      animate={{ opacity: 1, x: 0 }}
                      exit={{ opacity: 0, x: 10 }}
                      transition={{ duration: 0.15 }}
                      className="relative"
                    >
                      {/* Laptop */}
                      {devicePair === 0 && (
                        <div className="flex flex-col items-center">
                          <div className="w-16 h-10 bg-zinc-800 rounded-t-lg border-2 border-b-0 border-blue-500/50 flex items-center justify-center">
                            <div className="w-12 h-7 bg-blue-500/20 rounded flex items-center justify-center">
                              <svg className="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                              </svg>
                            </div>
                          </div>
                          <div className="w-20 h-1.5 bg-zinc-700 rounded-b-lg border-2 border-t-0 border-blue-500/50" />
                        </div>
                      )}
                      {/* Laptop */}
                      {devicePair === 1 && (
                        <div className="flex flex-col items-center">
                          <div className="w-16 h-10 bg-zinc-800 rounded-t-lg border-2 border-b-0 border-blue-500/50 flex items-center justify-center">
                            <div className="w-12 h-7 bg-blue-500/20 rounded flex items-center justify-center">
                              <svg className="w-3 h-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                              </svg>
                            </div>
                          </div>
                          <div className="w-20 h-1.5 bg-zinc-700 rounded-b-lg border-2 border-t-0 border-blue-500/50" />
                        </div>
                      )}
                      {/* Tablet */}
                      {devicePair === 2 && (
                        <div className="w-12 h-16 bg-zinc-800 rounded-lg border-2 border-blue-500/50 flex items-center justify-center">
                          <div className="w-9 h-12 bg-blue-500/20 rounded flex items-center justify-center">
                            <svg className="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                            </svg>
                          </div>
                        </div>
                      )}
                    </motion.div>
                  </AnimatePresence>
                </div>
              </motion.div>
            )}

            {/* Step 4: Payment Complete */}
            {currentStep === 3 && (
              <motion.div
                key="step4"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -20 }}
                transition={{ duration: 0.25 }}
                className="absolute inset-0 flex items-center justify-center"
              >
                <div className="relative">
                  {/* Success burst */}
                  <motion.div
                    className="absolute inset-0 flex items-center justify-center"
                    initial={{ scale: 0 }}
                    animate={{ scale: [0, 1.5, 1] }}
                    transition={{ duration: 0.3 }}
                  >
                    <div className="w-16 h-16 rounded-full bg-emerald-500/10" />
                  </motion.div>

                  {/* Phone with success */}
                  <motion.div 
                    className="relative w-14 h-24 bg-zinc-800 rounded-xl border-2 border-emerald-500 shadow-lg shadow-emerald-500/30"
                    initial={{ scale: 0.9 }}
                    animate={{ scale: 1 }}
                    transition={{ duration: 0.675, delay: 0.45 }}
                  >
                    {/* Notch */}
                    <div className="absolute top-1.5 left-1/2 -translate-x-1/2 w-7 h-1 bg-zinc-700 rounded-full" />
                    
                    {/* Screen */}
                    <div className="absolute inset-1.5 top-4 bg-emerald-500/10 rounded-lg flex flex-col items-center justify-center gap-1">
                      {/* Checkmark */}
                      <motion.div
                        className="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center"
                        initial={{ scale: 0 }}
                        animate={{ scale: [0, 1.2, 1] }}
                        transition={{ duration: 1.125, delay: 0.675 }}
                      >
                        <motion.svg 
                          className="w-4 h-4 text-emerald-400" 
                          fill="none" 
                          stroke="currentColor" 
                          viewBox="0 0 24 24"
                        >
                          <motion.path 
                            strokeLinecap="round" 
                            strokeLinejoin="round" 
                            strokeWidth={3} 
                            d="M5 13l4 4L19 7"
                            initial={{ pathLength: 0 }}
                            animate={{ pathLength: 1 }}
                            transition={{ duration: 0.9, delay: 1.125 }}
                          />
                        </motion.svg>
                      </motion.div>
                      <motion.span 
                        className="text-[7px] text-emerald-300 font-medium"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        transition={{ delay: 1.575 }}
                      >
                        Paid!
                      </motion.span>
                    </div>
                  </motion.div>

                  {/* Confetti particles */}
                  {[...Array(6)].map((_, i) => (
                    <motion.div
                      key={i}
                      className="absolute w-1 h-1 rounded-full"
                      style={{
                        background: ['#10b981', '#8b5cf6', '#3b82f6', '#f59e0b', '#ec4899', '#06b6d4'][i],
                        left: '50%',
                        top: '50%',
                      }}
                      initial={{ x: 0, y: 0, scale: 0 }}
                      animate={{ 
                        x: [0, (i % 2 ? 1 : -1) * (20 + i * 8)],
                        y: [0, -30 - i * 4, 15],
                        scale: [0, 1, 0],
                        opacity: [0, 1, 0]
                      }}
                      transition={{ duration: 2.25, delay: 0.9 + i * 0.025 }}
                    />
                  ))}
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>

      {/* Step indicators and text */}
      {showSteps && (
        <div className="mt-3 text-center">
          {/* Dots */}
          <div className="flex items-center justify-center gap-1.5 mb-2">
            {steps.map((_, i) => (
              <button
                key={i}

// MARK: - Event Handlers
                onClick={() => setCurrentStep(i)}
                className={`h-1.5 rounded-full transition-all duration-300 ${
                  currentStep === i 
                    ? 'w-4 bg-purple-500' 
                    : 'w-1.5 bg-zinc-700 hover:bg-zinc-600'
                }`}
              />
            ))}
          </div>

          {/* Text */}
          <AnimatePresence mode="wait">
            <motion.div
              key={currentStep}
              initial={{ opacity: 0, y: 5 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -5 }}
              transition={{ duration: 0.15 }}
            >
              <h3 className="text-white font-semibold text-base md:text-lg">
  {steps[currentStep].title}
</h3>
<p className="text-zinc-500 text-sm md:text-base mt-0.5">
  {steps[currentStep].subtitle}
</p>
            </motion.div>
          </AnimatePresence>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPayment copy.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';


// MARK: - Types & Interfaces
interface SoundPaymentProps {
  paymentId: string;
  amount: number;
  storeName: string;
  onSuccess?: (txHash: string) => void;
  onError?: (error: string) => void;
}

let soundUtils: any = null;

async function loadSoundUtils() {
  if (soundUtils) return soundUtils;
  if (typeof window === 'undefined') return null;
  soundUtils = await import('@/utils/soundPayment');
  return soundUtils;
}


// MARK: - Component Definition
export default function SoundPayment({
  paymentId,
  amount,
  storeName,
  onSuccess,
  onError
}: SoundPaymentProps) {
  const router = useRouter();
  const [mode, setMode] = useState<'send' | 'receive'>('send');
  const [status, setStatus] = useState<'idle' | 'active' | 'processing' | 'success' | 'error'>('idle');
  const [stopFn, setStopFn] = useState<(() => void) | null>(null);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

// MARK: - State Management
  const [attempt, setAttempt] = useState(0);
  const [listenState, setListenState] = useState<'idle' | 'ready' | 'sync' | 'receiving'>('idle');
  const [receivedChars, setReceivedChars] = useState('');
  const [isRegistered, setIsRegistered] = useState(true);

  // Registration check removed - Web3Auth login handles this in handleReceive

  // Generate HMAC signature (for customer response)
  const generateSignature = async (paymentId: string, soundId: string, timestamp: string, secretKey: string): Promise<string> => {
    const encoder = new TextEncoder();
    const data = encoder.encode(paymentId + soundId + timestamp);
    const keyData = encoder.encode(secretKey);
    
    const cryptoKey = await crypto.subtle.importKey(
      'raw',
      keyData,
      { name: 'HMAC', hash: 'SHA-256' },
      false,
      ['sign']
    );
    
    const signature = await crypto.subtle.sign('HMAC', cryptoKey, data);
    return Array.from(new Uint8Array(signature))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  };

  // SEND (POS) - Broadcast payment ID with auto-retry

// MARK: - Event Handlers
  const handleSend = async () => {
    try {
      setStatus('active');
      setErrorMsg(null);

      const utils = await loadSoundUtils();
      if (!utils) throw new Error('Sound not available');

      await utils.initSoundPayment();
      await utils.warmupAudio();
      
      const shortToken = paymentId.slice(-4).toUpperCase();
      
      // Retry settings: each attempt is more robust
      const attempts = [
        { volume: 0.4, toneDuration: 0.05, silenceDuration: 0.02 },  // Normal
        { volume: 0.7, toneDuration: 0.08, silenceDuration: 0.03 },  // Louder + longer
        { volume: 1.0, toneDuration: 0.12, silenceDuration: 0.04 },  // Loudest + longest
      ];
      
      let paid = false;
      
      for (let attempt = 0; attempt < attempts.length && !paid; attempt++) {
        const settings = attempts[attempt];
        setAttempt(attempt + 1);
        console.log(`üîä POS: Attempt ${attempt + 1}/${attempts.length}:`, shortToken, settings);
        
        await utils.broadcastToken(shortToken, settings);
        
        // Poll for 8 seconds before retrying
        const pollDuration = 8000;
        const pollStart = Date.now();
        
        while (Date.now() - pollStart < pollDuration && !paid) {
          try {
            const res = await fetch(`https://api.dltpays.com/nfc/api/v1/payment-link/${paymentId}`);
            const data = await res.json();
            
            if (data.payment?.status === 'paid') {
              paid = true;
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              onSuccess?.(data.payment.tx_hash);
              setTimeout(() => setStatus('idle'), 3000);
              return;
            }
          } catch (e) {
            console.warn('Poll error:', e);
          }
          await new Promise(r => setTimeout(r, 500));
        }
      }
      
      // All attempts failed
      if (!paid) {
        setErrorMsg('Sound payment unavailable - try Tap to Pay or QR');
        setStatus('error');
        onError?.('Sound payment failed after 3 attempts');
      }

    } catch (error: any) {
      console.error('Send error:', error);
      setErrorMsg(error.message || 'Failed to send');
      setStatus('error');
      onError?.(error.message || 'Failed to send');
    }
  };

  // RECEIVE (Customer) - Listen for payment ID, broadcast signed response
  const handleReceive = async () => {
    try {
      // Check if logged in, if not ‚Üí login with Web3Auth
      const { loginWithWeb3Auth } = await import('@/lib/web3auth');
      
      let wallet = sessionStorage.getItem('walletAddress');
      
      if (!wallet) {
        setStatus('processing');
        const result = await loginWithWeb3Auth();
        wallet = result?.address || sessionStorage.getItem('walletAddress');
      }
      
      if (!wallet) {
        setErrorMsg('Please login to pay');
        setStatus('error');
        return;
      }
      
      // Get sound_id from server using wallet
      const deviceRes = await fetch(`https://api.dltpays.com/nfc/api/v1/sound/device-by-wallet/${wallet}`);
      const deviceData = await deviceRes.json();
      
      if (!deviceData.success || !deviceData.sound_id) {
        setErrorMsg('Enable Tap-to-Pay in dashboard first');
        setStatus('error');
        return;
      }
      
      const soundId = deviceData.sound_id;

      const utils = await loadSoundUtils();
      if (!utils) throw new Error('Sound not available');

      if (status === 'active' && stopFn) {
        stopFn();
        setStopFn(null);
        setStatus('idle');
        return;
      }

      setStatus('active');
      setErrorMsg(null);
      await utils.initSoundPayment();
      await utils.warmupAudio();

      console.log('üîä Customer: Listening for payment request...');

      const stop = await utils.startListening(
        async (token: string) => {
          // Received short token from POS (e.g. "A9F2")
          if (token.length >= 4) {
            console.log('üîä Heard token:', token);
            stop();
            setStopFn(null);
            
            setStatus('processing');
            setListenState('idle');
            setReceivedChars('');
            
            try {
              // Call API directly - no broadcast back
              const res = await fetch(`https://api.dltpays.com/nfc/api/v1/p/${token}?sid=${soundId}`);
              const data = await res.json();
              
              if (!data.success) {
                throw new Error(data.error || 'Payment failed');
              }
              
              console.log('üîä Payment complete:', data.tx_hash);
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              onSuccess?.(data.tx_hash);
              
              setTimeout(() => setStatus('idle'), 3000);
              
            } catch (err: any) {
              console.error('üîä Payment error:', err);
              setErrorMsg(err.message || 'Payment failed');
              setStatus('error');
              onError?.(err.message || 'Payment failed');
            }
          }
        },
        (error: string) => {
          setErrorMsg(error);
          setStatus('error');
          setListenState('idle');
          onError?.(error);
        },
        (state: 'ready' | 'sync' | 'receiving', chars?: string) => {
          setListenState(state);
          if (chars) setReceivedChars(chars);
        }
      );

      setStopFn(() => stop);

    } catch (error: any) {
      console.error('Listen error:', error);
      setErrorMsg(error.message || 'Failed to listen');
      setStatus('error');
      onError?.(error.message || 'Failed to listen');
    }
  };

  const handleAction = () => {
    if (status === 'error') {
      setStatus('idle');
      setErrorMsg(null);
      return;
    }
    if (mode === 'send') handleSend();
    else handleReceive();
  };

  const switchMode = (newMode: 'send' | 'receive') => {
    if (stopFn) stopFn();
    setStopFn(null);
    setStatus('idle');
    setErrorMsg(null);
    setMode(newMode);
  };


// MARK: - Main Render
  return (
    <div className="bg-zinc-900 rounded-3xl p-6 border border-zinc-800">
      {/* Header */}
      <div className="text-center mb-6">
        <div className="inline-flex items-center justify-center w-12 h-12 rounded-full bg-zinc-800 mb-3">
          <svg className="w-6 h-6 text-zinc-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 012.828-2.828" />
          </svg>
        </div>
        <h3 className="text-lg font-semibold">Sound Payment</h3>
      </div>

      {/* Mode Toggle - Large tap targets */}
      <div className="grid grid-cols-2 gap-3 mb-4">
        <button
          onClick={() => switchMode('send')}
          className={`p-4 rounded-2xl border-2 transition-all ${
            mode === 'send'
              ? 'bg-blue-500/20 border-blue-500 text-blue-400'
              : 'bg-zinc-800/50 border-zinc-700 text-zinc-400'
          }`}
        >
          <div className="flex flex-col items-center gap-2">
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
            </svg>
            <span className="text-base font-medium">Send</span>
          </div>
        </button>
        <button
          onClick={() => switchMode('receive')}
          className={`p-4 rounded-2xl border-2 transition-all ${
            mode === 'receive'
              ? 'bg-purple-500/20 border-purple-500 text-purple-400'
              : 'bg-zinc-800/50 border-zinc-700 text-zinc-400'
          }`}
        >
          <div className="flex flex-col items-center gap-2">
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <span className="text-base font-medium">Receive</span>
          </div>
        </button>
      </div>

      {/* Volume/Mic Reminder */}
      <div className={`flex items-center justify-center gap-2 mb-4 px-4 py-3 rounded-xl ${
        mode === 'send' ? 'bg-blue-500/10 text-blue-300' : 'bg-purple-500/10 text-purple-300'
      }`}>
        {mode === 'send' ? (
          <>
            <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072M12 6v12m0-12l-4 4m4-4l4 4" />
            </svg>
            <span className="text-sm font-medium">Volume up to 50% or higher</span>
          </>
        ) : (
          <>
            <svg className="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <span className="text-sm font-medium">{isRegistered ? 'Allow microphone access' : 'Enable Tap-to-Pay first'}</span>
          </>
        )}
      </div>

      {/* Description */}
      <p className="text-zinc-400 text-center mb-6 text-base">
        {mode === 'send'
          ? 'Send payment request to customer'
          : isRegistered ? 'Listen & pay instantly' : 'Set up Tap-to-Pay to use this'}
      </p>

      {/* Main Action Button */}
      <button
        onClick={handleAction}
        disabled={status === 'processing' || (mode === 'receive' && !isRegistered)}
        className={`w-full aspect-square max-h-48 rounded-3xl transition-all flex flex-col items-center justify-center gap-4 ${
          status === 'success'
            ? 'bg-emerald-500/20 border-2 border-emerald-500'
            : status === 'error'
            ? 'bg-red-500/20 border-2 border-red-500'
            : status === 'processing'
            ? 'bg-amber-500/10 border-2 border-amber-500'
            : status === 'active'
            ? mode === 'send'
              ? 'bg-blue-500/10 border-2 border-blue-500'
              : 'bg-purple-500/10 border-2 border-purple-500'
            : (mode === 'receive' && !isRegistered)
            ? 'bg-zinc-800/50 border-2 border-zinc-700 cursor-not-allowed'
            : 'bg-zinc-800 border-2 border-zinc-700 active:scale-95'
        }`}
      >
        {status === 'success' ? (
          <>
            <div className="w-16 h-16 rounded-full bg-emerald-500/20 flex items-center justify-center">
              <svg className="w-10 h-10 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <span className="text-xl font-semibold text-emerald-400">
              {mode === 'send' ? 'Payment Complete!' : 'Sent!'}
            </span>
          </>
        ) : status === 'error' ? (
          <>
            <div className="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center">
              <svg className="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <span className="text-lg font-semibold text-red-400">{errorMsg || 'Error'}</span>
            <span className="text-sm text-zinc-500">Tap to retry</span>
          </>
        ) : status === 'processing' ? (
          <>
            <div className="relative w-20 h-20 flex items-center justify-center">
              <div className="absolute inset-0 rounded-full bg-amber-500/20 animate-pulse" />
              <div className="relative w-12 h-12 rounded-full bg-amber-500/40 flex items-center justify-center">
                <svg className="w-6 h-6 text-amber-300 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
            </div>
            <span className="text-lg font-medium text-amber-400">
              {mode === 'send' ? 'Processing Payment...' : 'Sending...'}
            </span>
          </>
        ) : status === 'active' ? (
          <>
            {/* Animated sound waves */}
            <div className="relative w-20 h-20 flex items-center justify-center">
              <div className={`absolute inset-0 rounded-full ${mode === 'send' ? 'bg-blue-500/20' : 'bg-purple-500/20'} animate-ping`} />
              <div className={`absolute inset-2 rounded-full ${mode === 'send' ? 'bg-blue-500/30' : 'bg-purple-500/30'} animate-pulse`} />
              <div className={`relative w-12 h-12 rounded-full ${mode === 'send' ? 'bg-blue-500/40' : 'bg-purple-500/40'} flex items-center justify-center`}>
                {mode === 'send' ? (
                  <svg className="w-6 h-6 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                  </svg>
                ) : (
                  <svg className="w-6 h-6 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                  </svg>
                )}
              </div>
            </div>
           <span className={`text-lg font-medium ${mode === 'send' ? 'text-blue-400' : 'text-purple-400'}`}>
              {mode === 'send' 
                ? attempt === 1 ? 'Sending payment...' 
                  : attempt === 2 ? 'Trying again...'
                  : attempt === 3 ? 'One more try...'
                  : 'Sending...'
                : listenState === 'ready' ? 'Ready - listening...'
                  : listenState === 'sync' ? 'Heard signal...'
                  : listenState === 'receiving' ? `Receiving ${receivedChars}...`
                  : 'Starting...'}
            </span>
            <span className="text-sm text-zinc-500">Tap to cancel</span>
          </>
        ) : (
          <>
            <div className={`w-16 h-16 rounded-full ${mode === 'send' ? 'bg-blue-500/20' : 'bg-purple-500/20'} flex items-center justify-center`}>
              {mode === 'send' ? (
                <svg className="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
                </svg>
              ) : (
                <svg className={`w-8 h-8 ${isRegistered ? 'text-purple-400' : 'text-zinc-600'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
              )}
            </div>
            <span className={`text-xl font-semibold ${(mode === 'receive' && !isRegistered) ? 'text-zinc-600' : 'text-white'}`}>
              {mode === 'send' ? 'Tap to Send' : isRegistered ? 'Tap to Listen' : 'Not Available'}
            </span>
          </>
        )}
      </button>

      {/* Payment Info */}
      <div className="mt-6 pt-4 border-t border-zinc-800 text-center">
        <p className="text-zinc-400 text-sm">{storeName}</p>
        <p className="text-2xl font-bold text-white mt-1">¬£{amount.toFixed(2)}</p>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPaymentConfirm.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface PaymentDetails {
  payment_id: string;
  store_id: string;
  store_name: string;
  store_logo: string | null;
  amount: number;
  currency: string;
  vendor_wallet: string;
}

interface SoundPaymentConfirmProps {
  payment: PaymentDetails;
  token: string;
  customerWallet: string;
  tipAmount?: number;
  onConfirm: (txHash: string, receiptId?: string) => void;
  onCancel: () => void;
  onError?: (error: string) => void;
}


// MARK: - Component Definition
export default function SoundPaymentConfirm({
  payment,
  token,
  customerWallet,
  onConfirm,
  onCancel,
  tipAmount = 0,
  onError
}: SoundPaymentConfirmProps) {

// MARK: - State Management
  const [processing, setProcessing] = useState(false);


// MARK: - Event Handlers
  const handleConfirm = async () => {
    try {
      setProcessing(true);

      // First verify the token and mark as used
      const verifyRes = await fetch(`${API_URL}/sound-payment/pay`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, customer_wallet: customerWallet })
      });

      const verifyData = await verifyRes.json();

      if (!verifyData.success) {
        throw new Error(verifyData.error || 'Token verification failed');
      }

      // Now process the actual payment using existing endpoint
      const payRes = await fetch(`${API_URL}/payment-link/${payment.payment_id}/pay`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          payer_wallet: customerWallet,
          tip_amount: tipAmount,
          payment_type: 'sound'
        })
      });

      const payData = await payRes.json();

      if (!payData.success) {
        throw new Error(payData.error || 'Payment failed');
      }

      onConfirm(payData.tx_hash, payData.receipt_id);

    } catch (error) {
      console.error('Payment error:', error);
      onError?.(String(error));
    } finally {
      setProcessing(false);
    }
  };


// MARK: - Main Render
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className="bg-zinc-900 rounded-3xl p-6 max-w-sm w-full">
        {/* Store Logo/Name */}
        <div className="text-center mb-6">
          {payment.store_logo ? (
            <img
              src={payment.store_logo}
              alt={payment.store_name}
              className="w-16 h-16 rounded-2xl object-cover mx-auto mb-3"
            />
          ) : (
            <div className="w-16 h-16 rounded-2xl bg-zinc-800 flex items-center justify-center mx-auto mb-3">
              <span className="text-2xl">{payment.store_name.charAt(0)}</span>
            </div>
          )}
          <h2 className="text-xl font-bold">{payment.store_name}</h2>
        </div>

        {/* Amount */}
        <div className="bg-zinc-800 rounded-2xl p-4 mb-6 text-center">
          <p className="text-zinc-400 text-sm mb-1">Amount to pay</p>
          <p className="text-4xl font-bold text-white">
            ¬£{payment.amount.toFixed(2)}
          </p>
        </div>

        {/* Sound Payment Badge */}
        <div className="flex items-center justify-center gap-2 mb-6 text-zinc-400">
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728" />
          </svg>
          <span className="text-sm">Received via Sound</span>
        </div>

        {/* Buttons */}
        <div className="flex gap-3">
          <button
            onClick={onCancel}
            disabled={processing}
            className="flex-1 bg-zinc-800 hover:bg-zinc-700 rounded-xl py-4 font-medium transition disabled:opacity-50"
          >
            Cancel
          </button>
          <button
            onClick={handleConfirm}
            disabled={processing}
            className="flex-1 bg-emerald-500 hover:bg-emerald-600 rounded-xl py-4 font-medium transition disabled:opacity-50 flex items-center justify-center gap-2"
          >
            {processing ? (
              <>
                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                Paying...
              </>
            ) : (
              'Confirm'
            )}
          </button>
        </div>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPaymentPage.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem } from '@/lib/safeStorage';
import { startListening, initSoundPayment, isSupported, cleanup, warmupAudio } from '@/utils/soundPayment';
import NebulaBackground from '@/components/NebulaBackground';
import SoundPayInstructions from '@/components/SoundPayInstructions';
import ReceiptActions from '@/components/ReceiptActions';
import MoveCloserAnimation from '@/components/MoveCloserAnimation';
import VolumeReminder from '@/components/VolumeReminder';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface PaymentData {
  store_name: string;
  store_id?: string;
  store_logo?: string;
  amount: number;
  tip?: number;
  items?: Array<{ name: string; quantity: number; unit_price: number }>;
  rlusd_amount?: number;
  conversion_rate?: {
    rlusd_gbp: number;
    source: string;
    captured_at: string;
  };
}


// MARK: - Component Definition
export default function SoundPaymentPage() {
  const [status, setStatus] = useState<'idle' | 'listening' | 'processing' | 'success' | 'error'>('idle');
  const [listenState, setListenState] = useState<'idle' | 'ready' | 'sync' | 'receiving'>('idle');

// MARK: - State Management
  const [receivedChars, setReceivedChars] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [txHash, setTxHash] = useState<string | null>(null);
  const [receiptId, setReceiptId] = useState<string | null>(null);
  const [paymentData, setPaymentData] = useState<PaymentData | null>(null);
  const [stopFn, setStopFn] = useState<(() => void) | null>(null);
  const [supported, setSupported] = useState(true);
  const [soundId, setSoundId] = useState<string | null>(null);
  const [showSuccessVideo, setShowSuccessVideo] = useState(true);
const [countdown, setCountdown] = useState<string | null>(null);

  // Hide success video after 3 seconds

// MARK: - Hooks & Effects
  useEffect(() => {
    if (status === 'success') {
      setShowSuccessVideo(true);
      const timer = setTimeout(() => setShowSuccessVideo(false), 6000);
      return () => clearTimeout(timer);
    }
  }, [status]);

  // Check support and get sound_id on mount
  useEffect(() => {
    if (!isSupported()) {
      setSupported(false);
      return;
    }

    // Get wallet and sound_id
    const setupWallet = async () => {
      try {
        const { loginWithWeb3Auth } = await import('@/lib/web3auth');
        
        let wallet = safeGetItem('walletAddress');
        
        if (!wallet) {
          const result = await loginWithWeb3Auth();
          wallet = result?.address || safeGetItem('walletAddress');
        }
        
        if (!wallet) {
          setError('Please login to pay');
          return;
        }
        
        // Get sound_id from server using wallet
        const deviceRes = await fetch(`${API_URL}/sound/device-by-wallet/${wallet}`);
        const deviceData = await deviceRes.json();
        
        if (!deviceData.success || !deviceData.sound_id) {
          setError('Enable Tap-to-Pay in dashboard first');
          return;
        }
        
        setSoundId(deviceData.sound_id);
      } catch (err: any) {
        console.error('Setup error:', err);
        setError(err.message || 'Failed to setup');
      }
    };

    setupWallet();
    
    return () => {
      cleanup();
    };
  }, []);

  // Start listening
  const startListen = async () => {
    if (!soundId) {
      setError('Not ready - please wait or refresh');
      return;
    }

    try {
      setError(null);
      setStatus('listening');
      setListenState('idle');
      setReceivedChars('');
      
      await initSoundPayment();
      await warmupAudio();

      // Countdown warmup
      setCountdown('1');
      await new Promise(r => setTimeout(r, 1000));
      setCountdown('2');
      await new Promise(r => setTimeout(r, 1000));
      setCountdown('Ready!');
      await new Promise(r => setTimeout(r, 500));
      setCountdown(null);

      console.log('üîä SoundPay: Listening for payment...');
      
      const stop = await startListening(
        async (token: string) => {
          if (token.length >= 4) {
            console.log('üîä Heard token:', token);
            stop();
            setStopFn(null);
            
            setStatus('processing');
            setListenState('idle');
            setReceivedChars('');
            
            try {
              const res = await fetch(`${API_URL}/p/${token}?sid=${soundId}`);
              const data = await res.json();
              
              if (!data.success) {
                throw new Error(data.error || 'Payment failed');
              }
              
              console.log('üîä Payment complete:', data);
              setTxHash(data.tx_hash);
              if (data.receipt_id) setReceiptId(data.receipt_id);
              
              // Store payment details for receipt
              setPaymentData({
                store_name: data.store_name || 'Unknown Store',
                store_id: data.store_id,
                store_logo: data.store_logo,
                amount: data.amount || 0,
                tip: data.tip_amount || data.tip || 0,
                items: data.items,
                rlusd_amount: data.rlusd_amount || data.amount_rlusd,
                conversion_rate: data.conversion_rate,
              });
              
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              
            } catch (err: any) {
              console.error('üîä Payment error:', err);
              setError(err.message || 'Payment failed');
              setStatus('error');
            }
          }
        },
        (err) => {
          setError(err);
          setStatus('error');
          setListenState('idle');
        },
        (state: 'ready' | 'sync' | 'receiving', chars?: string) => {
          setListenState(state);
          if (chars) setReceivedChars(chars);
        }
      );
      
      setStopFn(() => stop);
    } catch (err: any) {
      console.error('Listen error:', err);
      setError(err.message || 'Failed to start listening');
      setStatus('error');
    }
  };

  // Stop listening
  const stopListen = () => {
    if (stopFn) {
      stopFn();
      setStopFn(null);
    }
    setStatus('idle');
    setListenState('idle');
    setReceivedChars('');
  };

  // Reset
  const reset = () => {
    setStatus('idle');
    setListenState('idle');
    setReceivedChars('');
    setError(null);
    setTxHash(null);
    setReceiptId(null);
    setPaymentData(null);
  };

  if (!supported) {

// MARK: - Main Render
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center p-4">
        <div className="text-center">
          <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h2 className="text-xl font-bold mb-2">Not Supported</h2>
          <p className="text-zinc-400">Your browser doesn't support audio features needed for SoundPay.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black text-white overflow-hidden">
      <NebulaBackground opacity={0.3} />
      
      {/* Sound wave video background - very faint, nebula stays prominent */}
      <div className="fixed inset-0 z-[1] pointer-events-none">
        <video
          autoPlay
          loop
          muted
          playsInline
          className="absolute inset-0 w-full h-full object-cover mix-blend-soft-light"
          style={{
            opacity: 0.06,
          }}
        >
          <source src="/soundwave-bg.mp4" type="video/mp4" />
        </video>
      </div>
      
      <div className={`max-w-md mx-auto p-4 pt-4 md:pt-0 md:pb-4 md:min-h-screen md:flex md:flex-col md:justify-center relative z-10 ${status === 'success' ? 'pb-4' : 'pb-32'}`}>
        {/* Instructions Animation - Tappable */}
        {status === 'idle' && (
          <div className="mb-4 cursor-pointer" onClick={startListen}>
            <SoundPayInstructions mode="receive" />
          </div>
        )}

        {/* Mic Reminder */}
        {status === 'idle' && (
          <div className="flex items-center justify-center gap-2 mb-4 px-4 py-2 rounded-xl bg-purple-500/10 text-purple-300">
            <svg className="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            <span className="text-xs font-medium">Allow microphone access</span>
          </div>
        )}

        {/* Main Button */}
        {status === 'idle' && (
          <button

// MARK: - Event Handlers
            onClick={startListen}
            disabled={!soundId}
            className={`w-full h-40 rounded-2xl font-semibold transition-all flex flex-col items-center justify-center gap-2 relative overflow-hidden ${
              soundId 
                ? 'active:scale-95 text-white'
                : 'bg-zinc-800 border border-zinc-700 text-zinc-500 cursor-not-allowed'
            }`}
          >
            {soundId && (
              <>
                {/* Video background */}
                <video
                  autoPlay
                  loop
                  muted
                  playsInline
                  className="absolute inset-0 w-full h-full object-cover"
                >
                  <source src="/nebula-bg.webm" type="video/webm" />
                </video>
                {/* Dark overlay */}
                <div className="absolute inset-0 bg-black/60" />
              </>
            )}
            <span className="text-2xl font-bold relative z-10">{soundId ? 'SoundPay' : 'Setting up...'}</span>
            {soundId && <span className="text-purple-200 text-sm relative z-10">Pay Now</span>}
          </button>
        )}
{/* Volume Reminder - fills space, overlaps footer */}
        {status === 'idle' && soundId && (
          <VolumeReminder className="mt-8 mb-[-80px]" />
        )}
        {/* LISTENING STATE */}
        {status === 'listening' && (
          <div className="flex flex-col h-[calc(100vh-2rem)] justify-between py-2">
            {countdown !== null ? (
              <div className="bg-purple-500/10 border-2 border-purple-500 rounded-3xl p-6 text-center">
                <div className="text-8xl font-bold text-purple-400 mb-4 animate-pulse">
                  {countdown}
                </div>
                <h2 className="text-xl font-bold text-zinc-400">Warming up mic...</h2>
              </div>
            ) : (
              <div className="bg-purple-500/10 border-2 border-purple-500 rounded-2xl p-4 text-center">
                {/* Animated icon */}
                <div className="relative w-16 h-16 mx-auto mb-2">
                <div className="absolute inset-0 rounded-full bg-purple-500/20 animate-ping" />
                <div className="absolute inset-2 rounded-full bg-purple-500/30 animate-pulse" />
                <div className="relative w-16 h-16 rounded-full bg-purple-500/40 flex items-center justify-center">
                  <svg className="w-8 h-8 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                  </svg>
                </div>
              </div>
              
              <h2 className="text-lg font-bold text-purple-400 mb-0.5">
  {listenState === 'ready' ? 'Connected'
    : listenState === 'sync' ? 'Heard signal...'
    : listenState === 'receiving' ? `Receiving ${receivedChars}...`
    : 'Ready to Pay'}
</h2>
              <p className="text-zinc-400 text-sm">Hold phone near sender device</p>
              </div>
            )}

            {/* Move Closer Animation */}
            <MoveCloserAnimation className="mt-8" />

            <button
              onClick={stopListen}
              className="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-semibold py-3 rounded-xl transition mt-2"
            >
              Cancel
            </button>

            </div>
        )}

        {/* PROCESSING STATE */}
        {status === 'processing' && (
          <div className="bg-amber-500/10 border-2 border-amber-500 rounded-3xl p-8 text-center">
            <div className="w-20 h-20 bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-10 h-10 text-amber-400 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <h2 className="text-xl font-bold text-amber-400 mb-2">Processing Payment...</h2>
            <p className="text-zinc-400">Please wait</p>
          </div>
        )}

        {/* SUCCESS STATE */}
        {status === 'success' && (
          <div className="space-y-4 pt-4">
            {/* Store Logo with Success Video Overlay */}
            <div className="relative w-24 h-24 mx-auto">
              {paymentData?.store_logo ? (
                <img
                  src={paymentData.store_logo}
                  alt={paymentData.store_name}
                  className="w-24 h-24 rounded-2xl object-cover"
                />
              ) : (
                <img
                  src="https://yesallofus.com/dltpayslogo1.png"
                  alt="YesAllOfUs"
                  className="w-24 h-24 rounded-2xl"
                />
              )}
              {showSuccessVideo && (
                <video
                  autoPlay
                  muted
                  playsInline
                  onEnded={() => setShowSuccessVideo(false)}
                  className="absolute inset-0 w-24 h-24 rounded-2xl object-cover"
                >
                  <source src="/successmessage.webm" type="video/webm" />
                </video>
              )}
            </div>

            {/* Success Icon */}
            <div className="w-28 h-28 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto">
              <svg className="w-14 h-14 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>

            <div className="text-center space-y-1">
              <h2 className="text-3xl font-bold text-emerald-400">Payment Complete!</h2>
              <p className="text-lg text-zinc-400">Thank you for shopping at</p>
              <p className="text-2xl font-bold">{paymentData?.store_name || 'Store'}</p>
            </div>

            {/* Payment Summary */}
            <div className="bg-zinc-900/50 rounded-xl p-4 text-center">
              <div className="text-zinc-400 text-sm mb-1">Amount paid:</div>
              <div className="text-3xl font-bold text-emerald-400">
                ¬£{(paymentData?.amount || 0).toFixed(2)}
              </div>
              {paymentData?.tip && paymentData.tip > 0 && (
                <div className="text-zinc-500 text-sm mt-1">
                  Includes ¬£{paymentData.tip.toFixed(2)} tip
                </div>
              )}
            </div>

            {/* XRPL Link */}
            {txHash && (
              <a
                href={`https://livenet.xrpl.org/transactions/${txHash}`}
                target="_blank"
                rel="noopener noreferrer"
                className="text-sky-400 text-sm underline block text-center"
              >
                View on XRPL ‚Üí
              </a>
            )}

            {/* Receipt Actions */}
            <ReceiptActions
              receiptId={receiptId || undefined}
              txHash={txHash || undefined}
              storeName={paymentData?.store_name || ''}
              storeId={paymentData?.store_id}
              amount={paymentData?.amount || 0}
              rlusdAmount={paymentData?.rlusd_amount}
              items={paymentData?.items}
              tipAmount={paymentData?.tip || 0}
              conversionRate={paymentData?.conversion_rate}
              storeLogo={paymentData?.store_logo}
              walletAddress={safeGetItem('walletAddress') || undefined}
            />

            {/* YAOFUS Receipt Badge */}
            <div className="pt-4 border-t border-zinc-800 flex flex-col items-center gap-1">
              <span className="text-zinc-500 text-[10px] font-medium tracking-wider">RECEIPT</span>
              <span className="text-base font-extrabold tracking-widest">
                <span className="text-emerald-500">Y</span>
                <span className="text-green-500">A</span>
                <span className="text-blue-500">O</span>
                <span className="text-indigo-500">F</span>
                <span className="text-violet-500">U</span>
                <span className="text-purple-500">S</span>
              </span>
              <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">INSTANT</span>
              <div className="flex items-center gap-2 mt-1">
                <img src="https://yesallofus.com/dltpayslogo1.png" alt="YesAllOfUs" className="w-5 h-5 rounded opacity-60" />
                <span className="text-zinc-600 text-xs">Powered by YesAllOfUs</span>
              </div>
            </div>

            <button
              onClick={reset}
              className="w-full bg-zinc-800 hover:bg-zinc-700 text-white font-semibold py-4 rounded-xl transition"
            >
              Done
            </button>
          </div>
        )}

        {/* ERROR STATE */}
        {status === 'error' && (
          <div className="space-y-6">
            <div className="bg-red-500/10 border-2 border-red-500 rounded-3xl p-8 text-center">
              <div className="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg className="w-10 h-10 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </div>
              <h2 className="text-xl font-bold text-red-400 mb-2">Failed</h2>
              <p className="text-zinc-400">{error || 'Something went wrong'}</p>
            </div>

            <button
              onClick={reset}
              className="w-full bg-gradient-to-br from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold py-4 rounded-xl transition"
            >
              Try Again
            </button>
          </div>
        )}

        {/* Error display when idle - fixed at bottom over footer */}
        {status === 'idle' && error && (
          <div className="fixed bottom-0 left-4 right-4 mb-4 p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-center z-20">
            <p className="text-red-400 text-sm">{error}</p>
          </div>
        )}
      </div>

      {/* YAOFUS Pioneers Badge - Fixed at bottom, hidden when error or success */}
      {!(status === 'idle' && error) && status !== 'success' && status !== 'listening' && (
        <div className="fixed bottom-4 left-0 right-0 flex flex-col items-center gap-1">
          <span className="text-zinc-500 text-[10px] font-medium tracking-wider">ULTRA</span>
          <span className="text-base font-extrabold tracking-widest">
            <span className="text-emerald-500">Y</span>
            <span className="text-green-500">A</span>
            <span className="text-blue-500">O</span>
            <span className="text-indigo-500">F</span>
            <span className="text-violet-500">U</span>
            <span className="text-purple-500">S</span>
          </span>
          <span className="text-zinc-600 text-[10px] font-semibold tracking-wider">SoundPay</span>
          <div className="flex items-center gap-2 mt-2 text-zinc-600 text-sm">
            <img src="https://yesallofus.com/dltpayslogo1.png" alt="" className="w-5 h-5 rounded opacity-60" />
            <span>Powered by YesAllOfUs</span>
          </div>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPaySend.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface SoundPayButtonProps {
  /** Store ID */
  storeId: string;
  /** Store name for receipt */
  storeName: string;
  /** Vendor wallet address */
  vendorWallet: string;
  /** Payment amount in GBP */
  amount: number;
  /** Optional tip amount in GBP */
  tipAmount?: number;
  /** Optional cart items for receipt */
  items?: Array<{ name: string; quantity: number; unit_price: number }>;
  /** Callback when payment succeeds */
  onSuccess?: (txHash: string, receiptId?: string) => void;
  /** Callback on error */
  onError?: (error: string) => void;
  /** Button size - number (px), string (Tailwind class), or preset */
  size?: number | string | 'sm' | 'md' | 'lg' | 'xl' | 'full';
  /** Custom class name */
  className?: string;
  /** Disable the button */
  disabled?: boolean;
}

type Status = 'idle' | 'creating' | 'active' | 'success' | 'error';

let soundUtils: any = null;

async function loadSoundUtils() {
  if (soundUtils) return soundUtils;
  if (typeof window === 'undefined') return null;
  soundUtils = await import('@/utils/soundPayment');
  return soundUtils;
}


// MARK: - Component Definition
export default function SoundPayButton({
  storeId,
  storeName,
  vendorWallet,
  amount,
  tipAmount = 0,
  items,
  onSuccess,
  onError,
  size = 'md',
  className = '',
  disabled = false,
}: SoundPayButtonProps) {
  const [status, setStatus] = useState<Status>('idle');

// MARK: - State Management
  const [attempt, setAttempt] = useState(0);

  // Determine size classes

// MARK: - API Calls & Data Fetching
  const getSizeStyle = (): { style: React.CSSProperties; className: string } => {
    if (typeof size === 'number') {
      return { style: { width: size, height: size }, className: '' };
    }
    switch (size) {
      case 'sm':
        return { style: {}, className: 'w-16 h-16' };
      case 'md':
        return { style: {}, className: 'w-24 h-24' };
      case 'lg':
        return { style: {}, className: 'w-32 h-32' };
      case 'xl':
        return { style: {}, className: 'w-40 h-40' };
      case 'full':
        return { style: {}, className: 'w-full h-14' };
      default:
        // Custom Tailwind classes
        return { style: {}, className: size };
    }
  };

  const sizeConfig = getSizeStyle();
  const isFullWidth = size === 'full' || (typeof size === 'string' && size.includes('w-full'));


// MARK: - Event Handlers
  const handleSend = async () => {
    if (status === 'active' || status === 'creating' || disabled) return;

    try {
      setStatus('creating');

      // 1. Create payment link first
      const totalAmount = amount + tipAmount;
      const paymentItems = items 
        ? [
            ...items.map(item => ({
              name: item.name,
              quantity: item.quantity,
              unit_price: item.unit_price,
              line_total: item.unit_price * item.quantity
            })),
            ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
          ]
        : [
            { name: 'Payment', quantity: 1, unit_price: amount, line_total: amount },
            ...(tipAmount > 0 ? [{ name: 'Tip', quantity: 1, unit_price: tipAmount, line_total: tipAmount }] : [])
          ];

      const linkRes = await fetch(`${API_URL}/payment-link/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          store_id: storeId,
          store_name: storeName,
          vendor_wallet: vendorWallet,
          amount: totalAmount,
          items: paymentItems,
        }),
      });
      
      const linkData = await linkRes.json();
      if (!linkData.success || !linkData.payment_id) {
        throw new Error(linkData.error || 'Failed to create payment');
      }

      const paymentId = linkData.payment_id;
      console.log('üîä SoundPay: Created payment', paymentId);

      // 2. Initialize sound
      setStatus('active');
      setAttempt(0);

      const utils = await loadSoundUtils();
      if (!utils) throw new Error('Sound not available');

      await utils.initSoundPayment();
      await utils.warmupAudio();

      const shortToken = paymentId.slice(-4).toUpperCase();

      // 3. Broadcast with retries
      const attempts = [
        { volume: 0.4, toneDuration: 0.05, silenceDuration: 0.02 },
        { volume: 0.7, toneDuration: 0.08, silenceDuration: 0.03 },
        { volume: 1.0, toneDuration: 0.12, silenceDuration: 0.04 },
      ];

      let paid = false;

      for (let i = 0; i < attempts.length && !paid; i++) {
        const settings = attempts[i];
        setAttempt(i + 1);
        console.log(`üîä SoundPay: Attempt ${i + 1}/${attempts.length}:`, shortToken, settings);

        await utils.broadcastToken(shortToken, settings);

        // Poll for 8 seconds before retrying
        const pollDuration = 8000;
        const pollStart = Date.now();

        while (Date.now() - pollStart < pollDuration && !paid) {
          try {
            const res = await fetch(`${API_URL}/payment-link/${paymentId}`);
            const data = await res.json();

            if (data.payment?.status === 'paid') {
              paid = true;
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              onSuccess?.(data.payment.tx_hash, data.payment.receipt_id);
              setTimeout(() => setStatus('idle'), 3000);
              return;
            }
          } catch (e) {
            console.warn('Poll error:', e);
          }
          await new Promise((r) => setTimeout(r, 500));
        }
      }

      // All attempts failed
      if (!paid) {
        setStatus('error');
        onError?.('Sound payment failed after 3 attempts');
        setTimeout(() => setStatus('idle'), 3000);
      }
    } catch (error: any) {
      console.error('SoundPay error:', error);
      setStatus('error');
      onError?.(error.message || 'Failed to send');
      setTimeout(() => setStatus('idle'), 3000);
    }
  };


// MARK: - Main Render
  return (
    <button
      onClick={handleSend}
      disabled={disabled || status === 'active'}
      style={sizeConfig.style}
      className={`
        relative overflow-hidden rounded-2xl transition-all
        ${sizeConfig.className}
        ${disabled ? 'opacity-50 cursor-not-allowed' : 'active:scale-95 cursor-pointer'}
        ${status === 'success' ? 'ring-2 ring-emerald-500' : ''}
        ${status === 'error' ? 'ring-2 ring-red-500' : ''}
        ${status === 'active' || status === 'creating' ? 'ring-2 ring-purple-500' : ''}
        ${className}
      `}
    >
      {/* Video Background */}
      <video
        autoPlay
        loop
        muted
        playsInline
        className="absolute inset-0 w-full h-full object-cover"
      >
        <source src="/soundpay-button-bg.webm" type="video/webm" />
      </video>

      {/* Dark Overlay */}
      <div
        className={`absolute inset-0 transition-colors ${
          status === 'success'
            ? 'bg-emerald-900/70'
            : status === 'error'
            ? 'bg-red-900/70'
            : status === 'active' || status === 'creating'
            ? 'bg-purple-900/60'
            : 'bg-black/50'
        }`}
      />

      {/* Content */}
      <div className={`relative z-10 flex items-center justify-center h-full ${isFullWidth ? 'flex-row gap-3' : 'flex-col'}`}>
        {status === 'success' ? (
          <>
            <svg
              className={isFullWidth ? 'w-6 h-6 text-emerald-400' : 'w-1/3 h-1/3 text-emerald-400'}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
            </svg>
            {isFullWidth && <span className="text-emerald-400 font-bold">Paid!</span>}
          </>
        ) : status === 'error' ? (
          <>
            <svg
              className={isFullWidth ? 'w-6 h-6 text-red-400' : 'w-1/3 h-1/3 text-red-400'}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
            </svg>
            {isFullWidth && <span className="text-red-400 font-bold">Failed</span>}
          </>
        ) : status === 'creating' ? (
          <>
            {isFullWidth ? (
              <>
                <div className="w-5 h-5 border-2 border-purple-300 border-t-transparent rounded-full animate-spin" />
                <span className="text-purple-300 font-bold">Preparing...</span>
              </>
            ) : (
              <>
                <div className="w-6 h-6 border-2 border-purple-300 border-t-transparent rounded-full animate-spin" />
                <span className="text-purple-300 font-bold text-xs mt-1">Preparing</span>
              </>
            )}
          </>
        ) : status === 'active' ? (
          <>
            {/* Pulsing animation */}
            {!isFullWidth && (
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="w-2/3 h-2/3 rounded-full bg-purple-500/30 animate-ping" />
              </div>
            )}
            {isFullWidth ? (
              <>
                <div className="w-5 h-5 border-2 border-purple-300 border-t-transparent rounded-full animate-spin" />
                <span className="text-purple-300 font-bold">
                  {attempt === 1 ? 'Sending...' : attempt === 2 ? 'Retrying...' : 'Final try...'}
                </span>
              </>
            ) : (
              <span className="text-purple-300 font-bold text-xs relative z-10">
                {attempt === 1 ? 'Sending' : attempt === 2 ? 'Retry' : 'Final'}
              </span>
            )}
          </>
        ) : (
          <>
            {isFullWidth ? (
              <>
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 001.414 1.414m2.828-9.9a9 9 0 012.828-2.828" />
                </svg>
                <span className="text-white font-bold">SoundPay</span>
                <span className="text-white/60 text-sm">Send</span>
              </>
            ) : (
              <>
                <span className="text-white font-bold text-sm leading-tight">SoundPay</span>
                <span className="text-white/70 text-xs">Send</span>
              </>
            )}
          </>
        )}
      </div>
    </button>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SoundPaySendButton.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';
import { motion } from 'framer-motion';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface SoundPaySendButtonProps {
  className?: string;
  /** Payment ID to broadcast (last 4 chars used) */
  paymentId: string;
  /** Store ID for payment verification */
  storeId?: string;
  /** Callback when payment succeeds */
  onSuccess?: (txHash: string, receiptId?: string, rlusdAmount?: number) => void;
  /** Callback on error */
  onError?: (error: string) => void;
}

type Status = 'idle' | 'active' | 'success' | 'error';

let soundUtils: any = null;

async function loadSoundUtils() {
  if (soundUtils) return soundUtils;
  if (typeof window === 'undefined') return null;
  soundUtils = await import('@/utils/soundPayment');
  return soundUtils;
}


// MARK: - Component Definition
export default function SoundPaySendButton({ 
  className = '',
  paymentId,
  storeId = '',
  onSuccess,
  onError,
}: SoundPaySendButtonProps) {
  const [status, setStatus] = useState<Status>('idle');

// MARK: - State Management
  const [attempt, setAttempt] = useState(0);


// MARK: - Event Handlers
  const handleSend = async () => {
    if (status === 'active') return;

    try {
      setStatus('active');
      setAttempt(0);

      const utils = await loadSoundUtils();
      if (!utils) throw new Error('Sound not available');

      await utils.initSoundPayment();
      await utils.warmupAudio();

      const shortToken = paymentId.slice(-4).toUpperCase();

      const attempts = [
        { volume: 1.0, toneDuration: 0.08, silenceDuration: 0.03 },
        { volume: 1.0, toneDuration: 0.10, silenceDuration: 0.04 },
        { volume: 1.0, toneDuration: 0.12, silenceDuration: 0.05 },
      ];

      let paid = false;

      for (let i = 0; i < attempts.length && !paid; i++) {
        const settings = attempts[i];
        setAttempt(i + 1);
        console.log(`üîä SoundPay: Attempt ${i + 1}/${attempts.length}:`, shortToken, settings);

        await utils.broadcastToken(shortToken, settings);

        const pollDuration = i === attempts.length - 1 ? 11000 : 8000;
        const pollStart = Date.now();

        while (Date.now() - pollStart < pollDuration && !paid) {
          try {
            const res = await fetch(`${API_URL}/payment-link/${paymentId}`);
            const data = await res.json();

            if (data.payment?.status === 'paid') {
              console.log('SoundPay payment data:', data.payment);
              paid = true;
              setStatus('success');
              if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
              onSuccess?.(data.payment.tx_hash, data.payment.receipt_id, data.payment.rlusd_amount);
              return;
            }
          } catch (e) {
            console.warn('Poll error:', e);
          }
          await new Promise((r) => setTimeout(r, 500));
        }
      }

      if (!paid) {
        setStatus('error');
        onError?.('Sound payment failed after 3 attempts');
      }
    } catch (error: any) {
      console.error('SoundPay error:', error);
      setStatus('error');
      onError?.(error.message || 'Failed to send');
    }
  };

  // IDLE STATE
  if (status === 'idle') {

// MARK: - Main Render
    return (
      <div className="flex flex-col items-center">
        <button 
          onClick={handleSend}
          className={`flex flex-col items-center justify-center w-40 h-40 sm:w-48 sm:h-48 bg-sky-500/20 rounded-full cursor-pointer relative ${className}`}
        >
          <div className="absolute inset-0 bg-sky-500/20 rounded-full animate-ping pointer-events-none" style={{ animationDuration: '2s' }}></div>
          <div className="absolute inset-4 bg-sky-500/10 rounded-full animate-pulse"></div>
          <svg
            className="w-20 h-20 sm:w-24 sm:h-24 text-sky-400 relative z-10"
            style={{ transform: 'rotate(-90deg)' }}
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
          </svg>
        </button>
        <p className="text-2xl sm:text-3xl font-bold text-sky-400 mb-2 mt-5">SoundPay</p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Tap to send payment</p>
      </div>
    );
  }

  // ACTIVE STATE
  if (status === 'active') {
    return (
      <div className="flex flex-col items-center">
        <div className={`flex flex-col items-center justify-center w-40 h-40 sm:w-48 sm:h-48 bg-sky-500/20 rounded-full relative ${className}`}>
          {[0, 1, 2, 3].map((i) => (
            <motion.div
              key={i}
              className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 rounded-full border-2 border-sky-500/50"
              initial={{ width: 60, height: 60, opacity: 0.8 }}
              animate={{ 
                width: [60, 200],
                height: [60, 200],
                opacity: [0.8, 0],
              }}
              transition={{
                duration: 1.5,
                repeat: Infinity,
                delay: i * 0.4,
                ease: "easeOut"
              }}
            />
          ))}
          <motion.div
            className="relative z-10 w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-sky-500/30 flex items-center justify-center"
            animate={{ scale: [1, 1.1, 1] }}
            transition={{ duration: 0.5, repeat: Infinity }}
          >
            <svg className="w-10 h-10 sm:w-12 sm:h-12 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={2}>
              <circle cx="12" cy="12" r="2" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M16.24 7.76a6 6 0 010 8.49M7.76 16.24a6 6 0 010-8.49M19.07 4.93a10 10 0 010 14.14M4.93 19.07a10 10 0 010-14.14" />
            </svg>
          </motion.div>
        </div>
        <p className="text-2xl sm:text-3xl font-bold text-sky-400 mb-2 mt-5">
          {attempt === 1 ? 'Sending...' : attempt === 2 ? 'Retrying...' : 'Final attempt...'}
        </p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Hold phone near speaker</p>
      </div>
    );
  }

  // SUCCESS STATE
  if (status === 'success') {
    return (
      <div className="flex flex-col items-center">
        <div className={`flex flex-col items-center justify-center w-40 h-40 sm:w-48 sm:h-48 bg-emerald-500/20 rounded-full relative ${className}`}>
          <motion.div
            className="w-20 h-20 sm:w-24 sm:h-24 bg-emerald-500/20 rounded-full flex items-center justify-center"
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            transition={{ type: "spring", duration: 0.5 }}
          >
            <svg className="w-12 h-12 sm:w-16 sm:h-16 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <motion.path 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                strokeWidth={2.5} 
                d="M5 13l4 4L19 7"
                initial={{ pathLength: 0 }}
                animate={{ pathLength: 1 }}
                transition={{ duration: 0.5, delay: 0.2 }}
              />
            </svg>
          </motion.div>
        </div>
        <p className="text-2xl sm:text-3xl font-bold text-emerald-400 mb-2 mt-5">Complete!</p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Payment received</p>
      </div>
    );
  }

  // ERROR STATE
  if (status === 'error') {
    return (
      <div className="flex flex-col items-center">
        <button 
          onClick={handleSend}
          className={`flex flex-col items-center justify-center w-40 h-40 sm:w-48 sm:h-48 bg-red-500/20 rounded-full cursor-pointer relative ${className}`}
        >
          <motion.div
            className="w-20 h-20 sm:w-24 sm:h-24 bg-red-500/20 rounded-full flex items-center justify-center"
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            transition={{ type: "spring", duration: 0.5 }}
          >
            <svg className="w-12 h-12 sm:w-16 sm:h-16 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </motion.div>
        </button>
        <p className="text-2xl sm:text-3xl font-bold text-red-400 mb-2 mt-5">Failed</p>
        <p className="text-zinc-500 text-base sm:text-lg text-center">Tap to try again</p>
      </div>
    );
  }

  return null;
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SplitBillModal.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';
import NebulaBackground from '@/components/NebulaBackground';


// MARK: - Types & Interfaces
interface SplitBillModalProps {
  amount: number;
  isOpen: boolean;
  onClose: () => void;
  onSplit: (numSplits: number) => Promise<void>;
}


// MARK: - Component Definition
export default function SplitBillModal({ amount, isOpen, onClose, onSplit }: SplitBillModalProps) {

// MARK: - State Management
  const [splitCount, setSplitCount] = useState(2);
  const [splitting, setSplitting] = useState(false);

  if (!isOpen) return null;


// MARK: - Event Handlers
  const handleSplit = async () => {
    setSplitting(true);
    try {
      await onSplit(splitCount);
    } finally {
      setSplitting(false);
    }
  };

  // Calculate split amounts with proper rounding - first person absorbs remainder
  const baseAmount = Math.floor((amount * 100) / splitCount) / 100;
  const remainder = Math.round((amount - baseAmount * splitCount) * 100) / 100;
  const firstPersonPays = Math.round((baseAmount + remainder) * 100) / 100;
  const hasRemainder = remainder >= 0.01;


// MARK: - Main Render
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-6">
      <NebulaBackground opacity={0.5} />
      <div className="absolute inset-0 bg-black/70" />
      <div className="relative bg-gradient-to-b from-zinc-900/95 to-zinc-950/95 border border-zinc-800 rounded-3xl p-8 w-full max-w-sm shadow-2xl shadow-black/50">

        {/* Header */}
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-gradient-to-br from-emerald-500/20 to-sky-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
          </div>
          <h2 className="text-2xl font-bold text-white">Split the Bill</h2>
          <p className="text-zinc-500 text-sm mt-1">Divide payment between friends</p>
        </div>

        {/* Counter */}
        <div className="flex items-center justify-center gap-8 mb-8">
          <button
            onClick={() => setSplitCount(Math.max(2, splitCount - 1))}
            className="w-16 h-16 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 transition flex items-center justify-center group"
          >
            <svg className="w-6 h-6 text-zinc-400 group-hover:text-white transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M20 12H4" />
            </svg>
          </button>

          <div className="text-center">
            <span className="text-6xl font-bold text-white">{splitCount}</span>
            <p className="text-zinc-500 text-sm mt-1">people</p>
          </div>

          <button
            onClick={() => setSplitCount(Math.min(10, splitCount + 1))}
            className="w-16 h-16 rounded-2xl bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 transition flex items-center justify-center group"
          >
            <svg className="w-6 h-6 text-zinc-400 group-hover:text-white transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>

        {/* Summary Card */}
        <div className="bg-zinc-800/50 border border-zinc-700/50 rounded-2xl p-5 mb-8">
          <div className="flex justify-between items-center text-zinc-400 mb-3">
            <span>Total bill</span>
            <span className="font-medium">¬£{amount.toFixed(2)}</span>
          </div>
          <div className="h-px bg-gradient-to-r from-transparent via-zinc-600 to-transparent mb-3" />
          {hasRemainder ? (
            <>
              <div className="flex justify-between items-center mb-2">
                <span className="text-white font-medium">1st person pays</span>
                <span className="text-xl font-bold text-emerald-400">¬£{firstPersonPays.toFixed(2)}</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-zinc-400">{splitCount - 1} others pay</span>
                <span className="text-lg font-semibold text-emerald-400/80">¬£{baseAmount.toFixed(2)}</span>
              </div>
            </>
          ) : (
            <div className="flex justify-between items-center">
              <span className="text-white font-medium">Each person pays</span>
              <span className="text-2xl font-bold text-emerald-400">¬£{baseAmount.toFixed(2)}</span>
            </div>
          )}
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 py-4 rounded-xl font-medium transition text-zinc-300"
          >
            Cancel
          </button>
          <button
            onClick={handleSplit}
            disabled={splitting}
            className="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-black py-4 rounded-xl font-bold transition disabled:opacity-50 shadow-lg shadow-emerald-500/25 flex items-center justify-center gap-2"
          >
            {splitting ? (
              <>
                <div className="w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin" />
                Splitting...
              </>
            ) : (
              <>
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                Split Bill
              </>
            )}
          </button>
        </div>
      </div>
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/StaffSelector.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';
import { useRouter } from 'next/navigation';


// MARK: - Types & Interfaces
interface StaffMember {
  staff_id: string;
  name: string;
  photo_url?: string;
  role: string;
  is_clocked_in?: boolean;
}

interface StaffSelectorProps {
  storeId: string;
  walletAddress: string;
  onStaffChange?: (staff: StaffMember | null) => void;
}


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Component Definition
export default function StaffSelector({ storeId, walletAddress, onStaffChange }: StaffSelectorProps) {
  const router = useRouter();
  const [staffList, setStaffList] = useState<StaffMember[]>([]);
  const [activeStaff, setActiveStaff] = useState<StaffMember | null>(null);

// MARK: - State Management
  const [showDropdown, setShowDropdown] = useState(false);
  const [loading, setLoading] = useState(true);

  // Fetch staff list

// MARK: - Hooks & Effects
  useEffect(() => {
    if (storeId && walletAddress) {
      fetchStaffList();
      // Load saved active staff from session
      const savedStaff = safeGetItem('activeStaff');
      if (savedStaff) {
        const parsed = JSON.parse(savedStaff);
        setActiveStaff(parsed);
        onStaffChange?.(parsed);
      }
    }
  }, [storeId, walletAddress]);


// MARK: - API Calls & Data Fetching
  const fetchStaffList = async () => {
    setLoading(true);
    try {
      const res = await fetch(
        `${API_URL}/store/${storeId}/staff?wallet_address=${walletAddress}`
      );
      const data = await res.json();
      if (data.success) {
        setStaffList(data.staff || []);
      }
    } catch (err) {
      console.error('Failed to fetch staff');
    }
    setLoading(false);
  };

  const selectStaff = (staff: StaffMember | null) => {
    setActiveStaff(staff);
    if (staff) {
      safeSetItem('activeStaff', JSON.stringify(staff));
    } else {
      safeRemoveItem('activeStaff');
    }
    onStaffChange?.(staff);
    setShowDropdown(false);
  };


// MARK: - Main Render
  return (
    <div className="relative">
      <button

// MARK: - Event Handlers
        onClick={() => setShowDropdown(!showDropdown)}
        className="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-3 py-1.5 rounded-lg transition cursor-pointer active:scale-95"
      >
        {activeStaff ? (
          <>
            {activeStaff.photo_url ? (
              <img src={activeStaff.photo_url} alt="" className="w-6 h-6 rounded-full object-cover" />
            ) : (
              <div className="w-6 h-6 rounded-full bg-emerald-500/20 flex items-center justify-center text-xs text-emerald-400">
                {activeStaff.name.charAt(0)}
              </div>
            )}
            <span className="text-sm text-white hidden sm:inline max-w-[80px] truncate">{activeStaff.name}</span>
            <span className="text-emerald-400 text-xs">‚óè</span>
          </>
        ) : (
          <>
            <svg className="w-5 h-5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span className="text-sm text-zinc-400 hidden sm:inline">Staff</span>
          </>
        )}
        <svg className="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {/* Dropdown */}
      {showDropdown && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setShowDropdown(false)} />
          <div className="absolute top-full left-0 sm:left-auto sm:right-0 mt-2 w-64 bg-zinc-900 border border-zinc-700 rounded-xl shadow-xl z-50 overflow-hidden">
            <div className="p-2 border-b border-zinc-800">
              <p className="text-xs text-zinc-500 px-2">Who's on register?</p>
            </div>
            
            {loading ? (
              <div className="p-4 text-center">
                <div className="w-5 h-5 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
              </div>
            ) : staffList.length === 0 ? (
              <div className="p-4 text-center">
                <p className="text-zinc-500 text-sm mb-2">No staff members</p>
                <button
                  onClick={() => { setShowDropdown(false); router.push('/staffpos'); }}
                  className="text-emerald-400 text-sm hover:underline cursor-pointer"
                >
                  + Add staff
                </button>
              </div>
            ) : (
              <div className="max-h-64 overflow-y-auto">
                {/* No one option */}
                <button
                  onClick={() => selectStaff(null)}
                  className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 transition cursor-pointer ${
                    !activeStaff ? 'bg-zinc-800' : ''
                  }`}
                >
                  <div className="w-8 h-8 rounded-full bg-zinc-700 flex items-center justify-center">
                    <svg className="w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </div>
                  <div className="flex-1 text-left">
                    <p className="text-sm text-zinc-400">No one</p>
                  </div>
                </button>

                {staffList.map((staff) => (
                  <button
                    key={staff.staff_id}
                    onClick={() => selectStaff(staff)}
                    className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 transition cursor-pointer ${
                      activeStaff?.staff_id === staff.staff_id ? 'bg-zinc-800' : ''
                    }`}
                  >
                    {staff.photo_url ? (
                      <img src={staff.photo_url} alt="" className="w-8 h-8 rounded-full object-cover" />
                    ) : (
                      <div className="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-sm text-emerald-400">
                        {staff.name.charAt(0)}
                      </div>
                    )}
                    <div className="flex-1 text-left">
                      <p className="text-sm text-white">{staff.name}</p>
                      <p className="text-xs text-zinc-500">{staff.role}</p>
                    </div>
                    {staff.is_clocked_in ? (
                      <span className="text-emerald-400 text-xs">‚óè On shift</span>
                    ) : (
                      <span className="text-zinc-600 text-xs">Off</span>
                    )}
                  </button>
                ))}
              </div>
            )}

            <div className="p-2 border-t border-zinc-800">
              <button
                onClick={() => { setShowDropdown(false); router.push('/staffpos'); }}
                className="w-full text-center text-sm text-zinc-400 hover:text-white py-2 cursor-pointer"
              >
                Manage Staff ‚Üí
              </button>
            </div>
          </div>
        </>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/StoreActivity.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';


// MARK: - Types & Interfaces
interface Affiliate {
  affiliate_id: string;
  wallet: string;
  referral_code: string;
  total_earned: number;
  level: number;
  parent_id: string | null;
  created_at: any;
}

interface Payment {
  payout_id: string;
  order_id: string;
  order_total: number;
  payments: Array<{
    wallet: string;
    amount: number;
    level: number;
    type?: string;
    affiliate_id?: string;
  }>;
  tx_hashes: Array<{
    wallet: string;
    amount: number;
    tx_hash: string;
  }>;
  paid_at: any;
  auto_signed?: boolean;
}

interface StoreActivityProps {
  storeId: string;
  walletAddress: string;
  showAmounts?: boolean;
}


// MARK: - Component Definition
export default function StoreActivity({ storeId, walletAddress, showAmounts = false }: StoreActivityProps) {
  const [tab, setTab] = useState<'affiliates' | 'payments'>('affiliates');
  const [affiliates, setAffiliates] = useState<Affiliate[]>([]);
  const [payments, setPayments] = useState<Payment[]>([]);

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [sortOption, setSortOption] = useState<'rank' | 'oldest' | 'newest' | 'lowest'>('rank');
  const [paymentSortNewest, setPaymentSortNewest] = useState(true);
  const [page, setPage] = useState(0);
  const perPage = 20;


// MARK: - Hooks & Effects
  useEffect(() => {
    if (storeId && walletAddress) {
      fetchData();
    }
  }, [storeId, walletAddress]);


// MARK: - API Calls & Data Fetching
  const fetchData = async () => {
    setLoading(true);
    try {
      // L4: Use Promise.allSettled to handle partial failures gracefully
      const [affResult, payResult] = await Promise.allSettled([
        fetch(`${API_URL}/store/${storeId}/affiliates?wallet=${walletAddress}`),
        fetch(`${API_URL}/store/${storeId}/payouts?wallet=${walletAddress}`)
      ]);

      // Handle affiliates response
      if (affResult.status === 'fulfilled') {
        const affData = await affResult.value.json();
        if (affData.success) setAffiliates(affData.affiliates || []);
      } else {
        console.error('Failed to fetch affiliates:', affResult.reason);
      }

      // Handle payouts response
      if (payResult.status === 'fulfilled') {
        const payData = await payResult.value.json();
        if (payData.success) setPayments(payData.payouts || []);
      } else {
        console.error('Failed to fetch payouts:', payResult.reason);
      }
    } catch (err) {
      console.error('Failed to fetch activity:', err);
    }
    setLoading(false);
  };

  const getActualEarnings = (affiliateId: string): number => {
    let total = 0;
    for (const payment of payments) {
      for (const p of payment.payments) {
        if (p.affiliate_id === affiliateId) {
          total += p.amount;
        }
      }
    }
    return total;
  };

  const totalPaidOut = payments.reduce((sum, payment) => {
    const affiliatePayments = payment.payments
      .filter(p => p.type !== 'platform_fee')
      .reduce((s, p) => s + p.amount, 0);
    return sum + affiliatePayments;
  }, 0);

  const totalPlatformFees = payments.reduce((sum, payment) => {
    const platformFee = payment.payments
      .filter(p => p.type === 'platform_fee')
      .reduce((s, p) => s + p.amount, 0);
    return sum + platformFee;
  }, 0);

  const totalOrderValue = payments.reduce((sum, payment) => sum + payment.order_total, 0);

  const affiliatesWithActualEarnings = affiliates.map(aff => ({
    ...aff,
    actualEarned: getActualEarnings(aff.affiliate_id)
  }));

  // Sort affiliates based on selected option
  const sortedAffiliates = [...affiliatesWithActualEarnings].sort((a, b) => {
    switch (sortOption) {
      case 'rank':
        return b.actualEarned - a.actualEarned; // Highest earner first
      case 'lowest':
        return a.actualEarned - b.actualEarned; // Lowest earner first
      case 'newest':
        return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
      case 'oldest':
        return new Date(a.created_at).getTime() - new Date(b.created_at).getTime();
      default:
        return 0;
    }
  });

  // Ranked affiliates always by earnings (for showing rank number)
  const rankedAffiliates = [...affiliatesWithActualEarnings].sort((a, b) => b.actualEarned - a.actualEarned);

  const sortedPayments = [...payments].sort((a, b) => {
    if (paymentSortNewest) {
      const bTime = b.paid_at ? new Date(b.paid_at).getTime() : 0;
      const aTime = a.paid_at ? new Date(a.paid_at).getTime() : 0;
      return bTime - aTime;
    }
    const aTime = a.paid_at ? new Date(a.paid_at).getTime() : 0;
    const bTime = b.paid_at ? new Date(b.paid_at).getTime() : 0;
    return aTime - bTime;
  });

  const paginatedAffiliates = sortedAffiliates.slice(page * perPage, (page + 1) * perPage);
  const paginatedPayments = sortedPayments.slice(page * perPage, (page + 1) * perPage);
  
  const totalAffiliatePages = Math.ceil(affiliates.length / perPage);
  const totalPaymentPages = Math.ceil(payments.length / perPage);

  const formatDate = (date: any) => {
    if (!date) return '-';
    const d = date.toDate ? date.toDate() : new Date(date);
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
  };

  const formatWallet = (wallet: string) => {
    if (!wallet) return '-';
    return `${wallet.slice(0, 6)}...${wallet.slice(-4)}`;
  };

  const formatAmount = (amount: number) => {
    return showAmounts ? `$${amount.toFixed(2)}` : '$‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
  };

  const getRank = (affiliateId: string) => {
    const idx = rankedAffiliates.findIndex(a => a.affiliate_id === affiliateId);
    return idx >= 0 ? idx + 1 : '-';
  };

  const getRankIcon = (rank: number) => {
  if (rank === 1) return (
    <svg className="w-5 h-5 inline-block ml-1" viewBox="0 0 24 24" fill="none">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="#FFD700" stroke="#B8860B" strokeWidth="1"/>
    </svg>
  );
  if (rank === 2) return (
    <svg className="w-5 h-5 inline-block ml-1" viewBox="0 0 24 24" fill="none">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="#C0C0C0" stroke="#808080" strokeWidth="1"/>
    </svg>
  );
  if (rank === 3) return (
    <svg className="w-5 h-5 inline-block ml-1" viewBox="0 0 24 24" fill="none">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="#CD7F32" stroke="#8B4513" strokeWidth="1"/>
    </svg>
  );
  return null;
};

  if (loading) {

// MARK: - Main Render
    return (
      <div className="bg-zinc-900/50 rounded-xl p-8 text-center">
        <div className="w-6 h-6 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
      </div>
    );
  }

  return (
    <div className="mt-12">
      {payments.length > 0 && (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-zinc-900/50 rounded-xl p-4">
            <p className="text-zinc-500 text-xs uppercase tracking-wider mb-1">Total Orders</p>
            <p className="text-2xl font-bold text-white">{payments.length}</p>
          </div>
          <div className="bg-zinc-900/50 rounded-xl p-4">
            <p className="text-zinc-500 text-xs uppercase tracking-wider mb-1">Order Value</p>
            <p className="text-2xl font-bold text-white">{formatAmount(totalOrderValue)}</p>
          </div>
          <div className="bg-zinc-900/50 rounded-xl p-4">
            <p className="text-zinc-500 text-xs uppercase tracking-wider mb-1">Paid to Affiliates</p>
            <p className="text-2xl font-bold text-emerald-400">{formatAmount(totalPaidOut)}</p>
          </div>
          <div className="bg-zinc-900/50 rounded-xl p-4">
            <p className="text-zinc-500 text-xs uppercase tracking-wider mb-1">Platform Fees</p>
            <p className="text-2xl font-bold text-zinc-400">{formatAmount(totalPlatformFees)}</p>
          </div>
        </div>
      )}

      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
  <div className="flex gap-1 bg-zinc-900 p-1 rounded-lg flex-shrink-0">
          <button

// MARK: - Event Handlers
            onClick={() => { setTab('affiliates'); setPage(0); }}
            className={`px-4 py-2 rounded-md text-sm font-medium transition ${
              tab === 'affiliates' 
                ? 'bg-zinc-800 text-white' 
                : 'text-zinc-500 hover:text-zinc-300'
            }`}
          >
            Affiliates ({affiliates.length})
          </button>
          <button
            onClick={() => { setTab('payments'); setPage(0); }}
            className={`px-4 py-2 rounded-md text-sm font-medium transition ${
              tab === 'payments' 
                ? 'bg-zinc-800 text-white' 
                : 'text-zinc-500 hover:text-zinc-300'
            }`}
          >
            Payments ({payments.length})
          </button>
        </div>

        {tab === 'affiliates' ? (
  <div className="relative self-end sm:self-auto">
    <select
      value={sortOption}
      onChange={(e) => { setSortOption(e.target.value as any); setPage(0); }}
      className="appearance-none bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-1.5 sm:px-4 sm:py-2 pr-7 sm:pr-8 text-xs sm:text-sm text-zinc-300 cursor-pointer hover:border-zinc-700 transition focus:outline-none focus:border-emerald-500"
    >
      <option value="rank">‚è∂ Top Earners</option>
      <option value="lowest">‚è∑ Lowest First</option>
      <option value="newest">‚òÖ Newest First</option>
      <option value="oldest">‚ó∑ Oldest First</option>
    </select>
    <svg className="absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
    </svg>
  </div>
) : (
  <button
    onClick={() => setPaymentSortNewest(!paymentSortNewest)}
    className="text-zinc-500 hover:text-white text-sm flex items-center gap-2 transition"
  >
    {paymentSortNewest ? (
      <>
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
        Newest first
      </>
    ) : (
      <>
        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
        Oldest first
      </>
    )}
  </button>
)}
</div>

      {tab === 'affiliates' && (
        <>
          {affiliates.length === 0 ? (
            <div className="bg-zinc-900/50 rounded-xl p-8 text-center">
              <p className="text-zinc-500">No affiliates yet</p>
              <p className="text-zinc-600 text-sm mt-1">Share your affiliate signup link to get started</p>
            </div>
          ) : (
            <div className="bg-zinc-900/50 rounded-xl overflow-hidden">
              <div className="overflow-x-auto sm:overflow-visible">
                <table className="min-w-[600px] sm:min-w-0 w-full">
                  <thead>
                    <tr className="text-zinc-500 text-xs uppercase tracking-wider">
                      <th className="text-left px-4 py-3 font-medium">#</th>
                      <th className="text-left px-4 py-3 font-medium">Wallet</th>
                      <th className="text-left px-4 py-3 font-medium">Code</th>
                      <th className="text-right px-4 py-3 font-medium">Earned</th>
                      <th className="text-center px-4 py-3 font-medium">Active</th>
                    </tr>
                  </thead>
                  <tbody>
                    {paginatedAffiliates.map((aff) => {
                      const rank = getRank(aff.affiliate_id) as number;
                      const actualEarned = aff.actualEarned;
                      return (
                        <tr key={aff.affiliate_id} className="border-t border-zinc-800/50 hover:bg-zinc-800/30 transition">
                          <td className="px-4 py-3 text-sm">
  <span className="text-zinc-400">{rank}</span>
  {getRankIcon(rank)}
</td>
                          <td className="px-4 py-3">
                            <a
                              href={`https://livenet.xrpl.org/accounts/${aff.wallet}`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="font-mono text-sm text-zinc-300 hover:text-emerald-400 transition"
                            >
                              {formatWallet(aff.wallet)}
                            </a>
                          </td>
                          <td className="px-4 py-3">
                            <span className="font-mono text-sm text-zinc-400">{aff.referral_code}</span>
                          </td>
                          <td className="px-4 py-3 text-right">
                            <span className={`text-sm font-medium ${actualEarned > 0 ? 'text-emerald-400' : 'text-zinc-500'}`}>
                              {formatAmount(actualEarned)}
                            </span>
                          </td>
                          <td className="px-4 py-3 text-center">
                            <span className="inline-flex h-1.5 w-1.5 rounded-full bg-emerald-500 mx-auto"></span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {totalAffiliatePages > 1 && (
            <div className="flex items-center justify-between mt-4">
              <button
                onClick={() => setPage(p => Math.max(0, p - 1))}
                disabled={page === 0}
                className="text-sm text-zinc-500 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition"
              >
                ‚Üê Previous
              </button>
              <span className="text-sm text-zinc-500">
                Page {page + 1} of {totalAffiliatePages}
              </span>
              <button
                onClick={() => setPage(p => Math.min(totalAffiliatePages - 1, p + 1))}
                disabled={page >= totalAffiliatePages - 1}
                className="text-sm text-zinc-500 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition"
              >
                Next ‚Üí
              </button>
            </div>
          )}
        </>
      )}

      {tab === 'payments' && (
        <>
          {payments.length === 0 ? (
            <div className="bg-zinc-900/50 rounded-xl p-8 text-center">
              <p className="text-zinc-500">No payments yet</p>
              <p className="text-zinc-600 text-sm mt-1">Payments will appear here once orders complete</p>
            </div>
          ) : (
            <div className="bg-zinc-900/50 rounded-xl overflow-hidden">
              <div className="overflow-x-auto sm:overflow-visible">
                <table className="min-w-[600px] sm:min-w-0 w-full">
                  <thead>
                    <tr className="text-zinc-500 text-xs uppercase tracking-wider">
                      <th className="text-left px-4 py-3 font-medium">Order</th>
                      <th className="text-right px-4 py-3 font-medium">Total</th>
                      <th className="text-right px-4 py-3 font-medium">Commissions</th>
                      <th className="text-center px-4 py-3 font-medium">Mode</th>
                      <th className="text-right px-4 py-3 font-medium">Date</th>
                      <th className="text-right px-4 py-3 font-medium">TX</th>
                    </tr>
                  </thead>
                  <tbody>
                    {paginatedPayments.map((pay) => {
                      const commissionTotal = pay.payments
                        .filter(p => p.type !== 'platform_fee')
                        .reduce((sum, p) => sum + p.amount, 0);
                      const txCount = pay.tx_hashes?.length || 0;
                      const firstTx = pay.tx_hashes?.[0]?.tx_hash;
                      
                      return (
                        <tr key={pay.payout_id} className="border-t border-zinc-800/50 hover:bg-zinc-800/30 transition">
                          <td className="px-4 py-3">
                            <span className="font-mono text-sm text-zinc-300">{pay.order_id.slice(0, 8)}...</span>
                          </td>
                          <td className="px-4 py-3 text-right">
                            <span className="text-sm text-zinc-400">{formatAmount(pay.order_total)}</span>
                          </td>
                          <td className="px-4 py-3 text-right">
                            <span className="text-sm font-medium text-emerald-400">{formatAmount(commissionTotal)}</span>
                          </td>
                          <td className="px-4 py-3 text-center">
                            <span className={`text-xs px-2 py-1 rounded inline-flex items-center gap-1 ${
  pay.auto_signed 
    ? 'bg-emerald-500/20 text-emerald-400' 
    : 'bg-sky-500/20 text-sky-400'
}`}>
  {pay.auto_signed ? (
    <>
      <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
        <path d="M13 3L4 14h7v7l9-11h-7V3z"/>
      </svg>
      Auto
    </>
  ) : (
    <>
      <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
      Manual
    </>
  )}
</span>
                          </td>
                          <td className="px-4 py-3 text-right">
                            <span className="text-sm text-zinc-500">{formatDate(pay.paid_at)}</span>
                          </td>
                          <td className="px-4 py-3 text-right">
                            {firstTx ? (
                              <a
                                href={`https://livenet.xrpl.org/transactions/${firstTx}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-sm text-zinc-400 hover:text-emerald-400 transition font-mono"
                              >
                                {txCount > 1 ? `${txCount} txs` : `${firstTx.slice(0, 8)}...`}
                              </a>
                            ) : (
                              <span className="text-zinc-600 text-sm">-</span>
                            )}
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {totalPaymentPages > 1 && (
            <div className="flex items-center justify-between mt-4">
              <button
                onClick={() => setPage(p => Math.max(0, p - 1))}
                disabled={page === 0}
                className="text-sm text-zinc-500 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition"
              >
                ‚Üê Previous
              </button>
              <span className="text-sm text-zinc-500">
                Page {page + 1} of {totalPaymentPages}
              </span>
              <button
                onClick={() => setPage(p => Math.min(totalPaymentPages - 1, p + 1))}
                disabled={page >= totalPaymentPages - 1}
                className="text-sm text-zinc-500 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition"
              >
                Next ‚Üí
              </button>
            </div>
          )}
        </>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/SuccessMessage.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect, useState } from 'react';


// MARK: - Types & Interfaces
interface SuccessMessageProps {
  walletAddress?: string;
  loginMethod?: 'xaman' | 'crossmark' | 'web3auth' | null;
}


// MARK: - Component Definition
export default function SuccessMessage({ walletAddress, loginMethod }: SuccessMessageProps) {

// MARK: - State Management
  const [visible, setVisible] = useState(false);
  const [dismissed, setDismissed] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    // Fade in after mount
    const timer = setTimeout(() => setVisible(true), 100);
    return () => clearTimeout(timer);
  }, []);

 // Auto-hide after 5 seconds
useEffect(() => {
  const timer = setTimeout(() => setDismissed(true), 5000);
  return () => clearTimeout(timer);
}, []);

  if (dismissed) return null;


// MARK: - Main Render
  return (
    <div className={`relative overflow-hidden rounded-2xl mb-6 transition-opacity duration-700 ${visible ? 'opacity-100' : 'opacity-0'}`}>
      {/* Video Background */}
      <video
        autoPlay
        loop
        muted
        playsInline
        className="absolute inset-0 w-full h-full object-cover"
        style={{ filter: 'brightness(0.4)' }}
      >
        <source src="/successmessage.webm" type="video/webm" />
      </video>

      {/* Content Overlay */}
      <div className="relative z-10 p-8 flex flex-col items-center justify-center min-h-[280px]">
        {/* Animated Checkmark - Click to dismiss */}
        <button 

// MARK: - Event Handlers
          onClick={() => setDismissed(true)}
          className="mb-6 hover:scale-110 transition-transform cursor-pointer"
          title="Click to dismiss"
        >
          <svg className="w-20 h-20" viewBox="0 0 100 100">
            <defs>
              <linearGradient id="successGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stopColor="#10b981" />
                <stop offset="50%" stopColor="#3b82f6" />
                <stop offset="100%" stopColor="#8b5cf6" />
              </linearGradient>
            </defs>
            {/* Circle */}
            <circle
              cx="50"
              cy="50"
              r="45"
              fill="none"
              stroke="url(#successGradient)"
              strokeWidth="4"
              strokeLinecap="round"
              className="animate-[draw-circle_0.6s_ease-out_forwards]"
              style={{
                strokeDasharray: 283,
                strokeDashoffset: 283,
                animation: 'draw-circle 0.6s ease-out forwards'
              }}
            />
            {/* Checkmark */}
            <path
              d="M30 52 L45 67 L72 35"
              fill="none"
              stroke="url(#successGradient)"
              strokeWidth="5"
              strokeLinecap="round"
              strokeLinejoin="round"
              style={{
                strokeDasharray: 80,
                strokeDashoffset: 80,
                animation: 'draw-check 0.4s ease-out 0.5s forwards'
              }}
            />
          </svg>
        </button>

        {/* Success Text */}
        <h2 className="text-2xl font-bold text-white mb-2 text-center">Setup Complete!</h2>
        <p className="text-zinc-300 text-center mb-4">Your wallet is ready to receive payments</p>

        {/* Wallet Badge */}
        {walletAddress && (
          <div className="flex items-center gap-2 bg-white/10 backdrop-blur px-4 py-2 rounded-full">
            {loginMethod === 'xaman' && (
              <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-5 h-5 rounded" />
            )}
            {loginMethod === 'crossmark' && (
              <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-5 h-5 rounded" />
            )}
            {loginMethod === 'web3auth' && (
              <div className="w-5 h-5 bg-gradient-to-br from-emerald-500 to-sky-500 rounded flex items-center justify-center">
                <svg className="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" />
                </svg>
              </div>
            )}
            <code className="text-emerald-400 text-sm font-mono">
              {walletAddress.substring(0, 6)}...{walletAddress.slice(-4)}
            </code>
          </div>
        )}

        {/* Features Ready */}
        <div className="flex flex-wrap justify-center gap-3 mt-6">
          <div className="flex items-center gap-2 text-sm text-zinc-300">
            <svg className="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
            RLUSD Ready
          </div>
          <div className="flex items-center gap-2 text-sm text-zinc-300">
            <svg className="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
            USDC Ready
          </div>
          <div className="flex items-center gap-2 text-sm text-zinc-300">
            <svg className="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
            Tap-to-Pay
          </div>
        </div>
      </div>

      {/* CSS Keyframes */}
      <style jsx>{`
        @keyframes draw-circle {
          to {
            stroke-dashoffset: 0;
          }
        }
        @keyframes draw-check {
          to {
            stroke-dashoffset: 0;
          }
        }
      `}</style>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/TakePaymentHeader.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useRouter } from 'next/navigation';
import StaffSelector from '@/components/StaffSelector';


// MARK: - Types & Interfaces
interface TakePaymentHeaderProps {
  storeId: string | null;
  walletAddress: string | null;
  storeName: string;
  storeLogo: string | null;
  activeStaff: any | null;
  onStartTour: () => void;
  onShowLogoUpload: () => void;
  onShowStaffModal: () => void;
  onShowPendingPayments: () => void;
  onShowProductsManager: () => void;
  onStaffChange: (staff: any) => void;
}


// MARK: - Component Definition
export default function TakePaymentHeader({
  storeId,
  walletAddress,
  storeName,
  storeLogo,
  activeStaff,
  onStartTour,
  onShowLogoUpload,
  onShowStaffModal,
  onShowPendingPayments,
  onShowProductsManager,
  onStaffChange,
}: TakePaymentHeaderProps) {
  const router = useRouter();


// MARK: - Main Render
  return (
    <header className="sticky top-0 z-40 bg-gradient-to-r from-violet-500/20 via-purple-600/15 via-purple-800/10 to-black/20 backdrop-blur border-b border-violet-500/20">
      <div className="max-w-lg mx-auto sm:max-w-none sm:mx-0 w-full px-4 py-3 flex items-center justify-between">
        {/* Left - Home and Tour buttons */}
        <div className="flex items-center">
          <button
            id="tp-home-btn"

// MARK: - Event Handlers
            onClick={() => router.push('/dashboard')}
            className="text-zinc-400 hover:text-white transition p-2 active:scale-95 cursor-pointer"
            title="Dashboard"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
          </button>
          <button
            onClick={onStartTour}
            className="text-zinc-400 hover:text-emerald-400 transition p-2 active:scale-95 cursor-pointer"
            title="Take Tour"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
          </button>
        </div>

        {/* Center - Logo and Store Name */}
        <div className="flex items-center gap-2 landscape:ml-0 md:absolute md:left-1/2 md:-translate-x-1/2">
          <button
            id="tp-store-logo"
            onClick={onShowLogoUpload}
            className={`relative w-8 h-8 rounded-lg overflow-hidden transition flex-shrink-0 cursor-pointer ${
              storeLogo ? 'hover:opacity-80' : 'border border-zinc-700 hover:border-emerald-500'
            }`}
            title="Store logo"
          >
            {storeLogo ? (
              <img src={storeLogo} alt="Logo" className="w-full h-full object-cover" />
            ) : (
              <div className="w-full h-full bg-zinc-800 flex items-center justify-center">
                <svg className="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                </svg>
              </div>
            )}
          </button>
          <h1 className="text-lg font-bold truncate max-w-[120px] hidden landscape:block sm:block">{storeName}</h1>
        </div>

        {/* Right - Staff selector and icons */}
        <div id="tp-toolbar" className="flex items-center gap-1">
          {/* Staff Selector - Icon only on mobile, full on desktop */}
          {storeId && walletAddress && (
            <div id="tp-staff-selector" className="hidden lg:block">
              <StaffSelector
                storeId={storeId}
                walletAddress={walletAddress}
                onStaffChange={onStaffChange}
              />
            </div>
          )}
          {storeId && walletAddress && (
            <button
              onClick={onShowStaffModal}
              className="lg:hidden text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
              title={activeStaff?.name || 'Staff'}
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </button>
          )}

          {/* Analytics */}
          <div className="relative group">
            <button
              id="tp-analytics-btn"
              onClick={() => router.push('/analytics')}
              className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
            </button>
            <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
              Analytics
            </span>
          </div>

          {/* Pending Payments */}
          <div className="relative group">
            <button
              id="tp-pending-btn"
              onClick={onShowPendingPayments}
              className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </button>
            <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
              Pending Payments
            </span>
          </div>

          {/* Customer Display */}
          <div className="relative group">
            <button
              id="tp-display-btn"
              onClick={() => {
                const isPWA = window.matchMedia('(display-mode: standalone)').matches;
                if (isPWA) {
                  window.location.href = `/display?store=${storeId}`;
                } else {
                  window.open(`/display?store=${storeId}`, '_blank');
                }
              }}
              className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </button>
            <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
              Customer Display
            </span>
          </div>

          {/* Receipts */}
          <div className="relative group">
            <button
              id="tp-receipts-btn"
              onClick={() => router.push('/receipts?from=take-payment')}
              className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </button>
            <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
              Receipts
            </span>
          </div>

          {/* Add Products */}
          <div className="relative group">
            <button
              id="tp-products-btn"
              onClick={onShowProductsManager}
              className="text-zinc-400 hover:text-white transition p-2 active:scale-90 cursor-pointer"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
              </svg>
            </button>
            <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-zinc-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
              Add Products
            </span>
          </div>
        </div>
      </div>
    </header>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/TakePaymentTour.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { useEffect } from 'react';
import { useNextStep } from 'nextstepjs';


// MARK: - Types & Interfaces
interface TakePaymentTourProps {
  run: boolean;
  onComplete: () => void;
}

export const tourSteps = [
  {
    tour: 'takePayment',
    steps: [
      {
        icon: null,
        title: 'Welcome to Take Payment',
        content: 'This is your Point of Sale. Take payments from customers using NFC cards or QR codes. Let me show you around.',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Header Controls',
        content: 'Your quick access toolbar: Home button returns to dashboard, tap your logo to customize it for receipts and customer displays.',
        selector: '#tp-header',
        side: 'bottom' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Your Tools',
        content: 'Staff selector tracks who made each sale. Analytics shows your revenue. Pending payments shows unpaid links. Customer display opens a screen for customers. Receipts shows transaction history. The + button adds products to your catalog.',
        selector: '#tp-toolbar',
        side: 'bottom' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Payment Amount',
        content: 'The total amount to charge. This updates as you add items to the cart.',
        selector: '#tp-amount-display',
        side: 'bottom' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Products & Search',
        content: 'Search for products or tap them to add to the cart. Tap again to increase quantity. Add your first product using the + icon in the header.',
        selector: '#tp-products-area',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Tips',
        content: 'Enable tips to let customers add gratuity. Choose preset percentages or custom amounts.',
        selector: '#tp-tips-section',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Take Payment',
        content: 'Tap here when ready to collect payment. Shows QR code for scanning and enables NFC tap.',
        selector: '#tp-pay-btn',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Manual Entry',
        content: 'Enter a custom amount using the number pad instead of selecting products. Send Payment Link button will appear once you have items in your cart.',
        selector: '#tp-manual-btn',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Live Conversion',
        content: 'See the real-time RLUSD conversion rate from CoinGecko Pro. This will appear once you add your first product.',
        selector: '#tp-footer',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'You\'re Ready!',
        content: 'That covers the basics. Add products, take payments, and grow your business with instant crypto settlements.',
        side: 'top' as const,
        showControls: true,
        showSkip: false,
      },
    ],
  },
];


// MARK: - Component Definition
export default function TakePaymentTour({ run, onComplete }: TakePaymentTourProps) {
  const { startNextStep, closeNextStep } = useNextStep();


// MARK: - Hooks & Effects
  useEffect(() => {
    if (run) {
      console.log('Starting take payment tour...');
      try {
        closeNextStep();
      } catch (e) {
        // Ignore if no tour running
      }
      const timeout = setTimeout(() => {
        startNextStep('takePayment');
        // Save immediately when tour starts - user has seen it
        onComplete();
      }, 700);
      return () => clearTimeout(timeout);
    }
  }, [run]);

  return null;
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/TapToPaySettings.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect, useCallback } from 'react';


// MARK: - Types & Interfaces
interface TapToPaySettingsProps {
  walletAddress: string;
  loginMethod: string | null;
  socialProvider?: string | null;
  onAutoSignEnabled?: () => void;
}


// MARK: - Constants & Configuration

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1/nfc';

// Register sound device for sound payments
const registerSoundDevice = async (wallet: string) => {
  try {
    // Check if already registered
    const existingId = localStorage.getItem('yesallofus_sound_id');
    if (existingId) {
      console.log('üîä Sound device already registered:', existingId);
      return;
    }
    const soundId = 'snd_' + (crypto.randomUUID ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10));
    const secretKey = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
    localStorage.setItem('yesallofus_sound_id', soundId);
    localStorage.setItem('yesallofus_sound_secret', secretKey);
    await fetch('https://api.dltpays.com/nfc/api/v1/sound/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ wallet_address: wallet, sound_id: soundId, secret_key: secretKey })
    });
    console.log('üîä Sound device registered:', soundId);
  } catch (err) {
    console.warn('Sound registration failed:', err);
  }
};

export default function TapToPaySettings({ 
  walletAddress, 
  loginMethod, 
  socialProvider,
  onAutoSignEnabled 
}: TapToPaySettingsProps) {

// MARK: - State Management
  const [loading, setLoading] = useState(true);
  const [autoSignEnabled, setAutoSignEnabled] = useState(false);
  const [settingUp, setSettingUp] = useState(false);
  const [revoking, setRevoking] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  const [termsAccepted, setTermsAccepted] = useState(false);
  const [walletNotFunded, setWalletNotFunded] = useState(false);
  const [signerAddress, setSignerAddress] = useState<string | null>(null);
  
  // Customer limit is fixed at ¬£25 until KYC
  const MAX_TRANSACTION = 25;

  // Check if auto-sign is enabled for this customer (from XRPL - source of truth)
  const checkAutoSignStatus = useCallback(async () => {
    if (!walletAddress) return;
    
    setLoading(true);
    try {
      const res = await fetch(`${NFC_API_URL}/customer/autosign-status/${walletAddress}`);
      const data = await res.json();
      if (data.success) {
        // API now checks XRPL as source of truth
        setAutoSignEnabled(data.auto_signing_enabled || data.auto_sign_enabled || false);
        setWalletNotFunded(data.wallet_not_funded || false);
        setSignerAddress(data.signer_address || null);
      }
    } catch (err) {
      console.error('Failed to check auto-sign status:', err);
    }
    setLoading(false);
  }, [walletAddress]);


// MARK: - Hooks & Effects
  useEffect(() => {
    checkAutoSignStatus();
  }, [checkAutoSignStatus]);

  // Enable auto-sign for Web3Auth
  const enableAutoSignWeb3Auth = async () => {
    if (!termsAccepted) return;
    
    setSettingUp(true);
    setError(null);
    setSuccess(null);

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth || !web3auth.provider) {
        throw new Error('Web3Auth session not available. Please sign in again.');
      }

      // Get platform signer address from API
      const settingsRes = await fetch(`${NFC_API_URL}/customer/setup-autosign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const settingsData = await settingsRes.json();
      
      if (settingsData.error) {
        throw new Error(settingsData.error);
      }

      // Handle unfunded wallet
      if (settingsData.needs_funding) {
        setWalletNotFunded(true);
        throw new Error('Your wallet needs to be funded first. Please add at least 2 XRP.');
      }

      // If signer already exists, just verify
      if (settingsData.signer_exists) {
        setAutoSignEnabled(true);

      // Register sound device for sound payments
      try {
        const soundId = 'snd_' + (crypto.randomUUID ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10));
        const secretKey = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
        localStorage.setItem('yesallofus_sound_id', soundId);
        localStorage.setItem('yesallofus_sound_secret', secretKey);
        await fetch('https://api.dltpays.com/nfc/api/v1/sound/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet_address: walletAddress, sound_id: soundId, secret_key: secretKey })
        });
        console.log('üîä Sound device registered:', soundId);
      } catch (soundErr) {
        console.warn('Sound registration failed:', soundErr);
      }
        setSuccess('Tap-and-Pay is already enabled!');
        setSettingUp(false);
        return;
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) {
        throw new Error('Platform signer not configured');
      }

      // Build SignerListSet transaction
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 1,
        SignerEntries: [
          {
            SignerEntry: {
              Account: platformSignerAddress,
              SignerWeight: 1
            }
          }
        ]
      };

      // Sign and submit via Web3Auth
      const result = await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: {
          transaction: signerListSetTx
        }
      });

      console.log('SignerListSet result:', result);

      // Wait for ledger and verify
      await new Promise(resolve => setTimeout(resolve, 2000));
      await checkAutoSignStatus();

      setAutoSignEnabled(true);

      // Register sound device for sound payments
      try {
        const soundId = 'snd_' + (crypto.randomUUID ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10));
        const secretKey = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
        localStorage.setItem('yesallofus_sound_id', soundId);
        localStorage.setItem('yesallofus_sound_secret', secretKey);
        await fetch('https://api.dltpays.com/nfc/api/v1/sound/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet_address: walletAddress, sound_id: soundId, secret_key: secretKey })
        });
        console.log('üîä Sound device registered:', soundId);
      } catch (soundErr) {
        console.warn('Sound registration failed:', soundErr);
      }
      setSuccess('Tap-and-Pay enabled! You can now pay by tapping your NFC card or using sound payments.');
      await registerSoundDevice(walletAddress);
      setTermsAccepted(false);
      onAutoSignEnabled?.();

    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to enable Tap-and-Pay';
      setError(message);
    }
    setSettingUp(false);
  };

  // Enable auto-sign for Crossmark
  const enableAutoSignCrossmark = async () => {
    if (!termsAccepted) return;
    
    setSettingUp(true);
    setError(null);
    setSuccess(null);

    try {
      const sdk = (window as any).xrpl?.crossmark;
      if (!sdk) {
        throw new Error('Crossmark wallet not detected. Please install the browser extension.');
      }

      // Get platform signer address from API
      const settingsRes = await fetch(`${NFC_API_URL}/customer/setup-autosign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const settingsData = await settingsRes.json();

      if (settingsData.error) {
        throw new Error(settingsData.error);
      }

      if (settingsData.needs_funding) {
        setWalletNotFunded(true);
        throw new Error('Your wallet needs to be funded first. Please add at least 2 XRP.');
      }

      if (settingsData.signer_exists) {
        setAutoSignEnabled(true);

      // Register sound device for sound payments
      try {
        const soundId = 'snd_' + (crypto.randomUUID ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10));
        const secretKey = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
        localStorage.setItem('yesallofus_sound_id', soundId);
        localStorage.setItem('yesallofus_sound_secret', secretKey);
        await fetch('https://api.dltpays.com/nfc/api/v1/sound/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet_address: walletAddress, sound_id: soundId, secret_key: secretKey })
        });
        console.log('üîä Sound device registered:', soundId);
      } catch (soundErr) {
        console.warn('Sound registration failed:', soundErr);
      }
        setSuccess('Tap-and-Pay is already enabled!');
        setSettingUp(false);
        return;
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) {
        throw new Error('Platform signer not configured');
      }

      // Build and sign SignerListSet with Crossmark
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 1,
        SignerEntries: [
          {
            SignerEntry: {
              Account: platformSignerAddress,
              SignerWeight: 1
            }
          }
        ]
      };

      const result = await sdk.methods.signAndSubmitAndWait(signerListSetTx);
      console.log('Crossmark SignerListSet result:', result);

      // Wait and verify
      await new Promise(resolve => setTimeout(resolve, 2000));
      await checkAutoSignStatus();

      setAutoSignEnabled(true);

      // Register sound device for sound payments
      try {
        const soundId = 'snd_' + (crypto.randomUUID ? crypto.randomUUID().slice(0,8) : Math.random().toString(36).slice(2,10));
        const secretKey = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
        localStorage.setItem('yesallofus_sound_id', soundId);
        localStorage.setItem('yesallofus_sound_secret', secretKey);
        await fetch('https://api.dltpays.com/nfc/api/v1/sound/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet_address: walletAddress, sound_id: soundId, secret_key: secretKey })
        });
        console.log('üîä Sound device registered:', soundId);
      } catch (soundErr) {
        console.warn('Sound registration failed:', soundErr);
      }
      setSuccess('Tap-and-Pay enabled! You can now pay by tapping your NFC card or using sound payments.');
      await registerSoundDevice(walletAddress);
      setTermsAccepted(false);
      onAutoSignEnabled?.();

    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to enable Tap-and-Pay';
      setError(message);
    }
    setSettingUp(false);
  };

  // ============================================================
  // FIXED: Revoke auto-sign - now removes signer from XRPL
  // ============================================================
  const revokeAutoSign = async () => {
    if (!confirm('Disable Tap-and-Pay?\n\nThis will remove the auto-sign permission from the XRP Ledger. You will need to set it up again to use NFC payments.')) {
      return;
    }

    setRevoking(true);
    setError(null);
    setSuccess(null);

    try {
      // Step 1: Check with API if revoke is needed
      const revokeRes = await fetch(`${NFC_API_URL}/customer/revoke-autosign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet_address: walletAddress })
      });
      const revokeData = await revokeRes.json();

      if (!revokeData.success) {
        throw new Error(revokeData.error || 'Revoke request failed');
      }

      // Already revoked on XRPL
      if (revokeData.already_revoked) {
        setAutoSignEnabled(false);
        setSuccess('Tap-and-Pay has been disabled.');
        setRevoking(false);
        return;
      }

      // Step 2: Need to sign transaction to remove signer from XRPL
      if (revokeData.needs_signature) {
        // Build the revoke transaction (SignerListSet with SignerQuorum: 0)
        const revokeTx = {
          TransactionType: 'SignerListSet',
          Account: walletAddress,
          SignerQuorum: 0,
        };

        let txHash: string | null = null;

        // Sign based on login method
        if (loginMethod === 'web3auth') {
          const { getWeb3Auth } = await import('@/lib/web3auth');
          const web3auth = await getWeb3Auth();

          if (!web3auth || !web3auth.provider) {
            throw new Error('Web3Auth session expired. Please sign in again.');
          }

          const result = await web3auth.provider.request({
            method: 'xrpl_submitTransaction',
            params: { transaction: revokeTx }
          });

          txHash = (result as any)?.result?.hash || (result as any)?.hash || null;

        } else if (loginMethod === 'crossmark') {
          const sdk = (window as any).xrpl?.crossmark;
          if (!sdk) {
            throw new Error('Crossmark wallet not detected.');
          }

          const result = await sdk.methods.signAndSubmitAndWait(revokeTx);
          txHash = result?.response?.data?.resp?.result?.hash || null;

        } else {
          throw new Error('Please use Web3Auth or Crossmark to disable Tap-and-Pay');
        }

        // Step 3: Confirm revoke with backend
        await fetch(`${NFC_API_URL}/customer/confirm-revoke`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet_address: walletAddress,
            tx_hash: txHash
          })
        });

        // Wait for ledger and refresh status
        await new Promise(resolve => setTimeout(resolve, 2000));
        await checkAutoSignStatus();

        setSuccess('Tap-and-Pay disabled successfully.');
      }

    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to disable Tap-and-Pay';
      setError(message);
      console.error('Revoke error:', err);
    }
    setRevoking(false);
  };

  // Determine if user can enable auto-sign
  const canEnableAutoSign = loginMethod === 'web3auth' || loginMethod === 'crossmark';
  const isXaman = loginMethod === 'xaman' || (!loginMethod && !canEnableAutoSign);

  if (loading) {

// MARK: - Main Render
    return (
      <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6">
        <div className="flex items-center gap-3">
          <div className="w-5 h-5 border-2 border-zinc-500 border-t-white rounded-full animate-spin"></div>
          <span className="text-zinc-400">Loading Tap-and-Pay status...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <div className={`text-2xl ${autoSignEnabled ? '' : 'grayscale opacity-50'}`}>‚ö°</div>
          <div>
            <h3 className="text-lg font-bold">Tap-and-Pay</h3>
            <p className="text-zinc-500 text-sm">Pay instantly by tapping your NFC card</p>
          </div>
        </div>
        {/* Status Badge */}
        {autoSignEnabled && (
          <div className="px-3 py-1 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
            ‚úì ENABLED
          </div>
        )}
      </div>

      {/* Error */}
      {error && (
        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3 mb-4">
          <p className="text-red-400 text-sm">{error}</p>
          <button 

// MARK: - Event Handlers
            onClick={() => setError(null)} 
            className="text-red-400/60 hover:text-red-400 text-xs mt-1"
          >
            Dismiss
          </button>
        </div>
      )}

      {/* Success */}
      {success && (
        <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3 mb-4">
          <p className="text-emerald-400 text-sm">{success}</p>
          <button 
            onClick={() => setSuccess(null)} 
            className="text-emerald-400/60 hover:text-emerald-400 text-xs mt-1"
          >
            Dismiss
          </button>
        </div>
      )}

      {/* Wallet not funded warning */}
      {walletNotFunded && !autoSignEnabled && (
        <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mb-4">
          <div className="flex items-start gap-3">
            <span className="text-amber-400">‚ö†Ô∏è</span>
            <div>
              <p className="text-amber-400 font-medium text-sm">Wallet Not Activated</p>
              <p className="text-amber-400/70 text-xs mt-1">
                Your wallet needs at least 2 XRP to enable Tap-and-Pay.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Auto-sign enabled */}
      {autoSignEnabled ? (
        <div className="space-y-4">
          <div className="flex items-center justify-between p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
            <div className="flex items-center gap-3">
              <span className="text-emerald-400 text-xl">‚úì</span>
              <div>
                <p className="text-emerald-400 font-medium">Tap-and-Pay Active</p>
                <p className="text-zinc-500 text-sm">Max ¬£{MAX_TRANSACTION} per transaction</p>
              </div>
            </div>
          </div>

          {/* Signer info */}
          {signerAddress && (
            <div className="bg-zinc-800/50 rounded-lg p-3">
              <p className="text-zinc-500 text-xs mb-1">Platform Signer (on XRPL)</p>
              <p className="text-zinc-400 text-xs font-mono truncate">{signerAddress}</p>
            </div>
          )}

          <p className="text-zinc-500 text-sm">
            Tap your NFC card at any YesAllOfUs vendor to pay instantly.
          </p>

          {/* REVOKE BUTTON */}
          <button
            onClick={revokeAutoSign}
            disabled={revoking}
            className="w-full py-3 px-4 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 
                       text-red-400 rounded-lg font-semibold transition-all disabled:opacity-50 
                       disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {revoking ? (
              <>
                <div className="w-4 h-4 border-2 border-red-400 border-t-transparent rounded-full animate-spin" />
                Signing transaction...
              </>
            ) : (
              <>
                <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                Disable Tap-and-Pay
              </>
            )}
          </button>

          <p className="text-zinc-600 text-xs text-center">
            This will remove the signer from your wallet on the XRP Ledger
          </p>

          <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
            <p className="text-blue-400 text-sm">
              üí° <strong>Increase your limit:</strong> Complete KYC verification with TVVIN to increase your transaction limit. <span className="text-zinc-500">(Coming soon)</span>
            </p>
          </div>
        </div>
      ) : isXaman ? (
        /* Xaman user - show info message */
        <div className="space-y-4">
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4">
            <p className="text-amber-400 font-medium mb-2">‚ÑπÔ∏è Tap-and-Pay not available with Xaman</p>
            <p className="text-zinc-400 text-sm mb-3">
              To enable instant NFC payments, please sign in with:
            </p>
            <ul className="text-zinc-400 text-sm space-y-1">
              <li>‚Ä¢ <strong className="text-white">Social Login</strong> (Google, Apple, etc.) - Recommended</li>
              <li>‚Ä¢ <strong className="text-white">Crossmark</strong> browser extension</li>
            </ul>
          </div>

          <p className="text-zinc-500 text-sm">
            These options allow automatic payment signing without manual approval for each transaction.
          </p>
        </div>
      ) : (
        /* Web3Auth or Crossmark - show setup */
        <div className="space-y-4">
          <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
            <p className="text-blue-400 font-medium mb-2">‚ö° Enable instant NFC payments</p>
            <p className="text-zinc-400 text-sm">
              Allow payments up to <strong className="text-white">¬£{MAX_TRANSACTION}</strong> per transaction when you tap your NFC card at any vendor.
            </p>
          </div>

          {/* Security Notice */}
          <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
            <p className="text-orange-400 text-sm font-bold mb-2">‚ö†Ô∏è Security Notice</p>
            <p className="text-orange-300/90 text-sm mb-2">
              Enabling Tap-and-Pay adds YesAllOfUs as a signer on your wallet, allowing automatic RLUSD transactions up to ¬£{MAX_TRANSACTION}.
            </p>
            <ul className="text-orange-300/80 text-xs space-y-1">
              <li>‚Ä¢ Keep only small amounts in this wallet for daily spending</li>
              <li>‚Ä¢ You can disable Tap-and-Pay at any time</li>
              <li>‚Ä¢ Report lost/stolen cards immediately in your dashboard</li>
            </ul>
          </div>

          {/* Terms Checkbox */}
          <label className="flex items-start gap-3 p-3 bg-zinc-800/50 rounded-lg cursor-pointer">
            <input
              type="checkbox"
              checked={termsAccepted}
              onChange={(e) => setTermsAccepted(e.target.checked)}
              className="mt-1"
            />
            <span className="text-zinc-300 text-sm">
              I understand the risks and agree to the{' '}
              <a href="/terms" target="_blank" className="text-blue-400 hover:underline">Terms of Service</a>
            </span>
          </label>

          {/* Enable Button */}
          {loginMethod === 'web3auth' ? (
            <button
              onClick={enableAutoSignWeb3Auth}
              disabled={!termsAccepted || settingUp || walletNotFunded}
              className={`w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 ${
                termsAccepted && !settingUp && !walletNotFunded
                  ? 'bg-emerald-500 hover:bg-emerald-400 text-black'
                  : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
              }`}
            >
              {settingUp ? (
                <>
                  <span className="w-4 h-4 border-2 border-zinc-400 border-t-black rounded-full animate-spin"></span>
                  Signing transaction...
                </>
              ) : (
                <>‚ö° Enable Tap-and-Pay</>
              )}
            </button>
          ) : (
            <button
              onClick={enableAutoSignCrossmark}
              disabled={!termsAccepted || settingUp || walletNotFunded}
              className={`w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 ${
                termsAccepted && !settingUp && !walletNotFunded
                  ? 'bg-emerald-500 hover:bg-emerald-400 text-black'
                  : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
              }`}
            >
              {settingUp ? (
                <>
                  <span className="w-4 h-4 border-2 border-zinc-400 border-t-black rounded-full animate-spin"></span>
                  Signing transaction...
                </>
              ) : (
                <>üîê Enable Tap-and-Pay</>
              )}
            </button>
          )}

          {/* Refresh button */}
          <button
            onClick={checkAutoSignStatus}
            className="w-full py-2 text-zinc-500 hover:text-zinc-300 text-sm transition"
          >
            ‚Üª Refresh status
          </button>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/TipSelector.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Types & Interfaces
interface TipSelectorProps {
  amount: number;
  onTipChange: (tip: number) => void;
}

// Maximum tip amount to prevent accidental large tips

// MARK: - Constants & Configuration
const MAX_TIP = 999.99;


// MARK: - Component Definition
export default function TipSelector({ amount, onTipChange }: TipSelectorProps) {
  const [selectedPercent, setSelectedPercent] = useState<number | null>(null);

// MARK: - State Management
  const [customTip, setCustomTip] = useState('');

  const tipOptions = [
    { label: 'No tip', percent: 0 },
    { label: '10%', percent: 10 },
    { label: '15%', percent: 15 },
    { label: '20%', percent: 20 },
  ];


// MARK: - Event Handlers
  const handleTipSelect = (percent: number) => {
    setSelectedPercent(percent);
    setCustomTip('');
    const tipAmount = (amount * percent) / 100;
    onTipChange(tipAmount);
  };

  const handleCustomTip = (value: string) => {
    setCustomTip(value);
    setSelectedPercent(null);
    // Clamp tip between 0 and MAX_TIP to prevent accidental large tips
    const parsed = parseFloat(value) || 0;
    const tipAmount = Math.max(0, Math.min(parsed, MAX_TIP));
    onTipChange(tipAmount);
  };

  const currentTip = selectedPercent !== null 
    ? (amount * selectedPercent) / 100 
    : parseFloat(customTip) || 0;


// MARK: - Main Render
  return (
    <div className="bg-zinc-900/80 border border-zinc-800 rounded-2xl p-4 mb-4">
      <div className="flex items-center gap-2 mb-3">
        <svg className="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
        <span className="text-sm text-zinc-400">Add a tip?</span>
      </div>
      
      <div className="grid grid-cols-4 gap-2 mb-3">
        {tipOptions.map((option) => (
          <button
            key={option.percent}
            onClick={() => handleTipSelect(option.percent)}
            className={`py-2.5 px-3 rounded-xl text-sm font-medium transition ${
              selectedPercent === option.percent
                ? 'bg-emerald-500 text-black shadow-lg shadow-emerald-500/25'
                : 'bg-zinc-800 hover:bg-zinc-700 text-white'
            }`}
          >
            {option.label}
          </button>
        ))}
      </div>

      <div className="relative">
        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500 font-medium">¬£</span>
        <input
  type="number"
  placeholder="Custom amount"
  value={customTip}
  onChange={(e) => {
    setCustomTip(e.target.value);
    setSelectedPercent(null);
  }}
  onBlur={(e) => {
    const parsed = parseFloat(e.target.value) || 0;
    const tipAmount = Math.max(0, Math.min(parsed, MAX_TIP));
    onTipChange(tipAmount);
  }}
  onKeyDown={(e) => {
    if (e.key === 'Enter') {
      const parsed = parseFloat(customTip) || 0;
      const tipAmount = Math.max(0, Math.min(parsed, MAX_TIP));
      onTipChange(tipAmount);
      (e.target as HTMLInputElement).blur();
    }
  }}
  className="w-full bg-zinc-800 border border-zinc-700 rounded-xl pl-8 pr-4 py-2.5 text-white placeholder-zinc-500 focus:outline-none focus:border-emerald-500 text-sm transition"
  min="0"
  step="0.01"
/>
      </div>

      {currentTip > 0 && (
        <div className="mt-3 pt-3 border-t border-zinc-800 flex justify-between items-center">
          <span className="text-zinc-400 text-sm">Tip amount</span>
          <span className="text-emerald-400 font-bold">¬£{currentTip.toFixed(2)}</span>
        </div>
      )}
    </div>
  );
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/TopUpRLUSD.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';
import { QRCodeSVG } from 'qrcode.react';


// MARK: - Types & Interfaces
interface TopUpRLUSDProps {
  walletAddress: string;
  xrpBalance: number;
  rlusdBalance: number;
  showAmounts: boolean;
  onToggleAmounts: () => void;
  onRefresh?: () => Promise<void>;
  walletType?: 'xaman' | 'crossmark' | 'web3auth' | null;
}


// MARK: - Component Definition
export default function TopUpRLUSD({
  walletAddress,
  xrpBalance,
  rlusdBalance,
  showAmounts,
  onToggleAmounts,
  onRefresh,
  walletType,
}: TopUpRLUSDProps) {

// MARK: - State Management
  const [copied, setCopied] = useState(false);
  const [activeTab, setActiveTab] = useState<'card' | 'swap'>('card');
  const [showQR, setShowQR] = useState(false);
  const [refreshing, setRefreshing] = useState(false);


// MARK: - Event Handlers
  const handleRefresh = async () => {
    if (!onRefresh) return;
    
    setRefreshing(true);
    try {
      await onRefresh();
    } finally {
      setRefreshing(false);
    }
  };

  const copyAddress = () => {
    navigator.clipboard.writeText(walletAddress);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const cardOptions = [
    {
      name: 'Guardarian',
      url: `https://guardarian.com/buy-rlusd?address=${walletAddress}`,
      description: 'No KYC for small amounts',
      methods: ['visa', 'mastercard', 'googlepay', 'applepay'] as const,
      logo: '/guardarian-blue.svg',
    },
    {
      name: 'Transak',
      url: 'https://global.transak.com/',
      description: 'Global coverage',
      methods: ['visa', 'mastercard', 'googlepay', 'applepay'] as const,
      logo: '/transak.svg',
    },
  ];

  const swapOptions = [
    {
      name: 'XPMarket DEX',
      url: 'https://xpmarket.com/dex/XRP/RLUSD-rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De',
      description: 'Best liquidity, easy UI',
      recommended: true,
      logo: '/XPMarketLogo.png',
    },
    {
      name: 'Magnetic X',
      url: 'https://xmagnetic.org/dex/RLUSD%2BrMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De_XRP%2BXRP',
      description: 'Real-time spread analysis',
      recommended: false,
      logo: '/XMagneticWhitelogo.png',
    },
    {
      name: 'Sologenic DEX',
      url: 'https://sologenic.org',
      description: 'AMM liquidity pools',
      recommended: false,
      logo: '/Sologeniclogo1.svg',
    },
  ];

  const cexOptions = [
    { name: 'Bitstamp', url: 'https://www.bitstamp.net/markets/xrp/rlusd/', logo: '/Bitstamp.png' },
    { name: 'Uphold', url: 'https://uphold.com', logo: '/uphold.svg' },
    { name: 'Bitrue', url: 'https://www.bitrue.com', logo: '/Bitruewhitelogo-2.png' },
    { name: 'MEXC', url: 'https://www.mexc.com', logo: '/mexc-global-logo.png' },
  ];


// MARK: - Main Render
  return (
    <div className="space-y-6">
      {/* Low RLUSD balance warning */}
      {rlusdBalance < 10 && showAmounts && (
        <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
          <p className="text-yellow-400 text-sm">
            Warning: Low balance ‚Äî add RLUSD to continue paying affiliate commissions
          </p>
        </div>
      )}

      {/* Wallet address & controls */}
      <div className="bg-zinc-800/50 rounded-lg p-4">
        <div className="flex items-center gap-2 mb-3">
          {walletType === 'xaman' && (
            <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-5 h-5 rounded" />
          )}
          {walletType === 'crossmark' && (
            <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-5 h-5 rounded" />
          )}
          <p className="text-zinc-500 text-xs">Your payout wallet:</p>
        </div>

        <div className="flex flex-wrap items-center gap-2">
          <code className="text-emerald-400 text-sm font-mono flex-1 min-w-0 truncate">
            {walletAddress?.substring(0, 8)}...{walletAddress?.slice(-6)}
          </code>

          <button
            onClick={() => setShowQR(!showQR)}
            className="bg-zinc-700 hover:bg-zinc-600 px-3 py-1.5 rounded text-xs transition"
          >
            {showQR ? 'Hide QR' : 'Show QR'}
          </button>

          <button
            onClick={copyAddress}
            className="bg-zinc-700 hover:bg-zinc-600 px-3 py-1.5 rounded text-xs transition"
          >
            {copied ? 'Copied!' : 'Copy'}
          </button>
        </div>

        {showQR && (
          <div className="mt-5 text-center">
            <div className="inline-block bg-white p-4 rounded-lg">
              <QRCodeSVG value={walletAddress} size={180} level="M" />
            </div>
            <p className="text-zinc-500 text-xs mt-3">
              Scan to send XRP or RLUSD
            </p>
            <code className="text-emerald-400 text-xs font-mono mt-2 block break-all">
              {walletAddress}
            </code>
          </div>
        )}
      </div>

      {/* Tabs */}
      <div className="grid grid-cols-2 gap-2">
        <button
          onClick={() => setActiveTab('card')}
          className={`py-2.5 rounded-lg text-sm font-medium transition ${
            activeTab === 'card'
              ? 'bg-blue-600 text-white'
              : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'
          }`}
        >
          Buy with Card
        </button>
        <button
          onClick={() => setActiveTab('swap')}
          className={`py-2.5 rounded-lg text-sm font-medium transition ${
            activeTab === 'swap'
              ? 'bg-blue-600 text-white'
              : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'
          }`}
        >
          XRP ‚Üí RLUSD
        </button>
      </div>

      {/* Card Tab */}
      {activeTab === 'card' && (
        <div className="space-y-4">
          <p className="text-zinc-400 text-sm">
            Buy RLUSD instantly with card or mobile payment:
          </p>

          {cardOptions.map((option) => (
            <a
              key={option.name}
              href={option.url}
              target="_blank"
              rel="noopener noreferrer"
              className="block p-4 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4 flex-1">
                  <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center shrink-0">
                    <img
                      src={option.logo}
                      alt={option.name}
                      className="max-w-full max-h-full object-contain p-1"
                      onError={(e) => (e.currentTarget.style.display = 'none')}
                    />
                  </div>
                  <div>
                    <p className="font-medium text-white">{option.name}</p>
                    <p className="text-xs text-zinc-400">{option.description}</p>
                  </div>
                </div>
                <svg className="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
              </div>

              <div className="flex flex-wrap gap-2 mt-3">
                {option.methods.map((method) => (
                  <span key={method} className="text-xs bg-zinc-700 px-2 py-1 rounded">
                    {method === 'visa' && 'Visa'}
                    {method === 'mastercard' && 'Mastercard'}
                    {method === 'googlepay' && 'Google Pay'}
                    {method === 'applepay' && 'Apple Pay'}
                  </span>
                ))}
              </div>
            </a>
          ))}

          <p className="text-xs text-zinc-500 pt-2">
            RLUSD is sent directly to the wallet address shown above.
          </p>
        </div>
      )}

      {/* Swap Tab */}
      {activeTab === 'swap' && (
        <div className="space-y-5">
          {showAmounts && (
            <>
              {xrpBalance > 1.5 ? (
                <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3">
                  <p className="text-emerald-400 text-sm">
                    You have <strong>{xrpBalance.toFixed(2)} XRP</strong> ready to swap
                  </p>
                </div>
              ) : (
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                  <p className="text-yellow-400 text-sm">
                    Warning: Low XRP ‚Äî send more XRP first, then swap to RLUSD
                  </p>
                </div>
              )}
            </>
          )}

          <p className="text-zinc-400 text-sm">Swap on XRPL DEX (3‚Äì5 s settlement):</p>

          <div className="space-y-3">
            {swapOptions.map((option) => (
              <a
                key={option.name}
                href={option.url}
                target="_blank"
                rel="noopener noreferrer"
                className={`flex items-center justify-between p-4 rounded-lg transition ${
                  option.recommended
                    ? 'bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500/20'
                    : 'bg-zinc-800 hover:bg-zinc-700'
                }`}
              >
                <div className="flex items-center gap-4">
                  {option.logo && (
                    <img
                      src={option.logo}
                      alt={option.name}
                      className="w-10 h-10 object-contain rounded bg-white p-1"
                      onError={(e) => (e.currentTarget.style.display = 'none')}
                    />
                  )}
                  <div>
                    <div className="flex items-center gap-2">
                      <span className="font-medium text-white">{option.name}</span>
                      {option.recommended && (
                        <span className="bg-blue-600 text-white text-xs px-2 py-0.5 rounded">
                          Recommended
                        </span>
                      )}
                    </div>
                    <p className="text-xs text-zinc-400">{option.description}</p>
                  </div>
                </div>
                <svg className="w-5 h-5 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                </svg>
              </a>
            ))}
          </div>

          {/* CEX section */}
          <div className="border-t border-zinc-800 pt-5">
            <p className="text-xs text-zinc-500 mb-3">For larger amounts ‚Äî centralized exchanges:</p>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
              {cexOptions.map((ex) => (
                <a
                  key={ex.name}
                  href={ex.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 px-3 py-2 rounded-lg text-xs transition"
                >
                  {ex.logo && <img src={ex.logo} alt={ex.name} className="w-5 h-5 object-contain" />}
                  <span>{ex.name}</span>
                </a>
              ))}
            </div>
          </div>

          <div className="bg-zinc-800/50 rounded-lg p-4 text-sm">
            <p className="font-medium text-zinc-300 mb-2">How to swap:</p>
            <ol className="text-zinc-400 text-xs space-y-1 list-decimal list-inside">
              <li>Click one of the links above</li>
              <li>Connect your XRPL wallet</li>
              <li>Swap XRP to RLUSD</li>
              <li>Send RLUSD to the payout address shown at the top</li>
            </ol>
          </div>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/TourCard.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import type { CardComponentProps } from 'nextstepjs';


// MARK: - Component Definition
export default function TourCard({
  step,
  currentStep,
  totalSteps,
  nextStep,
  prevStep,
  skipTour,
  arrow,
}: CardComponentProps) {
  // Safety check - if step is undefined, return null
  if (!step) return null;

  const isFirst = currentStep === 0;
  const isLast = currentStep === totalSteps - 1;


// MARK: - Main Render
  return (
    <div className="w-80 bg-zinc-900 border border-zinc-700 rounded-xl p-5 shadow-2xl">
      {/* Progress */}
      <div className="flex items-center justify-between mb-3">
        <span className="text-xs text-zinc-500">
          {currentStep + 1} of {totalSteps}
        </span>
        {step.showSkip && (
          <button

// MARK: - Event Handlers
            onClick={skipTour}
            className="text-xs text-zinc-500 hover:text-white"
          >
            Skip
          </button>
        )}
      </div>

      {/* Progress bar */}
      <div className="h-1 bg-zinc-800 rounded-full mb-4">
        <div 
          className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 rounded-full"
          style={{ width: `${((currentStep + 1) / totalSteps) * 100}%` }}
        />
      </div>

      {/* Title */}
      <h3 className="text-white text-base font-semibold mb-2">{step.title}</h3>

      {/* Content */}
      <p className="text-zinc-400 text-sm leading-relaxed mb-5">
        {step.content}
      </p>

      {/* Navigation */}
      {step.showControls && (
        <div className="flex gap-3">
          {!isFirst && (
            <button
              onClick={prevStep}
              className="flex-1 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 rounded-lg text-sm font-medium"
            >
              Back
            </button>
          )}
          <button
            onClick={isLast ? skipTour : nextStep}
            className="flex-1 px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white rounded-lg text-sm font-semibold"
          >
            {isLast ? 'Done' : 'Next'}
          </button>
        </div>
      )}

      {arrow}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/TourProvider.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { NextStepProvider, NextStep } from 'nextstepjs';
import { tourSteps as affiliateTourSteps } from './AffiliateDashboardTour';
import { tourSteps as vendorTourSteps } from './VendorDashboardTour';
import TourCard from './TourCard';
import { tourSteps as takePaymentTourSteps } from './TakePaymentTour';

const allTourSteps = [...affiliateTourSteps, ...vendorTourSteps, ...takePaymentTourSteps];


// MARK: - Component Definition
export default function TourProvider({ children }: { children: React.ReactNode }) {

// MARK: - Main Render
  return (
    <NextStepProvider>
      <NextStep 
        steps={allTourSteps}
        cardComponent={TourCard}
        shadowRgb="0, 0, 0"
        shadowOpacity="0.8"
      >
        {children}
      </NextStep>
    </NextStepProvider>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/VendorDashboardTour.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useEffect } from 'react';
import { useNextStep } from 'nextstepjs';


// MARK: - Types & Interfaces
interface VendorDashboardTourProps {
  run: boolean;
  onComplete: () => void;
}

export const tourSteps = [
  {
    tour: 'vendorDashboard',
    steps: [
      {
        icon: null,
        title: 'Welcome to Your Vendor Dashboard',
        content: 'Manage your store, track sales, and grow your affiliate network. Let me show you around.',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: '‚Üê Sidebar Menu',
        content: 'Access all features from here. Look for the glowing tab on the left edge of your screen - tap it anytime to open the menu.',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Payout Method',
        content: 'Connect your wallet and set up how you pay affiliates. Choose between auto-sign for automatic payouts or manual approval.',
        selector: '#payout-method',
        side: 'bottom' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Take Payment',
        content: 'Your main POS button. Tap here to take payments from customers in person or generate payment links.',
        selector: '#take-payment-btn',
        side: 'bottom' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Top Up Wallet',
        content: 'Add funds to your wallet here. You need RLUSD to pay affiliate commissions.',
        selector: '#wallet-funding',
        side: 'left' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Withdraw Funds',
        content: 'Check your balance and withdraw RLUSD or XRP to another wallet.',
        selector: '#withdraw',
        side: 'left' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Pending Customers',
        content: 'See customers who signed up but haven\'t connected their wallets yet.',
        selector: '#pending-customers',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Commission Rates',
        content: 'Set how much affiliates earn at each level. Up to 5 levels of referral commissions.',
        selector: '#commission-rates',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Quick Links',
        content: 'Fast access to your most used features - Take Payment, Analytics, Receipts, Display mode, and Staff management.',
        selector: '#quick-links',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Affiliate Link',
        content: 'Share this link to recruit affiliates. They\'ll earn commissions when they refer customers.',
        selector: '#affiliate-link',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'Activity',
        content: 'View your recent transactions, payouts, and store activity all in one place.',
        selector: '#activity',
        side: 'top' as const,
        showControls: true,
        showSkip: true,
      },
      {
        icon: null,
        title: 'You\'re All Set!',
        content: 'That covers the basics. Use the sidebar menu to navigate, and check your progress to unlock all features.',
        side: 'top' as const,
        showControls: true,
        showSkip: false,
      },
    ],
  },
];


// MARK: - Component Definition
export default function VendorDashboardTour({ run, onComplete }: VendorDashboardTourProps) {
  const { startNextStep, closeNextStep, currentTour, currentStep } = useNextStep();


// MARK: - Hooks & Effects
  useEffect(() => {
    if (run) {
      console.log('Starting vendor tour...');
      
      try {
        closeNextStep();
      } catch (e) {
        // Ignore if no tour running
      }
      const timeout = setTimeout(() => {
        startNextStep('vendorDashboard');
        // Save immediately when tour starts - user has seen it
        onComplete();
      }, 700);
      return () => clearTimeout(timeout);
    }
  }, [run]);

  return null;
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/VolumeReminder.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';
import { motion } from 'framer-motion';


// MARK: - Types & Interfaces
interface VolumeReminderProps {
  className?: string;
}


// MARK: - Component Definition
export default function VolumeReminder({ className = '' }: VolumeReminderProps) {

// MARK: - Main Render
  return (
    <div className={`flex flex-col items-center justify-end ${className}`}>
      {/* Speaker with waves - fits space, facing UP */}
      <div className="relative w-24 h-44 flex flex-col items-center justify-end">
        {/* Sound waves going up */}
        <div className="absolute bottom-20 left-1/2 -translate-x-1/2">
          {[0, 1, 2].map((i) => (
            <motion.div
              key={i}
              className="absolute left-1/2 -translate-x-1/2 border-2 border-purple-500"
              style={{
                width: 30 + i * 20,
                height: 15 + i * 10,
                borderRadius: '50% 50% 0 0',
                borderBottom: 'none',
                bottom: i * 18,
              }}
              animate={{
                opacity: [0, 1, 0],
                y: [0, -15],
              }}
              transition={{
                duration: 1.2,
                repeat: Infinity,
                delay: i * 0.25,
                ease: 'easeOut',
              }}
            />
          ))}
        </div>
        {/* Speaker icon pointing UP (rotate -90deg) */}
        <svg
          className="w-20 h-20 text-purple-500"
          style={{ transform: 'rotate(-90deg)' }}
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
      </div>
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/WalletFunding.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';

// RLUSD is 5 chars, so must be hex-encoded (padded to 40 chars) for XRPL
const RLUSD_HEX = '524C555344000000000000000000000000000000';
const RLUSD_ISSUER = 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De';

const TRUSTED_EXCHANGES = [
  'binance',
  'gdax',
  'kraken',
  'kucoin',
  'bybit_spot',
  'bitstamp',
  'gemini',
  'crypto_com',
  'bitfinex',
  'okex',
  'huobi',
  'gate',
  'bitget',
  'bitvavo',
];

const FIAT_TARGETS = ['USD', 'EUR', 'GBP', 'AUD', 'CAD', 'USDT', 'USDC'];

// Exchange logo URLs (using CoinGecko/public CDNs)
const EXCHANGE_LOGOS: Record<string, string> = {
  'Binance': 'https://assets.coingecko.com/markets/images/52/small/binance.jpg',
  'Coinbase Exchange': 'https://assets.coingecko.com/markets/images/23/small/Coinbase_Coin_Primary.png',
  'Kraken': 'https://assets.coingecko.com/markets/images/29/small/kraken.jpg',
  'KuCoin': 'https://assets.coingecko.com/markets/images/61/small/kucoin.png',
  'Bybit': 'https://assets.coingecko.com/markets/images/698/small/bybit_spot.png',
  'Bitstamp': 'https://assets.coingecko.com/markets/images/9/small/bitstamp.jpg',
  'Gemini': 'https://assets.coingecko.com/markets/images/50/small/gemini.png',
  'Crypto.com Exchange': 'https://assets.coingecko.com/markets/images/589/small/crypto_com.jpg',
  'Bitfinex': 'https://assets.coingecko.com/markets/images/4/small/bitfinex.jpg',
  'OKX': 'https://assets.coingecko.com/markets/images/96/small/okx.png',
  'Huobi': 'https://assets.coingecko.com/markets/images/25/small/huobi.jpg',
  'Gate.io': 'https://assets.coingecko.com/markets/images/60/small/gate_io.jpg',
  'Bitget': 'https://assets.coingecko.com/markets/images/540/small/bitget.png',
  'Bitvavo': 'https://assets.coingecko.com/markets/images/505/small/bitvavo.png',
  'Uphold': 'https://assets.coingecko.com/markets/images/410/small/uphold.png',
  'MoonPay': 'https://assets.coingecko.com/markets/images/540/small/moonpay.png',
  'Changelly': 'https://assets.coingecko.com/markets/images/103/small/changelly.png',
  'ChangeNOW': 'https://assets.coingecko.com/markets/images/364/small/changenow.png',
  'Transak': 'https://assets.coingecko.com/markets/images/741/small/transak.png',
  'Guardarian': 'https://assets.coingecko.com/markets/images/651/small/guardarian.png',
  'Simplex': 'https://assets.coingecko.com/markets/images/496/small/simplex.png',
  'ChangeHero': 'https://assets.coingecko.com/markets/images/363/small/changehero.png',
};

// Inline SVG components for payment methods

// MARK: - Component Definition
const GooglePayIcon = () => (
  <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none">
    <path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z" fill="#4285F4"/>
  </svg>
);

const ApplePayIcon = () => (
  <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
    <path d="M7.078 23.55c-.473-.316-.893-.703-1.244-1.15-.383-.463-.738-.95-1.064-1.454-.766-1.12-1.365-2.345-1.78-3.636-.5-1.502-.743-2.94-.743-4.347 0-1.57.34-2.94 1.002-4.09.49-.9 1.22-1.653 2.1-2.182.85-.53 1.84-.82 2.84-.84.35 0 .73.05 1.13.15.29.08.64.21 1.07.37.55.21.85.34.95.37.32.12.59.17.8.17.16 0 .39-.05.645-.13.145-.05.42-.14.81-.31.386-.14.692-.26.935-.35.37-.11.728-.21 1.05-.26.39-.06.777-.08 1.148-.05.71.05 1.36.2 1.94.42 1.02.41 1.843 1.05 2.457 1.96-.26.16-.5.346-.725.55-.487.43-.9.94-1.23 1.505-.43.77-.65 1.64-.644 2.52.015 1.083.29 2.035.84 2.86.387.6.904 1.114 1.534 1.536.31.21.582.355.84.45-.12.375-.252.74-.405 1.1-.347.807-.76 1.58-1.25 2.31-.432.63-.772 1.1-1.03 1.41-.402.48-.79.84-1.18 1.097-.43.285-.935.436-1.452.436-.35.015-.7-.03-1.034-.127-.29-.095-.576-.202-.856-.323-.293-.134-.596-.248-.905-.34-.38-.1-.77-.148-1.164-.147-.4 0-.79.05-1.16.145-.31.088-.61.196-.907.325-.42.175-.695.29-.855.34-.324.096-.656.154-.99.175-.52 0-1.004-.15-1.486-.45zm6.854-18.46c-.68.34-1.326.484-1.973.436-.1-.646 0-1.31.27-2.037.24-.62.56-1.18 1-1.68.46-.52 1.01-.95 1.63-1.26.66-.34 1.29-.52 1.89-.55.08.68 0 1.35-.25 2.07-.228.64-.568 1.23-1 1.76-.435.52-.975.95-1.586 1.26z"/>
  </svg>
);

const VisaIcon = () => (
  <svg className="w-6 h-4" viewBox="0 0 48 16" fill="none">
    <path d="M17.545 1.027L11.636 14.973H7.91L5.036 3.927c-.173-.673-.327-.918-.855-1.2C3.29 2.254 1.827 1.782 0 1.473l.091-.446h6.182c.836 0 1.545.554 1.709 1.509l1.527 8.127 3.782-9.636h3.254zM34.727 10.218c.014-3.6-4.982-3.8-4.945-5.409.009-.491.473-.991 1.491-1.127.5-.064 1.882-.118 3.454.618l.618-2.873a9.46 9.46 0 00-3.273-.6c-3.455 0-5.882 1.836-5.909 4.464-.027 1.945 1.736 3.027 3.064 3.673 1.363.664 1.818 1.09 1.818 1.681-.009.909-1.091 1.309-2.1 1.327-1.764.027-2.782-.473-3.6-.855l-.636 2.973c.818.373 2.327.7 3.891.718 3.673 0 6.073-1.818 6.127-4.59zM44.145 14.973H47.2L44.527 1.027H41.6c-.709 0-1.309.409-1.573 1.045l-5.545 13.9h3.873l.764-2.118h4.727l.3 2.119zm-4.118-5.027l1.945-5.364 1.118 5.364h-3.063zM25.636 1.027l-2.836 13.946h-3.509l2.836-13.946h3.509z" fill="#1A1F71"/>
  </svg>
);

const MastercardIcon = () => (
  <svg className="w-6 h-4" viewBox="0 0 48 30" fill="none">
    <circle cx="18" cy="15" r="12" fill="#EB001B"/>
    <circle cx="30" cy="15" r="12" fill="#F79E1B"/>
    <path d="M24 5.6c2.8 2.2 4.6 5.6 4.6 9.4s-1.8 7.2-4.6 9.4c-2.8-2.2-4.6-5.6-4.6-9.4s1.8-7.2 4.6-9.4z" fill="#FF5F00"/>
  </svg>
);


// MARK: - Types & Interfaces
interface Exchange {
  name: string;
  url: string;
  target: string;
  price: number;
  supportsGooglePay: boolean;
  supportsApplePay: boolean;
  supportsVisa: boolean;
  supportsMastercard: boolean;
  logoUrl?: string;
}

interface WalletFundingProps {
  walletAddress: string;
  walletType?: 'xaman' | 'crossmark' | 'web3auth' | null;
  onFunded?: () => void;
  onTrustlineSet?: () => void;
}

export default function WalletFunding({
  walletAddress,
  walletType,
  onFunded,
  onTrustlineSet,
}: WalletFundingProps) {
  const [status, setStatus] = useState<'checking' | 'unfunded' | 'funded_no_trustline' | 'ready'>('checking');

// MARK: - State Management
  const [xrpBalance, setXrpBalance] = useState(0);
  const [rlusdBalance, setRlusdBalance] = useState(0);
  const [copied, setCopied] = useState(false);
  const [checking, setChecking] = useState(false);
  const [settingTrustline, setSettingTrustline] = useState(false);
  const [exchanges, setExchanges] = useState<Exchange[]>([]);
  const [showExchanges, setShowExchanges] = useState(false);
  const [loadingExchanges, setLoadingExchanges] = useState(false);
  // Re-authentication modal state
const [showReauthModal, setShowReauthModal] = useState(false);
const [reauthing, setReauthing] = useState(false);


// MARK: - Hooks & Effects
  useEffect(() => {
    if (walletAddress) {
      checkWalletStatus();
      fetchExchanges();
    }
  }, [walletAddress]);


// MARK: - API Calls & Data Fetching
  const getManualExchanges = (): Exchange[] => [
    {
      name: 'Uphold',
      url: 'https://uphold.com/assets/crypto/buy-xrp',
      target: 'USD',
      price: 0,
      supportsGooglePay: true,
      supportsApplePay: true,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['Uphold'],
    },
    {
      name: 'MoonPay',
      url: 'https://www.moonpay.com/buy/xrp',
      target: 'USD',
      price: 0,
      supportsGooglePay: true,
      supportsApplePay: true,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['MoonPay'],
    },
    {
      name: 'Changelly',
      url: 'https://changelly.com/buy/xrp',
      target: 'USD',
      price: 0,
      supportsGooglePay: false,
      supportsApplePay: false,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['Changelly'],
    },
    {
      name: 'ChangeNOW',
      url: 'https://changenow.io/buy/ripple',
      target: 'USD',
      price: 0,
      supportsGooglePay: false,
      supportsApplePay: false,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['ChangeNOW'],
    },
    {
      name: 'Transak',
      url: 'https://global.transak.com/?cryptoCurrencyCode=XRP',
      target: 'USD',
      price: 0,
      supportsGooglePay: true,
      supportsApplePay: true,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['Transak'],
    },
    {
      name: 'Guardarian',
      url: 'https://guardarian.com/buy-xrp',
      target: 'USD',
      price: 0,
      supportsGooglePay: false,
      supportsApplePay: true,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['Guardarian'],
    },
    {
      name: 'Simplex',
      url: 'https://www.simplex.com/',
      target: 'USD',
      price: 0,
      supportsGooglePay: false,
      supportsApplePay: true,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['Simplex'],
    },
    {
      name: 'ChangeHero',
      url: 'https://changehero.io/buy/xrp',
      target: 'USD',
      price: 0,
      supportsGooglePay: false,
      supportsApplePay: false,
      supportsVisa: true,
      supportsMastercard: true,
      logoUrl: EXCHANGE_LOGOS['ChangeHero'],
    },
  ];

  const fetchExchanges = async () => {
    setLoadingExchanges(true);
    try {
      const res = await fetch('/api/exchanges');
      const data = await res.json();

      const manualExchanges = getManualExchanges();

      if (data.tickers) {
        const filtered = data.tickers
          .filter((t: any) =>
            TRUSTED_EXCHANGES.includes(t.market.identifier) &&
            FIAT_TARGETS.includes(t.target) &&
            t.trade_url
          )
          .map((t: any) => ({
            name: t.market.name,
            url: t.trade_url,
            target: t.target,
            price: t.last,
            supportsGooglePay: false,
            supportsApplePay: false,
            supportsVisa: true,
            supportsMastercard: true,
            logoUrl: EXCHANGE_LOGOS[t.market.name] || null,
          }))
          .filter((exchange: Exchange, index: number, self: Exchange[]) =>
            index === self.findIndex((e) => e.name === exchange.name && e.target === exchange.target)
          )
          .sort((a: Exchange, b: Exchange) => a.name.localeCompare(b.name));

        setExchanges([...manualExchanges, ...filtered]);
      } else {
        setExchanges(manualExchanges);
      }
    } catch (err) {
      console.error('Failed to fetch exchanges:', err);
      setExchanges(getManualExchanges());
    } finally {
      setLoadingExchanges(false);
    }
  };

  const checkWalletStatus = async () => {
    setChecking(true);
    try {
      const res = await fetch(`${API_URL}/wallet/status/${walletAddress}`);
      const data = await res.json();

      if (data.success) {
        setXrpBalance(data.xrp_balance || 0);
        setRlusdBalance(data.rlusd_balance || 0);

        if (!data.funded) {
          setStatus('unfunded');
        } else if (!data.rlusd_trustline) {
          setStatus('funded_no_trustline');
          onFunded?.();
        } else {
          setStatus('ready');
          onFunded?.();
          onTrustlineSet?.();
        }
      }
    } catch (err) {
      console.error('Failed to check wallet status:', err);
    } finally {
      setChecking(false);
    }
  };

  const copyAddress = () => {
    navigator.clipboard.writeText(walletAddress);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const setTrustline = async () => {
  setSettingTrustline(true);
  try {
    const { getWeb3Auth } = await import('@/lib/web3auth');
    const web3auth = await getWeb3Auth();

    // Wait a moment for Web3Auth to fully initialize if needed
    if (web3auth && !web3auth.connected) {
      await new Promise(resolve => setTimeout(resolve, 500));
    }

    // Check if Web3Auth session is still active
    if (!web3auth?.connected || !web3auth?.provider) {
      setSettingTrustline(false);
      setShowReauthModal(true);
      return;
    }

      // Use hex-encoded RLUSD currency code (required for 5-char currency names)
      const trustlineTx = {
        TransactionType: 'TrustSet' as const,
        Account: walletAddress,
        LimitAmount: {
          currency: RLUSD_HEX,
          issuer: RLUSD_ISSUER,
          value: '1000000',
        },
      };

      const result = await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: trustlineTx },
      });

      console.log('Trustline set:', result);
      await checkWalletStatus();
    } catch (err: any) {
      console.error('Failed to set trustline:', err);
      alert(err.message || 'Failed to set trustline');
    } finally {
      setSettingTrustline(false);
    }
  };


// MARK: - Event Handlers
  const handleReauthAndRetry = async () => {
  setReauthing(true);
  try {
    const { getWeb3Auth } = await import('@/lib/web3auth');
    const web3auth = await getWeb3Auth();
    
    if (web3auth) {
      const provider = await web3auth.connect();
      
      // Only proceed if we got a provider back
      if (provider) {
        setShowReauthModal(false);
        // Small delay then retry
        setTimeout(() => setTrustline(), 500);
      } else {
        throw new Error('No provider returned');
      }
    }
  } catch (err) {
    console.error('Re-auth failed:', err);
    alert('Failed to reconnect. Please try again.');
  }
  setReauthing(false);
};

  // Loading state
  if (status === 'checking') {

// MARK: - Main Render
    return (
      <div className="bg-zinc-900/50 rounded-xl p-6">
        <div className="flex items-center justify-center gap-3">
          <span className="w-5 h-5 border-2 border-zinc-500 border-t-white rounded-full animate-spin"></span>
          <span className="text-zinc-400">Checking wallet status...</span>
        </div>
      </div>
    );
  }

  // Unfunded wallet
  if (status === 'unfunded') {
    return (
      <div className="bg-zinc-800/50 border border-zinc-700 rounded-xl p-6">
        <div className="flex items-start gap-4">
          <div className="text-3xl">üí∞</div>
          <div className="flex-1">
            <h3 className="text-lg font-bold text-white mb-2">Activate Your Wallet</h3>
            <p className="text-zinc-400 text-sm mb-4">
              Your wallet needs at least <strong className="text-white">1.5 XRP</strong> to be activated on the XRP Ledger
              and set up the RLUSD trustline.
              Send XRP from an exchange or another wallet.
            </p>

            <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 mb-4">
              <p className="text-blue-400 text-sm">
                <strong>Why 1.5 XRP?</strong> 1 XRP activates your wallet + 0.2 XRP reserves the RLUSD trustline + buffer for transaction fees.
              </p>
            </div>

            <div className="bg-zinc-900 rounded-lg p-4 mb-4">
              <p className="text-zinc-500 text-xs mb-2">Your wallet address:</p>
              <div className="flex items-center gap-2">
                <code className="text-emerald-400 text-sm font-mono flex-1">
                  {walletAddress.substring(0, 8)}...{walletAddress.slice(-6)}
                </code>
                <button
                  onClick={copyAddress}
                  className="bg-zinc-800 hover:bg-zinc-700 px-3 py-1.5 rounded text-sm transition shrink-0"
                >
                  {copied ? '‚úì Copied' : 'Copy'}
                </button>
              </div>
            </div>

            <div className="bg-white rounded-lg p-4 w-fit mx-auto mb-4">
              <img
                src={`https://api.qrserver.com/v1/create-qr-code/?size=128x128&data=${walletAddress}`}
                alt="Wallet QR Code"
                className="w-32 h-32"
              />
            </div>

            <div className="border-t border-zinc-800 pt-4 mt-4">
              <p className="text-zinc-500 text-xs mb-3">Buy XRP from an exchange:</p>
              <div className="relative">
                <button
                  onClick={() => setShowExchanges(!showExchanges)}
                  className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 px-4 rounded-lg font-medium transition flex items-center justify-center gap-2"
                >
                  <img src="/XRP-logo.webp" alt="XRP" className="w-5 h-5" />
                  <span>Buy XRP Now</span>
                  <svg
                    className={`w-5 h-5 transition-transform ${showExchanges ? 'rotate-180' : ''}`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                {showExchanges && (
                  <div className="absolute top-full left-0 right-0 mt-2 bg-zinc-800 border border-zinc-700 rounded-lg shadow-xl z-10 max-h-80 overflow-y-auto">
                    {loadingExchanges ? (
                      <div className="p-4 text-center text-zinc-400">
                        <span className="w-4 h-4 border-2 border-zinc-500 border-t-white rounded-full animate-spin inline-block mr-2"></span>
                        Loading exchanges...
                      </div>
                    ) : exchanges.length > 0 ? (
                      exchanges.map((exchange, i) => (
                        <a
                          key={`${exchange.name}-${exchange.target}-${i}`}
                          href={exchange.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center justify-between px-4 py-3 hover:bg-zinc-700 transition border-b border-zinc-700 last:border-0"
                        >
                          <div className="flex items-center gap-3">
                            {/* Exchange Logo */}
                            {exchange.logoUrl ? (
                              <img 
                                src={exchange.logoUrl} 
                                alt={exchange.name} 
                                className="w-6 h-6 rounded-full object-cover bg-white"
                                onError={(e) => {
                                  (e.target as HTMLImageElement).style.display = 'none';
                                }}
                              />
                            ) : (
                              <div className="w-6 h-6 rounded-full bg-zinc-600 flex items-center justify-center text-xs font-bold text-white">
                                {exchange.name.charAt(0)}
                              </div>
                            )}
                            <span className="text-white font-medium">{exchange.name}</span>
                            
                            {/* Payment Method Icons */}
                            <div className="flex items-center gap-1 ml-2">
                              {exchange.supportsGooglePay && (
                                <span title="Google Pay" className="opacity-70 hover:opacity-100">
                                  <GooglePayIcon />
                                </span>
                              )}
                              {exchange.supportsApplePay && (
                                <span title="Apple Pay" className="opacity-70 hover:opacity-100 text-white">
                                  <ApplePayIcon />
                                </span>
                              )}
                              {exchange.supportsVisa && (
                                <span title="Visa" className="opacity-70 hover:opacity-100">
                                  <VisaIcon />
                                </span>
                              )}
                              {exchange.supportsMastercard && (
                                <span title="Mastercard" className="opacity-70 hover:opacity-100">
                                  <MastercardIcon />
                                </span>
                              )}
                            </div>
                          </div>
                          <span className="text-zinc-400 text-sm">XRP/{exchange.target}</span>
                        </a>
                      ))
                    ) : (
                      <div className="p-4 text-center text-zinc-400">No exchanges available</div>
                    )}
                  </div>
                )}
              </div>

              <p className="text-zinc-600 text-xs mt-3 text-center">
                Buy at least 1.5 XRP on any exchange, then withdraw to your wallet address above.
              </p>
            </div>

            <button
              onClick={checkWalletStatus}
              disabled={checking}
              className="w-full mt-4 bg-zinc-800 hover:bg-zinc-700 text-white py-3 rounded-lg font-medium transition disabled:opacity-50"
            >
              {checking ? (
                <span className="flex items-center justify-center gap-2">
                  <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                  Checking...
                </span>
              ) : (
                "üîÑ I've sent XRP - Check again"
              )}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Funded but no trustline
  if (status === 'funded_no_trustline') {
    const needsMoreXrp = xrpBalance < 1.2;
    
    return (
      <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6">
        <div className="flex items-start gap-4">
          <div className="text-3xl">‚úÖ</div>
          <div className="flex-1">
            <h3 className="text-lg font-bold text-blue-400 mb-2">Wallet Activated!</h3>
            <p className="text-zinc-400 text-sm mb-4">
              Your wallet has <strong className="text-white">{xrpBalance.toFixed(2)} XRP</strong>.
              Now you need to enable <strong className="text-white">RLUSD</strong> to receive and send stablecoin payments.
            </p>

            {needsMoreXrp && (
              <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
                <p className="text-yellow-400 text-sm font-bold mb-1">‚ö†Ô∏è Need More XRP</p>
                <p className="text-yellow-300/80 text-sm">
                  Setting up a trustline requires 0.2 XRP reserve. You currently have {xrpBalance.toFixed(2)} XRP.
                  Please add at least {(1.3 - xrpBalance).toFixed(2)} more XRP to proceed.
                </p>
              </div>
            )}

            <div className="bg-zinc-900/50 rounded-lg p-4 mb-4">
              <p className="text-zinc-500 text-xs mb-2">What is a trustline?</p>
              <p className="text-zinc-400 text-sm">
                A trustline lets your wallet hold RLUSD (Ripple USD stablecoin). This is a one-time setup that costs ~0.2 XRP in reserve.
              </p>
            </div>

            {walletType === 'xaman' ? (
              <>
                <div className="bg-zinc-800/90 rounded-lg p-4 mb-4">
                  <div className="flex items-center gap-2 mb-2">
                    <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-6 h-6 rounded" />
                    <p className="text-zinc-300 text-sm font-medium">In Xaman app:</p>
                  </div>
                  <ol className="text-zinc-400 text-sm text-left space-y-1">
                    <li>1. Go to Settings ‚Üí Advanced ‚Üí Add Trustline</li>
                    <li>2. Search for <strong className="text-white">RLUSD</strong></li>
                    <li>3. Confirm the trustline transaction</li>
                  </ol>
                </div>
                
                <a 
                  href="/trustline"
                  target="_blank"
                  className="inline-block text-blue-400 hover:text-blue-300 text-sm transition mb-4"
                >
                  üìñ View Full Trustline Setup Guide
                </a>
                
                <button
                  onClick={checkWalletStatus}
                  disabled={checking}
                  className="w-full bg-yellow-500 hover:bg-yellow-400 text-black py-3 rounded-lg font-semibold transition disabled:opacity-50"
                >
                  {checking ? (
                    <span className="flex items-center justify-center gap-2">
                      <span className="w-4 h-4 border-2 border-black/30 border-t-black rounded-full animate-spin"></span>
                      Checking...
                    </span>
                  ) : (
                    "I've Added the Trustline ‚Üí Check Status"
                  )}
                </button>
              </>
            ) : (
              <button
                onClick={setTrustline}
                disabled={settingTrustline || needsMoreXrp}
                className="w-full bg-blue-500 hover:bg-blue-400 text-white py-3 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {settingTrustline ? (
                  <span className="flex items-center justify-center gap-2">
                    <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                    Setting up RLUSD...
                  </span>
                ) : needsMoreXrp ? (
                  '‚ö†Ô∏è Add more XRP first'
                ) : (
                  'üîì Enable RLUSD Trustline'
                )}
              </button>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Ready state
  if (status === 'ready') {
    return (
      <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6">
        <div className="flex items-start gap-4">
          <div className="text-3xl">üéâ</div>
          <div className="flex-1">
            <h3 className="text-lg font-bold text-emerald-400 mb-2">Wallet Ready!</h3>
            <p className="text-zinc-400 text-sm mb-4">
              Your wallet is fully set up and ready to receive affiliate payouts.
            </p>

            <div className="grid grid-cols-2 gap-4">
              <div className="bg-zinc-900/50 rounded-lg p-3">
                <p className="text-zinc-500 text-xs">XRP Balance</p>
                <p className="text-white font-bold">{xrpBalance.toFixed(2)} XRP</p>
              </div>
              <div className="bg-zinc-900/50 rounded-lg p-3">
                <p className="text-zinc-500 text-xs">RLUSD Balance</p>
                <p className="text-emerald-400 font-bold">${rlusdBalance.toFixed(2)}</p>
              </div>
            </div>

            {rlusdBalance < 10 && (
              <div className="mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                <p className="text-yellow-400 text-sm">
                  üí° You need RLUSD to pay affiliate commissions.{' '}
                  <a href="https://xrpl.org/decentralized-exchange.html" target="_blank" rel="noopener noreferrer" className="underline ml-1">
                    Swap XRP ‚Üí RLUSD on the DEX
                  </a>
                </p>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  {/* Re-authentication Modal */}
  if (showReauthModal) {
    return (
      <>
        {/* Show the current funding status underneath */}
        {status === 'funded_no_trustline' && (
          <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6 mb-4 opacity-50">
            <div className="flex items-start gap-4">
              <div className="text-3xl">‚úÖ</div>
              <div className="flex-1">
                <h3 className="text-lg font-bold text-blue-400 mb-2">Wallet Activated!</h3>
                <p className="text-zinc-400 text-sm">
                  Your wallet has <strong className="text-white">{xrpBalance.toFixed(2)} XRP</strong>.
                </p>
              </div>
            </div>
          </div>
        )}
        
        {/* Modal Overlay */}
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-zinc-900 border border-zinc-700 rounded-xl p-6 max-w-md w-full">
            <div className="text-center">
              <div className="text-4xl mb-4">üîê</div>
              <h3 className="text-xl font-bold text-white mb-3">Session Expired</h3>
              <p className="text-zinc-400 mb-4">
                For your security, social login sessions expire after you close the browser or after some time passes.
              </p>
              <p className="text-zinc-400 mb-6">
                Please sign in again with the <strong className="text-white">same social account</strong> to set up the RLUSD trustline.
              </p>
              
              <div className="space-y-3">
                <button
                  onClick={handleReauthAndRetry}
                  disabled={reauthing}
                  className="w-full bg-blue-500 hover:bg-blue-400 disabled:opacity-50 text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2"
                >
                  {reauthing ? (
                    <>
                      <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                      Connecting...
                    </>
                  ) : (
                    'üîë Sign In Again'
                  )}
                </button>
                
                <button
                  onClick={() => setShowReauthModal(false)}
                  className="w-full bg-zinc-800 hover:bg-zinc-700 text-zinc-300 font-medium py-3 px-6 rounded-lg transition"
                >
                  Cancel
                </button>
              </div>
              
              <p className="text-zinc-500 text-xs mt-4">
                Your wallet address and XRP balance are safe ‚Äî we just need to reconnect to sign the trustline transaction.
              </p>
            </div>
          </div>
        </div>
      </>
    );
  }

  return null;
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/WalletSettings.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState, useEffect } from 'react';
import { safeGetItem, safeSetItem, safeRemoveItem } from '@/lib/safeStorage';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';

// MARK: - Component Definition
const NFC_API_URL = 'https://api.dltpays.com/nfc/api/v1';


// MARK: - Types & Interfaces
interface WalletSettingsProps {
  walletAddress: string;
  loginMethod: string | null;
  socialProvider?: string | null;
  onWalletChange?: (newWallet: string, newMethod: string) => void;
  onDisconnect?: () => void;
}

// Social provider icon component
const SocialIcon = ({ provider, size = 'md' }: { provider: string | null; size?: 'sm' | 'md' }) => {
  const sizeClasses = size === 'sm' ? 'w-6 h-6' : 'w-8 h-8';
  const iconSize = size === 'sm' ? 'w-3.5 h-3.5' : 'w-5 h-5';
  
  switch (provider?.toLowerCase()) {
    case 'google':

// MARK: - Main Render
      return (
        <div className={`${sizeClasses} bg-white rounded-lg flex items-center justify-center`}>
          <svg className={iconSize} viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
        </div>
      );
    case 'apple':
      return (
        <div className={`${sizeClasses} bg-black rounded-lg flex items-center justify-center border border-zinc-700`}>
          <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
          </svg>
        </div>
      );
    case 'github':
      return (
        <div className={`${sizeClasses} bg-[#24292e] rounded-lg flex items-center justify-center`}>
          <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
          </svg>
        </div>
      );
    case 'discord':
      return (
        <div className={`${sizeClasses} bg-[#5865F2] rounded-lg flex items-center justify-center`}>
          <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
            <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
          </svg>
        </div>
      );
    case 'twitter':
      return (
        <div className={`${sizeClasses} bg-black rounded-lg flex items-center justify-center border border-zinc-700`}>
          <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </div>
      );
    case 'facebook':
      return (
        <div className={`${sizeClasses} bg-[#1877F2] rounded-lg flex items-center justify-center`}>
          <svg className={`${iconSize} text-white`} fill="currentColor" viewBox="0 0 24 24">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </div>
      );
    default:
      return (
        <div className={`${sizeClasses} bg-zinc-700 rounded-lg flex items-center justify-center`}>
          <svg className={`${iconSize} text-white`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
      );
  }
};

export default function WalletSettings({ 
  walletAddress, 
  loginMethod, 
  socialProvider,
  onWalletChange,
  onDisconnect 
}: WalletSettingsProps) {
  const [error, setError] = useState<string | null>(null);

// MARK: - State Management
  const [loading, setLoading] = useState(false);
  const [showAmounts, setShowAmounts] = useState(false);
  
  // Auto-sign state
  const [autoSignEnabled, setAutoSignEnabled] = useState(false);
  const [autoSignTermsAccepted, setAutoSignTermsAccepted] = useState(false);
  const [settingUpAutoSign, setSettingUpAutoSign] = useState(false);
  const [showRevokeModal, setShowRevokeModal] = useState(false);
  
  // Limits - ¬£25 max single payout cap for customers
  const [maxSinglePayout, setMaxSinglePayout] = useState(25);
  const [dailyLimit, setDailyLimit] = useState(100);
  
  // Wallet status
  const [walletFunded, setWalletFunded] = useState(false);
  const [hasTrustline, setHasTrustline] = useState(false);
  
  // Xaman connection state
  const [connectingXaman, setConnectingXaman] = useState(false);
  const [xamanQR, setXamanQR] = useState<string | null>(null);
  const [xamanDeepLink, setXamanDeepLink] = useState<string | null>(null);
  const [loginId, setLoginId] = useState<string | null>(null);

  // Check wallet and auto-sign status on mount

// MARK: - Hooks & Effects
  useEffect(() => {
    if (walletAddress) {
      checkWalletStatus();
      checkAutoSignStatus();
    }
  }, [walletAddress]);

  // Poll for Xaman login
  useEffect(() => {
    if (!loginId || !connectingXaman) return;

    const interval = setInterval(async () => {
      try {
        const res = await fetch(`${API_URL}/xaman/login/poll/${loginId}`);
        const data = await res.json();

        if (data.status === 'signed' && data.wallet_address) {
          clearInterval(interval);
          setConnectingXaman(false);
          setXamanQR(null);
          setLoginId(null);
          
          // Update to Xaman wallet
          safeSetItem('walletAddress', data.wallet_address);
          safeSetItem('loginMethod', 'xaman');
          safeRemoveItem('socialProvider');
          
          if (onWalletChange) {
            onWalletChange(data.wallet_address, 'xaman');
          }
        } else if (data.status === 'expired' || data.status === 'cancelled') {
          clearInterval(interval);
          setError(data.status === 'expired' ? 'QR code expired. Please try again.' : 'Connection cancelled.');
          setConnectingXaman(false);
          setXamanQR(null);
          setLoginId(null);
        }
      } catch (err) {
        console.error('Poll error:', err);
      }
    }, 3000);

    return () => clearInterval(interval);
  }, [loginId, connectingXaman, onWalletChange]);

  const checkWalletStatus = async () => {
    try {
      const res = await fetch(`${API_URL}/wallet/status/${walletAddress}`);
      const data = await res.json();
      if (data.success) {
        setWalletFunded(data.funded);
        setHasTrustline(data.rlusd_trustline);
      }
    } catch (err) {
      console.error('Failed to check wallet status:', err);
    }
  };

  const checkAutoSignStatus = async () => {
    try {
      // Check if signer is set up for this wallet
      const res = await fetch(`${NFC_API_URL}/customer/autosign-status/${walletAddress}`);
      const data = await res.json();
      if (data.success) {
        setAutoSignEnabled(data.auto_signing_enabled);
        if (data.max_single_payout) setMaxSinglePayout(data.max_single_payout);
        if (data.daily_limit) setDailyLimit(data.daily_limit);
      }
    } catch (err) {
      console.error('Failed to check auto-sign status:', err);
    }
  };

  // =========================================================================
  // SETUP AUTO-SIGN (Web3Auth) - Signs SignerListSet transaction
  // =========================================================================
  const setupAutoSignWeb3Auth = async () => {
    if (!walletAddress) return;

    setSettingUpAutoSign(true);
    setError(null);

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();
      
      if (!web3auth || !web3auth.provider) {
        throw new Error('Web3Auth session not available. Please sign in again.');
      }

      // Get platform signer address from API
      const settingsRes = await fetch(`${NFC_API_URL}/customer/setup-autosign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          wallet_address: walletAddress,
          max_single_payout: maxSinglePayout,
          daily_limit: dailyLimit
        })
      });
      const settingsData = await settingsRes.json();
      
      if (settingsData.error) {
        throw new Error(settingsData.error);
      }

      // Handle unfunded wallet
      if (settingsData.needs_funding) {
        setError('Your wallet needs to be funded first. Please add at least 2 XRP.');
        setSettingUpAutoSign(false);
        return;
      }

      // If signer already exists, just verify
      if (settingsData.signer_exists) {
        setAutoSignEnabled(true);
        setAutoSignTermsAccepted(false);
        setSettingUpAutoSign(false);
        return;
      }

      const platformSignerAddress = settingsData.platform_signer_address;
      if (!platformSignerAddress) {
        throw new Error('Platform signer not configured');
      }

      // Build SignerListSet transaction
      const signerListSetTx = {
        TransactionType: 'SignerListSet',
        Account: walletAddress,
        SignerQuorum: 1,
        SignerEntries: [
          {
            SignerEntry: {
              Account: platformSignerAddress,
              SignerWeight: 1
            }
          }
        ]
      };

      // Sign and submit via Web3Auth
      const result = await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: {
          transaction: signerListSetTx
        }
      });

      console.log('SignerListSet result:', result);

      // Verify the setup
      const verifyRes = await fetch(`${NFC_API_URL}/customer/verify-autosign/${walletAddress}`);
      const verifyData = await verifyRes.json();

      if (!verifyData.auto_signing_enabled) {
        throw new Error('Signer setup failed. Please try again.');
      }

      setAutoSignEnabled(true);
      setAutoSignTermsAccepted(false);

    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : 'Failed to enable auto-sign';
      setError(message);
    }
    setSettingUpAutoSign(false);
  };

  // =========================================================================
  // REVOKE AUTO-SIGN
  // =========================================================================
  const revokeAutoSign = async () => {
    setShowRevokeModal(false);
    setLoading(true);
    setError(null);
    
    try {
      const res = await fetch(`${NFC_API_URL}/customer/revoke-autosign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet_address: walletAddress
        })
      });

      const data = await res.json();
      if (data.success) {
        setAutoSignEnabled(false);
      } else {
        setError(data.error || 'Failed to revoke auto-sign');
      }
    } catch (err) {
      setError('Failed to revoke auto-sign');
    }
    setLoading(false);
  };

  // =========================================================================
  // SWITCH TO XAMAN (Manual payments)
  // =========================================================================
  const switchToXaman = async () => {
    setConnectingXaman(true);
    setError(null);

    try {
      const res = await fetch(`${API_URL}/xaman/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await res.json();
      if (data.error) {
        setError(data.error);
        setConnectingXaman(false);
        return;
      }

      setXamanQR(data.qr_png);
      setXamanDeepLink(data.deep_link);
      setLoginId(data.login_id);
    } catch (err) {
      setError('Failed to connect. Please try again.');
      setConnectingXaman(false);
    }
  };

  const cancelXamanConnection = () => {
    setConnectingXaman(false);
    setXamanQR(null);
    setXamanDeepLink(null);
    setLoginId(null);
  };

  const abbreviateWallet = (addr: string) => addr ? `${addr.slice(0, 8)}...${addr.slice(-6)}` : '';

  // Eye icon component
  const EyeIcon = ({ open }: { open: boolean }) => (
    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      {open ? (
        <>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </>
      ) : (
        <>
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
        </>
      )}
    </svg>
  );

  return (
    <div className="bg-zinc-900 border border-zinc-800 rounded-xl p-6 mb-6">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-lg font-bold">Payment Settings</h2>
        <button

// MARK: - Event Handlers
          onClick={() => setShowAmounts(!showAmounts)}
          className="text-zinc-400 hover:text-white transition-colors p-1"
          title={showAmounts ? 'Hide amounts' : 'Show amounts'}
        >
          <EyeIcon open={showAmounts} />
        </button>
      </div>

      {error && (
        <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
          <p className="text-red-400 text-sm">{error}</p>
          <button onClick={() => setError(null)} className="text-red-400 text-xs mt-2 hover:underline">Dismiss</button>
        </div>
      )}

      {/* ============================================================= */}
      {/* XAMAN QR CONNECTION SCREEN */}
      {/* ============================================================= */}
      {connectingXaman && xamanQR && (
        <div className="text-center">
          <p className="text-zinc-300 mb-4">Scan with Xaman app to switch to manual payments</p>
          <img src={xamanQR} alt="Xaman QR" className="mx-auto mb-4 rounded-lg max-w-[200px]" />
          <div className="flex items-center justify-center gap-2 text-zinc-500 text-sm mb-4">
            <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
            Waiting for signature...
          </div>
          {xamanDeepLink && (
            <a href={xamanDeepLink} className="text-sky-400 text-sm hover:underline block mb-4">
              Open in Xaman app ‚Üí
            </a>
          )}
          <button onClick={cancelXamanConnection} className="text-zinc-500 text-sm hover:text-white">
            ‚Üê Cancel
          </button>
        </div>
      )}

      {/* ============================================================= */}
      {/* CURRENT STATUS */}
      {/* ============================================================= */}
      {!connectingXaman && (
        <>
          {/* Auto-sign enabled */}
          {autoSignEnabled ? (
            <div className="space-y-4">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-zinc-800/50 border border-zinc-700 rounded-lg">
                <div className="flex items-center gap-3">
                  {loginMethod === 'web3auth' ? (
                    <SocialIcon provider={socialProvider || null} />
                  ) : loginMethod === 'xaman' ? (
                    <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded" />
                  ) : (
                    <img src="/CrossmarkWalletlogo.jpeg" alt="Crossmark" className="w-8 h-8 rounded" />
                  )}
                  <div>
                    <div className="flex items-center gap-2">
                      <span className="text-green-500 text-sm" style={{ textShadow: '0 0 8px rgba(34,197,94,0.9)' }}>‚óè</span>
                      <span className="text-green-500 text-sm font-medium">Auto-Pay Active</span>
                    </div>
                    <p className="text-zinc-500 text-sm font-mono">{abbreviateWallet(walletAddress)}</p>
                  </div>
                </div>
                <button
                  onClick={() => setShowRevokeModal(true)}
                  disabled={loading}
                  className="text-zinc-400 hover:text-red-400 text-sm transition-colors whitespace-nowrap"
                >
                  Revoke Auto-Pay
                </button>
              </div>

              {/* Current limits display */}
              <div className="bg-zinc-800/30 rounded-lg p-4">
                <p className="text-zinc-400 text-sm mb-2">Current Limits</p>
                <div className="flex gap-6 text-sm">
                  <div>
                    <span className="text-zinc-500">Max per tap: </span>
                    <span className="text-white font-medium">{showAmounts ? `¬£${maxSinglePayout}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span>
                  </div>
                  <div>
                    <span className="text-zinc-500">Daily limit: </span>
                    <span className="text-white font-medium">{showAmounts ? `¬£${dailyLimit}` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}</span>
                  </div>
                </div>
              </div>

              {/* Option to switch to manual */}
              <div className="border-t border-zinc-800 pt-4">
                <p className="text-zinc-400 text-sm mb-2">Prefer manual approval?</p>
                <button
                  onClick={switchToXaman}
                  className="text-sky-400 hover:text-sky-300 text-sm"
                >
                  Switch to Xaman for manual payments ‚Üí
                </button>
              </div>
            </div>
          ) : loginMethod === 'xaman' ? (
            /* Xaman connected - manual mode */
            <div className="space-y-4">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg">
                <div className="flex items-center gap-3">
                  <img src="/XamanWalletlogo.jpeg" alt="Xaman" className="w-8 h-8 rounded" />
                  <div>
                    <div className="flex items-center gap-2">
                      <span className="text-emerald-500 text-sm" style={{ textShadow: '0 0 8px rgba(16,185,129,0.9)' }}>‚óè</span>
                      <span className="text-emerald-500 text-sm font-medium">Manual Mode (Xaman)</span>
                    </div>
                    <p className="text-zinc-500 text-sm font-mono">{abbreviateWallet(walletAddress)}</p>
                  </div>
                </div>
              </div>

              <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                <p className="text-blue-400 text-sm">
                  üì± You'll receive a push notification in Xaman to approve each payment.
                </p>
              </div>

              {/* Can't enable auto-sign with Xaman - need Web3Auth */}
              <p className="text-zinc-500 text-xs">
                To enable auto-pay, sign in with a social account (Google, Apple, etc.) instead.
              </p>
            </div>
          ) : (
            /* Web3Auth connected but auto-sign not enabled - show setup */
            <div className="space-y-4">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg">
                <div className="flex items-center gap-3">
                  <SocialIcon provider={socialProvider || null} />
                  <div>
                    <div className="flex items-center gap-2">
                      <span className="text-yellow-500 text-sm" style={{ textShadow: '0 0 8px rgba(234,179,8,0.9)' }}>‚óè</span>
                      <span className="text-yellow-500 text-sm font-medium">Setup Required</span>
                    </div>
                    <p className="text-zinc-500 text-sm font-mono">{abbreviateWallet(walletAddress)}</p>
                  </div>
                </div>
              </div>

              {/* Wallet not ready warning */}
              {!walletFunded && (
                <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                  <p className="text-red-400 text-sm font-medium">‚ö†Ô∏è Wallet Not Funded</p>
                  <p className="text-zinc-400 text-sm mt-1">
                    Your wallet needs at least 2 XRP to enable auto-pay. Fund your wallet first.
                  </p>
                </div>
              )}

              {walletFunded && !hasTrustline && (
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-yellow-400 text-sm font-medium">‚ö†Ô∏è RLUSD Trustline Required</p>
                  <p className="text-zinc-400 text-sm mt-1">
                    Add the RLUSD trustline to receive payments.
                  </p>
                </div>
              )}

              {/* Auto-sign setup section */}
              {walletFunded && hasTrustline && (
                <>
                  <h3 className="text-md font-semibold text-white">Enable Auto-Pay</h3>
                  <p className="text-zinc-400 text-sm">
                    Automatically approve tap-to-pay transactions up to your set limits.
                  </p>

                  {/* Security Notice */}
                  <div className="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4">
                    <p className="text-orange-400 text-sm font-bold mb-2">‚ö†Ô∏è Security Notice</p>
                    <p className="text-orange-300/90 text-sm mb-2">
                      Auto-pay allows YesAllofUs to process RLUSD payments from your wallet automatically.
                    </p>
                    <ul className="text-orange-300/80 text-xs space-y-1">
                      <li>‚Ä¢ Payments are capped at ¬£25 per transaction</li>
                      <li>‚Ä¢ You can set a daily spending limit</li>
                      <li>‚Ä¢ Revoke anytime from this settings page</li>
                    </ul>
                  </div>

                  {/* Limits */}
                  <div className="flex gap-4">
                    <div className="flex-1 min-w-0">
                      <label className="text-zinc-400 text-xs block mb-1">Max per tap (¬£)</label>
                      <input
                        type="number"
                        min="1"
                        max="25"
                        value={maxSinglePayout}
                        onChange={(e) => setMaxSinglePayout(Math.min(25, parseInt(e.target.value) || 25))}
                        className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-white"
                      />
                      <p className="text-zinc-600 text-xs mt-1">Max ¬£25</p>
                    </div>
                    <div className="flex-1 min-w-0">
                      <label className="text-zinc-400 text-xs block mb-1">Daily limit (¬£)</label>
                      <input
                        type="number"
                        min="10"
                        max="500"
                        value={dailyLimit}
                        onChange={(e) => setDailyLimit(parseInt(e.target.value) || 100)}
                        className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-white"
                      />
                    </div>
                  </div>

                  {/* Terms Checkbox */}
                  <label className="flex items-start gap-3 p-3 bg-zinc-800/50 rounded-lg cursor-pointer">
                    <input
                      type="checkbox"
                      checked={autoSignTermsAccepted}
                      onChange={(e) => setAutoSignTermsAccepted(e.target.checked)}
                      className="mt-1"
                    />
                    <span className="text-zinc-300 text-sm">
                      I understand that enabling auto-pay allows automatic transactions up to my set limits. I can revoke this at any time.
                    </span>
                  </label>

                  {/* Setup Button */}
                  <button
                    onClick={setupAutoSignWeb3Auth}
                    disabled={!autoSignTermsAccepted || settingUpAutoSign}
                    className={`w-full py-3 rounded-lg font-semibold transition ${
                      autoSignTermsAccepted
                        ? 'bg-emerald-500 hover:bg-emerald-400 text-black'
                        : 'bg-zinc-700 text-zinc-500 cursor-not-allowed'
                    }`}
                  >
                    {settingUpAutoSign ? (
                      <span className="flex items-center justify-center gap-2">
                        <span className="w-4 h-4 border-2 border-black/30 border-t-black rounded-full animate-spin"></span>
                        Setting up...
                      </span>
                    ) : (
                      'üîê Enable Auto-Pay'
                    )}
                  </button>
                </>
              )}

              {/* Option to use Xaman instead */}
              <div className="border-t border-zinc-800 pt-4">
                <p className="text-zinc-400 text-sm mb-2">Prefer manual approval for each payment?</p>
                <button
                  onClick={switchToXaman}
                  className="text-sky-400 hover:text-sky-300 text-sm"
                >
                  Switch to Xaman wallet ‚Üí
                </button>
              </div>
            </div>
          )}
        </>
      )}

      {/* Revoke Auto-Pay Modal */}
      {showRevokeModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          {/* Backdrop */}
          <div 
            className="absolute inset-0 bg-black/70 backdrop-blur-sm"
            onClick={() => setShowRevokeModal(false)}
          />
          
          {/* Modal */}
          <div className="relative bg-zinc-900 border border-zinc-700 rounded-2xl p-6 max-w-md w-full shadow-2xl">
            {/* Icon */}
            <div className="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            
            {/* Content */}
            <h3 className="text-xl font-bold text-white text-center mb-2">Disable Auto-Pay?</h3>
            <p className="text-zinc-400 text-center mb-6">
              You will need to manually approve each payment with Xaman. You can re-enable auto-pay anytime.
            </p>
            
            {/* Actions */}
            <div className="flex gap-3">
              <button
                onClick={() => setShowRevokeModal(false)}
                className="flex-1 px-4 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl font-medium transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={revokeAutoSign}
                disabled={loading}
                className="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors disabled:opacity-50"
              >
                {loading ? 'Disabling...' : 'Disable Auto-Pay'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/components/WithdrawRLUSD.tsx
// =================================================
// MARK: - Imports & Dependencies
'use client';

import { useState } from 'react';


// MARK: - Constants & Configuration
const RLUSD_HEX = '524C555344000000000000000000000000000000';
const RLUSD_ISSUER = 'rMxCKbEDwqr76QuheSUMdEGf4B9xJ8m5De';


// MARK: - Types & Interfaces
interface WithdrawRLUSDProps {
  walletAddress: string;
  rlusdBalance: number;
  loginMethod?: 'xaman' | 'crossmark' | 'web3auth' | null;
  showAmounts: boolean;
  onToggleAmounts: () => void;
  onRefresh: () => Promise<void>;
  onSuccess?: () => void;
}


// MARK: - Component Definition
export default function WithdrawRLUSD({ 
  walletAddress, 
  rlusdBalance, 
  loginMethod,
  showAmounts,
  onToggleAmounts,
  onRefresh,
  onSuccess 
}: WithdrawRLUSDProps) {

// MARK: - State Management
  const [destinationAddress, setDestinationAddress] = useState('');
  const [amount, setAmount] = useState('');
  const [sending, setSending] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);


// MARK: - Event Handlers
  const handleRefresh = async () => {
    setRefreshing(true);
    try {
      await onRefresh();
    } finally {
      setRefreshing(false);
    }
  };

  const validateXRPAddress = (address: string): boolean => {
    return /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/.test(address);
  };

  const handleWithdraw = async () => {
    setError(null);
    setSuccess(null);

    // Validate destination
    if (!destinationAddress) {
      setError('Please enter a destination address');
      return;
    }

    if (!validateXRPAddress(destinationAddress)) {
      setError('Invalid XRP Ledger address');
      return;
    }

    if (destinationAddress === walletAddress) {
      setError("Can't send to yourself");
      return;
    }

    // Validate amount
    const amountNum = parseFloat(amount);
    if (!amount || isNaN(amountNum) || amountNum <= 0) {
      setError('Please enter a valid amount');
      return;
    }

    if (amountNum > rlusdBalance) {
      setError(`Insufficient balance. You have ${rlusdBalance.toFixed(2)} RLUSD`);
      return;
    }

    setSending(true);

    try {
      const { getWeb3Auth } = await import('@/lib/web3auth');
      const web3auth = await getWeb3Auth();

      if (!web3auth?.provider) {
        throw new Error('Web3Auth not connected. Please refresh and try again.');
      }

      // Build RLUSD payment transaction
      const paymentTx = {
        TransactionType: 'Payment',
        Account: walletAddress,
        Destination: destinationAddress,
        Amount: {
          currency: RLUSD_HEX,
          issuer: RLUSD_ISSUER,
          value: amountNum.toString(),
        },
      };

      const result = await web3auth.provider.request({
        method: 'xrpl_submitTransaction',
        params: { transaction: paymentTx },
      });

      console.log('Withdrawal result:', result);
      setSuccess(`Successfully sent ${amountNum.toFixed(2)} RLUSD to ${destinationAddress.substring(0, 8)}...${destinationAddress.slice(-6)}`);
      setAmount('');
      setDestinationAddress('');
      
      // Refresh balance after successful withdrawal
      await onRefresh();
      onSuccess?.();
    } catch (err: any) {
      console.error('Withdrawal failed:', err);
      setError(err.message || 'Withdrawal failed');
    } finally {
      setSending(false);
    }
  };

  const setMaxAmount = () => {
    setAmount(rlusdBalance.toString());
  };


// MARK: - Main Render
  return (
  <div>
    {/* Xaman Not Available Badge */}
    {loginMethod === 'xaman' && (
      <div className="flex items-center justify-center gap-2 mb-4 py-3 bg-amber-500/10 border border-amber-500/30 rounded-xl">
        <svg className="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span className="text-amber-400 text-sm font-medium">Not available for Xaman</span>
      </div>
    )}
    <div className={loginMethod === 'xaman' ? 'opacity-40 pointer-events-none' : ''}>
    <div className="flex items-center justify-end gap-2 mb-4">
      <div className="text-right">
        <p className="text-zinc-500 text-xs">Available</p>
        <p className="text-emerald-400 font-bold">
          {showAmounts ? `$${rlusdBalance.toFixed(2)} RLUSD` : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
        </p>
      </div>
          {/* Refresh button */}
          <button
            onClick={handleRefresh}
            disabled={refreshing}
            className="text-zinc-400 hover:text-white transition p-1 disabled:opacity-50"
            title="Refresh balance"
          >
            <svg 
              className={`w-5 h-5 ${refreshing ? 'animate-spin' : ''}`} 
              fill="none" 
              viewBox="0 0 24 24" 
              stroke="currentColor" 
              strokeWidth={2}
            >
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </button>
          {/* Eye toggle */}
          <button
            onClick={onToggleAmounts}
            className="text-zinc-400 hover:text-white transition p-1"
            title={showAmounts ? 'Hide balance' : 'Show balance'}
          >
            {showAmounts ? (
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            ) : (
              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
              </svg>
            )}
          </button>
        </div>

      <div className="space-y-4">
        {/* Destination Address */}
        <div>
          <label className="text-zinc-400 text-sm block mb-2">Destination Address</label>
          <input
            type="text"
            value={destinationAddress}
            onChange={(e) => setDestinationAddress(e.target.value.trim())}
            placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
            className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 text-white font-mono text-sm placeholder:text-zinc-600"
          />
          <p className="text-zinc-600 text-xs mt-1">
            Enter an XRP Ledger address with an RLUSD trustline
          </p>
        </div>

        {/* Amount */}
<div>
  <label className="text-zinc-400 text-sm block mb-2">Amount (RLUSD)</label>
  <div className="relative">
    <input
      type="number"
      value={amount}
      onChange={(e) => setAmount(e.target.value)}
      placeholder="0.00"
      min="0"
      step="0.01"
      className="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-3 pr-16 text-white"
    />
    <button
      onClick={setMaxAmount}
      className="absolute right-2 top-1/2 -translate-y-1/2 bg-zinc-600 hover:bg-zinc-500 px-3 py-1 rounded text-xs font-medium transition"
    >
      Max
    </button>
  </div>
</div>

        {/* Error Message */}
        {error && (
          <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-3">
            <p className="text-red-400 text-sm">{error}</p>
          </div>
        )}

        {/* Success Message */}
        {success && (
          <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-3">
            <p className="text-emerald-400 text-sm">{success}</p>
          </div>
        )}

        {/* Warning */}
        <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
          <p className="text-yellow-400 text-sm">
            ‚ö†Ô∏è Make sure the destination address has an RLUSD trustline, or the transaction will fail.
          </p>
        </div>

        {/* Submit Button */}
        <button
          onClick={handleWithdraw}
          disabled={sending || !destinationAddress || !amount || rlusdBalance === 0}
          className="w-full bg-emerald-500 hover:bg-emerald-400 disabled:bg-zinc-700 disabled:cursor-not-allowed text-white font-semibold py-3 rounded-lg transition"
        >
          {sending ? (
            <span className="flex items-center justify-center gap-2">
              <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
              Sending...
            </span>
          ) : (
            'Withdraw RLUSD'
        )}
      </button>
    </div>
    </div>
  </div>
);
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/lib/customerDisplay.ts
// =================================================

// MARK: - Types & Interfaces
interface CartItem {
  name: string;
  quantity: number;
  price: number;
  emoji?: string;
}

export type DisplayStatus = 'idle' | 'ready' | 'processing' | 'success' | 'error' | 'qr' | 'signup' | 'split_pending' | 'link_pending';


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/nfc/api/v1';

export async function updateCustomerDisplay(
  storeId: string,
  storeName: string,
  cart: any[],
  total: number,
  status: DisplayStatus,
  qrCode?: string | null,
  tip?: number,
  tipsEnabled?: boolean,
  vendorWallet?: string
) {
  try {
    await fetch(`${API_URL}/display/update`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        store_id: storeId,
        store_name: storeName,
        cart,
        total,
        status,
        qr_code: qrCode || null,
        tip: tip || 0,
        tips_enabled: tipsEnabled ?? false,
        vendor_wallet: vendorWallet || null
      })
    });
  } catch (error) {
    console.error('Failed to update display:', error);
  }
}

export async function clearCustomerDisplay(storeId: string, storeName: string) {
  await updateCustomerDisplay(storeId, storeName, [], 0, 'idle', null);
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/lib/foodIcons.tsx
// =================================================
// Food & Drink SVG Icon Library - 100 icons
// Free for commercial use, curated from open source libraries


// MARK: - Types & Interfaces
export interface FoodIcon {
  id: string;
  name: string;
  category: string;
  keywords: string[];
  svg: string;
}

export const foodIconCategories = [
  'Hot Drinks',
  'Cold Drinks',
  'Breakfast',
  'Lunch',
  'Snacks',
  'Desserts',
  'Fruits',
  'Meals',
  'Fast Food',
  'Other'
];

export const foodIcons: FoodIcon[] = [
  // ============ HOT DRINKS (10) ============
  {
    id: 'coffee-cup',
    name: 'Coffee Cup',
    category: 'Hot Drinks',
    keywords: ['coffee', 'latte', 'cappuccino', 'espresso', 'americano', 'flat white', 'mocha'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 8h1a4 4 0 010 8h-1M3 8h14v9a4 4 0 01-4 4H7a4 4 0 01-4-4V8zM6 1v3M10 1v3M14 1v3"/></svg>`
  },
  {
    id: 'coffee-bean',
    name: 'Coffee Bean',
    category: 'Hot Drinks',
    keywords: ['coffee', 'espresso', 'bean', 'roast'],
    svg: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C9.5 2 7.5 4 7.5 6.5c0 2 1.3 3.7 3 4.3V22h3v-11.2c1.7-.6 3-2.3 3-4.3C16.5 4 14.5 2 12 2zm0 7c-1.4 0-2.5-1.1-2.5-2.5S10.6 4 12 4s2.5 1.1 2.5 2.5S13.4 9 12 9z"/></svg>`
  },
  {
    id: 'tea-cup',
    name: 'Tea Cup',
    category: 'Hot Drinks',
    keywords: ['tea', 'chai', 'green tea', 'herbal'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 8h1a3 3 0 010 6h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><path d="M6 1c.5 1.5.5 3 0 4M10 1c.5 1.5.5 3 0 4M14 1c.5 1.5.5 3 0 4"/></svg>`
  },
  {
    id: 'teapot',
    name: 'Teapot',
    category: 'Hot Drinks',
    keywords: ['tea', 'pot', 'brew'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="10" cy="14" rx="7" ry="5"/><path d="M17 14h3a2 2 0 002-2v-1a2 2 0 00-2-2h-3M3 14l-1 5M10 9V6a2 2 0 012-2h0a2 2 0 012 2v3"/></svg>`
  },
  {
    id: 'hot-chocolate',
    name: 'Hot Chocolate',
    category: 'Hot Drinks',
    keywords: ['chocolate', 'cocoa', 'hot', 'marshmallow'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 8h1a4 4 0 010 8h-1M3 8h14v9a4 4 0 01-4 4H7a4 4 0 01-4-4V8z"/><circle cx="7" cy="5" r="1.5" fill="currentColor"/><circle cx="10" cy="4" r="1" fill="currentColor"/><circle cx="13" cy="5" r="1.5" fill="currentColor"/></svg>`
  },
  {
    id: 'matcha',
    name: 'Matcha',
    category: 'Hot Drinks',
    keywords: ['matcha', 'green tea', 'japanese'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 12h14l-2 9H7l-2-9z"/><ellipse cx="12" cy="12" rx="7" ry="2"/><path d="M8 8c0-2 1.8-4 4-4s4 2 4 4"/></svg>`
  },
  {
    id: 'espresso',
    name: 'Espresso',
    category: 'Hot Drinks',
    keywords: ['espresso', 'shot', 'coffee', 'strong'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 8h10v6a5 5 0 01-5 5h0a5 5 0 01-5-5V8z"/><path d="M17 10h2a2 2 0 010 4h-2"/><path d="M7 8c0-2 2-3 5-3s5 1 5 3"/></svg>`
  },
  {
    id: 'latte-art',
    name: 'Latte Art',
    category: 'Hot Drinks',
    keywords: ['latte', 'art', 'coffee', 'milk'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="10" rx="8" ry="3"/><path d="M4 10v5a8 8 0 0016 0v-5"/><path d="M12 10v2M9 11c1 1 2 1 3 0s2-1 3 0"/></svg>`
  },
  {
    id: 'cappuccino',
    name: 'Cappuccino',
    category: 'Hot Drinks',
    keywords: ['cappuccino', 'coffee', 'foam', 'italian'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 10h16v7a5 5 0 01-5 5h-6a5 5 0 01-5-5v-7z"/><path d="M4 10c0-3 3.5-5 8-5s8 2 8 5"/><ellipse cx="12" cy="10" rx="8" ry="2" fill="currentColor" opacity="0.2"/></svg>`
  },
  {
    id: 'mug',
    name: 'Mug',
    category: 'Hot Drinks',
    keywords: ['mug', 'cup', 'coffee', 'tea', 'drink'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 6h11v11a3 3 0 01-3 3H8a3 3 0 01-3-3V6z"/><path d="M16 9h2a2 2 0 012 2v1a2 2 0 01-2 2h-2"/></svg>`
  },
  {
    id: 'americano',
    name: 'Americano',
    category: 'Hot Drinks',
    keywords: ['americano', 'coffee', 'black', 'long'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="6" width="12" height="12" rx="2"/><path d="M8 4h8M8 20h8"/></svg>`
  },
  {
    id: 'flat-white',
    name: 'Flat White',
    category: 'Hot Drinks',
    keywords: ['flat white', 'coffee', 'milk', 'microfoam'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 8h12v8a4 4 0 01-4 4H10a4 4 0 01-4-4V8z"/><circle cx="12" cy="10" r="3" fill="currentColor" opacity="0.3"/></svg>`
  },
  {
    id: 'mocha',
    name: 'Mocha',
    category: 'Hot Drinks',
    keywords: ['mocha', 'chocolate', 'coffee', 'cocoa'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 8h10v9a4 4 0 01-4 4h-2a4 4 0 01-4-4V8z"/><path d="M9 5h6M11 3v4M13 3v4"/></svg>`
  },
  {
    id: 'herbal-tea',
    name: 'Herbal Tea',
    category: 'Hot Drinks',
    keywords: ['herbal', 'tea', 'infusion', 'chamomile'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 9h14v8a3 3 0 01-3 3H8a3 3 0 01-3-3V9z"/><path d="M9 4c1 2 2 3 3 3s2-1 3-3"/></svg>`
  },
  {
    id: 'turkish-coffee',
    name: 'Turkish Coffee',
    category: 'Hot Drinks',
    keywords: ['turkish', 'coffee', 'cezve', 'strong'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 4h8l-2 14H10L8 4z"/><path d="M10 18h4M9 8h6"/></svg>`
  },
  {
    id: 'chai-latte',
    name: 'Chai Latte',
    category: 'Hot Drinks',
    keywords: ['chai', 'latte', 'spiced', 'tea'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 7h12v10a3 3 0 01-3 3H9a3 3 0 01-3-3V7z"/><path d="M9 4l3 3 3-3"/></svg>`
  },
  {
    id: 'irish-coffee',
    name: 'Irish Coffee',
    category: 'Hot Drinks',
    keywords: ['irish', 'coffee', 'whiskey', 'cream'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 8h10v8a4 4 0 01-4 4h-2a4 4 0 01-4-4V8z"/><rect x="9" y="4" width="6" height="4" rx="2"/></svg>`
  },
  {
    id: 'affogato',
    name: 'Affogato',
    category: 'Hot Drinks',
    keywords: ['affogato', 'espresso', 'ice cream', 'dessert'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="16" r="5"/><path d="M12 11v-4M8 9l4-4 4 4"/></svg>`
  },
  {
    id: 'cortado',
    name: 'Cortado',
    category: 'Hot Drinks',
    keywords: ['cortado', 'coffee', 'espresso', 'milk'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="7" y="6" width="10" height="12" rx="2"/><path d="M9 4h6M11 18h2"/></svg>`
  },
  {
    id: 'bulletproof-coffee',
    name: 'Bulletproof Coffee',
    category: 'Hot Drinks',
    keywords: ['bulletproof', 'coffee', 'butter', 'mct'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 8h12v9a3 3 0 01-3 3H9a3 3 0 01-3-3V8z"/><circle cx="12" cy="10" r="2" fill="currentColor"/></svg>`
  },

  // ============ COLD DRINKS (10) ============
  {
    id: 'iced-coffee',
    name: 'Iced Coffee',
    category: 'Cold Drinks',
    keywords: ['iced', 'coffee', 'cold brew', 'frappe'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 4h12l-1 16H7L6 4z"/><path d="M6 4h12"/><rect x="8" y="8" width="3" height="3" rx="0.5"/><rect x="12" y="10" width="3" height="3" rx="0.5"/><rect x="9" y="13" width="3" height="3" rx="0.5"/></svg>`
  },
  {
    id: 'soda',
    name: 'Soda',
    category: 'Cold Drinks',
    keywords: ['soda', 'cola', 'fizzy', 'soft drink', 'pop'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2h8l1 20H7L8 2z"/><path d="M7 6h10"/><circle cx="10" cy="10" r="0.5" fill="currentColor"/><circle cx="14" cy="12" r="0.5" fill="currentColor"/><circle cx="11" cy="14" r="0.5" fill="currentColor"/><circle cx="13" cy="16" r="0.5" fill="currentColor"/></svg>`
  },
  {
    id: 'smoothie',
    name: 'Smoothie',
    category: 'Cold Drinks',
    keywords: ['smoothie', 'shake', 'blend', 'fruit'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 3h8l-1 18H9L8 3z"/><path d="M6 3h12"/><path d="M12 3v4"/><ellipse cx="12" cy="10" rx="3" ry="1.5"/></svg>`
  },
  {
    id: 'juice',
    name: 'Juice',
    category: 'Cold Drinks',
    keywords: ['juice', 'orange', 'apple', 'fresh'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 4h8v16H8V4z"/><path d="M8 4c0-1 1-2 4-2s4 1 4 2"/><path d="M8 10h8"/><circle cx="12" cy="14" r="2"/></svg>`
  },
  {
    id: 'milkshake',
    name: 'Milkshake',
    category: 'Cold Drinks',
    keywords: ['milkshake', 'shake', 'ice cream', 'dessert'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 8h10l-1 13H8L7 8z"/><path d="M7 8c0-3 2-5 5-5s5 2 5 5"/><circle cx="12" cy="5" r="2" fill="currentColor"/><path d="M12 8v10"/></svg>`
  },
  {
    id: 'water-bottle',
    name: 'Water Bottle',
    category: 'Cold Drinks',
    keywords: ['water', 'bottle', 'mineral', 'sparkling'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 2h6v3l2 2v13a2 2 0 01-2 2H9a2 2 0 01-2-2V7l2-2V2z"/><path d="M9 5h6"/><path d="M7 12h10"/></svg>`
  },
  {
    id: 'beer',
    name: 'Beer',
    category: 'Cold Drinks',
    keywords: ['beer', 'ale', 'lager', 'pint', 'draft'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 6h10v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6z"/><path d="M15 8h3a2 2 0 012 2v4a2 2 0 01-2 2h-3"/><path d="M5 6c0-2 2-3 5-3s5 1 5 3"/><path d="M5 9h10" opacity="0.5"/></svg>`
  },
  {
    id: 'wine',
    name: 'Wine',
    category: 'Cold Drinks',
    keywords: ['wine', 'red', 'white', 'glass', 'vino'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2h8l-1 8a4 4 0 01-3 3.9V20h4v2H8v-2h4v-6.1A4 4 0 019 10L8 2z"/><path d="M8 6h8"/></svg>`
  },
  {
    id: 'cocktail',
    name: 'Cocktail',
    category: 'Cold Drinks',
    keywords: ['cocktail', 'martini', 'drink', 'bar'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 3h12l-6 9v7h4v2H8v-2h4v-7L6 3z"/><path d="M6 6h12"/><circle cx="14" cy="5" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'lemonade',
    name: 'Lemonade',
    category: 'Cold Drinks',
    keywords: ['lemonade', 'lemon', 'citrus', 'fresh'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 6h10l-1 14H8L7 6z"/><path d="M5 6h14"/><circle cx="12" cy="11" r="2"/><path d="M12 9v-2"/></svg>`
  },
  {
    id: 'cold-brew',
    name: 'Cold Brew',
    category: 'Cold Drinks',
    keywords: ['cold brew', 'coffee', 'iced', 'concentrate'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="2"/><path d="M8 8h8M8 12h8"/></svg>`
  },
  {
    id: 'frappe',
    name: 'Frappe',
    category: 'Cold Drinks',
    keywords: ['frappe', 'coffee', 'whipped', 'blended'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 6h10l-2 14H9L7 6z"/><path d="M10 10c1 2 3 2 4 0"/></svg>`
  },
  {
    id: 'iced-tea',
    name: 'Iced Tea',
    category: 'Cold Drinks',
    keywords: ['iced tea', 'tea', 'lemon', 'cold'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="7" y="4" width="10" height="16" rx="3"/><circle cx="12" cy="14" r="2"/></svg>`
  },
  {
    id: 'bubble-tea',
    name: 'Bubble Tea',
    category: 'Cold Drinks',
    keywords: ['bubble', 'boba', 'pearls', 'tapioca'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="12" height="14" rx="2"/><circle cx="9" cy="16" r="2" fill="currentColor"/><circle cx="15" cy="16" r="2" fill="currentColor"/></svg>`
  },
  {
    id: 'energy-drink',
    name: 'Energy Drink',
    category: 'Cold Drinks',
    keywords: ['energy', 'drink', 'can', 'caffeine'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="2"/><path d="M9 8h6M9 12h6"/></svg>`
  },
  {
    id: 'mocktail',
    name: 'Mocktail',
    category: 'Cold Drinks',
    keywords: ['mocktail', 'non-alcoholic', 'cocktail', 'juice'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 4l-2 14h12l-2-14H8z"/><path d="M10 10l4 4M14 10l-4 4"/></svg>`
  },
  {
    id: 'sparkling-water',
    name: 'Sparkling Water',
    category: 'Cold Drinks',
    keywords: ['sparkling', 'water', 'carbonated', 'bubbles'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="7" y="4" width="10" height="16" rx="3"/><circle cx="10" cy="10" r="1" fill="currentColor"/><circle cx="14" cy="12" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'protein-shake',
    name: 'Protein Shake',
    category: 'Cold Drinks',
    keywords: ['protein', 'shake', 'gym', 'fitness'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 4h8v16H8V4z"/><path d="M10 8h4M10 12h4"/></svg>`
  },
  {
    id: 'horchata',
    name: 'Horchata',
    category: 'Cold Drinks',
    keywords: ['horchata', 'rice', 'cinnamon', 'mexican'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="7" y="5" width="10" height="14" rx="2"/><path d="M9 9c1 2 4 2 5 0"/></svg>`
  },
  {
    id: 'kombucha',
    name: 'Kombucha',
    category: 'Cold Drinks',
    keywords: ['kombucha', 'fermented', 'tea', 'probiotic'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="2"/><path d="M10 10c2 2 2 2 4 0"/></svg>`
  },

  // ============ BREAKFAST (10) ============
  {
    id: 'croissant',
    name: 'Croissant',
    category: 'Breakfast',
    keywords: ['croissant', 'pastry', 'french', 'bread'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 14c0-4 3-8 8-8s8 4 8 8c0 2-1 4-4 5H8c-3-1-4-3-4-5z"/><path d="M8 14c0-2 1.8-4 4-4s4 2 4 4"/></svg>`
  },
  {
    id: 'bagel',
    name: 'Bagel',
    category: 'Breakfast',
    keywords: ['bagel', 'bread', 'cream cheese'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="9" ry="6"/><ellipse cx="12" cy="12" rx="3" ry="2"/></svg>`
  },
  {
    id: 'toast',
    name: 'Toast',
    category: 'Breakfast',
    keywords: ['toast', 'bread', 'slice'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 5c0-2 3-3 7-3s7 1 7 3v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5z"/><path d="M8 10h8M8 14h8"/></svg>`
  },
  {
    id: 'pancakes',
    name: 'Pancakes',
    category: 'Breakfast',
    keywords: ['pancakes', 'pancake', 'breakfast', 'syrup'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="17" rx="8" ry="3"/><ellipse cx="12" cy="14" rx="7" ry="2.5"/><ellipse cx="12" cy="11" rx="6" ry="2"/><path d="M14 6c2 0 3 1 3 2s-1 2-3 2"/></svg>`
  },
  {
    id: 'waffle',
    name: 'Waffle',
    category: 'Breakfast',
    keywords: ['waffle', 'breakfast', 'belgian'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="6" width="16" height="12" rx="2"/><path d="M4 10h16M4 14h16M9 6v12M14 6v12"/></svg>`
  },
  {
    id: 'eggs',
    name: 'Eggs',
    category: 'Breakfast',
    keywords: ['eggs', 'fried', 'breakfast', 'sunny'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="13" rx="9" ry="7"/><circle cx="12" cy="13" r="3" fill="currentColor" opacity="0.3"/></svg>`
  },
  {
    id: 'bacon',
    name: 'Bacon',
    category: 'Breakfast',
    keywords: ['bacon', 'breakfast', 'meat', 'pork'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 6c2 0 3 2 5 2s3-2 5-2 3 2 5 2 3-2 3-2"/><path d="M3 11c2 0 3 2 5 2s3-2 5-2 3 2 5 2 3-2 3-2"/><path d="M3 16c2 0 3 2 5 2s3-2 5-2 3 2 5 2 3-2 3-2"/></svg>`
  },
  {
    id: 'cereal',
    name: 'Cereal',
    category: 'Breakfast',
    keywords: ['cereal', 'bowl', 'breakfast', 'milk'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 10c0 6 3 10 8 10s8-4 8-10"/><ellipse cx="12" cy="10" rx="8" ry="3"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="12" cy="13" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'yogurt',
    name: 'Yogurt',
    category: 'Breakfast',
    keywords: ['yogurt', 'yoghurt', 'dairy', 'breakfast'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 6h12v2l-1 13H7L6 8V6z"/><path d="M6 6c0-2 2-3 6-3s6 1 6 3"/><path d="M9 12c1.5 0 2 1 3 1s1.5-1 3-1"/></svg>`
  },
  {
    id: 'muffin',
    name: 'Muffin',
    category: 'Breakfast',
    keywords: ['muffin', 'breakfast', 'blueberry', 'baked'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 11h14l-2 10H7L5 11z"/><path d="M5 11c0-4 3-7 7-7s7 3 7 7"/><circle cx="10" cy="15" r="1" fill="currentColor"/><circle cx="14" cy="14" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'french-toast',
    name: 'French Toast',
    category: 'Breakfast',
    keywords: ['french toast', 'toast', 'cinnamon', 'breakfast'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="6" width="14" height="12" rx="2"/><path d="M8 8h8M8 12h8"/><path d="M7 4c2 0 3 2 3 4M17 4c-2 0-3 2-3 4"/></svg>`
  },
  {
    id: 'omelette',
    name: 'Omelette',
    category: 'Breakfast',
    keywords: ['omelette', 'omelet', 'eggs', 'folded'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="9" ry="6"/><path d="M6 14c2-3 10-3 12 0"/><circle cx="10" cy="12" r="1.5" fill="currentColor" opacity="0.4"/></svg>`
  },
  {
    id: 'granola',
    name: 'Granola',
    category: 'Breakfast',
    keywords: ['granola', 'oats', 'nuts', 'breakfast'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="8" ry="5"/><circle cx="9" cy="12" r="1.5" fill="currentColor"/><circle cx="15" cy="13" r="1" fill="currentColor"/><circle cx="11" cy="16" r="1" fill="currentColor"/><circle cx="13" cy="10" r="1.2" fill="currentColor"/></svg>`
  },
  {
    id: 'avocado-toast',
    name: 'Avocado Toast',
    category: 'Breakfast',
    keywords: ['avocado', 'toast', 'breakfast', 'healthy'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="6" width="14" height="12" rx="2"/><ellipse cx="12" cy="12" rx="5" ry="4" fill="currentColor" opacity="0.25"/></svg>`
  },
  {
    id: 'breakfast-burrito',
    name: 'Breakfast Burrito',
    category: 'Breakfast',
    keywords: ['burrito', 'breakfast', 'wrap', 'eggs'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="10" ry="5" transform="rotate(-15 12 12)"/><path d="M6 10c3 1 9 1 12 0"/></svg>`
  },

  // ============ LUNCH (10) ============
  {
    id: 'sandwich',
    name: 'Sandwich',
    category: 'Lunch',
    keywords: ['sandwich', 'sub', 'lunch', 'bread'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8c0-2 4-4 8-4s8 2 8 4v2H4V8z"/><path d="M4 14h16v2c0 2-4 4-8 4s-8-2-8-4v-2z"/><path d="M4 10h16v4H4z"/></svg>`
  },
  {
    id: 'wrap',
    name: 'Wrap',
    category: 'Lunch',
    keywords: ['wrap', 'burrito', 'tortilla'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0-5 4-9 9-9 3 0 5 1 6 3l-15 15c-2-2-3-5 0-9z"/><path d="M8 16l11-11"/></svg>`
  },
  {
    id: 'burger',
    name: 'Burger',
    category: 'Lunch',
    keywords: ['burger', 'hamburger', 'cheeseburger', 'fast food'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8c0-2 3-4 8-4s8 2 8 4H4z"/><path d="M4 16h16c0 2-3 4-8 4s-8-2-8-4z"/><rect x="3" y="11" width="18" height="2" rx="1"/><path d="M4 8v3h16V8"/><path d="M4 13v3h16v-3"/></svg>`
  },
  {
    id: 'pizza-slice',
    name: 'Pizza Slice',
    category: 'Lunch',
    keywords: ['pizza', 'slice', 'italian', 'cheese'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L3 20c0 1 1 2 2 2h14c1 0 2-1 2-2L12 2z"/><circle cx="10" cy="12" r="1.5" fill="currentColor"/><circle cx="14" cy="15" r="1.5" fill="currentColor"/><circle cx="11" cy="17" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'salad',
    name: 'Salad',
    category: 'Lunch',
    keywords: ['salad', 'healthy', 'greens', 'bowl'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0 5 4 9 8 9s8-4 8-9"/><ellipse cx="12" cy="12" rx="8" ry="3"/><path d="M8 10c1-2 2-3 4-3M14 9c0-2 1-3 2-4"/></svg>`
  },
  {
    id: 'soup',
    name: 'Soup',
    category: 'Lunch',
    keywords: ['soup', 'bowl', 'hot', 'stew'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 11c0 6 4 10 8 10s8-4 8-10"/><path d="M2 11h20"/><path d="M8 7c.5-1 .5-2 0-3M12 7c.5-1 .5-2 0-3M16 7c.5-1 .5-2 0-3"/></svg>`
  },
  {
    id: 'pasta',
    name: 'Pasta',
    category: 'Lunch',
    keywords: ['pasta', 'spaghetti', 'noodles', 'italian'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 14c0 4 4 7 8 7s8-3 8-7"/><ellipse cx="12" cy="14" rx="8" ry="3"/><path d="M6 12c2-6 4-8 6-8M12 4c2 0 4 2 6 8M9 4c1-1 2-1 3 0"/></svg>`
  },
  {
    id: 'sushi',
    name: 'Sushi',
    category: 'Lunch',
    keywords: ['sushi', 'japanese', 'fish', 'rice'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="8" ry="5"/><ellipse cx="12" cy="12" rx="8" ry="5"/><ellipse cx="12" cy="12" rx="4" ry="2" fill="currentColor" opacity="0.3"/></svg>`
  },
  {
    id: 'taco',
    name: 'Taco',
    category: 'Lunch',
    keywords: ['taco', 'mexican', 'tortilla'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 14c0 4 4 7 9 7s9-3 9-7c0-6-4-11-9-11S3 8 3 14z"/><path d="M6 13c1-3 3-5 6-5s5 2 6 5"/></svg>`
  },
  {
    id: 'rice-bowl',
    name: 'Rice Bowl',
    category: 'Lunch',
    keywords: ['rice', 'bowl', 'asian', 'grain'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 10c0 6 4 10 8 10s8-4 8-10"/><ellipse cx="12" cy="10" rx="8" ry="3"/><path d="M8 12v4M12 12v5M16 12v4"/></svg>`
  },
  {
    id: 'falafel',
    name: 'Falafel',
    category: 'Lunch',
    keywords: ['falafel', 'chickpea', 'middle eastern', 'ball'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="12" r="4"/><circle cx="16" cy="12" r="4"/><circle cx="12" cy="8" r="3" fill="currentColor" opacity="0.3"/><circle cx="12" cy="16" r="3" fill="currentColor" opacity="0.3"/></svg>`
  },
  {
    id: 'queso',
    name: 'Queso',
    category: 'Lunch',
    keywords: ['queso', 'cheese', 'dip', 'mexican'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="8" ry="5"/><path d="M8 10c2 2 6 2 8 0"/></svg>`
  },
  {
    id: 'pho',
    name: 'Pho',
    category: 'Lunch',
    keywords: ['pho', 'noodle', 'soup', 'vietnamese'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="8" ry="6"/><path d="M6 8c3 2 9 2 12 0M9 11l3 4 3-4"/></svg>`
  },
  {
    id: 'bento-box',
    name: 'Bento Box',
    category: 'Lunch',
    keywords: ['bento', 'box', 'japanese', 'lunch'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="6" width="16" height="12" rx="2"/><path d="M4 10h16M12 6v12"/></svg>`
  },
  {
    id: 'gyro',
    name: 'Gyro',
    category: 'Lunch',
    keywords: ['gyro', 'pita', 'greek', 'wrap'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="9" ry="5"/><path d="M8 10c2 3 6 3 8 0"/></svg>`
  },

  // ============ SNACKS (10) ============
  {
    id: 'cookie',
    name: 'Cookie',
    category: 'Snacks',
    keywords: ['cookie', 'biscuit', 'chocolate chip'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="14" cy="8" r="1.5" fill="currentColor"/><circle cx="8" cy="14" r="1" fill="currentColor"/><circle cx="15" cy="14" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1.5" fill="currentColor"/></svg>`
  },
  {
    id: 'chips',
    name: 'Chips',
    category: 'Snacks',
    keywords: ['chips', 'crisps', 'potato', 'snack'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 3c-2 0-3 2-3 4v10c0 3 2 5 5 5h6c3 0 5-2 5-5V7c0-2-1-4-3-4"/><path d="M7 3c1 2 3 3 5 3s4-1 5-3"/><path d="M8 11c2 1 4 1 6 0M8 15c2 1 4 1 6 0"/></svg>`
  },
  {
    id: 'popcorn',
    name: 'Popcorn',
    category: 'Snacks',
    keywords: ['popcorn', 'cinema', 'movie', 'snack'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 10l2 11h8l2-11"/><circle cx="8" cy="7" r="3"/><circle cx="12" cy="5" r="3"/><circle cx="16" cy="7" r="3"/></svg>`
  },
  {
    id: 'pretzel',
    name: 'Pretzel',
    category: 'Snacks',
    keywords: ['pretzel', 'bread', 'snack', 'german'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 20c-5 0-8-3-8-6 0-2 1-4 3-5 1-1 2-2 2-4 0-1 1-2 3-2s3 1 3 2c0 2 1 3 2 4 2 1 3 3 3 5 0 3-3 6-8 6z"/><path d="M9 12a3 3 0 106 0"/></svg>`
  },
  {
    id: 'nuts',
    name: 'Nuts',
    category: 'Snacks',
    keywords: ['nuts', 'peanuts', 'almonds', 'snack'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="8" cy="10" rx="4" ry="5"/><ellipse cx="16" cy="10" rx="4" ry="5"/><ellipse cx="12" cy="16" rx="4" ry="5"/></svg>`
  },
  {
    id: 'chocolate-bar',
    name: 'Chocolate Bar',
    category: 'Snacks',
    keywords: ['chocolate', 'candy', 'bar', 'sweet'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="6" width="16" height="12" rx="1"/><path d="M4 10h16M4 14h16M9 6v12M14 6v12"/></svg>`
  },
  {
    id: 'granola-bar',
    name: 'Granola Bar',
    category: 'Snacks',
    keywords: ['granola', 'bar', 'healthy', 'oats'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="8" width="18" height="8" rx="2"/><path d="M7 8v8M11 8v8M15 8v8"/><circle cx="5" cy="12" r="0.5" fill="currentColor"/><circle cx="9" cy="11" r="0.5" fill="currentColor"/><circle cx="13" cy="13" r="0.5" fill="currentColor"/><circle cx="17" cy="12" r="0.5" fill="currentColor"/></svg>`
  },
  {
    id: 'candy',
    name: 'Candy',
    category: 'Snacks',
    keywords: ['candy', 'sweet', 'wrapped'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="5" ry="4"/><path d="M7 12H3c0-2 1-3 2-3s2 1 2 3M17 12h4c0-2-1-3-2-3s-2 1-2 3"/></svg>`
  },
  {
    id: 'crackers',
    name: 'Crackers',
    category: 'Snacks',
    keywords: ['crackers', 'biscuit', 'snack'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="5" width="14" height="14" rx="1"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/><circle cx="9" cy="15" r="1" fill="currentColor"/><circle cx="15" cy="15" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'trail-mix',
    name: 'Trail Mix',
    category: 'Snacks',
    keywords: ['trail', 'mix', 'nuts', 'dried fruit'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 8c0 7 3 12 6 12s6-5 6-12"/><ellipse cx="12" cy="8" rx="6" ry="2"/><circle cx="10" cy="12" r="1" fill="currentColor"/><circle cx="14" cy="11" r="1.5" fill="currentColor"/><circle cx="11" cy="15" r="1" fill="currentColor"/></svg>`
  },

  // ============ DESSERTS (10) ============
  {
    id: 'cupcake',
    name: 'Cupcake',
    category: 'Desserts',
    keywords: ['cupcake', 'cake', 'frosting', 'birthday'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 12h12l-1 9H7l-1-9z"/><path d="M6 12c0-4 3-7 6-7s6 3 6 7"/><path d="M12 5V3"/><path d="M10 8c1 1 2 1 4 0"/></svg>`
  },
  {
    id: 'cake',
    name: 'Cake',
    category: 'Desserts',
    keywords: ['cake', 'birthday', 'celebration', 'dessert'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="11" width="16" height="10" rx="1"/><path d="M4 15h16"/><path d="M8 11V9c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><path d="M12 7V4"/><circle cx="12" cy="3" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'ice-cream',
    name: 'Ice Cream',
    category: 'Desserts',
    keywords: ['ice cream', 'gelato', 'cone', 'frozen'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22l-5-12h10l-5 12z"/><circle cx="12" cy="7" r="5"/><circle cx="9" cy="6" r="2"/><circle cx="15" cy="6" r="2"/></svg>`
  },
  {
    id: 'donut',
    name: 'Donut',
    category: 'Desserts',
    keywords: ['donut', 'doughnut', 'glazed', 'dessert'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="3"/><path d="M9 6c1 .5 2 .5 3 0s2-.5 3 0" opacity="0.5"/></svg>`
  },
  {
    id: 'pie',
    name: 'Pie',
    category: 'Desserts',
    keywords: ['pie', 'apple', 'dessert', 'slice'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 14c0 4 4 7 8 7s8-3 8-7"/><ellipse cx="12" cy="14" rx="8" ry="3"/><path d="M4 14c0-2 1-10 8-10s8 8 8 10"/><path d="M8 11l4-4 4 4"/></svg>`
  },
  {
    id: 'brownie',
    name: 'Brownie',
    category: 'Desserts',
    keywords: ['brownie', 'chocolate', 'dessert', 'fudge'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="8" width="16" height="10" rx="1"/><path d="M4 12h16"/><path d="M10 8v10M14 8v10"/></svg>`
  },
  {
    id: 'pudding',
    name: 'Pudding',
    category: 'Desserts',
    keywords: ['pudding', 'custard', 'dessert'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0 5 4 9 8 9s8-4 8-9"/><path d="M4 12c0-3 4-5 8-5s8 2 8 5"/><path d="M12 7V5"/><circle cx="12" cy="4" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'macaron',
    name: 'Macaron',
    category: 'Desserts',
    keywords: ['macaron', 'french', 'dessert', 'cookie'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="8" rx="7" ry="4"/><ellipse cx="12" cy="16" rx="7" ry="4"/><path d="M5 10v4c0 1 3 2 7 2s7-1 7-2v-4"/></svg>`
  },
  {
    id: 'cheesecake',
    name: 'Cheesecake',
    category: 'Desserts',
    keywords: ['cheesecake', 'cake', 'dessert', 'cream'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 18h18l-2-8H5l-2 8z"/><path d="M5 10c0-3 3-5 7-5s7 2 7 5"/><path d="M10 14l2-2 2 2"/></svg>`
  },
  {
    id: 'popsicle',
    name: 'Popsicle',
    category: 'Desserts',
    keywords: ['popsicle', 'ice', 'frozen', 'summer'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 3h8v12a4 4 0 01-8 0V3z"/><path d="M12 15v6"/><path d="M8 8h8"/></svg>`
  },
  {
    id: 'tiramisu',
    name: 'Tiramisu',
    category: 'Desserts',
    keywords: ['tiramisu', 'italian', 'coffee', 'layered'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="6" width="14" height="12" rx="2"/><path d="M5 10h14M5 14h14"/><circle cx="12" cy="9" r="1.5" fill="currentColor" opacity="0.3"/></svg>`
  },
  {
    id: 'creme-brulee',
    name: 'Cr√®me Br√ªl√©e',
    category: 'Desserts',
    keywords: ['creme brulee', 'custard', 'caramelized', 'torch'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="7" ry="5"/><circle cx="12" cy="10" r="3" fill="currentColor" opacity="0.4"/></svg>`
  },
  {
    id: 'eclair',
    name: '√âclair',
    category: 'Desserts',
    keywords: ['eclair', 'pastry', 'cream', 'chocolate'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="10" ry="4"/><path d="M8 10c2 2 6 2 8 0"/></svg>`
  },
  {
    id: 'cannoli',
    name: 'Cannoli',
    category: 'Desserts',
    keywords: ['cannoli', 'italian', 'tube', 'ricotta'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="8" cy="12" rx="3" ry="6"/><ellipse cx="16" cy="12" rx="3" ry="6"/><path d="M11 10l2 4"/></svg>`
  },
  {
    id: 'gelato',
    name: 'Gelato',
    category: 'Desserts',
    keywords: ['gelato', 'italian', 'ice cream', 'scoop'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="7" ry="5"/><circle cx="10" cy="11" r="2" fill="currentColor"/><circle cx="14" cy="12" r="1.5" fill="currentColor"/></svg>`
  },

  // ============ FRUITS (10) ============
  {
    id: 'apple',
    name: 'Apple',
    category: 'Fruits',
    keywords: ['apple', 'fruit', 'red', 'healthy'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 4c-4 0-8 4-8 10 0 4 2 7 5 7 1 0 2-.5 3-.5s2 .5 3 .5c3 0 5-3 5-7 0-6-4-10-8-10z"/><path d="M12 4c0-2 2-3 3-3"/></svg>`
  },
  {
    id: 'banana',
    name: 'Banana',
    category: 'Fruits',
    keywords: ['banana', 'fruit', 'yellow', 'tropical'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 8c0-3 4-5 9-5 6 0 7 3 7 5 0 4-3 8-8 12C8 16 5 12 5 8z"/><path d="M14 3c1 1 2 2 2 4"/></svg>`
  },
  {
    id: 'orange',
    name: 'Orange',
    category: 'Fruits',
    keywords: ['orange', 'fruit', 'citrus'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="13" r="8"/><path d="M12 5V3"/><path d="M10 3c1 1 3 1 4 0"/><path d="M12 13l-4 4M12 13l4 4M12 13v5"/></svg>`
  },
  {
    id: 'strawberry',
    name: 'Strawberry',
    category: 'Fruits',
    keywords: ['strawberry', 'fruit', 'berry', 'red'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6c-5 0-8 4-8 9 0 4 3 7 8 7s8-3 8-7c0-5-3-9-8-9z"/><path d="M8 4c2 1 6 1 8 0"/><path d="M12 4V2"/><circle cx="9" cy="12" r="0.5" fill="currentColor"/><circle cx="15" cy="12" r="0.5" fill="currentColor"/><circle cx="12" cy="15" r="0.5" fill="currentColor"/><circle cx="10" cy="17" r="0.5" fill="currentColor"/><circle cx="14" cy="17" r="0.5" fill="currentColor"/></svg>`
  },
  {
    id: 'grapes',
    name: 'Grapes',
    category: 'Fruits',
    keywords: ['grapes', 'fruit', 'wine', 'purple'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="9" r="3"/><circle cx="15" cy="9" r="3"/><circle cx="6" cy="14" r="3"/><circle cx="12" cy="14" r="3"/><circle cx="18" cy="14" r="3"/><circle cx="9" cy="19" r="3"/><circle cx="15" cy="19" r="3"/><path d="M12 3v3"/></svg>`
  },
  {
    id: 'watermelon',
    name: 'Watermelon',
    category: 'Fruits',
    keywords: ['watermelon', 'fruit', 'summer', 'melon'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12a8 8 0 0116 0"/><path d="M4 12h16"/><path d="M4 12c0 5 4 9 8 9s8-4 8-9"/><circle cx="9" cy="15" r="0.5" fill="currentColor"/><circle cx="12" cy="17" r="0.5" fill="currentColor"/><circle cx="15" cy="15" r="0.5" fill="currentColor"/></svg>`
  },
  {
    id: 'lemon',
    name: 'Lemon',
    category: 'Fruits',
    keywords: ['lemon', 'fruit', 'citrus', 'yellow'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="8" ry="6"/><path d="M12 6v12"/><path d="M8 9c2 1 4 1 4 3s-2 2-4 3"/><path d="M16 9c-2 1-4 1-4 3s2 2 4 3"/></svg>`
  },
  {
    id: 'cherry',
    name: 'Cherry',
    category: 'Fruits',
    keywords: ['cherry', 'fruit', 'red', 'berry'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="16" r="4"/><circle cx="16" cy="16" r="4"/><path d="M8 12c0-4 2-7 4-9"/><path d="M16 12c0-4-2-7-4-9"/><path d="M12 3c2 0 3 1 4 2"/></svg>`
  },
  {
    id: 'pineapple',
    name: 'Pineapple',
    category: 'Fruits',
    keywords: ['pineapple', 'fruit', 'tropical'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="6" ry="7"/><path d="M9 3c1 2 2 4 3 4s2-2 3-4"/><path d="M7 5c2 1 3 3 5 3s3-2 5-3"/><path d="M6 14h12M8 10l8 8M16 10l-8 8"/></svg>`
  },
  {
    id: 'avocado',
    name: 'Avocado',
    category: 'Fruits',
    keywords: ['avocado', 'fruit', 'healthy', 'green'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2c-4 0-7 5-7 11 0 5 3 9 7 9s7-4 7-9c0-6-3-11-7-11z"/><ellipse cx="12" cy="14" rx="3" ry="4"/></svg>`
  },

  // ============ MEALS (10) ============
  {
    id: 'steak',
    name: 'Steak',
    category: 'Meals',
    keywords: ['steak', 'beef', 'meat', 'dinner'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0-4 4-8 10-8 4 0 7 2 7 5 0 4-3 9-9 11-5 0-8-4-8-8z"/><path d="M10 10c2 0 4 1 4 3"/></svg>`
  },
  {
    id: 'chicken-leg',
    name: 'Chicken Leg',
    category: 'Meals',
    keywords: ['chicken', 'leg', 'drumstick', 'meat'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 4c3 0 5 2 5 5 0 4-3 7-7 7-2 0-3-1-4-2l-5 6-2-2 6-5c-1-1-2-2-2-4 0-4 3-7 7-7 1 0 2 .5 2 2z"/></svg>`
  },
  {
    id: 'fish',
    name: 'Fish',
    category: 'Meals',
    keywords: ['fish', 'seafood', 'salmon', 'healthy'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12c3-5 9-7 15-4-6 3-12 1-15 4z"/><path d="M3 12c3 5 9 7 15 4-6-3-12-1-15-4z"/><path d="M18 8l3 4-3 4"/><circle cx="7" cy="12" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'curry',
    name: 'Curry',
    category: 'Meals',
    keywords: ['curry', 'indian', 'spicy', 'rice'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0 5 4 9 8 9s8-4 8-9"/><ellipse cx="12" cy="12" rx="8" ry="3"/><path d="M8 9c.5-1 .5-2 0-3M12 8c.5-1 .5-2 0-3M16 9c.5-1 .5-2 0-3"/></svg>`
  },
  {
    id: 'noodles',
    name: 'Noodles',
    category: 'Meals',
    keywords: ['noodles', 'ramen', 'asian', 'soup'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 11c0 6 4 10 8 10s8-4 8-10"/><path d="M2 11h20"/><path d="M6 6c1 2 2 3 2 5M10 4c1 2 2 4 2 7M14 4c1 2 2 4 2 7M18 6c1 2 2 3 2 5"/></svg>`
  },
  {
    id: 'pot',
    name: 'Pot',
    category: 'Meals',
    keywords: ['pot', 'cooking', 'stew', 'soup'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 10h16v9a2 2 0 01-2 2H6a2 2 0 01-2-2v-9z"/><path d="M2 10h2M20 10h2"/><path d="M8 10V8M12 10V6M16 10V8"/><path d="M6 10c0-2 3-4 6-4s6 2 6 4"/></svg>`
  },
  {
    id: 'plate',
    name: 'Plate',
    category: 'Meals',
    keywords: ['plate', 'dish', 'dinner', 'meal'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="10" ry="5"/><ellipse cx="12" cy="14" rx="6" ry="3"/></svg>`
  },
  {
    id: 'fried-rice',
    name: 'Fried Rice',
    category: 'Meals',
    keywords: ['rice', 'fried', 'asian', 'chinese'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0 5 4 8 8 8s8-3 8-8"/><ellipse cx="12" cy="12" rx="8" ry="3"/><circle cx="8" cy="14" r="0.5" fill="currentColor"/><circle cx="11" cy="16" r="0.5" fill="currentColor"/><circle cx="14" cy="14" r="0.5" fill="currentColor"/><circle cx="16" cy="16" r="0.5" fill="currentColor"/><circle cx="10" cy="13" r="0.5" fill="currentColor"/></svg>`
  },
  {
    id: 'kebab',
    name: 'Kebab',
    category: 'Meals',
    keywords: ['kebab', 'skewer', 'bbq', 'grill'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2v20"/><rect x="9" y="5" width="6" height="3" rx="1"/><circle cx="12" cy="11" r="2"/><rect x="9" y="15" width="6" height="3" rx="1"/></svg>`
  },
  {
    id: 'roast',
    name: 'Roast',
    category: 'Meals',
    keywords: ['roast', 'dinner', 'sunday', 'meat'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="15" rx="9" ry="5"/><path d="M6 12c0-3 3-6 6-6s6 3 6 6"/><path d="M9 15v-2M12 15v-4M15 15v-2"/></svg>`
  },

  // ============ FAST FOOD (10) ============
  {
    id: 'fries',
    name: 'Fries',
    category: 'Fast Food',
    keywords: ['fries', 'chips', 'potato', 'fast food'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 10l2 11h8l2-11"/><path d="M8 10V4M11 10V3M14 10V4M17 10V5"/><path d="M5 10h14"/></svg>`
  },
  {
    id: 'hotdog',
    name: 'Hot Dog',
    category: 'Fast Food',
    keywords: ['hotdog', 'sausage', 'fast food', 'bun'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0-3 4-6 8-6s8 3 8 6-4 6-8 6-8-3-8-6z"/><path d="M6 10c3-2 9-2 12 0"/><path d="M6 14c3 2 9 2 12 0"/><path d="M7 12c2.5-1 5-1 10 0"/></svg>`
  },
  {
    id: 'pizza-whole',
    name: 'Pizza',
    category: 'Fast Food',
    keywords: ['pizza', 'whole', 'italian', 'cheese'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M12 3v9l6.36 6.36"/><path d="M12 12L5.64 18.36"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="15" cy="9" r="1" fill="currentColor"/><circle cx="9" cy="15" r="1" fill="currentColor"/><circle cx="15" cy="15" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'burrito',
    name: 'Burrito',
    category: 'Fast Food',
    keywords: ['burrito', 'mexican', 'wrap', 'tortilla'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="9" ry="5" transform="rotate(-20 12 12)"/><path d="M5 9c4 2 10 2 14 0"/></svg>`
  },
  {
    id: 'nuggets',
    name: 'Nuggets',
    category: 'Fast Food',
    keywords: ['nuggets', 'chicken', 'fast food', 'fried'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="7" cy="10" rx="4" ry="3"/><ellipse cx="14" cy="8" rx="4" ry="3"/><ellipse cx="17" cy="14" rx="4" ry="3"/><ellipse cx="10" cy="15" rx="4" ry="3"/></svg>`
  },
  {
    id: 'onion-rings',
    name: 'Onion Rings',
    category: 'Fast Food',
    keywords: ['onion', 'rings', 'fried', 'fast food'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="8" cy="10" rx="4" ry="2"/><ellipse cx="8" cy="10" rx="2" ry="1"/><ellipse cx="16" cy="10" rx="4" ry="2"/><ellipse cx="16" cy="10" rx="2" ry="1"/><ellipse cx="12" cy="16" rx="4" ry="2"/><ellipse cx="12" cy="16" rx="2" ry="1"/></svg>`
  },
  {
    id: 'nachos',
    name: 'Nachos',
    category: 'Fast Food',
    keywords: ['nachos', 'chips', 'mexican', 'cheese'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 18l4-14h8l4 14H4z"/><path d="M8 18l2-7M12 18V8M16 18l-2-7"/><circle cx="10" cy="14" r="1" fill="currentColor"/><circle cx="14" cy="12" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'corn-dog',
    name: 'Corn Dog',
    category: 'Fast Food',
    keywords: ['corn', 'dog', 'fried', 'stick'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3c-3 0-5 2-5 5v6c0 3 2 5 5 5s5-2 5-5V8c0-3-2-5-5-5z"/><path d="M12 19v3"/></svg>`
  },
  {
    id: 'quesadilla',
    name: 'Quesadilla',
    category: 'Fast Food',
    keywords: ['quesadilla', 'mexican', 'cheese', 'tortilla'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12h18L12 20 3 12z"/><path d="M3 12L12 4l9 8"/><path d="M7 12h10"/></svg>`
  },
  {
    id: 'sub-sandwich',
    name: 'Sub Sandwich',
    category: 'Fast Food',
    keywords: ['sub', 'sandwich', 'hoagie', 'long'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12c0-2 4-4 9-4s9 2 9 4-4 4-9 4-9-2-9-4z"/><path d="M3 12c0 2 4 4 9 4s9-2 9-4"/><path d="M5 10c4-1 10-1 14 0"/></svg>`
  },

  // ============ OTHER (10) ============
  {
    id: 'cutlery',
    name: 'Cutlery',
    category: 'Other',
    keywords: ['cutlery', 'fork', 'knife', 'utensils'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 3v18M6 3c-1 0-2 2-2 4s1 4 2 4M6 3c1 0 2 2 2 4s-1 4-2 4"/><path d="M18 3v7c0 1-1 2-2 2h-1v9"/><path d="M18 3c0 3-1 5-3 7"/></svg>`
  },
  {
    id: 'takeaway',
    name: 'Takeaway',
    category: 'Other',
    keywords: ['takeaway', 'takeout', 'box', 'container'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 8h16l-2 13H6L4 8z"/><path d="M8 8V6c0-2 2-4 4-4s4 2 4 4v2"/><path d="M4 12h16"/></svg>`
  },
  {
    id: 'shopping-bag',
    name: 'Shopping Bag',
    category: 'Other',
    keywords: ['bag', 'shopping', 'grocery', 'store'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 8h14l-1 13H6L5 8z"/><path d="M8 8V6a4 4 0 018 0v2"/></svg>`
  },
  {
    id: 'gift',
    name: 'Gift',
    category: 'Other',
    keywords: ['gift', 'present', 'box', 'special'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="8" width="18" height="13" rx="1"/><path d="M12 8v13"/><path d="M3 12h18"/><path d="M12 8c-2 0-4-2-4-3s1-2 2-2c2 0 2 2 2 5M12 8c2 0 4-2 4-3s-1-2-2-2c-2 0-2 2-2 5"/></svg>`
  },
  {
    id: 'voucher',
    name: 'Voucher',
    category: 'Other',
    keywords: ['voucher', 'coupon', 'discount', 'ticket'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16v4a2 2 0 100 4v4H4v-4a2 2 0 100-4V6z"/><path d="M10 6v12" stroke-dasharray="2 2"/></svg>`
  },
  {
    id: 'tip',
    name: 'Tip',
    category: 'Other',
    keywords: ['tip', 'gratuity', 'money', 'service'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M12 6v2M12 16v2M9 9c0-1.5 1.5-2 3-2s3 .5 3 2-1 2-3 2-3 .5-3 2 1.5 2 3 2 3-.5 3-2"/></svg>`
  },
  {
    id: 'menu',
    name: 'Menu',
    category: 'Other',
    keywords: ['menu', 'list', 'food', 'order'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="3" width="16" height="18" rx="1"/><path d="M8 7h8M8 11h8M8 15h5"/></svg>`
  },
  {
    id: 'clock',
    name: 'Clock',
    category: 'Other',
    keywords: ['clock', 'time', 'hours', 'wait'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M12 6v6l4 2"/></svg>`
  },
  {
    id: 'star',
    name: 'Star',
    category: 'Other',
    keywords: ['star', 'favorite', 'special', 'featured'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2l3 6 7 1-5 5 1 7-6-3-6 3 1-7-5-5 7-1 3-6z"/></svg>`
  },
  {
    id: 'heart',
    name: 'Heart',
    category: 'Other',
    keywords: ['heart', 'love', 'favorite', 'like'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 21C12 21 4 14 4 8.5C4 5.5 6.5 3 9.5 3C11 3 12 4 12 4C12 4 13 3 14.5 3C17.5 3 20 5.5 20 8.5C20 14 12 21 12 21Z"/></svg>`
  },
  {
    id: 'restaurant',
    name: 'Restaurant',
    category: 'Other',
    keywords: ['restaurant', 'dining', 'eat out'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 4h16v16H4V4z"/><path d="M8 8h8M8 12h8M8 16h5"/></svg>`
  },
  {
    id: 'chef-hat',
    name: 'Chef Hat',
    category: 'Other',
    keywords: ['chef', 'hat', 'cook', 'kitchen'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 16c0-4 4-8 6-8s6 4 6 8"/><ellipse cx="12" cy="8" rx="6" ry="4"/></svg>`
  },
  {
    id: 'apron',
    name: 'Apron',
    category: 'Other',
    keywords: ['apron', 'cooking', 'protect'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="2"/><path d="M8 4v4M16 4v4"/></svg>`
  },
  {
    id: 'recipe-book',
    name: 'Recipe Book',
    category: 'Other',
    keywords: ['recipe', 'book', 'cookbook'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="4" width="14" height="16" rx="2"/><path d="M9 8h6M9 12h6M9 16h4"/></svg>`
  },
  {
    id: 'grill',
    name: 'Grill',
    category: 'Other',
    keywords: ['grill', 'bbq', 'barbecue'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="8" width="16" height="10" rx="2"/><path d="M6 8v-2M10 8v-2M14 8v-2M18 8v-2"/></svg>`
  },
  {
    id: 'microwave',
    name: 'Microwave',
    category: 'Other',
    keywords: ['microwave', 'oven', 'heat'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="6" width="16" height="12" rx="2"/><circle cx="8" cy="12" r="2"/><path d="M14 10h4M14 14h4"/></svg>`
  },
  {
    id: 'fridge',
    name: 'Fridge',
    category: 'Other',
    keywords: ['fridge', 'refrigerator', 'cool'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="12" height="16" rx="2"/><path d="M6 10h12"/></svg>`
  },
  {
    id: 'delivery',
    name: 'Delivery',
    category: 'Other',
    keywords: ['delivery', 'food', 'scooter'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M5 7h14l-2 8H7L5 7z"/></svg>`
  },
  {
    id: 'napkin',
    name: 'Napkin',
    category: 'Other',
    keywords: ['napkin', 'serviette', 'table'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="6" width="12" height="12" rx="2"/><path d="M8 8l8 8M16 8l-8 8"/></svg>`
  },
  {
    id: 'spatula',
    name: 'Spatula',
    category: 'Other',
    keywords: ['spatula', 'kitchen', 'tool', 'flip'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="10" y="4" width="4" height="12" rx="1"/><path d="M8 16h8l2 4H6l2-4z"/></svg>`
  },
  {
    id: 'whisk',
    name: 'Whisk',
    category: 'Other',
    keywords: ['whisk', 'beater', 'mix'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 4v8M8 12c0 4 8 4 8 0"/></svg>`
  },
  {
    id: 'rolling-pin',
    name: 'Rolling Pin',
    category: 'Other',
    keywords: ['rolling pin', 'dough', 'bake'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="12" rx="10" ry="3"/><circle cx="6" cy="12" r="2"/><circle cx="18" cy="12" r="2"/></svg>`
  },
  {
    id: 'cutting-board',
    name: 'Cutting Board',
    category: 'Other',
    keywords: ['cutting board', 'chopping', 'wood'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="6" width="14" height="12" rx="2"/><path d="M8 10h8M8 14h8"/></svg>`
  },
  {
    id: 'salt-shaker',
    name: 'Salt Shaker',
    category: 'Other',
    keywords: ['salt', 'shaker', 'seasoning'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="9" y="6" width="6" height="12" rx="3"/><circle cx="12" cy="10" r="1.5" fill="currentColor"/></svg>`
  },
  {
    id: 'pepper-mill',
    name: 'Pepper Mill',
    category: 'Other',
    keywords: ['pepper', 'mill', 'grinder'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="9" y="4" width="6" height="14" rx="3"/><path d="M12 18v4"/></svg>`
  },
  {
    id: 'corkscrew',
    name: 'Corkscrew',
    category: 'Other',
    keywords: ['corkscrew', 'wine', 'opener'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 4v12M8 16l4 4 4-4"/><path d="M10 10c1 2 3 2 4 0"/></svg>`
  },
  {
    id: 'tray',
    name: 'Tray',
    category: 'Other',
    keywords: ['tray', 'serving', 'waiter'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="8" width="16" height="8" rx="2"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>`
  },
  {
    id: 'chopsticks',
    name: 'Chopsticks',
    category: 'Other',
    keywords: ['chopsticks', 'asian', 'eating'],
    svg: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 4l-2 16M16 4l2 16"/><path d="M6 12h12"/></svg>`
  }
];

// Helper function to find icon by product name
export function findIconForProduct(name: string, category: string | null): FoodIcon | null {
  const nameLower = name.toLowerCase();
  
  // First try exact keyword match
  for (const icon of foodIcons) {
    for (const keyword of icon.keywords) {
      if (nameLower.includes(keyword)) {
        return icon;
      }
    }
  }
  
  // Then try category match
  if (category) {
    const categoryIcons = foodIcons.filter(i => i.category.toLowerCase() === category.toLowerCase());
    if (categoryIcons.length > 0) {
      return categoryIcons[0];
    }
  }
  
  return null;
}

// Get icon by ID
export function getIconById(id: string): FoodIcon | undefined {
  return foodIcons.find(icon => icon.id === id);
}

// Get icons by category
export function getIconsByCategory(category: string): FoodIcon[] {
  return foodIcons.filter(icon => icon.category === category);
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/lib/safeStorage.ts
// =================================================
/**
 * Safe sessionStorage wrapper that handles:
 * - Safari private browsing (throws on access)
 * - Storage quota exceeded
 * - SSR (no window object)
 * - Any other storage errors
 */

function isStorageAvailable(): boolean {
  if (typeof window === 'undefined') return false;
  try {
    const test = '__storage_test__';
    window.sessionStorage.setItem(test, test);
    window.sessionStorage.removeItem(test);
    return true;
  } catch {
    return false;
  }
}

// Cache the availability check
let storageAvailable: boolean | null = null;

function checkStorage(): boolean {
  if (storageAvailable === null) {
    storageAvailable = isStorageAvailable();
  }
  return storageAvailable;
}

// In-memory fallback for when sessionStorage is unavailable
const memoryStorage: Map<string, string> = new Map();

/**
 * Safely get an item from sessionStorage
 * Returns null if storage is unavailable or item doesn't exist
 */
export function safeGetItem(key: string): string | null {
  if (!checkStorage()) {
    return memoryStorage.get(key) ?? null;
  }
  try {
    return window.sessionStorage.getItem(key);
  } catch {
    return memoryStorage.get(key) ?? null;
  }
}

/**
 * Safely set an item in sessionStorage
 * Silently falls back to memory storage if unavailable
 */
export function safeSetItem(key: string, value: string): void {
  if (!checkStorage()) {
    memoryStorage.set(key, value);
    return;
  }
  try {
    window.sessionStorage.setItem(key, value);
  } catch {
    // Fallback to memory storage (e.g., quota exceeded)
    memoryStorage.set(key, value);
  }
}

/**
 * Safely remove an item from sessionStorage
 */
export function safeRemoveItem(key: string): void {
  memoryStorage.delete(key);
  if (!checkStorage()) return;
  try {
    window.sessionStorage.removeItem(key);
  } catch {
    // Ignore errors
  }
}

/**
 * Safely clear all sessionStorage
 */
export function safeClear(): void {
  memoryStorage.clear();
  if (!checkStorage()) return;
  try {
    window.sessionStorage.clear();
  } catch {
    // Ignore errors
  }
}

/**
 * Get and parse JSON from sessionStorage
 * Returns null if parsing fails or item doesn't exist
 */
export function safeGetJSON<T>(key: string): T | null {
  const value = safeGetItem(key);
  if (!value) return null;
  try {
    return JSON.parse(value) as T;
  } catch {
    return null;
  }
}

/**
 * Stringify and set JSON to sessionStorage
 */
export function safeSetJSON(key: string, value: unknown): void {
  try {
    safeSetItem(key, JSON.stringify(value));
  } catch {
    // JSON stringify failed - ignore
  }
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/lib/walletAuth.ts
// =================================================
/**
 * Wallet Authentication Helper
 *
 * Provides HMAC-signed authentication for protected API endpoints.
 * The backend verifies wallet ownership via x-wallet-signature header.
 *
 * Usage:
 *   import { getWalletAuthHeaders, refreshWalletAuth } from '@/lib/walletAuth';
 *
 *   // After login, refresh the auth token
 *   await refreshWalletAuth(walletAddress);
 *
 *   // Include headers in protected requests
 *   const headers = getWalletAuthHeaders(walletAddress);
 *   fetch('/api/v1/affiliate/dashboard/' + wallet, { headers });
 */


// MARK: - Constants & Configuration
const API_URL = 'https://api.dltpays.com/api/v1';


// MARK: - Types & Interfaces
interface WalletAuthToken {
  wallet_address: string;
  signature: string;
  timestamp: string;
  expires_at: number; // Unix timestamp when token expires
}

// In-memory cache for auth tokens (per wallet)
const authTokenCache = new Map<string, WalletAuthToken>();

// Refresh buffer - refresh token 60 seconds before expiry
const REFRESH_BUFFER_MS = 60 * 1000;

/**
 * Fetch a new auth token from the backend
 */
export async function refreshWalletAuth(walletAddress: string): Promise<boolean> {
  if (!walletAddress) return false;

  try {
    const res = await fetch(`${API_URL}/wallet/auth-token`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ wallet_address: walletAddress })
    });

    if (!res.ok) {
      console.error('Failed to get wallet auth token:', res.status);
      return false;
    }

    const data = await res.json();

    if (!data.success || !data.signature || !data.timestamp) {
      console.error('Invalid auth token response:', data);
      return false;
    }

    // Cache the token with expiry time
    const expiresAt = Date.now() + (data.expires_in || 5 * 60 * 1000) - REFRESH_BUFFER_MS;

    authTokenCache.set(walletAddress, {
      wallet_address: walletAddress,
      signature: data.signature,
      timestamp: data.timestamp,
      expires_at: expiresAt
    });

    console.log('Wallet auth token refreshed for:', walletAddress.substring(0, 8) + '...');
    return true;
  } catch (err) {
    console.error('Error refreshing wallet auth:', err);
    return false;
  }
}

/**
 * Get the cached auth token, refreshing if needed
 */
async function getAuthToken(walletAddress: string): Promise<WalletAuthToken | null> {
  if (!walletAddress) return null;

  const cached = authTokenCache.get(walletAddress);

  // If no cache or expired, refresh
  if (!cached || Date.now() >= cached.expires_at) {
    const success = await refreshWalletAuth(walletAddress);
    if (!success) return null;
    return authTokenCache.get(walletAddress) || null;
  }

  return cached;
}

/**
 * Get headers for authenticated requests (synchronous - uses cached token)
 * Call refreshWalletAuth() first to ensure token is cached
 */
export function getWalletAuthHeaders(walletAddress: string): Record<string, string> {
  if (!walletAddress) return {};

  const cached = authTokenCache.get(walletAddress);

  if (!cached || Date.now() >= cached.expires_at) {
    // Token missing or expired - return empty (caller should refresh first)
    console.warn('Wallet auth token missing or expired. Call refreshWalletAuth() first.');
    return {};
  }

  return {
    'x-wallet-signature': cached.signature,
    'x-wallet-timestamp': cached.timestamp
  };
}

/**
 * Get headers for authenticated requests (async - auto-refreshes if needed)
 */
export async function getWalletAuthHeadersAsync(walletAddress: string): Promise<Record<string, string>> {
  if (!walletAddress) return {};

  const token = await getAuthToken(walletAddress);

  if (!token) {
    console.warn('Failed to get wallet auth token');
    return {};
  }

  return {
    'x-wallet-signature': token.signature,
    'x-wallet-timestamp': token.timestamp
  };
}

/**
 * Make an authenticated fetch request
 */
export async function authenticatedFetch(
  walletAddress: string,
  url: string,
  options: RequestInit = {}
): Promise<Response> {
  const authHeaders = await getWalletAuthHeadersAsync(walletAddress);

  const headers = {
    ...options.headers,
    ...authHeaders
  };

  return fetch(url, {
    ...options,
    headers
  });
}

/**
 * Clear cached auth token (call on logout)
 */
export function clearWalletAuth(walletAddress?: string): void {
  if (walletAddress) {
    authTokenCache.delete(walletAddress);
  } else {
    authTokenCache.clear();
  }
}

/**
 * Check if we have a valid (non-expired) auth token cached
 */
export function hasValidAuthToken(walletAddress: string): boolean {
  if (!walletAddress) return false;

  const cached = authTokenCache.get(walletAddress);
  return cached !== undefined && Date.now() < cached.expires_at;
}

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/lib/web3auth.ts
// =================================================
// lib/web3auth.ts
// Web3Auth must be imported dynamically due to SSR issues
// See: https://web3auth.io/docs/troubleshooting/different-methods#nextjs

// L6: Use environment variable for Web3Auth client ID

// MARK: - Constants & Configuration
export const WEB3AUTH_CLIENT_ID = process.env.NEXT_PUBLIC_WEB3AUTH_CLIENT_ID || "BJammoKWeysr0S4Nk7J0WxyYHnfFw1Jscfgwx3iuvwI4GEMJCCz1iQ_wtbd40MDLrcf_xaXbi7AVif0MCv19Fk4";

// Cache instance so withdraw can reuse the connected session
let web3authInstance: any = null;

export async function getWeb3Auth() {
  if (typeof window === 'undefined') return null;
  
  // Return cached instance if already connected
  if (web3authInstance?.connected) {
    return web3authInstance;
  }
  
  const { Web3Auth } = await import("@web3auth/modal");
  const { XrplPrivateKeyProvider } = await import("@web3auth/xrpl-provider");
  const { WEB3AUTH_NETWORK } = await import("@web3auth/base");
  
  const chainConfig = {
    chainNamespace: "xrpl" as const,
    chainId: "0x1",
    rpcTarget: "https://xrplcluster.com",
    wsTarget: "wss://xrplcluster.com",
    ticker: "XRP",
    tickerName: "XRPL",
    displayName: "XRPL Mainnet",
    blockExplorerUrl: "https://livenet.xrpl.org",
  };
  
  const privateKeyProvider = new XrplPrivateKeyProvider({
    config: { chainConfig }
  });
  
  const web3auth = new Web3Auth({
    clientId: WEB3AUTH_CLIENT_ID,
    web3AuthNetwork: WEB3AUTH_NETWORK.SAPPHIRE_MAINNET,
    privateKeyProvider: privateKeyProvider as any,
  });
  
  await web3auth.init();
  web3authInstance = web3auth;
  return web3auth;
}

export async function loginWithWeb3Auth(): Promise<{ address: string; provider: string } | null> {
  try {
    const web3auth = await getWeb3Auth();
    if (!web3auth) return null;

    await web3auth.connect();
    if (!web3auth.provider) return null;

    const accounts = await web3auth.provider.request({ method: "xrpl_getAccounts" }) as string[];
    const address = accounts?.[0];
    if (!address) return null;

    // Get the social provider (github, google, discord, etc.)
    const userInfo = await web3auth.getUserInfo();
    const socialProvider = userInfo?.authConnection || 'google';

    return { address, provider: socialProvider };
  } catch (error) {
    console.error("Web3Auth login error:", error);
    return null;
  }
}

export async function logoutWeb3Auth() {
  const web3auth = await getWeb3Auth();
  if (web3auth?.connected) {
    await web3auth.logout();
    web3authInstance = null;
  }
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/next-env.d.ts
// =================================================
/// <reference types="next" />
/// <reference types="next/image-types/global" />
// MARK: - Imports & Dependencies
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/next.config.ts
// =================================================
// MARK: - Imports & Dependencies
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  transpilePackages: ['nextstepjs'],
};


// MARK: - Exports
export default nextConfig;

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/public/ggwave-processor.js
// =================================================
class GGWaveProcessor extends AudioWorkletProcessor {
  process(inputs) {
    const input = inputs[0]?.[0];
    if (input && input.length > 0) {
      this.port.postMessage(new Float32Array(input));
    }
    return true;
  }
}
registerProcessor('ggwave-processor', GGWaveProcessor);

// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/public/js/track.js
// =================================================
/**
 * YesAllofUs Affiliate Tracking SDK v2.0
 * Tracking only - payouts triggered server-side via webhook
 * 
 * Usage:
 * <script src="https://yesallofus.com/js/track.js"></script>
 * 
 * Then read referral at checkout:
 * const ref = YesAllofUs.getReferralCode();
 * // Send 'ref' to your backend with the order
 */

(function() {
  'use strict';

  var COOKIE_NAME = 'yesallofus_ref';
  var COOKIE_DAYS = 30;

  function setCookie(name, value, days) {
    var expires = '';
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      expires = '; expires=' + date.toUTCString();
    }
    var domain = location.hostname.replace(/^www\./i, '');
    var domainStr = (domain === 'localhost') ? '' : '; domain=' + domain;
    document.cookie = name + '=' + value + expires + '; path=/' + domainStr + '; SameSite=Lax';
  }

  function getCookie(name) {
    var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
  }

  function isValidRefCode(code) {
    return code && /^[A-Za-z0-9]{4,20}$/.test(code);
  }

  function trackReferral() {
    var params = new URLSearchParams(window.location.search);
    var ref = params.get('ref');
    
    if (ref && isValidRefCode(ref)) {
      setCookie(COOKIE_NAME, ref.toUpperCase(), COOKIE_DAYS);
      console.log('[YesAllofUs] Referral tracked:', ref.toUpperCase());
    }
  }

  function getReferralCode() {
    var code = getCookie(COOKIE_NAME);
    if (!code) {
      try {
        code = sessionStorage.getItem('_yesallofus_ref') || sessionStorage.getItem('yesallofus_ref');
      } catch (e) {}
    }
    return isValidRefCode(code) ? code : null;
  }

  trackReferral();

  window.YesAllofUs = {
    getReferralCode: getReferralCode,
    version: '2.0.0'
  };

  console.log('[YesAllofUs] Tracking SDK v2.0 loaded');

})();
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/public/sw.js
// =================================================

// MARK: - Constants & Configuration
const CACHE_NAME = 'yesallofus-v3';

self.addEventListener('install', (event) => {
  self.skipWaiting();
});

self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheName !== CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    }).then(() => clients.claim())
  );
});

self.addEventListener('fetch', (event) => {
  if (event.request.method !== 'GET') return;
  
  // Skip API requests
  if (event.request.url.includes('api.dltpays.com')) {
    return;
  }
  
  event.respondWith(
    fetch(event.request)
      .then((response) => {
        return response;
      })
      .catch(() => caches.match(event.request))
  );
});
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/utils/soundPayment copy.ts
// =================================================
// MARK: - Imports & Dependencies
'use client';

// =============================================================================
// BOMBPROOF FSK Sound Payment System
// =============================================================================
// 
// Protocol: Fixed Symbol Timing with Gap Tones
// 
// Transmission format:
//   [PREAMBLE] ‚Üí [GAP] ‚Üí [CHAR1] ‚Üí [GAP] ‚Üí [CHAR2] ‚Üí [GAP] ‚Üí ... ‚Üí [POSTAMBLE]
//
// Key principle: GAP tone between EVERY character eliminates repeated-char problem
// Receiver locks to preamble, then samples at fixed time slots
//
// =============================================================================


// MARK: - Constants & Configuration
const SAMPLE_RATE = 48000;

// =============================================================================
// TIMING CONFIGURATION (in seconds)
// =============================================================================
const TIMING = {
  // Preamble/Postamble - long enough to reliably detect
  PREAMBLE_DURATION: 0.20,      // 200ms - longer for better receiver lock 
  POSTAMBLE_DURATION: 0.20,     // 200ms - longer for reliable detection
  
  // Character and gap durations
  CHAR_DURATION: 0.12,          // 120ms per character - more time to detect
  GAP_DURATION: 0.06,           // 60ms gap - MUST be long enough to detect
  
  // Receiver timing
  SAMPLE_DELAY: 0.05,           // Sample 50ms into char slot
  PREAMBLE_MIN_DURATION: 0.08,  // Min time to confirm preamble
  
  // Envelope for smooth transitions
  ATTACK_TIME: 0.005,           // 5ms fade in - sharper attack
RELEASE_TIME: 0.005,          // 5ms fade out - sharper cutoff
};

// Calculate total broadcast duration for a token
const calculateDuration = (tokenLength: number): number => {
  return TIMING.PREAMBLE_DURATION + 
         TIMING.GAP_DURATION +  // gap after preamble
         (tokenLength * TIMING.CHAR_DURATION) + 
         (tokenLength * TIMING.GAP_DURATION) +  // gap after each char
         TIMING.POSTAMBLE_DURATION;
};

// =============================================================================
// DEVICE DETECTION
// =============================================================================
const detectBroadcastMode = (): 'ultrasound' | 'audible' => {
  if (typeof window === 'undefined') return 'audible';
  const isLargeScreen = window.innerWidth > 1024;
  return isLargeScreen ? 'ultrasound' : 'audible';
};

const BROADCAST_MODE = typeof window !== 'undefined' ? detectBroadcastMode() : 'audible';

// =============================================================================
// FREQUENCY CONFIGURATIONS
// =============================================================================
const FREQ_CONFIG = {
  ultrasound: {
    baseFreq: 17800,
    freqStep: 30,
    syncFreq: 17500,       // PREAMBLE
    gapFreq: 17650,        // GAP tone (between sync and data range)
    endSyncFreq: 19500,    // POSTAMBLE - MOVED MUCH HIGHER (was 18800)
    // Char range: 17800 (0) to 18250 (F) - gap to postamble now 1250 Hz
  },
  audible: {
    // 15000 Hz range - this is the sweet spot for iPhone speakers!
    baseFreq: 15500,       // Character base frequency
    freqStep: 80,          // 80 Hz per character (0-F = 0-1200 Hz range)
    syncFreq: 15000,       // PREAMBLE
    gapFreq: 15250,        // GAP tone (between sync and data range)
    endSyncFreq: 17000,    // POSTAMBLE
    // Char range: 15500 (0) to 16700 (F)
  }
};

// Character set for encoding - hex only
const CHARSET = '0123456789ABCDEF';

// =============================================================================
// FREQUENCY HELPERS
// =============================================================================
function charToFreq(char: string, mode: 'ultrasound' | 'audible' = BROADCAST_MODE): number {
  const config = FREQ_CONFIG[mode];
  const index = CHARSET.indexOf(char.toUpperCase());
  if (index === -1) return config.baseFreq;
  return config.baseFreq + (index * config.freqStep);
}

function freqToChar(freq: number, mode: 'ultrasound' | 'audible'): string | null {
  const config = FREQ_CONFIG[mode];
  const index = Math.round((freq - config.baseFreq) / config.freqStep);
  if (index < 0 || index >= CHARSET.length) return null;
  
  // Check if frequency is close enough to expected
  const expectedFreq = config.baseFreq + (index * config.freqStep);
  const tolerance = config.freqStep * 0.5;
  if (Math.abs(freq - expectedFreq) > tolerance) return null;
  
  return CHARSET[index];
}

function identifyTone(freq: number, mode: 'ultrasound' | 'audible', logUnknown: boolean = false): 
  { type: 'preamble' | 'gap' | 'postamble' | 'char'; char?: string } | null {
  
  const config = FREQ_CONFIG[mode];
  const tolerance = mode === 'ultrasound' ? 100 : 120;  // Increased tolerance
  
  // Check preamble
  if (Math.abs(freq - config.syncFreq) < tolerance) {
    return { type: 'preamble' };
  }
  
  // Check gap
  if (Math.abs(freq - config.gapFreq) < tolerance) {
    return { type: 'gap' };
  }
  
  // Check postamble - use VERY strict tolerance to avoid false positives
  // Postamble is now at 19500 Hz (ultrasound), far from chars (max 18250 Hz)
  if (Math.abs(freq - config.endSyncFreq) < 200) {
    return { type: 'postamble' };
  }
  
  // Check character
  const char = freqToChar(freq, mode);
  if (char) {
    return { type: 'char', char };
  }
  
  return null;
}

// =============================================================================
// AUDIO CONTEXT MANAGEMENT
// =============================================================================
let audioContext: AudioContext | null = null;
let mediaStream: MediaStream | null = null;
let analyser: AnalyserNode | null = null;
let isListening = false;

export async function warmupAudio(): Promise<void> {
  if (typeof window === 'undefined') return;
  try {
    const AudioContextClass = window.AudioContext || (window as any).webkitAudioContext;
    if (!audioContext || audioContext.state === 'closed') {
      audioContext = new AudioContextClass({ sampleRate: SAMPLE_RATE });
    }
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }
    // Play silent tone to unlock iOS
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    gain.gain.value = 0.001;
    osc.connect(gain);
    gain.connect(audioContext.destination);
    osc.start();
    osc.stop(audioContext.currentTime + 0.1);
    console.log('üîä [INIT] Audio warmup complete');
  } catch (e) {
    console.warn('üîä [INIT] Warmup failed:', e);
  }
}

export async function initSoundPayment(): Promise<boolean> {
  if (typeof window === 'undefined') return false;
  try {
    const AudioContextClass = window.AudioContext || (window as any).webkitAudioContext;
    if (!audioContext || audioContext.state === 'closed') {
      audioContext = new AudioContextClass({ sampleRate: SAMPLE_RATE });
    }
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }
    console.log('üîä [INIT] Sound payment initialized (BOMBPROOF protocol)');
    console.log('üîä [INIT] Broadcast mode:', BROADCAST_MODE, BROADCAST_MODE === 'ultrasound' ? '(silent)' : '(audible chirps)');
    console.log('üîä [INIT] Timing: CHAR=' + (TIMING.CHAR_DURATION * 1000) + 'ms, GAP=' + (TIMING.GAP_DURATION * 1000) + 'ms');
    return true;
  } catch (error) {
    console.error('üîä [INIT] Failed to initialize:', error);
    return false;
  }
}

// =============================================================================
// BROADCAST (TRANSMITTER)
// =============================================================================

// MARK: - Types & Interfaces
export interface BroadcastSettings {
  volume?: number;
}

export async function broadcastToken(token: string, settings?: BroadcastSettings): Promise<boolean> {
  if (typeof window === 'undefined') return false;

  try {
    await initSoundPayment();
    if (!audioContext) throw new Error('Audio context not available');
    
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }

    const tokenUpper = token.toUpperCase();
    const config = FREQ_CONFIG[BROADCAST_MODE];
    const volume = settings?.volume ?? (BROADCAST_MODE === 'ultrasound' ? 0.8 : 0.7);
    const totalDuration = calculateDuration(tokenUpper.length);
    
    console.log('üîä ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üîä [TX] BROADCAST START');
    console.log('üîä [TX] Token:', tokenUpper);
    console.log('üîä [TX] Mode:', BROADCAST_MODE);
    console.log('üîä [TX] Volume:', volume);
    console.log('üîä [TX] Total duration:', (totalDuration * 1000).toFixed(0) + 'ms');
    console.log('üîä [TX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('üîä [TX] Frequency map:');
    console.log('üîä [TX]   PREAMBLE  ‚Üí', config.syncFreq, 'Hz');
    console.log('üîä [TX]   GAP       ‚Üí', config.gapFreq, 'Hz');
    for (const char of tokenUpper) {
      console.log('üîä [TX]   CHAR "' + char + '"  ‚Üí', charToFreq(char), 'Hz');
    }
    console.log('üîä [TX]   POSTAMBLE ‚Üí', config.endSyncFreq, 'Hz');
    console.log('üîä [TX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

    const ctx = audioContext;
    let currentTime = ctx.currentTime + 0.05; // Small buffer
    
    // Helper to play a tone with envelope
    const playTone = (freq: number, duration: number, label: string) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.frequency.value = freq;
      osc.type = 'sine';
      
      // Smooth envelope
      gain.gain.setValueAtTime(0, currentTime);
      gain.gain.linearRampToValueAtTime(volume, currentTime + TIMING.ATTACK_TIME);
      gain.gain.setValueAtTime(volume, currentTime + duration - TIMING.RELEASE_TIME);
      gain.gain.linearRampToValueAtTime(0, currentTime + duration);
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(currentTime);
      osc.stop(currentTime + duration);
      
      const startMs = ((currentTime - ctx.currentTime) * 1000).toFixed(0);
      console.log('üîä [TX] @' + startMs + 'ms: ' + label + ' (' + freq + 'Hz, ' + (duration * 1000).toFixed(0) + 'ms)');
      
      currentTime += duration;
    };

    // 1. PREAMBLE
    playTone(config.syncFreq, TIMING.PREAMBLE_DURATION, 'PREAMBLE');
    
    // 2. GAP after preamble
    playTone(config.gapFreq, TIMING.GAP_DURATION, 'GAP');
    
    // 3. For each character: CHAR + GAP
    for (let i = 0; i < tokenUpper.length; i++) {
      const char = tokenUpper[i];
      const freq = charToFreq(char);
      playTone(freq, TIMING.CHAR_DURATION, 'CHAR[' + i + ']="' + char + '"');
      playTone(config.gapFreq, TIMING.GAP_DURATION, 'GAP');
    }
    
    // 4. POSTAMBLE
    playTone(config.endSyncFreq, TIMING.POSTAMBLE_DURATION, 'POSTAMBLE');

    console.log('üîä [TX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('üîä [TX] All tones scheduled, waiting for completion...');

    return new Promise((resolve) => {
      setTimeout(() => {
        console.log('üîä [TX] BROADCAST COMPLETE');
        console.log('üîä ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        resolve(true);
      }, totalDuration * 1000 + 100);
    });

  } catch (error) {
    console.error('üîä [TX] Broadcast error:', error);
    return false;
  }
}

// =============================================================================
// LISTEN (RECEIVER) - Fixed Symbol Timing State Machine
// =============================================================================
type ReceiverState = 'IDLE' | 'PREAMBLE_DETECTED' | 'WAITING_FOR_GAP' | 'WAITING_FOR_CHAR' | 'COMPLETE';

export async function startListening(
  onTokenReceived: (token: string) => void,
  onError?: (error: string) => void,
  onProgress?: (state: 'ready' | 'sync' | 'receiving', chars?: string) => void
): Promise<() => void> {
  if (typeof window === 'undefined') return () => {};
  if (isListening) {
    console.log('üé§ [RX] Already listening, ignoring duplicate call');
    return () => {};
  }

  try {
    await initSoundPayment();
    if (!audioContext) throw new Error('Audio context not available');
    
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }

    const ctx = audioContext;

    mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        channelCount: 1,
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false,
      }
    });

    console.log('üé§ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üé§ [RX] RECEIVER STARTED');
    console.log('üé§ [RX] Mic granted');
    onProgress?.('ready');

    const source = ctx.createMediaStreamSource(mediaStream);
    analyser = ctx.createAnalyser();
    analyser.fftSize = 8192;
    analyser.smoothingTimeConstant = 0.3;
    source.connect(analyser);

    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    const freqResolution = SAMPLE_RATE / analyser.fftSize;

    console.log('üé§ [RX] FFT size:', analyser.fftSize);
    console.log('üé§ [RX] Freq resolution:', freqResolution.toFixed(2), 'Hz');
    console.log('üé§ [RX] Listening for BOTH audible and ultrasound');
    console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

    isListening = true;
    
    // State machine variables
    let state: ReceiverState = 'IDLE';
    let detectedMode: 'ultrasound' | 'audible' | null = null;
    let receivedChars: string[] = [];
    let preambleStartTime = 0;
    let lastGapTime = 0;
    let lastToken = '';
    let lastTokenTime = 0;
    let stateStartTime = 0;
    let consecutivePreambleCount = 0;
    let consecutiveGapCount = 0;
    
    const AMPLITUDE_THRESHOLD = 25;  // Lowered for better postamble detection
    const PREAMBLE_CONFIRM_COUNT = 3;  // Need 3 consecutive preamble detections
    const GAP_CONFIRM_COUNT = 1;       // Need 1 gap detection (faster!)
    const CHAR_CONFIRM_COUNT = 1;      // Need 1 char detection (faster!)
    
    let lastDetectedChar: string | null = null;
    let charConfirmCount = 0;

    // Detect peak frequency in range
    const detectFrequency = (minFreq: number, maxFreq: number): { freq: number; amplitude: number } | null => {
      analyser!.getByteFrequencyData(dataArray);
      
      const minBin = Math.floor(minFreq / freqResolution);
      const maxBin = Math.ceil(maxFreq / freqResolution);
      
      let maxValue = 0;
      let maxIndex = 0;
      
      for (let i = minBin; i < maxBin; i++) {
        if (dataArray[i] > maxValue) {
          maxValue = dataArray[i];
          maxIndex = i;
        }
      }
      
      if (maxValue < AMPLITUDE_THRESHOLD) return null;
      
      return { freq: maxIndex * freqResolution, amplitude: maxValue };
    };

    // Try both frequency ranges
    // IMPORTANT: Check audible FIRST because its POSTAMBLE (17000 Hz) 
    // could be confused with ultrasound PREAMBLE (17500 Hz)
    const detectAnySignal = (): { freq: number; amplitude: number; mode: 'ultrasound' | 'audible' } | null => {
      // Try audible first (14500-17200 Hz) - the 15000 Hz sweet spot for iPhone
      // Upper limit 17200 to include POSTAMBLE but not overlap with ultrasound PREAMBLE
      const audible = detectFrequency(14500, 17200);
      if (audible && audible.amplitude > AMPLITUDE_THRESHOLD) {
        return { ...audible, mode: 'audible' };
      }
      
      // Try ultrasound (17300-20000 Hz) - starts above audible POSTAMBLE
      const ultra = detectFrequency(17300, 20000);
      if (ultra && ultra.amplitude > AMPLITUDE_THRESHOLD) {
        return { ...ultra, mode: 'ultrasound' };
      }
      
      return null;
    };

    const processFrame = () => {
      if (!isListening) return;

      const now = Date.now();
      const detection = detectAnySignal();

      // Debug: log any strong signal detected (every 500ms to avoid spam)
      if (detection && detection.amplitude > 50 && now % 500 < 20) {
        console.log('üé§ [RX] Signal detected | mode:', detection.mode, '| freq:', detection.freq.toFixed(0), '| amp:', detection.amplitude);
      }

      if (detection) {
        const { freq, amplitude, mode } = detection;
        const tone = identifyTone(freq, mode);

        switch (state) {
          case 'IDLE':
            // Looking for preamble
            if (tone?.type === 'preamble') {
              consecutivePreambleCount++;
              if (consecutivePreambleCount >= PREAMBLE_CONFIRM_COUNT) {
                state = 'PREAMBLE_DETECTED';
                detectedMode = mode;
                preambleStartTime = now;
                stateStartTime = now;
                receivedChars = [];
                console.log('üé§ [RX] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üé§ [RX] PREAMBLE LOCKED | mode:', mode, '| freq:', freq.toFixed(0), '| amp:', amplitude);
                onProgress?.('sync');
              }
            } else {
              consecutivePreambleCount = 0;
            }
            break;

          case 'PREAMBLE_DETECTED':
            // Wait for first GAP after preamble
            if (tone?.type === 'gap') {
              consecutiveGapCount++;
              if (consecutiveGapCount >= GAP_CONFIRM_COUNT) {
                state = 'WAITING_FOR_CHAR';
                lastGapTime = now;
                stateStartTime = now;
                consecutiveGapCount = 0;
                console.log('üé§ [RX] GAP after preamble | freq:', freq.toFixed(0), '| amp:', amplitude);
                console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
              }
            } else if (tone?.type === 'preamble') {
              // Still in preamble, that's fine
              consecutiveGapCount = 0;
            } else {
              // Something else detected - log it!
              console.log('üé§ [RX] ? In PREAMBLE_DETECTED, got:', tone?.type || 'unknown', '| freq:', freq.toFixed(0), '| amp:', amplitude, '| gapCount:', consecutiveGapCount);
              consecutiveGapCount = 0;
            }
            break;

          case 'WAITING_FOR_CHAR':
            // Looking for character tone
            if (tone?.type === 'char' && tone.char) {
              // Require consecutive confirmations of same char
              if (tone.char === lastDetectedChar) {
                charConfirmCount++;
              } else {
                lastDetectedChar = tone.char;
                charConfirmCount = 1;
              }
              
              if (charConfirmCount >= CHAR_CONFIRM_COUNT) {
                receivedChars.push(tone.char);
                state = 'WAITING_FOR_GAP';
                stateStartTime = now;
                charConfirmCount = 0;
                lastDetectedChar = null;
                console.log('üé§ [RX] CHAR[' + (receivedChars.length - 1) + '] = "' + tone.char + '" | freq:', freq.toFixed(0), '| amp:', amplitude, '| token so far:', receivedChars.join(''));
                onProgress?.('receiving', receivedChars.join(''));
              }
            } else if (tone?.type === 'postamble') {
              // End of transmission
              state = 'COMPLETE';
              const token = receivedChars.join('');
              console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
              console.log('üé§ [RX] POSTAMBLE DETECTED | freq:', freq.toFixed(0));
              console.log('üé§ [RX] TOKEN COMPLETE:', token, '| length:', token.length);
              
              if (token.length >= 4) {
                if (token !== lastToken || now - lastTokenTime > 5000) {
                  lastToken = token;
                  lastTokenTime = now;
                  console.log('üé§ [RX] ‚úÖ TOKEN ACCEPTED:', token);
                  console.log('üé§ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  onTokenReceived(token);
                } else {
                  console.log('üé§ [RX] ‚ö†Ô∏è Duplicate token ignored');
                }
              } else {
                console.log('üé§ [RX] ‚ö†Ô∏è Token too short, discarding');
              }
              
              // Reset
              state = 'IDLE';
              detectedMode = null;
              receivedChars = [];
              consecutivePreambleCount = 0;
              consecutiveGapCount = 0;
              charConfirmCount = 0;
              lastDetectedChar = null;
            } else if (tone?.type === 'gap') {
              // Still gap, waiting for char - reset char detection
              lastDetectedChar = null;
              charConfirmCount = 0;
            } else {
              // Unknown tone - log it for debugging
              if (tone) {
                console.log('üé§ [RX] ? Unknown tone in WAITING_FOR_CHAR | type:', tone.type, '| freq:', freq.toFixed(0), '| amp:', amplitude);
              }
            }
            break;

          case 'WAITING_FOR_GAP':
            // Looking for gap after character
            if (tone?.type === 'gap') {
              consecutiveGapCount++;
              if (consecutiveGapCount >= GAP_CONFIRM_COUNT) {
                state = 'WAITING_FOR_CHAR';
                lastGapTime = now;
                stateStartTime = now;
                consecutiveGapCount = 0;
                console.log('üé§ [RX] GAP after char | freq:', freq.toFixed(0), '| amp:', amplitude);
              }
            } else if (tone?.type === 'postamble') {
              // End of transmission (no gap before postamble sometimes)
              state = 'COMPLETE';
              const token = receivedChars.join('');
              console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
              console.log('üé§ [RX] POSTAMBLE DETECTED | freq:', freq.toFixed(0));
              console.log('üé§ [RX] TOKEN COMPLETE:', token, '| length:', token.length);
              
              if (token.length >= 4) {
                if (token !== lastToken || now - lastTokenTime > 5000) {
                  lastToken = token;
                  lastTokenTime = now;
                  console.log('üé§ [RX] ‚úÖ TOKEN ACCEPTED:', token);
                  console.log('üé§ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  onTokenReceived(token);
                } else {
                  console.log('üé§ [RX] ‚ö†Ô∏è Duplicate token ignored');
                }
              } else {
                console.log('üé§ [RX] ‚ö†Ô∏è Token too short, discarding');
              }
              
              // Reset
              state = 'IDLE';
              detectedMode = null;
              receivedChars = [];
              consecutivePreambleCount = 0;
              consecutiveGapCount = 0;
              charConfirmCount = 0;
              lastDetectedChar = null;
            } else if (tone?.type === 'char') {
              // Still hearing character, not gap yet
              consecutiveGapCount = 0;
            }
            break;
        }
      } else {
        // No signal detected
        if (state !== 'IDLE') {
          // Timeout check
          const timeSinceStateStart = now - stateStartTime;
          if (timeSinceStateStart > 2000) {
            console.log('üé§ [RX] ‚ö†Ô∏è Timeout in state:', state, '| resetting');
            state = 'IDLE';
            detectedMode = null;
            receivedChars = [];
            consecutivePreambleCount = 0;
            consecutiveGapCount = 0;
          }
        } else {
          consecutivePreambleCount = 0;
        }
      }

      requestAnimationFrame(processFrame);
    };

    requestAnimationFrame(processFrame);

    return () => {
      console.log('üé§ [RX] Stopping listener...');
      isListening = false;
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      if (analyser) {
        analyser.disconnect();
        analyser = null;
      }
      console.log('üé§ [RX] Stopped');
    };

  } catch (error: any) {
    console.error('üé§ [RX] Listen error:', error);
    if (onError) {
      if (error.name === 'NotAllowedError') {
        onError('Microphone permission denied');
      } else {
        onError(error.message || 'Failed to listen');
      }
    }
    return () => {};
  }
}

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================
export function isSupported(): boolean {
  if (typeof window === 'undefined') return false;
  return !!(
    (window.AudioContext || (window as any).webkitAudioContext) &&
    navigator.mediaDevices?.getUserMedia
  );
}

export function getBroadcastMode(): 'ultrasound' | 'audible' {
  return BROADCAST_MODE;
}

export function cleanup() {
  console.log('üîä [CLEANUP] Cleaning up audio resources...');
  isListening = false;
  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
    mediaStream = null;
  }
  if (analyser) {
    analyser.disconnect();
    analyser = null;
  }
  if (audioContext && audioContext.state !== 'closed') {
    audioContext.close();
    audioContext = null;
  }
  console.log('üîä [CLEANUP] Done');
}
// =================================================
// FILE: /Users/markflynn/Local Sites/yesallofus/utils/soundPayment.ts
// =================================================
// MARK: - Imports & Dependencies
'use client';

// =============================================================================
// BOMBPROOF FSK Sound Payment System
// =============================================================================
// 
// Protocol: Fixed Symbol Timing with Gap Tones
// 
// Transmission format:
//   [PREAMBLE] ‚Üí [GAP] ‚Üí [CHAR1] ‚Üí [GAP] ‚Üí [CHAR2] ‚Üí [GAP] ‚Üí ... ‚Üí [POSTAMBLE]
//
// Key principle: GAP tone between EVERY character eliminates repeated-char problem
// Receiver locks to preamble, then samples at fixed time slots
//
// =============================================================================


// MARK: - Constants & Configuration
const SAMPLE_RATE = 48000;

// =============================================================================
// TIMING CONFIGURATION (in seconds)
// =============================================================================
const TIMING = {
  // Preamble/Postamble - long enough to reliably detect
  PREAMBLE_DURATION: 0.20,      // 200ms - longer for better receiver lock
  POSTAMBLE_DURATION: 0.20,     // 200ms - longer for reliable detection
  
  // Character and gap durations
  CHAR_DURATION: 0.12,          // 120ms per character - more time to detect
  GAP_DURATION: 0.06,           // 60ms gap - MUST be long enough to detect
  
  // Receiver timing
  SAMPLE_DELAY: 0.05,           // Sample 50ms into char slot
  PREAMBLE_MIN_DURATION: 0.08,  // Min time to confirm preamble
  
  // Envelope for smooth transitions
  ATTACK_TIME: 0.005,           // 5ms fade in - sharper attack
  RELEASE_TIME: 0.005,          // 5ms fade out - sharper cutoff
};

// Calculate total broadcast duration for a token
const calculateDuration = (tokenLength: number): number => {
  return TIMING.PREAMBLE_DURATION + 
         TIMING.GAP_DURATION +  // gap after preamble
         (tokenLength * TIMING.CHAR_DURATION) + 
         (tokenLength * TIMING.GAP_DURATION) +  // gap after each char
         TIMING.POSTAMBLE_DURATION;
};

// =============================================================================
// DEVICE DETECTION
// =============================================================================
const detectBroadcastMode = (): 'ultrasound' | 'audible' => {
  return 'audible';
};

const BROADCAST_MODE = typeof window !== 'undefined' ? detectBroadcastMode() : 'audible';

// =============================================================================
// FREQUENCY CONFIGURATIONS
// =============================================================================
const FREQ_CONFIG = {
  ultrasound: {
    baseFreq: 17800,
    freqStep: 30,
    syncFreq: 17500,       // PREAMBLE
    gapFreq: 17650,        // GAP tone (between sync and data range)
    endSyncFreq: 19500,    // POSTAMBLE - MOVED MUCH HIGHER (was 18800)
    // Char range: 17800 (0) to 18250 (F) - gap to postamble now 1250 Hz
  },
  audible: {
  baseFreq: 17000,
  freqStep: 80,
  syncFreq: 16500,
  gapFreq: 16750,
  endSyncFreq: 18500,
},
};

// Character set for encoding - hex only
const CHARSET = '0123456789ABCDEF';

// =============================================================================
// FREQUENCY HELPERS
// =============================================================================
function charToFreq(char: string, mode: 'ultrasound' | 'audible' = BROADCAST_MODE): number {
  const config = FREQ_CONFIG[mode];
  const index = CHARSET.indexOf(char.toUpperCase());
  if (index === -1) return config.baseFreq;
  return config.baseFreq + (index * config.freqStep);
}

function freqToChar(freq: number, mode: 'ultrasound' | 'audible'): string | null {
  const config = FREQ_CONFIG[mode];
  const index = Math.round((freq - config.baseFreq) / config.freqStep);
  if (index < 0 || index >= CHARSET.length) return null;
  
  // Check if frequency is close enough to expected
  const expectedFreq = config.baseFreq + (index * config.freqStep);
  const tolerance = config.freqStep * 0.5;
  if (Math.abs(freq - expectedFreq) > tolerance) return null;
  
  return CHARSET[index];
}

function identifyTone(freq: number, mode: 'ultrasound' | 'audible', logUnknown: boolean = false): 
  { type: 'preamble' | 'gap' | 'postamble' | 'char'; char?: string } | null {
  
  const config = FREQ_CONFIG[mode];
  const tolerance = mode === 'ultrasound' ? 100 : 75;  // Tighter for audible mode
  
  // Check preamble
  if (Math.abs(freq - config.syncFreq) < tolerance) {
    return { type: 'preamble' };
  }
  
  // Check gap
  if (Math.abs(freq - config.gapFreq) < tolerance) {
    return { type: 'gap' };
  }
  
  // Check postamble - use VERY strict tolerance to avoid false positives
  // Postamble is now at 19500 Hz (ultrasound), far from chars (max 18250 Hz)
  if (Math.abs(freq - config.endSyncFreq) < 200) {
    return { type: 'postamble' };
  }
  
  // Check character
  const char = freqToChar(freq, mode);
  if (char) {
    return { type: 'char', char };
  }
  
  return null;
}

// =============================================================================
// AUDIO CONTEXT MANAGEMENT
// =============================================================================
let audioContext: AudioContext | null = null;
let mediaStream: MediaStream | null = null;
let analyser: AnalyserNode | null = null;
let isListening = false;

export async function warmupAudio(): Promise<void> {
  if (typeof window === 'undefined') return;
  try {
    const AudioContextClass = window.AudioContext || (window as any).webkitAudioContext;
    if (!audioContext || audioContext.state === 'closed') {
      audioContext = new AudioContextClass({ sampleRate: SAMPLE_RATE });
    }
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }
    // Play silent tone to unlock iOS
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    gain.gain.value = 0.001;
    osc.connect(gain);
    gain.connect(audioContext.destination);
    osc.start();
    osc.stop(audioContext.currentTime + 0.1);
    console.log('üîä [INIT] Audio warmup complete');
  } catch (e) {
    console.warn('üîä [INIT] Warmup failed:', e);
  }
}

export async function initSoundPayment(): Promise<boolean> {
  if (typeof window === 'undefined') return false;
  try {
    const AudioContextClass = window.AudioContext || (window as any).webkitAudioContext;
    if (!audioContext || audioContext.state === 'closed') {
      audioContext = new AudioContextClass({ sampleRate: SAMPLE_RATE });
    }
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }
    console.log('üîä [INIT] Sound payment initialized (BOMBPROOF protocol)');
    console.log('üîä [INIT] Broadcast mode:', BROADCAST_MODE, BROADCAST_MODE === 'ultrasound' ? '(silent)' : '(audible chirps)');
    console.log('üîä [INIT] Timing: CHAR=' + (TIMING.CHAR_DURATION * 1000) + 'ms, GAP=' + (TIMING.GAP_DURATION * 1000) + 'ms');
    return true;
  } catch (error) {
    console.error('üîä [INIT] Failed to initialize:', error);
    return false;
  }
}

// =============================================================================
// BROADCAST (TRANSMITTER)
// =============================================================================

// MARK: - Types & Interfaces
export interface BroadcastSettings {
  volume?: number;
}

export async function broadcastToken(token: string, settings?: BroadcastSettings): Promise<boolean> {
  if (typeof window === 'undefined') return false;

  try {
    await initSoundPayment();
    if (!audioContext) throw new Error('Audio context not available');
    
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }

    const tokenUpper = token.toUpperCase();
    const config = FREQ_CONFIG[BROADCAST_MODE];
    const volume = settings?.volume ?? (BROADCAST_MODE === 'ultrasound' ? 0.8 : 0.7);
    const totalDuration = calculateDuration(tokenUpper.length);
    
    console.log('üîä ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üîä [TX] BROADCAST START');
    console.log('üîä [TX] Token:', tokenUpper);
    console.log('üîä [TX] Mode:', BROADCAST_MODE);
    console.log('üîä [TX] Volume:', volume);
    console.log('üîä [TX] Total duration:', (totalDuration * 1000).toFixed(0) + 'ms');
    console.log('üîä [TX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('üîä [TX] Frequency map:');
    console.log('üîä [TX]   PREAMBLE  ‚Üí', config.syncFreq, 'Hz');
    console.log('üîä [TX]   GAP       ‚Üí', config.gapFreq, 'Hz');
    for (const char of tokenUpper) {
      console.log('üîä [TX]   CHAR "' + char + '"  ‚Üí', charToFreq(char), 'Hz');
    }
    console.log('üîä [TX]   POSTAMBLE ‚Üí', config.endSyncFreq, 'Hz');
    console.log('üîä [TX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

    const ctx = audioContext;
    let currentTime = ctx.currentTime + 0.05; // Small buffer
    
    // Helper to play a tone with envelope
    const playTone = (freq: number, duration: number, label: string) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.frequency.value = freq;
      osc.type = 'sine';
      
      // Smooth envelope
      gain.gain.setValueAtTime(0, currentTime);
      gain.gain.linearRampToValueAtTime(volume, currentTime + TIMING.ATTACK_TIME);
      gain.gain.setValueAtTime(volume, currentTime + duration - TIMING.RELEASE_TIME);
      gain.gain.linearRampToValueAtTime(0, currentTime + duration);
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(currentTime);
      osc.stop(currentTime + duration);
      
      const startMs = ((currentTime - ctx.currentTime) * 1000).toFixed(0);
      console.log('üîä [TX] @' + startMs + 'ms: ' + label + ' (' + freq + 'Hz, ' + (duration * 1000).toFixed(0) + 'ms)');
      
      currentTime += duration;
    };

    // 1. PREAMBLE
    playTone(config.syncFreq, TIMING.PREAMBLE_DURATION, 'PREAMBLE');
    
    // 2. GAP after preamble
    playTone(config.gapFreq, TIMING.GAP_DURATION, 'GAP');
    
    // 3. For each character: CHAR + GAP
    for (let i = 0; i < tokenUpper.length; i++) {
      const char = tokenUpper[i];
      const freq = charToFreq(char);
      playTone(freq, TIMING.CHAR_DURATION, 'CHAR[' + i + ']="' + char + '"');
      playTone(config.gapFreq, TIMING.GAP_DURATION, 'GAP');
    }
    
    // 4. POSTAMBLE
    playTone(config.endSyncFreq, TIMING.POSTAMBLE_DURATION, 'POSTAMBLE');

    console.log('üîä [TX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    console.log('üîä [TX] All tones scheduled, waiting for completion...');

    return new Promise((resolve) => {
      setTimeout(() => {
        console.log('üîä [TX] BROADCAST COMPLETE');
        console.log('üîä ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        resolve(true);
      }, totalDuration * 1000 + 100);
    });

  } catch (error) {
    console.error('üîä [TX] Broadcast error:', error);
    return false;
  }
}

// =============================================================================
// LISTEN (RECEIVER) - Fixed Symbol Timing State Machine
// =============================================================================
type ReceiverState = 'IDLE' | 'PREAMBLE_DETECTED' | 'WAITING_FOR_GAP' | 'WAITING_FOR_CHAR' | 'COMPLETE';

export async function startListening(
  onTokenReceived: (token: string) => void,
  onError?: (error: string) => void,
  onProgress?: (state: 'ready' | 'sync' | 'receiving', chars?: string) => void
): Promise<() => void> {
  if (typeof window === 'undefined') return () => {};
  if (isListening) {
    console.log('üé§ [RX] Already listening, ignoring duplicate call');
    return () => {};
  }

  try {
    await initSoundPayment();
    if (!audioContext) throw new Error('Audio context not available');
    
    if (audioContext.state === 'suspended') {
      await audioContext.resume();
    }

    const ctx = audioContext;

    mediaStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        channelCount: 1,
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false,
      }
    });

    console.log('üé§ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üé§ [RX] RECEIVER STARTED');
    console.log('üé§ [RX] Mic granted');
    onProgress?.('ready');

    const source = ctx.createMediaStreamSource(mediaStream);
    analyser = ctx.createAnalyser();
    analyser.fftSize = 8192;
    analyser.smoothingTimeConstant = 0.3;
    source.connect(analyser);

    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    const freqResolution = SAMPLE_RATE / analyser.fftSize;

    console.log('üé§ [RX] FFT size:', analyser.fftSize);
    console.log('üé§ [RX] Freq resolution:', freqResolution.toFixed(2), 'Hz');
    console.log('üé§ [RX] Listening for BOTH audible and ultrasound');
    console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

    isListening = true;
    
    // State machine variables
    let state: ReceiverState = 'IDLE';
    let detectedMode: 'ultrasound' | 'audible' | null = null;
    let receivedChars: string[] = [];
    let preambleStartTime = 0;
    let lastGapTime = 0;
    let lastToken = '';
    let lastTokenTime = 0;
    let stateStartTime = 0;
    let consecutivePreambleCount = 0;
    let consecutiveGapCount = 0;
    
    const AMPLITUDE_THRESHOLD = 25;  // Lowered for better postamble detection
    const PREAMBLE_CONFIRM_COUNT = 3;  // Need 3 consecutive preamble detections
    const GAP_CONFIRM_COUNT = 1;       // Need 1 gap detection (faster!)
    const CHAR_CONFIRM_COUNT = 1;      // Need 1 char detection (faster!)
    
    let lastDetectedChar: string | null = null;
    let charConfirmCount = 0;

    // Detect peak frequency in range
    const detectFrequency = (minFreq: number, maxFreq: number): { freq: number; amplitude: number } | null => {
      analyser!.getByteFrequencyData(dataArray);
      
      const minBin = Math.floor(minFreq / freqResolution);
      const maxBin = Math.ceil(maxFreq / freqResolution);
      
      let maxValue = 0;
      let maxIndex = 0;
      
      for (let i = minBin; i < maxBin; i++) {
        if (dataArray[i] > maxValue) {
          maxValue = dataArray[i];
          maxIndex = i;
        }
      }
      
      if (maxValue < AMPLITUDE_THRESHOLD) return null;
      
      return { freq: maxIndex * freqResolution, amplitude: maxValue };
    };

    // Try both frequency ranges
    // IMPORTANT: Check audible FIRST because its POSTAMBLE (17000 Hz) 
    // could be confused with ultrasound PREAMBLE (17500 Hz)
    const detectAnySignal = (): { freq: number; amplitude: number; mode: 'ultrasound' | 'audible' } | null => {
      // Try audible first (14500-17200 Hz) - the 15000 Hz sweet spot for iPhone
      // Upper limit 17200 to include POSTAMBLE but not overlap with ultrasound PREAMBLE
      const audible = detectFrequency(14500, 18600);
      if (audible && audible.amplitude > AMPLITUDE_THRESHOLD) {
        return { ...audible, mode: 'audible' };
      }
      
      // Try ultrasound (17300-20000 Hz) - starts above audible POSTAMBLE
      const ultra = detectFrequency(17300, 20000);
      if (ultra && ultra.amplitude > AMPLITUDE_THRESHOLD) {
        return { ...ultra, mode: 'ultrasound' };
      }
      
      return null;
    };

    const processFrame = () => {
      if (!isListening) return;

      const now = Date.now();
      const detection = detectAnySignal();

      // Debug: log any strong signal detected (every 500ms to avoid spam)
      if (detection && detection.amplitude > 50 && now % 500 < 20) {
        console.log('üé§ [RX] Signal detected | mode:', detection.mode, '| freq:', detection.freq.toFixed(0), '| amp:', detection.amplitude);
      }

      if (detection) {
        const { freq, amplitude, mode } = detection;
        const tone = identifyTone(freq, mode);

        switch (state) {
          case 'IDLE':
            // Looking for preamble
            if (tone?.type === 'preamble') {
              consecutivePreambleCount++;
              if (consecutivePreambleCount >= PREAMBLE_CONFIRM_COUNT) {
                state = 'PREAMBLE_DETECTED';
                detectedMode = mode;
                preambleStartTime = now;
                stateStartTime = now;
                receivedChars = [];
                console.log('üé§ [RX] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üé§ [RX] PREAMBLE LOCKED | mode:', mode, '| freq:', freq.toFixed(0), '| amp:', amplitude);
                onProgress?.('sync');
              }
            } else {
              consecutivePreambleCount = 0;
            }
            break;

          case 'PREAMBLE_DETECTED':
            // Wait for first GAP after preamble
            if (tone?.type === 'gap') {
              consecutiveGapCount++;
              if (consecutiveGapCount >= GAP_CONFIRM_COUNT) {
                state = 'WAITING_FOR_CHAR';
                lastGapTime = now;
                stateStartTime = now;
                consecutiveGapCount = 0;
                console.log('üé§ [RX] GAP after preamble | freq:', freq.toFixed(0), '| amp:', amplitude);
                console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
              }
            } else if (tone?.type === 'preamble') {
              // Still in preamble, that's fine
              consecutiveGapCount = 0;
            } else {
              // Something else detected - log it!
              console.log('üé§ [RX] ? In PREAMBLE_DETECTED, got:', tone?.type || 'unknown', '| freq:', freq.toFixed(0), '| amp:', amplitude, '| gapCount:', consecutiveGapCount);
              consecutiveGapCount = 0;
            }
            break;

          case 'WAITING_FOR_CHAR':
            // Looking for character tone
            if (tone?.type === 'char' && tone.char) {
              // Require consecutive confirmations of same char
              if (tone.char === lastDetectedChar) {
                charConfirmCount++;
              } else {
                lastDetectedChar = tone.char;
                charConfirmCount = 1;
              }
              
              if (charConfirmCount >= CHAR_CONFIRM_COUNT) {
                receivedChars.push(tone.char);
                state = 'WAITING_FOR_GAP';
                stateStartTime = now;
                charConfirmCount = 0;
                lastDetectedChar = null;
                console.log('üé§ [RX] CHAR[' + (receivedChars.length - 1) + '] = "' + tone.char + '" | freq:', freq.toFixed(0), '| amp:', amplitude, '| token so far:', receivedChars.join(''));
                onProgress?.('receiving', receivedChars.join(''));
              }
            } else if (tone?.type === 'postamble') {
              // End of transmission
              state = 'COMPLETE';
              const token = receivedChars.join('');
              console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
              console.log('üé§ [RX] POSTAMBLE DETECTED | freq:', freq.toFixed(0));
              console.log('üé§ [RX] TOKEN COMPLETE:', token, '| length:', token.length);
              
              if (token.length >= 4) {
                if (token !== lastToken || now - lastTokenTime > 5000) {
                  lastToken = token;
                  lastTokenTime = now;
                  console.log('üé§ [RX] ‚úÖ TOKEN ACCEPTED:', token);
                  console.log('üé§ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  onTokenReceived(token);
                } else {
                  console.log('üé§ [RX] ‚ö†Ô∏è Duplicate token ignored');
                }
              } else {
                console.log('üé§ [RX] ‚ö†Ô∏è Token too short, discarding');
              }
              
              // Reset
              state = 'IDLE';
              detectedMode = null;
              receivedChars = [];
              consecutivePreambleCount = 0;
              consecutiveGapCount = 0;
              charConfirmCount = 0;
              lastDetectedChar = null;
            } else if (tone?.type === 'gap') {
              // Still gap, waiting for char - reset char detection
              lastDetectedChar = null;
              charConfirmCount = 0;
              consecutiveGapCount++;
              // If we have 4 chars and keep seeing gaps, postamble might be missed
              if (consecutiveGapCount > 5 && receivedChars.length === 4) {
                console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                console.log('üé§ [RX] POSTAMBLE ASSUMED (multiple gaps after 4 chars)');
                const token = receivedChars.join('');
                console.log('üé§ [RX] TOKEN COMPLETE:', token, '| length:', token.length);
                if (token !== lastToken || now - lastTokenTime > 5000) {
                  lastToken = token;
                  lastTokenTime = now;
                  console.log('üé§ [RX] ‚úÖ TOKEN ACCEPTED:', token);
                  console.log('üé§ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  onTokenReceived(token);
                }
                // Reset
                state = 'IDLE';
                detectedMode = null;
                receivedChars = [];
                consecutivePreambleCount = 0;
                consecutiveGapCount = 0;
                charConfirmCount = 0;
                lastDetectedChar = null;
              }
            } else {
              // Unknown tone - log it for debugging
              if (tone) {
                console.log('üé§ [RX] ? Unknown tone in WAITING_FOR_CHAR | type:', tone.type, '| freq:', freq.toFixed(0), '| amp:', amplitude);
              }
            }
            break;

          case 'WAITING_FOR_GAP':
            // Looking for gap after character
            if (tone?.type === 'gap') {
              consecutiveGapCount++;
              if (consecutiveGapCount >= GAP_CONFIRM_COUNT) {
                state = 'WAITING_FOR_CHAR';
                lastGapTime = now;
                stateStartTime = now;
                consecutiveGapCount = 0;
                console.log('üé§ [RX] GAP after char | freq:', freq.toFixed(0), '| amp:', amplitude);
              }
            } else if (tone?.type === 'postamble') {
              // End of transmission (no gap before postamble sometimes)
              state = 'COMPLETE';
              const token = receivedChars.join('');
              console.log('üé§ [RX] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
              console.log('üé§ [RX] POSTAMBLE DETECTED | freq:', freq.toFixed(0));
              console.log('üé§ [RX] TOKEN COMPLETE:', token, '| length:', token.length);
              
              if (token.length >= 4) {
                if (token !== lastToken || now - lastTokenTime > 5000) {
                  lastToken = token;
                  lastTokenTime = now;
                  console.log('üé§ [RX] ‚úÖ TOKEN ACCEPTED:', token);
                  console.log('üé§ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  onTokenReceived(token);
                } else {
                  console.log('üé§ [RX] ‚ö†Ô∏è Duplicate token ignored');
                }
              } else {
                console.log('üé§ [RX] ‚ö†Ô∏è Token too short, discarding');
              }
              
              // Reset
              state = 'IDLE';
              detectedMode = null;
              receivedChars = [];
              consecutivePreambleCount = 0;
              consecutiveGapCount = 0;
              charConfirmCount = 0;
              lastDetectedChar = null;
            } else if (tone?.type === 'char') {
              // Still hearing character, not gap yet
              consecutiveGapCount = 0;
            }
            break;
        }
      } else {
        // No signal detected
        if (state !== 'IDLE') {
          // Timeout check
          const timeSinceStateStart = now - stateStartTime;
          if (timeSinceStateStart > 2000) {
            console.log('üé§ [RX] ‚ö†Ô∏è Timeout in state:', state, '| resetting');
            state = 'IDLE';
            detectedMode = null;
            receivedChars = [];
            consecutivePreambleCount = 0;
            consecutiveGapCount = 0;
          }
        } else {
          consecutivePreambleCount = 0;
        }
      }

      requestAnimationFrame(processFrame);
    };

    requestAnimationFrame(processFrame);

    return () => {
      console.log('üé§ [RX] Stopping listener...');
      isListening = false;
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      if (analyser) {
        analyser.disconnect();
        analyser = null;
      }
      console.log('üé§ [RX] Stopped');
    };

  } catch (error: any) {
    console.error('üé§ [RX] Listen error:', error);
    if (onError) {
      if (error.name === 'NotAllowedError') {
        onError('Microphone permission denied');
      } else {
        onError(error.message || 'Failed to listen');
      }
    }
    return () => {};
  }
}

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================
export function isSupported(): boolean {
  if (typeof window === 'undefined') return false;
  return !!(
    (window.AudioContext || (window as any).webkitAudioContext) &&
    navigator.mediaDevices?.getUserMedia
  );
}

export function getBroadcastMode(): 'ultrasound' | 'audible' {
  return BROADCAST_MODE;
}

export function cleanup() {
  console.log('üîä [CLEANUP] Cleaning up audio resources...');
  isListening = false;
  if (mediaStream) {
    mediaStream.getTracks().forEach(track => track.stop());
    mediaStream = null;
  }
  if (analyser) {
    analyser.disconnect();
    analyser = null;
  }
  if (audioContext && audioContext.state !== 'closed') {
    audioContext.close();
    audioContext = null;
  }
  console.log('üîä [CLEANUP] Done');
}